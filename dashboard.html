<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>28-Day Plant Based Switch</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="manifest.json" rel="manifest"/>
<link rel="apple-touch-icon" href="assets/Logo_dots.jpg">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW Registered!', reg))
      .catch(err => console.log('SW Failed:', err));
  }
</script>

<!-- Supabase & Auth Guard -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="lib/supabase.js?v=3"></script>
<script src="lib/auth-guard.js?v=3"></script>
<script src="lib/migrate-localstorage.js"></script>
<script src="lib/stories.js"></script>
<script src="lib/nutrition-calculator.js"></script>

<style>
    :root {
        /* Premium Green & Gold Palette (Default) */
        --primary: #7BA883; /* Soft Sage Green (Pastel) */
        --primary-light: #98C9A3; /* Light Mint Green (Pastel) */
        --secondary: #E8D68E; /* Soft Golden Yellow */
        --accent-green: #f2f7f4; /* Subtle Green Tint */

        --bg: #f9f9f7;
        --surface: #ffffff;
        --text-main: #1a202c;
        --text-muted: #718096;

        --border-radius: 16px;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --nav-height: 80px;
    }

    * { box-sizing: border-box; }

    body { 
        font-family: 'Inter', sans-serif; 
        background: var(--bg);
        color: var(--text-main); 
        margin: 0; 
        padding-bottom: calc(var(--nav-height) + 20px); /* Space for bottom nav */
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
    }

    /* Fixed Bottom Navigation */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: var(--nav-height);
        background: white;
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        z-index: 9999; /* Always on top */
        border-top: 1px solid rgba(0,0,0,0.05);
        padding-bottom: env(safe-area-inset-bottom);
    }


    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.75rem;
        font-weight: 500;
        gap: 6px;
        width: 100%;
        height: 100%;
        transition: color 0.2s;
        border: none;
        background: transparent;
        cursor: pointer;
    }

    .nav-item.active {
        color: var(--secondary);
    }
    
    .nav-item svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }

    /* Notification glow effect for tabs */
    .nav-item.has-notification {
        position: relative;
        animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
        0%, 100% {
            box-shadow: 0 0 0 rgba(251, 191, 36, 0);
        }
        50% {
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), inset 0 0 20px rgba(251, 191, 36, 0.2);
        }
    }

    .nav-item.has-notification svg,
    .nav-item.has-notification span {
        color: #fbbf24;
        filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.8));
    }

    /* Flower Theme Decorative Elements (used when flower-garden theme is active) */
    .flower-decoration-corner {
        position: absolute;
        width: 60px;
        height: 60px;
        background: url('assets/flower-cherry-blossom.svg') no-repeat center;
        background-size: contain;
        opacity: 0.25;
        pointer-events: none;
    }
    .flower-decoration-corner.top-right {
        top: 10px;
        right: 10px;
    }
    .flower-decoration-corner.bottom-left {
        bottom: 10px;
        left: 10px;
        transform: rotate(180deg);
    }

    /* Top Header for Views */
    .app-header {
        padding: 20px 25px;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 900;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .app-logo { font-family: 'Playfair Display'; font-weight: 700; font-size: 1.25rem; color: var(--primary); }
    /* Profile View Styles */
    .profile-header {
        text-align: center;
        padding: 40px 20px;
        background: white;
        border-bottom: 1px solid #f1f5f9;
        margin-bottom: 25px;
    }
    .profile-photo-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 20px auto;
        border-radius: 50%;
        border: 4px solid var(--accent-green);
        padding: 5px;
    }
    .profile-photo {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    .photo-edit-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: var(--secondary);
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .profile-name-large {
        font-family: 'Playfair Display';
        font-size: 1.8rem;
        margin-bottom: 5px;
        color: var(--primary);
    }
    .profile-email {
        color: var(--text-muted);
        font-size: 0.95rem;
    }
    .profile-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding: 0 25px;
        margin-bottom: 30px;
    }
    .detail-item {
        background: white;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #f1f5f9;
        text-align: center;
    }
    .detail-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
    }
    .detail-val {
        font-weight: 700;
        color: var(--primary);
        font-size: 1.1rem;
    }
    .connected-apps-list {
        padding: 0 25px;
    }
    .app-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        padding: 15px 20px;
        border-radius: 16px;
        margin-bottom: 15px;
        border: 1px solid #f1f5f9;
    }
    .app-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .app-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    .app-btn {
        padding: 8px 20px;
        border-radius: 50px;
        border: 1px solid var(--primary);
        background: transparent;
        color: var(--primary);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
    }
    .app-btn.connected {
        background: #f0fdf4;
        color: #166534;
        border-color: #166534;
    }

    /* Subscription Management Styles */
    .subscription-menu {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }
    .subscription-menu.active { display: block; }
    .sub-action-btn {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        background: white;
        color: var(--text-main);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .sub-action-btn:hover { background: #f1f5f9; }
    .sub-action-btn.cancel { color: #dc2626; border-color: #fecaca; }
    .sub-action-btn.cancel:hover { background: #fef2f2; }
    
    .pause-options {
        display: none;
        padding-top: 10px;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
        margin-bottom: 8px;
    }
    .pause-options.active { display: grid; }
    .pause-btn {
        padding: 8px;
        border: 1px solid var(--primary);
        background: white;
        color: var(--primary);
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
    }
    .pause-btn:hover { background: #f0fdf4; }

    .profile-icon { 
        width: 35px; 
        height: 35px; 
        background: var(--accent-green); 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-weight: bold; 
        color: var(--primary); 
        cursor: pointer;
        transition: transform 0.1s;
    }
    .profile-icon:active { transform: scale(0.95); }

    /* Week Sub-Navigation (Pills) */
    .week-scroller { 
        display: flex; 
        gap: 10px; 
        overflow-x: auto; 
        padding: 15px 25px; 
        background: var(--bg);
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }
    .week-scroller::-webkit-scrollbar { display: none; }

    .pill-btn {
        padding: 8px 16px;
        background: white;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 20px;
        color: var(--text-muted);
        white-space: nowrap;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .pill-btn.active {
        background: var(--secondary); /* Gold */
        color: white;
        border-color: var(--secondary);
        box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
    }

    /* Dashboard Styles */
    .dashboard-welcome {
        padding: 25px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: white;
        border-bottom-left-radius: 30px;
        border-bottom-right-radius: 30px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px -10px rgba(123, 168, 131, 0.4);
        border-bottom: 5px solid var(--secondary);
    }
    .dashboard-welcome h1, 
    .dashboard-welcome .user-name,
    .dashboard-welcome .stat-val,
    .dashboard-welcome h2,
    .dashboard-welcome h3,
    .dashboard-welcome h4,
    .dashboard-welcome p {
        color: white !important;
    }
    .welcome-text { opacity: 0.9; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: white; }
    .user-name { font-family: 'Playfair Display'; font-size: 2rem; margin: 5px 0 15px 0; }
    
    .stats-row { display: flex; gap: 15px; margin-top: 20px; }
    .stat-card {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(5px);
        padding: 15px;
        border-radius: 12px;
        flex: 1;
        text-align: center;
    }
    .stat-val { font-size: 1.5rem; font-weight: 700; display: block; }
    .stat-label { font-size: 0.75rem; opacity: 0.9; }



    h1, h2, h3, h4 { 
        font-family: 'Playfair Display', serif; 
        color: var(--primary);
        margin-top: 0;
    }

    h1 { font-size: 2.5rem; letter-spacing: -0.5px; font-weight: 700; }
    h2 { font-size: 1.75rem; color: var(--primary-light); }
    
    /* Layout Container */
    .container { 
        max-width: 100%; 
        margin: 0 auto; 
        min-height: 100vh; 
        background: var(--bg); 
        display: flex; 
        flex-direction: column; 
        position: relative;
    }
    
    /* Sticky Navigation */
    .top-nav { 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(10px);
        position: sticky; 
        top: 0; 
        z-index: 1000; 
        border-bottom: 1px solid rgba(0,0,0,0.05); 
        padding: 15px 30px; 
        display: flex; 
        gap: 12px; 
        overflow-x: auto; 
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Hide scrollbar Firefox */
        box-shadow: var(--nav-shadow);
    }
    .top-nav::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome/Safari */

    .nav-btn { 
        padding: 10px 24px; 
        border-radius: 50px; 
        border: 1px solid transparent; 
        background: transparent; 
        color: var(--text-muted); 
        font-weight: 500; 
        cursor: pointer; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        font-family: 'Inter', sans-serif; 
        font-size: 0.95rem; 
        white-space: nowrap;
    }
    
    .nav-btn:hover { color: var(--primary); background: var(--accent-green); }
    
    .nav-btn.active { 
        background: var(--primary); 
        color: white; 
        box-shadow: 0 4px 12px rgba(30, 58, 95, 0.25); 
        transform: translateY(-1px);
    }

    /* Content Area */
    .view-section { 
        display: none; 
        padding: 40px 30px; 
        animation: fadeIn 0.4s ease-out; 
    }
    .view-section.active { display: block; }
    
    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(10px); } 
        to { opacity: 1; transform: translateY(0); } 
    }

    /* Hero Section (Cover) */
    .hero-card {
        text-align: center;
        padding: 100px 40px;
        background: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)), url('/assets/hero_image.webp');
        background-size: cover;
        background-position: center;
        border-radius: var(--border-radius);
        margin-bottom: 40px;
        border: 1px solid rgba(0,0,0,0.03);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .hero-title {
        font-size: 3rem;
        color: var(--primary);
        line-height: 1.1;
        margin-bottom: 15px;
    }
    .hero-subtitle {
        font-size: 1.25rem;
        color: var(--secondary);
        font-family: 'Inter', sans-serif;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 600;
        margin-bottom: 30px;
    }

    /* Sub Tabs (Week Days) */
    .sub-nav { 
        display: flex; 
        gap: 10px; 
        margin-bottom: 30px; 
        flex-wrap: wrap; 
        justify-content: center;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .sub-btn { 
        padding: 5px 12px; 
        border: none; 
        background: transparent; 
        border-radius: 6px; 
        font-size: 0.9rem; 
        font-weight: 500; 
        cursor: pointer; 
        transition: all 0.2s; 
        color: var(--text-muted);
    }
    
    .sub-btn:hover { color: var(--primary); }
    
    .sub-btn.active { 
        background: transparent; 
        color: var(--primary); 
        border: none;
        font-weight: 700;
        text-decoration: underline;
        text-underline-offset: 4px;
    }
    
    .day-view { display: none; }
    .day-view.active { display: block; }

    /* Meal Cards */
    .card { 
        background: var(--surface); 
        border-radius: var(--border-radius); 
        box-shadow: var(--card-shadow); 
        margin-bottom: 24px; 
        border: 1px solid rgba(0,0,0,0.04); 
        overflow: hidden; 
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.08);
    }
    
    .card-header { 
        padding: 25px; 
        cursor: pointer; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: white;
    }
    
    .meal-icon { font-size: 1.8rem; margin-right: 20px; filter: grayscale(0.2); }
    
    .meta { 
        font-size: 0.75rem; 
        color: var(--secondary); 
        font-weight: 700; 
        text-transform: uppercase; 
        letter-spacing: 1px; 
        margin-bottom: 6px; 
    }
    
    .meal-title {
        font-family: 'Playfair Display', serif;
        font-weight: 600;
        font-size: 1.25rem;
        color: var(--primary);
        line-height: 1.3;
    }

    .expand-icon {
        font-size: 1.5rem;
        color: var(--text-muted);
        transition: transform 0.3s ease;
        font-weight: 300;
    }
    .card.open .expand-icon { transform: rotate(45deg); }

    .card-body { 
        padding: 0 30px; 
        max-height: 0; 
        overflow: hidden; 
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        background: #fdfdfd; 
        border-top: 1px solid rgba(0,0,0,0.03); 
        opacity: 0;
    }
    .card.open .card-body { 
        max-height: 2000px; /* Safe large number */
        padding: 30px; 
        opacity: 1;
    }

    /* Content Styling */
    .nutrition-pill {
        display: inline-block;
        padding: 6px 12px;
        background: var(--accent-green);
        color: #2d4a3e;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 20px;
    }

    h4 { 
        font-size: 0.95rem; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
        color: var(--primary-light); 
        margin-bottom: 12px; 
        border-bottom: 2px solid rgba(0,0,0,0.05);
        padding-bottom: 6px;
        display: inline-block;
    }

    ul { padding-left: 20px; color: #4a5568; margin-bottom: 25px; }
    li { margin-bottom: 8px; }
    p { color: #4a5568; }

    /* Tables */
    table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 20px 0; font-size: 0.95rem; border: 1px solid #eee; border-radius: 12px; overflow: hidden; }
    th { background: var(--primary); color: white; padding: 15px; text-align: left; font-weight: 500; font-family: 'Playfair Display'; letter-spacing: 0.5px; }
    td { border-bottom: 1px solid #eee; padding: 12px 15px; color: #444; }
    tr:last-child td { border-bottom: none; }
    tr:nth-child(even) { background: #fcfcfc; }

    /* Mobile Tweaks */
    @media (max-width: 600px) {
        .top-nav { padding: 15px; gap: 8px; }
        .nav-btn { padding: 8px 16px; font-size: 0.85rem; }
        .hero-title { font-size: 2.2rem; }
        .view-section { padding: 25px 15px; }
        .card-body { padding: 0 20px; }
        .card.open .card-body { padding: 20px; }
    }
    /* Image Modal */
    .image-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        display: none;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        padding: 20px;
        backdrop-filter: blur(5px);
    }
    .image-modal-overlay.active {
        display: flex;
        opacity: 1;
    }
    .image-modal-content {
        max-width: 90vw;
        max-height: 90vh;
        border-radius: 8px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        object-fit: contain;
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }
    .image-modal-overlay.active .image-modal-content {
        transform: scale(1);
    }
    .close-modal-btn {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 2.5rem;
        cursor: pointer;
        z-index: 2001;
        background: rgba(255, 255, 255, 0.1);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background 0.2s, transform 0.2s;
        line-height: 0;
        padding-bottom: 5px;
    }
    .close-modal-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }
    
    /* Meal Image Cursor */
    .card-body img {
        cursor: zoom-in;
        transition: opacity 0.2s;
    }
    .card-body img:hover {
        opacity: 0.9;
    }
    /* Shopping List Improvements */
    .shopping-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        margin-top: 10px;
    }
    .shopping-category h4 {
        color: var(--primary);
        border-bottom: 2px solid var(--accent-green);
        padding-bottom: 8px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .check-list {
        list-style: none; /* Remove default bullets */
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
    }
    .check-list li {
        position: relative;
        padding-left: 35px; /* Space for checkbox */
        line-height: 1.4;
        color: var(--text-main);
        cursor: pointer;
        transition: color 0.2s;
        display: flex; /* alignment */
        align-items: center;
    }
    .check-list li:hover {
        color: var(--primary);
    }
    /* Custom Checkbox */
    .check-list li::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        border: 2px solid #cbd5e0;
        border-radius: 5px;
        transition: all 0.2s;
        background: white;
    }
    .check-list li.checked {
        text-decoration: line-through;
        color: var(--text-muted);
        opacity: 0.7;
    }
    .check-list li.checked::before {
        background-color: var(--secondary); /* Gold background */
        border-color: var(--secondary);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='14px' height='14px'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
    }
    
    /* Sleep Guide Styles */
    .section-title {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        margin-top: 50px;
    }
    .section-number {
        background: var(--secondary);
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        font-size: 1.2rem;
    }
    .timeline-item {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        position: relative;
    }
    .timeline-item:last-child { margin-bottom: 0; }
    .timeline-time {
        min-width: 100px;
        text-align: right;
        font-weight: 600;
        color: var(--primary-light);
        padding-top: 2px;
    }
    .timeline-content {
        padding-bottom: 30px;
        border-left: 2px solid var(--accent-green);
        padding-left: 35px; /* More space for icon */
        position: relative;
    }
    .timeline-item:last-child .timeline-content { border-left: 2px solid transparent; }
    
    /* Icon Dot on Timeline */
    .timeline-content::before {
        content: '';
        position: absolute;
        left: -20px; /* Centered on line */
        top: 0;
        width: 40px;
        height: 40px;
        background: white;
        border: 2px solid var(--secondary);
        border-radius: 50%;
        z-index: 1;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    /* Simple CSS Icons using Emojis or content chars for simplicity/reliability without SVG bloat here */
    /* Simple CSS Icons using Emojis or content chars for simplicity/reliability without SVG bloat here */
    .timeline-item:nth-child(1) .timeline-content::after { content: '🌙'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }
    .timeline-item:nth-child(2) .timeline-content::after { content: '🍵'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }
    .timeline-item:nth-child(3) .timeline-content::after { content: '🧘'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }
    .timeline-item:nth-child(4) .timeline-content::after { content: '📵'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }
    .timeline-item:nth-child(5) .timeline-content::after { content: '🛌'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }

    /* Sleep Hero */
    .sleep-hero {
        background: linear-gradient(135deg, #1a2a44 0%, #2d4a6d 100%);
        color: white;
        padding: 60px 40px;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 50px;
        box-shadow: 0 10px 40px rgba(30, 58, 95, 0.2);
    }
    
    .recipe-card {
        background: #fffafa;
        border: 1px solid #ffecec;
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        display: flex;
        gap: 30px;
        align-items: center;
    }
    .rescue-card {
        background: #fdf6f6;
        border-left: 4px solid #e53e3e;
        padding: 25px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    @media (max-width: 700px) {
        .recipe-card { flex-direction: column; text-align: center; }
        .timeline-content::before { left: -15px; width: 30px; height: 30px; }
        .timeline-item:nth-child(n) .timeline-content::after { font-size: 1rem; left: -8px; top: 4px; }
        .timeline-content { padding-left: 25px; }
    }

    /* Today's Meals Redesign */
    .today-menu-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .today-menu-header h2 {
        font-size: 2rem;
        margin-bottom: 5px;
    }
    .today-menu-header p {
        color: var(--text-muted);
        font-weight: 500;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-size: 0.8rem;
    }
    #today .card {
        border-radius: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(0,0,0,0.03);
        box-shadow: 0 10px 25px rgba(0,0,0,0.03);
    }
    #today .card-header {
        padding: 20px 25px;
    }
    #today .meal-title {
        font-size: 1.15rem;
    }
    /* Onboarding Modal Styles */
    .onboarding-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(4, 106, 56, 0.6); /* Primary with opacity */
        backdrop-filter: blur(8px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        padding: 20px;
        opacity: 0;
        transition: opacity 0.4s ease;
    }
    .onboarding-overlay.active {
        display: flex;
        opacity: 1;
    }
    .onboarding-modal {
        background: white;
        width: 100%;
        max-width: 450px;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        animation: slideUp 0.5s ease-out;
    }
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideDown {
        from { transform: translate(-50%, -20px); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    .onboarding-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        padding: 30px;
        text-align: center;
        color: white;
    }
    .onboarding-content {
        padding: 30px;
    }
    .onboarding-step {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: flex-start;
    }
    .step-icon {
        font-size: 1.5rem;
        background: var(--accent-green);
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .step-text h4 {
        margin: 0 0 5px 0;
        color: var(--primary);
        font-size: 1rem;
        border: none;
    }
    .step-text p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted);
        line-height: 1.4;
    }
    .onboarding-btn {
        width: 100%;
        padding: 16px;
        background: var(--secondary);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: transform 0.2s;
        margin-top: 10px;
    }
    .onboarding-btn:hover {
        transform: translateY(-2px);
        background: #bfa64d; /* Darker gold */
    }

    /* ========================================== */
    /* CALORIE TRACKER STYLES */
    /* ========================================== */

    /* Calorie Widget Card (Dashboard) */
    .calorie-widget-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .calorie-widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .camera-btn-widget {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(123, 168, 131, 0.3);
    }

    .camera-btn-widget:hover {
        background: var(--primary-light);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(123, 168, 131, 0.4);
    }

    .camera-btn-widget:active {
        transform: scale(0.95);
    }

    /* Calorie Progress */
    .calorie-progress-main {
        margin-bottom: 20px;
    }

    .calorie-numbers {
        display: flex;
        align-items: baseline;
        justify-content: center;
        margin-bottom: 12px;
        gap: 4px;
    }

    .calorie-current {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
    }

    .calorie-separator {
        font-size: 1.5rem;
        color: var(--text-muted);
        margin: 0 4px;
    }

    .calorie-goal {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .calorie-unit {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-left: 4px;
    }

    /* Progress Bars */
    .progress-bar {
        height: 12px;
        background: #f0f0f0;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--primary-light));
        border-radius: 6px;
        transition: width 0.5s ease;
    }

    .progress-bar-small {
        height: 6px;
        background: #f0f0f0;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 6px;
    }

    .progress-fill-protein {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--primary-light));
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .progress-fill-carbs {
        height: 100%;
        background: linear-gradient(90deg, var(--secondary), var(--secondary-light));
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .progress-fill-fat {
        height: 100%;
        background: linear-gradient(90deg, #d4a574, #e6c29a);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .progress-fill-fiber {
        height: 100%;
        background: linear-gradient(90deg, #9b8dab, #b5a9c2);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    /* Macros Grid */
    .macros-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .macro-item {
        text-align: center;
    }

    .macro-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 4px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .macro-value {
        font-size: 0.85rem;
        color: var(--text-main);
        font-weight: 600;
        margin-bottom: 4px;
    }

    /* Widget Footer */
    .calorie-widget-footer {
        margin-top: 16px;
        text-align: center;
    }

    .view-details-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .view-details-btn:hover {
        background: var(--accent-green);
    }

    /* ==========================================
       POINTS WIDGET STYLES
       ========================================== */

    .points-widget {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        color: white;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .points-widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .points-balance {
        display: flex;
        flex-direction: column;
    }

    .points-number {
        font-size: 2.5rem;
        font-weight: 900;
        line-height: 1;
    }

    .points-label {
        font-size: 0.85rem;
        opacity: 0.85;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 4px;
    }

    .streak-badge {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50px;
        padding: 10px 18px;
        display: flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(10px);
    }

    .streak-fire {
        font-size: 1.4rem;
    }

    .streak-number {
        font-size: 1.4rem;
        font-weight: 800;
    }

    .points-progress {
        margin-bottom: 15px;
    }

    .points-progress-bar {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        height: 12px;
        overflow: hidden;
        margin-bottom: 8px;
    }

    .points-progress-fill {
        background: linear-gradient(90deg, rgba(255,255,255,0.9) 0%, var(--secondary) 100%);
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .points-progress-label {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .redeem-btn {
        width: 100%;
        background: white;
        color: var(--primary);
        border: none;
        padding: 14px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .redeem-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .redeem-btn:not(:disabled):hover {
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    /* Milestone Toast */
    .milestone-toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: linear-gradient(135deg, var(--secondary) 0%, var(--primary-light) 100%);
        border-radius: 16px;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 10009;
        transition: transform 0.3s ease;
    }

    .milestone-toast.show {
        transform: translateX(-50%) translateY(0);
    }

    .milestone-icon {
        font-size: 2rem;
    }

    .milestone-title {
        font-weight: 700;
        color: #333;
        font-size: 1.1rem;
    }

    .milestone-points {
        color: #666;
        font-weight: 600;
    }

    /* Points Earned Toast */
    .points-earned-toast {
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--primary);
        color: white;
        border-radius: 12px;
        padding: 12px 20px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        z-index: 10009;
        transform: translateX(200px);
        transition: transform 0.3s ease;
    }

    .points-earned-toast.show {
        transform: translateX(0);
    }

    .points-earned-main {
        font-size: 1.5rem;
        font-weight: 800;
    }

    .points-earned-bonus,
    .points-earned-streak {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    /* Calorie Tracker Summary (Full View) */
    .calorie-tracker-summary {
        background: white;
        border-radius: 16px;
        padding: 30px 20px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* Circular Progress */
    .calorie-progress-large {
        display: flex;
        justify-content: center;
        margin: 30px 0;
    }

    .calorie-circle {
        position: relative;
        width: 200px;
        height: 200px;
    }

    .calorie-circle-svg {
        width: 100%;
        height: 100%;
    }

    .calorie-circle-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .calorie-circle-numbers {
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 4px;
    }

    .calorie-circle-current {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--primary);
        line-height: 1;
    }

    .calorie-circle-separator {
        font-size: 1.2rem;
        color: var(--text-muted);
    }

    .calorie-circle-goal {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .calorie-circle-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Macros Detail Grid */
    .macros-detail-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 30px;
    }

    .macro-detail-item {
        background: #f9f9f7;
        padding: 12px 16px;
        border-radius: 12px;
    }

    /* Weekly Metrics Styles */
    .weekly-day-item {
        margin-bottom: 12px;
    }

    .weekly-day-item:last-child {
        margin-bottom: 0;
    }

    .weekly-day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }

    .weekly-day-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-main);
    }

    .weekly-day-calories {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-muted);
    }

    .macro-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .macro-detail-name {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text-main);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .macro-detail-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-main);
    }

    .progress-bar-medium {
        height: 10px;
        background: #e5e5e5;
        border-radius: 5px;
        overflow: hidden;
    }

    /* Camera Button Large */
    .camera-btn-large {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 16px;
        padding: 16px 32px;
        font-size: 1.1rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(123, 168, 131, 0.3);
    }

    .camera-btn-large:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(123, 168, 131, 0.4);
    }

    .camera-btn-large:active {
        transform: translateY(0);
    }

    /* Meals Log List */
    #meals-log-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .meal-log-card {
        background: white;
        border-radius: 12px;
        padding: 12px;
        display: flex;
        gap: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        align-items: center;
        transition: all 0.2s ease;
    }

    .meal-log-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .meal-log-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        background-size: cover;
        background-position: center;
        background-color: #f0f0f0;
        flex-shrink: 0;
    }

    .meal-log-content {
        flex: 1;
        min-width: 0;
    }

    .meal-log-time {
        font-size: 0.75rem;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .meal-log-foods {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 6px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .meal-log-macros {
        display: flex;
        gap: 10px;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .meal-log-macros span {
        white-space: nowrap;
    }

    .meal-log-delete {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .meal-log-delete:hover {
        background: #fee2e2;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
        .macros-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .calorie-circle {
            width: 160px;
            height: 160px;
        }

        .calorie-circle-current {
            font-size: 2rem;
        }

        .calorie-circle-goal {
            font-size: 1.2rem;
        }

        .meal-log-image {
            width: 60px;
            height: 60px;
        }

        .meal-log-macros {
            flex-wrap: wrap;
            gap: 6px;
        }
    }

    </style>
</head>
<body>
<div class="container">
<!-- DASHBOARD VIEW (HOME) -->
<div id="view-dashboard" class="app-view">
    <div class="dashboard-welcome">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <span id="daily-progress-counter" class="welcome-text" style="color: white; font-weight: 700;">Day 1 of 28</span>
             <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div> <!-- Placeholder User Initial -->
        </div>
        <h1 class="user-name">Hello, Shannon</h1>
        <div style="margin-top: 5px;">
            <button onclick="openCheckInModal()" style="background:none; border:none; color:white; font-size:0.8rem; cursor:pointer; text-decoration:underline;">
                Did you check in today?
            </button>
        </div>
    </div>

    <!-- Duplicate Install Banner Removed -->

    <!-- Stories Ring Carousel -->
    <div id="stories-carousel-container" style="padding: 15px 0 15px 25px; background: transparent; overflow-x: auto; overflow-y: hidden; white-space: nowrap;">
        <div id="stories-carousel" style="display: inline-flex; gap: 15px;">
            <!-- Add Your Story Button -->
            <div class="story-ring add-story-btn" onclick="openStoryCamera()" style="display: inline-block; text-align: center; cursor: pointer;">
                <div style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; position: relative;">
                    <div style="width: 64px; height: 64px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 2rem; color: var(--primary);">+</span>
                    </div>
                </div>
                <p style="margin: 5px 0 0 0; font-size: 0.75rem; color: var(--text-muted); white-space: normal; width: 70px;">Your Story</p>
            </div>
            <input type="file" id="story-camera-input" accept="image/*,video/*" capture style="display:none;" onchange="handleStoryFileSelect(event)">
            <input type="file" id="meal-camera-input" accept="image/*" capture="environment" style="display:none;" onchange="handleMealPhotoSelect(event)">
            <!-- Story rings will be injected here -->
        </div>
    </div>

    <div style="padding: 0 25px;">
        <!-- Points Rewards Widget -->
        <div id="points-widget" class="points-widget">
            <div class="points-widget-header">
                <div class="points-balance">
                    <span class="points-number" id="points-current">0</span>
                    <span class="points-label">points</span>
                </div>
                <div class="streak-badge" id="streak-badge">
                    <span class="streak-fire">&#x1F525;</span>
                    <span class="streak-number" id="streak-current">0</span>
                    <span style="font-size: 0.75rem; opacity: 0.8;">day streak</span>
                </div>
            </div>
            <div class="points-progress">
                <div class="points-progress-bar">
                    <div class="points-progress-fill" id="points-progress-fill" style="width: 0%"></div>
                </div>
                <span class="points-progress-label" id="points-progress-label">0/200 to free week</span>
            </div>
            <button class="redeem-btn" id="redeem-btn" onclick="redeemPointsForFreeWeek()" disabled>
                Redeem Free Week (200 pts)
            </button>
        </div>

        <!-- Calorie Counter Widget -->
        <div class="calorie-widget-card">
            <div class="calorie-widget-header">
                <h3 style="margin: 0; font-size: 1.1rem;">Today's Nutrition</h3>
                <button class="camera-btn-widget" onclick="openMealCamera('widget')" title="Log a meal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </button>
            </div>

            <div id="calorie-widget-content">
                <!-- Calories Progress -->
                <div class="calorie-progress-main">
                    <div class="calorie-numbers">
                        <span class="calorie-current" id="widget-calories-current">0</span>
                        <span class="calorie-separator">/</span>
                        <span class="calorie-goal" id="widget-calories-goal">2000</span>
                        <span class="calorie-unit">kcal</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="widget-calories-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Macros Grid -->
                <div class="macros-grid">
                    <div class="macro-item">
                        <div class="macro-label">Protein</div>
                        <div class="macro-value"><span id="widget-protein">0</span>g / <span id="widget-protein-goal">50</span>g</div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-protein" id="widget-protein-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-label">Carbs</div>
                        <div class="macro-value"><span id="widget-carbs">0</span>g / <span id="widget-carbs-goal">250</span>g</div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-carbs" id="widget-carbs-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-label">Fat</div>
                        <div class="macro-value"><span id="widget-fat">0</span>g / <span id="widget-fat-goal">70</span>g</div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-fat" id="widget-fat-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="calorie-widget-footer">
                    <button class="view-details-btn" onclick="switchAppTab('meals', this); setTimeout(() => switchWeek('calorie-tracker', document.querySelector('.pill-btn')), 100)">
                        View Details →
                    </button>
                </div>
            </div>
        </div>

        <h3 style="margin-bottom: 15px; margin-top: 30px;">Today's Priority</h3>
        
        <!-- Cycle Sync Injection Container -->
        <div id="today-meals-container"></div>
        <!-- Quick Action Card -->
         <div class="card" onclick="switchAppTab('meals', this);" style="cursor: pointer;">
            <div class="card-body" style="max-height: none; padding: 25px; opacity: 1; display: flex; align-items: center; gap: 20px;">
                <div style="background: var(--accent-green); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">🌿</div>
                <div>
                    <h4 style="margin: 0 0 5px 0; border: none; padding: 0;">Current Phase</h4>
                    <p style="margin: 0; font-weight: 500; color: var(--primary);">Week 1: The Flush</p>
                    <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">View today's menu &rarr;</p>
                </div>
            </div>
         </div>

         <!-- Your Workout Actions -->
         <h3 style="margin: 30px 0 15px 0;">Your Workout</h3>
         <div class="card" onclick="switchAppTab('movement-tab', this);" style="cursor: pointer; border-left: 5px solid var(--secondary);">
            <div class="card-body" style="max-height: none; padding: 25px; opacity: 1; display: flex; align-items: center; gap: 20px;">
                <div id="dashboard-workout-icon" style="background: var(--accent-green); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">🧘‍♀️</div>
                <div>
                    <h4 style="margin: 0 0 5px 0; border: none; padding: 0;">Today's Movement</h4>
                    <p id="dashboard-workout-title" style="margin: 0; font-weight: 500; color: var(--primary);">Loading...</p>
                    <p id="dashboard-workout-sub" style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Tap to view →</p>
                </div>
            </div>
         </div>

        <h3 style="margin: 30px 0 15px 0;">Coaching Insight</h3>
         <div class="card">
              <div class="card-body" style="max-height: none; padding: 20px; opacity: 1;">
                  <p id="daily-coaching-tip" style="margin:0;"><strong>Biology Tip:</strong> Eating within 30 minutes of waking stops the morning cortisol spike. Have you had your breakfast?</p>
              </div>
         </div>
    </div>
</div>

<!-- MEALS VIEW (Contains Week Tabs) -->
<div id="view-meals" class="app-view" style="display:none;">
    <div class="app-header">
        <div class="app-logo">Meals</div>
        <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
    </div>
    
    <!-- Week Pills Navigation -->
    <div class="week-scroller" id="meals-nav-pills">
        <button class="pill-btn active" onclick="switchWeek('today', this)">Today</button>
        <button class="pill-btn" onclick="switchWeek('calorie-tracker', this)" style="background: var(--accent-green); color: var(--primary); font-weight: 600; border-color: rgba(4, 106, 56, 0.2);">📸 Calorie Tracker</button>
        <button class="pill-btn" onclick="switchWeek('week1', this)">Week 1</button>
        <button class="pill-btn" onclick="switchWeek('week2', this)">Week 2</button>
        <button class="pill-btn" onclick="switchWeek('week3', this)">Week 3</button>
        <button class="pill-btn" onclick="switchWeek('week4', this)">Week 4</button>
        <button class="pill-btn" onclick="switchWeek('dining', this)">Dining Out</button>
        <button class="pill-btn" onclick="switchWeek('shopping', this)" style="background: var(--accent-green); color: var(--primary); font-weight: 600; border-color: rgba(4, 106, 56, 0.2);">🛒 Shopping List</button>
    </div>

    <!-- Container for Week Content -->
    <div id="meals-content-container">
        <!-- Today's Meals View -->
        <div class="view-section active" id="today">
            <div id="today-meals-content">
                <!-- Current day's meals will be injected here -->
                <div style="text-align:center; padding:40px; color:var(--text-muted);">
                    <p>Loading your meals for today...</p>
                </div>
            </div>
        </div>

        <!-- Calorie Tracker View -->
        <div class="view-section" id="calorie-tracker">
            <div style="padding: 25px;">
                <!-- Daily Summary Card -->
                <div class="calorie-tracker-summary">
                    <h2 style="margin: 0 0 20px 0; font-size: 1.5rem; color: var(--text-main);">Daily Nutrition Tracker</h2>

                    <!-- Calorie Progress Large -->
                    <div class="calorie-progress-large">
                        <div class="calorie-circle">
                            <svg class="calorie-circle-svg" viewBox="0 0 200 200">
                                <circle class="calorie-circle-bg" cx="100" cy="100" r="90" fill="none" stroke="#f0f0f0" stroke-width="12"/>
                                <circle class="calorie-circle-progress" id="calorie-circle-progress" cx="100" cy="100" r="90" fill="none" stroke="var(--primary)" stroke-width="12" stroke-linecap="round"
                                    style="stroke-dasharray: 565; stroke-dashoffset: 565; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.5s ease;"/>
                            </svg>
                            <div class="calorie-circle-text">
                                <div class="calorie-circle-numbers">
                                    <span class="calorie-circle-current" id="tracker-calories-current">0</span>
                                    <span class="calorie-circle-separator">/</span>
                                    <span class="calorie-circle-goal" id="tracker-calories-goal">2000</span>
                                </div>
                                <div class="calorie-circle-label">calories</div>
                            </div>
                        </div>
                    </div>

                    <!-- Macros Progress Bars -->
                    <div class="macros-detail-grid">
                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Protein</span>
                                <span class="macro-detail-value"><span id="tracker-protein">0</span> / <span id="tracker-protein-goal">50</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-protein" id="tracker-protein-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Carbs</span>
                                <span class="macro-detail-value"><span id="tracker-carbs">0</span> / <span id="tracker-carbs-goal">250</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-carbs" id="tracker-carbs-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Fat</span>
                                <span class="macro-detail-value"><span id="tracker-fat">0</span> / <span id="tracker-fat-goal">70</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-fat" id="tracker-fat-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Fiber</span>
                                <span class="macro-detail-value"><span id="tracker-fiber">0</span> / <span id="tracker-fiber-goal">25</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-fiber" id="tracker-fiber-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Metrics Section -->
                <div class="weekly-metrics-card" style="margin: 30px 0; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border: 1px solid #dee2e6;">
                    <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                        📊 Weekly Summary
                    </h3>

                    <!-- Weekly Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Total Calories</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><span id="weekly-total-calories">0</span></div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Daily Average</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><span id="weekly-avg-calories">0</span></div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Days Logged</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><span id="weekly-days-logged">0</span>/7</div>
                        </div>
                    </div>

                    <!-- Daily Breakdown -->
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 12px;">Last 7 Days</div>
                        <div id="weekly-daily-breakdown">
                            <p style="text-align: center; color: var(--text-muted); padding: 20px 0;">Loading weekly data...</p>
                        </div>
                    </div>
                </div>

                <!-- Camera Button -->
                <div style="text-align: center; margin: 30px 0;">
                    <button class="camera-btn-large" onclick="openMealCamera('tracker')">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        <span>Log a Meal</span>
                    </button>
                </div>

                <!-- Today's Meals List -->
                <h3 style="margin: 30px 0 15px 0;">Today's Meals</h3>
                <div id="meals-log-list">
                    <div class="empty-state">
                        <p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                            📸 No meals logged yet today.<br>
                            <span style="font-size: 0.9rem;">Take a photo of your meal to get started!</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Week views will be injected/shown here -->

<!-- START HERE -->
    <!-- Protocol Section Removed -->

<script>
    (function() {
        try {
            // 1. Get User Data
            const rawProfile = sessionStorage.getItem('userProfile');
            const data = rawProfile ? JSON.parse(rawProfile) : {};
            // 0. Unified App Content Configuration
            const APP_CONTENT = {
                CORTISOL: {
                    title: "Your Cortisol Recovery Protocol",
                    subtitle: "<strong>The \"Survival Mode\" Profile.</strong> Your body is stuck in fight-or-flight, holding onto belly fat. This plan powers down your adrenaline response to signal safety and shedding.",
                    goldenRules: `
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">1. Carbs at Night</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Save starchy carbs (Sweet Potato/Rice) for <strong>dinner</strong>. This blunts the evening cortisol spike and boosts serotonin for deep sleep.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">2. No Fasting</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Eat within <strong>30 minutes</strong> of waking. Fasting spikes cortisol and keeps your body in emergency storage mode.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">3. Magnesium</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Prioritize magnesium-rich foods (Spinach, Pumpkin Seeds, Dark Choc) to physically relax the nervous system.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">4. 4-Hour Rhythm</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p><strong>Never go >4 hours without food.</strong> Frequent protein feedings assure your ancient brain that you are safe from starvation.</p></div></div>
                    `,
                    spotlight: `
                        <img src="protocols/cortisol/images/sweet_potato_spotlight.png" style="width:150px; height:150px; object-fit:cover; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
                        <div><h3 style="color:var(--secondary);">Medicinal Power: The Sweet Potato</h3><p><strong>Why simple carbs?</strong> When eaten at night, the strategic insulin release helps lower cortisol and drives Tryptophan into the brain to create <strong>Serotonin</strong>. It is your biochemistry hack for sleep and calm.</p></div>
                    `,
                    whyWorks: `
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Calming Your Adrenals</h4><p>This plan specifically excludes stimulants and high-glycemic spikes that trigger cortisol release. By stabilizing your blood sugar with complex carbs and protein, we tell your body it is "safe," allowing your adrenal glands to rest and recover.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Strategic Carb Timing</h4><p>We include specific slow-releasing carbohydrates in the evening (like sweet potatoes). This naturally lowers cortisol levels and boosts serotonin production, helping you wind down and improving sleep qualitythe foundation of hormone repair.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Magnesium-Rich Ingredients</h4><p>High-stress burns through magnesium. This menu is packed with magnesium-rich foods like leafy greens, seeds, and cacao to actively replenish your stores, relaxing your nervous system and reducing anxiety.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Anti-Inflammatory fats</h4><p>Healthy fats from avocados, nuts, and seeds provide the raw materials for hormone production while damping down the systemic inflammation caused by chronic stress.</p></div>
                    `,
                    welcomeText: "Your biochemical reset is active. Cortisol levels are stabilizing."
                },
                ESTROGEN: {
                    title: "Your Estrogen Detox Protocol",
                    subtitle: "<strong>The \"Dominance\" Profile.</strong> Heavy cycles, bloating, and mood swings. This plan amplifies fiber and liver support to safely flush excess hormones.",
                    goldenRules: `
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">1. Cruciferous Daily</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Eat Broccoli, Kale, or Brussels Sprouts <strong>daily</strong>. They contain compounds (DIM) that active the liver's detox pathways.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">2. Raw Carrot Salad</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Eat your raw carrot salad <strong>every day</strong>. Its unique fiber acts like a sponge for endotoxins and excess estrogen.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">3. Hydration</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Drink <strong>3 Liters</strong> of water. Your kidneys are a major detox organ; keep them flushed to reduce bloating.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">4. Zero Alcohol</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p><strong>Strict No Alcohol.</strong> Ethanol pauses fat burning and liver detox for up to 48 hours. Give your liver a break.</p></div></div>
                    `,
                    spotlight: `
                        <img src="protocols/estrogen/images/raw_carrot_salad_spotlight.png" style="width:150px; height:150px; object-fit:cover; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
                         <div><h3 style="color:var(--secondary);">Medicinal Power: Raw Carrot Salad</h3><p><strong>Not just a side dish.</strong> Raw carrots contain a unique fiber that binds to estrogen in the intestine, preventing reabsorption. Paired with coconut oil and vinegar, it is a powerful daily detox tool.</p></div>
                    `,
                    whyWorks: `
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Supporting Liver Detoxification</h4><p>Your liver is responsible for clearing excess estrogen. This plan is rich in cruciferous vegetables (broccoli, kale, cauliflower) containing Indole-3-Carbinol, a compound that directly supports the liver's ability to safely metabolize and excrete used hormones.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Fiber "Estrogen Trap"</h4><p>Once the liver processes estrogen, it needs to be eliminated. The high soluble fiber content in this plan (from oats, beans, flax) acts like a sponge in your gut, binding to this "old" estrogen and ensuring it leaves your body instead of being reabsorbed.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Phytoestrogen Modulation</h4><p>We use specific plant foods like flaxseeds and legumes that contain phytoestrogens. These smart compounds help balance your levelsproviding a weak estrogenic effect if you're low, but competing with potent estrogens if you're high, creating a smoother ride.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Gut Microbiome Support</h4><p>A healthy gut minimizes the enzyme beta-glucuronidase, which can recycle bad estrogen. This diverse, plant-based menu feeds the beneficial bacteria needed to keep this enzyme in check.</p></div>
                    `,
                    welcomeText: "Your biochemical reset is active. Estrogen detoxification is active."
                }
            };

            const selectedSymptoms = (data.symptoms || '').split(',').map(s => s.trim()).filter(Boolean);

            // 0.5. Apply Unified Content
            const resultType = sessionStorage.getItem('userResult') || 'CORTISOL';
            const profileKey = (resultType.toUpperCase().includes('ESTROGEN')) ? 'ESTROGEN' : 'CORTISOL';
            const content = APP_CONTENT[profileKey];

            if(content) {
                // Intro / Dashboard
                const heroTitle = document.getElementById('hero-title');
                if(heroTitle) heroTitle.innerHTML = content.title;

                const heroSubtitle = document.getElementById('hero-subtitle');
                if(heroSubtitle) heroSubtitle.innerHTML = content.subtitle;
                
                // Welcome Text (Day 1)
                const welcomeMsg = document.getElementById('welcome-message');
                if(welcomeMsg) welcomeMsg.textContent = content.welcomeText;

                // Golden Rules
                const rulesContainer = document.getElementById('golden-rules-container');
                if(rulesContainer) rulesContainer.innerHTML = content.goldenRules;

                // Spotlight
                const spotlightBody = document.getElementById('spotlight-body');
                if(spotlightBody) spotlightBody.innerHTML = content.spotlight;

                // Why Works
                const whyWorksBody = document.getElementById('why-works-body');
                if(whyWorksBody) whyWorksBody.innerHTML = content.whyWorks;
            }
            
            // 2. Symptom Data (Mirrored from Landing Page)
            const symptomData = {
                bloating: {
                    title: 'SYMPTOM: BLOATING & DIGESTION',
                    wrong: "Dwindling estrogen slows gastric emptying. Your digestion is literally moving slower, causing fermentation and that 'hard' belly feeling.",
                    fix: "We use the 'Flora-Flush' sequence. By rotating specific enzyme-active plants, we clear the digestive backlog and flatten the 'Endo-Belly' in days."
                },
                joint_pain: {
                    title: 'SYMPTOM: JOINTS & INFLAMMATION',
                    wrong: "Estrogen is nature's anti-inflammatory. As it drops, your joints lose hydration and fascia becomes sticky, causing that 'stiff and achy' feeling.",
                    fix: "We implement 'Structural Hydration.' We use specific mineral-dense liquids and collagen-protecting plants to re-lubricate your joints from the inside out."
                },
                mood: {
                    title: 'SYMPTOM: MOOD & IRRITABILITY',
                    wrong: "Estrogen protects your serotonin receptors. When it fluctuates, your emotional 'buffer' disappears, leading to sudden rage or weepiness.",
                    fix: "The 'Neuro-Buffering' Protocol. We use amino-acid rich plant pairings to stabilize your dopamine and serotonin pathways, giving you your patience back."
                },
                hair_skin: {
                    title: 'SYMPTOM: HAIR & SKIN CHANGES',
                    wrong: "As estrogen drops, your relative testosterone levels become dominant, attacking hair follicles and causing 'crepey' or dry skin.",
                    fix: "The 'Follicle-Fortress' Strategy. We block DHT naturally using specific plant sterols and re-hydrate the dermal layers with essential fatty acids."
                },
                hot_flashes: {
                    title: 'SYMPTOM: HOT FLASHES & SWEATS',
                    wrong: "Your hypothalamus is misreading low estrogen as 'overheating,' triggering a false panic-cooldown response that results in sweats.",
                    fix: "The 'Thermostat Reset.' We use cooling phytoestrogens and evening primrose timing to 'lie' to your brain's thermostat and keep your core temperature stable."
                },
                libido: {
                    title: 'SYMPTOM: LOW LIBIDO',
                    wrong: "Dopamine drives desire, but it needs estrogen to fire effectively. Without it, the 'spark' feels physically and mentally distant.",
                    fix: "The 'Spark-Ignition' Protocol. We clear neural pathways and use natural vasodilation plants to increase physical sensitivity and mental desire."
                },
                anxiety: {
                    title: 'SYMPTOM: ANXIETY & DREAD',
                    wrong: "Progesterone is your brain's natural 'chill-pill.' When it crashes, your GABA receptors are left unprotected, causing spikes of dread.",
                    fix: "The 'GABA-Guard' Sequence. We use magnesium-rich plant chelation and specific breathing windows to manually override the panic response."
                },
                weight_gain: {
                    title: 'SYMPTOM: UNEXPECTED WEIGHT GAIN',
                    wrong: "Your body is in 'Storage Mode.' It's hoarding fat to protect your bones and produce emergency estrogen, making standard dieting useless.",
                    fix: "The 'Metabolic Flip.' We switch your body from 'Storage' to 'Fuel' mode by hitting specific insulin triggers and using anti-inflammatory fats."
                }
            };

            // 3. Render Logic
            const container = document.getElementById('symptom-content-container');
            const wrapper = document.getElementById('dynamic-symptom-section');
            
            const activeSymptoms = selectedSymptoms
                .filter(s => symptomData[s])
                .map(s => symptomData[s]);

            if (activeSymptoms.length > 0) {
                wrapper.style.display = 'block';
                container.innerHTML = activeSymptoms.map(s => `
                    <div style="margin-bottom: 20px; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <h4 style="color: #48864B; margin: 0 0 10px 0; font-size: 0.9rem;">${s.title}</h4>
                        <p style="font-size: 0.9rem; color: #475569; margin-bottom: 10px;"><strong>The Issue:</strong> ${s.wrong}</p>
                        <p style="font-size: 0.9rem; color: #1e293b; margin: 0;"><strong>The Fix:</strong> ${s.fix}</p>
                    </div>
                `).join('');

                // 4. Meal Card Badging Logic
                applyMealBadges(selectedSymptoms);
            }

            // Expose function globally for re-triggering
            window.applyMealBadges = function(symptomList) {
                const symptoms = symptomList || JSON.parse(sessionStorage.getItem('userProfile') || '{}').symptoms || [];

                // Map symptoms to keywords/meal types
                const mappings = {
                    'mood': { type: 'BREAKFAST', badge: '🧠 Brain-Fat Focus', color: '#fef3c7', text: '#8a7e30' }, /* Greeny Gold Text */
                    'bloating': { type: 'DINNER', badge: '🦠 Flora-Flush', color: '#dcfce7', text: '#166534' },
                    'joint_pain': { type: 'SMOOTHIE', badge: '🦴 Structural Hydration', color: '#dbeafe', text: '#1e40af' },
                    'anxiety': { type: 'SNACK', badge: '🛡️ GABA-Guard', color: '#f3e8ff', text: '#6b21a8' },
                    'weight_gain': { type: 'LUNCH', badge: '🔥 Metabolic Spark', color: '#ffe4e6', text: '#9f1239' }
                };

                symptoms.forEach(s => {
                    const map = mappings[s];
                    if (map) {
                        document.querySelectorAll('.meta').forEach(meta => {
                            if (meta.textContent.toUpperCase().includes(map.type)) {
                                const titleInfoDiv = meta.parentElement;
                                const title = titleInfoDiv.querySelector('.meal-title');
                                
                                if (title && !title.querySelector('.dynamic-badge')) {
                                    const badge = document.createElement('span');
                                    badge.className = 'dynamic-badge';
                                    badge.textContent = map.badge;
                                    badge.style.cssText = `
                                        background: ${map.color}; 
                                        color: ${map.text}; 
                                        padding: 4px 8px; 
                                        border-radius: 4px; 
                                        font-size: 0.65rem; 
                                        font-weight: 700; 
                                        text-transform: uppercase; 
                                        margin-left: 10px;
                                        display: inline-block;
                                        vertical-align: middle;
                                        line-height: 1.2;
                                    `;
                                    title.appendChild(badge);
                                }
                            }
                        });
                    }
                });
            };

            // Run on load
            window.applyMealBadges();

        } catch(e) { console.error("Symptom Injection and Badging Error", e); }
    })();

    // --- NEW: Coach & Photo Logic ---
    window.addEventListener('DOMContentLoaded', async () => {
        injectReflectionsIntoDays();

        // NOTE: Do NOT call applyGenderTheme() here - it must run AFTER loadProfileData()
        // restores gender from the database, otherwise it defaults to female

        // Wait for Auth before loading user-specific data
        const waitForAuth = () => new Promise(resolve => {
            if(window.currentUser) return resolve(window.currentUser);
            const check = setInterval(() => {
                if(window.currentUser) {
                    clearInterval(check);
                    resolve(window.currentUser);
                }
            }, 100);
            // Timeout after 5s just in case
            setTimeout(() => { clearInterval(check); resolve(null); }, 5000);
        });

        await waitForAuth();

        if(window.currentUser) {
            loadChat();
            loadJournalHistory();
            await syncQuizDataToDb(); // Sync quiz data first
            await seedTestAccount(); // Inject fake data for test user
            await loadProfileData(); // Ensure profile is loaded (includes gender restore)
            initProgramDate(); // Ensure program date is synced

            // Apply saved theme AFTER gender is loaded from database
            const savedTheme = localStorage.getItem('userThemePreference') || 'default';
            if (typeof applyAppTheme === 'function') {
                applyAppTheme(savedTheme);
            }

            // Check if essential quiz data is missing and trigger onboarding wizard
            await checkAndTriggerOnboarding();

            // Update dashboard workout card to show today's recommended workout
            if(typeof updateDashboardWorkoutCard === 'function') updateDashboardWorkoutCard();

            // Also refresh community feed if function exists
            if(typeof window.loadCommunityFeed === 'function') window.loadCommunityFeed();

            // Switch to dashboard as default entry point
            if(typeof switchAppTab === 'function') {
                const homeNav = document.querySelector('.nav-item');
                switchAppTab('dashboard', homeNav);
            }

            // --- TEST DATA SEEDING ---
            async function seedTestAccount() {
                if (window.currentUser?.email === 'shannonbirch@cocospersonaltraining.com') {
                    console.log("🧪 Seeding Test Account Data...");
                    
                    const coreUpdates = {
                        name: 'Shannon Test'
                    };

                    const factUpdates = {
                        profile: 'CORTISOL', // Hormone Type
                        equipment_access: 'none', // Just a mat (Triggers: Yoga, Bodyweight only)
                        energy_status: 'moderate',
                        goal: 'Fat Loss',
                        // Quiz Answers mapping to symptoms
                        keeps_awake: 'worry',     // -> Anxiety
                        midday_crash: 'yes',      // -> Fatigue
                        brain_fog: 'yes',         // -> Fatigue
                        symptoms: ['anxiety', 'fatigue'] // Explicitly set for immediate testing
                    };
                    
                    try {
                        // 1. Core Profile (users table)
                        try {
                            await dbHelpers.users.upsert(window.currentUser.id, coreUpdates);
                        } catch (coreError) {
                            console.warn("⚠️ Could not update core 'users' table (likely RLS). Proceeding to 'user_facts'.", coreError);
                        }
                        
                        // 2. Extended Facts (user_facts table)
                        let existingFacts = {}; 
                        try { existingFacts = await dbHelpers.userFacts.get(window.currentUser.id); } catch(e){}
                        const currentDetails = existingFacts?.personal_details || {};
                        
                        // Force explicit symptoms to prove it works
                        const finalFacts = { ...currentDetails, ...factUpdates };
                        // Ensure symptoms are set if not already present or if forceful overwrite needed
                        // For test account, we force them.
                        finalFacts.symptoms = ['anxiety', 'bloating', 'fatigue'];

                        await dbHelpers.userFacts.upsert(window.currentUser.id, {
                            personal_details: finalFacts
                        });

                        window.userProfile = { ...window.userProfile, ...coreUpdates, ...factUpdates, symptoms: finalFacts.symptoms };
                        console.log("✅ Test Data Injected Successfully: ", window.userProfile);
                        
                        // Force UI refresh if profile view is active
                        if(typeof loadProfileData === 'function') setTimeout(loadProfileData, 500);
                    } catch (e) {
                        console.error("❌ Failed to seed test data (Fatal)", e);
                    }
                }

                // Test account that skips quiz but shows onboarding slides
                if (window.currentUser?.email === 'shannonrhysbirch@gmail.com') {
                    console.log("🧪 Setting up Onboarding Test Account (skips quiz, shows onboarding)...");

                    // Clear onboarding complete flag to ensure wizard shows
                    localStorage.removeItem('onboardingComplete');

                    // Clear any cached quiz data from sessionStorage
                    sessionStorage.removeItem('userProfile');

                    // Clear quiz results from database to ensure onboarding triggers
                    try {
                        await window.supabaseClient
                            .from('quiz_results')
                            .delete()
                            .eq('user_id', window.currentUser.id);
                        console.log("✅ Cleared quiz results for onboarding test account");
                    } catch(e) {
                        console.warn("⚠️ Could not clear quiz results:", e);
                    }

                    console.log("✅ Onboarding Test Account Ready - wizard will show");
                }
            }

            // Auto-show Daily Wellness check-in (once per day)
            // NOTE: Moved to after onboarding completes - handled by finishOnboarding()
            // This ensures check-in only shows AFTER user selects gender in onboarding
        }
    });

    function injectReflectionsIntoDays() {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        // Find all day views
        document.querySelectorAll('.day-view').forEach(view => {
            const id = view.id; // e.g., week1-Monday
            if (!id) return;
            
            // Check if it ends with a day name
            const isDay = days.some(day => id.endsWith(day));
            if (!isDay) return;

            // Check if already injected
            if (view.querySelector('.reflection-card')) return;

            const div = document.createElement('div');
            div.className = 'card reflection-card';
            div.innerHTML = `
                <div class="card-header" style="background: white; cursor: default;">
                    <div class="meal-title" style="color: var(--primary);">End of Day Reflection</div>
                </div>
                <div class="card-body" style="padding: 25px; max-height: none; opacity: 1;">
                    <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 20px;">How did you feel today? Any wins or challenges?</p>
                    <textarea id="ref-${id}" placeholder="Journal your thoughts here..." style="width: 100%; height: 120px; padding: 15px; border: 1px solid #cbd5e0; border-radius: 8px; font-family: 'Inter'; font-size: 0.95rem; resize: vertical; margin-bottom: 15px;"></textarea>
                    <button onclick="saveDayReflection('${id}')" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">Save Entry</button>
                    <span id="status-${id}" style="margin-left: 15px; font-size: 0.85rem; color: #166534;"></span>
                </div>
            `;
            view.appendChild(div);

            // Load saved reflection
            const saved = localStorage.getItem('reflection_' + id);
            if (saved) {
                div.querySelector('textarea').value = saved;
            }
        });
    }

    window.saveDayReflection = function(id) {
        const val = document.getElementById('ref-' + id).value;
        if (!val.trim()) return;
        
        // Save locally
        localStorage.setItem('reflection_' + id, val);
        
        const status = document.getElementById('status-' + id);
        status.textContent = "Saved to your journal.";
        setTimeout(() => { status.textContent = ""; }, 3000);

        // Re-render journal history
        loadJournalHistory();

        // Trigger Celebration
        // Parse "week1-Monday" to get "Day X" or just confirm "Day Complete"
        // For simplicity, we can map days to numbers or just say "You did it!"
        showDayCompletion(id);
    };

    window.showDayCompletion = function(dayId) {
        const modal = document.getElementById('day-completion-modal');
        const text = document.getElementById('completion-text');
        
        // Simple heuristic for day number
        // Assuming we are on Day 1 for demo if not strictly tracked elsewhere in this simpler version
        // Or extract from dayId if it was "day1" etc. 
        // dayId format: "week1-Monday"
        
        let displayDay = "Today";
        if(dayId.includes('Monday')) displayDay = "Day 1";
        if(dayId.includes('Tuesday')) displayDay = "Day 2";
        if(dayId.includes('Wednesday')) displayDay = "Day 3";
        if(dayId.includes('Thursday')) displayDay = "Day 4";
        if(dayId.includes('Friday')) displayDay = "Day 5";
        if(dayId.includes('Saturday')) displayDay = "Day 6";
        if(dayId.includes('Sunday')) displayDay = "Day 7";

        text.textContent = `You have successfully completed ${displayDay}.`;
        modal.style.display = 'flex';
        triggerConfetti();
    }

    window.closeCompletionModal = function() {
        document.getElementById('day-completion-modal').style.display = 'none';
    }

    window.triggerConfetti = function() {
        // Simple JS confetti
        const colors = ['#d4af37', '#046A38', '#ffffff', '#f0fdf4'];
        for(let i=0; i<50; i++) {
            const el = document.createElement('div');
            el.className = 'confetti-piece';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            el.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 5000);
        }
    }
    
    // Inject confetti styles if not present
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    `;
    document.head.appendChild(style);

    // --- MOVEMENT STUDIO DB & LOGIC ---
    // --- WORKOUT TRACKER & DATABASE LOGIC ---
    
    // 1. Configuration
    const DEFAULT_WORKOUT = [
        { id: 'sq_01', name: 'Goblet Squat', thumb: 'https://images.unsplash.com/photo-1574680096145-d05b474e2155?w=150', video: 'MeIiIdhvOUg', sets: 3 },
        { id: 'dl_01', name: 'Romanian Deadlift', thumb: 'https://images.unsplash.com/photo-1605296867304-46d5465a13f1?w=150', video: 'vI2jU4zFfK8', sets: 3 },
        { id: 'push_01', name: 'Kneeling Push Up', thumb: 'https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?w=150', video: 'WPHG8tJ9bO0', sets: 3 }
    ];

    let myWorkout = JSON.parse(localStorage.getItem('myCurrentWorkout')) || DEFAULT_WORKOUT;
    let rapidApiKey = localStorage.getItem('rapidApiKey') || ''; // User needs to set this

    // 2. Initialize
    async function loadMovementStudio() {
        renderWorkoutList();
    }

    // 3. Render Workout List (Trainerize Style)
    function renderWorkoutList() {
        const container = document.getElementById('workout-list');
        if(!container) return;
        
        if(myWorkout.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">No exercises added. Go to Library to add some!</div>`;
            return;
        }

        container.innerHTML = myWorkout.map((ex, index) => `
            <div class="card" style="margin-bottom:20px; border:1px solid #e2e8f0; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <!-- Header -->
                <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <img src="${ex.thumb || 'https://via.placeholder.com/50'}" style="width:50px; height:50px; border-radius:8px; object-fit:cover; background:white;">
                        <div>
                            <h4 style="margin:0; color:var(--primary); font-size:1rem;">${ex.name}</h4>
                            ${ex.video ? `<button onclick="openExerciseModal('${ex.video}')" style="background:none; border:none; color:#3b82f6; font-size:0.75rem; cursor:pointer; padding:0; display:flex; align-items:center; gap:4px; margin-top:4px;">? Watch Demo</button>` : ''}
                        </div>
                    </div>
                     <button onclick="removeExercise(${index})" style="color:#ef4444; background:none; border:none; font-size:0.8rem; cursor:pointer;">Remove</button>
                </div>
                <!-- Sets -->
                <div style="padding:15px;">
                    <div style="display:grid; grid-template-columns: 40px 1fr 1fr 40px; gap:10px; margin-bottom:10px; font-size:0.7rem; color:#64748b; font-weight:700; text-transform:uppercase; text-align:center;">
                        <div>Set</div>
                        <div>kg / lbs</div>
                        <div>Reps</div>
                        <div></div>
                    </div>
                    ${Array(ex.sets || 3).fill(0).map((_, i) => `
                        <div style="display:grid; grid-template-columns: 40px 1fr 1fr 40px; gap:10px; margin-bottom:8px; align-items:center;">
                            <div style="text-align:center; color:#94a3b8; font-weight:600; font-size:0.9rem;">${i + 1}</div>
                            <input type="number" placeholder="0" style="width:100%; padding:8px; border:1px solid #cbd5e0; border-radius:6px; text-align:center; background:#f8fafc;">
                            <input type="number" placeholder="0" style="width:100%; padding:8px; border:1px solid #cbd5e0; border-radius:6px; text-align:center; background:#f8fafc;">
                            <div class="check-circle" onclick="this.classList.toggle('completed')" style="width:32px; height:32px; border:2px solid #e2e8f0; border-radius:50%; margin:0 auto; cursor:pointer; display:flex; align-items:center; justify-content:center; color:white; transition:all 0.2s;">✓</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    // 4. ExerciseDB Integration (RapidAPI)
    window.searchRapidAPI = async function() {
        const query = document.getElementById('db-search-input').value.trim();
        const grid = document.getElementById('library-results');
        
        if(!rapidApiKey) {
            alert("Please set your RapidAPI Key first (click 'Update API Key'). Using Demo Data for now.");
            // Demo Fallback
            renderLibraryResults([
                { id: 'demo1', name: 'Barbell Squat', bodyPart: 'legs', gifUrl: 'https://v2.exercisedb.io/image/demo-squat.gif', target: 'glutes' },
                { id: 'demo2', name: 'Dumbbell Lunge', bodyPart: 'legs', gifUrl: 'https://v2.exercisedb.io/image/demo-lunge.gif', target: 'quads' },
                { id: 'demo3', name: 'Plank', bodyPart: 'core', gifUrl: 'https://v2.exercisedb.io/image/demo-plank.gif', target: 'abs' }
            ]); 
            return;
        }

        if(!query) return;

        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;">Searching ExerciseDB...</div>';

        try {
            const url = `https://exercisedb.p.rapidapi.com/exercises/name/${query}`;
            const options = {
                method: 'GET',
                headers: {
                    'X-RapidAPI-Key': rapidApiKey,
                    'X-RapidAPI-Host': 'exercisedb.p.rapidapi.com'
                }
            };

            const response = await fetch(url, options);
            const result = await response.json();
            
            if(Array.isArray(result)) {
                renderLibraryResults(result.slice(0, 20)); // Limit 20
            } else {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;">No results found.</div>';
            }

        } catch (error) {
            console.error(error);
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red; padding:20px;">Error fetching data. Check Console.</div>';
        }
    }

    function renderLibraryResults(list) {
        const grid = document.getElementById('library-results');
        grid.innerHTML = list.map(item => `
            <div class="card" style="margin:0; text-align:center; padding:10px; cursor:pointer; transition:all 0.2s; touch-action: manipulation; user-select: none;" onclick="addToWorkout('${item.name.replace(/'/g, "\\'")}', '${item.gifUrl}')">
                <img src="${item.gifUrl}" style="width:100%; height:120px; object-fit:contain; mix-blend-mode:multiply; margin-bottom:10px; pointer-events: none;">
                <h5 style="margin:0 0 5px 0; font-size:0.85rem; color:var(--primary);">${item.name}</h5>
                <small style="color:#64748b; text-transform:uppercase; font-size:0.7rem;">${item.bodyPart || item.target}</small>
                <div style="margin-top:10px; color:var(--secondary); font-size:0.8rem; font-weight:600;">+ Add</div>
            </div>
        `).join('');
    }

    // Load exercise library from EXERCISE_VIDEOS (Google Drive)
    window.loadExerciseLibrary = function(searchQuery = '') {
        const grid = document.getElementById('library-results');

        // Safety check for library loading
        if (typeof EXERCISE_VIDEOS === 'undefined') {
            grid.innerHTML = `
                <div style="grid-column:1/-1; padding:20px; text-align:center; color:red; background:#fee2e2; border-radius:12px;">
                    <strong>Error: Exercise Library Not Loaded</strong><br>
                    <div style="font-size:0.8rem; margin-top:5px;">Please verify 'exercise_videos.js' file exists and is in the same folder.</div>
                </div>`;
            return;
        }

        const allExercises = Object.keys(EXERCISE_VIDEOS);

        if (allExercises.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">Exercise library is empty.</div>';
            return;
        }

        // Filter by search query if provided
        let filteredExercises = allExercises;
        if (searchQuery) {
            const terms = searchQuery.toLowerCase().split(' ');
            filteredExercises = allExercises.filter(name => {
                const nameLower = name.toLowerCase();
                return terms.every(term => nameLower.includes(term));
            });
        }

        if (filteredExercises.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">No exercises found matching your search.</div>';
            return;
        }

        // Limit to first 100 exercises for performance
        const displayExercises = filteredExercises.slice(0, 100);

        grid.innerHTML = displayExercises.map(name => {
            const videoUrl = EXERCISE_VIDEOS[name];
            const escapedName = name.replace(/'/g, "\\'");
            const escapedUrl = videoUrl.replace(/'/g, "\\'");

            return `
                <div class="card" style="margin:0; text-align:center; padding:12px; cursor:pointer; transition:all 0.2s; position:relative;" onclick="openExerciseVideo('${escapedUrl}', '${escapedName}')">
                    <div style="width:100%; height:120px; background:#f8fafc; border-radius:8px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; position:relative; overflow:hidden;">
                        <svg style="width:48px; height:48px; color:#cbd5e0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div style="position:absolute; bottom:5px; right:5px; background:rgba(0,0,0,0.6); color:white; font-size:0.65rem; padding:2px 6px; border-radius:4px;">VIDEO</div>
                    </div>
                    <h5 style="margin:0 0 5px 0; font-size:0.85rem; color:var(--primary); line-height:1.3;">${name}</h5>
                    <div style="margin-top:8px; color:var(--secondary); font-size:0.75rem; font-weight:600;">▶ Watch</div>
                </div>
            `;
        }).join('');

        if (displayExercises.length < filteredExercises.length) {
            grid.innerHTML += `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#94a3b8; font-size:0.9rem;">Showing first ${displayExercises.length} of ${filteredExercises.length} exercises. Use search to narrow down.</div>`;
        }
    }

    window.addToWorkout = function(name, gif) {
        myWorkout.push({
            id: 'ex_' + Date.now(),
            name: name,
            thumb: gif,
            video: null, // No YT video for API items
            sets: 3
        });
        localStorage.setItem('myCurrentWorkout', JSON.stringify(myWorkout));
        alert(`${name} added to workout!`);
        switchTrackerView('workout');
    }

    window.removeExercise = function(index) {
        if(confirm('Remove this exercise?')) {
            myWorkout.splice(index, 1);
            localStorage.setItem('myCurrentWorkout', JSON.stringify(myWorkout));
            renderWorkoutList();
        }
    }

    window.promptApiKey = function() {
        const key = prompt("Enter your RapidAPI Key for ExerciseDB:", rapidApiKey);
        if(key) {
            rapidApiKey = key;
            localStorage.setItem('rapidApiKey', key);
            alert("API Key Saved.");
        }
    }

    window.switchTrackerView = function(view) {
        document.getElementById('view-workout').style.display = view === 'workout' ? 'block' : 'none';
        document.getElementById('view-library').style.display = view === 'library' ? 'block' : 'none';

        const btnW = document.getElementById('btn-workout');
        const btnL = document.getElementById('btn-library');

        if(view === 'workout') {
            btnW.style.color = 'var(--primary)'; btnW.style.borderBottomColor = 'var(--primary)';
            btnL.style.color = '#94a3b8'; btnL.style.borderBottomColor = 'transparent';
            renderWorkoutList();
        } else {
            btnL.style.color = 'var(--primary)'; btnL.style.borderBottomColor = 'var(--primary)';
            btnW.style.color = '#94a3b8'; btnW.style.borderBottomColor = 'transparent';
            loadExerciseLibrary(); // Load exercise library with videos
        }
    }
    
    // Style check circles
    document.head.insertAdjacentHTML('beforeend', `<style>.check-circle.completed { background: #10b981 !important; border-color: #10b981 !important; }</style>`);

    // --- END TRACKER LOGIC ---

    // Call this on load
    window.addEventListener('DOMContentLoaded', () => {
         loadMovementStudio();
    });

    // Chat
    window.toggleFloatingChat = function() {
        const box = document.getElementById('floating-chat-box');
        if(box.style.display === 'none' || !box.style.display) {
            box.style.display = 'flex';
        } else {
            box.style.display = 'none';
        }
    }

    window.sendChatMessage = function(inputEl) {
        let input;
        if (inputEl) {
            input = inputEl;
        } else {
            input = document.getElementById('chat-input');
        }
        
        const txt = input.value.trim();
        if(!txt) return;

        // Add user msg to ALL containers
        addMessage(txt, 'user');
        
        // Clear inputs
        document.querySelectorAll('input[type="text"]').forEach(el => {
             if(el.id === 'chat-input' || el.classList.contains('chat-input-field')) el.value = '';
        });
        
        // Save
        saveChatToStorage(txt, 'user');

        // Simulate AI Pending
        setTimeout(() => {
        }, 1000);
    }
    
    function addMessage(text, sender) {
        document.querySelectorAll('.chat-history-container').forEach(container => {
            const div = document.createElement('div');
            const isUser = sender === 'user';
            
            div.style.cssText = isUser 
                ? "align-self: flex-end; background: var(--primary); color: white; padding: 12px 16px; border-radius: 12px 12px 0 12px; max-width: 85%;"
                : "align-self: flex-start; background: white; padding: 12px 16px; border-radius: 12px 12px 12px 0; border: 1px solid #e2e8f0; max-width: 85%;";
                
            div.innerHTML = `
                <p style="margin: 0; font-size: 0.95rem;">${text}</p>
                <span style="font-size: 0.75rem; color: ${isUser ? 'rgba(255,255,255,0.7)' : '#94a3b8'}; display: block; margin-top: 5px; text-align: right;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        });
    }

    function saveChatToStorage(text, sender) {
        const chat = JSON.parse(localStorage.getItem('myChatStats') || '[]');
        chat.push({ text, sender, time: new Date().toISOString() });
        localStorage.setItem('myChatStats', JSON.stringify(chat));
    }

    function loadChat() {
        const chat = JSON.parse(localStorage.getItem('myChatStats') || '[]');
        chat.forEach(msg => addMessage(msg.text, msg.sender));
    }

    // Journal History
    function loadJournalHistory() {
        const journalContainer = document.getElementById('journal-history');
        if (!journalContainer) return;
        journalContainer.innerHTML = ''; // Clear previous entries

        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const weeks = ['week1', 'week2', 'week3', 'week4'];

        let hasEntries = false;

        weeks.forEach(week => {
            days.forEach(day => {
                const id = `${week}-${day}`;
                const savedReflection = localStorage.getItem('reflection_' + id);
                if (savedReflection) {
                    hasEntries = true;
                    const entryDiv = document.createElement('div');
                    entryDiv.style.cssText = 'margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;';
                    entryDiv.innerHTML = `
                        <h5 style="margin: 0 0 8px 0; color: var(--primary-light); font-size: 0.95rem;">${week.charAt(0).toUpperCase() + week.slice(1)} - ${day}</h5>
                        <p style="margin: 0; font-size: 0.9rem; color: #4a5568;">${savedReflection}</p>
                    `;
                    journalContainer.appendChild(entryDiv);
                }
            });
        });

        if (!hasEntries) {
            journalContainer.innerHTML = '<p style="font-style: italic; color: var(--text-muted);">No journal entries yet. Start writing your daily reflections!</p>';
        }
    }

    // ==========================================
    // REFLECTIONS DIARY SYSTEM
    // ==========================================

    // Load all reflections (meal plan + standalone) and display chronologically
    function loadAllReflections() {
        const container = document.getElementById('reflections-list');
        if (!container) return;

        const reflections = [];

        // 1. Load meal plan reflections
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const weeks = ['week1', 'week2', 'week3', 'week4'];

        weeks.forEach(week => {
            days.forEach(day => {
                const id = `${week}-${day}`;
                const savedReflection = localStorage.getItem('reflection_' + id);
                if (savedReflection) {
                    reflections.push({
                        type: 'mealplan',
                        id: id,
                        title: `${week.charAt(0).toUpperCase() + week.slice(1)} - ${day}`,
                        text: savedReflection,
                        timestamp: 0 // Meal plan reflections don't have timestamps, will show at bottom
                    });
                }
            });
        });

        // 2. Load standalone reflections
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('standalone_reflection_')) {
                const data = JSON.parse(localStorage.getItem(key));
                reflections.push({
                    type: 'standalone',
                    id: key,
                    title: formatReflectionDate(data.timestamp),
                    text: data.text,
                    timestamp: data.timestamp
                });
            }
        }

        // 3. Sort by timestamp (newest first, meal plan at bottom)
        reflections.sort((a, b) => b.timestamp - a.timestamp);

        // 4. Render
        if (reflections.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">📔</div>
                    <p style="margin: 0; font-size: 1rem; font-weight: 500;">No reflections yet</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.875rem;">Start by adding your first reflection or complete a meal plan day</p>
                </div>
            `;
        } else {
            container.innerHTML = '';
            reflections.forEach(r => {
                const entryDiv = document.createElement('div');
                entryDiv.style.cssText = 'margin-bottom: 15px; padding: 18px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;';
                entryDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--primary);">${r.title}</div>
                        ${r.type === 'standalone' ? `<button onclick="deleteReflection('${r.id}')" style="background: none; border: none; color: #94a3b8; cursor: pointer; padding: 0; font-size: 1.2rem; line-height: 1;">&times;</button>` : ''}
                    </div>
                    <div style="font-size: 0.95rem; color: #1e293b; line-height: 1.6; white-space: pre-wrap;">${r.text}</div>
                `;
                container.appendChild(entryDiv);
            });
        }
    }

    // Format timestamp to readable date
    function formatReflectionDate(timestamp) {
        if (!timestamp) return 'Meal Plan Entry';
        const date = new Date(timestamp);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        // Check if today
        if (date.toDateString() === today.toDateString()) {
            return 'Today, ' + date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
        }

        // Check if yesterday
        if (date.toDateString() === yesterday.toDateString()) {
            return 'Yesterday, ' + date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
        }

        // Otherwise show full date
        return date.toLocaleDateString('en-AU', {
            weekday: 'short',
            day: 'numeric',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Open modal to add new reflection
    window.openNewReflectionModal = function() {
        const modal = document.createElement('div');
        modal.id = 'reflection-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; max-width: 500px; width: 100%; padding: 25px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 1.3rem; color: var(--text-main);">New Reflection</h3>
                    <button onclick="closeReflectionModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                </div>
                <p style="margin: 0 0 15px 0; font-size: 0.9rem; color: #64748b;">How are you feeling? Any wins or challenges today?</p>
                <textarea id="new-reflection-text" placeholder="Write your thoughts..." style="width: 100%; height: 200px; padding: 15px; border: 1px solid #cbd5e0; border-radius: 8px; font-family: 'Inter'; font-size: 1rem; resize: vertical; margin-bottom: 20px;"></textarea>
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeReflectionModal()" style="flex: 1; background: #f1f5f9; color: #64748b; border: none; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Cancel</button>
                    <button onclick="saveNewReflection()" style="flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Save</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Focus textarea
        setTimeout(() => {
            document.getElementById('new-reflection-text').focus();
        }, 100);
    }

    // Close modal
    window.closeReflectionModal = function() {
        const modal = document.getElementById('reflection-modal');
        if (modal) modal.remove();
    }

    // Save new standalone reflection
    window.saveNewReflection = function() {
        const text = document.getElementById('new-reflection-text').value.trim();
        if (!text) return;

        const timestamp = Date.now();
        const id = `standalone_reflection_${timestamp}`;

        localStorage.setItem(id, JSON.stringify({
            text: text,
            timestamp: timestamp
        }));

        closeReflectionModal();
        loadAllReflections();
    }

    // Delete a standalone reflection
    window.deleteReflection = function(id) {
        if (confirm('Delete this reflection?')) {
            localStorage.removeItem(id);
            loadAllReflections();
        }
    }



</script>

<!-- SMOOTHIE BOOKLOAD -->
<div class="view-section" id="smoothies">
    <div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
        <div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Adrenal Rescue</div>
        <h1 style="margin-bottom: 15px;">The 28-Day Smoothie Guide</h1>
        <p style="font-size: 1.1rem; color: #555;">Delicious, grounding recipes to stop the jitters and stabilize blood sugar.</p>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
        <!-- Recipes (Extracted from old bonuses) -->
        <div style="background: #fffdf0; border:1px solid #efe5c0; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_berry_blast.png" alt="Berry Blast" style="width:100%; height:180px; object-fit:cover; background:#e0dbe9;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">1. Cortisol-Control Berry Blast</h4>
                <div style="display:inline-block; background:#e0dbe9; color:#4a3b69; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Antioxidant Shield</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 cup frozen wild blueberries</li>
                    <li>1 handful spinach</li>
                    <li>1/4 avocado</li>
                    <li>1 scoop vanilla pea protein</li>
                    <li>1 tbsp chia seeds</li>
                    <li>1.5 cups almond milk</li>
                </ul>
            </div>
        </div>

        <div style="background: #f4f8f5; border:1px solid #dbece0; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_zen_green.png" alt="Zen Green" style="width:100%; height:180px; object-fit:cover; background:#dbece0;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">2. The "Zen Green" Rescue</h4>
                <div style="display:inline-block; background:#dbece0; color:#2d4a3e; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Cooling & Hydrating</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 cucumber, 1/2 pear</li>
                    <li>1 inch fresh ginger</li>
                    <li>Squeeze of lime</li>
                    <li>1 tbsp hemp seeds</li>
                    <li>Coconut water base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fdf6f6; border:1px solid #eadddd; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_cacao_calm.png" alt="Cacao Calm" style="width:100%; height:180px; object-fit:cover; background:#eadddd;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">3. Cacao "Night Calm"</h4>
                <div style="display:inline-block; background:#eadddd; color:#5c4242; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Serotonin Boost</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 frozen banana</li>
                    <li>1 tbsp raw cacao powder</li>
                    <li>1 tbsp almond butter</li>
                    <li>Pinch sea salt</li>
                    <li>Oat milk base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fffbef; border:1px solid #efeac0; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_golden_turmeric.png" alt="Golden Turmeric" style="width:100%; height:180px; object-fit:cover; background:#efeac0;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">4. Golden Anti-Inflammatory</h4>
                <div style="display:inline-block; background:#efeac0; color:#7a6b28; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Joint Relief</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 cup frozen mango</li>
                    <li>1 tsp turmeric + pinch pepper</li>
                    <li>1 scoop unflavored protein</li>
                    <li>1 tsp flax oil</li>
                    <li>Coconut milk base</li>
                </ul>
            </div>
        </div>

        <!-- Additional recipes to reach 10+ -->
        <div style="background: #f0fdf4; border:1px solid #dcfce7; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_avocado_lime.png" alt="Avocado Lime" style="width:100%; height:180px; object-fit:cover; background:#dcfce7;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">5. Creamy Avocado Lime</h4>
                <div style="display:inline-block; background:#dcfce7; color:#166534; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Healthy Fats</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 ripe avocado</li>
                    <li>Zest & juice of 1 lime</li>
                    <li>1 serving vanilla protein</li>
                    <li>Handful of spinach</li>
                    <li>Unsweetened cashew milk</li>
                </ul>
            </div>
        </div>

        <div style="background: #fdf2f8; border:1px solid #fce7f3; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_cherry_sleep.png" alt="Cherry Sleep" style="width:100%; height:180px; object-fit:cover; background:#fce7f3;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">6. Cherry Chamomile Sleep</h4>
                <div style="display:inline-block; background:#fce7f3; color:#9d174d; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Natural Melatonin</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 cup frozen tart cherries</li>
                    <li>1/2 cup chamomile tea (chilled)</li>
                    <li>1 tbsp almond butter</li>
                    <li>1 tsp honey (optional)</li>
                    <li>Almond milk base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fff7ed; border:1px solid #ffedd5; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_pumpkin_pie.png" alt="Pumpkin Pie" style="width:100%; height:180px; object-fit:cover; background:#ffedd5;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">7. Pumpkin Pie Protein</h4>
                <div style="display:inline-block; background:#ffedd5; color:#9a3412; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Zinc & Magnesium</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 cup pumpkin pure</li>
                    <li>1 frozen banana</li>
                    <li>1 tsp pumpkin spice</li>
                    <li>1 tbsp pumpkin seeds</li>
                    <li>Vanilla protein & oat milk</li>
                </ul>
            </div>
        </div>

        <div style="background: #f0fdfa; border:1px solid #ccfbf1; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_matcha_mint.png" alt="Matcha Mint" style="width:100%; height:180px; object-fit:cover; background:#ccfbf1;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">8. Matcha Mint Energy</h4>
                <div style="display:inline-block; background:#ccfbf1; color:#115e59; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">L-Theanine Focus</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 tsp matcha powder</li>
                    <li>Fresh mint leaves</li>
                    <li>1/2 frozen banana</li>
                    <li>Vanilla protein</li>
                    <li>Coconut milk base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fff1f2; border:1px solid #ffe4e6; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_beet_berry.png" alt="Beet Berry" style="width:100%; height:180px; object-fit:cover; background:#ffe4e6;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">9. Beet & Berry Detox</h4>
                <div style="display:inline-block; background:#ffe4e6; color:#be123c; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Liver Support</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/4 raw beet (peeled)</li>
                    <li>1 cup mixed berries</li>
                    <li>1/2 lemon (juiced)</li>
                    <li>1 tsp flax seeds</li>
                    <li>Coconut water base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fffbeb; border:1px solid #fef3c7; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_banana_nut.png" alt="Banana Bread" style="width:100%; height:180px; object-fit:cover; background:#fef3c7;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">10. Banana Nut Pre-Workout</h4>
                <div style="display:inline-block; background:#fef3c7; color:#92400e; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Sustained Fuel</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 large frozen banana</li>
                    <li>1/4 cup rolled oats</li>
                    <li>1 tbsp walnut butter</li>
                    <li>Dash of cinnamon</li>
                    <li>Almond milk base</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Print Button -->
    <div style="margin-top: 50px; text-align: center;">
         <p style="color:var(--text-muted);">Prefer a printed copy?</p>
         <a href="adrenal_smoothie_guide.html" target="_blank" style="text-decoration:none;"><button style="background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-size:1rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='var(--primary)'">Download Printable Guide</button></a>
    </div>
</div>

<!-- MOVEMENT STUDIO SECTION -->
<div class="view-section" id="movement-archive">
    <div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); color: white;">
        <div style="font-family:'Inter'; text-transform:uppercase; color:#99f6e4; font-weight:600; letter-spacing:1px; margin-bottom:10px;">Body & Mind Connection</div>
        <h1 style="margin-bottom: 15px; color: white;">Movement Studio</h1>
        <p style="font-size: 1.1rem; color: #ccfbf1;">Gentle exercises designed to support hormone balance without spiking cortisol.</p>
    </div>

    <!-- MAIN PLAYER STAGE -->
    <div id="video-stage" style="display:none; margin-bottom:30px; background:black; border-radius:15px; overflow:hidden; aspect-ratio:16/9; position:relative;">
        <div id="video-placeholder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; background:#1e293b;">
            <div style="font-size:3rem; margin-bottom:20px;">??</div>
            <div id="video-title-display" style="color:white; font-size:1.2rem; font-weight:600;">Select a Workout</div>
            <p id="video-desc-display" style="color:#94a3b8; margin-top:10px;">Duration: -- min</p>
        </div>
        <button onclick="closeVideoStage()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">&times;</button>
    </div>

    <!-- EXERCISE DATABASE GRID -->
    <h3 style="color:var(--primary); margin: 30px 0 20px 0;">Featured Sessions</h3>
    
    <!-- EXERCISE TRACKER & DATABASE (Trainerize Style) -->
    <div id="tracker-interface" style="max-width: 800px; margin: 0 auto;">
        
        <!-- Tab Switcher -->
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:30px; border-bottom:1px solid #e2e8f0; padding-bottom:15px;">
            <button onclick="switchTrackerView('workout')" id="btn-workout" style="border:none; background:none; font-weight:700; color:var(--primary); border-bottom:3px solid var(--primary); padding-bottom:5px; cursor:pointer;">Today's Workout</button>
            <button onclick="switchTrackerView('library')" id="btn-library" style="border:none; background:none; font-weight:600; color:#94a3b8; border-bottom:3px solid transparent; padding-bottom:5px; cursor:pointer;">Exercise Library</button>
        </div>

        <!-- VIEW 1: TODAY'S WORKOUT -->
        <div id="view-workout">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
               <h3 style="margin:0; color:var(--primary); display:flex; align-items:center; gap:10px;">
                   <span>??</span> Today's Session
               </h3>
               <button onclick="saveWorkout()" style="background:var(--secondary); color:white; border:none; padding:10px 25px; border-radius:30px; font-weight:600; cursor:pointer; box-shadow:0 4px 10px rgba(16, 185, 129, 0.2);">
                   ? Complete
               </button>
            </div>

            <!-- Dynamic Workout List -->
            <div id="workout-list">
                <!-- Exercises injected here -->
            </div>
            
            <button onclick="switchTrackerView('library')" style="width:100%; padding:15px; border:2px dashed #cbd5e0; color:#64748b; background:transparent; border-radius:12px; font-weight:600; cursor:pointer; margin-top:20px; transition:all 0.2s; touch-action: manipulation; user-select: none; min-height: 50px;" onmouseover="this.style.borderColor='var(--primary)'; this.style.color='var(--primary)'" onmouseout="this.style.borderColor='#cbd5e0'; this.style.color='#64748b'">
                + Add Exercise
            </button>
        </div>

        <!-- VIEW 2: EXERCISE LIBRARY (DB) -->
        <div id="view-library" style="display:none;">
            <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px;">
                <h4 style="margin:0 0 10px 0; color:#334155;">Search Exercise Library</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="db-search-input" placeholder="e.g. Squat, Lunge, Plank..." style="flex:1; padding:12px; border:1px solid #cbd5e0; border-radius:8px; outline:none;" onkeyup="if(event.key === 'Enter') loadExerciseLibrary(this.value)">
                    <button onclick="loadExerciseLibrary(document.getElementById('db-search-input').value)" style="background:var(--primary); color:white; border:none; padding:0 25px; border-radius:8px; cursor:pointer; font-weight:600;">Search</button>
                </div>
                <div style="margin-top:10px; font-size:0.8rem; color:#64748b;">
                    Browse 1700+ exercise videos from our library. All videos hosted on Google Drive.
                </div>
            </div>

            <div id="library-results" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:15px;">
                <!-- Search Results -->
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">
                    Use the search bar above to browse 1300+ exercises.
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div id="exercise-video-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:black; width:90%; max-width:500px; aspect-ratio:16/9; position:relative; border-radius:12px; overflow:hidden;">
             <button onclick="closeExerciseModal()" style="position:absolute; top:10px; right:10px; z-index:10; background:rgba(0,0,0,0.5); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer;">&times;</button>
             <iframe id="modal-video-frame" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>
</div>

<!-- DINING OUT GUIDE -->
<div class="view-section" id="dining">
    <div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
        <div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">The Vegan Socialite</div>
        <h1 style="margin-bottom: 15px;">Restaurant Cheat Sheet</h1>
        <p style="font-size: 1.1rem; color: #555;">Never worry about what to order. Use these cheat codes to stay on track mentre dining out.</p>
    </div>

    <div class="card">
        <div class="card-body" style="opacity: 1; max-height: none; padding: 30px;">
            <h3 style="color:var(--secondary); text-transform:uppercase; letter-spacing:1px; font-size:1rem; margin-top:0;">General Dining Rules</h3>
            <ul style="margin-bottom:30px;">
                <li><strong>Protein First:</strong> Always scan for the protein options (Tofu, Beans, Lentils).</li>
                <li><strong>Sauce on Side:</strong> Most hidden oils and sugars are in the dressing.</li>
                <li><strong>Hydrate:</strong> Order sparkling water with lime immediately to settle in.</li>
            </ul>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:25px;">
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Italian</h4>
                    <p><strong>Order:</strong> Grilled vegetable antipasto, Minestrone soup, or simple Marinara pasta with a side of steamed spinach.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Heavy cream sauces (Alfredo) or excessive bread basket grazing.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Mexican</h4>
                    <p><strong>Order:</strong> The Burrito Bowl. Base of black beans and lettuce. Load up on Guacamole (healthy fats!) and Salsa.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Fried chips and heavy cheese quesadillas.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Thai</h4>
                    <p><strong>Order:</strong> Green or Red Curry with Tofu (coconut milk is great for hormones). Papaya Salad (Som Tum).</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Pad Thai (sugar) and deep-fried spring rolls.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Japanese</h4>
                    <p><strong>Order:</strong> Edamame, Miso Soup, Seaweed Salad, Avocado/Cucumber Rolls, Agedashi Tofu.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Tempura (deep fried) and hidden mayo in "spicy" rolls.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">?? Middle Eastern</h4>
                    <p><strong>Order:</strong> Hummus, Baba Ganoush, Falafel (request baked), Tabbouleh, grilled veggie skewers.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Deep-fried pita chips and heavy oil-based tahini swirls.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">?? Indian</h4>
                    <p><strong>Order:</strong> Dal Tadka, Chana Masala, Baingan Bharta (baked eggplant). High fiber and spices.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Heavy cream curries (Korma) or excessive Naan bread.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Greek</h4>
                    <p><strong>Order:</strong> Giant Beans (Gigantes), Greek Salad (no feta), Stuffed vine leaves (Dolmades).</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Feta-heavy dishes and phyllo pastries (Spanakopita).</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">?? Fast Casual</h4>
                    <p><strong>Order:</strong> Portobello Mushroom Burger (lettuce wrap), Bean-based Veggie Bowl, sweet potato sides.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Processed "fake meat" patties and white flour buns.</p>
                </div>
            </div>

            <!-- Print Button -->
            <div style="margin-top: 50px; text-align: center;">
                 <p style="color:var(--text-muted);">Want a pocket guide?</p>
                 <a href="adrenal_dining_guide.html" target="_blank" style="text-decoration:none;"><button style="background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-size:1rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='var(--primary)'">Download Printable Guide</button></a>
            </div>
        </div>
    </div>
</div>








<div class="view-section" id="bonuses">
     <div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
        <div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Exclusive Extras</div>
        <h1 style="margin-bottom: 15px;">Your Protocol Bonuses</h1>
        <p style="font-size: 1.1rem; color: #555;">Tools to support your adrenal recovery journey.</p>
    </div>

    <!-- The content of the original bonuses section (Smoothie, Dining, Acupressure) has been moved to dedicated sections above. -->
    <!-- This section can now be used for other bonuses or removed if no other bonuses are planned. -->
</div>

<div class="view-section" id="week1">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week1', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week1', 'Monday')">Day 1</button><button class="sub-btn" onclick="switchDay('week1', 'Tuesday')">Day 2</button><button class="sub-btn" onclick="switchDay('week1', 'Wednesday')">Day 3</button><button class="sub-btn" onclick="switchDay('week1', 'Thursday')">Day 4</button><button class="sub-btn" onclick="switchDay('week1', 'Friday')">Day 5</button><button class="sub-btn" onclick="switchDay('week1', 'Saturday')">Day 6</button><button class="sub-btn" onclick="switchDay('week1', 'Sunday')">Day 7</button>
</div>
<div class="day-view active" id="week1-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(to right, #eef2f3, #ffffff);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 1</div>
<h1 style="margin-bottom: 15px;">Reset and Debloat</h1>
<p style="font-size: 1.1rem; color: #555;">Flush inflammation with mineral-rich hydration.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>This week reduces the inflammatory load on your adrenal glands. By removing common stressors and flooding your system with minerals (potassium/magnesium), we signal safety to your nervous system, allowing baseline cortisol levels to drop so true restoration can begin.</p>
</div></div>
</div>
<div class="day-view" id="week1-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Stuffed Sweet Potato</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Stuffed Sweet Potato" src="/assets/stuffed_sweet_potato.jpg" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sweet potato 200g</li><li>Quinoa 150g</li><li>Black beans 150g</li><li>Kale 50g</li><li>Tahini 15g</li><li>Lemon juice</li><li>Pumpkin seeds 10g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast:</strong> Bake sweet potato (whole or cubed) until tender (approx 25-30 mins).<br/>
<strong>2. Stuff/Assemble:</strong> Mix cooked quinoa, rinsed black beans, and massaged kale. Stuff into the split potato or arrange in a bowl.<br/>
<strong>3. Serve:</strong> Drizzle with a dressing made of tahini and lemon juice. Top with pumpkin seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Miso Glazed Tempeh</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Miso Glazed Tempeh" src="/assets/miso_glazed_tempeh.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Miso 15g</li><li>Tamari 10ml</li><li>Maple 10ml</li><li>Bok choy 150g</li><li>Cauliflower rice 150g</li><li>Sesame oil</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Whisk miso, tamari, maple syrup, and sesame oil. Cube tempeh and toss in marinade. Let sit for 15-30 mins.<br/>
<strong>2. Cook Tempeh:</strong> Pan-fry tempeh over medium-high heat until golden and caramelized (approx 5-8 mins).<br/>
<strong>3. Sides:</strong> Steam bok choy (3-4 mins). Saut cauliflower rice with a splash of water or oil until tender.<br/>
<strong>4. Serve:</strong> Assemble in a bowl and drizzle with any remaining fresh tahini.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Chamomile Maca Moon Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Chamomile Maca Moon Milk" src="/assets/chamomile_maca_moon_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca 5g</li><li>Cinnamon</li><li>Magnesium</li><li>Chamomile tea</li></ul>
<h4>Preparation</h4>
<p>Steep tea in hot milk. Whisk powders.</p>
</div>
</div>
</div><div class="day-view" id="week1-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Cucumber Mint Green Juice + Tofu Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cucumber Mint Green Juice + Tofu Scramble" src="/assets/cucumber_mint_juice_tofu_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cucumber 200g</li><li>Fresh mint 10g</li><li>Firm tofu 200g</li><li>Asparagus 100g</li><li>Dill 5g</li><li>Olive oil 10ml</li><li>Turmeric 2g</li><li>Black salt 1g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Juice:</strong> Juice cucumber and mint (or blend and strain).<br/>
<strong>2. Scramble:</strong> Crumble firm tofu. Saut in olive oil with turmeric and black salt for 5 mins.<br/>
<strong>3. Veggies:</strong> Steam asparagus until tender-crisp. Chop and mix with tofu and fresh dill.<br/>
<strong>4. Serve:</strong> Plate the scramble with the green juice on the side.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Rainbow Collard Wraps</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Collard Wraps" src="/assets/rainbow_collard_wraps.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Collard greens 6 leaves</li><li>Carrot 100g</li><li>Red lentils 250g</li><li>Avocado 100g</li><li>Bean sprouts 50g</li><li>Tahini 20g</li><li>Garlic 2g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prepare Leaves:</strong> Blanch collard leaves in boiling water for 30 seconds, then plunge into ice water. Pat dry and trim the thick stem spine carefully.<br/>
<strong>2. Make Paste:</strong> Mash red lentils (cooked) with tahini, minced garlic, and a squeeze of lemon until spreadable.<br/>
<strong>3. Assemble:</strong> Spread lentil paste on each leaf. Top with shredded carrot, avocado slices, and bean sprouts.<br/>
<strong>4. Roll:</strong> Fold sides in and roll tightly like a burrito.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Coconut Curry Red Lentil Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Coconut Curry Red Lentil Soup" src="/assets/coconut_curry_red_lentil_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Red lentils 250g</li><li>Light coconut milk 200ml</li><li>Curry paste 20g</li><li>Delicata squash 150g</li><li>Onion/Garlic/Ginger</li><li>Stock 300ml</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Squash:</strong> Toss delicata squash cubes with oil and roast at 200C for 20-25 mins until tender.<br/>
<strong>2. Base:</strong> Saut diced onion, garlic, and ginger until fragrant. Stir in curry paste for 1 minute.<br/>
<strong>3. Simmer:</strong> Add red lentils, coconut milk, and stock. Simmer for 15-20 mins until lentils are soft.<br/>
<strong>4. Serve:</strong> Ladle soup into bowls and top with roasted squash.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Tea" src="/assets/lemon_balm_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lemon balm tea</li><li>Ground flax 5g</li></ul>
<h4>Preparation</h4>
<p>Steep tea. Stir in flax.</p>
</div>
</div>
</div><div class="day-view" id="week1-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Glow Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Glow Bowl" src="/assets/glow_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Baby greens 100g</li><li>Fennel bulb 150g</li><li>White beans 200g</li><li>Artichoke hearts 100g</li><li>Pesto 25g</li><li>Lemon/Oil</li></ul>
<h4>Preparation</h4>
<p>Roast fennel. Arrange greens. Top with beans/artichokes/fennel. Drizzle with pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Zucchini Noodle Pho</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Zucchini Noodle Pho" src="/assets/zucchini_noodle_pho.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 250g</li><li>Veg broth 300ml</li><li>Star anise/Cinnamon</li><li>Tofu 200g</li><li>Edamame 50g</li><li>Shiitake 100g</li><li>Mung sprouts</li><li>Basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Infuse Broth:</strong> Simmer vegetable broth with star anise, cinnamon stick, ginger slices, and onion for 15 mins. Strain if desired.<br/>
<strong>2. Add Veggies:</strong> Add sliced shiitake mushrooms and simmer for 5 mins.<br/>
<strong>3. Finish:</strong> Add tofu cubes and zucchini noodles (zoodles) for just the last 1-2 minutes to warm through without overcooking.<br/>
<strong>4. Serve:</strong> Top with fresh basil, sprouts, and lime.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Golden Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Golden Milk" src="/assets/golden_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Turmeric</li><li>Ginger</li><li>Coconut oil 3g</li><li>Triphala</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Whisk all ingredients in hot milk.</p>
</div>
</div>
</div><div class="day-view" id="week1-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Cucumber Mint Green Juice + Tofu Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cucumber Mint Green Juice + Tofu Scramble" src="/assets/cucumber_mint_juice_tofu_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cucumber 200g</li><li>Fresh mint 10g</li><li>Firm tofu 200g</li><li>Asparagus 100g</li><li>Dill 5g</li><li>Olive oil 10ml</li><li>Turmeric 2g</li><li>Black salt 1g</li></ul>
<h4>Preparation</h4>
<p>Juice cucumber/mint. Saut crumbled tofu with spices. Steam asparagus. Mix tofu with dill/asparagus. Serve with juice.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lemony Quinoa &amp; Chickpea Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemony Quinoa &amp; Chickpea Bowl" src="/assets/lemony_quinoa_chickpea_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Quinoa 150g</li><li>Pumpkin seeds 20g</li><li>Mint &amp; Parsley 10g</li><li>Lemon juice 15ml</li><li>Plant protein 20g</li></ul>
<h4>Preparation</h4>
<p>Assemble bowl. Whisk lemon juice/oil dressing. Drizzle over.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Miso Glazed Tempeh</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Miso Glazed Tempeh" src="/assets/miso_glazed_tempeh.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Miso 15g</li><li>Tamari 10ml</li><li>Maple 10ml</li><li>Bok choy 150g</li><li>Cauliflower rice 150g</li><li>Sesame oil</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p>Marinate/fry tempeh. Steam bok choy. Saut rice. Serve bowl style.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Chamomile Maca Moon Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Chamomile Maca Moon Milk" src="/assets/chamomile_maca_moon_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca 5g</li><li>Cinnamon</li><li>Magnesium</li><li>Chamomile tea</li></ul>
<h4>Preparation</h4>
<p>Steep tea in hot milk. Whisk powders.</p>
</div>
</div>
</div><div class="day-view" id="week1-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Rainbow Collard Wraps</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Collard Wraps" src="/assets/rainbow_collard_wraps.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Collard greens 6 leaves</li><li>Carrot 100g</li><li>Red lentils 250g</li><li>Avocado 100g</li><li>Bean sprouts 50g</li><li>Tahini 20g</li><li>Garlic 2g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prepare Leaves:</strong> Blanch collard leaves in boiling water for 30 seconds, then plunge into ice water. Pat dry and trim the thick stem spine carefully.<br/>
<strong>2. Make Paste:</strong> Mash red lentils (cooked) with tahini, minced garlic, and a squeeze of lemon until spreadable.<br/>
<strong>3. Assemble:</strong> Spread lentil paste on each leaf. Top with shredded carrot, avocado slices, and bean sprouts.<br/>
<strong>4. Roll:</strong> Fold sides in and roll tightly like a burrito.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Coconut Curry Red Lentil Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Coconut Curry Red Lentil Soup" src="/assets/coconut_curry_red_lentil_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Red lentils 250g</li><li>Light coconut milk 200ml</li><li>Curry paste 20g</li><li>Delicata squash 150g</li><li>Onion/Garlic/Ginger</li><li>Stock 300ml</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Squash:</strong> Toss delicata squash cubes with oil and roast at 200C for 20-25 mins until tender.<br/>
<strong>2. Base:</strong> Saut diced onion, garlic, and ginger until fragrant. Stir in curry paste for 1 minute.<br/>
<strong>3. Simmer:</strong> Add red lentils, coconut milk, and stock. Simmer for 15-20 mins until lentils are soft.<br/>
<strong>4. Serve:</strong> Ladle soup into bowls and top with roasted squash.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Tea" src="/assets/lemon_balm_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lemon balm tea</li><li>Ground flax 5g</li></ul>
<h4>Preparation</h4>
<p>Steep tea. Stir in flax.</p>
</div>
</div>
</div><div class="day-view" id="week1-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Cucumber Mint Green Juice + Tofu Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cucumber Mint Green Juice + Tofu Scramble" src="/assets/cucumber_mint_juice_tofu_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cucumber 200g</li><li>Fresh mint 10g</li><li>Firm tofu 200g</li><li>Asparagus 100g</li><li>Dill 5g</li><li>Olive oil 10ml</li><li>Turmeric 2g</li><li>Black salt 1g</li></ul>
<h4>Preparation</h4>
<p>Juice cucumber/mint. Saut crumbled tofu with spices. Steam asparagus. Mix tofu with dill/asparagus. Serve with juice.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Glow Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Glow Bowl" src="/assets/glow_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Baby greens 100g</li><li>Fennel bulb 150g</li><li>White beans 200g</li><li>Artichoke hearts 100g</li><li>Pesto 25g</li><li>Lemon/Oil</li></ul>
<h4>Preparation</h4>
<p>Roast fennel. Arrange greens. Top with beans/artichokes/fennel. Drizzle with pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Zucchini Noodle Pho</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Zucchini Noodle Pho" src="/assets/zucchini_noodle_pho.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 250g</li><li>Veg broth 300ml</li><li>Star anise/Cinnamon</li><li>Tofu 200g</li><li>Shiitake 100g</li><li>Mung sprouts</li><li>Basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Infuse Broth:</strong> Simmer vegetable broth with star anise, cinnamon stick, ginger slices, and onion for 15 mins. Strain if desired.<br/>
<strong>2. Add Veggies:</strong> Add sliced shiitake mushrooms and simmer for 5 mins.<br/>
<strong>3. Finish:</strong> Add tofu cubes and zucchini noodles (zoodles) for just the last 1-2 minutes to warm through without overcooking.<br/>
<strong>4. Serve:</strong> Top with fresh basil, sprouts, and lime.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Golden Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Golden Milk" src="/assets/golden_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Turmeric</li><li>Ginger</li><li>Coconut oil 3g</li><li>Triphala</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Whisk all ingredients in hot milk.</p>
</div>
</div>
</div><div class="day-view" id="week1-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lemony Quinoa &amp; Chickpea Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemony Quinoa &amp; Chickpea Bowl" src="/assets/lemony_quinoa_chickpea_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Quinoa 150g</li><li>Pumpkin seeds 20g</li><li>Mint &amp; Parsley 10g</li><li>Lemon juice 15ml</li><li>Plant protein 20g</li></ul>
<h4>Preparation</h4>
<p>Assemble bowl. Whisk lemon juice/oil dressing. Drizzle over.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Miso Glazed Tempeh</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Miso Glazed Tempeh" src="/assets/miso_glazed_tempeh.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Miso 15g</li><li>Tamari 10ml</li><li>Maple 10ml</li><li>Bok choy 150g</li><li>Cauliflower rice 150g</li><li>Sesame oil</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Whisk miso, tamari, maple syrup, and sesame oil. Cube tempeh and toss in marinade. Let sit for 15-30 mins.<br/>
<strong>2. Cook Tempeh:</strong> Pan-fry tempeh over medium-high heat until golden and caramelized (approx 5-8 mins).<br/>
<strong>3. Sides:</strong> Steam bok choy (3-4 mins). Saut cauliflower rice with a splash of water or oil until tender.<br/>
<strong>4. Serve:</strong> Assemble in a bowl and drizzle with any remaining fresh tahini.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Chamomile Maca Moon Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Chamomile Maca Moon Milk" src="/assets/chamomile_maca_moon_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca 5g</li><li>Cinnamon</li><li>Magnesium</li><li>Chamomile tea</li></ul>
<h4>Preparation</h4>
<p>Steep tea in hot milk. Whisk powders.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="week2">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week2', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week2', 'Monday')">Day 8</button><button class="sub-btn" onclick="switchDay('week2', 'Tuesday')">Day 9</button><button class="sub-btn" onclick="switchDay('week2', 'Wednesday')">Day 10</button><button class="sub-btn" onclick="switchDay('week2', 'Thursday')">Day 11</button><button class="sub-btn" onclick="switchDay('week2', 'Friday')">Day 12</button><button class="sub-btn" onclick="switchDay('week2', 'Saturday')">Day 13</button><button class="sub-btn" onclick="switchDay('week2', 'Sunday')">Day 14</button>
</div>
<div class="day-view active" id="week2-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 2</div>
<h1 style="margin-bottom: 15px;">Strength &amp; Blood Sugar</h1>
<p style="font-size: 1.1rem; color: #555;">Higher protein and fiber dense carbs.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>Bio-availability is key. We pair protein with slow-burning complex carbs to prevent the blood sugar dips that trigger "panic" cortisol spikes. This steady energy supply keeps your mood stable and your adrenal output calm throughout the day.</p>
</div></div>
</div>
<div class="day-view" id="week2-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Warm Apple Pie Oat Bake</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Warm Apple Pie Oat Bake" src="/assets/warm_apple_pie_oat_bake.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 50g</li><li>Apple 120g</li><li>Cardamom</li><li>Hemp yogurt 80g</li><li>Pear 80g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine rolled oats, chopped apple, cardamom, and a splash of almond milk/water in a baking dish.<br/>
<strong>2. Bake:</strong> Bake at 180C for 20-25 minutes until oats are set and apples are soft.<br/>
<strong>3. Serve:</strong> Top with a dollop of hemp yogurt and fresh pear slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Farro Power Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Farro Power Bowl" src="/assets/farro_power_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Farro 80g</li><li>Tempeh 150g</li><li>Brussels sprouts 100g</li><li>Pomegranate</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prep Components:</strong> Cook farro according to package instructions. Roast halved Brussels sprouts at 200C for 20 mins.<br/>
<strong>2. Tempeh:</strong> Pan-fry tempeh cubes with a splash of tamari until crispy.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, 1 tbsp water, and a drop of maple syrup until smooth.<br/>
<strong>4. Assemble:</strong> Combine farro, sprouts, and tempeh. Top with pomegranate seeds and dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Walnut Crusted Tofu</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Walnut Crusted Tofu" src="/assets/walnut_crusted_tofu.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Walnuts 20g</li><li>Sweet potato 200g</li><li>Green beans</li></ul>
<h4>Preparation</h4>
<p><strong>1. Crust Tofu:</strong> Mix crushed walnuts with spices. Dip pressed tofu slabs in almond milk, then press into walnut mix.<br/>
<strong>2. Bake:</strong> Place tofu and sweet potato wedges on a baking sheet. Bake at 200C for 25-30 minutes until crispy.<br/>
<strong>3. Veggies:</strong> Briefly steam or saut green beans with garlic.<br/>
<strong>4. Serve:</strong> Plate tofu with fries and beans.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Reishi Hot Chocolate</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Reishi Hot Chocolate" src="/assets/reishi_hot_chocolate.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk</li><li>Cacao</li><li>Reishi</li><li>Monk fruit</li></ul>
<h4>Preparation</h4>
<p>Whisk heated ingredients.</p>
</div>
</div>
</div><div class="day-view" id="week2-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Savory Chickpea Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Savory Chickpea Scramble" src="/assets/savory_chickpea_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Tofu 200g</li><li>Spinach 100g</li><li>Pesto 10g</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Scramble Base:</strong> Roughly mash chickpeas and tofu with a fork.<br/>
<strong>2. Saut:</strong> Saut chopped onion and tomatoes in a pan until soft. Add chickpea/tofu mix.<br/>
<strong>3. Season:</strong> Add turmeric, black salt (kala namak), and pepper. Cook 5-7 mins.<br/>
<strong>4. Finish:</strong> Stir in fresh spinach until wilted. Remove from heat and fold in pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Hearty Tempeh Chili</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Hearty Tempeh Chili" src="/assets/hearty_tempeh_chili.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Kidney beans 100g</li><li>Cacao</li><li>Tomatoes 200g</li><li>Chili spices</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Cook onions, garlic, and peppers until soft. Add crumbled tempeh and brown lightly.<br/>
<strong>2. Simmer:</strong> Add kidney beans, crushed tomatoes, chili powder, cumin, and vegetable broth. Simmer for 20-30 mins to thicken.<br/>
<strong>3. Finish:</strong> Stir in raw cacao powder right before serving for depth.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Sheet Pan Lemon Seitan</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sheet Pan Lemon Seitan" src="/assets/sheet_pan_lemon_seitan.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seitan 150g</li><li>Asparagus 150g</li><li>Fennel 100g</li><li>Orange</li></ul>
<h4>Preparation</h4>
<p><strong>1. Toss:</strong> Combine seitan chunks, asparagus spears, and fennel wedges on a sheet pan. Toss with olive oil, lemon juice, dried oregano, and garlic powder.<br/>
<strong>2. Bake:</strong> Roast at 200C for 20 minutes until golden and veggies are tender.<br/>
<strong>3. Serve:</strong> Garnish with fresh orange zest or slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tulsi Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tulsi Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tulsi tea</li><li>Lemon</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Blue Spirulina Smoothie Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Blue Spirulina Smoothie Bowl" src="/assets/blue_spirulina_smoothie_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cauli rice 100g</li><li>Blueberries 150g</li><li>Pea protein</li><li>Spirulina</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p>Blend all. Decoration optional.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Mediterranean Lentil Salad</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mediterranean Lentil Salad" src="/assets/mediterranean_lentil_salad.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 100g</li><li>Eggplant 200g</li><li>Tahini 15g</li><li>Parsley</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Eggplant:</strong> Cube eggplant, toss with oil and salt. Roast at 200C for 25 mins.<br/>
<strong>2. Salad Base:</strong> Combine cooked lentils, roasted eggplant, diced tomatoes, chopped parsley, and cucumber.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, garlic, and a splash of water.<br/>
<strong>4. Serve:</strong> Toss salad with dressing while warm or cold.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Rainbow Sushi Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Sushi Bowl" src="/assets/rainbow_sushi_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Black rice 150g</li><li>Smoked tofu 150g</li><li>Avocado</li><li>Cucumber</li><li>Nori</li></ul>
<h4>Preparation</h4>
<p><strong>1. Rice:</strong> Cook black rice according to package. Stir in a little rice vinegar when done.<br/>
<strong>2. Prep:</strong> Cube smoked tofu. Slice avocado and cucumber. Cut nori into small strips.<br/>
<strong>3. Assemble:</strong> Arrange everything in a bowl.<br/>
<strong>4. Dress:</strong> Drizzle with tamari and sesame oil.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Sage &amp; Lavender Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sage &amp; Lavender Tea" src="/assets/sage_lavender_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sage</li><li>Lavender</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Overnight Buckwheat Groats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Overnight Buckwheat Groats" src="/assets/overnight_buckwheat_groats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Buckwheat 60g</li><li>Almond milk 150ml</li><li>Cacao nibs</li><li>Cherries</li><li>Alhond yogurt</li></ul>
<h4>Preparation</h4>
<p>Soak overnight. Top with cherries/yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Farro Power Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Farro Power Bowl" src="/assets/farro_power_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Farro 80g</li><li>Tempeh 150g</li><li>Brussels sprouts 100g</li><li>Pomegranate</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prep Components:</strong> Cook farro according to package instructions. Roast halved Brussels sprouts at 200C for 20 mins.<br/>
<strong>2. Tempeh:</strong> Pan-fry tempeh cubes with a splash of tamari until crispy.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, 1 tbsp water, and a drop of maple syrup until smooth.<br/>
<strong>4. Assemble:</strong> Combine farro, sprouts, and tempeh. Top with pomegranate seeds and dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Walnut Crusted Tofu</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Walnut Crusted Tofu" src="/assets/walnut_crusted_tofu.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Walnuts 20g</li><li>Sweet potato 200g</li><li>Green beans</li></ul>
<h4>Preparation</h4>
<p><strong>1. Crust Tofu:</strong> Mix crushed walnuts with spices. Dip pressed tofu slabs in almond milk, then press into walnut mix.<br/>
<strong>2. Bake:</strong> Place tofu and sweet potato wedges on a baking sheet. Bake at 200C for 25-30 minutes until crispy.<br/>
<strong>3. Veggies:</strong> Briefly steam or saut green beans with garlic.<br/>
<strong>4. Serve:</strong> Plate tofu with fries and beans.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Reishi Hot Chocolate</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Reishi Hot Chocolate" src="/assets/reishi_hot_chocolate.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk</li><li>Cacao</li><li>Reishi</li><li>Monk fruit</li></ul>
<h4>Preparation</h4>
<p>Whisk heated ingredients.</p>
</div>
</div>
</div><div class="day-view" id="week2-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Warm Apple Pie Oat Bake</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Warm Apple Pie Oat Bake" src="/assets/warm_apple_pie_oat_bake.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 50g</li><li>Apple 120g</li><li>Cardamom</li><li>Hemp yogurt 80g</li><li>Pear 80g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine rolled oats, chopped apple, cardamom, and a splash of almond milk/water in a baking dish.<br/>
<strong>2. Bake:</strong> Bake at 180C for 20-25 minutes until oats are set and apples are soft.<br/>
<strong>3. Serve:</strong> Top with a dollop of hemp yogurt and fresh pear slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Hearty Tempeh Chili</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Hearty Tempeh Chili" src="/assets/hearty_tempeh_chili.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Kidney beans 100g</li><li>Cacao</li><li>Tomatoes 200g</li><li>Chili spices</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Cook onions, garlic, and peppers until soft. Add crumbled tempeh and brown lightly.<br/>
<strong>2. Simmer:</strong> Add kidney beans, crushed tomatoes, chili powder, cumin, and vegetable broth. Simmer for 20-30 mins to thicken.<br/>
<strong>3. Finish:</strong> Stir in raw cacao powder right before serving for depth.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Sheet Pan Lemon Seitan</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sheet Pan Lemon Seitan" src="/assets/sheet_pan_lemon_seitan.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seitan 150g</li><li>Asparagus 150g</li><li>Fennel 100g</li><li>Orange</li></ul>
<h4>Preparation</h4>
<p><strong>1. Toss:</strong> Combine seitan chunks, asparagus spears, and fennel wedges on a sheet pan. Toss with olive oil, lemon juice, dried oregano, and garlic powder.<br/>
<strong>2. Bake:</strong> Roast at 200C for 20 minutes until golden and veggies are tender.<br/>
<strong>3. Serve:</strong> Garnish with fresh orange zest or slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tulsi Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tulsi Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tulsi tea</li><li>Lemon</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Savory Chickpea Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Savory Chickpea Scramble" src="/assets/savory_chickpea_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Tofu 200g</li><li>Spinach 100g</li><li>Pesto 10g</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Scramble Base:</strong> Roughly mash chickpeas and tofu with a fork.<br/>
<strong>2. Saut:</strong> Saut chopped onion and tomatoes in a pan until soft. Add chickpea/tofu mix.<br/>
<strong>3. Season:</strong> Add turmeric, black salt (kala namak), and pepper. Cook 5-7 mins.<br/>
<strong>4. Finish:</strong> Stir in fresh spinach until wilted. Remove from heat and fold in pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Mediterranean Lentil Salad</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mediterranean Lentil Salad" src="/assets/mediterranean_lentil_salad.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 100g</li><li>Eggplant 200g</li><li>Tahini 15g</li><li>Parsley</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Eggplant:</strong> Cube eggplant, toss with oil and salt. Roast at 200C for 25 mins.<br/>
<strong>2. Salad Base:</strong> Combine cooked lentils, roasted eggplant, diced tomatoes, chopped parsley, and cucumber.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, garlic, and a splash of water.<br/>
<strong>4. Serve:</strong> Toss salad with dressing while warm or cold.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Rainbow Sushi Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Sushi Bowl" src="/assets/rainbow_sushi_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Black rice 150g</li><li>Smoked tofu 150g</li><li>Avocado</li><li>Cucumber</li><li>Nori</li></ul>
<h4>Preparation</h4>
<p><strong>1. Rice:</strong> Cook black rice according to package. Stir in a little rice vinegar when done.<br/>
<strong>2. Prep:</strong> Cube smoked tofu. Slice avocado and cucumber. Cut nori into small strips.<br/>
<strong>3. Assemble:</strong> Arrange everything in a bowl.<br/>
<strong>4. Dress:</strong> Drizzle with tamari and sesame oil.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Sage &amp; Lavender Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sage &amp; Lavender Tea" src="/assets/sage_lavender_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sage</li><li>Lavender</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Blue Spirulina Smoothie Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Blue Spirulina Smoothie Bowl" src="/assets/blue_spirulina_smoothie_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cauli rice 100g</li><li>Blueberries 150g</li><li>Pea protein</li><li>Spirulina</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p>Blend all. Decoration optional.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Farro Power Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Farro Power Bowl" src="/assets/farro_power_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Farro 80g</li><li>Tempeh 150g</li><li>Brussels sprouts 100g</li><li>Pomegranate</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast sprouts. Fry tempeh. Assemble bowl with tahini dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Walnut Crusted Tofu</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Walnut Crusted Tofu" src="/assets/walnut_crusted_tofu.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Walnuts 20g</li><li>Sweet potato 200g</li><li>Green beans</li></ul>
<h4>Preparation</h4>
<p>Crust tofu/fry. Roast potato. Saut beans.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Reishi Hot Chocolate</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Reishi Hot Chocolate" src="/assets/reishi_hot_chocolate.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk</li><li>Cacao</li><li>Reishi</li><li>Monk fruit</li></ul>
<h4>Preparation</h4>
<p>Whisk heated ingredients.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="week3">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week3', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week3', 'Monday')">Day 15</button><button class="sub-btn" onclick="switchDay('week3', 'Tuesday')">Day 16</button><button class="sub-btn" onclick="switchDay('week3', 'Wednesday')">Day 17</button><button class="sub-btn" onclick="switchDay('week3', 'Thursday')">Day 18</button><button class="sub-btn" onclick="switchDay('week3', 'Friday')">Day 19</button><button class="sub-btn" onclick="switchDay('week3', 'Saturday')">Day 20</button><button class="sub-btn" onclick="switchDay('week3', 'Sunday')">Day 21</button>
</div>
<div class="day-view active" id="week3-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(to right, #fbfdef, #ffffff);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 3</div>
<h1 style="margin-bottom: 15px;">Metabolism Boost</h1>
<p style="font-size: 1.1rem; color: #555;">Thermogenic foods and spices.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>We gently support your metabolic rate with warming, nutrient-dense foods rather than stimulants. Selenium and Zinc nourish the thyroidyour adrenals' partner in energy productionensuring you feel energized without the "tired-wired" crash.</p>
</div></div>
</div>
<div class="day-view" id="week3-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Fire Tonic &amp; Lentil Waffles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fire Tonic &amp; Lentil Waffles" src="/assets/fire_tonic_lentil_waffles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tonic: ACV, Ginger, Cayenne</li><li>Lentils 150g</li><li>Chickpea flour 50g</li><li>Kimchi</li><li>Avocado</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tonic:</strong> Mix warm water, apple cider vinegar, grated ginger, and a pinch of cayenne.<br/>
<strong>2. Waffles:</strong> Blend soaked red lentils (or use flour), chickpea flour, water, baking powder, and salt. Cook in a greased waffle iron until crisp.<br/>
<strong>3. Serve:</strong> Drink tonic first. Top waffles with kimchi and sliced avocado.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Thai Basil Zucchini Noodles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Thai Basil Zucchini Noodles" src="/assets/thai_basil_zucchini_noodles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 300g</li><li>Tofu 200g</li><li>Almond butter</li><li>Coconut milk</li><li>Thai basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tofu:</strong> Pan-fry tofu cubes with soy sauce until golden.<br/>
<strong>2. Sauce:</strong> Whisk almond butter, coconut milk, lime juice, ginger, and garlic until creamy.<br/>
<strong>3. Noodles:</strong> Spiralize zucchini. Toss zoodles in the sauce briefly to warm (don't cook too long).<br/>
<strong>4. Serve:</strong> Top with tofu and fresh Thai basil leaves.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p><strong>1. Steaks:</strong> Slice cauliflower into thick "steaks". Brush with oil, turmeric, cumin, and paprika.<br/>
<strong>2. Roast:</strong> Bake at 200C for 25-30 minutes, flipping halfway, until tender and charred.<br/>
<strong>3. Base:</strong> Warm the cooked beluga lentils and massage the kale with lemon.<br/>
<strong>4. Serve:</strong> Place steaks over lentils/kale and drizzle with tahini.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Dandelion Root Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Dandelion Root Latte" src="/assets/dandelion_root_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dandelion root</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p>Heat and whisk.</p>
</div>
</div>
</div><div class="day-view" id="week3-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Carrot Cake Chia Parfait</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Chia Parfait" src="/assets/carrot_cake_chia_parfait.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 30g</li><li>Carrot 100g</li><li>Cashew butter</li><li>Coconut cream</li><li>Walnuts</li></ul>
<h4>Preparation</h4>
<p>Layer chia pudding with grated carrot/cream.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Moroccan Chickpea Stew</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Moroccan Chickpea Stew" src="/assets/moroccan_chickpea_stew.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 200g</li><li>Millet 150g</li><li>Apricots</li><li>Tomatoes</li><li>Spinach</li></ul>
<h4>Preparation</h4>
<p><strong>1. Base:</strong> Saut onion, garlic, and ginger with cumin, cinnamon, and turmeric.<br/>
<strong>2. Simmer:</strong> Add chickpeas, chopped tomatoes, dried apricots, and broth. Simmer for 20 mins.<br/>
<strong>3. Greens:</strong> Stir in spinach at the end to wilt.<br/>
<strong>4. Serve:</strong> Spoon stew over fluffy cooked millet.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Grilled Tofu Tikka</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grilled Tofu Tikka" src="/assets/grilled_tofu_tikka.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Cauli rice 150g</li><li>Cucumber/Mint salad</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Coat tofu in coconut yogurt mixed with tikka spices, lime, and ginger. Let sit for 20+ mins.<br/>
<strong>2. Grill/Bake:</strong> Grill skewers or bake tofu at 220C until edges are charred (approx 20 mins).<br/>
<strong>3. Sides:</strong> Serve with heated cauliflower rice and a cooling cucumber/mint salad.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Holy Basil Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Holy Basil Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fresh basil</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Metabolic Mocha Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Metabolic Mocha Smoothie" src="/assets/metabolic_mocha_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cold brew</li><li>Cacao</li><li>Chili</li><li>Pea protein</li><li>Banana</li></ul>
<h4>Preparation</h4>
<p>Blend.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Charred Broccoli &amp; Bean Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Charred Broccoli &amp; Bean Bowl" src="/assets/charred_broccoli_bean_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Broccoli 200g</li><li>Cannellini beans 150g</li><li>Romesco sauce</li></ul>
<h4>Preparation</h4>
<p><strong>1. Char:</strong> Toss broccoli florets with oil and roast at high heat (220C) or pan-sear until charred/browned.<br/>
<strong>2. Combine:</strong> Mix warm broccoli with cannellini beans.<br/>
<strong>3. Serve:</strong> Toss generously with Romesco sauce (roasted red pepper &amp; almond sauce).</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast cauliflower. Serve over lentils/kale.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Fennel Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Tea" src="/assets/fennel_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel seeds</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Fire Tonic &amp; Lentil Waffles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fire Tonic &amp; Lentil Waffles" src="/assets/fire_tonic_lentil_waffles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tonic: ACV, Ginger, Cayenne</li><li>Lentils 150g</li><li>Chickpea flour 50g</li><li>Kimchi</li><li>Avocado</li></ul>
<h4>Preparation</h4>
<p>Drink tonic. Blend/cook waffles. Top with kimchi/avo.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Sweet Potato Nourish Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sweet Potato Nourish Bowl" src="/assets/sweet_potato_nourish_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sweet potato 200g</li><li>Kale</li><li>Quinoa</li><li>Maple Miso dressing</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast:</strong> Roast sweet potato wedges at 200C until tender.<br/>
<strong>2. Kale:</strong> Remove kale stems and massage leaves with a little olive oil and salt to soften.<br/>
<strong>3. Dressing:</strong> Whisk maple, miso, and apple cider vinegar.<br/>
<strong>4. Serve:</strong> Assemble bowl with quinoa, potato, kale, and drizzle with dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Grilled Tofu Tikka</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grilled Tofu Tikka" src="/assets/grilled_tofu_tikka.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Cauli rice 150g</li><li>Cucumber/Mint salad</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p>Grill marinated tofu. Serve with rice/salad.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Dandelion Root Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Dandelion Root Latte" src="/assets/dandelion_root_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dandelion root</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p>Heat and whisk.</p>
</div>
</div>
</div><div class="day-view" id="week3-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Carrot Cake Chia Parfait</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Chia Parfait" src="/assets/carrot_cake_chia_parfait.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 30g</li><li>Carrot 100g</li><li>Cashew butter</li><li>Coconut cream</li><li>Walnuts</li></ul>
<h4>Preparation</h4>
<p>Layer chia pudding with grated carrot/cream.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Thai Basil Zucchini Noodles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Thai Basil Zucchini Noodles" src="/assets/thai_basil_zucchini_noodles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 300g</li><li>Tofu 200g</li><li>Almond butter</li><li>Coconut milk</li><li>Thai basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tofu:</strong> Pan-fry tofu cubes with soy sauce until golden.<br/>
<strong>2. Sauce:</strong> Whisk almond butter, coconut milk, lime juice, ginger, and garlic until creamy.<br/>
<strong>3. Noodles:</strong> Spiralize zucchini. Toss zoodles in the sauce briefly to warm (don't cook too long).<br/>
<strong>4. Serve:</strong> Top with tofu and fresh Thai basil leaves.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast cauliflower. Serve over lentils/kale.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Holy Basil Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Holy Basil Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fresh basil</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Metabolic Mocha Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Metabolic Mocha Smoothie" src="/assets/metabolic_mocha_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cold brew</li><li>Cacao</li><li>Chili</li><li>Pea protein</li><li>Banana</li></ul>
<h4>Preparation</h4>
<p>Blend.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Moroccan Chickpea Stew</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Moroccan Chickpea Stew" src="/assets/moroccan_chickpea_stew.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 200g</li><li>Millet 150g</li><li>Apricots</li><li>Tomatoes</li><li>Spinach</li></ul>
<h4>Preparation</h4>
<p><strong>1. Base:</strong> Saut onion, garlic, and ginger with cumin, cinnamon, and turmeric.<br/>
<strong>2. Simmer:</strong> Add chickpeas, chopped tomatoes, dried apricots, and broth. Simmer for 20 mins.<br/>
<strong>3. Greens:</strong> Stir in spinach at the end to wilt.<br/>
<strong>4. Serve:</strong> Spoon stew over fluffy cooked millet.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Grilled Tofu Tikka</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grilled Tofu Tikka" src="/assets/grilled_tofu_tikka.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Cauli rice 150g</li><li>Cucumber/Mint salad</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Coat tofu in coconut yogurt mixed with tikka spices, lime, and ginger. Let sit for 20+ mins.<br/>
<strong>2. Grill/Bake:</strong> Grill skewers or bake tofu at 220C until edges are charred (approx 20 mins).<br/>
<strong>3. Sides:</strong> Serve with heated cauliflower rice and a cooling cucumber/mint salad.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Fennel Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Tea" src="/assets/fennel_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel seeds</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Fire Tonic &amp; Lentil Waffles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fire Tonic &amp; Lentil Waffles" src="/assets/fire_tonic_lentil_waffles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tonic: ACV, Ginger, Cayenne</li><li>Lentils 150g</li><li>Chickpea flour 50g</li><li>Kimchi</li><li>Avocado</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tonic:</strong> Mix warm water, apple cider vinegar, grated ginger, and a pinch of cayenne.<br/>
<strong>2. Waffles:</strong> Blend soaked red lentils (or use flour), chickpea flour, water, baking powder, and salt. Cook in a greased waffle iron until crisp.<br/>
<strong>3. Serve:</strong> Drink tonic first. Top waffles with kimchi and sliced avocado.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Charred Broccoli &amp; Bean Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Charred Broccoli &amp; Bean Bowl" src="/assets/charred_broccoli_bean_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Broccoli 200g</li><li>Cannellini beans 150g</li><li>Romesco sauce</li></ul>
<h4>Preparation</h4>
<p><strong>1. Char:</strong> Toss broccoli florets with oil and roast at high heat (220C) or pan-sear until charred/browned.<br/>
<strong>2. Combine:</strong> Mix warm broccoli with cannellini beans.<br/>
<strong>3. Serve:</strong> Toss generously with Romesco sauce (roasted red pepper &amp; almond sauce).</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast cauliflower. Serve over lentils/kale.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Dandelion Root Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Dandelion Root Latte" src="/assets/dandelion_root_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dandelion root</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p>Heat and whisk.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="week4">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week4', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week4', 'Monday')">Day 22</button><button class="sub-btn" onclick="switchDay('week4', 'Tuesday')">Day 23</button><button class="sub-btn" onclick="switchDay('week4', 'Wednesday')">Day 24</button><button class="sub-btn" onclick="switchDay('week4', 'Thursday')">Day 25</button><button class="sub-btn" onclick="switchDay('week4', 'Friday')">Day 26</button><button class="sub-btn" onclick="switchDay('week4', 'Saturday')">Day 27</button><button class="sub-btn" onclick="switchDay('week4', 'Sunday')">Day 28</button>
</div>
<div class="day-view active" id="week4-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(to right, #f7f9fc, #ffffff);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 4</div>
<h1 style="margin-bottom: 15px;">Hormone Harmony</h1>
<p style="font-size: 1.1rem; color: #555;">Mood stabilizing carbs and magnesium.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>Strategic carbohydrates in the evening boost serotonin production, your brain's natural "off switch." Combined with magnesium-rich ingredients, this week prepares your body for deep, restorative sleepthe only time your adrenals truly repair.</p>
</div></div>
</div>
<div class="day-view" id="week4-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Baked Raspberry Almond Oats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Baked Raspberry Almond Oats" src="/assets/baked_raspberry_almond_oats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 60g</li><li>Almonds</li><li>Raspberries</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine oats, baking powder, cinnamon, and almonds.<br/>
<strong>2. Wet:</strong> Mix mashed banana (if using in base) or maple syrup with milk and melted coconut oil. Fold into dry mix.<br/>
<strong>3. Bake:</strong> Stir in raspberries. Pour into ramekin. Bake at 180C for 20-25 mins.<br/>
<strong>4. Serve:</strong> Drizzle with coconut yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Creamy White Bean Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy White Bean Soup" src="/assets/creamy_white_bean_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>White beans 200g</li><li>Rosemary</li><li>Sourdough side</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut onion, garlic, and celery until soft.<br/>
<strong>2. Simmer:</strong> Add white beans (cannellini) and veggie stock. Add a sprig of rosemary. Simmer 15 mins.<br/>
<strong>3. Blend:</strong> Remove rosemary. Blend soup until creamy (add almond milk if needed).<br/>
<strong>4. Serve:</strong> Serve hot with a slice of sourdough.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Smoky Tempeh Pot Pie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Smoky Tempeh Pot Pie" src="/assets/smoky_tempeh_pot_pie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh</li><li>Root veg</li><li>Cassava crust</li></ul>
<h4>Preparation</h4>
<p><strong>1. Filling:</strong> Saut onion, carrots, celery. Add crumbled tempeh. Stir in flour or starch to coat, then pour in broth to create gravy.<br/>
<strong>2. Crust:</strong> Make a simple cassava flour dough (flour, oil, water) or top with mashed potato.<br/>
<strong>3. Bake:</strong> Place filling in dish, top with crust. Bake at 200C for 25-30 mins until bubbling and golden.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tart Cherry Mocktail</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tart Cherry Mocktail" src="/assets/tart_cherry_mocktail.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tart cherry</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Mix.</p>
</div>
</div>
</div><div class="day-view" id="week4-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Banana Buckwheat Muffins</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Banana Buckwheat Muffins" src="/assets/banana_buckwheat_muffins.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Buckwheat flour 60g</li><li>Banana</li><li>Walnuts</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p><strong>1. Batter:</strong> Mash banana. Whisk with almond milk and a tsp of oil. Stir in buckwheat flour, baking powder, and cinnamon.<br/>
<strong>2. Bake:</strong> Fold in walnuts. Spoon into muffin tin.<br/>
<strong>3. Cook:</strong> Bake at 180C for 20-25 minutes. Let cool slightly.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Cozy Miso Soba Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cozy Miso Soba Bowl" src="/assets/cozy_miso_soba_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Soba noodles</li><li>Miso</li><li>Shiitake</li><li>Tofu 200g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Broth:</strong> Simmer ginger slices, garlic, and shiitake mushrooms in vegetable stock for 10 mins.<br/>
<strong>2. Miso:</strong> Whisk miso with a little hot water separately. Turn off heat and stir into broth (don't boil miso).<br/>
<strong>3. Noodles:</strong> Cook soba noodles, rinse cold. Place in bowl.<br/>
<strong>4. Serve:</strong> Ladle soup over noodles. Top with tofu cubes and scallions.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Gnocchi Sage Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Gnocchi Sage Butter" src="/assets/gnocchi_sage_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Gnocchi</li><li>White beans 150g</li><li>Sage</li><li>Walnuts</li><li>Rocket</li></ul>
<h4>Preparation</h4>
<p><strong>1. Cook Gnocchi:</strong> Boil gnocchi until they float. Drain.<br/>
<strong>2. Sage Sauce:</strong> Heat olive oil or vegan butter in a pan. Fry fresh sage leaves until crisp. Add walnuts.<br/>
<strong>3. Toss:</strong> Add gnocchi to the pan and saut for a few minutes to crisp the outside.<br/>
<strong>4. Serve:</strong> Pile over a bed of fresh rocket.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Valerian</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Valerian" src="/assets/lemon_balm_valerian.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tea</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Berry Chia Jam Toast</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Berry Chia Jam Toast" src="/assets/berry_chia_jam_toast.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seeded bread</li><li>Chia jam</li><li>Tofu scramble side</li></ul>
<h4>Preparation</h4>
<p>Toast bread. Top with jam. Serve with tofu.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lentil Bolognese Squash</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lentil Bolognese Squash" src="/assets/lentil_bolognese_squash.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 200g</li><li>Tomato sauce</li><li>Spaghetti squash</li></ul>
<h4>Preparation</h4>
<p><strong>1. Squash:</strong> Cut squash in half lengthwise, remove seeds. Roast cut-side down at 200C for 40 mins. Scrape out strands.<br/>
<strong>2. Sauce:</strong> Saut onion, carrot, celery. Add lentils, crushed tomatoes, and dried herbs. Simmer 20 mins.<br/>
<strong>3. Serve:</strong> Top squash strands with heavy scoop of bolognese.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Creamy Mushroom Stroganoff</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy Mushroom Stroganoff" src="/assets/creamy_mushroom_stroganoff.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Mushrooms</li><li>Smoked tofu 200g</li><li>Rice noodles</li><li>Cashew cream</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut sliced mushrooms in olive oil until browned. Add garlic and thyme.<br/>
<strong>2. Sauce:</strong> Stir in cashew cream (blended cashews + water), nutritional yeast, and mustard. Simmer to thicken.<br/>
<strong>3. Noodles:</strong> Cook rice noodles. Toss immediately with the sauce.<br/>
<strong>4. Serve:</strong> Top with parsley.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Kava Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Kava Tea" src="/assets/kava_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Kava</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Baked Raspberry Almond Oats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Baked Raspberry Almond Oats" src="/assets/baked_raspberry_almond_oats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 60g</li><li>Almonds</li><li>Raspberries</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine oats, baking powder, cinnamon, and almonds.<br/>
<strong>2. Wet:</strong> Mix mashed banana (if using in base) or maple syrup with milk and melted coconut oil. Fold into dry mix.<br/>
<strong>3. Bake:</strong> Stir in raspberries. Pour into ramekin. Bake at 180C for 20-25 mins.<br/>
<strong>4. Serve:</strong> Drizzle with coconut yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Creamy White Bean Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy White Bean Soup" src="/assets/creamy_white_bean_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>White beans 200g</li><li>Rosemary</li><li>Sourdough side</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut onion, garlic, and celery until soft.<br/>
<strong>2. Simmer:</strong> Add white beans (cannellini) and veggie stock. Add a sprig of rosemary. Simmer 15 mins.<br/>
<strong>3. Blend:</strong> Remove rosemary. Blend soup until creamy (add almond milk if needed).<br/>
<strong>4. Serve:</strong> Serve hot with a slice of sourdough.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Smoky Tempeh Pot Pie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Smoky Tempeh Pot Pie" src="/assets/smoky_tempeh_pot_pie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh</li><li>Root veg</li><li>Cassava crust</li></ul>
<h4>Preparation</h4>
<p><strong>1. Filling:</strong> Saut onion, carrots, celery. Add crumbled tempeh. Stir in flour or starch to coat, then pour in broth to create gravy.<br/>
<strong>2. Crust:</strong> Make a simple cassava flour dough (flour, oil, water) or top with mashed potato.<br/>
<strong>3. Bake:</strong> Place filling in dish, top with crust. Bake at 200C for 25-30 mins until bubbling and golden.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tart Cherry Mocktail</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tart Cherry Mocktail" src="/assets/tart_cherry_mocktail.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tart cherry</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Mix.</p>
</div>
</div>
</div><div class="day-view" id="week4-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Banana Buckwheat Muffins</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Banana Buckwheat Muffins" src="/assets/banana_buckwheat_muffins.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Buckwheat flour 60g</li><li>Banana</li><li>Walnuts</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p><strong>1. Batter:</strong> Mash banana. Whisk with almond milk and a tsp of oil. Stir in buckwheat flour, baking powder, and cinnamon.<br/>
<strong>2. Bake:</strong> Fold in walnuts. Spoon into muffin tin.<br/>
<strong>3. Cook:</strong> Bake at 180C for 20-25 minutes. Let cool slightly.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Cozy Miso Soba Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cozy Miso Soba Bowl" src="/assets/cozy_miso_soba_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Soba noodles</li><li>Miso</li><li>Shiitake</li><li>Tofu 200g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Broth:</strong> Simmer ginger slices, garlic, and shiitake mushrooms in vegetable stock for 10 mins.<br/>
<strong>2. Miso:</strong> Whisk miso with a little hot water separately. Turn off heat and stir into broth (don't boil miso).<br/>
<strong>3. Noodles:</strong> Cook soba noodles, rinse cold. Place in bowl.<br/>
<strong>4. Serve:</strong> Ladle soup over noodles. Top with tofu cubes and scallions.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Gnocchi Sage Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Gnocchi Sage Butter" src="/assets/gnocchi_sage_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Gnocchi</li><li>White beans 150g</li><li>Sage</li><li>Walnuts</li><li>Rocket</li></ul>
<h4>Preparation</h4>
<p><strong>1. Cook Gnocchi:</strong> Boil gnocchi until they float. Drain.<br/>
<strong>2. Sage Sauce:</strong> Heat olive oil or vegan butter in a pan. Fry fresh sage leaves until crisp. Add walnuts.<br/>
<strong>3. Toss:</strong> Add gnocchi to the pan and saut for a few minutes to crisp the outside.<br/>
<strong>4. Serve:</strong> Pile over a bed of fresh rocket.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Valerian</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Valerian" src="/assets/lemon_balm_valerian.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tea</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Berry Chia Jam Toast</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Berry Chia Jam Toast" src="/assets/berry_chia_jam_toast.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seeded bread</li><li>Chia jam</li><li>Tofu scramble side</li></ul>
<h4>Preparation</h4>
<p>Toast bread. Top with jam. Serve with tofu.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lentil Bolognese Squash</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lentil Bolognese Squash" src="/assets/lentil_bolognese_squash.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 200g</li><li>Tomato sauce</li><li>Spaghetti squash</li></ul>
<h4>Preparation</h4>
<p><strong>1. Squash:</strong> Cut squash in half lengthwise, remove seeds. Roast cut-side down at 200C for 40 mins. Scrape out strands.<br/>
<strong>2. Sauce:</strong> Saut onion, carrot, celery. Add lentils, crushed tomatoes, and dried herbs. Simmer 20 mins.<br/>
<strong>3. Serve:</strong> Top squash strands with heavy scoop of bolognese.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Creamy Mushroom Stroganoff</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy Mushroom Stroganoff" src="/assets/creamy_mushroom_stroganoff.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Mushrooms</li><li>Smoked tofu 200g</li><li>Rice noodles</li><li>Cashew cream</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut sliced mushrooms in olive oil until browned. Add garlic and thyme.<br/>
<strong>2. Sauce:</strong> Stir in cashew cream (blended cashews + water), nutritional yeast, and mustard. Simmer to thicken.<br/>
<strong>3. Noodles:</strong> Cook rice noodles. Toss immediately with the sauce.<br/>
<strong>4. Serve:</strong> Top with parsley.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Kava Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Kava Tea" src="/assets/kava_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Kava</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Baked Raspberry Almond Oats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Baked Raspberry Almond Oats" src="/assets/baked_raspberry_almond_oats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 60g</li><li>Almonds</li><li>Raspberries</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine oats, baking powder, cinnamon, and almonds.<br/>
<strong>2. Wet:</strong> Mix mashed banana (if using in base) or maple syrup with milk and melted coconut oil. Fold into dry mix.<br/>
<strong>3. Bake:</strong> Stir in raspberries. Pour into ramekin. Bake at 180C for 20-25 mins.<br/>
<strong>4. Serve:</strong> Drizzle with coconut yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Creamy White Bean Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy White Bean Soup" src="/assets/creamy_white_bean_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>White beans 200g</li><li>Rosemary</li><li>Sourdough side</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut onion, garlic, and celery until soft.<br/>
<strong>2. Simmer:</strong> Add white beans (cannellini) and veggie stock. Add a sprig of rosemary. Simmer 15 mins.<br/>
<strong>3. Blend:</strong> Remove rosemary. Blend soup until creamy (add almond milk if needed).<br/>
<strong>4. Serve:</strong> Serve hot with a slice of sourdough.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Smoky Tempeh Pot Pie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Smoky Tempeh Pot Pie" src="/assets/smoky_tempeh_pot_pie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh</li><li>Root veg</li><li>Cassava crust</li></ul>
<h4>Preparation</h4>
<p><strong>1. Filling:</strong> Saut onion, carrots, celery. Add crumbled tempeh. Stir in flour or starch to coat, then pour in broth to create gravy.<br/>
<strong>2. Crust:</strong> Make a simple cassava flour dough (flour, oil, water) or top with mashed potato.<br/>
<strong>3. Bake:</strong> Place filling in dish, top with crust. Bake at 200C for 25-30 mins until bubbling and golden.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tart Cherry Mocktail</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tart Cherry Mocktail" src="/assets/tart_cherry_mocktail.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tart cherry</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Mix.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="supplements">
    <h1>Supplement Guide</h1>
    <div style="background: #fff3e0; padding: 20px; border-radius: 12px; border: 1px solid #ffe0b2; margin-bottom: 30px;">
        <h4 style="color: #e65100; margin-bottom: 5px; border: none;">Medical Disclaimer</h4>
        <p style="font-size: 0.9rem; margin: 0; color: #666;">Supplements should be taken under the guidance of a healthcare professional. Dosages listed are general guidelines.</p>
    </div>

    <h3 style="color:var(--secondary); margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">Cortisol Calm (Your Essentials)</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-bottom: 50px;">
        <!-- Ashwagandha -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Ashwagandha" src="/assets/ashwagandha_spp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Stress</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Ashwagandha</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">200mg evening. Lowers cortisol and helps manage stress.</p>
            </div>
        </div>
        <!-- Magnesium -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Magnesium Glycinate" src="/assets/magnesium_glycinate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Sleep</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Magnesium Glycinate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">300-400mg nightly. Aids sleep, reduces cramps and anxiety.</p>
            </div>
        </div>
        <!-- Omega 3 -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Omega 3 DHA/EPA" src="/assets/omega_3_algae_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Inflammation</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Omega 3 DHA/EPA</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">300-600mg DHA + 150mg EPA daily. Supports brain health &amp; reduces hot flashes.</p>
            </div>
        </div>
        <!-- B12 -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Vitamin B12" src="/assets/vitamin_b12_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Essentials</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Vitamin B12</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">1,000 mcg 3x weekly. Supports energy levels and nerve function.</p>
            </div>
        </div>
    </div>


    <h3 style="color:var(--text-muted); margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">General Vitality (Optional)</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px;">
        <!-- Iron -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Iron Bisglycinate" src="/assets/iron_bisglycinate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Deficiency Only</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Iron Bisglycinate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">18-25mg every other day (ONLY if deficient). Pair with Vit C for absorption.</p>
            </div>
        </div>
        <!-- Calcium -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Calcium Citrate" src="/assets/calcium_citrate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Bone Health</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Calcium Citrate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">500mg Ca + 2000IU D3 + 90mcg K2. Critical for bone density protection.</p>
            </div>
        </div>
        <!-- Zinc -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Zinc" src="/assets/zinc_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Immunity</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Zinc</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">15mg alternating days. Supports thyroid function. Take with food.</p>
            </div>
        </div>
        <!-- Selenium -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Selenium" src="/assets/selenium_brazil_nut.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Thyroid</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Selenium</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">100mcg (or 1 Brazil nut) alternating days. Key for thyroid conversion.</p>
            </div>
        </div>
        <!-- Iodine -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Iodine (Kelp)" src="/assets/iodine_kelp_granules.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Thyroid</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Iodine (Kelp)</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">150mcg kelp granules (ONLY if deficient). Supports thyroid hormones.</p>
            </div>
        </div>
        <!-- Maca -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Maca" src="/assets/maca_powder.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Hormone Balance</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Maca</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">1 tsp morning (Gelatinized). Adaptogen for mood, energy, and libido.</p>
            </div>
        </div>
        <!-- Flax -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Ground Flax" src="/assets/ground_flax_seeds.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Daily Essential</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Ground Flax</h4>
                <p id="flax-description" style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">1-2 tbsp daily. Rich in lignans to help balance estrogen.</p>
            </div>
        </div>
        <!-- Creatine -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Creatine Monohydrate" src="/assets/creatine_monohydrate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Muscle & Brain</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Creatine Monohydrate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">3-5g daily. Vital for vegans: supports muscle retention, bone density, and cognitive function.</p>
            </div>
        </div>
    </div>
</div>
<div class="view-section" id="swaps">
<h1 style="text-align: center; margin-bottom: 20px;">Quick Swaps</h1>
<div class="card">
<div class="card-body active" style="max-height:2000px; padding:0; opacity:1; overflow:hidden;">
<div style="padding: 30px 30px 20px 30px; background: linear-gradient(to bottom, #fdfbf7, #ffffff); border-bottom: 1px solid rgba(0,0,0,0.03);">
<p style="margin: 0; text-align: center; color: var(--text-muted); font-size: 0.95rem;">Flexible options for allergies, dietary preferences, or pantry availability.</p>
</div>
<div style="overflow-x: auto;">
<table style="margin: 0; border: none; border-radius: 0;">
<thead>
<tr style="background: var(--primary);">
<th style="padding: 18px 30px; width: 40%; color: white; font-weight: 500; letter-spacing: 0.5px;">Original Item</th>
<th style="padding: 18px 30px; width: 60%; color: white; font-weight: 500; letter-spacing: 0.5px;">Alternative Options</th>
</tr>
</thead>
<tbody>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Almond Yogurt</td>
<td style="padding: 15px 30px;">Coconut or Oat yogurt</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Ashwagandha</td>
<td style="padding: 15px 30px;">Maca powder or simply skip</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Cassava Flour</td>
<td style="padding: 15px 30px;">Chickpea or Rice flour</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Cauliflower <span style="font-size:0.8em; color:var(--text-muted); font-weight:400;">(Low FODMAP)</span></td>
<td style="padding: 15px 30px;">Zucchini</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Chickpeas <span style="font-size:0.8em; color:var(--text-muted); font-weight:400;">(Low FODMAP)</span></td>
<td style="padding: 15px 30px;">Firm tofu</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Coconut Aminos</td>
<td style="padding: 15px 30px;">Tamari or Soy sauce</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Cooked Lunches</td>
<td style="padding: 15px 30px;">Raw wraps or salads</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Dates</td>
<td style="padding: 15px 30px;">Ripe bananas</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Farro / Barley</td>
<td style="padding: 15px 30px;">Quinoa or Millet</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Garlic</td>
<td style="padding: 15px 30px;">Infused oil (adds flavor without fiber)</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Hemp Hearts</td>
<td style="padding: 15px 30px;">Sunflower, Pumpkin, or Chia seeds</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Jackfruit</td>
<td style="padding: 15px 30px;">Hearts of Palm or Tofu</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Kelp Noodles</td>
<td style="padding: 15px 30px;">Soba, Rice, or Zucchini noodles</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Lupini Beans</td>
<td style="padding: 15px 30px;">Chickpeas or Edamame</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Miso</td>
<td style="padding: 15px 30px;">Vegetable stock cube or paste</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Monk Fruit</td>
<td style="padding: 15px 30px;">Stevia, Maple syrup, or Coconut sugar</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Nutritional Yeast</td>
<td style="padding: 15px 30px;">A small pinch of Miso</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Tempeh</td>
<td style="padding: 15px 30px;">Tofu, Seitan, or Chickpeas</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Tofu</td>
<td style="padding: 15px 30px;">Chickpea tofu, Lupini beans, or Seitan</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="view-section" id="shopping">
<h1>Shopping Lists</h1>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 1 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Asparagus</li><li onclick="this.classList.toggle('checked')">Avocado</li><li onclick="this.classList.toggle('checked')">Baby Greens</li><li onclick="this.classList.toggle('checked')">Basil</li><li onclick="this.classList.toggle('checked')">Bean Sprouts</li><li onclick="this.classList.toggle('checked')">Bok Choy</li><li onclick="this.classList.toggle('checked')">Broccoli</li><li onclick="this.classList.toggle('checked')">Carrots</li><li onclick="this.classList.toggle('checked')">Cauliflower</li><li onclick="this.classList.toggle('checked')">Collard Greens</li><li onclick="this.classList.toggle('checked')">Cucumber</li><li onclick="this.classList.toggle('checked')">Delicata Squash</li><li onclick="this.classList.toggle('checked')">Dill</li><li onclick="this.classList.toggle('checked')">Fennel</li><li onclick="this.classList.toggle('checked')">Garlic</li><li onclick="this.classList.toggle('checked')">Ginger</li><li onclick="this.classList.toggle('checked')">Lemons</li><li onclick="this.classList.toggle('checked')">Limes</li><li onclick="this.classList.toggle('checked')">Mint</li><li onclick="this.classList.toggle('checked')">Mixed Berries</li><li onclick="this.classList.toggle('checked')">Mung Sprouts</li><li onclick="this.classList.toggle('checked')">Onion</li><li onclick="this.classList.toggle('checked')">Parsley</li><li onclick="this.classList.toggle('checked')">Pear</li><li onclick="this.classList.toggle('checked')">Scallions</li><li onclick="this.classList.toggle('checked')">Shiitake Mushrooms</li><li onclick="this.classList.toggle('checked')">Spinach</li><li onclick="this.classList.toggle('checked')">Zucchini</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Almond Butter</li><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Aloe Vera Juice</li><li onclick="this.classList.toggle('checked')">Artichoke Hearts</li><li onclick="this.classList.toggle('checked')">Brazil Nuts</li><li onclick="this.classList.toggle('checked')">Chamomile Tea</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Chickpeas</li><li onclick="this.classList.toggle('checked')">Cinnamon</li><li onclick="this.classList.toggle('checked')">Coconut Milk</li><li onclick="this.classList.toggle('checked')">Coconut Oil</li><li onclick="this.classList.toggle('checked')">Cranberries</li><li onclick="this.classList.toggle('checked')">Curry Paste</li><li onclick="this.classList.toggle('checked')">Edamame</li><li onclick="this.classList.toggle('checked')">Flaxseed</li><li onclick="this.classList.toggle('checked')">Lemon Balm Tea</li><li onclick="this.classList.toggle('checked')">Maca</li><li onclick="this.classList.toggle('checked')">Magnesium</li><li onclick="this.classList.toggle('checked')">Maple Syrup</li><li onclick="this.classList.toggle('checked')">Miso</li><li onclick="this.classList.toggle('checked')">Nori</li><li onclick="this.classList.toggle('checked')">Pea Protein</li><li onclick="this.classList.toggle('checked')">Pesto</li><li onclick="this.classList.toggle('checked')">Pumpkin Seeds</li><li onclick="this.classList.toggle('checked')">Quinoa</li><li onclick="this.classList.toggle('checked')">Red Lentils</li><li onclick="this.classList.toggle('checked')">Sesame Oil</li><li onclick="this.classList.toggle('checked')">Star Anise</li><li onclick="this.classList.toggle('checked')">Tamari</li><li onclick="this.classList.toggle('checked')">Tempeh</li><li onclick="this.classList.toggle('checked')">Tofu (Firm)</li><li onclick="this.classList.toggle('checked')">Triphala</li><li onclick="this.classList.toggle('checked')">Vegetable Broth</li><li onclick="this.classList.toggle('checked')">Wakame</li><li onclick="this.classList.toggle('checked')">White Beans</li></ul></div></div></div></div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 2 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Apples</li><li onclick="this.classList.toggle('checked')">Asparagus</li><li onclick="this.classList.toggle('checked')">Avocado</li><li onclick="this.classList.toggle('checked')">Blueberries</li><li onclick="this.classList.toggle('checked')">Brussels Sprouts</li><li onclick="this.classList.toggle('checked')">Cauliflower</li><li onclick="this.classList.toggle('checked')">Cherries</li><li onclick="this.classList.toggle('checked')">Cucumber</li><li onclick="this.classList.toggle('checked')">Eggplant</li><li onclick="this.classList.toggle('checked')">Fennel</li><li onclick="this.classList.toggle('checked')">Green Beans</li><li onclick="this.classList.toggle('checked')">Limes</li><li onclick="this.classList.toggle('checked')">Onion</li><li onclick="this.classList.toggle('checked')">Orange</li><li onclick="this.classList.toggle('checked')">Pears</li><li onclick="this.classList.toggle('checked')">Pomegranate</li><li onclick="this.classList.toggle('checked')">Raspberries</li><li onclick="this.classList.toggle('checked')">Spinach</li><li onclick="this.classList.toggle('checked')">Sweet Potato</li><li onclick="this.classList.toggle('checked')">Tomatoes</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Black Rice</li><li onclick="this.classList.toggle('checked')">Buckwheat</li><li onclick="this.classList.toggle('checked')">Cacao Powder</li><li onclick="this.classList.toggle('checked')">Cardamom</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Chili Powder</li><li onclick="this.classList.toggle('checked')">Cinnamon</li><li onclick="this.classList.toggle('checked')">Edamame</li><li onclick="this.classList.toggle('checked')">Farro</li><li onclick="this.classList.toggle('checked')">Hemp Yogurt</li><li onclick="this.classList.toggle('checked')">Kidney Beans</li><li onclick="this.classList.toggle('checked')">Lavender Tea</li><li onclick="this.classList.toggle('checked')">Lentils</li><li onclick="this.classList.toggle('checked')">Maca</li><li onclick="this.classList.toggle('checked')">Monk Fruit</li><li onclick="this.classList.toggle('checked')">Nori</li><li onclick="this.classList.toggle('checked')">Oats</li><li onclick="this.classList.toggle('checked')">Pea Protein</li><li onclick="this.classList.toggle('checked')">Pepitas</li><li onclick="this.classList.toggle('checked')">Pesto</li><li onclick="this.classList.toggle('checked')">Reishi</li><li onclick="this.classList.toggle('checked')">Sage</li><li onclick="this.classList.toggle('checked')">Seitan</li><li onclick="this.classList.toggle('checked')">Sesame Oil</li><li onclick="this.classList.toggle('checked')">Smoked Tofu</li><li onclick="this.classList.toggle('checked')">Spirulina</li><li onclick="this.classList.toggle('checked')">Tahini</li><li onclick="this.classList.toggle('checked')">Tamari</li><li onclick="this.classList.toggle('checked')">Tempeh</li><li onclick="this.classList.toggle('checked')">Tulsi Tea</li><li onclick="this.classList.toggle('checked')">Walnuts</li></ul></div></div></div></div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 3 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Apple</li><li onclick="this.classList.toggle('checked')">Apricots</li><li onclick="this.classList.toggle('checked')">Avocado</li><li onclick="this.classList.toggle('checked')">Banana</li><li onclick="this.classList.toggle('checked')">Broccoli</li><li onclick="this.classList.toggle('checked')">Carrot</li><li onclick="this.classList.toggle('checked')">Cauliflower</li><li onclick="this.classList.toggle('checked')">Cucumber</li><li onclick="this.classList.toggle('checked')">Dandelion Root</li><li onclick="this.classList.toggle('checked')">Ginger</li><li onclick="this.classList.toggle('checked')">Grapefruit</li><li onclick="this.classList.toggle('checked')">Holy Basil</li><li onclick="this.classList.toggle('checked')">Kale</li><li onclick="this.classList.toggle('checked')">Mint</li><li onclick="this.classList.toggle('checked')">Rosemary</li><li onclick="this.classList.toggle('checked')">Sweet Potato</li><li onclick="this.classList.toggle('checked')">Thai Basil</li><li onclick="this.classList.toggle('checked')">Tomato</li><li onclick="this.classList.toggle('checked')">Zucchini</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">ACV</li><li onclick="this.classList.toggle('checked')">Almond Butter</li><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Beluga Lentils</li><li onclick="this.classList.toggle('checked')">Cacao Powder</li><li onclick="this.classList.toggle('checked')">Cannellini Beans</li><li onclick="this.classList.toggle('checked')">Cashews (Butter & Whole)</li><li onclick="this.classList.toggle('checked')">Cayenne</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Chickpea Flour</li><li onclick="this.classList.toggle('checked')">Chickpeas</li><li onclick="this.classList.toggle('checked')">Chili Powder</li><li onclick="this.classList.toggle('checked')">Coconut Cream</li><li onclick="this.classList.toggle('checked')">Coconut Milk</li><li onclick="this.classList.toggle('checked')">Coconut Oil</li><li onclick="this.classList.toggle('checked')">Coconut Yogurt</li><li onclick="this.classList.toggle('checked')">Cold Brew Coffee</li><li onclick="this.classList.toggle('checked')">Dandelion Root Powder</li><li onclick="this.classList.toggle('checked')">Fennel Seeds/Tea</li><li onclick="this.classList.toggle('checked')">Kimchi</li><li onclick="this.classList.toggle('checked')">Maple Syrup</li><li onclick="this.classList.toggle('checked')">Millet</li><li onclick="this.classList.toggle('checked')">Miso</li><li onclick="this.classList.toggle('checked')">Pea Protein</li><li onclick="this.classList.toggle('checked')">Pumpkin Seeds</li><li onclick="this.classList.toggle('checked')">Quinoa</li><li onclick="this.classList.toggle('checked')">Romesco Sauce</li><li onclick="this.classList.toggle('checked')">Tahini</li><li onclick="this.classList.toggle('checked')">Tofu</li><li onclick="this.classList.toggle('checked')">Walnuts</li></ul></div></div></div></div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 4 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Banana</li><li onclick="this.classList.toggle('checked')">Carrots</li><li onclick="this.classList.toggle('checked')">Lemon Balm</li><li onclick="this.classList.toggle('checked')">Mushrooms (Shiitake/Button)</li><li onclick="this.classList.toggle('checked')">Orange</li><li onclick="this.classList.toggle('checked')">Raspberries</li><li onclick="this.classList.toggle('checked')">Rocket</li><li onclick="this.classList.toggle('checked')">Root Vegetables</li><li onclick="this.classList.toggle('checked')">Rosemary</li><li onclick="this.classList.toggle('checked')">Sage</li><li onclick="this.classList.toggle('checked')">Squash (Spaghetti)</li><li onclick="this.classList.toggle('checked')">Tart Cherry Juice</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Almonds</li><li onclick="this.classList.toggle('checked')">Buckwheat Flour</li><li onclick="this.classList.toggle('checked')">Cacao Powder</li><li onclick="this.classList.toggle('checked')">Cashews</li><li onclick="this.classList.toggle('checked')">Cassava Flour</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Coconut Flour</li><li onclick="this.classList.toggle('checked')">Coconut Yogurt</li><li onclick="this.classList.toggle('checked')">Dark Chocolate</li><li onclick="this.classList.toggle('checked')">Dates</li><li onclick="this.classList.toggle('checked')">Gnocchi</li><li onclick="this.classList.toggle('checked')">Kava Tea</li><li onclick="this.classList.toggle('checked')">Lentils</li><li onclick="this.classList.toggle('checked')">Magnesium</li><li onclick="this.classList.toggle('checked')">Miso</li><li onclick="this.classList.toggle('checked')">Oats</li><li onclick="this.classList.toggle('checked')">Pepitas</li><li onclick="this.classList.toggle('checked')">Rice Noodles</li><li onclick="this.classList.toggle('checked')">Seeded Bread</li><li onclick="this.classList.toggle('checked')">Soba Noodles</li><li onclick="this.classList.toggle('checked')">Sourdough Bread</li><li onclick="this.classList.toggle('checked')">Tart Cherry</li><li onclick="this.classList.toggle('checked')">Tempeh</li><li onclick="this.classList.toggle('checked')">Tofu</li><li onclick="this.classList.toggle('checked')">Tomato Sauce</li><li onclick="this.classList.toggle('checked')">Valerian Tea</li><li onclick="this.classList.toggle('checked')">Walnuts</li><li onclick="this.classList.toggle('checked')">White Beans</li></ul></div></div></div></div>
</div>
<!-- Sleep Protocol Section -->
<div class="view-section" id="sleep">
    <div class="sleep-hero">
        <h1 style="color:white; margin-bottom:10px;">The Adrenal Sleep Architecture</h1>
        <p style="font-size:1.15rem; opacity:0.9; max-width:600px; margin:0 auto;">Use this specific sequence to lower your core body temperature and signal safety to your nervous system.</p>
        
        <div class="glass-effect">
            <span style="font-size:2rem; display:block; margin-bottom:10px;">???</span>
            <strong>Why Temperature Matters:</strong> Deep sleep only occurs when your core temperature drops by 2-3F. Cortisol keeps you hot. This routine forces the drop.
        </div>
    </div>

    <!-- Wind Down Routine -->
    <div class="section-title">
        <div class="section-number">1</div>
        <h2>The Wind Down Routine</h2>
    </div>

    <div style="margin-bottom: 60px;">
        <div class="timeline-item">
            <div class="timeline-time">12:00 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">The Caffeine Hard Stop</span>
                Switch to herbal tea or water. Caffeine has a quarter-life of 12 hours. Drinking it at 2PM means 25% is still active in your brain at 2AM, blocking deep sleep.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">7:00 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">Kitchen Closed</span>
                Finish your last meal 3 hours before bed. Digestion is a thermogenic (heat-producing) process. We need your body cool to initiate sleep.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">8:30 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">The Blue Light Block</span>
                Laptops closed. Phone on 'Night Shift' or 'Eye Comfort' mode. Blue light stimulates the same cortisol receptors as sunlight.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">9:00 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">Thermal Dump Shower</span>
                Take a <strong>warm</strong> shower or bath. When you step out into cool air, your body heat rapidly dissipates. This steep drop mimics the biological signal for sleep onset.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">9:45 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">The Brain Dump</span>
                Write down your top 3 'Must Do' items for tomorrow on paper. Get them out of your head so your Reticular Activating System (brain's alarm) can stand down.
            </div>
        </div>
    </div>

    <!-- Adrenal Mocktail Feature -->
    <div class="section-title">
        <div class="section-number">2</div>
        <h2>Your Sleep Cocktail</h2>
    </div>

    <div class="recipe-card">
        <div style="font-size: 5rem; line-height: 1;">??</div>
        <div style="flex-grow:1;">
            <h3 style="color:var(--primary); margin-top:0;">The 'Adrenal Mocktail'</h3>
            <p>Drink this 1 hour before bed instead of wine. It provides the building blocks for melatonin without the blood sugar crash.</p>
            <ul style="margin-bottom:0;">
                <li><strong>1/2 cup Tart Cherry Juice</strong> (Natural source of Melatonin)</li>
                <li><strong>1 scoop Magnesium Glycinate</strong> (The relaxation mineral)</li>
                <li><strong>Pinch of Sea Salt</strong> (Lowers adrenaline)</li>
                <li><strong>Sparkling Water</strong></li>
            </ul>
        </div>
    </div>

    <!-- 3AM Protocol -->
     <div class="section-title">
        <div class="section-number">3</div>
        <h2>The 3 A.M. Emergency Protocol</h2>
    </div>
    
    <div class="rescue-card">
        <h4 style="color:#c53030; margin-top:0; display:flex; align-items:center; gap:10px;">? Woke up wired?</h4>
        <p>This is a liver glycogen crash causing an adrenaline spike. <strong>Do NOT look at the clock.</strong> Looking at the time engages your logical brain and wakefulness.</p>
        <p style="font-weight:600; margin-bottom:5px;">Try this:</p>
        <ol style="margin-top:0; padding-left:20px;">
            <li style="margin-bottom:5px;"><strong>Physiological Sigh:</strong> Two sharp inhales through nose, one long exhale through mouth. Repeat 3 times.</li>
            <li style="margin-bottom:5px;"><strong>Cool the Palm:</strong> Stick a foot or hand out from the covers to dump heat.</li>
            <li><strong>Last Resort:</strong> If awake >20 mins, get up and do a boring task (fold laundry) in dim light until tired.</li>
        </ol>
    </div>

    <!-- Bedroom Setup Checklist -->
    <div class="section-title" style="margin-top:60px;">
        <div class="section-number">4</div>
        <h2>Bedroom Sanctuary Checklist</h2>
    </div>

    <div class="checklist-grid">
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>Temperature Drop</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Set thermostat to 65-68F (18-20C). Cool rooms promote deeper REM cycles.</span>
            </div>
        </div>
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>Total Blackout</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Cover all LEDs (even the TV standby light). Use blackout curtains or a sleep mask.</span>
            </div>
        </div>
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>Phone Quarantine</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Charge your phone in the bathroom or hallway, not on the nightstand.</span>
            </div>
        </div>
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>White Noise</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Use a fan or sound machine to mask sudden noises that trigger 'light sleeper' wakeups.</span>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 50px; text-align: center;">
         <p style="color:var(--text-muted);">Prefer a printed copy?</p>
         <a href="adrenal_sleep_guide.html" target="_blank" style="text-decoration:none;"><button style="background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-size:1rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='var(--primary)'">Download Printable Guide</button></a>
    </div>

        </div> <!-- End meals-content-container -->
    </div> <!-- End view-meals -->

    <!-- Placeholder for moved sections (Movement, Support) - they will be moved here by JS -->
    <!-- Duplicate movement view removed -->

    <!-- INSTALL APP BANNER (Hidden by default) -->
    <!-- INSTALL APP BANNER MOVED TO FOOTER FOR FIXED POSITIONING -->


    <!-- SUPPORT VIEW (Coach & Community) -->
    <div id="view-support" class="app-view" style="display:none; padding-bottom: 80px;">
        <div class="app-header">
            <div class="app-logo">Support</div>
            <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
        </div>
        
        <div style="padding: 20px; min-height: calc(100vh - 160px); display: flex; flex-direction: column;">
            
            <!-- Tab Switcher for Support -->
            <div style="display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 25px; position: sticky; top: 80px; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <button class="sub-btn active" style="flex:1; border:none; box-shadow:none; background:white; color:var(--primary); font-weight: 600;" onclick="showSupportTab('chat', this)">Coach Chat</button>
                <button class="sub-btn" style="flex:1; border:none; box-shadow:none; background:transparent; color:#64748b;" onclick="showSupportTab('community', this)">Community</button>
                <button class="sub-btn" style="flex:1; border:none; box-shadow:none; background:transparent; color:#64748b;" onclick="showSupportTab('reflections', this)">Reflections</button>
            </div>

            <!-- CHAT VIEW CONTAINER -->
            <!-- CHAT VIEW CONTAINER (Messenger Style Match) -->
            <div id="support-chat" style="display: flex; flex-direction: column; background: #fff; position: relative; padding-bottom: 0;">

                <!-- Fixed Header (Matches Community) -->
                <div style="height: 60px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index: 50;">
                    <div style="text-align: center;">
                        <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main);">Coach Shannon</div>
                        <div id="coach-header-status-text" style="font-size: 0.75rem; color: var(--primary); font-weight: 600;">Active Now</div>
                    </div>
                </div>

                <!-- Chat Stream -->
                <div id="chat-messages-container" style="padding: 15px; padding-bottom: 120px; display: block;">
                    <!-- Intro Message (re-added here as static first item, or handled by JS history load) -->
                    <div style="display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 20px; max-width: 85%;">
                        <div style="background: #f8fafc; padding: 15px 20px; border-radius: 0 16px 16px 16px; border: 1px solid #e2e8f0; color: var(--text-main);">
                        <p style="margin: 0; font-size: 0.95rem; line-height: 1.5;">Hey there! I'm Shannon, your reset coach. Leave a message here about your progress or any questions. I'll review it and get back to you with guidance!</p>
                        </div>
                        <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 5px; margin-left: 2px;">Shannon  Always here</div>
                    </div>
                </div>

                <!-- Input Area (Fixed above bottom nav) -->
                <div style="position: fixed; bottom: 90px; left: 0; width: 100%; background: white; padding: 10px 15px; border-top: 1px solid #f1f5f9; z-index: 60; box-shadow: 0 -2px 10px rgba(0,0,0,0.02);">
                    <form onsubmit="event.preventDefault(); submitCoachMessage();" style="display: flex; align-items: center; gap: 10px; width: 100%; margin: 0;">
                        <input type="text" id="coach-chat-input" placeholder="Ask your coach..." style="flex: 1; background: #f1f5f9; border: none; padding: 12px 15px; border-radius: 20px; font-size: 1rem; outline: none; color: var(--text-main);">
                        <div onclick="submitCoachMessage()" style="width: 40px; height: 40px; border: none; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; flex-shrink: 0;">
                                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white; margin-left: 4px; pointer-events: none;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </div>
                        <button type="submit" style="display:none;"></button>
                    </form>
                </div>
            </div>

            <!-- COMMUNITY INTERFACE (Hidden by default) -->
            <!-- COMMUNITY INTERFACE (Messenger Style) -->
            <div id="support-community" style="display: none; flex-direction: column; height: 100vh; background: #fff; position: relative; padding-bottom: 0; overflow: hidden;">
                <!-- Fixed Chat Header -->
                <div style="height: 60px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index: 50;">
                    <div style="text-align: center;">
                        <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main);">Your Referral Network</div>
                        <div id="referral-network-count" style="font-size: 0.75rem; color: #94a3b8;">Loading...</div>
                    </div>
                </div>

                <!-- Referral Invite Banner -->
                <div id="referral-invite-banner" style="margin: 15px; padding: 20px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 16px; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2); flex-shrink: 0; position: relative;">
                    <!-- Dismiss button -->
                    <div onclick="dismissReferralBanner()" style="position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: white;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="font-size: 2rem;">🎁</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.1rem; color: white; margin-bottom: 4px;">You BOTH Get 2 Weeks Free!</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.9);">Invite friends and you each get 2 weeks free when they join</div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div id="referral-stats" style="display: flex; gap: 12px; margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 10px; backdrop-filter: blur(10px);">
                        <div style="flex: 1; text-align: center;">
                            <div id="referral-count" style="font-size: 1.5rem; font-weight: 700; color: white;">0</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.5px;">Friends</div>
                        </div>
                        <div style="flex: 1; text-align: center;">
                            <div id="free-days-count" style="font-size: 1.5rem; font-weight: 700; color: white;">0</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.5px;">Days Free</div>
                        </div>
                    </div>

                    <!-- Share Button -->
                    <button onclick="openShareReferralModal()" style="width: 100%; background: white; color: #059669; border: none; padding: 14px; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s;">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #059669;">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                        Share Your Link
                    </button>
                </div>

                <!-- Chat Stream -->
                <div id="community-chat-stream" style="padding: 15px; padding-bottom: 170px; overflow-y: auto; -webkit-overflow-scrolling: touch; flex: 1;">
                    <!-- Messages injected here -->
                </div>

                <!-- Input Area (Fixed above bottom nav) -->
                <div style="position: fixed; bottom: 90px; left: 0; width: 100%; background: white; padding: 10px 15px; border-top: 1px solid #f1f5f9; z-index: 60; box-shadow: 0 -2px 10px rgba(0,0,0,0.02);">
                    <form onsubmit="event.preventDefault(); sendCommunityMessage();" style="display: flex; align-items: center; gap: 10px; width: 100%; margin: 0;">
                        <input type="text" id="community-chat-input" placeholder="Message..." style="flex: 1; background: #f1f5f9; border: none; padding: 12px 15px; border-radius: 20px; font-size: 1rem; outline: none; color: var(--text-main);">
                        <!-- Clickable container or specific button logic -->
                        <div onclick="sendCommunityMessage()" style="width: 40px; height: 40px; border: none; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; flex-shrink: 0;">
                             <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white; pointer-events: none;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </div>
                        <button type="submit" style="display:none;"></button>
                    </form>
                </div>
            </div>

            <!-- REFLECTIONS INTERFACE (Hidden by default) -->
            <div id="support-reflections" style="display: none; flex-direction: column; height: 100vh; background: #fff; position: relative; padding-bottom: 70px; overflow: hidden;">

                <!-- Header -->
                <div style="padding: 20px 20px 15px 20px; border-bottom: 1px solid #f1f5f9;">
                    <h2 style="margin: 0 0 5px 0; font-size: 1.5rem; color: var(--text-main);">Your Reflections</h2>
                    <p style="margin: 0; font-size: 0.875rem; color: #64748b;">Daily journal entries and end-of-day reflections</p>
                </div>

                <!-- Add New Reflection Button -->
                <div style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9;">
                    <button onclick="openNewReflectionModal()" style="width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">+</span> Add Reflection
                    </button>
                </div>

                <!-- Reflections List -->
                <div id="reflections-list" style="flex: 1; overflow-y: auto; padding: 20px;">
                    <!-- Reflections will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- ACTIVE WORKOUT PLAYER (Hidden by default) -->
    <div id="view-active-workout-stub" class="app-view" style="display:none; background: #fff; padding-bottom: 0;">
        <!-- Workout Header -->
        <div style="position: sticky; top:0; z-index:100; background:white; border-bottom:1px solid #eee; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <div onclick="quitWorkout()" style="cursor:pointer; color:var(--text-muted);">✕</div>
            <div style="font-weight:700;" id="stub-workout-player-title">Workout</div>
            <div style="font-family:monospace; font-size:1.1rem; color:var(--primary);" id="stub-workout-timer">00:00</div>
        </div>

        <!-- Video Player Stub -->
        <div style="width:100%; height:220px; background:black; display:flex; align-items:center; justify-content:center; position:relative;">
            <div id="stub-workout-video-placeholder" style="color:white; text-align:center;">
                <div style="font-size:3rem;">▶</div>
                <div>Play Video Tutorial</div>
            </div>
            <!-- In real app, proper video tag here -->
        </div>

        <!-- Exercise List -->
        <div id="stub-workout-exercises-list" style="padding: 20px; padding-bottom: 100px;">
            <!-- Dynamic Content Injected Here -->
        </div>

        <!-- Finish Bar -->
        <div style="position: fixed; bottom:0; left:0; width:100%; padding: 20px; background:white; border-top:1px solid #eee; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 50;">
            <button onclick="finishWorkout()" class="btn-primary" style="width:100%; border-radius:30px; touch-action: manipulation; user-select: none; min-height: 56px; cursor: pointer;">FINISH WORKOUT</button>
        </div>
    </div>

    <!-- WORKOUT SUCCESS SCREEN -->
    <div id="view-workout-success-stub" class="app-view" style="display:none; background: var(--primary); color:white; text-align:center; flex-direction:column; align-items:center; justify-content:center; height:100%;">
        <div style="font-size: 5rem; margin-bottom: 20px;">🎉</div>
        <h1 style="font-family: 'Playfair Display'; font-size: 3rem; margin-bottom: 10px;">High Five!</h1>
        <p style="font-size: 1.2rem; opacity: 0.9;">Workout Complete</p>
        <div style="margin-top: 40px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 16px;">
            <div style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Duration</div>
            <div style="font-size: 2rem; font-weight: 700;" id="stub-success-duration">24:00</div>
        </div>
        <button onclick="closeSuccessScreen()" style="margin-top: 50px; background: white; color: var(--primary); border:none; padding: 15px 40px; border-radius: 30px; font-weight: 700; font-size: 1rem; cursor: pointer;">DONE</button>
    </div>

    <style>
        /* Workout Logger Styles */
        .exercise-logger-card {
            border: 1px solid #eee;
            border-radius: 12px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        .exercise-header {
            background: #f8fafc;
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .set-row {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f1f5f9;
            gap: 10px;
        }
        .set-col-label {
            font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; text-align: center;
        }
        .set-input {
            background: #f1f5f9;
            border: 1px solid transparent;
            border-radius: 6px;
            text-align: center;
            padding: 8px;
            width: 100%;
            font-weight: 600;
            color: var(--text-main);
        }
        .set-input:focus { background: white; border-color: var(--primary); outline: none; }
        .set-check {
            width: 35px; height: 35px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: transparent;
            transition: all 0.2s;
        }
        .set-check.completed {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Day Completion Modal */
        .completion-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.5s ease-out;
        }
        .completion-modal {
            background: white;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: popUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 4px solid var(--secondary);
        }
        @keyframes popUp {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .confetti-piece {
            position: absolute;
            width: 10px; height: 10px;
            background: #ffd700;
            top: -10px;
            z-index: 10000;
        }
    </style>

    <!-- DAY COMPLETION MODAL -->
    <div id="day-completion-modal" class="completion-modal-overlay">
        <div class="completion-modal">
            <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce 1s infinite;">??</div>
            <h2 style="color: var(--primary); font-size: 1.8rem; margin: 0 0 10px 0;">Day Complete!</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;" id="completion-text">You have successfully finished Day 1.</p>
            
            <div style="background: #f0fdf4; padding: 15px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #bbf7d0;">
                <div style="font-size: 0.9rem; color: #166534; font-weight: 600;">Cortisol Level: Stabilizing ??</div>
            </div>

            <button onclick="closeCompletionModal()" style="background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-weight: 700; font-size: 1.1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(4, 106, 56, 0.3);">
                CONTINUE
            </button>
        </div>
    </div>


<!-- MOVEMENT VIEW (Shared Main Tab) -->
<div id="movement-tab" class="app-view" style="display:none;">
    <div class="app-header">
        <div class="app-logo">Movement Studio</div>
        <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
    </div>
    
    <div style="padding: 25px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
            <div>
                <div style="color:var(--text-muted); font-size:0.85rem; font-weight:600; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;" id="movement-today-date">Day 1</div>
                <h1 style="color:var(--primary); margin:0; font-size:2rem; letter-spacing:-1px;">Today's Schedule</h1>
            </div>
            <!-- Button Removed -->
        </div>

        <!-- Dynamic Hero Container -->
        <div id="movement-hero-container"></div>

        <div id="saved-workouts-container" style="display:none; margin-bottom:30px;">
            <h3 style="margin-bottom:15px;">Your Saved Workouts</h3>
            <div id="saved-workouts-list" style="display:flex; gap:15px; overflow-x:auto; padding-bottom:10px; scrollbar-width: none;"></div>
        </div>

        <div style="margin-bottom: 20px;">
            <h3 style="margin:0;">Browse Programs</h3>
        </div>

        <!-- Dynamic Grid Container -->
        <div id="movement-grid-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
    </div>
</div>

<!-- MOVED CHECK-IN MODAL TO BODY ROOT -->

<style>
    .checkin-btn.selected {
        border-color: var(--primary) !important;
        background: #f0fdf4 !important;
        color: var(--primary);
    }
</style>





<script>
let customWorkoutSelection = [];

function openWorkoutBuilder() {
    customWorkoutSelection = []; // Reset on open
    document.getElementById('builder-search').value = '';
    filterExerciseLibrary('');
    updateBuilderUI();
    hideAllAppViews();
    document.getElementById('view-workout-builder').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';
}

// Initialize filter state
if (typeof window.activeFilters === 'undefined') {
    window.activeFilters = {
        workoutType: [],
        equipment: [],
        muscle: []
    };
}

// Toggle filter chip
function toggleFilter(category, value) {
    const filters = window.activeFilters[category];
    const index = filters.indexOf(value);

    // Find the button element
    const btn = document.querySelector(`.filter-chip[data-category="${category}"][data-value="${value}"]`);

    if (index > -1) {
        // Remove filter
        filters.splice(index, 1);
        btn.style.background = 'white';
        btn.style.color = '#64748b';
        btn.style.borderColor = '#e2e8f0';
    } else {
        // Add filter
        filters.push(value);
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--primary)';
    }

    // Show/hide clear button
    const hasActiveFilters = Object.values(window.activeFilters).some(arr => arr.length > 0);
    document.getElementById('clear-filters-btn').style.display = hasActiveFilters ? 'block' : 'none';

    // Re-run filter
    filterExerciseLibrary(document.getElementById('builder-search').value);
}

// Clear all filters
function clearAllFilters() {
    window.activeFilters = {
        workoutType: [],
        equipment: [],
        muscle: []
    };

    // Reset all filter chip styles
    document.querySelectorAll('.filter-chip').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#64748b';
        btn.style.borderColor = '#e2e8f0';
    });

    // Hide clear button
    document.getElementById('clear-filters-btn').style.display = 'none';

    // Re-run filter
    filterExerciseLibrary(document.getElementById('builder-search').value);
}

// Toggle filter section expand/collapse
function toggleFilterSection(sectionId) {
    const content = document.getElementById(`filter-content-${sectionId}`);
    const chevron = document.getElementById(`chevron-${sectionId}`);

    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
    }
}

// Check if exercise matches category filter
function matchesFilter(exerciseName) {
    const nameLower = exerciseName.toLowerCase();

    // Check workout type filters
    if (window.activeFilters.workoutType.length > 0) {
        const matchesWorkoutType = window.activeFilters.workoutType.some(type => {
            if (type === 'yoga') return nameLower.includes('yoga');
            if (type === 'pilates') return nameLower.includes('pilates');
            if (type === 'cardio') return nameLower.includes('sprint') || nameLower.includes('run') || nameLower.includes('jump') || nameLower.includes('hop') || nameLower.includes('burpee');
            if (type === 'stretch') return nameLower.includes('stretch') || nameLower.includes('foam roller');
            return false;
        });
        if (!matchesWorkoutType) return false;
    }

    // Check equipment filters
    if (window.activeFilters.equipment.length > 0) {
        const matchesEquipment = window.activeFilters.equipment.some(equip => {
            if (equip === 'dumbbell') return nameLower.includes('dumbbell');
            if (equip === 'barbell') return nameLower.includes('barbell');
            if (equip === 'cable') return nameLower.includes('cable');
            if (equip === 'band') return nameLower.includes('band') || nameLower.includes('miniband');
            if (equip === 'kettlebell') return nameLower.includes('kettlebell');
            if (equip === 'machine') return nameLower.includes('machine');
            if (equip === 'bodyweight') {
                // Bodyweight = doesn't contain any equipment keywords
                return !nameLower.includes('dumbbell') &&
                       !nameLower.includes('barbell') &&
                       !nameLower.includes('cable') &&
                       !nameLower.includes('band') &&
                       !nameLower.includes('kettlebell') &&
                       !nameLower.includes('machine') &&
                       !nameLower.includes('ball') &&
                       !nameLower.includes('trx') &&
                       !nameLower.includes('sled');
            }
            return false;
        });
        if (!matchesEquipment) return false;
    }

    // Check muscle group filters
    if (window.activeFilters.muscle.length > 0) {
        const matchesMuscle = window.activeFilters.muscle.some(muscle => {
            if (muscle === 'chest') return nameLower.includes('chest') || nameLower.includes('pec') || (nameLower.includes('press') && (nameLower.includes('bench') || nameLower.includes('floor')));
            if (muscle === 'back') return nameLower.includes('back') || nameLower.includes('lat') || nameLower.includes('row') || nameLower.includes('pull up') || nameLower.includes('pullup');
            if (muscle === 'shoulders') return nameLower.includes('shoulder') || nameLower.includes('delt') || nameLower.includes('raise') || nameLower.includes('overhead press');
            if (muscle === 'arms') return nameLower.includes('bicep') || nameLower.includes('tricep') || nameLower.includes('curl') || nameLower.includes('extension') && !nameLower.includes('leg') && !nameLower.includes('back');
            if (muscle === 'core') return nameLower.includes('ab') || nameLower.includes('core') || nameLower.includes('crunch') || nameLower.includes('plank') || nameLower.includes('oblique');
            if (muscle === 'legs') return nameLower.includes('squat') || nameLower.includes('lunge') || nameLower.includes('leg') || nameLower.includes('quad') || nameLower.includes('hamstring') || nameLower.includes('calf');
            if (muscle === 'glutes') return nameLower.includes('glute') || nameLower.includes('hip') || nameLower.includes('kickback');
            return false;
        });
        if (!matchesMuscle) return false;
    }

    return true;
}

function filterExerciseLibrary(query) {
    const list = document.getElementById('builder-library-list');
    if (!list) {
        console.error("Builder library list element not found!");
        return;
    }
    list.innerHTML = '';

    // Safety check for library loading
    if (typeof EXERCISE_VIDEOS === 'undefined') {
        list.innerHTML = `
            <div style="padding:20px; text-align:center; color:red; background:#fee2e2; border-radius:12px;">
                <strong>Error: Exercise Library Not Loaded</strong><br>
                <div style="font-size:0.8rem; margin-top:5px;">Please verify 'exercise_videos.js' file exists and is in the same folder.</div>
            </div>`;
        return;
    }

    // Global or scoped state for pagination
    if(typeof window.builderLimit === 'undefined') window.builderLimit = 50;

    const terms = query.toLowerCase().split(' ').filter(t => t);

    const allKeys = Object.keys(EXERCISE_VIDEOS);
    if (allKeys.length === 0) {
        list.innerHTML = '<div style="padding:20px; text-align:center;">Library is empty.</div>';
        return;
    }

    // 1. Gather Matches (search query + category filters)
    const matchedKeys = [];
    for (let key of allKeys) {
        const keyLower = key.toLowerCase();

        // Check search query
        let matchesQuery = true;
        if (terms.length > 0) {
            for (let term of terms) {
                if (!keyLower.includes(term)) {
                    matchesQuery = false;
                    break;
                }
            }
        }

        // Check category filters
        const matchesCategories = matchesFilter(key);

        if (matchesQuery && matchesCategories) {
            matchedKeys.push(key);
        }
    }

    // 2. Render Selection
    const keysToRender = matchedKeys.slice(0, window.builderLimit);

    keysToRender.forEach(key => {
        const isSelected = customWorkoutSelection.includes(key);
        const div = document.createElement('div');
        div.style.cssText = `background:white; border:1px solid ${isSelected ? 'var(--primary)' : '#f1f5f9'}; padding:15px; border-radius:16px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; min-height:60px;`;
        if(isSelected) div.style.background = '#f0fdf4';

        div.innerHTML = `
            <div style="font-weight:600; font-size:0.95rem; color:var(--text-main); flex:1; padding-right:10px;">${key}</div>
            <button onclick="toggleBuilderItem(this, '${key.replace(/'/g, "\\'")}')" style="width:32px; height:32px; border-radius:50%; border:none; background:${isSelected ? 'var(--primary)' : '#f1f5f9'}; color:${isSelected ? 'white' : '#94a3b8'}; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                ${isSelected ? '✓' : '+'}
            </button>
        `;
        list.appendChild(div);
    });

    // 3. Load More Button
    if (matchedKeys.length > window.builderLimit) {
        const moreDiv = document.createElement('div');
        moreDiv.innerHTML = `<button onclick="window.builderLimit += 50; filterExerciseLibrary(document.getElementById('builder-search').value)" style="width:100%; padding:15px; border:none; background:#f1f5f9; color:var(--text-muted); font-weight:600; border-radius:12px; cursor:pointer;">Load More (${matchedKeys.length - window.builderLimit} remaining)</button>`;
        list.appendChild(moreDiv);
    }

    if (matchedKeys.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted);">No exercises found</div>';
    }
}

// Ensure limit reset on open
const originalOpenBuilder = window.openWorkoutBuilder;
window.openWorkoutBuilder = function() {
    window.builderLimit = 50;
    if(originalOpenBuilder) originalOpenBuilder(); // Recursion risk if defined by name? 
    // Wait, openWorkoutBuilder is defined above. We should edit it directly or just resetting global var here is risky.
    // Better: Update openWorkoutBuilder in a separate chunk or rely on the input handler resetting it?
    // Let's simple check: if query length < previous query? No.
    // I'll just Replace openWorkoutBuilder in a separate edit or use MultiReplace.
};

function toggleBuilderItem(btn, key) {
    const index = customWorkoutSelection.indexOf(key);
    const parent = btn.parentElement;
    
    if (index > -1) {
        customWorkoutSelection.splice(index, 1);
        parent.style.borderColor = '#f1f5f9';
        parent.style.background = 'white';
        btn.style.background = '#f1f5f9';
        btn.style.color = '#94a3b8';
        btn.innerHTML = '+';
    } else {
        customWorkoutSelection.push(key);
        parent.style.borderColor = 'var(--primary)';
        parent.style.background = '#f0fdf4';
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        btn.innerHTML = '✓';
    }
    updateBuilderUI();
}

function updateBuilderUI() {
    const floatAction = document.getElementById('builder-floating-action');
    const countSpan = document.getElementById('builder-count');
    
    if (customWorkoutSelection.length > 0) {
        floatAction.style.display = 'block';
        countSpan.innerText = customWorkoutSelection.length;
    } else {
        floatAction.style.display = 'none';
    }
}

function startCustomBuilderWorkout() {
    if (customWorkoutSelection.length === 0) return;
    
    // Construct a dynamic workout object
    const customWorkout = {
        title: 'Custom Session',
        name: 'Custom Builder',
        description: 'Your personalized session',
        exercises: customWorkoutSelection.map(key => ({
            name: key,
            sets: 3,
            reps: '12',
            videoUrl: '', // Will be looked up
            desc: ''
        }))
    };
    
    // Hijack the player
    document.getElementById('workout-player-title').innerText = customWorkout.title;
    document.getElementById('workout-player-goal').innerText = customWorkout.description;
    
    const list = document.getElementById('workout-exercises-list');
    list.innerHTML = '';
    
    customWorkout.exercises.forEach((ex, idx) => {
        const card = document.createElement('div');
        card.style.cssText = "background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9;";

        const videoUrl = findVideoMatch(ex.name);
        const prevData = findPreviousSetData(ex.name);

        card.innerHTML = `
            <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="font-weight: 700; font-size: 1.05rem; margin-bottom: 5px;">${ex.name}</div>
                <div style="color: var(--text-muted); font-size: 0.85rem;">Custom Exercise</div>
                ${prevData ? `<div style="color: var(--primary); font-size: 0.75rem; margin-top: 5px;">Last: ${prevData}</div>` : ''}
            </div>

            ${videoUrl ? `
            <div data-video-container style="position: relative; width: 100%; padding-top: 56.25%; background: black; cursor: pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: var(--primary); margin-left: 3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div>
            </div>

            <div class="sets-list-container">
                ${Array.from({length: ex.sets}, (_, setIdx) => `
                    <div class="workout-set-row" style="display: grid; grid-template-columns: 40px 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 10px 15px; border-top: 1px solid #f8fafc;">
                        <div style="font-weight: 800; color: #94a3b8; font-size: 0.85rem; text-align: center;">${setIdx + 1}</div>
                        <input type="text" class="input-time" placeholder="-" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="time" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                        <input type="text" class="input-reps" placeholder="Reps" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="reps" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                        <input type="text" class="input-kg" placeholder="Kg" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="weight" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                    </div>
                `).join('')}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${ex.name.replace(/'/g, "\\'")}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>
        `;
        list.appendChild(card);
    });

    hideAllAppViews();
    document.getElementById('view-active-workout').style.display = 'block';
    startWorkoutTimer();

    // Push navigation state for Android back button
    pushNavigationState('view-active-workout', () => quitWorkout());
}
</script>

<!-- WORKOUT OVERVIEW VIEW -->
<div id="view-workout-overview" class="app-view" style="display:none; height: 100vh; background: white; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;">
        <div style="width: 40px;"></div>
        <div id="overview-header-title" style="font-weight: 700; color: var(--text-main);">Workout Overview</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 20px;">
        <div id="overview-hero-card" style="border-radius: 20px; overflow: hidden; margin-bottom: 25px; position: relative; height: 200px; background: #f1f5f9;">
            <img id="overview-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);"></div>
            <div style="position: absolute; bottom: 20px; left: 20px; color: white;">
                <h1 id="overview-title" style="margin: 0; font-size: 1.8rem;">Workout Name</h1>
                <div id="overview-meta" style="opacity: 0.9; font-size: 0.9rem;">22 mins  6 Exercises</div>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.1rem;">Equipment Needed</h3>
            <div id="overview-equipment" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <!-- Equipment Badges -->
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.1rem;">Instructions</h3>
            <p id="overview-instructions" style="color: var(--text-muted); line-height: 1.5; font-size: 0.95rem;"></p>
        </div>

        <div>
            <h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">Exercise List</h3>
            <div id="overview-exercise-list">
                <!-- Exercises List -->
            </div>
        </div>
        
        <div style="height: 100px;"></div>
    </div>


</div>

<!-- ACTIVE WORKOUT PLAYER VIEW -->
<div id="view-active-workout" class="app-view" style="display:none; height: 100vh; background: #f8fafc; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    
    <!-- Top Nav Bar -->
    <div style="position: sticky; top: 0; z-index: 100; background: black; color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;">
        <div onclick="quitWorkout()" style="font-weight: 600; cursor: pointer; color: #FF4444; padding: 10px; touch-action: manipulation; user-select: none;">Cancel</div>
        <div style="text-align: center;">
            <div id="workout-timer" style="font-family: monospace; font-size: 1.2rem; font-weight: 700; color: white;">00:00</div>
        </div>
        <div onclick="finishWorkout()" style="font-weight: 600; cursor: pointer; color: #44FF44; padding: 10px; touch-action: manipulation; user-select: none;">Save</div>
    </div>

    <div style="padding: 15px; padding-bottom: 120px;">
        <h1 id="workout-player-title" style="margin: 0 0 5px 0; font-size: 1.3rem; line-height: 1.2;">Workout Title</h1>
        <p id="workout-player-goal" style="font-size: 0.85rem; color: var(--text-muted); margin: 0 0 20px 0; line-height: 1.4;"></p>

        <div id="workout-exercises-list">
            <!-- Dynamic Content Injected Here via JS -->
        </div>

        <!-- Add Exercise Button -->
        <div style="margin-top: 20px; padding-bottom: 40px;">
            <button onclick="openAddExerciseModal()" style="width: 100%; background: transparent; border: 2px dashed var(--primary); color: var(--primary); font-weight: 700; font-size: 0.95rem; padding: 18px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Add Exercise
            </button>
        </div>
    </div>
</div>

</div>

<!-- ADD EXERCISE MODAL -->
<div id="add-exercise-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 600; overflow-y: auto;">
    <div style="background: white; min-height: 100%; max-width: 600px; margin: 0 auto; position: relative;">
        <!-- Modal Header -->
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div onclick="closeAddExerciseModal()" style="font-weight: 600; cursor: pointer; color: var(--text-muted); padding: 10px;">Cancel</div>
            <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Add Exercise</div>
            <div style="width: 60px;"></div>
        </div>

        <!-- Search Box -->
        <div style="padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
            <input type="text" id="add-exercise-search" placeholder="Search exercises..." oninput="searchExercisesForAdd(this.value)" style="width: 100%; padding: 12px 15px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; background: white;">
        </div>

        <!-- Exercise Results -->
        <div id="add-exercise-results" style="padding: 15px 20px; padding-bottom: 100px;">
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                Type to search for exercises from your library
            </div>
        </div>
    </div>
</div>


<!-- WORKOUT SUCCESS VIEW -->
<div id="view-workout-success" class="app-view" style="display:none; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 500; background: var(--primary); color: white; overflow-y: auto;">
    <div style="padding: 40px 20px; text-align: center; max-width: 600px; margin: 0 auto;">

        <div style="font-size: 5rem; margin-bottom: 20px;">🙌</div>

        <h1 style="font-family: 'Playfair Display'; font-size: 2.5rem; margin: 0; color: white;">High Five!</h1>
        <p style="font-size: 1.2rem; opacity: 0.9; margin-top: 10px;">Workout Completed</p>

        <!-- Milestones Container -->
        <div id="success-milestones" style="display: none; margin: 30px 0;"></div>

        <!-- Duration -->
        <div style="margin: 30px 0; background: rgba(255,255,255,0.1); padding: 20px 40px; border-radius: 16px; backdrop-filter: blur(10px);">
            <div style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Duration</div>
            <div id="success-duration" style="font-size: 3rem; font-weight: 700; font-family: monospace;">00:00</div>
        </div>

        <!-- Workout Count -->
        <div id="success-workout-count-container" style="display: none; margin: 20px 0; background: rgba(255,255,255,0.1); padding: 15px 30px; border-radius: 16px;">
            <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Total Workouts</div>
            <div id="success-workout-count" style="font-size: 2rem; font-weight: 700; margin-top: 5px;">0</div>
        </div>

        <!-- Improvements Container -->
        <div id="success-improvements" style="display: none; margin: 30px 0; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 16px;"></div>

        <p style="max-width: 300px; margin: 30px auto 40px; line-height: 1.6; opacity: 0.9;">Great job signaling safety to your body. Your cortisol levels are thanking you.</p>

        <!-- Workout Photo Section -->
        <div id="workout-photo-section" style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 16px; margin-bottom: 30px; backdrop-filter: blur(10px);">
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 10px;">Earn a Point!</div>
            <p style="font-size: 0.9rem; opacity: 0.85; margin-bottom: 15px;">Post a workout photo to verify and earn your point</p>
            <label for="workout-photo-input" style="display: inline-block; background: white; color: var(--primary); padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                Post Workout Photo
            </label>
            <input type="file" id="workout-photo-input" accept="image/*" capture="environment" style="display: none;" onchange="handleWorkoutPhotoSelect(event)">
        </div>

        <!-- Points Awarded Confirmation (shown after photo verified) -->
        <div id="workout-points-awarded" style="display: none; background: rgba(68, 255, 68, 0.2); padding: 15px 25px; border-radius: 16px; margin-bottom: 30px; border: 2px solid rgba(68, 255, 68, 0.5);">
            <div style="font-size: 1.3rem; font-weight: 700;">+1 Point Earned!</div>
            <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px;">Workout verified successfully</div>
        </div>

        <button onclick="closeSuccessScreen()" style="background: white; color: var(--primary); border: none; padding: 15px 50px; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2); margin-bottom: 40px;">
            DONE
        </button>
    </div>
</div>

<style>
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<!-- WORKOUT LIBRARY CATEGORIES VIEW -->
<div id="view-workout-library" class="app-view" style="display:none; height: 100vh; background: white; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Workout Library</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;">
            Choose your workout style and browse our complete library of professionally designed workouts.
        </p>

        <div id="library-categories-grid" style="display: grid; gap: 15px;">
            <!-- Categories will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- WORKOUT LIBRARY SUBCATEGORIES VIEW -->
<div id="view-workout-subcategories" class="app-view" style="display:none; height: 100vh; background: white; z-index: 501; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div id="subcategory-header-title" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Category</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p id="subcategory-description" style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;"></p>

        <div id="subcategories-grid" style="display: grid; gap: 15px;">
            <!-- Subcategories will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- WORKOUT LIBRARY WORKOUTS LIST VIEW -->
<div id="view-workout-list" class="app-view" style="display:none; height: 100vh; background: white; z-index: 502; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div id="workout-list-header-title" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Workouts</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p id="workout-list-description" style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;"></p>

        <div id="workouts-list" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Workouts will be dynamically inserted here -->
        </div>
    </div>
</div>

<style>
.exercise-logger-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.library-category-card {
    background: white;
    border: 2px solid #f1f5f9;
    border-radius: 16px;
    padding: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 20px;
}

.library-category-card:hover {
    border-color: var(--primary);
    background: #f0fdf4;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.library-category-icon {
    font-size: 2.5rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8fafc;
    border-radius: 12px;
}

.library-category-card:hover .library-category-icon {
    background: white;
}

.workout-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.workout-card:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transform: translateY(-1px);
}

.workout-difficulty-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.difficulty-beginner {
    background: #d1fae5;
    color: #065f46;
}

.difficulty-intermediate {
    background: #fed7aa;
    color: #9a3412;
}

.difficulty-advanced {
    background: #fecaca;
    color: #991b1b;
}
</style>



    <!-- Bottom Navigation (Moved Outside Container) -->
    <nav class="bottom-nav" style="z-index: 9999 !important; position: fixed; bottom: 0; left: 0; width: 100%;">
        <button class="nav-item active" onclick="switchAppTab('dashboard', this)">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('meals', this)">
            <svg viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>
            <span>Meals</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('movement-tab', this)">
            <svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 16.29 22 18.43 19.86 19.86 21.29 21.29 19.86l-1.43-1.43L21.29 17l-1.43-1.43L18.43 17l-3.57-3.57z"/></svg>
            <span>Movement</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('progress', this)">
            <svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
            <span>Progress</span>
        </button>
        <button class="nav-item" id="nav-cycle-btn" onclick="switchAppTab('cycle', this)">
           <svg id="nav-cycle-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.22-7.52-3.22 3.22 7.52 3.22-7.52z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
           <span id="nav-cycle-label">Cycle</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('support', this)">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
            <span>Support</span>
        </button>
     </nav>

    <!-- PROGRESS / ANALYTICS VIEW -->
    <div id="view-progress" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc;">
        <!-- Header -->
        <div style="padding: 20px 25px; background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
            <div>
                <h2 style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.5rem;">Your Progress</h2>
                <div style="font-size: 0.8rem; color: var(--text-muted);">Track your journey</div>
            </div>
            <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
        </div>

        <!-- Progress Content Container -->
        <div id="progress-content" style="padding: 0;">
            <!-- Loading State -->
            <div id="progress-loading" style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 2rem; margin-bottom: 10px;">📊</div>
                <div style="color: var(--text-muted);">Loading your progress...</div>
            </div>

            <!-- Main Content (Hidden Initially) -->
            <div id="progress-main-content" style="display: none;">

                <!-- Overview Stats Grid -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">Overview</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 10px;">
                        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 5px;" id="total-workouts-stat">-</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Total Workouts</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--secondary); margin-bottom: 5px;" id="current-streak-stat">-</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Day Streak</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 5px;" id="total-points-stat">-</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Total Points</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--secondary); margin-bottom: 5px;" id="avg-calories-stat">-</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Avg Calories</div>
                        </div>
                    </div>
                </div>

                <!-- Workout Analytics Section -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">Workout History</h3>
                    <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow);">
                        <div id="workout-history-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Milestones & Achievements Section -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">Achievements</h3>
                    <div id="milestones-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Daily Check-ins Trends Section -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">Recent Check-ins</h3>
                    <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow);">
                        <div id="checkins-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Exercise Progress Section -->
                <div style="padding: 20px 20px 30px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">Exercise Progress</h3>
                    <div id="exercise-progress-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- EXERCISE CHART MODAL -->
    <div id="exercise-chart-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="padding: 20px 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; border-radius: 20px 20px 0 0; z-index: 1;">
                <h3 id="exercise-chart-title" style="margin: 0; font-family: 'Playfair Display'; color: var(--primary); font-size: 1.3rem;">Exercise Progress</h3>
                <button onclick="closeExerciseChartModal()" style="background: transparent; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 5px; line-height: 1;">&times;</button>
            </div>

            <!-- Modal Content -->
            <div id="exercise-chart-content">
                <!-- Chart will be rendered here -->
            </div>
        </div>
    </div>

    <!-- CALENDAR / CYCLE VIEW -->
    <!-- CYCLE / HORMONE HUB VIEW -->
    <div id="view-cycle" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc;">
        <!-- Header -->
        <div style="padding: 20px 25px; background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
            <div>
                <h2 style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.5rem;">Hormone Hub</h2>
                <div style="font-size: 0.8rem; color: var(--text-muted);">Sync your life to your cycle</div>
            </div>
            <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
        </div>

        <!-- Cycle Wheel / Hero Card -->
        <div style="padding: 25px;">
            <div class="card" style="background: linear-gradient(135deg, var(--bg) 0%, var(--accent-green) 100%); border: 1px solid var(--secondary); box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1); overflow: visible;">
                <div class="card-body active" style="opacity:1; max-height:none; padding: 30px 25px; text-align: center;">

                    <!-- Phase Indicator Ring (CSS Only) -->
                    <div style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--secondary); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; position: relative; background: white; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);">
                         <!-- Dynamic progress border would go here -->
                         <div style="font-size: 2.5rem;">🌸</div>
                         <div style="position: absolute; bottom: -10px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">Day <span id="cycle-day-display">--</span></div>
                    </div>

                    <h2 id="cycle-phase-name" style="color: var(--primary); margin: 0 0 10px 0; font-family: 'Playfair Display'; font-size: 1.8rem;">Loading...</h2>
                    <p id="cycle-phase-desc" style="color: var(--text-main); font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px;">Tracking your cycle helps predict your energy.</p>
                    
                    <!-- Phase Tags -->
                    <div id="cycle-phase-tags" style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Cycle Sync Check-in Button -->
            <div id="check-in-prompt-card" onclick="openCheckInModal()" style="margin-top: 20px; background: white; border: 1px solid var(--primary); color: var(--primary); padding: 20px; border-radius: 16px; font-weight: 600; text-align: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div style="font-size: 1.5rem;">✨</div>
                <div style="text-align: left;">
                    <div style="font-size: 1.05rem; color: var(--primary);">Daily Check-in</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 400;">Unlock your daily cycle sync</div>
                </div>
                <div style="margin-left: auto; background: var(--primary); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">→</div>
            </div>
            
            <!-- Check-in Completed State (Hidden by default) -->
            <div id="check-in-completed-card" style="display: none; margin-top: 20px; background: #F0FDF4; border: 1px solid #BBF7D0; color: #166534; padding: 20px; border-radius: 16px; text-align: center;">
                <div style="font-size: 1.5rem; margin-bottom: 5px;">✅</div>
                <div style="font-weight: 700;">Cycle Sync Active!</div>
                <div style="font-size: 0.85rem; margin-top: 5px;">Your dashboard has been updated.</div>
            </div>

        </div>

        <!-- Weekly Calendar -->
        <div style="padding: 0 25px 25px 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--primary); margin: 0; font-size: 1.1rem;">Your Predictions</h3>
                <span onclick="switchAppTab('profile')" style="font-size: 0.8rem; color: var(--secondary); cursor: pointer; font-weight: 600;">Edit Dates</span>
            </div>

            <div id="weekly-calendar" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Calendar rows inserted via JS -->
            </div>
        </div>
    </div>

    <style>
        .mood-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mood-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .calendar-day-row {
            display: flex;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid #eee;
        }
        .calendar-day-row.is-today {
            border: 2px solid var(--secondary);
            background: #fffbf0;
        }
        .cal-date-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 45px;
            border-right: 1px solid #eee;
            padding-right: 15px;
        }
        .cal-day-name { font-size: 0.75em; color: #888; text-transform: uppercase; font-weight: 700; }
        .cal-day-num { font-weight: 700; font-size: 1.25em; color: var(--primary); }
        
        .cal-context {
            flex: 1;
        }
        .cal-workout-tag {
            background: var(--surface);
            color: var(--primary);
            font-size: 0.85em;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
            border: 1px solid #eee;
        }
        .cal-phase-dot {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px;
        }
        
        .cycle-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .cycle-settings input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
        }
    </style>

    <!-- PROFILE VIEW -->
    <div id="view-profile" class="app-view" style="display:none; padding-bottom: 80px;">
        <div class="app-header">
            <div class="app-logo">Your Profile</div>
            <div style="width:35px;"></div> <!-- Spacer -->
        </div>

        <div class="profile-header">
            <!-- Robust Profile Photo: Text S is background, IMG overlays it -->
            <div class="profile-photo-container" style="display:flex; align-items:center; justify-content:center; background:var(--accent-green); overflow:hidden;">
                <span id="profile-default-initial" style="font-size:3rem; font-weight:700; color:var(--primary);">S</span>
                <img src="" class="profile-photo" id="profile-photo-img" style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:50%; object-fit:cover;" onerror="this.style.opacity=0" onload="this.style.opacity=1">
                
                <label for="profile-photo-input" class="photo-edit-btn">
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:white;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </label>
                <input type="file" id="profile-photo-input" accept="image/*" style="display:none;" onchange="handlePhotoUpload(this)">
            </div>
            <h2 class="profile-name-large" id="profile-name-display">Shannon</h2>
            <div class="profile-email" id="profile-email-display">Loading...</div>
        </div>

        <!-- Basic Stats Row -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; padding: 0 25px; margin-bottom: 25px;">
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Age</div>
                <div id="profile-age-display" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">34</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Weight</div>
                <div id="profile-weight-display" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">68 kg</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Goal</div>
                <div id="profile-goal-display" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Fat Loss</div>
            </div>
        </div>

        <!-- Professional Protocol Settings -->
        <div class="settings-card" style="margin: 0 25px 25px 25px; background: white; border-radius: 16px; border: 1px solid #f1f5f9; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
            <div style="background: #f8fafc; padding: 15px 20px; border-bottom: 1px solid #e2e8f0;">
                <h3 style="margin:0; font-size: 0.95rem; color: var(--text-main); display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <span>🧬</span> Metabolic Protocol
                </h3>
            </div>
            <div style="padding: 0;">
                <!-- Hormone Type / Energy Level (gender-specific) -->
                <div class="setting-row" style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div id="profile-type-label" style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Hormone Type</div>
                        <div id="profile-type-desc" style="font-size: 0.8rem; color: var(--text-muted);">Determines your nutrition plan</div>
                    </div>
                    <div id="profile-type-display" style="font-weight: 700; color: var(--primary);">Cortisol</div>
                </div>
                
                <!-- Equipment -->
                <div class="setting-row" style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                     <div>
                        <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Equipment Access</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Filters your available workouts</div>
                    </div>
                    <div id="profile-equipment-display" style="font-weight: 700; color: var(--primary);">No Equipment</div>
                </div>

                <!-- Symptoms -->
                <div class="setting-row" style="padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                     <div>
                        <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Active Symptoms</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">From your latest check-in</div>
                    </div>
                    <div id="profile-symptoms-display" style="font-weight: 700; color: var(--primary); max-width: 50%; text-align: right; font-size: 0.9rem;">None</div>
                </div>
            </div>
        </div>

        <!-- Hidden inputs for cycle tracking (used by existing JavaScript) -->
        <input type="date" id="last-period-input-profile" style="display:none;">
        <input type="number" id="cycle-length-input-profile" value="28" style="display:none;">
        <input type="checkbox" id="no-period-toggle-profile" style="display:none;">

        <div style="text-align:center; margin-top:20px;">
            <button id="btn-edit-profile" onclick="toggleProfileEditMode()" style="background:#f1f5f9; color:var(--text-main); border:none; padding:10px 24px; border-radius:30px; font-weight:600; font-size:0.9rem; cursor:pointer; display:inline-flex; align-items:center; gap:8px;">
                <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:currentColor;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                Edit Profile
            </button>
            <button id="btn-save-profile" onclick="saveProfileChanges()" style="background:var(--primary); color:white; border:none; padding:10px 24px; border-radius:30px; font-weight:600; font-size:0.9rem; cursor:pointer; display:none; align-items:center; gap:8px;">
                Save Changes
            </button>
        </div>

        <!-- Manual Quiz/Check-in Triggers -->
        <div style="margin-top:30px; padding:20px; background:#f8fafc; border-radius:12px;">
            <h3 style="margin:0 0 15px 0; font-size:1rem; color:var(--text-main);">Health Tools</h3>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button onclick="initOnboardingWizard()" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>🌸</span> Restart Onboarding Setup
                </button>
                <button onclick="checkDailyWellness(true)" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>☀️</span> Daily Wellness Check-in
                </button>
                <button onclick="openCycleTrackingModal()" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>🌸</span> Cycle Tracking
                </button>
            </div>
        </div>

        <!-- APP SETTINGS -->
        <h3 style="padding: 0 25px; margin-bottom: 20px; display:flex; align-items:center; gap:10px;">
            <!-- Regular Settings Gear Icon -->
            <svg id="settings-icon-gear" class="settings-icon-gear" viewBox="0 0 24 24" style="width:24px; height:24px; fill:var(--text-main);"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.73,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            <!-- Dragon Ball Icon (for DBZ themes) -->
            <img id="settings-icon-dragonball" class="settings-icon-dragonball" src="assets/dragon-ball.svg" alt="Dragon Ball" style="width:24px; height:24px; vertical-align:middle;" />
            Settings
        </h3>
        <div style="padding: 0 25px; margin-bottom: 30px;">
            <div style="background:white; border-radius:12px; border:1px solid #f1f5f9; overflow:hidden;">
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>Color Theme</div>
                     <select id="theme-selector" onchange="applyAppTheme(this.value)" style="border:1px solid #e2e8f0; padding:5px 10px; border-radius:8px; color:var(--primary); font-weight:600; outline:none; background:transparent; font-family: 'Inter', sans-serif; cursor: pointer;">
                         <option value="default" selected>Forest (Original)</option>
                         <option value="antigravity-light">Antigravity Light</option>
                         <option value="ocean">Ocean Calm</option>
                         <option value="sunset">Sunset Glow</option>
                         <option value="cycle-pink" class="female-only-theme">Cycle Harmony</option>
                         <option value="flower-garden" class="female-only-theme">Flower Garden</option>
                         <option value="monochrome">Monochrome</option>
                         <option value="dbz-warrior" class="male-only-theme">Super Saiyan</option>
                         <option value="dbz-vegeta" class="male-only-theme">Saiyan Prince</option>
                     </select>
                 </div>
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>Units</div>
                     <div style="font-size:0.9rem; font-weight:700; color:var(--primary); cursor:pointer;" onclick="alert('Units toggled (Simulation)')">Metric (kg)</div>
                 </div>
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>
                         <div>Notifications</div>
                         <div style="font-size:0.75rem; color:var(--text-muted);">Coach message alerts</div>
                     </div>
                     <label class="toggle-switch" style="display:inline-block; width:40px; height:24px; position:relative;">
                         <input type="checkbox" id="user-notifications-toggle" checked onchange="toggleUserNotifications(this.checked)">
                         <span style="position:absolute; inset:0; background:#ccc; border-radius:24px; transition:0.3s;" class="slider"></span>
                         <span style="position:absolute; top:2px; left:2px; width:20px; height:20px; background:white; border-radius:50%; transition:0.3s;" class="knob"></span>
                     </label>
                     <style> input:checked + .slider { background: var(--primary) !important; } input:checked + .slider + .knob { transform: translateX(16px); } </style>
                 </div>
                 <div style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>
                         <div>Invite a Friend</div>
                         <div style="font-size:0.75rem; color:var(--text-muted);">You both get 2 weeks free</div>
                     </div>
                     <button onclick="openShareReferralModal()" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px;">
                         <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:white;"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                         Share
                     </button>
                 </div>
                <!-- Admin Notifications (only visible to admins) -->
                <div id="admin-notifications-setting" style="padding:15px; border-top:1px solid #f1f5f9; display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div>Coach Notifications</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">Get notified when users message</div>
                        </div>
                        <button id="admin-notif-btn" onclick="toggleAdminNotifications()" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer;">
                            Enable
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div style="padding: 0 25px; margin-top: 30px;">
            <button class="btn-primary" style="width:100%; padding:15px; border-radius:12px; font-weight:700; background:var(--primary); color:white;" onclick="toggleSubscriptionMenu()">
                MANAGE SUBSCRIPTION
            </button>

            <div id="subscription-management-menu" class="subscription-menu">
                <button class="sub-action-btn" onclick="togglePauseOptions()">
                    <span>??</span> Pause Subscription
                </button>
                <div id="pause-duration-options" class="pause-options">
                    <button class="pause-btn" onclick="handlePause(1)">1 Month</button>
                    <button class="pause-btn" onclick="handlePause(2)">2 Months</button>
                    <button class="pause-btn" onclick="handlePause(3)">3 Months</button>
                </div>

                <button id="btn-cancel-sub" class="sub-action-btn cancel" onclick="handleSubscriptionAction('cancel')">
                    <span>?</span> Cancel Subscription
                </button>
                <div id="sub-status-msg" style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 10px;">
                    Managed securely via Stripe
                </div>
            </div>
        </div>

        <!-- Logout Button -->
        <div style="padding: 0 25px; margin-top: 30px; margin-bottom: 40px;">
            <button onclick="handleLogout()" style="width:100%; padding:15px; border-radius:12px; font-weight:700; background:#ef4444; color:white; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                LOG OUT
            </button>
        </div>

        </div>

    <!-- EDIT PROFILE MODAL -->

    <script>
    function toggleProfileEditMode() {
        const isEditing = document.getElementById('btn-save-profile').style.display === 'inline-flex';

        // SYMPTOMS_LIST removed - symptoms can only be updated via daily check-in

        const editMap = [
             { id: 'profile-name-display', type: 'text' },
             { id: 'profile-email-display', type: 'text' },
             { id: 'profile-age-display', type: 'text' },
             { id: 'profile-weight-display', type: 'text' },
             { id: 'profile-goal-display', type: 'text' },
             { id: 'profile-type-display', type: 'select', options: ['CORTISOL', 'ESTROGEN', 'ADRENAL'] },
             { id: 'profile-equipment-display', type: 'select', options: [['none', 'No Equipment'], ['dumbbells', 'Home / Dumbbells'], ['gym', 'Full Gym Access']] }
             // Symptoms removed - can only be updated via daily check-in
        ];
        
        if (!isEditing) {
            // Enter Edit Mode
            editMap.forEach(f => {
                const el = document.getElementById(f.id);
                if(!el) return;

                let currentVal = el.innerText;
                if(f.id === 'profile-weight-display') currentVal = currentVal.replace(' kg', '');
                // Use dataset raw for mapped values if available
                if(el.dataset.raw) currentVal = el.dataset.raw; 

                el.dataset.original = currentVal;
                
                // Parse current array if multiselect
                let currentArray = [];
                if (f.type === 'multiselect') {
                    // Start with dataset raw (array or comma string)
                     const raw = el.dataset.raw || currentVal; 
                     if (Array.isArray(raw)) currentArray = raw;
                     else if (typeof raw === 'string') currentArray = raw.split(',').map(s=>s.trim().toLowerCase());
                     else currentArray = [];
                     
                     // Handle "None" text case
                     if(currentArray.length === 1 && currentArray[0] === 'none') currentArray = [];
                }

                if (f.type === 'text') {
                     const align = f.id.includes('symptoms') ? 'right' : 'center';
                     el.innerHTML = `<input type="text" value="${currentVal}" style="width:100%; border:1px solid var(--primary); padding:4px 8px; border-radius:6px; font-family:inherit; font-size:inherit; text-align:${align}; background:white;">`;
                } else if (f.type === 'select') {
                    let opts = '';
                    f.options.forEach(opt => {
                        const val = Array.isArray(opt) ? opt[0] : opt;
                        const label = Array.isArray(opt) ? opt[1] : opt;
                        const selected = (String(val).toLowerCase() === String(currentVal).toLowerCase()) ? 'selected' : '';
                        opts += `<option value="${val}" ${selected}>${label}</option>`;
                    });
                    el.innerHTML = `<select style="width:100%; border:1px solid var(--primary); padding:4px; border-radius:6px; font-family:inherit; font-size:inherit; background:white;">${opts}</select>`;
                } else if (f.type === 'multiselect') {
                    let checks = '';
                    f.options.forEach(opt => {
                        const isChecked = currentArray.some(s => s.includes(opt.val) || s === opt.label.toLowerCase()); // Loose match
                        checks += `
                            <label style="display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid #f1f5f9; cursor:pointer;">
                                <input type="checkbox" value="${opt.val}" ${isChecked ? 'checked' : ''} style="width:18px; height:18px; accent-color:var(--primary);">
                                <span style="font-size:0.9rem; color:var(--text-main);">${opt.label}</span>
                            </label>
                        `;
                    });
                    el.innerHTML = `
                        <div class="multiselect-container" style="border:1px solid var(--primary); background:white; border-radius:8px; padding:8px 12px; max-height:200px; overflow-y:auto; text-align:left;">
                            ${checks}
                        </div>
                    `;
                }
            });
            document.getElementById('btn-save-profile').style.display = 'inline-flex';
            document.getElementById('btn-edit-profile').style.display = 'none';
        }
    }
    
    function saveProfileChanges() {
        const fields = [
            { id: 'profile-name-display', key: 'name' },
            { id: 'profile-email-display', key: 'email' },
            { id: 'profile-age-display', key: 'age' },
            { id: 'profile-weight-display', key: 'weight' },
            { id: 'profile-goal-display', key: 'goal_weight' },
            { id: 'profile-type-display', key: 'profile' },
            { id: 'profile-equipment-display', key: 'equipment_access' }
            // Symptoms removed - can only be updated via daily check-in
        ];
        
        let quizData = {};
        try { quizData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e){}
        
        fields.forEach(f => {
            const el = document.getElementById(f.id);
            if(!el) return;

            // NOTE: Symptoms handling removed - symptoms can only be updated via daily check-in

            const input = el.querySelector('input, select');
            if(input) {
                let val = input.value;
                quizData[f.key] = val;
                // Update UI Display properly
                if (f.key === 'equipment_access') {
                    const eqMap = {
                        'gym': 'Full Gym Access',
                        'dumbbells': 'Home / Dumbbells',
                        'home': 'Home / Dumbbells',  // Legacy value support
                        'none': 'No Equipment',
                        'bodyweight': 'No Equipment'  // Legacy value support
                    };
                    el.innerText = eqMap[val] || 'No Equipment';
                    el.dataset.raw = val; 
                } else {
                    el.innerText = val + (f.key === 'weight' ? ' kg' : '');
                }
            }
        });
        
        // Save to Supabase (Split Logic)
        if (window.currentUser) {
            const userColumns = ['name', 'email'];
            const coreData = {};
            const factsData = {};

            Object.keys(quizData).forEach(k => {
                if (userColumns.includes(k)) coreData[k] = quizData[k];
                else factsData[k] = quizData[k];
            });

            // 1. Core
            if (Object.keys(coreData).length > 0) {
                 dbHelpers.users.upsert(window.currentUser.id, coreData).catch(console.error);
            }

            // 2. Facts
            if (Object.keys(factsData).length > 0) {
                (async () => {
                    let existingFacts = {}; 
                    try { existingFacts = await dbHelpers.userFacts.get(window.currentUser.id); } catch(e){}
                    const currentDetails = existingFacts?.personal_details || {};
                    
                    await dbHelpers.userFacts.upsert(window.currentUser.id, {
                        personal_details: { ...currentDetails, ...factsData }
                    });
                })();
            }
            
            window.userProfile = { ...window.userProfile, ...quizData }; // Update cache
            
            // Refresh views immediately to reflect new settings
            if(typeof renderMovementView === 'function') setTimeout(renderMovementView, 100);
            if(typeof loadProfileData === 'function') loadProfileData(); // Refresh profile display logic
        }

        document.getElementById('btn-save-profile').style.display = 'none';
        document.getElementById('btn-edit-profile').style.display = 'inline-flex';
    }
    </script>

    </div> 
</div> <!-- End Main Container (Moved) -->

<script>
// PWA & Navigation Logic
document.addEventListener('DOMContentLoaded', () => {
    // 0. Chat History now loaded in consolidated auth-aware block

    // 1. Move Sections out of Meals Container
    // We want Movement and Support to be top-level app views, not sub-views of Meals
    const moveIds = ['movement-tab', 'group', 'view-support', 'sleep', 'view-active-workout', 'view-workout-success', 'view-profile'];
    const container = document.querySelector('.container');
    const bottomNav = document.querySelector('.bottom-nav');
    
    moveIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('active');
            el.classList.add('app-view'); // Treat as top level view
            el.style.display = 'none'; // Hide initially
            // Move to main container
            container.appendChild(el);
        }
    });

    // 2. Initialize (Now handled by the consolidated listener above)
    // initProgramDate(); 
    // switchAppTab('dashboard', document.querySelector('.nav-item')); // Default to Home
});

// --- DAILY CONTENT LOGIC ---
const COACHING_TIPS = [
    "Eating within 30 minutes of waking stops the morning cortisol spike. Have you had your breakfast?",
    "High cortisol blocks fat burning. Use the 'Somatic Flow' in Movement to signal safety to your body.",
    "Your biology is not your destiny. By changing your input (food/light/movement), you change your output (mood/weight/sleep).",
    "Feeling bloated? Your gut-brain axis is reset today. Sip warm lemon water to keep things moving.",
    "The 3PM slump is a blood sugar signal. Try the 'Adrenal Rescue Smoothie' instead of a third coffee.",
    "Sleep is when you shed. 70% of fat loss happens during deep REM sleep. Prioritize an early bedtime.",
    "Box breathing for 2 minutes can lower salivary cortisol by 20%. Try it before your next meal.",
    "Vitamin D3 is actually a pro-hormone. Are you taking your daily drop? It's key for mood stability.",
    "Alcohol blocks the liver's ability to detox estrogen for 24 hours. Stick to sparkling water tonight!",
    "Muscle is metabolic currency. Even the gentle resistance in our Pilates core sessions helps you burn at rest.",
    "Magnesium glycinate is the 'relaxation mineral.' Take it 1 hour before bed for deeper sleep architecture.",
    "Raw carrot salad helps bind excess estrogen. Have you had your crunch today?",
    "Caffeine on an empty stomach spikes cortisol by 50%. Always eat your P+F+F (Protein, Fat, Fiber) first.",
    "You are halfway through your 28-day reset. Your skin should be starting to glow as inflammation drops.",
    "Nature is a nervous system hack. 10 minutes of morning sunlight sets your circadian rhythm for tonight.",
    "Dandelion tea supports liver phase II detox. Perfect for this stage of the flush.",
    "Consistency over perfection. If you missed a meal, don't worry. Just make the next choice a green one.",
    "Your thyroid needs selenium. 1-2 Brazil nuts daily is all you need for this metabolic kickstart.",
    "Gut dysbiosis causes brain fog. The fermented foods in this week's plan are feeding your 'good' bugs.",
    "Hydration is not just water. Add a pinch of sea salt to your bottle to help your cells actually absorb it.",
    "Ashwagandha is an adaptogen that 'adopts' your needs. If you're wired, it calms. If you're tired, it lifts.",
    "The 'Stress Belly' is often just persistent inflammation. Notice if your waist feels looser this morning.",
    "Digital detox! Screens after 8 PM block melatonin. Read a physical book tonight instead.",
    "Omega-3s are anti-inflammatory gold. The algae-based DHA in your protocol supports brain and heart.",
    "You're in the final stretch. Your body is now efficient at using fat for fuel instead of just glucose.",
    "Lowering your core temperature by 1 degree helps you fall asleep. Try the warm-to-cool shower trick.",
    "Zinc is critical for hormone conversion. Ensure you're hitting those pumpkin seeds today.",
    "You have successfully reset your biochemistry. This is not a diet, it's a signal of safety to your body. Well done!"
];

// Male-specific coaching tips focused on performance, muscle, and recovery
const MALE_COACHING_TIPS = [
    "Protein timing matters. Hit 30-40g within 2 hours post-workout to maximize muscle protein synthesis.",
    "Sleep is your #1 anabolic hormone. 7-9 hours optimizes testosterone and growth hormone production.",
    "Progressive overload is key. Add 2.5kg to your lifts each week to keep the gains coming.",
    "Creatine is the most researched supplement. 5g daily supports strength, power, and cognitive function.",
    "Don't skip leg day. Compound movements like squats boost testosterone more than isolation exercises.",
    "Hydration affects performance. Losing just 2% body water can decrease strength by 10%.",
    "Post-workout nutrition window: Protein + carbs within 2 hours helps muscle recovery and glycogen replenishment.",
    "Cold exposure (cold showers) can boost recovery and increase brown fat activation for better body composition.",
    "Zinc and magnesium are critical for testosterone. Pumpkin seeds and dark leafy greens are your friends.",
    "Rest days are growth days. Muscles repair and grow during recovery, not during the workout itself.",
    "Caffeine 30 minutes pre-workout can increase power output by 3-5%. Time it right!",
    "Vitamin D3 acts like a steroid hormone. Get 15 min of morning sun or supplement for optimal levels.",
    "Mind-muscle connection is real. Focus on the muscle you're working for better activation and growth.",
    "Protein goal: 1.6-2.2g per kg bodyweight daily for muscle building. Track it today.",
    "Gut health affects everything. Fermented foods support nutrient absorption and reduce inflammation.",
    "Box breathing lowers cortisol. High cortisol = muscle breakdown. 4-4-4-4 breathing before bed.",
    "Omega-3s reduce muscle soreness and inflammation. Fish oil or algae-based DHA daily.",
    "Deload weeks prevent overtraining. Every 4-6 weeks, reduce volume by 40% to come back stronger.",
    "Morning sunlight sets your circadian rhythm, improving sleep quality and testosterone production.",
    "Ashwagandha is proven to increase testosterone and reduce cortisol. Consider adding it to your stack.",
    "Muscle is metabolic currency. Every kg of muscle burns 50+ extra calories at rest.",
    "Alcohol tanks testosterone for 24-72 hours. Save it for special occasions if gains are your goal.",
    "Core temperature drops help sleep. Cool room (18-20°C) optimizes recovery hormones.",
    "Consistency beats intensity. 4 solid sessions/week beats 7 mediocre ones. Quality over quantity.",
    "Time under tension matters. Control the eccentric (lowering) phase for 3-4 seconds for better gains.",
    "Pre-workout meal: Protein + complex carbs 2-3 hours before training for sustained energy.",
    "Track your lifts. What gets measured gets managed. Progressive overload requires data.",
    "You're building a performance machine. Every meal, every rep, every hour of sleep is an investment. Keep going!"
];

async function initProgramDate() {
    let startDate = null;
    try {
        const profile = await window.getUserProfile();
        startDate = profile?.program_start_date;
    } catch(e) {}

    if (!startDate) {
        startDate = localStorage.getItem('pbb_start_date');
    }

    if (!startDate) {
        startDate = new Date().toISOString();
    }

    // Always ensure localStorage is synced with the current start date
    localStorage.setItem('pbb_start_date', startDate);

    const start = new Date(startDate);
    const now = new Date();
    const diffTime = Math.abs(now - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    let currentDay = diffDays;
    if (currentDay < 1) currentDay = 1;

    updateDailyContent(currentDay);
}

function updateDailyContent(day) {
    // Use gender-appropriate coaching tips
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    const tips = isMale ? MALE_COACHING_TIPS : COACHING_TIPS;
    let tipIndex = (day - 1) % tips.length;

    const counterEl = document.getElementById('daily-progress-counter');
    if (counterEl) {
        counterEl.innerText = `Day ${day} of 28`;
        if (day > 28) counterEl.innerText = `Day ${day} (Maintenance)`;
    }

    const tipEl = document.getElementById('daily-coaching-tip');
    if (tipEl) {
        const tipLabel = isMale ? 'Performance Tip' : 'Day ' + day + ' Insight';
        tipEl.innerHTML = `<strong>${tipLabel}:</strong> ${tips[tipIndex]}`;
    }

    // Update Movement Tab Header
    const moveDate = document.getElementById('movement-today-date');
    if (moveDate) {
        moveDate.innerText = `Day ${day}`;
    }

    // --- NEW: Render Today's Meals Logic ---
    const todayContainer = document.getElementById('today-meals-content');
    if (todayContainer) {
        const weekNum = Math.ceil(day / 7);
        const dayIndex = (day - 1) % 7;
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const dayName = days[dayIndex];
        const sourceId = `week${weekNum}-${dayName}`;
        
        const sourceCard = document.getElementById(sourceId);
        
        if (sourceCard) {
            // Clone content but keep it generic/clean
            todayContainer.innerHTML = ''; // Clear loading
            const clone = sourceCard.cloneNode(true);
            
            // Adjust styling for 'Today' view if needed, or just append
            // We want it open by default
            clone.classList.add('open');
            clone.style.marginBottom = '20px';
            
            // Remove the ID to avoid duplicates in DOM
            clone.removeAttribute('id');
            
            // Fix onclick to toggle THIS clone, not the original ID
            const header = clone.querySelector('.card-header');
            if(header) header.setAttribute('onclick', 'toggleCard(this.parentElement)');
            
            todayContainer.appendChild(clone);
        } else {
            // Fallback if content not found
            todayContainer.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-muted);">
                    <p>Meals for Day ${day} (${dayName}, Week ${weekNum}) are loading...</p>
                    <button onclick="switchWeek('week${weekNum}', this)" style="margin-top:10px; padding:10px 20px; border-radius:30px; border:1px solid var(--primary); background:transparent; color:var(--primary); cursor:pointer;">View Week ${weekNum} Plan</button>
                    <!-- Debug: Looked for #${sourceId} -->
                </div>
            `;
        }
    }
}

async function syncQuizDataToDb() {
    const user = window.currentUser;
    if (!user) return;

    try {
        const quizJson = sessionStorage.getItem('userProfile');
        const hormoneType = sessionStorage.getItem('userResult');

        let quizData = {};
        if (quizJson) {
             try { quizData = JSON.parse(quizJson); } catch(e) {}
        }

        // Add hormone type if present
        if (hormoneType) {
            quizData.profile = hormoneType;
        }

        // Map 'sex' to 'user_gender' for quiz users
        // Quiz collects 'sex' field, but we need 'user_gender' for UI/localStorage
        if (quizData.sex && !quizData.user_gender) {
            quizData.user_gender = quizData.sex;
            localStorage.setItem('userGender', quizData.sex);
        }

        // NOTE: Symptom derivation from quiz REMOVED
        // Symptoms can ONLY be set via daily wellness check-in to prevent persistent stale data
        // This ensures equipment selection is respected and symptoms stay current

        if (Object.keys(quizData).length > 0) {
            console.log("Syncing quiz data to DB...", quizData);

            // SPLIT DATA: Users table vs User Facts (personal_details)
            // user_gender and equipment_access are core user attributes that should be in users table
            const userColumns = ['name', 'email', 'profile_photo', 'program_start_date', 'theme_preference', 'location', 'user_gender', 'equipment_access'];
            const coreData = {};
            const factsData = {};

            Object.keys(quizData).forEach(k => {
                if (userColumns.includes(k)) coreData[k] = quizData[k];
                else factsData[k] = quizData[k];
            });

            // 1. Update Core User Data
            if (Object.keys(coreData).length > 0) {
                await dbHelpers.users.upsert(user.id, coreData);
            }

            // 2. Update Extension Data (User Facts)
            if (Object.keys(factsData).length > 0) {
                // Get existing facts first to merge
                let existingFacts = {};
                try { existingFacts = await dbHelpers.userFacts.get(user.id); } catch(e){}

                const currentDetails = existingFacts?.personal_details || {};

                await dbHelpers.userFacts.upsert(user.id, {
                    personal_details: { ...currentDetails, ...factsData }
                });
            }

            // 3. Calculate and Save Nutrition Goals if we have the required data
            if (quizData.age && quizData.height && quizData.weight && quizData.goal_weight && quizData.activity_level && quizData.goalBodyType) {
                try {
                    // Convert quiz data to metric units
                    const metricData = convertQuizDataToMetric(quizData);

                    // Calculate nutrition goals
                    const nutritionGoals = calculateNutritionGoals(metricData);

                    if (nutritionGoals) {
                        console.log("Calculated nutrition goals:", nutritionGoals);

                        // Save to quiz_results table
                        const quizResultData = {
                            menopause_status: quizData.menopause_status,
                            cycle_description: quizData.cycle_desc,
                            activity_level: quizData.activity_level,
                            weight_storage_location: quizData.weight_gain_location,
                            goal_body_type: quizData.goalBodyType,
                            sleep_hours: quizData.sleep_hours,
                            sleep_quality: quizData.wake_feel,
                            energy_level: quizData.energy_level || quizData.energy_status, // Support both field names
                            energy_crashes: quizData.midday_crash,
                            caffeine_relationship: quizData.caffeine,
                            hormone_profile: hormoneType,
                            equipment_access: quizData.equipment_access, // Include equipment selection
                            age: metricData.age,
                            height: metricData.height,
                            weight: metricData.weight,
                            goal_weight: metricData.goal_weight,
                            sex: metricData.sex,
                            bmr: nutritionGoals.bmr,
                            tdee: nutritionGoals.tdee,
                            calorie_goal: nutritionGoals.calorie_goal,
                            protein_goal_g: nutritionGoals.protein_goal_g,
                            carbs_goal_g: nutritionGoals.carbs_goal_g,
                            fat_goal_g: nutritionGoals.fat_goal_g
                        };

                        await dbHelpers.quizResults.create(user.id, quizResultData);
                        console.log("Quiz results with nutrition goals saved to database");

                        // Update daily_nutrition goals for today
                        const today = new Date().toISOString().split('T')[0];
                        await dbHelpers.nutrition.updateGoals(user.id, today, {
                            calorie_goal: nutritionGoals.calorie_goal,
                            protein_goal_g: nutritionGoals.protein_goal_g,
                            carbs_goal_g: nutritionGoals.carbs_goal_g,
                            fat_goal_g: nutritionGoals.fat_goal_g
                        });
                        console.log("Daily nutrition goals updated");

                        // CRITICAL FIX: Save sex to users table so it persists on page reload
                        // This fixes the bug where gender resets to female on refresh
                        await dbHelpers.users.update(user.id, {
                            sex: metricData.sex
                        });
                        console.log("User sex field saved to users table:", metricData.sex);
                    }
                } catch (nutritionError) {
                    console.error("Failed to calculate/save nutrition goals:", nutritionError);
                }
            }

            // Update local cache
            window.userProfile = { ...window.userProfile, ...quizData };
            console.log("Quiz data synced successfully");
        }
    } catch (e) {
        console.error("Failed to sync quiz data:", e);
    }
}

async function handleLogout() {
    if (confirm('Are you sure you want to log out?')) {
        try {
            await authHelpers.signOut();
            // Clear any cached data
            sessionStorage.clear();
            localStorage.removeItem('userProfile');
            localStorage.removeItem('userGender'); // Clear gender on logout
            localStorage.removeItem('onboardingComplete'); // Reset onboarding status
            window.location.href = '/login.html';
        } catch (error) {
            console.error('Logout failed:', error);
            alert('Failed to log out. Please try again.');
        }
    }
}

async function loadProfileData() {
    let profile = null;
    let quizResult = null;

    try {
        profile = await window.getUserProfile();
    } catch (e) {
        console.warn("Profile fetching error", e);
    }

    // Also fetch quiz results for equipment_access and energy_level
    try {
        if (window.currentUser?.id && typeof dbHelpers !== 'undefined') {
            quizResult = await dbHelpers.quizResults.getLatest(window.currentUser.id);
        }
    } catch (e) {
        console.warn("Quiz results fetching error", e);
    }

    // Merge quiz results into profile for easy access
    if (quizResult) {
        profile = { ...profile, ...quizResult };
    }

    // Fallback if DB fetch fail
    if (!profile) {
        try {
            profile = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
        } catch(e) {}
    }

    const context = {
        name: profile?.name || window.currentUser?.user_metadata?.full_name || "Shannon",
        email: profile?.email || window.currentUser?.email || "shannon@example.com",
        age: profile?.age || "34",
        weight: profile?.weight || "68 kg",
        goal: profile?.goal_weight || profile?.goal || "Fat Loss",
        profile: profile?.profile || (sessionStorage.getItem('userResult') || 'Cortisol').toUpperCase(),
        energy_level: profile?.energy_level || 'normal'
    };

    // Store energy_level globally for gender-specific UI
    window.userEnergyLevel = context.energy_level;

    // NOTE: Symptoms are NO LONGER loaded from profile
    // Symptoms now ONLY come from daily check-ins to prevent stale data from affecting recommendations

    if(document.getElementById('profile-name-display')) document.getElementById('profile-name-display').innerText = context.name;
    if(document.getElementById('profile-email-display')) document.getElementById('profile-email-display').innerText = context.email;
    if(document.getElementById('profile-age-display')) document.getElementById('profile-age-display').innerText = context.age;
    
    const wStr = String(context.weight).toLowerCase();
    const weightDisplay = wStr.includes('k') || wStr.includes('l') 
        ? context.weight 
        : context.weight + " kg";

    if(document.getElementById('profile-weight-display')) document.getElementById('profile-weight-display').innerText = weightDisplay;
    if(document.getElementById('profile-goal-display')) document.getElementById('profile-goal-display').innerText = context.goal;
    
    // Updated Protocol Fields
    if(document.getElementById('profile-type-display')) document.getElementById('profile-type-display').innerText = context.profile;
    
    const equipment = profile?.equipment_access || 'none';
    const eqMap = {
        'gym': 'Full Gym Access',
        'dumbbells': 'Home / Dumbbells',
        'home': 'Home / Dumbbells',  // Legacy value support
        'none': 'No Equipment',
        'bodyweight': 'No Equipment'  // Legacy value support
    };
    const eqDisplay = document.getElementById('profile-equipment-display');
    if(eqDisplay) {
        eqDisplay.innerText = eqMap[equipment] || 'No Equipment';
        eqDisplay.dataset.raw = equipment; // Store raw value for edit mode mapping
    }

    // Display symptoms from latest check-in (NOT from profile)
    // Symptoms can only be updated via daily wellness check-in
    let symptomsText = 'None';

    // Look for most recent check-in with symptoms
    if (userCycleData.logs && Object.keys(userCycleData.logs).length > 0) {
        // Get all dates sorted descending (most recent first)
        const dates = Object.keys(userCycleData.logs).sort().reverse();

        // Find the most recent check-in that has symptoms
        for (const date of dates) {
            const log = userCycleData.logs[date];
            if (log.symptoms && Array.isArray(log.symptoms) && log.symptoms.length > 0) {
                symptomsText = log.symptoms.map(s =>
                    s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
                ).join(', ');
                break;
            }
        }
    }

    if(document.getElementById('profile-symptoms-display')) {
        document.getElementById('profile-symptoms-display').innerText = symptomsText;
    }

    // Load saved avatar if exists
    const savedPhoto = localStorage.getItem('profile_photo');
    if(savedPhoto) {
        const mainImg = document.getElementById('profile-photo-img');
        if(mainImg) mainImg.src = savedPhoto;
        document.querySelectorAll('.profile-icon').forEach(el => {
            el.innerHTML = `<img src="${savedPhoto}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
            el.style.background = 'transparent';
        });
    }

    // CRITICAL: Always sync gender from database to localStorage
    // Database is the source of truth - always overwrite localStorage
    // This fixes the bug where localStorage has wrong gender value
    // Check both user_gender (from users table) and sex (from quiz_results table)
    const genderFromDb = profile?.user_gender || profile?.sex;
    if (genderFromDb) {
        const currentLocalGender = localStorage.getItem('userGender');
        if (currentLocalGender !== genderFromDb) {
            console.log("Gender mismatch detected - DB:", genderFromDb, "localStorage:", currentLocalGender);
        }
        localStorage.setItem('userGender', genderFromDb);
        console.log("Synced gender from DB to localStorage:", genderFromDb);
    }

    // CRITICAL: Restore theme preference from database to localStorage
    // This ensures theme persists even when cache is cleared
    if (profile?.theme_preference && !localStorage.getItem('userThemePreference')) {
        localStorage.setItem('userThemePreference', profile.theme_preference);
        console.log("Restored theme preference from DB to localStorage:", profile.theme_preference);
    }

    // CRITICAL FIX: Restore sex field to sessionStorage for nutrition calculations
    // This fixes the bug where gender resets to female on page refresh
    if (profile?.sex) {
        const currentProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
        currentProfile.sex = profile.sex;
        sessionStorage.setItem('userProfile', JSON.stringify(currentProfile));
        console.log("Restored sex from DB to sessionStorage:", profile.sex);
    }

    // ALWAYS apply gender-specific UI after profile loads
    // This uses localStorage (which may have been set during onboarding or restored from DB above)
    if (typeof applyGenderTheme === 'function') {
        applyGenderTheme();
    }
    if (typeof applyGenderSpecificUI === 'function') {
        applyGenderSpecificUI();
    }
    // Update settings icon to show Dragon Ball for DBZ themes
    if (typeof updateSettingsIcon === 'function') {
        updateSettingsIcon();
    }
    // Re-render cycle status with correct gender
    if (typeof renderCycleStatus === 'function') {
        renderCycleStatus();
    }

    // Load today's check-in from Supabase to sync localStorage
    if (window.currentUser && typeof dbHelpers !== 'undefined') {
        try {
            const today = new Date().toISOString().split('T')[0];
            const todayCheckin = await dbHelpers.checkins.get(window.currentUser.id, today);
            if (todayCheckin) {
                // User has already checked in today - mark localStorage
                localStorage.setItem('lastWellnessCheck', new Date().toDateString());
                console.log('✅ Today\'s check-in found in DB');

                // Update symptoms display from check-in data
                const additionalData = todayCheckin.additional_data || {};
                const checkInSymptoms = additionalData.symptoms || [];
                if (checkInSymptoms.length > 0) {
                    const symptomsEl = document.getElementById('profile-symptoms-display');
                    if (symptomsEl) {
                        const formattedSymptoms = checkInSymptoms.map(s =>
                            s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
                        ).join(', ');
                        symptomsEl.textContent = formattedSymptoms;
                    }
                }
            }
        } catch (e) {
            console.warn('Could not check today\'s check-in status:', e);
        }
    }
}

function handlePhotoUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            input.value = '';
            return;
        }

        // Show loading state
        const mainImg = document.getElementById('profile-photo-img');
        if (mainImg) mainImg.style.opacity = '0.5';

        // Resize image to prevent localStorage overflow (max 500KB)
        resizeImageFile(file, 400, 0.8).then(photoData => {
            // Update main profile photo
            if (mainImg) {
                mainImg.src = photoData;
                mainImg.style.opacity = '1';
            }

            // Save to localStorage
            try {
                localStorage.setItem('profile_photo', photoData);
            } catch (e) {
                console.error('Failed to save photo to localStorage:', e);
            }

            // Update all small icons
            document.querySelectorAll('.profile-icon').forEach(el => {
                el.innerHTML = `<img src="${photoData}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                el.style.background = 'transparent';
            });

            // Reset input to allow re-selecting the same file
            input.value = '';
        }).catch(err => {
            console.error('Failed to process image:', err);
            alert('Failed to process image. Please try a different photo.');
            if (mainImg) mainImg.style.opacity = '1';
            input.value = '';
        });
    }
}

// Helper function to resize image before storing
function resizeImageFile(file, maxSize, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Scale down if larger than maxSize
                if (width > height && width > maxSize) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                } else if (height > maxSize) {
                    width = (width * maxSize) / height;
                    height = maxSize;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = function() {
                reject(new Error('Failed to load image'));
            };
            img.src = e.target.result;
        };
        reader.onerror = function() {
            reject(new Error('Failed to read file'));
        };
        reader.readAsDataURL(file);
    });
}

function connectApp(appName) {
    const btn = event.target;
    btn.innerText = "Connecting...";
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerText = "Connected";
        btn.classList.add('connected');
        alert(`${appName} connected successfully! (Simulation)`);
    }, 1500);
}

function toggleSubscriptionMenu() {
    const menu = document.getElementById('subscription-management-menu');
    menu.classList.toggle('active');
}

function togglePauseOptions() {
    const opts = document.getElementById('pause-duration-options');
    opts.classList.toggle('active');
}

async function handlePause(months) {
    if (!confirm(`Pause your subscription for ${months} month(s)? Your access will resume automatically.`)) return;

    const msgEl = document.getElementById('sub-status-msg');
    msgEl.innerText = "Processing pause request...";
    
    try {
        const email = window.currentUser?.email || sessionStorage.getItem('userEmail') || "user@example.com"; 
        
        const response = await fetch('/.netlify/functions/pause-subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, durationMonths: months })
        });

        const data = await response.json();

        if (response.ok) {
            msgEl.innerText = `? Paused for ${months} months.`;
            msgEl.style.color = "var(--primary)";
            alert(data.message);
            togglePauseOptions(); // Hide options
        } else {
            throw new Error(data.error || "Pause failed");
        }
    } catch (err) {
        console.error(err);
        msgEl.innerText = "Error pausing subscription.";
        msgEl.style.color = "red";
        alert("Error: " + err.message);
    }
}

async function handleSubscriptionAction(action) {
    if (action === 'cancel') {
        if (!confirm("Are you sure you want to cancel? You will lose access to new content at the end of your billing cycle.")) {
            return;
        }

        const btn = document.getElementById('btn-cancel-sub');
        const originalText = btn.innerHTML;
        btn.innerHTML = "Processing...";
        btn.disabled = true;

        try {
            const email = window.currentUser?.email || sessionStorage.getItem('userEmail') || "user@example.com"; // Fallback for dev
            
            const response = await fetch('/.netlify/functions/cancel-subscription', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            });

            const data = await response.json();

            if (response.ok) {
                btn.innerHTML = "<span>?</span> Cancelled";
                btn.classList.remove('cancel');
                document.getElementById('sub-status-msg').innerText = "Subscription cancelled. Access remains until period end.";
                document.getElementById('sub-status-msg').style.color = "var(--primary)";
                alert(data.message);
            } else {
                throw new Error(data.error || "Cancellation failed");
            }

        } catch (err) {
            console.error(err);
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert("Error cancelling subscription: " + err.message + ". Please try again or contact support.");
        }
    }
}



function switchAppTab(tabName, btn) {
    // 1. Update Bottom Nav UI
    document.querySelectorAll('.bottom-nav .nav-item').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else {
        // simple fallback
    }

    // 1.5. Restore bottom navigation visibility for normal tabs
    document.querySelector('.bottom-nav').style.display = 'flex';

    // 1.6. Clear Android navigation stack when switching to main tabs
    if (typeof clearNavigationStack === 'function') {
        clearNavigationStack();
    }

    // 2. Clear All Views
    hideAllAppViews();

    // 3. Show Target View
    if (tabName === 'dashboard') {
        document.getElementById('view-dashboard').style.display = 'block';
    } else if (tabName === 'meals') {
        document.getElementById('view-meals').style.display = 'block';
        if (!document.querySelector('#meals-content-container .view-section.active')) {
            switchWeek('today');
        } else if (document.getElementById('today').classList.contains('active')) {
            renderTodayMeals(); // Refresh today view if active
        }
    } else if (tabName === 'movement-tab') {
        const el = document.getElementById('movement-tab');
        if(el) { 
            el.classList.add('active'); 
            el.style.display='block'; 
            renderMovementView();
            
            // Auto-Check-in Logic (Once per day)
            const todayStr = new Date().toDateString();
            const lastAuto = localStorage.getItem('last_auto_checkin_date');
            
            // Auto check-in disabled per user request
            // if (lastAuto !== todayStr) { ... }
        }
    } else if (tabName === 'support') {
        const el = document.getElementById('view-support'); // Default to Coach/Chat logic
        if(el) {
            el.classList.add('active');
            el.style.display='block';
            // Scroll chat to bottom after a short delay
            setTimeout(() => {
                scrollToBottomOfChat();
            }, 100);
        }
    } else if (tabName === 'profile') {
        const el = document.getElementById('view-profile');
        if(el) {
            el.classList.add('active');
            el.style.display='block';
            // Decouple data loading so errors don't stop view from showing
            setTimeout(loadProfileData, 10);
            // Update settings icon when profile view is shown
            if (typeof updateSettingsIcon === 'function') {
                setTimeout(updateSettingsIcon, 100);
            }
        }
    } else if (tabName === 'progress') {
        const el = document.getElementById('view-progress');
        if(el) {
            el.style.display = 'block';
            if(typeof initProgressView === 'function') initProgressView();
        }
    } else if (tabName === 'cycle') {
        const el = document.getElementById('view-cycle');
        if(el) {
            el.style.display = 'block';
            if(typeof initCycleView === 'function') initCycleView();
        }
    }
    
    // Trigger Cycle Sync Check if entering Dashboard
    if(tabName === 'dashboard' && typeof checkAndRenderCycleSync === 'function') {
        checkAndRenderCycleSync();
    }
    
    window.scrollTo(0,0);
}

// --- CALENDAR & CYCLE LOGIC ---
const PHASE_INFO = {
    menstrual: { name: 'Menstrual Phase', color: '#E57373', css: 'phase-menstrual', rec: 'Rest, Walking, Yin Yoga', icon: '🩸' },
    follicular: { name: 'Follicular Phase', color: '#F06292', css: 'phase-follicular', rec: 'HIIT, Strength, Cardio', icon: '⚡' },
    ovulation: { name: 'Ovulation Phase', color: '#BA68C8', css: 'phase-ovulation', rec: 'Max Effort, PB Attempts', icon: '🥚' },
    luteal: { name: 'Luteal Phase', color: '#FFB74D', css: 'phase-luteal', rec: 'Strength (Mod), Pilates', icon: '🌙' },
    wellness: { name: 'Wellness Cycle', color: '#4DB6AC', css: 'phase-follicular', rec: 'Balanced Activity / Strength', icon: '🌿' },
    performance: { name: 'Performance Mode', color: '#3b82f6', css: 'phase-performance', rec: 'Strength, HIIT, Progressive Overload', icon: '💪' }
};

let userCycleData = {
    lastPeriod: null, 
    cycleLength: 28,
    mood: null, // 'strong' or 'tired'
    noPeriodMode: false,
    symptoms: [],
    logs: {}, // { "YYYY-MM-DD": { flow, symptoms:[], mood, energy } }
    dailyCheckIn: null // { date: "YYYY-MM-DD", status: "completed" }
};

function setCycleMood(mood, btn) {
    userCycleData.mood = mood;
    // UI Update
    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // Re-render suggestions
    renderCycleStatus();
    renderWeeklyCalendar();
}

function toggleNoPeriodMode() {
    const isChecked = document.getElementById('no-period-toggle-profile').checked;
    userCycleData.noPeriodMode = isChecked;

    const inputContainer = document.getElementById('last-period-input-profile');
    if(inputContainer) inputContainer.disabled = isChecked;

    updateCycleData();
}

async function initCalendarView() {
    // 1. Try to load from localStorage first (works for non-logged-in users)
    try {
        const savedCycleData = localStorage.getItem('userCycleData');
        if (savedCycleData) {
            const parsed = JSON.parse(savedCycleData);
            if (parsed.lastPeriod) {
                userCycleData.lastPeriod = parsed.lastPeriod;
                const lastPeriodInput = document.getElementById('last-period-input-profile');
                if (lastPeriodInput) lastPeriodInput.value = userCycleData.lastPeriod;
            }
            if (parsed.cycleLength) {
                userCycleData.cycleLength = parseInt(parsed.cycleLength);
                const cycleLengthInput = document.getElementById('cycle-length-input-profile');
                if (cycleLengthInput) cycleLengthInput.value = userCycleData.cycleLength;
            }
            if (parsed.noPeriodMode) {
                userCycleData.noPeriodMode = true;
                const noPeriodToggle = document.getElementById('no-period-toggle-profile');
                if (noPeriodToggle) noPeriodToggle.checked = true;
                const lastPeriodInput = document.getElementById('last-period-input-profile');
                if (lastPeriodInput) lastPeriodInput.disabled = true;
            }
            // Load logs for Cycle Sync
            if (parsed.logs) {
                userCycleData.logs = parsed.logs;
            }
        }
    } catch (e) {
        console.log("Error loading cycle data from localStorage", e);
    }

    // 2. Fetch Cycle Data from DB (user_facts) - overrides localStorage if logged in
    if (window.currentUser) {
        try {
            const userId = window.currentUser.id || window.currentUser.user_id;
            const facts = await dbHelpers.userFacts.get(userId);
            if (facts && facts.additional_data) {
                if (facts.additional_data.last_period_start) {
                    userCycleData.lastPeriod = facts.additional_data.last_period_start;
                    const lastPeriodInput = document.getElementById('last-period-input-profile');
                    if (lastPeriodInput) lastPeriodInput.value = userCycleData.lastPeriod;
                }
                if (facts.additional_data.cycle_length) {
                    userCycleData.cycleLength = parseInt(facts.additional_data.cycle_length);
                    const cycleLengthInput = document.getElementById('cycle-length-input-profile');
                    if (cycleLengthInput) cycleLengthInput.value = userCycleData.cycleLength;
                }
                if (facts.additional_data.no_period_mode) {
                    userCycleData.noPeriodMode = true;
                    const noPeriodToggle = document.getElementById('no-period-toggle-profile');
                    if (noPeriodToggle) noPeriodToggle.checked = true;
                    const lastPeriodInput = document.getElementById('last-period-input-profile');
                    if (lastPeriodInput) lastPeriodInput.disabled = true;
                }
            }
        } catch (e) {
            console.log("No existing cycle data found or error fetching", e);
        }
    }

    renderCycleStatus();
    renderWeeklyCalendar();
}

async function updateCycleData() {
    const startInput = document.getElementById('last-period-input-profile').value;
    const lengthInput = document.getElementById('cycle-length-input-profile').value;
    const noPeriod = document.getElementById('no-period-toggle-profile').checked;

    userCycleData.noPeriodMode = noPeriod;

    if (!noPeriod && !startInput) return; // Wait for input if not in wellness mode

    userCycleData.lastPeriod = startInput;
    userCycleData.cycleLength = parseInt(lengthInput);

    // Always save to localStorage first (works for all users)
    localStorage.setItem('userCycleData', JSON.stringify(userCycleData));

    // Also save to DB if logged in (background, non-blocking)
    if (window.currentUser) {
        (async () => {
            try {
                const userId = window.currentUser.id || window.currentUser.user_id;
                let existingFacts = {};
                try {
                    existingFacts = await dbHelpers.userFacts.get(userId);
                } catch(err) { /* ignore not found */ }
                
                const currentAdditional = existingFacts?.additional_data || {};
                
                await dbHelpers.userFacts.upsert(userId, {
                    additional_data: {
                        ...currentAdditional,
                        last_period_start: userCycleData.lastPeriod,
                        cycle_length: userCycleData.cycleLength,
                        no_period_mode: userCycleData.noPeriodMode
                    }
                });
            } catch (e) {
                // DB save failed but localStorage worked, user data is safe
                console.warn("Cycle data saved locally. Cloud sync pending.", e.message);
            }
        })();
    }

    renderCycleStatus();
    renderWeeklyCalendar();
}

function getCyclePhase(dayOfCycle, cycleLen) {
    // For male users, always return 'performance' (no cycle tracking)
    if (typeof isMaleUser === 'function' && isMaleUser()) {
        return 'performance';
    }

    // Basic Algo
    // Day 1-5: Menstrual
    // Day 6-13: Follicular
    // Day 14: Ovulation (approx mid-cycle)
    // Day 15-End: Luteal

    // Adjust for cycle length:
    // Menstrual is usually fixed ~5
    // Luteal is usually fixed ~14 days before end.
    // Follicular varies.

    const ovulationDay = cycleLen - 14;

    if (dayOfCycle <= 5) return 'menstrual';
    if (dayOfCycle < ovulationDay) return 'follicular';
    if (dayOfCycle === ovulationDay) return 'ovulation';
    return 'luteal';
}

function renderCycleStatus() {
    // For male users, show Performance Mode (no cycle tracking)
    if (typeof isMaleUser === 'function' && isMaleUser()) {
        const phase = PHASE_INFO['performance'];
        const phaseName = document.getElementById('cycle-phase-name');
        const phaseDesc = document.getElementById('cycle-phase-desc');
        const cycleDayDisplay = document.getElementById('cycle-day-display');

        if (phaseName) {
            phaseName.innerText = phase.name;
            phaseName.style.color = phase.color;
        }
        if (cycleDayDisplay && cycleDayDisplay.parentElement) {
            cycleDayDisplay.parentElement.style.display = 'none'; // Hide day counter for males
        }
        if (phaseDesc) {
            phaseDesc.innerText = "Train based on energy and recovery. Push hard, recover smart.";
        }

        // Update recommendation
        let suggestion = phase.rec;
        const recText = document.getElementById('rec-text');
        if (recText) recText.innerText = suggestion;

        const recCard = document.getElementById('today-workout-rec');
        if (recCard) recCard.style.background = phase.color;

        return;
    }

    if (userCycleData.noPeriodMode) {
        // Wellness Mode View
        const phase = PHASE_INFO['wellness'];
        document.getElementById('cycle-phase-name').innerText = phase.name;
        document.getElementById('cycle-phase-name').style.color = phase.color;
        document.getElementById('cycle-day-display').innerText = "General Wellness";
        document.getElementById('cycle-phase-desc').innerText = "Focus on a balanced routine of Strength, Cardio, and Rest.";
        
        const iconContainer = document.getElementById('cycle-phase-icon');
        if(iconContainer) {
            iconContainer.style.background = phase.color + '40';
            iconContainer.style.color = phase.color;
            iconContainer.innerHTML = phase.icon;
        }

        let suggestion = phase.rec;
        if (userCycleData.mood === 'tired') suggestion = "Rest / Light Walking";
        else if (userCycleData.mood === 'strong') suggestion = "Strength / HIIT";

        document.getElementById('rec-text').innerText = suggestion;
        const recCard = document.getElementById('today-workout-rec');
        if(recCard) recCard.style.background = phase.color;
        
        return;
    }

    if (!userCycleData.lastPeriod) {
        document.getElementById('cycle-phase-name').innerText = "Setup Required";
        document.getElementById('cycle-day-display').innerText = "Enter details below";
        document.getElementById('cycle-phase-desc').innerText = "Enter your details above to see your cycle insights.";
        return;
    }

    const start = new Date(userCycleData.lastPeriod);
    const today = new Date();
    const msPerDay = 24 * 60 * 60 * 1000;
    const daysSinceStart = Math.floor((today - start) / msPerDay);
    
    // Handle cycle looping
    let currentDayRaw = (daysSinceStart % userCycleData.cycleLength) + 1;
    if (currentDayRaw < 1) currentDayRaw = 1; // Basic safety

    const phaseKey = getCyclePhase(currentDayRaw, userCycleData.cycleLength);
    const phase = PHASE_INFO[phaseKey];

    document.getElementById('cycle-phase-name').innerText = phase.name;
    document.getElementById('cycle-phase-name').style.color = phase.color;
    document.getElementById('cycle-day-display').innerText = `Day ${currentDayRaw} of ${userCycleData.cycleLength}`;
    
    // Icon
    const iconContainer = document.getElementById('cycle-phase-icon');
    if(iconContainer) {
        iconContainer.style.background = phase.color + '40'; // Low opacity bg
        iconContainer.style.color = phase.color;
        iconContainer.innerHTML = phase.icon;
    }

    // Description & Suggestion based on Mood
    let suggestion = phase.rec;
    if (userCycleData.mood === 'tired') {
        suggestion = "Restorative Yoga / Stretching (Listen to body)";
        if (phaseKey === 'follicular') suggestion = "Light Cardio / Walk";
    } else if (userCycleData.mood === 'strong' && phaseKey === 'menstrual') {
        suggestion = "Light Resistance / Pilates";
    }

    document.getElementById('cycle-phase-desc').innerText = `You are in ${phase.name}. Usual focus: ${phase.rec}.`;
    
    // Update Today's Rec Card (if it exists)
    const recText = document.getElementById('rec-text');
    if(recText) recText.innerText = suggestion;
    
    const recCard = document.getElementById('today-workout-rec');
    if(recCard) recCard.style.background = phase.color;
    
    // Keep dashboard in sync
    if(typeof updateDashboardWorkoutCard === 'function') updateDashboardWorkoutCard();
}

// --- CYCLE & CALENDAR ACTIONS ---

window.logPeriodStart = function() {
    const today = new Date();
    // Format YYYY-MM-DD local
    const offset = today.getTimezoneOffset();
    const local = new Date(today.getTime() - (offset*60*1000));
    const dateStr = local.toISOString().split('T')[0];
    
    userCycleData.lastPeriod = dateStr;
    localStorage.setItem('userCycleData', JSON.stringify(userCycleData));

    // Update Input if exists
    const input = document.getElementById('last-period-input-profile');
    if(input) input.value = dateStr;
    
    // Refresh Logic
    // If renderCycleStatus exists, call it.
    if(typeof renderCycleStatus === 'function') renderCycleStatus();
    renderWeeklyCalendar();
    
    // Visual Confirmation
    const btn = document.querySelector('button[onclick="logPeriodStart()"]');
    if(btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span style="color:#22c55e;">✓</span> Logged!';
        setTimeout(() => { btn.innerHTML = originalText; }, 2000);
    }
    
    // Also simulate selecting "Menstrual" mood? Or just let the cycle logic handle it.
    // Ideally we might assume they are "Tired" or "Cramps" but let's not assume.
};

function renderWeeklyCalendar() {
    const grid = document.getElementById('weekly-calendar');
    if(!grid) return;
    grid.innerHTML = '';

    // Self-healing: If variable is empty but input has value, sync it.
    const inputVal = document.getElementById('last-period-input-profile')?.value;
    if (!userCycleData.lastPeriod && inputVal) {
        userCycleData.lastPeriod = inputVal;
    }

    // Determine if we are in "Baseline" mode (no period data)
    // If no period is set, and we haven't explicitly set "noPeriodMode", we still want to show the calendar
    const isBaseline = !userCycleData.lastPeriod;

    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 is Sun, 1 is Mon
    // Calculate Monday of this week.
    const distToMon = (dayOfWeek + 6) % 7;
    const monday = new Date(today);
    monday.setDate(today.getDate() - distToMon);

    const msPerDay = 24 * 60 * 60 * 1000;
    
    // Start date for cycle calc
    const start = userCycleData.lastPeriod ? new Date(userCycleData.lastPeriod) : new Date();

    // Check High Cortisol Profile
    const profileType = (sessionStorage.getItem('userResult') || '').toUpperCase();
    const isHighCortisol = profileType.includes('CORTISOL') || profileType.includes('ADRENAL');

    // Check if user qualifies for Gym Split (Male or Female)
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
    const hasGymAccess = userProfile.equipment_access === 'gym';
    const hasHighEnergy = userProfile.energy_status === 'high';
    const useMaleGymSplit = isMale && hasGymAccess && hasHighEnergy;
    const useFemaleGymSplit = !isMale && hasGymAccess && hasHighEnergy;

    // Calculate which week we're in for 12 different 4-week programs (48 weeks total)
    function getGymSplitWeekNumber() {
        if (!useMaleGymSplit && !useFemaleGymSplit) return 1;

        let startDate = localStorage.getItem('gym_split_start_date');
        if (!startDate) {
            // First time using gym split - set start date to this week's Monday
            const today = new Date();
            const dayOfWeek = today.getDay();
            const distToMon = (dayOfWeek + 6) % 7;
            const monday = new Date(today);
            monday.setDate(today.getDate() - distToMon);
            monday.setHours(0, 0, 0, 0);
            startDate = monday.toISOString().split('T')[0];
            localStorage.setItem('gym_split_start_date', startDate);
        }

        // Calculate weeks elapsed since start
        const start = new Date(startDate);
        const now = new Date();
        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
        const weeksElapsed = Math.floor((now - start) / msPerWeek);

        // Return week number 1-48 (12 programs × 4 weeks each)
        return (weeksElapsed % 48) + 1;
    }

    const currentWeek = getGymSplitWeekNumber();

    // Helper to get the workout index based on which 4-week program we're in
    function getWorkoutIndexForWeek(numWorkouts) {
        // Calculate which 4-week program (0-11)
        // Week 1-4 = Program 0 (uses workout 1)
        // Week 5-8 = Program 1 (uses workout 2)
        // Week 9-12 = Program 2 (uses workout 3)
        // etc.
        const programNumber = Math.floor((currentWeek - 1) / 4);
        return programNumber % numWorkouts; // Cycles through available workouts
    }

    // Weekly Schedule Template - maps to WORKOUT_DB programs
    // Each day references a program and the day index within that program's schedule
    let WEEKLY_SCHEDULE;

    if (useMaleGymSplit) {
        // Male Gym Split: Chest, Back, Legs, Shoulders, Arms+Core, Active Recovery, Rest
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'gym_split', dayIndex: 0, muscleGroup: 'chest' }, // Chest
            { day: 'Tue', program: 'gym_split', dayIndex: 1, muscleGroup: 'back' }, // Back
            { day: 'Wed', program: 'gym_split', dayIndex: 2, muscleGroup: 'legs' }, // Legs
            { day: 'Thu', program: 'gym_split', dayIndex: 3, muscleGroup: 'shoulders' }, // Shoulders
            { day: 'Fri', program: 'gym_split', dayIndex: 4, muscleGroup: 'armscore' }, // Arms & Core
            { day: 'Sat', program: 'gym_split', dayIndex: 5 }, // Active Recovery
            { day: 'Sun', program: 'gym_split', dayIndex: 6 }  // Rest
        ];
    } else if (useFemaleGymSplit) {
        // Female Gym Split: Legs, Push, Arms+Core, Legs, Pull, Active Recovery, Rest
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'female_gym_split', dayIndex: 0, muscleGroup: 'legs' }, // Legs
            { day: 'Tue', program: 'female_gym_split', dayIndex: 1, muscleGroup: 'push' }, // Push
            { day: 'Wed', program: 'female_gym_split', dayIndex: 2, muscleGroup: 'armscore' }, // Arms & Core
            { day: 'Thu', program: 'female_gym_split', dayIndex: 3, muscleGroup: 'legs' }, // Legs
            { day: 'Fri', program: 'female_gym_split', dayIndex: 4, muscleGroup: 'pull' }, // Pull
            { day: 'Sat', program: 'female_gym_split', dayIndex: 5 }, // Active Recovery
            { day: 'Sun', program: 'female_gym_split', dayIndex: 6 }  // Rest
        ];
    } else {
        // Default schedule for everyone else
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'bodyweight', dayIndex: 0 }, // Lower Body Power
            { day: 'Tue', program: 'bodyweight', dayIndex: 1 }, // Upper Body Strength
            { day: 'Wed', program: 'yoga', dayIndex: 2 },       // Spinal Mobility & Detox
            { day: 'Thu', program: 'bodyweight', dayIndex: 3 }, // Full Body Conditioning
            { day: 'Fri', program: 'bodyweight', dayIndex: 4 }, // Glutes & Core Focus
            { day: 'Sat', program: 'yoga', dayIndex: 0 },       // Somatic Hormone Reset
            { day: 'Sun', program: 'yoga', dayIndex: 6 }        // Yin & Meditation (Rest)
        ];
    }

    // Helper to get workout from WORKOUT_DB or WORKOUT_LIBRARY (for gym split rotation)
    function getWorkoutForDay(dayIdx, checkDateStr) {
        // Check if there's equipment selection for this specific day
        let dayEquipment = null;
        if (checkDateStr && userCycleData.logs && userCycleData.logs[checkDateStr] && userCycleData.logs[checkDateStr].equipment) {
            dayEquipment = userCycleData.logs[checkDateStr].equipment;
        }

        let scheduleItem = WEEKLY_SCHEDULE[dayIdx];

        // Override program based on equipment selection for this day
        if (dayEquipment) {
            if (dayEquipment === 'gym' && (useMaleGymSplit || useFemaleGymSplit)) {
                // Keep gym split
                // scheduleItem stays the same
            } else if (dayEquipment === 'gym') {
                // User selected gym but doesn't qualify for split - use gym program
                scheduleItem = { ...scheduleItem, program: 'gym', dayIndex: dayIdx };
            } else if (dayEquipment === 'dumbbells') {
                scheduleItem = { ...scheduleItem, program: 'home', dayIndex: dayIdx };
            } else if (dayEquipment === 'none') {
                scheduleItem = { ...scheduleItem, program: 'bodyweight', dayIndex: dayIdx };
            }
        }

        // For gym split with muscle group, pull from WORKOUT_LIBRARY with 48-week rotation
        if ((scheduleItem.program === 'gym_split' || scheduleItem.program === 'female_gym_split') && scheduleItem.muscleGroup && typeof WORKOUT_LIBRARY !== 'undefined') {
            const muscleGroup = scheduleItem.muscleGroup;
            const gymCategory = WORKOUT_LIBRARY['gym'];

            if (gymCategory && gymCategory.subcategories && gymCategory.subcategories[muscleGroup]) {
                const workouts = gymCategory.subcategories[muscleGroup].workouts;

                // Get workout index based on current week in 48-week cycle
                const workoutIndex = getWorkoutIndexForWeek(workouts.length);
                const workout = workouts[workoutIndex];

                // Calculate which 4-week program we're in (1-12)
                const programNumber = Math.floor((currentWeek - 1) / 4) + 1;
                const weekInProgram = ((currentWeek - 1) % 4) + 1;

                if (workout) {
                    return {
                        title: workout.name,
                        programName: `Gym - Program ${programNumber}, Week ${weekInProgram}`,
                        programId: 'gym_library',
                        libraryWorkout: { category: 'gym', subcategory: muscleGroup, workoutId: workout.id },
                        exercises: workout.exercises
                    };
                }
            }
        }

        // Default: use WORKOUT_DB
        const program = window.WORKOUT_DB?.[scheduleItem.program];
        if (program && program.schedule && program.schedule[scheduleItem.dayIndex]) {
            const workout = program.schedule[scheduleItem.dayIndex];
            return {
                title: workout.title,
                programName: program.name,
                programId: scheduleItem.program,
                exercises: workout.exercises
            };
        }
        // Fallback
        return { title: scheduleItem.day + ' Workout', programName: 'General', programId: 'bodyweight', exercises: [] };
    }

    for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        
        const isToday = d.toDateString() === today.toDateString();
        
        let headerColor = '';
        let phaseDotHtml = '';
        const dayDateStr = d.toISOString().split('T')[0];
        const dayWorkout = getWorkoutForDay(i, dayDateStr);
        let workoutName = dayWorkout.title;
        let phase = PHASE_INFO.wellness; // Default
        let phaseKey = 'wellness';
        let currentDayLoop = 0;

        if (isBaseline) {
            // Baseline Mode: Just show standard workout, no phase info
            if(isToday) headerColor = PHASE_INFO.wellness.color;

        } else {
            // Cycle Mode
            const daysSinceStart = Math.floor((d - start) / msPerDay);
            // Handle negative modulo correctly
            let mod = daysSinceStart % userCycleData.cycleLength;
            if (mod < 0) mod += userCycleData.cycleLength;
            currentDayLoop = mod + 1;
            
            phaseKey = getCyclePhase(currentDayLoop, userCycleData.cycleLength);
            phase = PHASE_INFO[phaseKey];

            if(isToday) headerColor = phase.color;
        }

        // Apply Modifiers
        const isMaleCalendar = (typeof isMaleUser === 'function' && isMaleUser());

        // Check if user selected equipment in today's check-in
        let userSelectedEquipmentForThisDay = false;
        if (userCycleData.logs && userCycleData.logs[dayDateStr] && userCycleData.logs[dayDateStr].equipment) {
            userSelectedEquipmentForThisDay = true;
        }

        if (!isBaseline) {
            // 1. Phase Modifiers - swap to yoga on menstrual phase if doing strength (females only)
            // BUT respect equipment selection from check-in
            if (!isMaleCalendar && phaseKey === 'menstrual' && (dayWorkout.programId === 'bodyweight' || dayWorkout.programId === 'gym_library') && !userSelectedEquipmentForThisDay) {
                // Swap to gentle yoga ONLY if user didn't explicitly select equipment
                const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative Recovery
                if (yogaWorkout) workoutName = yogaWorkout.title;
            }
        }

        // 2. High Cortisol Safety Override - encourage yoga over HIIT
        if (isHighCortisol && (dayWorkout.programId === 'bodyweight' || dayWorkout.programId === 'gym_library')) {
            const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[0]; // Somatic Hormone Reset
            if (yogaWorkout) workoutName = yogaWorkout.title;
        }

        // 3. Daily Mood/Symptoms only apply to TODAY
        if (isToday) {
            // Swap to yoga if user reports being tired (applies to all users including males)
            if (userCycleData.mood === 'tired') {
                const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative Recovery
                if (yogaWorkout) workoutName = yogaWorkout.title;
            }
            if (userCycleData.symptoms && userCycleData.symptoms.length > 0) {
                // Hot flash and dizziness are female-specific
                if (!isMaleCalendar && (userCycleData.symptoms.includes('hot_flash') || userCycleData.symptoms.includes('dizziness'))) {
                    const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative
                    if (yogaWorkout) workoutName = yogaWorkout.title;
                } else if (userCycleData.symptoms.includes('fatigue') || userCycleData.symptoms.includes('anxiety')) {
                    // Fatigue/anxiety triggers yoga for everyone (males & females)
                    const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[6]; // Yin & Meditation
                    if (yogaWorkout) workoutName = yogaWorkout.title;
                }
            }
        }

        const row = document.createElement('div');
        row.className = `calendar-day-row ${isToday ? 'is-today' : ''}`;
        
        // Construct Phase Dot HTML
        if (isBaseline) {
             // In baseline, maybe just show "Schedule" or nothing
             phaseDotHtml = `<span class="cal-phase-dot" style="background:#cbd5e1"></span> <span style="font-size:0.8rem; color:#94a3b8;">Standard</span>`;
        } else {
             if (!userCycleData.noPeriodMode) {
                 phaseDotHtml = `<span class="cal-phase-dot" style="background:${phase.color}"></span>
                                 <span style="opacity:0.8; font-size:0.8rem;">${phase.name} (Day ${currentDayLoop})</span>`;
             } else {
                 phaseDotHtml = `<span class="cal-phase-dot" style="background:${PHASE_INFO.wellness.color}"></span> <span style="font-size:0.8rem">Balanced</span>`;
             }
        }

        row.innerHTML = `
            <div class="cal-date-box">
                <span class="cal-day-name">${WEEKLY_SCHEDULE[i].day}</span>
                <span class="cal-day-num" style="color:${isToday ? (isBaseline ? '#046A38' : headerColor) : ''}">${d.getDate()}</span>
            </div>
            <div class="cal-context" onclick="openCalendarWorkout(${i})" style="cursor: pointer;">
                <div style="font-size: 0.9em; margin-bottom: 2px;">
                    ${phaseDotHtml}
                </div>
                <div class="cal-workout-tag">${workoutName}</div>
            </div>
        `;
        grid.appendChild(row);
    }
}

window.openCalendarWorkout = function(dayIndexFromMonday) {
    // 1. Check if user qualifies for Gym Split (Male or Female)
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
    const hasGymAccess = userProfile.equipment_access === 'gym';
    const hasHighEnergy = userProfile.energy_status === 'high';
    const useMaleGymSplit = isMale && hasGymAccess && hasHighEnergy;
    const useFemaleGymSplit = !isMale && hasGymAccess && hasHighEnergy;

    // 2. Schedule Definition (Same as in renderWeeklyCalendar)
    let WEEKLY_SCHEDULE;

    if (useMaleGymSplit) {
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'gym_split', dayIndex: 0 }, // Chest
            { day: 'Tue', program: 'gym_split', dayIndex: 1 }, // Back
            { day: 'Wed', program: 'gym_split', dayIndex: 2 }, // Legs
            { day: 'Thu', program: 'gym_split', dayIndex: 3 }, // Shoulders
            { day: 'Fri', program: 'gym_split', dayIndex: 4 }, // Arms & Core
            { day: 'Sat', program: 'gym_split', dayIndex: 5 }, // Active Recovery
            { day: 'Sun', program: 'gym_split', dayIndex: 6 }  // Rest
        ];
    } else if (useFemaleGymSplit) {
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'female_gym_split', dayIndex: 0 }, // Legs
            { day: 'Tue', program: 'female_gym_split', dayIndex: 1 }, // Push
            { day: 'Wed', program: 'female_gym_split', dayIndex: 2 }, // Arms & Core
            { day: 'Thu', program: 'female_gym_split', dayIndex: 3 }, // Legs
            { day: 'Fri', program: 'female_gym_split', dayIndex: 4 }, // Pull
            { day: 'Sat', program: 'female_gym_split', dayIndex: 5 }, // Active Recovery
            { day: 'Sun', program: 'female_gym_split', dayIndex: 6 }  // Rest
        ];
    } else {
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'bodyweight', dayIndex: 0 },
            { day: 'Tue', program: 'bodyweight', dayIndex: 1 },
            { day: 'Wed', program: 'yoga', dayIndex: 2 },
            { day: 'Thu', program: 'bodyweight', dayIndex: 3 },
            { day: 'Fri', program: 'bodyweight', dayIndex: 4 },
            { day: 'Sat', program: 'yoga', dayIndex: 0 },
            { day: 'Sun', program: 'yoga', dayIndex: 6 }
        ];
    }
    
    if (dayIndexFromMonday < 0 || dayIndexFromMonday >= WEEKLY_SCHEDULE.length) return;

    // 2. Logic Setup
    const today = new Date();
    const dayOfWeek = today.getDay(); 
    const distToMon = (dayOfWeek + 6) % 7;
    const monday = new Date(today);
    monday.setDate(today.getDate() - distToMon);
    
    const targetDate = new Date(monday);
    targetDate.setDate(monday.getDate() + dayIndexFromMonday);
    
    const scheduleItem = WEEKLY_SCHEDULE[dayIndexFromMonday];
    
    // Default Workout Selection
    let programId = scheduleItem.program;
    let dayIndex = scheduleItem.dayIndex;
    
    // 3. Apply Modifiers (Cycle, Cortisol, etc.)
    const isBaseline = !userCycleData.lastPeriod;
    const profileType = (sessionStorage.getItem('userResult') || '').toUpperCase();
    const isHighCortisol = profileType.includes('CORTISOL') || profileType.includes('ADRENAL');
    
    let phaseKey = 'wellness';
    
    const isMaleWorkout = (typeof isMaleUser === 'function' && isMaleUser());

    // Skip cycle phase modifiers for males
    if (!isMaleWorkout && !isBaseline && !userCycleData.noPeriodMode) {
        const start = new Date(userCycleData.lastPeriod);
        const msPerDay = 24 * 60 * 60 * 1000;
        const daysSinceStart = Math.floor((targetDate - start) / msPerDay);
        let mod = daysSinceStart % userCycleData.cycleLength;
        if (mod < 0) mod += userCycleData.cycleLength;
        const currentCycleDay = mod + 1;

        if (typeof getCyclePhase === 'function') {
            phaseKey = getCyclePhase(currentCycleDay, userCycleData.cycleLength);
        }

        // Modifier: Menstrual -> Yoga (females only)
        if (phaseKey === 'menstrual' && programId === 'bodyweight') {
            programId = 'yoga';
            dayIndex = 3; // Restorative Recovery
        }
    }

    // Modifier: High Cortisol -> Yoga (overrides HIIT/Bodyweight/Gym)
    if (isHighCortisol && (programId === 'bodyweight' || programId === 'gym_split' || programId === 'female_gym_split')) {
        programId = 'yoga';
        dayIndex = 0; // Somatic Hormone Reset
    }

    // Modifier: Mood/Symptoms (Only applies if targetDate is TODAY)
    if (targetDate.toDateString() === today.toDateString()) {
         // Swap to yoga if user reports being tired (applies to all users including males)
         if (userCycleData.mood === 'tired') {
             programId = 'yoga';
             dayIndex = 3; // Restorative Recovery
         }
         if (userCycleData.symptoms && userCycleData.symptoms.length > 0) {
             // Hot flash and dizziness are female-specific symptoms
             if (!isMaleWorkout && (userCycleData.symptoms.includes('hot_flash') || userCycleData.symptoms.includes('dizziness'))) {
                 programId = 'yoga';
                 dayIndex = 3; // Restorative
             } else if (userCycleData.symptoms.includes('fatigue') || userCycleData.symptoms.includes('anxiety')) {
                 // Fatigue/anxiety triggers yoga for everyone (males & females)
                 programId = 'yoga';
                 dayIndex = 6; // Yin & Meditation
             }
         }
    }

    // 4. Fetch Exercises & Launch Player
    // For gym_split with muscle groups, use WORKOUT_LIBRARY with rotation
    if ((programId === 'gym_split' || programId === 'female_gym_split') && scheduleItem.muscleGroup && typeof WORKOUT_LIBRARY !== 'undefined') {
        const muscleGroup = scheduleItem.muscleGroup;
        const gymCategory = WORKOUT_LIBRARY['gym'];

        if (gymCategory && gymCategory.subcategories && gymCategory.subcategories[muscleGroup]) {
            // Calculate which week in 48-week cycle (12 programs × 4 weeks)
            let startDate = localStorage.getItem('gym_split_start_date');
            if (!startDate) {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const distToMon = (dayOfWeek + 6) % 7;
                const monday = new Date(today);
                monday.setDate(today.getDate() - distToMon);
                monday.setHours(0, 0, 0, 0);
                startDate = monday.toISOString().split('T')[0];
                localStorage.setItem('gym_split_start_date', startDate);
            }
            const start = new Date(startDate);
            const now = new Date();
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeksElapsed = Math.floor((now - start) / msPerWeek);
            const currentWeek = (weeksElapsed % 48) + 1;

            const workouts = gymCategory.subcategories[muscleGroup].workouts;
            // Calculate which 4-week program (same workout for 4 weeks)
            const programNumber = Math.floor((currentWeek - 1) / 4);
            const workoutIndex = programNumber % workouts.length;
            const workout = workouts[workoutIndex];

            if (workout && typeof startLibraryWorkout === 'function') {
                startLibraryWorkout('gym', muscleGroup, workout.id);
            } else {
                console.error("Library workout not found or player function missing");
            }
        }
    } else {
        // Default: use WORKOUT_DB
        const program = window.WORKOUT_DB?.[programId];
        if (program && program.schedule && program.schedule[dayIndex]) {
            if (typeof startActiveWorkout === 'function') {
                startActiveWorkout(programId, dayIndex);
            } else {
                console.error("Workout player function not found");
            }
        } else {
            console.log("Workout data not found for program:", programId);
        }
    }
};

// --- SHARED WORKOUT LOGIC ---
// Returns today's recommended workout based on Calendar logic (same as renderWeeklyCalendar)
function getTodaysWorkout() {
    // Check if user qualifies for Gym Split (Male or Female)
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
    const hasGymAccess = userProfile.equipment_access === 'gym';
    const hasHighEnergy = userProfile.energy_status === 'high';
    const useMaleGymSplit = isMale && hasGymAccess && hasHighEnergy;
    const useFemaleGymSplit = !isMale && hasGymAccess && hasHighEnergy;

    // Weekly Schedule Template - maps to WORKOUT_DB programs (same as calendar)
    let WEEKLY_SCHEDULE;

    if (useMaleGymSplit) {
        // Male Gym Split
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'gym_split', dayIndex: 0, icon: '💪', muscleGroup: 'chest' }, // Chest
            { day: 'Tue', program: 'gym_split', dayIndex: 1, icon: '💪', muscleGroup: 'back' }, // Back
            { day: 'Wed', program: 'gym_split', dayIndex: 2, icon: '🦵', muscleGroup: 'legs' }, // Legs
            { day: 'Thu', program: 'gym_split', dayIndex: 3, icon: '💪', muscleGroup: 'shoulders' }, // Shoulders
            { day: 'Fri', program: 'gym_split', dayIndex: 4, icon: '💪', muscleGroup: 'armscore' }, // Arms & Core
            { day: 'Sat', program: 'gym_split', dayIndex: 5, icon: '🧘‍♂️' }, // Active Recovery
            { day: 'Sun', program: 'gym_split', dayIndex: 6, icon: '💤' }  // Rest
        ];
    } else if (useFemaleGymSplit) {
        // Female Gym Split
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'female_gym_split', dayIndex: 0, icon: '🦵', muscleGroup: 'legs' }, // Legs
            { day: 'Tue', program: 'female_gym_split', dayIndex: 1, icon: '💪', muscleGroup: 'push' }, // Push
            { day: 'Wed', program: 'female_gym_split', dayIndex: 2, icon: '💪', muscleGroup: 'armscore' }, // Arms & Core
            { day: 'Thu', program: 'female_gym_split', dayIndex: 3, icon: '🦵', muscleGroup: 'legs' }, // Legs
            { day: 'Fri', program: 'female_gym_split', dayIndex: 4, icon: '💪', muscleGroup: 'pull' }, // Pull
            { day: 'Sat', program: 'female_gym_split', dayIndex: 5, icon: '🧘‍♀️' }, // Active Recovery
            { day: 'Sun', program: 'female_gym_split', dayIndex: 6, icon: '💤' }  // Rest
        ];
    } else {
        // Default schedule
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'bodyweight', dayIndex: 0, icon: '🦵' }, // Lower Body Power
            { day: 'Tue', program: 'bodyweight', dayIndex: 1, icon: '💪' }, // Upper Body Strength
            { day: 'Wed', program: 'yoga', dayIndex: 2, icon: '🧘‍♀️' },       // Spinal Mobility & Detox
            { day: 'Thu', program: 'bodyweight', dayIndex: 3, icon: '🔥' }, // Full Body Conditioning
            { day: 'Fri', program: 'bodyweight', dayIndex: 4, icon: '🍑' }, // Glutes & Core Focus
            { day: 'Sat', program: 'yoga', dayIndex: 0, icon: '🧘‍♀️' },       // Somatic Hormone Reset
            { day: 'Sun', program: 'yoga', dayIndex: 6, icon: '💤' }        // Yin & Meditation (Rest)
        ];
    }

    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 is Sun, 6 is Sat
    // Convert to Mon=0 index
    const dayIndex = (dayOfWeek + 6) % 7;
    const scheduleItem = WEEKLY_SCHEDULE[dayIndex];

    let workoutName, workoutIcon;

    // For gym_split with muscle groups, pull from WORKOUT_LIBRARY with rotation
    if ((scheduleItem.program === 'gym_split' || scheduleItem.program === 'female_gym_split') && scheduleItem.muscleGroup && typeof WORKOUT_LIBRARY !== 'undefined') {
        const muscleGroup = scheduleItem.muscleGroup;
        const gymCategory = WORKOUT_LIBRARY['gym'];

        if (gymCategory && gymCategory.subcategories && gymCategory.subcategories[muscleGroup]) {
            // Calculate which week in 48-week cycle (12 programs × 4 weeks)
            let startDate = localStorage.getItem('gym_split_start_date');
            if (!startDate) {
                const dayOfWeek = today.getDay();
                const distToMon = (dayOfWeek + 6) % 7;
                const monday = new Date(today);
                monday.setDate(today.getDate() - distToMon);
                monday.setHours(0, 0, 0, 0);
                startDate = monday.toISOString().split('T')[0];
                localStorage.setItem('gym_split_start_date', startDate);
            }
            const start = new Date(startDate);
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeksElapsed = Math.floor((today - start) / msPerWeek);
            const currentWeek = (weeksElapsed % 48) + 1;

            const workouts = gymCategory.subcategories[muscleGroup].workouts;
            // Calculate which 4-week program (same workout for 4 weeks)
            const programNumber = Math.floor((currentWeek - 1) / 4);
            const workoutIndex = programNumber % workouts.length;
            const workout = workouts[workoutIndex];

            workoutName = workout ? workout.name : scheduleItem.day + ' Workout';
            workoutIcon = scheduleItem.icon;
        } else {
            workoutName = scheduleItem.day + ' Workout';
            workoutIcon = scheduleItem.icon;
        }
    } else {
        // Default: get from WORKOUT_DB
        const program = window.WORKOUT_DB?.[scheduleItem.program];
        const workout = program?.schedule?.[scheduleItem.dayIndex];
        workoutName = workout?.title || scheduleItem.day + ' Workout';
        workoutIcon = scheduleItem.icon;
    }
    let programId = scheduleItem.program;
    let phaseInfo = null;
    let currentCycleDay = 0;
    let phaseKey = 'wellness';
    
    const isBaseline = !userCycleData.lastPeriod;
    const profileType = (sessionStorage.getItem('userResult') || '').toUpperCase();
    const isHighCortisol = profileType.includes('CORTISOL') || profileType.includes('ADRENAL');
    
    const isMaleHero = (typeof isMaleUser === 'function' && isMaleUser());

    // Calculate phase if we have period data (skip for males)
    if (!isMaleHero && !isBaseline && !userCycleData.noPeriodMode) {
        const start = new Date(userCycleData.lastPeriod);
        const msPerDay = 24 * 60 * 60 * 1000;
        const daysSinceStart = Math.floor((today - start) / msPerDay);
        let mod = daysSinceStart % userCycleData.cycleLength;
        if (mod < 0) mod += userCycleData.cycleLength;
        currentCycleDay = mod + 1;

        phaseKey = getCyclePhase(currentCycleDay, userCycleData.cycleLength);
        phaseInfo = PHASE_INFO[phaseKey];

        // Apply phase modifiers - swap to yoga on menstrual phase if doing strength (females only)
        if (phaseKey === 'menstrual' && programId === 'bodyweight') {
            const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative Recovery
            if (yogaWorkout) {
                workoutName = yogaWorkout.title;
                workoutIcon = '🧘‍♀️';
            }
        }
    }

    // For males, set performance mode
    if (isMaleHero) {
        phaseKey = 'performance';
        phaseInfo = PHASE_INFO['performance'];
    }

    // Apply High Cortisol safety override (applies to bodyweight and gym split users)
    if (isHighCortisol && (programId === 'bodyweight' || scheduleItem.program === 'gym_split' || scheduleItem.program === 'female_gym_split')) {
        const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[0]; // Somatic Hormone Reset
        if (yogaWorkout) {
            workoutName = yogaWorkout.title;
            workoutIcon = '🧘‍♀️';
        }
    }

    // Apply mood modifiers (applies to all users including males on gym split)
    if (userCycleData.mood === 'tired') {
        const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative Recovery
        if (yogaWorkout) {
            workoutName = yogaWorkout.title;
            workoutIcon = '💤';
        }
    }
    if (userCycleData.symptoms && userCycleData.symptoms.length > 0) {
        // Hot flash and dizziness are female-specific symptoms
        if (!isMaleHero && (userCycleData.symptoms.includes('hot_flash') || userCycleData.symptoms.includes('dizziness'))) {
            const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative
            if (yogaWorkout) {
                workoutName = yogaWorkout.title;
                workoutIcon = '🧘‍♀️';
            }
        } else if (userCycleData.symptoms.includes('fatigue') || userCycleData.symptoms.includes('anxiety')) {
            // Fatigue/anxiety triggers yoga for everyone (males & females, gym & bodyweight)
            const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[6]; // Yin & Meditation
            if (yogaWorkout) {
                workoutName = yogaWorkout.title;
                workoutIcon = '🧘‍♀️';
            }
        }
    }
    
    return {
        name: workoutName,
        icon: workoutIcon,
        phaseKey: phaseKey,
        phaseInfo: phaseInfo,
        cycleDay: currentCycleDay,
        dayName: WEEKLY_SCHEDULE[dayIndex].day,
        programId: programId
    };
}

// Update Dashboard workout card
function updateDashboardWorkoutCard() {
    const workout = getTodaysWorkout();
    
    const titleEl = document.getElementById('dashboard-workout-title');
    const subEl = document.getElementById('dashboard-workout-sub');
    const iconEl = document.getElementById('dashboard-workout-icon');
    
    if (titleEl) titleEl.innerText = workout.name;
    if (iconEl) iconEl.innerText = workout.icon;
    
    if (subEl) {
        if (workout.phaseInfo && workout.cycleDay > 0) {
            subEl.innerText = `${workout.phaseInfo.name} (Day ${workout.cycleDay}) →`;
        } else {
            subEl.innerText = `${workout.dayName}'s workout →`;
        }
    }
}


// --- DAILY WELLNESS CHECK-IN LOGIC ---
function checkDailyWellness(forceShow = false) {
    // Don't show if onboarding isn't complete
    const onboardingComplete = localStorage.getItem('onboardingComplete');
    if (onboardingComplete !== 'true' && !forceShow) {
        console.log("Skipping daily wellness - onboarding not complete");
        return;
    }

    // Don't show if the onboarding wizard is currently visible
    const wizardModal = document.getElementById('onboarding-wizard');
    if (wizardModal && wizardModal.style.display !== 'none') {
        console.log("Skipping daily wellness - onboarding wizard is open");
        return;
    }

    const lastCheck = localStorage.getItem('lastWellnessCheck');
    const today = new Date().toDateString();

    // Show if manually triggered (forceShow=true) OR if it hasn't been shown today
    if (forceShow || lastCheck !== today) {
        // Apply gender-specific UI before showing modal
        if (typeof applyGenderSpecificUI === 'function') {
            applyGenderSpecificUI();
        }
        // Open the detailed check-in modal
        const modal = document.getElementById('check-in-modal');
        if(modal) modal.style.display = 'flex';
    }
}

function showPersonalizationMessage() {
    // Create a temporary banner message
    const existing = document.getElementById('personalization-banner');
    if (existing) existing.remove();

    const banner = document.createElement('div');
    banner.id = 'personalization-banner';
    banner.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        z-index: 9999;
        font-weight: 600;
        font-size: 0.95rem;
        text-align: center;
        animation: slideDown 0.5s ease-out, fadeOut 0.5s ease-out 3.5s;
    `;
    banner.innerHTML = '✨ We\'ve personalized your workout and meals for today!';

    document.body.appendChild(banner);

    // Auto-remove after 4 seconds
    setTimeout(() => {
        banner.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => banner.remove(), 500);
    }, 3500);
}

// Trigger Onboarding OR Daily Check on Load
// TEMPORARILY DISABLED: These modals were causing the homepage to freeze
// Re-enable when modal functionality is fixed and ready for production
/*
document.addEventListener('DOMContentLoaded', () => {
    // Only proceed if we have a user context (simulation or real)
    const finishedOnboarding = localStorage.getItem('onboardingComplete');

    if (!finishedOnboarding) {
        // Show Wizard First
        setTimeout(initOnboardingWizard, 1000);
    } else {
        // Standard Daily Check
        setTimeout(checkDailyWellness, 1500);
    }
});
*/


function switchWeek(id, btn) {
    // Hide all internal meal sections
    document.querySelectorAll('#meals-content-container .view-section').forEach(el => el.classList.remove('active'));

    // Show target
    const target = document.getElementById(id);
    if(target) {
        target.classList.add('active');
        if (id === 'today') {
            renderTodayMeals();
        } else if (id === 'calorie-tracker') {
            // Recalculate and load nutrition data
            (async () => {
                await recalculateDailyNutrition();
                loadTodayNutrition();
            })();
        } else {
            // For week views, add cycle sync indicators
            markCycleSyncMeals();
        }
    }

    // Update Pills
    if(btn) {
        document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    } else if (id === 'today') {
        // Find today pill if no btn passed
        const pills = document.querySelectorAll('.pill-btn');
        pills.forEach(p => {
            if (p.textContent.toLowerCase() === 'today') {
                pills.forEach(b => b.classList.remove('active'));
                p.classList.add('active');
            }
        });
    }
}

// Add stars to cycle sync meals in static week views
function markCycleSyncMeals() {
    if (!window.cycleSyncMealTitle) return;

    // Find all meal titles in the currently active week view
    const activeSection = document.querySelector('#meals-content-container .view-section.active');
    if (!activeSection) return;

    // Skip Today view (it handles stars in renderTodayMeals)
    if (activeSection.id === 'today' || activeSection.id === 'calorie-tracker') return;

    const mealTitles = activeSection.querySelectorAll('.meal-title');
    mealTitles.forEach(titleEl => {
        const originalText = titleEl.textContent.replace('⭐ ', '').trim();
        if (originalText === window.cycleSyncMealTitle && !titleEl.textContent.startsWith('⭐')) {
            titleEl.textContent = '⭐ ' + originalText;
        }
    });
}

async function renderTodayMeals() {
    const container = document.getElementById('today-meals-content');
    if (!container) return;

    // 1. Calculate Day
    let startDate = localStorage.getItem('pbb_start_date');
    if (!startDate) {
        // Initialize program date if not set
        await initProgramDate();
        startDate = localStorage.getItem('pbb_start_date');
        if (!startDate) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">
                <p>Unable to determine your program start date. Please try refreshing the page.</p>
            </div>`;
            return;
        }
    }

    const start = new Date(startDate);
    const now = new Date();
    const diffTime = Math.abs(now - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    let currentDayNum = diffDays || 1;
    if (currentDayNum > 28) currentDayNum = 28; // Cap at 28

    const weekNum = Math.ceil(currentDayNum / 7);
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const dayIndex = (currentDayNum - 1) % 7; // Calculate which day in the program cycle (0-6)
    const dayName = days[dayIndex];
    
    const targetDayId = `week${weekNum}-${dayName}`;
    const sourceSection = document.getElementById(targetDayId);

    if (!sourceSection) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">
            <p>Your meal plan for ${dayName} (Week ${weekNum}) couldn't be found. Please check the full plan.</p>
        </div>`;
        return;
    }

    // 2. Clone and Clean Cards
    container.innerHTML = ''; // Clear loading state
    
    // Add Header
    const header = document.createElement('div');
    header.className = 'today-menu-header';
    header.innerHTML = `<h2>Today's Menu</h2>
                       <p>DAY ${currentDayNum}</p>`;
    container.appendChild(header);

    // 1.5 Personalized Meal Recommendation Banner REMOVED per user request
    // The green bar was appearing empty or unwanted.

    const cards = sourceSection.querySelectorAll('.card');

    cards.forEach(card => {
        if (card.classList.contains('reflection-card')) return;

        const clone = card.cloneNode(true);

        // Check if this meal matches the Cycle Sync meal
        if (window.cycleSyncMealTitle) {
            const mealTitleElement = clone.querySelector('.meal-title');
            if (mealTitleElement && mealTitleElement.textContent.trim() === window.cycleSyncMealTitle) {
                mealTitleElement.textContent = '⭐ ' + mealTitleElement.textContent;
            }
        }

        // Ensure images open the modal
        clone.querySelectorAll('img').forEach(img => {
            img.onclick = function() {
                // Check if openImageModal or similar exists
                if (typeof openImageModal === 'function') {
                    openImageModal(this.src);
                } else {
                    // Fallback to simple alert or nothing if not found
                    console.log("Image modal function not found");
                }
            };
        });
        container.appendChild(clone);
    });

    // 3. Add Reflection at the bottom
    const reflection = sourceSection.querySelector('.reflection-card');
    if (reflection) {
        const rfClone = reflection.cloneNode(true);
        const textarea = rfClone.querySelector('textarea');
        if (textarea) {
            const originalId = textarea.id; // e.g., ref-week1-Monday
            
            // Ensure the clone's save button works correctly
            const btn = rfClone.querySelector('button');
            const idParts = originalId.split('-');
            if (idParts.length >= 3) {
                const weekDayId = idParts[1] + '-' + idParts[2];
                if (btn) {
                    btn.onclick = function() {
                        saveDayReflection(weekDayId);
                    };
                }
            }
            
            // Mirror textarea value
            textarea.id = 'today-' + originalId;
            textarea.oninput = function() {
                const originalTextarea = document.getElementById(originalId);
                if (originalTextarea) originalTextarea.value = this.value;
            };
        }

        container.appendChild(rfClone);
    }
}

function switchDay(weekId, dayId) {
    const context = document.getElementById(weekId);
    if(!context) return;
    
    context.querySelectorAll('.day-view').forEach(el => el.classList.remove('active'));
    context.querySelectorAll('.sub-nav .sub-btn').forEach(el => el.classList.remove('active'));
    
    // Activating
    const targetId = weekId + '-' + dayId;
    const targetEl = document.getElementById(targetId);
    if(targetEl) targetEl.classList.add('active');
    
    // Highlight sub btn
    const btns = context.querySelectorAll('.sub-nav .sub-btn');
    for(let b of btns) {
        const btnText = b.innerText.toLowerCase();
        const dId = dayId.toLowerCase();
        
        if (btnText === dId || 
           (dId === 'overview' && btnText === 'overview') || 
           (dId !== 'overview' && btnText.startsWith(dId.substring(0,3)))) {
            b.classList.add('active');
        }
    }
    
    // Re-apply badges if available
    if (window.applyMealBadges) window.applyMealBadges();
}

// Backward compatibility if internal links use switchView
function switchView(id) {
    switchWeek(id);
}

// --- ONBOARDING WIZARD LOGIC ---
let currentWizardStep = 1;
const totalWizardSteps = 7;
let selectedGender = localStorage.getItem('userGender') || null; // Track gender selection

async function checkAndTriggerOnboarding() {
    // Check if user has completed onboarding before (localStorage)
    const onboardingComplete = localStorage.getItem('onboardingComplete');

    // If onboarding is already complete in localStorage, skip
    if (onboardingComplete === 'true') {
        return;
    }

    // If user is logged in, check the database for onboarding_complete flag
    // This ensures onboarding is skipped even if localStorage was cleared or user is on a new device
    if (window.currentUser) {
        try {
            const userData = await dbHelpers.users.get(window.currentUser.id);
            if (userData && userData.onboarding_complete) {
                // Sync localStorage with database state
                localStorage.setItem('onboardingComplete', 'true');
                console.log("Onboarding already completed (from database), skipping wizard");
                return;
            }
        } catch(e) {
            console.warn("Error checking onboarding status from database:", e);
        }
    }

    // Check if essential quiz data exists in sessionStorage
    const quizJson = sessionStorage.getItem('userProfile');
    let hasEssentialData = false;

    if (quizJson) {
        try {
            const quizData = JSON.parse(quizJson);
            // Check for essential fields
            hasEssentialData = quizData.age && quizData.weight && quizData.height &&
                             quizData.sex && quizData.equipment_access &&
                             quizData.activity_level && quizData.energy_level;
        } catch(e) {
            console.warn("Error parsing quiz data:", e);
        }
    }

    // If no essential data, check the database
    if (!hasEssentialData && window.currentUser) {
        try {
            const quizResults = await dbHelpers.quizResults.getLatest(window.currentUser.id);
            if (quizResults && quizResults.age && quizResults.weight && quizResults.height) {
                hasEssentialData = true;
            }
        } catch(e) {
            console.warn("Error fetching quiz results:", e);
        }
    }

    // Check if gender is selected (required for proper UI)
    const hasGender = localStorage.getItem('userGender');

    // If missing essential data OR missing gender selection, trigger onboarding wizard
    if (!hasEssentialData || !hasGender) {
        console.log("Essential quiz data or gender missing, triggering onboarding wizard...");
        setTimeout(initOnboardingWizard, 1500);
    } else {
        // User has essential data AND gender but hasn't marked onboarding complete
        // Mark as complete and show the gender-specific check-in
        console.log("User has essential data and gender, marking onboarding complete...");
        localStorage.setItem('onboardingComplete', 'true');

        // Apply gender-specific UI and show check-in
        if (typeof applyGenderSpecificUI === 'function') {
            applyGenderSpecificUI();
        }

        setTimeout(() => {
            const today = new Date().toDateString();
            const lastCheck = localStorage.getItem('lastWellnessCheck');
            if (lastCheck !== today) {
                const modal = document.getElementById('check-in-modal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }
        }, 1500);
    }
}

function initOnboardingWizard() {
    currentWizardStep = 1; // Reset to first step
    const modal = document.getElementById('onboarding-wizard');
    if(modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
        modal.style.opacity = '1';
    }
    updateWizardUI();
}

function updateWizardUI() {
    // 1. Slides
    for(let i=1; i<=totalWizardSteps; i++) {
        const slide = document.getElementById('slide-' + i);
        if(slide) slide.style.display = (i === currentWizardStep) ? 'block' : 'none';
    }

    // 2. Dots
    const dots = document.querySelectorAll('.wizard-progress .dot');
    dots.forEach((d, i) => {
        if(i < currentWizardStep) d.classList.add('active');
        else d.classList.remove('active');
    });

    // 3. Update final slide with hormone profile goal
    if(currentWizardStep === 7) {
        const hormoneProfile = sessionStorage.getItem('userResult') || 'CORTISOL';
        const goalDiv = document.getElementById('wizard-hormone-goal');
        if(goalDiv) {
            if(hormoneProfile === 'ESTROGEN') {
                goalDiv.innerHTML = 'Goal: Balance Estrogen & Support Hormones';
            } else if (selectedGender === 'male') {
                goalDiv.innerHTML = 'Goal: Optimize Performance & Build Strength';
            } else {
                goalDiv.innerHTML = 'Goal: Reduce Cortisol & Restore Balance';
            }
        }
    }

    // 4. Buttons
    const prevBtn = document.getElementById('wizard-back');
    const nextBtn = document.getElementById('wizard-next');

    if(prevBtn) prevBtn.style.visibility = (currentWizardStep > 1) ? 'visible' : 'hidden';

    if(nextBtn) {
        if(currentWizardStep === totalWizardSteps) {
            nextBtn.innerHTML = "Let's Go! 🚀";
            nextBtn.onclick = finishOnboarding;
        } else {
            nextBtn.innerHTML = "Next &rarr;";
            nextBtn.onclick = wizardNext;
        }
    }
}

function calculateNutritionGoals(data) {
    // Calculate BMR using Mifflin-St Jeor Equation
    // BMR (kcal/day) = 10 × weight (kg) + 6.25 × height (cm) − 5 × age (y) + s
    // where s = +5 for males and −161 for females

    const weight = data.weight;
    const height = data.height;
    const age = data.age;
    const sex = data.sex;

    let bmr;
    if (sex === 'male') {
        bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
    } else { // female
        bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
    }

    // Calculate TDEE (Total Daily Energy Expenditure) based on activity level
    let activityMultiplier;
    switch(data.activity_level) {
        case 'sedentary':
            activityMultiplier = 1.2;
            break;
        case 'light':
            activityMultiplier = 1.375;
            break;
        case 'moderate':
            activityMultiplier = 1.55;
            break;
        case 'very':
            activityMultiplier = 1.725;
            break;
        default:
            activityMultiplier = 1.375;
    }

    const tdee = bmr * activityMultiplier;

    // Calculate calorie goal (slight deficit for weight loss, or maintenance)
    let calorieGoal = tdee;
    if (data.goal_weight < data.weight) {
        // Weight loss: 15% deficit
        calorieGoal = tdee * 0.85;
    } else if (data.goal_weight > data.weight) {
        // Weight gain: 10% surplus
        calorieGoal = tdee * 1.10;
    }

    // Calculate Macronutrient Goals (Plant-Based Distribution)
    // Protein: 1.6-2.0g per kg body weight (use 1.8g as middle ground)
    // Fat: 25-30% of calories (use 27%)
    // Carbs: Remaining calories

    const proteinGrams = weight * 1.8;
    const proteinCalories = proteinGrams * 4; // 4 cal per gram

    const fatCalories = calorieGoal * 0.27;
    const fatGrams = fatCalories / 9; // 9 cal per gram

    const carbCalories = calorieGoal - proteinCalories - fatCalories;
    const carbGrams = carbCalories / 4; // 4 cal per gram

    return {
        bmr: Math.round(bmr),
        tdee: Math.round(tdee),
        calorie_goal: Math.round(calorieGoal),
        protein_goal_g: Math.round(proteinGrams),
        carbs_goal_g: Math.round(carbGrams),
        fat_goal_g: Math.round(fatGrams)
    };
}

// Gender selection function
function selectGender(gender) {
    selectedGender = gender;
    document.getElementById('wizard-gender').value = gender;
    localStorage.setItem('userGender', gender);

    // Apply theme based on gender
    if (gender === 'male') {
        document.body.classList.add('male-theme');
        document.body.classList.remove('female-theme');
    } else {
        document.body.classList.add('female-theme');
        document.body.classList.remove('male-theme');
    }

    // Update button styles
    const femaleBtn = document.getElementById('gender-btn-female');
    const maleBtn = document.getElementById('gender-btn-male');

    if (gender === 'female') {
        femaleBtn.style.border = '2px solid var(--primary)';
        femaleBtn.style.background = '#f0fdf4';
        maleBtn.style.border = '2px solid #e2e8f0';
        maleBtn.style.background = 'white';
    } else {
        maleBtn.style.border = '2px solid #3b82f6';
        maleBtn.style.background = '#eff6ff';
        femaleBtn.style.border = '2px solid #e2e8f0';
        femaleBtn.style.background = 'white';
    }

    // Auto-advance to next slide after selection
    setTimeout(() => {
        currentWizardStep++;
        updateWizardUI();
    }, 300);
}

// Helper function to check if user is male
function isMaleUser() {
    return localStorage.getItem('userGender') === 'male';
}

// Apply gender theme on page load if already set
function applyGenderTheme() {
    const savedGender = localStorage.getItem('userGender');
    if (savedGender === 'male') {
        document.body.classList.add('male-theme');
        document.body.classList.remove('female-theme');
        selectedGender = 'male';
    } else if (savedGender === 'female') {
        document.body.classList.add('female-theme');
        document.body.classList.remove('male-theme');
        selectedGender = 'female';

        // Reset DBZ theme if female user has it selected (male-only themes)
        const currentTheme = localStorage.getItem('userThemePreference');
        if (currentTheme && currentTheme.startsWith('dbz-')) {
            localStorage.setItem('userThemePreference', 'default');
            if (typeof applyAppTheme === 'function') {
                applyAppTheme('default');
            }
        }
    }

    // Apply gender-specific UI changes
    applyGenderSpecificUI();
}

// Hide/show UI elements based on gender
function applyGenderSpecificUI() {
    const isMale = isMaleUser();

    // Elements to hide for males (by ID)
    const femaleOnlyElements = [
        'check-in-period-section',     // Period flow check-in
        'check-in-cervical-section',   // Cervical fluid check-in
    ];

    // Elements to show only for males (by ID)
    const maleOnlyElements = [
        'check-in-recovery-section',   // Recovery status check-in
    ];

    femaleOnlyElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = isMale ? 'none' : '';
    });

    maleOnlyElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = isMale ? '' : 'none';
    });

    // Handle female-only and male-only chips (by class)
    document.querySelectorAll('.female-only-chip').forEach(el => {
        el.style.display = isMale ? 'none' : '';
    });

    document.querySelectorAll('.male-only-chip').forEach(el => {
        el.style.display = isMale ? '' : 'none';
    });

    // Handle gender-specific theme options
    document.querySelectorAll('.female-only-theme').forEach(el => {
        el.style.display = isMale ? 'none' : '';
    });

    document.querySelectorAll('.male-only-theme').forEach(el => {
        el.style.display = isMale ? '' : 'none';
    });

    // Show/hide DBZ character decorations based on theme and gender
    const dbzDecorations = document.getElementById('dbz-decorations');
    if (dbzDecorations) {
        const currentTheme = localStorage.getItem('userThemePreference') || 'default';
        const isDbzTheme = currentTheme.startsWith('dbz-');
        dbzDecorations.style.display = (isMale && isDbzTheme) ? 'block' : 'none';
    }

    // Update Hormone Hub for males
    if (isMale) {
        // Update cycle phase display for males
        const phaseName = document.getElementById('cycle-phase-name');
        const phaseDesc = document.getElementById('cycle-phase-desc');
        const phaseIcon = document.querySelector('#view-cycle .card-body div[style*="font-size: 2.5rem"]');

        if (phaseName) phaseName.textContent = 'Performance Mode';
        if (phaseDesc) phaseDesc.textContent = 'Optimized training based on your recovery and energy levels.';
        if (phaseIcon) phaseIcon.textContent = '💪';

        // Hide cycle day badge parent
        const cycleDayBadge = document.getElementById('cycle-day-display');
        if (cycleDayBadge && cycleDayBadge.parentElement) {
            cycleDayBadge.parentElement.style.display = 'none';
        }

        // Hide cycle phase tags
        const phaseTags = document.getElementById('cycle-phase-tags');
        if (phaseTags) phaseTags.style.display = 'none';

        // Update Hormone Hub title and subtitle
        const hormoneHubHeader = document.querySelector('#view-cycle div[style*="sticky"]');
        if (hormoneHubHeader) {
            const title = hormoneHubHeader.querySelector('h2');
            const subtitle = hormoneHubHeader.querySelector('div[style*="0.8rem"]');
            if (title) title.textContent = 'Performance Hub';
            if (subtitle) subtitle.textContent = 'Optimize your training & recovery';
        }

        // Update "Cycle Sync" text to "Daily Sync"
        const checkInPrompt = document.getElementById('check-in-prompt-card');
        if (checkInPrompt) {
            const subtitleEl = checkInPrompt.querySelector('div[style*="text-muted"]');
            if (subtitleEl) subtitleEl.textContent = 'Log energy & recovery';
        }

        // Update completed state text
        const completedCard = document.getElementById('check-in-completed-card');
        if (completedCard) {
            const titleEl = completedCard.querySelector('div[style*="font-weight: 700"]');
            if (titleEl) titleEl.textContent = 'Daily Sync Active!';
        }

        // Update check-in modal title
        const checkInModalTitle = document.querySelector('#check-in-modal h2');
        if (checkInModalTitle && checkInModalTitle.textContent.includes('Cycle')) {
            checkInModalTitle.textContent = 'Daily Check-in';
        }

        // Update bottom navigation "Cycle" tab to "Perform"
        const navCycleLabel = document.getElementById('nav-cycle-label');
        if (navCycleLabel) navCycleLabel.textContent = 'Perform';

        // Update nav icon to dumbbell for males
        const navCycleIcon = document.getElementById('nav-cycle-icon');
        if (navCycleIcon) {
            navCycleIcon.innerHTML = '<path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z"/>';
        }

        // Update Cycle Tracking button in settings
        const cycleTrackingBtn = document.querySelector('button[onclick="openCycleTrackingModal()"]');
        if (cycleTrackingBtn) {
            cycleTrackingBtn.innerHTML = '<span>💪</span> Recovery Tracking';
        }

        // Update meal card descriptions for males
        const flaxDesc = document.getElementById('flax-description');
        if (flaxDesc) {
            flaxDesc.textContent = '1-2 tbsp daily. Rich in omega-3s and fiber for recovery and gut health.';
        }

        // Update any estrogen-related text visible to users
        document.querySelectorAll('p, span, div').forEach(el => {
            if (el.id) return; // Skip elements we handle specifically
            if (el.textContent.includes('balance estrogen') && !el.textContent.includes('Rich in omega-3s')) {
                el.textContent = el.textContent.replace('balance estrogen', 'support recovery');
            }
            if (el.textContent.includes('estrogen detox')) {
                el.textContent = el.textContent.replace('estrogen detox', 'metabolic optimization');
            }
        });
    }

    // Update Metabolic Protocol section based on gender
    const typeLabel = document.getElementById('profile-type-label');
    const typeDesc = document.getElementById('profile-type-desc');
    const typeDisplay = document.getElementById('profile-type-display');

    if (isMale) {
        // Males: Show Energy Level instead of Hormone Type
        if (typeLabel) typeLabel.textContent = 'Energy Level';
        if (typeDesc) typeDesc.textContent = 'Affects workout intensity';
        if (typeDisplay) {
            const energyLevel = window.userEnergyLevel || 'normal';
            const energyMap = {
                'low': 'Low Energy',
                'normal': 'Normal',
                'high': 'High Energy'
            };
            typeDisplay.textContent = energyMap[energyLevel] || 'Normal';
        }
    } else {
        // Females: Show Hormone Type (default)
        if (typeLabel) typeLabel.textContent = 'Hormone Type';
        if (typeDesc) typeDesc.textContent = 'Determines your nutrition plan';
        // typeDisplay keeps its hormone profile value (set in loadProfileData)
    }
}

function wizardNext() {
    // Validation for Step 1: Gender Selection
    if(currentWizardStep === 1) {
        if (!selectedGender) {
            alert("Please select your program (For Her or For Him).");
            return;
        }
        // Gender already saved in selectGender function
        console.log("Step 1 gender selected:", selectedGender);
    }

    // Validation for Step 2: Essential Data Collection
    if(currentWizardStep === 2) {
        const name = document.getElementById('wizard-name').value.trim();
        const age = document.getElementById('wizard-age').value;
        const height = document.getElementById('wizard-height').value;
        const weight = document.getElementById('wizard-weight').value;
        const goalWeight = document.getElementById('wizard-goal-weight').value;
        const equipment = document.getElementById('wizard-equipment').value;
        const activityLevel = document.getElementById('wizard-activity-level').value;
        const energyLevel = document.getElementById('wizard-energy-level').value;

        // Validate all required fields
        if (!name) {
            alert("Please enter your name.");
            return;
        }
        if (!age || age < 18 || age > 100) {
            alert("Please enter a valid age (18-100).");
            return;
        }
        if (!height || height < 100 || height > 250) {
            alert("Please enter a valid height in cm (100-250).");
            return;
        }
        if (!weight || weight < 30 || weight > 300) {
            alert("Please enter a valid weight in kg (30-300).");
            return;
        }
        if (!goalWeight || goalWeight < 30 || goalWeight > 300) {
            alert("Please enter a valid goal weight in kg (30-300).");
            return;
        }
        if (!equipment) {
            alert("Please select your equipment access.");
            return;
        }
        if (!activityLevel) {
            alert("Please select your activity level.");
            return;
        }
        if (!energyLevel) {
            alert("Please select your energy status.");
            return;
        }

        // Save to sessionStorage for later processing
        const quizData = {
            name: name,
            age: parseInt(age),
            sex: selectedGender, // Use gender from "For Her/For Him" selection
            height: parseFloat(height),
            weight: parseFloat(weight),
            goal_weight: parseFloat(goalWeight),
            equipment_access: equipment,
            activity_level: activityLevel,
            energy_level: energyLevel,
            user_gender: selectedGender // Also store gender preference
        };

        // Calculate BMR, TDEE, and Macros
        const calculatedData = calculateNutritionGoals(quizData);
        Object.assign(quizData, calculatedData);

        // Store in sessionStorage
        sessionStorage.setItem('userProfile', JSON.stringify(quizData));

        console.log("Step 2 data collected:", quizData);

        // If male, skip cycle tracking (step 3) and go directly to step 4
        if (selectedGender === 'male') {
            // Set default values for males (no cycle tracking)
            const existingData = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
            existingData.menopause_status = 'not_applicable';
            existingData.last_period = null;
            existingData.profile = 'CORTISOL'; // Default profile for males
            sessionStorage.setItem('userProfile', JSON.stringify(existingData));
            sessionStorage.setItem('userResult', 'CORTISOL');

            // Skip to step 4 (nutrition logic)
            currentWizardStep = 4;
            updateWizardUI();
            return;
        }
    }

    // Validation for Step 3: Cycle Setup (females only)
    if(currentWizardStep === 3) {
        const dateInput = document.getElementById('wizard-period-date');
        const wellnessToggle = document.getElementById('wizard-wellness-toggle');

        if (!wellnessToggle.checked && !dateInput.value) {
            alert("Please enter your last period date so we can sync your plan.");
            return;
        }

        // Save Data
        if (wellnessToggle.checked) {
            userCycleData.noPeriodMode = true;
            toggleNoPeriodMode(); // Apply logic
        } else {
            userCycleData.noPeriodMode = false;
            userCycleData.lastPeriod = dateInput.value;
            // Also update the Settings input in profile
            const settingsInput = document.getElementById('last-period-input-profile');
            if(settingsInput) settingsInput.value = dateInput.value;

            updateCycleData(); // Trigger calculations
        }

        // Add menopause status to quizData
        const existingData = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
        const age = existingData.age || 0;

        // Determine menopause status based on wellness toggle and age
        let menopause_status = 'cycling';
        if (wellnessToggle.checked || age > 45) {
            menopause_status = 'menopause';
        }

        existingData.menopause_status = menopause_status;
        existingData.last_period = wellnessToggle.checked ? null : dateInput.value;

        // Calculate hormone profile (CORTISOL vs ESTROGEN)
        if (menopause_status === 'menopause' || age > 45) {
            existingData.profile = 'ESTROGEN';
        } else {
            existingData.profile = 'CORTISOL';
        }

        sessionStorage.setItem('userProfile', JSON.stringify(existingData));
        sessionStorage.setItem('userResult', existingData.profile);

        console.log("Step 3 data collected, hormone profile:", existingData.profile);
    }

    if(currentWizardStep < totalWizardSteps) {
        currentWizardStep++;
        updateWizardUI();
    }
}

function wizardPrev() {
    if(currentWizardStep > 1) {
        // If male and going back from step 4, skip step 3 (cycle tracking)
        if (selectedGender === 'male' && currentWizardStep === 4) {
            currentWizardStep = 2;
        } else {
            currentWizardStep--;
        }
        updateWizardUI();
    }
}

async function finishOnboarding() {
    localStorage.setItem('onboardingComplete', 'true');
    document.getElementById('onboarding-wizard').style.display = 'none';

    // Apply gender-specific UI changes NOW that gender is selected
    if (typeof applyGenderSpecificUI === 'function') {
        applyGenderSpecificUI();
    }

    // Re-render cycle status with correct gender
    if (typeof renderCycleStatus === 'function') {
        renderCycleStatus();
    }

    // Update daily content with gender-appropriate tips
    if (typeof initProgramDate === 'function') {
        initProgramDate();
    }

    // Sync quiz data to database
    await syncQuizDataToDb();

    // Mark onboarding complete in the database so it persists across browsers/sessions
    if (window.currentUser) {
        try {
            await dbHelpers.users.update(window.currentUser.id, { onboarding_complete: true });
            console.log("Onboarding marked complete in database");
        } catch (e) {
            console.warn("Failed to mark onboarding complete in database:", e);
        }
    }

    // Show the gender-specific daily check-in modal after onboarding
    // This is the full check-in modal with gender-appropriate sections
    setTimeout(() => {
        const today = new Date().toDateString();
        const lastCheck = localStorage.getItem('lastWellnessCheck');
        if (lastCheck !== today) {
            // Apply gender-specific UI to ensure correct sections are visible
            if (typeof applyGenderSpecificUI === 'function') {
                applyGenderSpecificUI();
            }
            const modal = document.getElementById('check-in-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
    }, 500);
}

function closeWizardManually() {
     document.getElementById('onboarding-wizard').style.display = 'none';
     // Warning: if they close manually without finishing, we might show it again next time?
     // For now, let's assume they want to skip it.
     localStorage.setItem('onboardingComplete', 'true');

     // Still apply gender-specific UI if they selected a gender
     if (typeof applyGenderSpecificUI === 'function') {
         applyGenderSpecificUI();
     }

     // Show the gender-specific check-in modal if not shown today
     setTimeout(() => {
         const today = new Date().toDateString();
         const lastCheck = localStorage.getItem('lastWellnessCheck');
         if (lastCheck !== today) {
             const modal = document.getElementById('check-in-modal');
             if (modal) {
                 modal.style.display = 'flex';
             }
         }
     }, 500);
}

function toggleWizardPeriodInput() {
    const toggle = document.getElementById('wizard-wellness-toggle');
    const input = document.getElementById('wizard-period-date');
    if(toggle.checked) {
        input.disabled = true;
        input.style.opacity = '0.5';
        input.value = '';
    } else {
        input.disabled = false;
        input.style.opacity = '1';
    }
}

function toggleCard(header) {
    // Toggle card expansion
    const card = header.parentElement;
    card.classList.toggle('open');
}

// --- TRAINERIZE WORKOUT LOGIC ---
// --- TRAINERIZE WORKOUT LOGIC ---
window.WORKOUT_DB = {
    'yoga': {
        name: 'Somatic Yoga',
        id: 'yoga',
        description: 'Release the Psoas (fight/flight muscle) and switch the nervous system from "Sympathetic" (Stress) to "Parasympathetic" (Rest).',
        estimatedTime: '25',
        equipment: ['Body Weight', 'Mat'],
        schedule: [
             // DAY 1: Cortisol & Psoas Release
             {
                title: 'Somatic Hormone Reset',
                exercises: [
                    { name: 'Adductor Stretch with Thoracic Twist', sets: 1, reps: '3 min', desc: 'Signals safety to the pelvic floor' },
                    { name: 'Cat to Cow', sets: 1, reps: '1 min', desc: 'Regulates the nervous system' },
                    { name: 'Yoga - Lizard Pose (Utthan Pristhasana)', sets: 2, reps: '90 sec/side', desc: 'Releases the Psoas (fight/flight muscle)' },
                    { name: 'Yoga - Happy Baby Pose (Ananda Balasana)', sets: 1, reps: '2 min', desc: 'True somatic reset' },
                    { name: 'Yoga - Supine Twist (Jathara Parivartanasana)', sets: 2, reps: '1 min/side', desc: 'Wrings tension from adrenals' },
                    { name: 'Corpse Pose', sets: 1, reps: '5 min', desc: 'Lowers cortisol' }
                ]
            },
            // DAY 2: Hip Opening & Grounding
            {
                title: 'Deep Hip Opening Flow',
                exercises: [
                    { name: "Child's Pose", sets: 1, reps: '2 min', desc: 'Grounding and centering' },
                    { name: 'Cat to Cow', sets: 1, reps: '1 min', desc: 'Spinal warm-up' },
                    { name: 'Yoga - Pigeon Pose (Eka Pada Rajakapotasana)', sets: 2, reps: '2 min/side', desc: 'Deep hip flexor release' },
                    { name: 'Yoga - Fire Log Pose (Agnistambhasana)', sets: 2, reps: '90 sec/side', desc: 'Hip opener' },
                    { name: 'Yoga - Reclined Bound Angle (Supta Baddha Konasana)', sets: 1, reps: '3 min', desc: 'Pelvic floor relaxation' },
                    { name: 'Yoga - Legs Up the Wall (Viparita Karani)', sets: 1, reps: '5 min', desc: 'Calms nervous system' }
                ]
            },
            // DAY 3: Spinal Flow & Twists
            {
                title: 'Spinal Mobility & Detox',
                exercises: [
                    { name: 'Cat to Cow', sets: 1, reps: '2 min', desc: 'Spinal lubrication' },
                    { name: 'Yoga - Thread the Needle', sets: 2, reps: '90 sec/side', desc: 'Shoulder and upper back release' },
                    { name: 'Yoga - Seated Spinal Twist (Ardha Matsyendrasana)', sets: 2, reps: '1 min/side', desc: 'Digestive massage' },
                    { name: 'Yoga - Supine Twist (Jathara Parivartanasana)', sets: 2, reps: '2 min/side', desc: 'Spinal detox' },
                    { name: 'Yoga - Child Pose with Side Stretch', sets: 2, reps: '1 min/side', desc: 'Lateral body opening' },
                    { name: 'Corpse Pose', sets: 1, reps: '5 min', desc: 'Integration' }
                ]
            },
            // DAY 4: Restorative & Gentle
            {
                title: 'Restorative Recovery',
                exercises: [
                    { name: 'Yoga - Supported Fish Pose (Matsyasana)', sets: 1, reps: '3 min', desc: 'Heart opener' },
                    { name: 'Yoga - Puppy Pose (Anahatasana)', sets: 1, reps: '2 min', desc: 'Calms heart rate' },
                    { name: "Child's Pose", sets: 1, reps: '3 min', desc: 'Deep rest' },
                    { name: 'Yoga - Reclined Bound Angle (Supta Baddha Konasana)', sets: 1, reps: '4 min', desc: 'Pelvic relaxation' },
                    { name: 'Yoga - Legs Up the Wall (Viparita Karani)', sets: 1, reps: '5 min', desc: 'Lymphatic drainage' },
                    { name: 'Corpse Pose', sets: 1, reps: '8 min', desc: 'Deep relaxation' }
                ]
            },
            // DAY 5: Gentle Strength & Balance
            {
                title: 'Balance & Core Flow',
                exercises: [
                    { name: 'Yoga - Sun Salutation A (Surya Namaskar A)', sets: 3, reps: '1 round', desc: 'Full body warm-up' },
                    { name: 'Yoga - Warrior II (Virabhadrasana II)', sets: 2, reps: '1 min/side', desc: 'Leg strength' },
                    { name: 'Yoga - Triangle Pose (Trikonasana)', sets: 2, reps: '1 min/side', desc: 'Stability' },
                    { name: 'Yoga - Tree Pose (Vrksasana)', sets: 2, reps: '1 min/side', desc: 'Balance practice' },
                    { name: 'Yoga - Boat Pose (Navasana)', sets: 3, reps: '30 sec', desc: 'Core activation' },
                    { name: 'Yoga - Seated Forward Fold (Paschimottanasana)', sets: 1, reps: '3 min', desc: 'Hamstring stretch' },
                    { name: 'Corpse Pose', sets: 1, reps: '5 min', desc: 'Rest' }
                ]
            },
            // DAY 6: Full Vinyasa Flow
            {
                title: 'Dynamic Flow Integration',
                exercises: [
                    { name: 'Cat to Cow', sets: 1, reps: '2 min', desc: 'Warm-up' },
                    { name: 'Yoga - Sun Salutation A (Surya Namaskar A)', sets: 3, reps: '1 round', desc: 'Energy building' },
                    { name: 'Yoga - Sun Salutation B (Surya Namaskar B)', sets: 3, reps: '1 round', desc: 'Full body activation' },
                    { name: 'Yoga - Warrior I (Virabhadrasana I)', sets: 2, reps: '1 min/side', desc: 'Power pose' },
                    { name: 'Yoga - Extended Side Angle Pose (Utthita Parsvakonasana)', sets: 2, reps: '1 min/side', desc: 'Side body strength' },
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '2 min', desc: 'Full body stretch' },
                    { name: 'Yoga - Pigeon Pose (Eka Pada Rajakapotasana)', sets: 2, reps: '2 min/side', desc: 'Hip release' },
                    { name: 'Corpse Pose', sets: 1, reps: '7 min', desc: 'Deep rest' }
                ]
            },
            // DAY 7: Deep Rest & Meditation
            {
                title: 'Yin & Meditation',
                exercises: [
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Surrender and release' },
                    { name: 'Yoga - Reclined Bound Angle (Supta Baddha Konasana)', sets: 1, reps: '5 min', desc: 'Hip opening' },
                    { name: 'Yoga - Supine Twist (Jathara Parivartanasana)', sets: 2, reps: '3 min/side', desc: 'Spinal release' },
                    { name: 'Yoga - Legs Up the Wall (Viparita Karani)', sets: 1, reps: '7 min', desc: 'Restorative inversion' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Complete relaxation and meditation' }
                ]
            }
        ]
    },
    'bodyweight': {
        name: 'Bodyweight Sculpt',
        id: 'bodyweight',
        description: 'Build strength and tone without any equipment. Perfect for home workouts.',
        estimatedTime: '35',
        equipment: ['None'],
        schedule: [
            // DAY 1: Lower Body Push & Squat Patterns
            {
                title: 'Lower Body Power',
                exercises: [
                    { name: 'Body Weight Squat', sets: 4, reps: '15-20', desc: 'Quad and glute activation' },
                    { name: 'Body Weight Reverse Lunge', sets: 3, reps: '12/leg', desc: 'Single leg strength' },
                    { name: 'Glute Bridge', sets: 4, reps: '20', desc: 'Glute isolation' },
                    { name: 'Body Weight Single Leg Deadlift', sets: 3, reps: '10/leg', desc: 'Hamstring and balance' },
                    { name: 'Body Weight Sumo Squat', sets: 3, reps: '15', desc: 'Inner thigh and glutes' },
                    { name: 'Wall Sit', sets: 3, reps: '45 sec', desc: 'Quad endurance' }
                ]
            },
            // DAY 2: Upper Body Push
            {
                title: 'Upper Body Strength',
                exercises: [
                    { name: 'Push Up', sets: 4, reps: '10-15', desc: 'Chest, shoulders, triceps' },
                    { name: 'Pike Push Up', sets: 3, reps: '8-12', desc: 'Shoulder focus' },
                    { name: 'Tricep Dip', sets: 3, reps: '12-15', desc: 'Tricep isolation' },
                    { name: 'Plank to Down Dog', sets: 3, reps: '10', desc: 'Dynamic upper body' },
                    { name: 'Diamond Push Up', sets: 3, reps: '8-10', desc: 'Tricep emphasis' },
                    { name: 'Plank Hold', sets: 3, reps: '45 sec', desc: 'Core stability' }
                ]
            },
            // DAY 3: Core & Conditioning
            {
                title: 'Core & Cardio Blast',
                exercises: [
                    { name: 'Mountain Climber', sets: 4, reps: '30 sec', desc: 'Cardio and core' },
                    { name: 'Bicycle Crunch', sets: 3, reps: '20', desc: 'Obliques' },
                    { name: 'Burpee', sets: 3, reps: '10-15', desc: 'Full body conditioning' },
                    { name: 'Plank Hip Twist', sets: 3, reps: '15/side', desc: 'Rotational core' },
                    { name: 'High Knees', sets: 4, reps: '30 sec', desc: 'Cardio burst' },
                    { name: 'Dead Bug', sets: 3, reps: '12/side', desc: 'Core control' }
                ]
            },
            // DAY 4: Full Body Power
            {
                title: 'Total Body Strength',
                exercises: [
                    { name: 'Body Weight Squat Jump', sets: 3, reps: '12', desc: 'Explosive lower body' },
                    { name: 'Push Up', sets: 3, reps: '12-15', desc: 'Upper body push' },
                    { name: 'Body Weight Reverse Lunge', sets: 3, reps: '12/leg', desc: 'Lower body unilateral' },
                    { name: 'Superman', sets: 3, reps: '15', desc: 'Posterior chain' },
                    { name: 'Plank Alternating Arm & Leg Lift', sets: 3, reps: '10/side', desc: 'Anti-rotation' },
                    { name: 'Glute Bridge', sets: 3, reps: '20', desc: 'Glute activation' }
                ]
            },
            // DAY 5: Glutes & Legs Focus
            {
                title: 'Glute Sculpt',
                exercises: [
                    { name: 'Single Leg Glute Bridge', sets: 3, reps: '15/leg', desc: 'Glute isolation' },
                    { name: 'Body Weight Side Lunge', sets: 3, reps: '12/side', desc: 'Lateral movement' },
                    { name: 'Fire Hydrant', sets: 3, reps: '15/side', desc: 'Glute medius' },
                    { name: 'Donkey Kick', sets: 3, reps: '15/leg', desc: 'Glute max activation' },
                    { name: 'Body Weight Sumo Squat', sets: 4, reps: '20', desc: 'Inner thigh and glutes' },
                    { name: 'Calf Raise', sets: 3, reps: '20', desc: 'Calf definition' }
                ]
            },
            // DAY 6: Active Recovery & Mobility
            {
                title: 'Mobility & Flow',
                exercises: [
                    { name: 'Downward Dog', sets: 1, reps: '2 min', desc: 'Full body stretch' },
                    { name: 'Cat to Cow', sets: 1, reps: '2 min', desc: 'Spinal mobility' },
                    { name: 'World Greatest Stretch', sets: 2, reps: '5/side', desc: 'Full body mobility' },
                    { name: 'Bird Dog', sets: 3, reps: '12/side', desc: 'Core stability' },
                    { name: "Child's Pose", sets: 1, reps: '3 min', desc: 'Recovery' },
                    { name: 'Body Weight Squat', sets: 2, reps: '15', desc: 'Active recovery' }
                ]
            },
            // DAY 7: Rest or Gentle Movement
            {
                title: 'Rest Day',
                exercises: [
                    { name: 'Downward Dog', sets: 1, reps: '3 min', desc: 'Gentle stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Rest and restore' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Complete relaxation' }
                ]
            }
        ]
    },
    'home': {
        name: 'Dumbbell Strength',
        id: 'home',
        description: 'Build lean muscle mass at home with dumbbells. Progressive strength training.',
        estimatedTime: '45',
        equipment: ['Dumbbells', 'Mat'],
        schedule: [
            // DAY 1: Lower Body (Quads & Hamstrings)
            {
                title: 'Lower Body Strength',
                exercises: [
                    { name: 'Dumbbell Goblet Squat', sets: 4, reps: '12-15', desc: 'Quad dominant compound' },
                    { name: 'Dumbbell Romanian Deadlift', sets: 4, reps: '12', desc: 'Hamstring and glutes' },
                    { name: 'Dumbbell Stationary Lunge', sets: 3, reps: '12/leg', desc: 'Unilateral strength' },
                    { name: 'Dumbbell Single Leg Deadlift', sets: 3, reps: '10/leg', desc: 'Hamstring and balance' },
                    { name: 'Dumbbell Goblet Lateral Lunge', sets: 3, reps: '10/side', desc: 'Adductors and glutes' },
                    { name: 'Dumbbell Calf Raise', sets: 3, reps: '15-20', desc: 'Calf development' }
                ]
            },
            // DAY 2: Upper Body Push (Chest, Shoulders, Triceps)
            {
                title: 'Push Day',
                exercises: [
                    { name: 'Dumbbell Bench Press', sets: 4, reps: '10-12', desc: 'Chest compound' },
                    { name: 'Dumbbell Standing Shoulder Press', sets: 4, reps: '10-12', desc: 'Shoulder strength' },
                    { name: 'Dumbbell Incline Chest Press', sets: 3, reps: '12', desc: 'Upper chest' },
                    { name: 'Dumbbell Lateral Raise', sets: 3, reps: '12-15', desc: 'Shoulder width' },
                    { name: 'Dumbbell Overhead Tricep Extension', sets: 3, reps: '12-15', desc: 'Tricep mass' },
                    { name: 'Dumbbell Front Raise', sets: 3, reps: '12', desc: 'Anterior deltoid' }
                ]
            },
            // DAY 3: Core & Conditioning
            {
                title: 'Core Power',
                exercises: [
                    { name: 'Dumbbell Russian Twist', sets: 3, reps: '20 total', desc: 'Obliques' },
                    { name: 'Dumbbell Woodchop', sets: 3, reps: '12/side', desc: 'Rotational power' },
                    { name: 'Plank Hold', sets: 3, reps: '60 sec', desc: 'Core stability' },
                    { name: 'Dumbbell Side Bend', sets: 3, reps: '15/side', desc: 'Oblique strength' },
                    { name: 'Mountain Climber', sets: 3, reps: '30 sec', desc: 'Conditioning' },
                    { name: 'Dead Bug', sets: 3, reps: '12/side', desc: 'Anti-extension core' }
                ]
            },
            // DAY 4: Full Body Compound
            {
                title: 'Total Body Power',
                exercises: [
                    { name: 'Dumbbell Squat to Press', sets: 4, reps: '12', desc: 'Full body compound' },
                    { name: 'Dumbbell Deadlift', sets: 4, reps: '12', desc: 'Posterior chain' },
                    { name: 'Dumbbell Bent Over Row', sets: 3, reps: '12', desc: 'Back thickness' },
                    { name: 'Dumbbell Walking Lunge', sets: 3, reps: '10/leg', desc: 'Dynamic lower body' },
                    { name: 'Dumbbell Push Press', sets: 3, reps: '10-12', desc: 'Explosive shoulder' },
                    { name: 'Dumbbell Renegade Row', sets: 3, reps: '10/side', desc: 'Core and back' }
                ]
            },
            // DAY 5: Lower Body (Glutes & Hamstrings)
            {
                title: 'Glute & Hamstring Focus',
                exercises: [
                    { name: 'Dumbbell Sumo Deadlift', sets: 4, reps: '12', desc: 'Glute and inner thigh' },
                    { name: 'Dumbbell Bulgarian Split Squat', sets: 3, reps: '12/leg', desc: 'Glute dominant lunge' },
                    { name: 'Dumbbell Single Leg Deadlift', sets: 3, reps: '12/leg', desc: 'Hamstring and glutes' },
                    { name: 'Dumbbell Hip Thrust', sets: 4, reps: '15', desc: 'Glute isolation' },
                    { name: 'Dumbbell Goblet Sumo Squat', sets: 3, reps: '15', desc: 'Wide stance glutes' },
                    { name: 'Dumbbell Stiff Leg Deadlift', sets: 3, reps: '12', desc: 'Hamstring stretch-load' }
                ]
            },
            // DAY 6: Upper Body Pull (Back, Biceps, Rear Delts)
            {
                title: 'Pull Day',
                exercises: [
                    { name: 'Dumbbell Bent Over Row', sets: 4, reps: '12', desc: 'Back width and thickness' },
                    { name: 'Dumbbell Single Arm Bent Over Row', sets: 3, reps: '12/side', desc: 'Unilateral back' },
                    { name: 'Dumbbell Reverse Fly', sets: 3, reps: '12-15', desc: 'Rear deltoid' },
                    { name: 'Dumbbell Bicep Curl', sets: 3, reps: '12-15', desc: 'Bicep mass' },
                    { name: 'Dumbbell Hammer Curl', sets: 3, reps: '12-15', desc: 'Brachialis and forearms' },
                    { name: 'Dumbbell Shrug', sets: 3, reps: '15-20', desc: 'Trap development' }
                ]
            },
            // DAY 7: Active Recovery or Rest
            {
                title: 'Active Recovery',
                exercises: [
                    { name: 'Dumbbell Goblet Squat', sets: 2, reps: '15', desc: 'Light movement' },
                    { name: 'Dumbbell Romanian Deadlift', sets: 2, reps: '12', desc: 'Hamstring stretch' },
                    { name: 'Downward Dog', sets: 1, reps: '3 min', desc: 'Full body stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Rest' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Recovery' }
                ]
            }
        ]
    },
    'gym': {
        name: 'Full Gym Protocol',
        id: 'gym',
        description: 'Maximize strength and hormonal balance with full gym access. Traditional bodybuilding split.',
        estimatedTime: '60',
        equipment: ['Full Gym'],
        schedule: [
            // DAY 1: Legs (Quads Focus)
            {
                title: 'Leg Day - Quads',
                exercises: [
                    { name: 'Barbell Back Squat', sets: 4, reps: '8-10', desc: 'King of lower body' },
                    { name: 'Angled Machine Leg Press', sets: 4, reps: '12-15', desc: 'Quad mass' },
                    { name: 'Machine Seated Leg Extension', sets: 3, reps: '15', desc: 'Quad isolation' },
                    { name: 'Walking Barbell Lunge', sets: 3, reps: '12/leg', desc: 'Functional strength' },
                    { name: 'Machine Hack Squat', sets: 3, reps: '12', desc: 'Quad emphasis' },
                    { name: 'Seated Calf Raise Machine', sets: 4, reps: '15-20', desc: 'Calf development' }
                ]
            },
            // DAY 2: Chest & Triceps
            {
                title: 'Chest & Triceps',
                exercises: [
                    { name: 'Barbell Bench Press', sets: 4, reps: '8-10', desc: 'Chest compound' },
                    { name: 'Incline Dumbbell Bench Press', sets: 4, reps: '10-12', desc: 'Upper chest' },
                    { name: 'Machine Seated Parallel Grip Chest Press', sets: 3, reps: '12', desc: 'Chest isolation' },
                    { name: 'Cable Standing High To Low Fly', sets: 3, reps: '12-15', desc: 'Chest definition' },
                    { name: 'Cable Rope Tricep Extension', sets: 3, reps: '12-15', desc: 'Tricep mass' },
                    { name: 'Cable Standing Overhead Tricep Extension', sets: 3, reps: '12-15', desc: 'Long head tricep' },
                    { name: 'Tricep Dip', sets: 3, reps: '10-12', desc: 'Compound tricep' }
                ]
            },
            // DAY 3: Back & Biceps
            {
                title: 'Back & Biceps',
                exercises: [
                    { name: 'Barbell Bent Over Row', sets: 4, reps: '8-10', desc: 'Back thickness' },
                    { name: 'Wide Grip Lat Pulldown', sets: 4, reps: '10-12', desc: 'Lat width' },
                    { name: 'Cable Seated Row', sets: 3, reps: '12', desc: 'Mid-back' },
                    { name: 'Cable Single Arm Lateral Pulldown', sets: 3, reps: '12/side', desc: 'Unilateral lats' },
                    { name: 'Machine Back Extension', sets: 3, reps: '15', desc: 'Lower back' },
                    { name: 'Barbell Bicep Curl', sets: 3, reps: '10-12', desc: 'Bicep mass' },
                    { name: 'Cable Single Arm Bicep Curl', sets: 3, reps: '12/side', desc: 'Bicep peak' },
                    { name: 'Cable Hammer Curl', sets: 3, reps: '12-15', desc: 'Brachialis' }
                ]
            },
            // DAY 4: Legs (Glutes & Hamstrings)
            {
                title: 'Leg Day - Glutes & Hamstrings',
                exercises: [
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '10-12', desc: 'Hamstring and glutes' },
                    { name: 'Barbell Hip Thrust', sets: 4, reps: '12-15', desc: 'Glute isolation' },
                    { name: 'Machine Seated Leg Curl', sets: 4, reps: '12-15', desc: 'Hamstring isolation' },
                    { name: 'Cable Pull-Through', sets: 3, reps: '15', desc: 'Glute activation' },
                    { name: 'Machine Seated Hip Adduction', sets: 3, reps: '15', desc: 'Inner thigh' },
                    { name: 'Standing Calf Raise Machine', sets: 4, reps: '15-20', desc: 'Calf mass' }
                ]
            },
            // DAY 5: Shoulders & Abs
            {
                title: 'Shoulders & Core',
                exercises: [
                    { name: 'Barbell Overhead Shoulder Press', sets: 4, reps: '8-10', desc: 'Shoulder compound' },
                    { name: 'Machine Seated Parallel Grip Shoulder Press', sets: 3, reps: '12', desc: 'Shoulder mass' },
                    { name: 'Dumbbell Lateral Raise', sets: 4, reps: '12-15', desc: 'Lateral deltoid' },
                    { name: 'Cable Single Arm Lateral Raise', sets: 3, reps: '12/side', desc: 'Shoulder width' },
                    { name: 'Dumbbell Reverse Fly', sets: 3, reps: '12-15', desc: 'Rear deltoid' },
                    { name: 'Cable Rope Face Pull', sets: 3, reps: '15', desc: 'Rear delt and traps' },
                    { name: 'Cable Crunch', sets: 3, reps: '15-20', desc: 'Abs' },
                    { name: 'Cable Side Bend', sets: 3, reps: '15/side', desc: 'Obliques' }
                ]
            },
            // DAY 6: Full Body or Active Recovery
            {
                title: 'Full Body Metabolic',
                exercises: [
                    { name: 'Barbell Deadlift', sets: 3, reps: '8', desc: 'Full posterior chain' },
                    { name: 'Barbell Front Squat', sets: 3, reps: '10', desc: 'Quad emphasis' },
                    { name: 'Dumbbell Bench Press', sets: 3, reps: '12', desc: 'Chest' },
                    { name: 'Wide Grip Lat Pulldown', sets: 3, reps: '12', desc: 'Back width' },
                    { name: 'Cable Standing High To Low Fly', sets: 2, reps: '15', desc: 'Chest pump' },
                    { name: 'Cable Seated Row', sets: 2, reps: '15', desc: 'Back pump' }
                ]
            },
            // DAY 7: Rest
            {
                title: 'Rest & Recovery',
                exercises: [
                    { name: 'Downward Dog', sets: 1, reps: '5 min', desc: 'Full body stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Recovery' },
                    { name: 'Corpse Pose', sets: 1, reps: '15 min', desc: 'Complete rest' }
                ]
            }
        ]
    },
    'gym_split': {
        name: 'Male Gym Split',
        id: 'gym_split',
        description: 'Classic bodybuilding split for men with full gym access. Build strength and muscle with dedicated muscle group focus each day.',
        estimatedTime: '45',
        equipment: ['Barbell', 'Dumbbells', 'Cable', 'Machine'],
        schedule: [
            // DAY 1: CHEST
            {
                title: 'Chest Day',
                exercises: [
                    { name: 'Barbell Bench Press', sets: 4, reps: '8-10', desc: 'Chest compound' },
                    { name: 'Dumbbell Incline Bench Press', sets: 4, reps: '10-12', desc: 'Upper chest' },
                    { name: 'Dumbbell Flat Bench Fly', sets: 4, reps: '10-12', desc: 'Chest stretch' },
                    { name: 'Cable Standing High To Low Fly', sets: 4, reps: '12-15', desc: 'Lower chest' },
                    { name: 'Cable Rope Tricep Extension', sets: 4, reps: '12-15', desc: 'Tricep finisher' }
                ]
            },
            // DAY 2: BACK
            {
                title: 'Back Day',
                exercises: [
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '8-10', desc: 'Posterior chain' },
                    { name: 'Wide Grip Pull Up', sets: 4, reps: '8-10', desc: 'Lat width' },
                    { name: 'Cable Seated Rotational Row', sets: 4, reps: '10-12', desc: 'Mid-back' },
                    { name: 'Cable Rope Face Pull', sets: 4, reps: '12-15', desc: 'Rear delts' },
                    { name: 'Dumbbell Shrug', sets: 4, reps: '12-15', desc: 'Trap work' }
                ]
            },
            // DAY 3: LEGS
            {
                title: 'Leg Day',
                exercises: [
                    { name: 'Barbell Back Squat', sets: 4, reps: '8-10', desc: 'Quad compound' },
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '10-12', desc: 'Hamstrings' },
                    { name: 'Dumbbell Walking Lunge', sets: 4, reps: '10-12 each', desc: 'Unilateral' },
                    { name: 'Machine Seated Leg Curl', sets: 4, reps: '12-15', desc: 'Hamstring isolation' },
                    { name: 'Smith Machine Calf Raise', sets: 4, reps: '15-20', desc: 'Calf work' }
                ]
            },
            // DAY 4: SHOULDERS
            {
                title: 'Shoulder Day',
                exercises: [
                    { name: 'Barbell Overhead Press', sets: 4, reps: '8-10', desc: 'Shoulder compound' },
                    { name: 'Dumbbell Lateral Raise', sets: 4, reps: '12-15', desc: 'Side delts' },
                    { name: 'Cable Rope Face Pull', sets: 4, reps: '12-15', desc: 'Rear delts' },
                    { name: 'Dumbbell Front Raise', sets: 4, reps: '12-15', desc: 'Front delts' },
                    { name: 'Dumbbell Shrug', sets: 4, reps: '12-15', desc: 'Traps' }
                ]
            },
            // DAY 5: ARMS & CORE
            {
                title: 'Arms & Core',
                exercises: [
                    { name: 'Barbell Close Grip Bench Press', sets: 4, reps: '8-10', desc: 'Tricep compound' },
                    { name: 'Barbell Bicep Curl', sets: 4, reps: '10-12', desc: 'Bicep mass' },
                    { name: 'Cable Rope Tricep Extension', sets: 4, reps: '12-15', desc: 'Tricep isolation' },
                    { name: 'Cable Kneeling Crunch', sets: 4, reps: '12-15', desc: 'Abs' },
                    { name: 'Hanging Leg Raise', sets: 4, reps: '10-12', desc: 'Lower abs' }
                ]
            },
            // DAY 6: ACTIVE RECOVERY
            {
                title: 'Active Recovery',
                exercises: [
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '5 min', desc: 'Full body stretch' },
                    { name: 'Yoga - Pigeon Pose (Eka Pada Rajakapotasana)', sets: 2, reps: '2 min/side', desc: 'Hip mobility' },
                    { name: "Child's Pose", sets: 1, reps: '3 min', desc: 'Recovery' },
                    { name: 'Cat to Cow', sets: 1, reps: '3 min', desc: 'Spinal mobility' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Deep rest' }
                ]
            },
            // DAY 7: REST
            {
                title: 'Rest & Recovery',
                exercises: [
                    { name: 'Light Walk or Bike', sets: 1, reps: '20-30 min', desc: 'Active recovery cardio' },
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '5 min', desc: 'Stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Recovery' },
                    { name: 'Corpse Pose', sets: 1, reps: '15 min', desc: 'Complete rest' }
                ]
            }
        ]
    },
    'female_gym_split': {
        name: 'Female Gym Split',
        id: 'female_gym_split',
        description: 'Balanced training split for women with full gym access. Build strength with legs twice weekly, push/pull movements, and core focus.',
        estimatedTime: '45',
        equipment: ['Barbell', 'Dumbbells', 'Cable', 'Machine'],
        schedule: [
            // DAY 1: LEGS
            {
                title: 'Leg Day',
                exercises: [
                    { name: 'Barbell Back Squat', sets: 4, reps: '8-10', desc: 'Quad compound' },
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '10-12', desc: 'Hamstrings' },
                    { name: 'Dumbbell Walking Lunge', sets: 4, reps: '10-12 each', desc: 'Unilateral' },
                    { name: 'Machine Seated Leg Curl', sets: 4, reps: '12-15', desc: 'Hamstring isolation' },
                    { name: 'Smith Machine Calf Raise', sets: 4, reps: '15-20', desc: 'Calf work' }
                ]
            },
            // DAY 2: PUSH
            {
                title: 'Push Day',
                exercises: [
                    { name: 'Barbell Bench Press', sets: 4, reps: '8-10', desc: 'Chest compound' },
                    { name: 'Dumbbell Seated Shoulder Press', sets: 4, reps: '10-12', desc: 'Shoulder press' },
                    { name: 'Dumbbell Incline Bench Press', sets: 4, reps: '10-12', desc: 'Upper chest' },
                    { name: 'Dumbbell Lateral Raise', sets: 4, reps: '12-15', desc: 'Side delts' },
                    { name: 'Cable Rope Tricep Extension', sets: 4, reps: '12-15', desc: 'Tricep isolation' }
                ]
            },
            // DAY 3: ARMS & CORE
            {
                title: 'Arms & Core',
                exercises: [
                    { name: 'Barbell Close Grip Bench Press', sets: 4, reps: '8-10', desc: 'Tricep compound' },
                    { name: 'Barbell Bicep Curl', sets: 4, reps: '10-12', desc: 'Bicep mass' },
                    { name: 'Cable Rope Tricep Extension', sets: 4, reps: '12-15', desc: 'Tricep isolation' },
                    { name: 'Cable Kneeling Crunch', sets: 4, reps: '12-15', desc: 'Abs' },
                    { name: 'Hanging Leg Raise', sets: 4, reps: '10-12', desc: 'Lower abs' }
                ]
            },
            // DAY 4: LEGS
            {
                title: 'Leg Day',
                exercises: [
                    { name: 'Barbell Back Squat', sets: 4, reps: '8-10', desc: 'Quad compound' },
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '10-12', desc: 'Hamstrings' },
                    { name: 'Dumbbell Walking Lunge', sets: 4, reps: '10-12 each', desc: 'Unilateral' },
                    { name: 'Machine Seated Leg Curl', sets: 4, reps: '12-15', desc: 'Hamstring isolation' },
                    { name: 'Smith Machine Calf Raise', sets: 4, reps: '15-20', desc: 'Calf work' }
                ]
            },
            // DAY 5: PULL
            {
                title: 'Pull Day',
                exercises: [
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '8-10', desc: 'Posterior chain' },
                    { name: 'Wide Grip Pull Up', sets: 4, reps: '8-10', desc: 'Lat width' },
                    { name: 'Cable Seated Rotational Row', sets: 4, reps: '10-12', desc: 'Back thickness' },
                    { name: 'Cable Rope Face Pull', sets: 4, reps: '12-15', desc: 'Rear delts' },
                    { name: 'Dumbbell Bicep Curl', sets: 4, reps: '12-15', desc: 'Bicep isolation' }
                ]
            },
            // DAY 6: ACTIVE RECOVERY
            {
                title: 'Active Recovery',
                exercises: [
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '5 min', desc: 'Full body stretch' },
                    { name: 'Yoga - Pigeon Pose (Eka Pada Rajakapotasana)', sets: 2, reps: '2 min/side', desc: 'Hip mobility' },
                    { name: "Child's Pose", sets: 1, reps: '3 min', desc: 'Recovery' },
                    { name: 'Cat to Cow', sets: 1, reps: '3 min', desc: 'Spinal mobility' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Deep rest' }
                ]
            },
            // DAY 7: REST
            {
                title: 'Rest & Recovery',
                exercises: [
                    { name: 'Light Walk or Bike', sets: 1, reps: '20-30 min', desc: 'Active recovery cardio' },
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '5 min', desc: 'Stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Recovery' },
                    { name: 'Corpse Pose', sets: 1, reps: '15 min', desc: 'Complete rest' }
                ]
            }
        ]
    }
};

// Check-in State
let selectedEnergy = null;
let selectedEquipment = null;

function openCheckInModal() {
    document.getElementById('checkin-modal').style.display = 'flex';
}

function selectEnergy(level) {
    selectedEnergy = level;
    document.querySelectorAll('[id^="btn-energy-"]').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('btn-energy-' + level).classList.add('selected');
}

function selectEquipment(type) {
    selectedEquipment = type;
    document.querySelectorAll('[id^="btn-eq-"]').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('btn-eq-' + type).classList.add('selected');
}

async function submitCheckIn() {
    if(!selectedEnergy || !selectedEquipment) {
        alert("Please select both energy level and equipment access.");
        return;
    }

    try {
        const user = window.currentUser;
        if (user) {
            const dateStr = new Date().toISOString().split('T')[0];
            await dbHelpers.checkins.upsert(user.id, dateStr, {
                energy: selectedEnergy,
                equipment: selectedEquipment
            });
            console.log('✅ Check-in saved to DB');
        }
    } catch (e) {
        console.error('Failed to save check-in:', e);
        alert('Failed to save check-in. Please try again.');
        return;
    }

    document.getElementById('checkin-modal').style.display = 'none';
    renderMovementView();
}

// Cycle Tracking Modal Functions
function openCycleTrackingModal() {
    // Populate modal with current data
    const modal = document.getElementById('cycle-tracking-modal');
    const periodDateInput = document.getElementById('cycle-modal-period-date');
    const cycleLengthInput = document.getElementById('cycle-modal-cycle-length');
    const wellnessToggle = document.getElementById('cycle-modal-wellness-toggle');

    // Load from userCycleData or hidden inputs
    if (userCycleData.lastPeriod) {
        periodDateInput.value = userCycleData.lastPeriod;
    }
    cycleLengthInput.value = userCycleData.cycleLength || 28;
    wellnessToggle.checked = userCycleData.noPeriodMode || false;

    // Show/hide period date input based on wellness mode
    const updatePeriodVisibility = () => {
        const periodContainer = periodDateInput.parentElement;
        periodContainer.style.display = wellnessToggle.checked ? 'none' : 'block';
    };

    wellnessToggle.onchange = updatePeriodVisibility;
    updatePeriodVisibility();

    // Show modal with proper animation (match onboarding wizard pattern)
    if(modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
        modal.style.opacity = '1';
    }
}

function closeCycleTrackingModal() {
    const modal = document.getElementById('cycle-tracking-modal');
    if(modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
        modal.style.opacity = '0';
    }
}

function saveCycleTrackingData() {
    const periodDateInput = document.getElementById('cycle-modal-period-date');
    const cycleLengthInput = document.getElementById('cycle-modal-cycle-length');
    const wellnessToggle = document.getElementById('cycle-modal-wellness-toggle');

    // Validate input
    if (!wellnessToggle.checked && !periodDateInput.value) {
        alert("Please enter your last period date or enable Wellness Mode.");
        return;
    }

    // Update userCycleData
    userCycleData.noPeriodMode = wellnessToggle.checked;
    userCycleData.lastPeriod = wellnessToggle.checked ? null : periodDateInput.value;
    userCycleData.cycleLength = parseInt(cycleLengthInput.value) || 28;

    // Sync to hidden inputs (for backward compatibility)
    document.getElementById('last-period-input-profile').value = periodDateInput.value || '';
    document.getElementById('cycle-length-input-profile').value = cycleLengthInput.value;
    document.getElementById('no-period-toggle-profile').checked = wellnessToggle.checked;

    // Save to storage using existing function
    updateCycleData();

    // Close modal
    closeCycleTrackingModal();

    // Show success message
    alert('Cycle tracking settings saved successfully!');
}

function getExerciseVideoUrl(name) {
    return EXERCISE_VIDEOS[name] || '';
}

async function renderMovementView() {
    const user = window.currentUser;
    if (!user) return;

    // 1. Get Date Index & Profile
    const profile = await window.getUserProfile();
    const startDate = profile?.program_start_date;
    
    let dayIndex = 0;
    if (startDate) {
        const start = new Date(startDate);
        const now = new Date();
        const diffTime = Math.abs(now - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const currentDay = diffDays || 1;
        dayIndex = (currentDay - 1) % 7;
        
        // Update header date
        const dateEl = document.getElementById('movement-today-date');
        if(dateEl) dateEl.innerText = `Day ${currentDay}`;
    }

    // 2. Get Check-in
    const dateStr = new Date().toISOString().split('T')[0];
    const checkin = await dbHelpers.checkins.get(user.id, dateStr);

    // 3. Calculate Cycle Phase
    let phaseKey = 'wellness';
    let cyclePhaseInfo = null;
    let currentCycleDay = 0;

    if (userCycleData.lastPeriod && !userCycleData.noPeriodMode) {
        const start = new Date(userCycleData.lastPeriod);
        const now = new Date();
        const msPerDay = 24 * 60 * 60 * 1000;
        const daysSinceStart = Math.floor((now - start) / msPerDay);
        currentCycleDay = (daysSinceStart % userCycleData.cycleLength) + 1;
        if (currentCycleDay < 1) currentCycleDay = 1;

        phaseKey = getCyclePhase(currentCycleDay, userCycleData.cycleLength);
        cyclePhaseInfo = PHASE_INFO[phaseKey];
    }

    // === PRIORITY-BASED WORKOUT SELECTION ===
    // Priority 1: Quiz/Profile Equipment (highest) - What equipment do they have access to?
    // Priority 2: WORKOUT_DB Schedules - Use actual pre-built workouts
    // Priority 3: Daily Check-in - Energy, mood, symptoms
    // Priority 4: Cycle Phase (lowest) - Adjust based on menstrual phase
    
    // profile is already loaded above at line 9238
    
    // PRIORITY 1: Determine available programs based on quiz/profile equipment
    // Check if user has gym access from their profile
    const hasGymAccess = profile?.equipment_access === 'gym' || profile?.gym_access === true;
    // Support both 'dumbbells' (new) and 'home' (legacy) values for backward compatibility
    const hasDumbbells = profile?.equipment_access === 'dumbbells' || profile?.equipment_access === 'home' || hasGymAccess;
    
    // Default available programs based on equipment
    let availablePrograms = ['yoga', 'bodyweight']; // Always available
    if (hasDumbbells) availablePrograms.push('home');
    if (hasGymAccess) availablePrograms.push('gym');
    
    // PRIORITY 2: Weekly Schedule using WORKOUT_DB
    const today = new Date();
    const dayOfWeek = today.getDay();
    const calDayIndex = (dayOfWeek + 6) % 7; // Mon=0 index

    // Determine default strength program based on equipment from onboarding
    let defaultStrengthProgram = 'bodyweight'; // Default fallback
    if (hasGymAccess) {
        defaultStrengthProgram = 'gym';
    } else if (hasDumbbells) {
        defaultStrengthProgram = 'home';
    }

    // Weekly Schedule - maps each day to a program and workout
    // Uses equipment settings from onboarding to set appropriate workouts
    const WEEKLY_SCHEDULE = [
        { day: 'Mon', program: defaultStrengthProgram, dayIndex: 0, fallback: 'yoga', fallbackIdx: 4 }, // Lower Body Power / Balance & Core
        { day: 'Tue', program: defaultStrengthProgram, dayIndex: 1, fallback: 'yoga', fallbackIdx: 5 }, // Upper Body / Dynamic Flow
        { day: 'Wed', program: 'yoga', dayIndex: 2, fallback: 'yoga', fallbackIdx: 2 },       // Spinal Mobility
        { day: 'Thu', program: defaultStrengthProgram, dayIndex: 3, fallback: 'yoga', fallbackIdx: 4 }, // Full Body / Balance & Core
        { day: 'Fri', program: defaultStrengthProgram, dayIndex: 4, fallback: 'yoga', fallbackIdx: 4 }, // Glutes & Core
        { day: 'Sat', program: 'yoga', dayIndex: 0, fallback: 'yoga', fallbackIdx: 0 },       // Somatic Hormone Reset
        { day: 'Sun', program: 'yoga', dayIndex: 6, fallback: 'yoga', fallbackIdx: 6 }        // Yin & Meditation
    ];
    
    const scheduleItem = WEEKLY_SCHEDULE[calDayIndex];
    let suggestedProgram = scheduleItem.program;
    let workoutDayIndex = scheduleItem.dayIndex;
    let personalizationReason = '';
    
    // PRIORITY 3: Daily Check-in adjustments
    // --- DAILY SYNC OVERRIDE (Local Log) ---
    // Use gender-appropriate messaging
    const syncLabel = (typeof isMaleUser === 'function' && isMaleUser()) ? '💪 Daily Sync' : '✨ Cycle Sync';
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());

    // Track if user explicitly selected equipment in today's check-in
    let userSelectedEquipmentToday = false;

    if (userCycleData.logs && userCycleData.logs[dateStr]) {
        const log = userCycleData.logs[dateStr];

        // Map Energy
        if (log.energy === 'low') {
             suggestedProgram = 'yoga';
             workoutDayIndex = 3;
             personalizationReason = isMale ? '💪 Daily Sync: Active recovery for low energy.' : '✨ Cycle Sync: Gentle flow for low energy.';
        }

        // Map Symptoms (Cramps/Back Pain -> Yin) - Skip cramps for males
        if (log.symptoms && !isMale && (log.symptoms.includes('cramps') || log.symptoms.includes('back_pain'))) {
             suggestedProgram = 'yoga';
             workoutDayIndex = 6; // Yin
             personalizationReason = '✨ Cycle Sync: Relief for your body.';
        }

        // Map muscle soreness for males
        if (log.symptoms && isMale && log.symptoms.includes('muscle_soreness')) {
             suggestedProgram = 'yoga';
             workoutDayIndex = 3; // Restorative
             personalizationReason = '💪 Daily Sync: Recovery session for sore muscles.';
        }

        // Map Mood
        if (log.mood === 'anxious' || log.mood === 'sad') {
             suggestedProgram = 'yoga';
             workoutDayIndex = 6;
             personalizationReason = `${syncLabel}: Calming practice for your mind.`;
        }

        // High Energy Bonus - check for menstrual only if female
        const skipMenstrualCheck = isMale || !cyclePhaseInfo?.name.includes('Menstrual');
        if (log.energy === 'high' && suggestedProgram === 'yoga' && skipMenstrualCheck) {
             suggestedProgram = 'bodyweight'; // Upgrade from Yoga
             workoutDayIndex = 1; // Dynamic Flow
             personalizationReason = isMale ? '💪 Daily Sync: Let\'s crush it with high energy!' : '✨ Cycle Sync: Matching your high energy!';
        }

        // Recovery status for males
        if (isMale && log.recovery) {
            if (log.recovery === 'fresh') {
                suggestedProgram = 'bodyweight';
                workoutDayIndex = 1;
                personalizationReason = '💪 Daily Sync: Fully recovered - time to push hard!';
            } else if (log.recovery === 'tired') {
                suggestedProgram = 'yoga';
                workoutDayIndex = 3;
                personalizationReason = '💪 Daily Sync: Rest day for optimal recovery.';
            }
        }
    }
    // --- END SUPERBOOST ---

    // Get today's check-in symptoms (time-aware - only from recent check-ins)
    let todaySymptoms = [];
    if (checkin && checkin.additional_data && checkin.additional_data.symptoms) {
        todaySymptoms = checkin.additional_data.symptoms;
    } else if (userCycleData.logs && userCycleData.logs[dateStr] && userCycleData.logs[dateStr].symptoms) {
        todaySymptoms = userCycleData.logs[dateStr].symptoms;
    }

    // Symptoms override - BUT only if user hasn't explicitly selected equipment
    // EXCEPTION: If mood is 'strong' (High Energy), we ignore 'fatigue' and 'anxiety' overrides to allow rigorous exercise
    const isHighEnergy = userCycleData.mood === 'strong';

    if (todaySymptoms && todaySymptoms.length > 0) {
        // Hot flash is female-specific, skip for males
        if (!isMale && (todaySymptoms.includes('hot_flash') || todaySymptoms.includes('dizziness'))) {
            suggestedProgram = 'yoga';
            workoutDayIndex = 3; // Restorative Recovery
            personalizationReason = '✨ Cycle Sync: Gentle recovery for your symptoms today';
        } else if ((todaySymptoms.includes('fatigue') || todaySymptoms.includes('anxiety')) && !isHighEnergy) {
            suggestedProgram = 'yoga';
            workoutDayIndex = 6; // Yin & Meditation
            personalizationReason = `${syncLabel}: Restorative practice for how you feel today`;
        }
    } else if (userCycleData.mood === 'tired') {
        suggestedProgram = 'yoga';
        workoutDayIndex = 3; // Restorative Recovery
        personalizationReason = `${syncLabel}: Recovery & restoration for low energy`;
    }

    // HIGHEST PRIORITY: Explicit equipment selection from today's check-in overrides symptoms
    // Check both database checkin AND localStorage logs for equipment selection
    let equipmentFromCheckin = null;

    // First, try to get equipment from database check-in
    if (checkin && checkin.equipment) {
        equipmentFromCheckin = checkin.equipment;
    }
    // Fallback: check localStorage if database doesn't have it
    else if (userCycleData.logs && userCycleData.logs[dateStr] && userCycleData.logs[dateStr].equipment) {
        equipmentFromCheckin = userCycleData.logs[dateStr].equipment;
    }

    if (checkin || equipmentFromCheckin) {
        // If low energy, always suggest yoga (even overrides equipment choice)
        if (checkin && checkin.energy === 'low') {
            suggestedProgram = 'yoga';
            workoutDayIndex = 3; // Restorative Recovery
            personalizationReason = isMale ? '💪 Daily Sync: Active recovery for low energy' : '✨ Cycle Sync: Gentle movement for low energy today';
        }
        // Equipment override based on TODAY's explicit check-in choice
        else if (equipmentFromCheckin === 'gym' && availablePrograms.includes('gym')) {
            suggestedProgram = 'gym';
            workoutDayIndex = calDayIndex % 7;
            userSelectedEquipmentToday = true;
            // Clear symptom-based personalization if user explicitly chose equipment
            if (personalizationReason.includes('symptoms') || personalizationReason.includes('Restorative')) {
                personalizationReason = '';
            }
        } else if (equipmentFromCheckin === 'dumbbells' && availablePrograms.includes('home')) {
            suggestedProgram = 'home';
            workoutDayIndex = calDayIndex % 7;
            userSelectedEquipmentToday = true;
            // Clear symptom-based personalization if user explicitly chose equipment
            if (personalizationReason.includes('symptoms') || personalizationReason.includes('Restorative')) {
                personalizationReason = '';
            }
        }
    }

    // PRIORITY 4: Cycle Phase adjustments (skip for males)
    // CRITICAL: Do NOT override if user explicitly selected equipment in today's check-in
    if (!isMale && !personalizationReason && !userSelectedEquipmentToday && cyclePhaseInfo && phaseKey !== 'wellness' && phaseKey !== 'performance') {
        if (phaseKey === 'menstrual' && (suggestedProgram === 'bodyweight' || suggestedProgram === 'gym' || suggestedProgram === 'home')) {
            // During menstrual, swap strength workouts to gentle yoga
            // BUT only if user hasn't explicitly selected equipment today
            suggestedProgram = 'yoga';
            workoutDayIndex = 3; // Restorative Recovery
            personalizationReason = `✨ Cycle Sync: Gentle movement for menstrual phase`;
        } else {
            personalizationReason = `✨ Cycle Sync: ${cyclePhaseInfo.rec}`;
        }
    }

    // For males, show performance-based recommendation if no other reason
    if (isMale && !personalizationReason) {
        personalizationReason = '💪 Daily Sync: Strength, HIIT, Progressive Overload';
    }
    
    // Ensure program is available based on equipment
    if (!availablePrograms.includes(suggestedProgram)) {
        suggestedProgram = scheduleItem.fallback;
        workoutDayIndex = scheduleItem.fallbackIdx;
    }

    const assets = {
        'yoga': { img: '/assets/somatic_yoga_hero.png', sub: 'Recovery', color: '#F59E0B' },
        'bodyweight': { img: '/assets/bodyweight_sculpt_hero.png', sub: 'No Equipment', color: '#ec4899' },
        'home': { img: '/assets/dumbbell_strength_hero.png', sub: 'Dumbbells', color: '#8b5cf6' },
        'gym': { img: '/assets/full_gym_hero.png', sub: 'Gym Access', color: '#10b981' }
    };

    // Render Hero
    const heroContainer = document.getElementById('movement-hero-container');
    const heroProg = window.WORKOUT_DB[suggestedProgram];
    const heroMeta = assets[suggestedProgram];
    const heroSched = heroProg.schedule[workoutDayIndex % heroProg.schedule.length];

    // Check if this is a Cycle Sync personalization
    const isCycleSync = personalizationReason && personalizationReason.startsWith('✨ Cycle Sync:');
    const isDailySync = personalizationReason && personalizationReason.startsWith('💪 Daily Sync:');
    const badgeText = isCycleSync ? '⭐ Cycle Sync' : (isDailySync ? '💪 Daily Sync' : (personalizationReason ? '✨ Personalized' : 'Best for Today'));

    heroContainer.innerHTML = `
    <div class="card" onclick="startActiveWorkout('${suggestedProgram}')" style="cursor: pointer; overflow:hidden; border-radius:32px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); border:none; position: relative; margin-bottom: 30px;">
        <div style="position: relative; height: 380px;">
             <img src="${heroMeta.img}" style="width:100%; height:100%; object-fit: cover;" onerror="this.src='https://placehold.co/600x800/png?text=${suggestedProgram}';">
             <div style="position: absolute; inset:0; background: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0.4) 50%, transparent 100%);"></div>

             <div style="position: absolute; top: 25px; left: 25px;">
                <span style="background: ${heroMeta.color}; color: white; padding: 8px 16px; border-radius: 50px; font-size: 0.8rem; font-weight: 800; text-transform: uppercase;">${badgeText}</span>
             </div>

             <div style="position: absolute; bottom: 0; left: 0; width: 100%; padding: 30px;">
                 <div style="color: ${heroMeta.color}; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 5px;">${heroProg.name}</div>
                 <h2 style="color: white; margin: 0 0 15px 0; font-size: 2.2rem; line-height: 1.1; font-family:'Playfair Display';">${heroSched.title}</h2>
                 <div style="display:flex; gap:15px; color:rgba(255,255,255,0.7); font-size:0.9rem; margin-bottom:20px;">
                    <span style="display:flex; align-items:center; gap:5px;"><svg style="width:16px; height:16px; fill:currentColor;" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>${heroProg.estimatedTime} mins</span>
                    <span style="display:flex; align-items:center; gap:5px;"><svg style="width:16px; height:16px; fill:currentColor;" viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>${heroSched.exercises.length} exercises</span>
                 </div>
                 <button onclick="event.stopPropagation(); startActiveWorkout('${suggestedProgram}')" style="width: 100%; background: #FFC107; color: black; border: none; padding: 18px; border-radius: 50px; font-weight: 900; font-size: 1.1rem; box-shadow: 0 10px 20px rgba(255,193,7,0.3);">
                    START SESSION
                 </button>
             </div>
        </div>
    </div>`;
    
    // Render Saved Workouts (DB)
    const savedContainer = document.getElementById('saved-workouts-container');
    const savedList = document.getElementById('saved-workouts-list');
    
    try {
        const savedWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
        window.savedWorkoutsCache = savedWorkouts; // Cache for player

        if (savedWorkouts.length > 0) {
            savedContainer.style.display = 'block';
            savedList.innerHTML = savedWorkouts.map(w => {
                const name = w.template_name || 'Untitled Workout';
                const exercises = w.template_data?.exercises || [];
                return `
                <div onclick="startSavedWorkout('${w.id}')" style="min-width: 160px; background:white; border-radius:16px; padding:15px; border:1px solid #f1f5f9; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.05);">
                    <div style="width:40px; height:40px; background:#f0fdf4; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:10px; color:var(--primary); font-weight:bold;">${name.charAt(0)}</div>
                    <div style="font-weight:700; color:var(--text-main); font-size:0.9rem; margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">${exercises.length} exercises</div>
                </div>
            `}).join('') + `
                <div onclick="openWorkoutBuilder()" style="min-width: 60px; display:flex; align-items:center; justify-content:center; background:#f8fafc; border-radius:16px; border:2px dashed #cbd5e1; cursor:pointer; color:#cbd5e1; font-weight:bold; font-size:1.5rem;">+</div>
            `;
        } else {
             savedContainer.style.display = 'none';
        }
    } catch(err) {
        console.error('Failed to load saved workouts:', err);
    }

    const gridContainer = document.getElementById('movement-grid-container');
    gridContainer.innerHTML = ''; 

    // Add 'Build Custom' Card as first item
    const buildDiv = document.createElement('div');
    buildDiv.onclick = () => openWorkoutBuilder();
    buildDiv.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); background: #f1f5f9; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; border: 2px dashed #cbd5e1;";
    buildDiv.innerHTML = `
        <div style="width:50px; height:50px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05);">
            <svg viewBox="0 0 24 24" style="width:24px; height:24px; fill:var(--primary);"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </div>
        <div style="font-weight:800; color:var(--text-main); font-size:1.1rem;">Build Custom</div>
        <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">Create your own flow</div>
    `;
    gridContainer.appendChild(buildDiv);

    // Add 'Browse Workout Library' Card as second item
    const libraryDiv = document.createElement('div');
    libraryDiv.onclick = () => openWorkoutLibrary();
    libraryDiv.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);";
    libraryDiv.innerHTML = `
        <div style="position: absolute; inset:0; background: linear-gradient(to bottom right, rgba(0,0,0,0.2), transparent);"></div>
        <div style="position: absolute; bottom: 15px; left: 15px; color: white; z-index: 1;">
            <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 5px;">Explore All</div>
            <div style="font-size: 1.2rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px;">Workout Library</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">100+ workouts to choose from</div>
        </div>
        <div style="position: absolute; top: 15px; right: 15px; color: white; opacity: 0.4; font-size: 3rem;">📚</div>
    `;
    gridContainer.appendChild(libraryDiv);

    // Removed other workout cards - users now browse via Workout Library
    // Object.keys(WORKOUT_DB).forEach(key => {
    //     if (key === suggestedProgram) return;
    //     const prog = WORKOUT_DB[key];
    //     const meta = assets[key];
    //     const sched = prog.schedule[dayIndex % prog.schedule.length];

    //     const div = document.createElement('div');
    //     div.onclick = () => startActiveWorkout(key);
    //     div.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1);";
    //     div.innerHTML = `
    //         <img src="${meta.img}" style="width:100%; height:100%; object-fit: cover; position:absolute; inset:0;" onerror="this.src='https://placehold.co/300x200?text=${key}';">
    //         <div style="position: absolute; inset:0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);"></div>
    //         <div style="position: absolute; bottom: 15px; left: 15px; color: white;">
    //             <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.8;">${prog.name}</div>
    //             <div style="font-size: 1.2rem; font-weight: 800; line-height: 1.1;">${sched.title}</div>
    //         </div>
    //     `;
    //     gridContainer.appendChild(div);
    // });
}

function showWorkoutOverview(id) {
    const program = WORKOUT_DB[id];
    const startDate = localStorage.getItem('pbb_start_date');
    let dayIndex = 0;
    if (startDate) {
        const start = new Date(startDate);
        const dayDiff = Math.ceil(Math.abs(new Date() - start) / (1000 * 60 * 60 * 24));
        dayIndex = (dayDiff || 1) - 1;
    }
    const workout = program.schedule[dayIndex % program.schedule.length];

    document.getElementById('overview-title').innerText = workout.title;
    document.getElementById('overview-header-title').innerText = program.name;
    document.getElementById('overview-meta').innerText = `${program.estimatedTime} mins  ${workout.exercises.length} Exercises`;
    document.getElementById('overview-instructions').innerText = program.description || '';
    
    // Equipment
    const eqCont = document.getElementById('overview-equipment');
    eqCont.innerHTML = '';
    program.equipment.forEach(e => {
        eqCont.innerHTML += `<span style="background:#f1f5f9; padding:8px 15px; border-radius:50px; font-size:0.85rem; font-weight:600; color:var(--text-main);">${e}</span>`;
    });

    // Exercises
    const exList = document.getElementById('overview-exercise-list');
    exList.innerHTML = '';
    workout.exercises.forEach(ex => {
        exList.innerHTML += `
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                <div style="width:70px; height:70px; border-radius:12px; background:#f1f5f9; flex-shrink:0; overflow:hidden;">
                    <img src="https://placehold.co/100x100/png?text=Preview" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <div style="flex:1;">
                    <div style="font-weight:700; font-size:1.05rem;">${ex.name}</div>
                    <div style="color:var(--text-muted); font-size:0.85rem;">${ex.sets} sets x ${ex.reps}</div>
                </div>
            </div>
        `;
    });

    document.getElementById('btn-start-now').onclick = () => startActiveWorkout(id);

    // Show View
    hideAllAppViews();
    document.getElementById('view-workout-overview').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';
}

function hideAllAppViews() {
    const views = ['view-dashboard', 'view-meals', 'movement-tab', 'group', 'view-support', 'sleep', 'view-workout-success', 'view-profile', 'view-workout-overview', 'view-active-workout', 'view-coach-dashboard', 'view-workout-builder', 'view-calendar', 'view-cycle', 'view-workout-list', 'view-workout-library', 'view-workout-subcategories', 'view-progress'];
    views.forEach(v => {
        const el = document.getElementById(v);
        if(el) {
            el.style.display = 'none';
            el.classList.remove('active');
        }
    });
}

async function startActiveWorkout(id, forcedDayIndex = null) {
    const program = WORKOUT_DB[id];

    // Get correct day schedule & Preload History
    const user = window.currentUser;
    let dayIndex = 0;
    let customizations = null;

    if (forcedDayIndex !== null) {
        dayIndex = forcedDayIndex;
    } else if (user) {
        // Preload history
        try {
            window.workoutHistoryCache = await dbHelpers.workouts.getHistory(user.id);
        } catch(e) { console.error("Failed to load history", e); }

        const profile = await window.getUserProfile();
        const startDate = profile?.program_start_date;
        if (startDate) {
            const start = new Date(startDate);
            const dayDiff = Math.ceil(Math.abs(new Date() - start) / (1000 * 60 * 60 * 24));
            dayIndex = (dayDiff || 1) - 1;
        }
    }

    const actualDayIndex = dayIndex % program.schedule.length;
    const workout = program.schedule[actualDayIndex];

    // Store current workout key for customizations
    window.currentWorkoutKey = `${id}/${actualDayIndex}`;

    // Load workout customizations if user is logged in
    if (user) {
        try {
            customizations = await dbHelpers.workoutCustomizations.get(user.id, window.currentWorkoutKey);
            window.currentWorkoutCustomizations = customizations;
        } catch(e) {
            console.error("Failed to load customizations", e);
        }
    }

    // Build exercise list with customizations applied
    let exercises = workout.exercises.map(ex => ({...ex}));

    if (customizations) {
        // Filter out removed exercises
        const removedExercises = customizations.removed_exercises || [];
        exercises = exercises.filter(ex => !removedExercises.includes(ex.name));

        // Add user-added exercises at the end
        const addedExercises = customizations.added_exercises || [];
        exercises = exercises.concat(addedExercises.map(ex => ({
            ...ex,
            isUserAdded: true
        })));
    }

    document.getElementById('workout-player-title').innerText = workout.title;
    const exerciseCount = exercises.length;
    document.getElementById('workout-player-goal').innerText = `${program.description} · ${exerciseCount} Exercise${exerciseCount !== 1 ? 's' : ''}`;

    const list = document.getElementById('workout-exercises-list');
    list.innerHTML = '';

    exercises.forEach((ex, idx) => {
        const card = document.createElement('div');
        card.className = 'exercise-logger-card';
        card.setAttribute('data-exercise-name', ex.name);
        card.setAttribute('data-is-user-added', ex.isUserAdded || false);
        card.style.cssText = "background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9;";

        const isTimeBased = ex.reps && (ex.reps.toLowerCase().includes('min') || ex.reps.toLowerCase().includes('s'));
        let setsHtml = '';
        const numSets = ex.sets || 3;
        for(let s=1; s<=numSets; s++) {
            setsHtml += getSetRowHtml(ex.name, s, isTimeBased);
        }

        const videoUrl = findVideoMatch(ex.name);
        const prevData = findPreviousSetData(ex.name);
        const isUserAdded = ex.isUserAdded || false;
        const escapedName = ex.name.replace(/'/g, "\\'");

        card.innerHTML = `
            <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <h3 style="margin:0; font-size:1.05rem; font-weight:700; color:var(--text-main); line-height:1.2;">${ex.name}</h3>
                            ${isUserAdded ? '<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">ADDED</span>' : ''}
                        </div>
                        <p style="margin:0; font-size:0.85rem; color:var(--text-muted); line-height:1.3;">${ex.desc || ''}</p>
                        ${prevData ? `<div style="color: var(--primary); font-size: 0.75rem; margin-top: 5px;">Last: ${prevData}</div>` : ''}
                    </div>
                    <button onclick="deleteExerciseFromWorkout('${escapedName}', ${isUserAdded})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; font-size: 0.8rem; font-weight: 600;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>

            ${videoUrl ? `
            <div data-video-container style="position:relative; width:100%; padding-top:56.25%; background:black; cursor:pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:60px; height:60px; background:rgba(255,255,255,0.9); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width:30px; height:30px; fill:var(--primary); margin-left:3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr; gap:8px; padding:0 15px 10px 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div>
            </div>

            <div class="sets-list-container">
                ${setsHtml}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${escapedName}', ${isTimeBased})" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>
        `;
        list.appendChild(card);
    });

    hideAllAppViews();
    document.getElementById('view-active-workout').style.display = 'block';
    startWorkoutTimer();

    // Push navigation state for Android back button
    pushNavigationState('view-active-workout', () => quitWorkout());
}

function getPreviousStats(name, set) {
    // Use cached history from DB
    const history = window.workoutHistoryCache || [];

    // Filter history for this specific exercise
    const exerciseHistory = history.filter(h => h.exercise === name);

    if (exerciseHistory.length === 0) return 'New';

    // Reverse iterate to find most recent
    for (let i = exerciseHistory.length - 1; i >= 0; i--) {
        const h = exerciseHistory[i];
        if (h.set == set) {
             const val = h.reps || h.time;
             if (h.kg && h.kg !== '0' && h.kg !== '') return `${h.kg}kg x ${val}`;
             return `${val}`;
        }
    }
    return '-';
}

function findPreviousSetData(name) {
    // Use cached history from DB to find most recent data for this exercise
    const history = window.workoutHistoryCache || [];
    const exerciseHistory = history.filter(h => h.exercise === name);

    if (exerciseHistory.length === 0) return null;

    // Get most recent entry
    const recent = exerciseHistory[exerciseHistory.length - 1];
    const val = recent.reps || recent.time;
    if (recent.kg && recent.kg !== '0' && recent.kg !== '') {
        return `${recent.kg}kg x ${val}`;
    }
    return val ? `${val}` : null;
}

function getSetRowHtml(exName, setNum, isTimeBased) {
    const prev = getPreviousStats(exName, setNum) || '-';
    return `
        <div class="workout-set-row" style="display:grid; grid-template-columns:40px 1fr 1fr 1fr; gap:8px; align-items:center; padding:10px 15px; border-top:1px solid #f8fafc;">
            <div style="font-weight:800; color:#94a3b8; font-size:0.85rem; text-align:center;">${setNum}</div>
            <div style="position:relative;">
                <input type="text" class="input-time" placeholder="-" style="width:100%; border:none; background:#f8fafc; border-radius:8px; padding:10px 5px; text-align:center; font-weight:700; color:var(--text-main); font-size:0.9rem;">
                ${isTimeBased ? '<svg viewBox="0 0 24 24" style="position:absolute; left:4px; top:50%; transform:translateY(-50%); width:12px; height:12px; fill:#94a3b8;"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>' : ''}
            </div>
            <input type="text" class="input-reps" placeholder="Reps" style="width:100%; border:none; background:#f8fafc; border-radius:8px; padding:10px 5px; text-align:center; font-weight:700; color:var(--text-main); font-size:0.9rem;">
            <input type="text" class="input-kg" placeholder="Kg" style="width:100%; border:none; background:#f8fafc; border-radius:8px; padding:10px 5px; text-align:center; font-weight:700; color:var(--text-main); font-size:0.9rem;">
        </div>
    `;
}

function addWorkoutSet(btn, exName, isTimeBased) {
    // Navigate up to the card container
    // Structure: Button -> Div -> Div (padding) -> Card
    const card = btn.closest('.card') || btn.parentElement.parentElement.parentElement;
    
    // Find the sets container within this card
    const container = card.querySelector('.sets-list-container');
    
    if (!container) {
        console.error("Could not find .sets-list-container");
        return;
    }

    const setNum = container.children.length + 1;
    
    // Create new div wrapper (since getSetRowHtml returns a string)
    const div = document.createElement('div');
    div.innerHTML = getSetRowHtml(exName, setNum, isTimeBased).trim();
    
    // Optional: Add simple animation
    const newRow = div.firstElementChild;
    newRow.style.opacity = '0';
    newRow.style.transform = 'translateY(-10px)';
    newRow.style.transition = 'all 0.3s ease';
    
    container.appendChild(newRow);
    
    // Trigger reflow for animation
    requestAnimationFrame(() => {
        newRow.style.opacity = '1';
        newRow.style.transform = 'translateY(0)';
    });
}

let workoutTimerInterval;
function startWorkoutTimer() {
    let sec = 0;
    const display = document.getElementById('workout-timer');
    clearInterval(workoutTimerInterval);
    workoutTimerInterval = setInterval(() => {
        sec++;
        const m = Math.floor(sec / 60).toString().padStart(2, '0');
        const s = (sec % 60).toString().padStart(2, '0');
        display.innerText = `${m}:${s}`;
    }, 1000);
}

async function finishWorkout() {
    clearInterval(workoutTimerInterval);
    const duration = document.getElementById('workout-timer').innerText;
    document.getElementById('success-duration').innerText = duration;

    // Save logic
    const activeWorkout = document.getElementById('workout-exercises-list');
    const date = new Date().toISOString().split('T')[0];
    const setsToSave = [];

    if(activeWorkout) {
        Array.from(activeWorkout.children).forEach(card => {
            const nameEl = card.querySelector('h3');
            if(!nameEl) return;
            const name = nameEl.innerText;

            const container = card.querySelector('.sets-list-container');
            if(!container) return;

            container.querySelectorAll('.workout-set-row').forEach((row, rIdx) => {
                const time = row.querySelector('.input-time')?.value || '';
                const reps = row.querySelector('.input-reps')?.value || '';
                const kg = row.querySelector('.input-kg')?.value || '';

                // Only save if at least one field is filled
                if (time || reps || kg) {
                    setsToSave.push({
                        date,
                        exercise: name,
                        set: rIdx + 1,
                        reps: reps,
                        time: time,
                        kg: kg
                    });
                }
            });
        });
    }

    try {
        const user = window.currentUser;
        if(user && setsToSave.length > 0) {
             // Save workout data
             await Promise.all(setsToSave.map(s => dbHelpers.workouts.createHistory(user.id, s)));
             console.log("✅ Workout saved to DB");

             // Update cache if it exists
             if (window.workoutHistoryCache) {
                 window.workoutHistoryCache.push(...setsToSave);
             }

             // Check for improvements and milestones
             try {
                 const [improvements, milestones] = await Promise.all([
                     dbHelpers.workouts.getWorkoutImprovements(user.id, setsToSave),
                     dbHelpers.milestones.checkAndRecordMilestones(user.id)
                 ]);

                 // Award points for completing workout
                 try {
                     // Use today's date as workout reference ID
                     const workoutRefId = new Date().toISOString().split('T')[0] + '_' + Date.now();
                     await awardPointsForWorkout(workoutRefId);
                 } catch(pointsError) {
                     console.error("Error awarding points (workout still saved):", pointsError);
                 }

                 // Display success screen with progress data
                 await showWorkoutSuccessScreen(duration, improvements, milestones, setsToSave);
             } catch(progressError) {
                 console.error("Error calculating progress:", progressError);
                 // Still show success screen, just without progress data
                 await showWorkoutSuccessScreen(duration, [], [], setsToSave);
             }
        } else {
            hideAllAppViews();
            document.getElementById('view-workout-success').style.display = 'flex';
            // Push navigation state for Android back button
            pushNavigationState('view-workout-success', () => closeSuccessScreen());
        }
    } catch(e) {
        console.error("Failed to save workout to DB:", e);
        alert("Failed to save workout. Please try again.");
        return;
    }
}

async function showWorkoutSuccessScreen(duration, improvements, milestones, workoutData) {
    hideAllAppViews();

    // Update duration
    document.getElementById('success-duration').innerText = duration;

    // Show milestones if any
    const milestonesContainer = document.getElementById('success-milestones');
    if (milestones && milestones.length > 0) {
        milestonesContainer.style.display = 'block';
        milestonesContainer.innerHTML = milestones.map(m => `
            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 16px; margin-bottom: 15px; animation: slideInUp 0.5s ease;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">${m.milestone_value === 1 ? '🎉' : m.milestone_value >= 100 ? '👑' : m.milestone_value >= 50 ? '🏆' : m.milestone_value >= 25 ? '🌟' : m.milestone_value >= 10 ? '🔥' : '💪'}</div>
                <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 5px;">Milestone Achieved!</div>
                <div style="font-size: 1rem; opacity: 0.95;">${m.message}</div>
            </div>
        `).join('');
    } else {
        milestonesContainer.style.display = 'none';
    }

    // Show improvements if any
    const improvementsContainer = document.getElementById('success-improvements');
    if (improvements && improvements.length > 0) {
        improvementsContainer.style.display = 'block';
        improvementsContainer.innerHTML = `
            <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; opacity: 0.95;">💪 Your Progress</div>
            ${improvements.map(imp => {
                let improvementText = '';
                if (imp.weightIncrease > 0 && imp.repsIncrease > 0) {
                    improvementText = `+${imp.weightIncrease}kg and +${imp.repsIncrease} reps`;
                } else if (imp.weightIncrease > 0) {
                    improvementText = `+${imp.weightIncrease}kg`;
                } else if (imp.repsIncrease > 0) {
                    improvementText = `+${imp.repsIncrease} reps`;
                }

                return `
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; text-align: left;">
                        <div style="font-weight: 600; font-size: 0.95rem;">${imp.exercise}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 5px;">
                            ${imp.previousWeight > 0 ? `${imp.previousWeight}kg` : ''} ${imp.previousReps > 0 ? `x ${imp.previousReps}` : ''}
                            →
                            ${imp.currentWeight > 0 ? `${imp.currentWeight}kg` : ''} ${imp.currentReps > 0 ? `x ${imp.currentReps}` : ''}
                            <span style="color: #4ade80; font-weight: 700; margin-left: 8px;">${improvementText}</span>
                        </div>
                    </div>
                `;
            }).join('')}
        `;
    } else {
        improvementsContainer.style.display = 'none';
    }

    // Get workout count for display
    try {
        const workoutCount = await dbHelpers.workouts.getWorkoutCount(window.currentUser.id);
        document.getElementById('success-workout-count').innerText = workoutCount;
        document.getElementById('success-workout-count-container').style.display = 'block';
    } catch(e) {
        document.getElementById('success-workout-count-container').style.display = 'none';
    }

    document.getElementById('view-workout-success').style.display = 'flex';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-success', () => closeSuccessScreen());
}

function quitWorkout() {
    if(confirm('Quit workout? Your progress won\'t be saved.')) {
        console.log("Quitting workout...");
        clearInterval(workoutTimerInterval);
        document.getElementById('view-active-workout').style.display = 'none'; // Force hide
        closeSuccessScreen();
    }
}

function closeSuccessScreen() {
    hideAllAppViews();
    document.getElementById('movement-tab').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'flex';
    renderMovementView();
}

// ===========================
// SWIPE BACK NAVIGATION SYSTEM
// ===========================

// Platform detection for adaptive navigation
function getPlatform() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;

    // iOS detection
    if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        return 'ios';
    }

    // Android detection
    if (/android/i.test(userAgent)) {
        return 'android';
    }

    // Default to iOS-style for other platforms (web browsers, etc.)
    return 'ios';
}

// Store platform once at startup for consistent behavior
const devicePlatform = getPlatform();

function enableSwipeBackNavigation(viewId, backHandler) {
    const view = document.getElementById(viewId);
    if (!view) return;

    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isDragging = false;
    let overlayEl = null;

    const screenWidth = window.innerWidth;
    const isAndroid = devicePlatform === 'android';

    // Edge zone: 50px from the appropriate edge
    const edgeThreshold = 50;

    const handleTouchStart = (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isDragging = false;
    };

    const handleTouchMove = (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = Math.abs(e.changedTouches[0].screenY - touchStartY);

        // Platform-adaptive edge detection:
        // iOS: Swipe from LEFT edge, moving RIGHT (deltaX > 0)
        // Android: Swipe from RIGHT edge, moving LEFT (deltaX < 0)
        const isFromCorrectEdge = isAndroid
            ? (touchStartX > screenWidth - edgeThreshold && deltaX < -30)  // Right edge, swipe left
            : (touchStartX < edgeThreshold && deltaX > 30);                 // Left edge, swipe right

        const absDeltaX = Math.abs(deltaX);

        if (isFromCorrectEdge && deltaY < 100) {
            isDragging = true;

            // Create visual feedback overlay
            if (!overlayEl) {
                overlayEl = document.createElement('div');
                overlayEl.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.1);
                    pointer-events: none;
                    z-index: 9998;
                    opacity: 0;
                    transition: opacity 0.1s;
                `;
                document.body.appendChild(overlayEl);
            }

            // Transform the view based on swipe distance
            // iOS: slide right (positive), Android: slide left (negative)
            const progress = Math.min(absDeltaX / 200, 1);
            const translateX = isAndroid ? deltaX : deltaX;
            view.style.transform = `translateX(${translateX}px)`;
            view.style.transition = 'none';
            overlayEl.style.opacity = progress * 0.3;
        }
    };

    const handleTouchEnd = (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = Math.abs(touchEndY - touchStartY);
        const absDeltaX = Math.abs(deltaX);

        // Platform-adaptive completion check
        const isValidSwipe = isAndroid
            ? (touchStartX > screenWidth - edgeThreshold && deltaX < -100)  // Right edge, swiped left enough
            : (touchStartX < edgeThreshold && deltaX > 100);                 // Left edge, swiped right enough

        if (isValidSwipe && deltaY < 100 && isDragging) {
            // Animate out in the appropriate direction
            const exitDirection = isAndroid ? '-100%' : '100%';
            view.style.transition = 'transform 0.3s ease-out';
            view.style.transform = `translateX(${exitDirection})`;

            // Call back handler after animation
            setTimeout(() => {
                backHandler();
                view.style.transform = '';
                view.style.transition = '';
                if (overlayEl) {
                    overlayEl.remove();
                    overlayEl = null;
                }
            }, 300);
        } else if (isDragging) {
            // Reset position if swipe wasn't far enough
            view.style.transition = 'transform 0.3s ease-out';
            view.style.transform = '';
            setTimeout(() => {
                view.style.transition = '';
                if (overlayEl) {
                    overlayEl.remove();
                    overlayEl = null;
                }
            }, 300);
        }

        isDragging = false;
    };

    // Remove existing listeners to avoid duplicates
    view.removeEventListener('touchstart', handleTouchStart);
    view.removeEventListener('touchmove', handleTouchMove);
    view.removeEventListener('touchend', handleTouchEnd);

    // Add touch listeners
    view.addEventListener('touchstart', handleTouchStart, { passive: true });
    view.addEventListener('touchmove', handleTouchMove, { passive: true });
    view.addEventListener('touchend', handleTouchEnd, { passive: true });
}

// Initialize swipe-back navigation for all movement views
function initializeMovementSwipeNavigation() {
    // Main movement views
    enableSwipeBackNavigation('view-workout-library', () => {
        switchAppTab('movement-tab');
    });

    enableSwipeBackNavigation('view-workout-subcategories', () => {
        closeWorkoutSubcategories();
    });

    enableSwipeBackNavigation('view-workout-list', () => {
        closeWorkoutList();
    });

    enableSwipeBackNavigation('view-workout-overview', () => {
        switchAppTab('movement-tab');
    });

    enableSwipeBackNavigation('view-active-workout', () => {
        quitWorkout();
    });

    enableSwipeBackNavigation('view-workout-success', () => {
        closeSuccessScreen();
    });
}

// Initialize swipe navigation when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    initializeMovementSwipeNavigation();
    initializeAndroidBackNavigation();
});

// ===========================
// ANDROID HARDWARE BACK BUTTON SUPPORT
// ===========================

// Navigation stack for Android back button
const navigationStack = [];

function pushNavigationState(viewId, backHandler) {
    // Only use history-based navigation on Android
    if (devicePlatform !== 'android') return;

    const state = { viewId, timestamp: Date.now() };
    navigationStack.push({ viewId, backHandler });
    history.pushState(state, '', window.location.href);
}

function popNavigationState() {
    return navigationStack.pop();
}

function clearNavigationStack() {
    navigationStack.length = 0;
}

function initializeAndroidBackNavigation() {
    // Only set up on Android
    if (devicePlatform !== 'android') return;

    // Handle browser/hardware back button via popstate
    window.addEventListener('popstate', (event) => {
        const navItem = popNavigationState();
        if (navItem && navItem.backHandler) {
            // Execute the back handler
            navItem.backHandler();
        }
    });
}

// Helper to navigate to a view with back support (Android)
function navigateToView(viewId, backHandler) {
    pushNavigationState(viewId, backHandler);
}

// ===========================
// WORKOUT LIBRARY FUNCTIONS
// ===========================

function openWorkoutLibrary() {
    renderWorkoutLibraryCategories();
    hideAllAppViews();
    document.getElementById('view-workout-library').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-library', () => switchAppTab('movement-tab'));
}

function renderWorkoutLibraryCategories() {
    const grid = document.getElementById('library-categories-grid');
    grid.innerHTML = '';

    Object.keys(WORKOUT_LIBRARY).forEach(categoryKey => {
        const category = WORKOUT_LIBRARY[categoryKey];

        grid.innerHTML += `
            <div class="library-category-card" onclick="openWorkoutSubcategories('${categoryKey}')">
                <div class="library-category-icon">${category.icon}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${category.name}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;">${category.description}</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--text-muted);">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        `;
    });
}

function openWorkoutSubcategories(categoryKey) {
    const category = WORKOUT_LIBRARY[categoryKey];

    // Set header
    document.getElementById('subcategory-header-title').textContent = category.name;
    document.getElementById('subcategory-description').textContent = category.description;

    // Render subcategories
    const grid = document.getElementById('subcategories-grid');
    grid.innerHTML = '';

    Object.keys(category.subcategories).forEach(subKey => {
        const subcategory = category.subcategories[subKey];
        const workoutCount = subcategory.workouts.length;

        grid.innerHTML += `
            <div class="library-category-card" onclick="openWorkoutList('${categoryKey}', '${subKey}')">
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${subcategory.name}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;">${subcategory.description}</div>
                    <div style="color: var(--primary); font-size: 0.8rem; font-weight: 600; margin-top: 8px;">${workoutCount} workout${workoutCount > 1 ? 's' : ''}</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--text-muted);">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        `;
    });

    // Show view
    document.getElementById('view-workout-subcategories').style.display = 'block';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-subcategories', () => closeWorkoutSubcategories());
}

function closeWorkoutSubcategories() {
    document.getElementById('view-workout-subcategories').style.display = 'none';
}

function openWorkoutList(categoryKey, subcategoryKey) {
    const category = WORKOUT_LIBRARY[categoryKey];
    const subcategory = category.subcategories[subcategoryKey];

    // Set header
    document.getElementById('workout-list-header-title').textContent = subcategory.name;
    document.getElementById('workout-list-description').textContent = subcategory.description;

    // Render workouts
    const list = document.getElementById('workouts-list');
    list.innerHTML = '';

    subcategory.workouts.forEach(workout => {
        const difficultyClass = `difficulty-${workout.difficulty.toLowerCase()}`;

        // Create card element
        const card = document.createElement('div');
        card.className = 'workout-card';
        card.style.cssText = 'cursor: pointer; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: rgba(4, 106, 56, 0.1);';

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 8px 0; font-size: 1.1rem;">${workout.name}</h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <span class="workout-difficulty-badge ${difficultyClass}">${workout.difficulty}</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">⏱ ${workout.duration}</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">📝 ${workout.exercises.length} exercises</span>
                    </div>
                </div>
            </div>
            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 10px;">
                <strong>Equipment:</strong> ${workout.equipment.join(', ')}
            </div>
        `;

        // Add click handler - directly start the workout (touch-action: manipulation already handles mobile responsiveness)
        card.addEventListener('click', () => {
            startLibraryWorkout(categoryKey, subcategoryKey, workout.id);
        });

        // Append to list
        list.appendChild(card);
    });

    // Show view
    document.getElementById('view-workout-list').style.display = 'block';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-list', () => closeWorkoutList());
}

function closeWorkoutList() {
    document.getElementById('view-workout-list').style.display = 'none';
}

function openLibraryWorkoutOverview(categoryKey, subcategoryKey, workoutId) {
    const category = WORKOUT_LIBRARY[categoryKey];
    const subcategory = category.subcategories[subcategoryKey];
    const workout = subcategory.workouts.find(w => w.id === workoutId);

    if (!workout) {
        console.error('Workout not found:', workoutId);
        return;
    }

    // Set header
    document.getElementById('overview-header-title').textContent = 'Workout Overview';

    // Set title and meta
    document.getElementById('overview-title').textContent = workout.name;
    document.getElementById('overview-meta').textContent = `${workout.duration} · ${workout.exercises.length} Exercises`;

    // Set equipment
    const equipmentContainer = document.getElementById('overview-equipment');
    equipmentContainer.innerHTML = '';
    workout.equipment.forEach(item => {
        equipmentContainer.innerHTML += `
            <span style="background: #f1f5f9; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; color: var(--text-main);">
                ${item}
            </span>
        `;
    });

    // Set instructions
    const instructionsText = `This is a ${workout.difficulty.toLowerCase()} level ${subcategory.name.toLowerCase()} workout. Complete all exercises in order, resting as needed between sets.`;
    document.getElementById('overview-instructions').textContent = instructionsText;

    // Set exercise list
    const exList = document.getElementById('overview-exercise-list');
    exList.innerHTML = '';
    workout.exercises.forEach(ex => {
        exList.innerHTML += `
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                <div style="width:70px; height:70px; border-radius:12px; background:#f1f5f9; flex-shrink:0; overflow:hidden;">
                    <img src="https://placehold.co/100x100/png?text=Ex" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <div style="flex:1;">
                    <div style="font-weight:700; font-size:1.05rem;">${ex.name}</div>
                    <div style="color:var(--text-muted); font-size:0.85rem;">${ex.sets} sets x ${ex.reps}</div>
                    <div style="color:var(--text-muted); font-size:0.8rem; margin-top:3px;">${ex.desc}</div>
                </div>
            </div>
        `;
    });

    // Set start button to launch library workout
    document.getElementById('btn-start-now').onclick = () => startLibraryWorkout(categoryKey, subcategoryKey, workoutId);

    // Show view
    hideAllAppViews();
    document.getElementById('view-workout-overview').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-overview', () => switchAppTab('movement-tab'));
}

// Store current workout key globally for customizations
window.currentWorkoutKey = null;
window.currentWorkoutCustomizations = null;

async function startLibraryWorkout(categoryKey, subcategoryKey, workoutId) {
    const category = WORKOUT_LIBRARY[categoryKey];
    const subcategory = category.subcategories[subcategoryKey];
    const workout = subcategory.workouts.find(w => w.id === workoutId);

    if (!workout) {
        console.error('Workout not found:', workoutId);
        return;
    }

    // Store current workout key for customizations
    window.currentWorkoutKey = `${categoryKey}/${subcategoryKey}/${workoutId}`;

    // Preload history if user is logged in
    const user = window.currentUser;
    let customizations = null;
    if (user) {
        try {
            window.workoutHistoryCache = await dbHelpers.workouts.getHistory(user.id);
            // Load workout customizations
            customizations = await dbHelpers.workoutCustomizations.get(user.id, window.currentWorkoutKey);
            window.currentWorkoutCustomizations = customizations;
        } catch(e) {
            console.error("Failed to load history/customizations", e);
        }
    }

    // Build exercise list with customizations applied
    let exercises = [...workout.exercises];

    // Apply customizations if they exist
    if (customizations) {
        // Filter out removed exercises
        const removedExercises = customizations.removed_exercises || [];
        exercises = exercises.filter(ex => !removedExercises.includes(ex.name));

        // Add user-added exercises at the end
        const addedExercises = customizations.added_exercises || [];
        exercises = exercises.concat(addedExercises.map(ex => ({
            ...ex,
            isUserAdded: true
        })));
    }

    // Set workout title and goal
    document.getElementById('workout-player-title').textContent = workout.name;
    const exerciseCount = exercises.length;
    document.getElementById('workout-player-goal').textContent = `${workout.difficulty} · ${workout.duration} · ${exerciseCount} Exercise${exerciseCount !== 1 ? 's' : ''}`;

    // Start timer
    window.workoutStartTime = Date.now();
    window.workoutTimer = setInterval(() => {
        const elapsed = Date.now() - window.workoutStartTime;
        const mins = Math.floor(elapsed / 60000);
        const secs = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('workout-timer').textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    }, 1000);

    // Render exercises
    renderWorkoutExercises(exercises);

    // Show workout player
    hideAllAppViews();
    document.getElementById('view-active-workout').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-active-workout', () => quitWorkout());
}

// Render workout exercises with delete buttons
function renderWorkoutExercises(exercises) {
    const container = document.getElementById('workout-exercises-list');
    container.innerHTML = '';

    exercises.forEach((ex, idx) => {
        const videoUrl = findVideoMatch(ex.name);
        const prevData = findPreviousSetData(ex.name);
        const isUserAdded = ex.isUserAdded || false;
        const escapedName = ex.name.replace(/'/g, "\\'");

        container.innerHTML += `
            <div class="exercise-logger-card" data-exercise-name="${ex.name}" data-is-user-added="${isUserAdded}">
                <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <span style="font-weight: 700; font-size: 1.05rem;">${ex.name}</span>
                                ${isUserAdded ? '<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">ADDED</span>' : ''}
                            </div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">${ex.desc || ''}</div>
                            ${prevData ? `<div style="color: var(--primary); font-size: 0.75rem; margin-top: 5px;">Last: ${prevData}</div>` : ''}
                        </div>
                        <button onclick="deleteExerciseFromWorkout('${escapedName}', ${isUserAdded})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; font-size: 0.8rem; font-weight: 600;">
                            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                ${videoUrl ? `
                <div data-video-container style="position: relative; width: 100%; padding-top: 56.25%; background: black; cursor: pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                    <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline>
                        <source src="${videoUrl}" type="video/mp4">
                    </video>
                    <div class="inline-play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                        <svg viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: var(--primary); margin-left: 3px;">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                </div>` : ''}

                <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                    <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div>
                </div>

                <div class="sets-list-container">
                    ${Array.from({length: ex.sets || 3}, (_, setIdx) => `
                        <div class="workout-set-row" style="display: grid; grid-template-columns: 40px 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 10px 15px; border-top: 1px solid #f8fafc;">
                            <div style="font-weight: 800; color: #94a3b8; font-size: 0.85rem; text-align: center;">${setIdx + 1}</div>
                            <input type="text" class="input-time" placeholder="-" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="time" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                            <input type="text" class="input-reps" placeholder="Reps" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="reps" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                            <input type="text" class="input-kg" placeholder="Kg" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="weight" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                        </div>
                    `).join('')}
                </div>

                <div style="padding:15px; border-top:1px solid #f8fafc;">
                    <button onclick="addWorkoutSet(this, '${escapedName}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
                </div>
            </div>
        `;
    });
}

// Delete exercise from workout
async function deleteExerciseFromWorkout(exerciseName, isUserAdded) {
    const user = window.currentUser;
    const workoutKey = window.currentWorkoutKey;

    if (!user || !workoutKey) {
        // Just remove from DOM if not logged in
        const card = document.querySelector(`.exercise-logger-card[data-exercise-name="${exerciseName}"]`);
        if (card && confirm('Remove this exercise from today\'s workout?')) {
            card.remove();
        }
        return;
    }

    // Ask user if they want to save this permanently
    const saveChoice = confirm(`Remove "${exerciseName}" from this workout?\n\nClick OK to remove it permanently (it won't show next time).\nClick Cancel to keep it.`);

    if (!saveChoice) return;

    try {
        // Remove from database
        await dbHelpers.workoutCustomizations.removeExercise(user.id, workoutKey, exerciseName);

        // Remove from DOM
        const card = document.querySelector(`.exercise-logger-card[data-exercise-name="${exerciseName}"]`);
        if (card) {
            card.remove();
        }

        // Update exercise count in header
        const remainingExercises = document.querySelectorAll('.exercise-logger-card').length;
        const goalEl = document.getElementById('workout-player-goal');
        if (goalEl) {
            const currentText = goalEl.textContent;
            goalEl.textContent = currentText.replace(/\d+ Exercise[s]?/, `${remainingExercises} Exercise${remainingExercises !== 1 ? 's' : ''}`);
        }

        console.log(`Exercise "${exerciseName}" removed from workout`);
    } catch (e) {
        console.error('Failed to remove exercise:', e);
        alert('Failed to remove exercise. Please try again.');
    }
}

// Open add exercise modal
function openAddExerciseModal() {
    document.getElementById('add-exercise-modal').style.display = 'block';
    document.getElementById('add-exercise-search').value = '';
    document.getElementById('add-exercise-results').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #94a3b8;">
            Type to search for exercises from your library
        </div>
    `;
    document.getElementById('add-exercise-search').focus();
}

// Close add exercise modal
function closeAddExerciseModal() {
    document.getElementById('add-exercise-modal').style.display = 'none';
}

// Search exercises for add modal
function searchExercisesForAdd(query) {
    const resultsContainer = document.getElementById('add-exercise-results');

    if (!query || query.length < 2) {
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                Type at least 2 characters to search
            </div>
        `;
        return;
    }

    // Search in EXERCISE_VIDEOS library
    if (typeof EXERCISE_VIDEOS === 'undefined') {
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                Exercise library not loaded
            </div>
        `;
        return;
    }

    const allExercises = Object.keys(EXERCISE_VIDEOS);
    const terms = query.toLowerCase().split(' ');
    const filteredExercises = allExercises.filter(name => {
        const nameLower = name.toLowerCase();
        return terms.every(term => nameLower.includes(term));
    });

    if (filteredExercises.length === 0) {
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                No exercises found matching "${query}"
            </div>
        `;
        return;
    }

    // Limit to first 50 results
    const displayExercises = filteredExercises.slice(0, 50);

    resultsContainer.innerHTML = displayExercises.map(name => {
        const escapedName = name.replace(/'/g, "\\'");
        return `
            <div onclick="selectExerciseToAdd('${escapedName}')" style="padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                <div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8;">
                        <path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-main);">${name}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Tap to add to workout</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--primary);">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
            </div>
        `;
    }).join('');

    if (displayExercises.length < filteredExercises.length) {
        resultsContainer.innerHTML += `
            <div style="text-align: center; padding: 15px; color: #94a3b8; font-size: 0.85rem;">
                Showing ${displayExercises.length} of ${filteredExercises.length} results. Refine your search for more specific results.
            </div>
        `;
    }
}

// Select exercise to add
async function selectExerciseToAdd(exerciseName) {
    const user = window.currentUser;
    const workoutKey = window.currentWorkoutKey;

    // Create exercise object
    const newExercise = {
        name: exerciseName,
        sets: 3,
        reps: '8-12',
        desc: 'Custom exercise added by you',
        isUserAdded: true
    };

    // Ask user if they want to save permanently
    const saveChoice = confirm(`Add "${exerciseName}" to this workout?\n\nClick OK to save it permanently (it will appear every time you do this workout).\nClick Cancel to just add it for today.`);

    // Add to UI immediately
    addExerciseToUI(newExercise);
    closeAddExerciseModal();

    // Save to database if user confirmed and is logged in
    if (saveChoice && user && workoutKey) {
        try {
            await dbHelpers.workoutCustomizations.addExercise(user.id, workoutKey, {
                name: exerciseName,
                sets: 3,
                reps: '8-12',
                desc: 'Custom exercise added by you'
            });
            console.log(`Exercise "${exerciseName}" saved to workout permanently`);
        } catch (e) {
            console.error('Failed to save exercise to database:', e);
            // Exercise is already added to UI, just log the error
        }
    }
}

// Add exercise to UI
function addExerciseToUI(exercise) {
    const container = document.getElementById('workout-exercises-list');
    const videoUrl = findVideoMatch(exercise.name);
    const prevData = findPreviousSetData(exercise.name);
    const escapedName = exercise.name.replace(/'/g, "\\'");

    const exerciseHtml = `
        <div class="exercise-logger-card" data-exercise-name="${exercise.name}" data-is-user-added="true" style="animation: slideInUp 0.3s ease;">
            <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <span style="font-weight: 700; font-size: 1.05rem;">${exercise.name}</span>
                            <span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">ADDED</span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">${exercise.desc || ''}</div>
                        ${prevData ? `<div style="color: var(--primary); font-size: 0.75rem; margin-top: 5px;">Last: ${prevData}</div>` : ''}
                    </div>
                    <button onclick="deleteExerciseFromWorkout('${escapedName}', true)" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; font-size: 0.8rem; font-weight: 600;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>

            ${videoUrl ? `
            <div data-video-container style="position: relative; width: 100%; padding-top: 56.25%; background: black; cursor: pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: var(--primary); margin-left: 3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div>
            </div>

            <div class="sets-list-container">
                ${Array.from({length: exercise.sets || 3}, (_, setIdx) => `
                    <div class="workout-set-row" style="display: grid; grid-template-columns: 40px 1fr 1fr 1fr; gap: 8px; align-items: center; padding: 10px 15px; border-top: 1px solid #f8fafc;">
                        <div style="font-weight: 800; color: #94a3b8; font-size: 0.85rem; text-align: center;">${setIdx + 1}</div>
                        <input type="text" class="input-time" placeholder="-" data-exercise="${exercise.name}" data-set="${setIdx + 1}" data-field="time" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                        <input type="text" class="input-reps" placeholder="Reps" data-exercise="${exercise.name}" data-set="${setIdx + 1}" data-field="reps" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                        <input type="text" class="input-kg" placeholder="Kg" data-exercise="${exercise.name}" data-set="${setIdx + 1}" data-field="weight" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                    </div>
                `).join('')}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${escapedName}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', exerciseHtml);

    // Update exercise count in header
    const exerciseCount = document.querySelectorAll('.exercise-logger-card').length;
    const goalEl = document.getElementById('workout-player-goal');
    if (goalEl) {
        const currentText = goalEl.textContent;
        goalEl.textContent = currentText.replace(/\d+ Exercise[s]?/, `${exerciseCount} Exercise${exerciseCount !== 1 ? 's' : ''}`);
    }

    // Scroll to the new exercise
    const newCard = container.lastElementChild;
    if (newCard) {
        newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// Update hideAllAppViews to include new views
const originalHideAllAppViews = hideAllAppViews;
hideAllAppViews = function() {
    originalHideAllAppViews();
    const libraryViews = ['view-workout-library', 'view-workout-subcategories', 'view-workout-list'];
    libraryViews.forEach(v => {
        const el = document.getElementById(v);
        if(el) {
            el.style.display = 'none';
        }
    });
};

</script>
<!-- Image Modal HTML -->
<div class="image-modal-overlay" id="imageModal" onclick="closeImageModal()">
<div class="close-modal-btn"></div>
<img alt="Full size meal" class="image-modal-content" id="modalImage" onclick="event.stopPropagation()" src=""/>
</div>
<script>
// Image Modal Logic
document.addEventListener('DOMContentLoaded', function() {
    const mealImages = document.querySelectorAll('.card-body img');
    mealImages.forEach(img => {
        img.addEventListener('click', function(e) {
            e.stopPropagation(); 
            openImageModal(this.src, this.alt);
        });
    });
});

function openImageModal(src, alt) {
    const modal = document.getElementById('imageModal');
    const img = document.getElementById('modalImage');
    img.src = src;
    img.alt = alt || 'Meal Image';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden'; 
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.classList.remove('active');
    document.body.style.overflow = ''; 
    setTimeout(() => {
        document.getElementById('modalImage').src = '';
    }, 300); 
}

// Close on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") {
        closeImageModal();
    }
});

function showSupportTab(tab, btn) {
    // 1. Toggle Buttons
    const container = btn.parentElement;
    container.querySelectorAll('button').forEach(b => {
        b.classList.remove('active');
        b.style.background = 'transparent';
        b.style.color = '#718096';
    });
    btn.classList.add('active');
    btn.style.background = 'white';
    btn.style.color = 'var(--primary)';

    // 2. Toggle Content
    const chat = document.getElementById('support-chat');
    const comm = document.getElementById('support-community');
    const refl = document.getElementById('support-reflections');

    if (tab === 'chat') {
        chat.style.display = 'flex';
        comm.style.display = 'none';
        refl.style.display = 'none';
        // Scroll to bottom of chat messages after a short delay to ensure content is rendered
        setTimeout(() => {
            const chatContainer = document.getElementById('chat-messages-container');
            if (chatContainer) {
                const rect = chatContainer.getBoundingClientRect();
                const absoluteBottom = rect.bottom + window.pageYOffset;
                window.scrollTo({
                    top: absoluteBottom - window.innerHeight + 100, // 100px buffer for input box
                    behavior: 'smooth'
                });
            }
        }, 100);
    } else if (tab === 'community') {
        chat.style.display = 'none';
        comm.style.display = 'flex';
        refl.style.display = 'none';
        loadCommunityFeed(); // Refresh feed when opening
    } else if (tab === 'reflections') {
        chat.style.display = 'none';
        comm.style.display = 'none';
        refl.style.display = 'flex';
        loadAllReflections(); // Load reflections when opening
    }
}

// Helper function to scroll to bottom of chat messages (for single page scroll)
function scrollToBottomOfChat() {
    const chatContainer = document.getElementById('chat-messages-container');
    if (chatContainer) {
        const rect = chatContainer.getBoundingClientRect();
        const absoluteBottom = rect.bottom + window.pageYOffset;
        window.scrollTo({
            top: absoluteBottom - window.innerHeight + 100,
            behavior: 'smooth'
        });
    }
}

// Consolidated Chat Logic (Old versions removed)


// Old chat logic removed.

// --- COMMUNITY CHAT LOGIC (HUMAN REFERRAL NETWORK ONLY) ---

function loadCommunityFeed() {
    let messages = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
    if(messages.length === 0) {
        const sysMsg = {
            id: 'sys_' + Date.now(),
            isSystem: true,
            text: `Community group started`,
            timestamp: Date.now()
        };
        messages.push(sysMsg);
        localStorage.setItem('community_chat_history', JSON.stringify(messages));
    }
    renderChat(messages);
}

function renderChat(messages) {
    const container = document.getElementById('community-chat-stream');
    if(!container) return;

    // 1. Build a single massive string instead of touching the DOM repeatedly
    let fullHtml = '';

    messages.forEach((msg, msgIndex) => {
        const isMe = !msg.authorId || msg.authorId === 'current-user';

        // For other users, show their avatar and name
        let avatarHtml = '';
        let authorName = '';
        if(!isMe && msg.authorName) {
             // Use user's profile photo if available, otherwise use initials
             if (msg.authorAvatar) {
                 avatarHtml = `<img src="${msg.authorAvatar}" style="width:32px; height:32px; border-radius:50%; flex-shrink:0; align-self:flex-end; margin-bottom:5px; object-fit:cover;">`;
             } else {
                 const initials = msg.authorName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                 avatarHtml = `<div style="width:32px; height:32px; border-radius:50%; flex-shrink:0; align-self:flex-end; margin-bottom:5px; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:0.75rem; font-weight:600;">${initials}</div>`;
             }
             authorName = msg.authorName;
        }

        const bBg = isMe ? 'var(--chat-bg-user)' : 'var(--chat-bg-coach)';
        const bText = isMe ? 'var(--chat-text-user)' : 'var(--chat-text-coach)';
        const bRadius = isMe ? '18px 18px 0 18px' : '18px 18px 18px 0';
        const bBorder = isMe ? 'none' : '1px solid var(--chat-border-coach)';
        const alignStyle = isMe ? "justify-content: flex-end;" : "justify-content: flex-start;";

        // Emoji reactions (keeping for human interactions)
        let reactionsHtml = '';
        if (msg.reactions && msg.reactions.length > 0) {
            const reactionCounts = {};
            msg.reactions.forEach(r => {
                reactionCounts[r.emoji] = (reactionCounts[r.emoji] || 0) + 1;
            });
            reactionsHtml = '<div style="display:flex; gap:4px; margin-top:4px; margin-left:10px; flex-wrap:wrap;">';
            Object.entries(reactionCounts).forEach(([emoji, count]) => {
                reactionsHtml += `<span style="font-size:0.85rem; background:#f1f5f9; padding:2px 6px; border-radius:10px; border:1px solid #e2e8f0;">${emoji} ${count > 1 ? count : ''}</span>`;
            });
            reactionsHtml += '</div>';
        }

        let messageHtml = '';
        if (msg.isSystem) {
            messageHtml = `<div style="text-align:center; margin: 20px 0; color:#94a3b8; font-size:0.8rem; font-weight:600; text-transform:uppercase; letter-spacing:1px;">${msg.text}</div>`;
        } else {
            messageHtml = `
            <div style="display:flex; ${alignStyle} margin-bottom: 12px; gap: 8px;">
                ${(!isMe && authorName) ? avatarHtml : ''}
                <div style="display:flex; flex-direction:column; max-width:75%; ${isMe ? 'align-items:flex-end;' : 'align-items:flex-start;'}">
                    ${(!isMe && authorName) ? `<div style="font-size:0.7rem; color:var(--text-muted); margin-left:10px; margin-bottom:2px;">${authorName}</div>` : ''}
                    <div>
                        <div style="padding: 10px 15px; font-size: 0.95rem; line-height: 1.4; background: ${bBg}; color: ${bText}; border-radius: ${bRadius}; border: ${bBorder}; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                            ${msg.text}
                        </div>
                        ${reactionsHtml}
                    </div>
                </div>
            </div>`;
        }

        // Append to string, NOT DOM
        fullHtml += messageHtml;
    });

    // 2. Update DOM exactly once
    container.innerHTML = fullHtml;
    container.scrollTop = container.scrollHeight;
}

</script>

<!-- COACH DASHBOARD STYLES -->
<style>
    /* Coach Dashboard Specific Styles */
    #view-coach-dashboard {
        display: none; /* Hidden by default */
        position: fixed;
        inset: 0;
        background: #f8fafc;
        z-index: 10000;
        overflow-y: auto;
        font-family: 'Inter', sans-serif;
    }

    .coach-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        min-height: 100vh;
    }

    /* Sidebar */
    .coach-sidebar {
        background: #0f172a;
        color: white;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .coach-logo {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        margin-bottom: 40px;
        color: var(--secondary);
    }

    .coach-nav-item {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #94a3b8;
        transition: all 0.2s;
    }

    .coach-nav-item:hover, .coach-nav-item.active {
        background: rgba(255,255,255,0.1);
        color: white;
    }

    /* Main Content */
    .coach-main {
        padding: 30px;
        overflow-y: auto;
    }

    .coach-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .coach-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1e293b;
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
    }

    .d-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }

    .d-card h3 {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #334155;
        border-bottom: 1px solid #f1f5f9;
        padding-bottom: 10px;
    }

    /* Compliance Snapshots */
    .compliance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 10px;
    }
    
    .compliance-dot {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
        position: relative;
    }
    .status-warning { background: #F59E0B; }
    .status-danger { background: #EF4444; }
    .status-good { background: #10B981; }

    /* Activity Feed */
    .activity-item {
        display: flex;
        gap: 15px;
        padding: 12px 0;
        border-bottom: 1px solid #f1f5f9;
    }
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Mobile Responsive adjustment for Coach View */
    @media (max-width: 768px) {
        .coach-layout { grid-template-columns: 1fr; }
        .coach-sidebar { display: none; } /* Add a mobile toggler later if needed, assume desktop for "Command Center" initially */
        .dashboard-grid { grid-template-columns: 1fr; }
    }
</style>

<!-- COACH DASHBOARD HTML -->
<div id="view-coach-dashboard-REMOVED" style="display:none !important;">
    <div class="coach-layout">
        <!-- Sidebar -->
        <div class="coach-sidebar">
            <div class="coach-logo">Shannon (Coach)</div>
            <div class="coach-nav-item active" onclick="showCoachSection('overview')">
                <span>🏠</span> Overview
            </div>
            <div class="coach-nav-item" onclick="showCoachSection('clients')">
                <span>👥</span> Clients
            </div>
            <div class="coach-nav-item" onclick="showCoachSection('messages')">
                <span>💬</span> Messages <span class="badge" style="background:red; padding:2px 6px; border-radius:10px; font-size:0.7rem;">3</span>
            </div>
            <div class="coach-nav-item" onclick="showCoachSection('calendar')">
                <span>📅</span> User Calendar
            </div>
             <div style="margin-top:auto;">
                <div class="coach-nav-item" onclick="toggleCoachMode(false)">
                    <span>🚪</span> Exit Coach Mode
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="coach-main">
            <!-- SECTION: OVERVIEW -->
            <div id="coach-sec-overview">
                <div class="coach-header">
                    <div>
                        <div class="coach-title">Command Center</div>
                        <div style="color:#64748b;">Welcome back, Shannon. Here is what's happening today.</div>
                    </div>
                    <button class="app-btn" style="width: auto; padding: 10px 20px;">+ Quick Add</button>
                </div>

                <div class="dashboard-grid">
                    <!-- Left Col -->
                    <div>
                        <!-- Compliance -->
                        <div class="d-card">
                            <h3>Compliance Snapshots</h3>
                            <div class="compliance-grid" id="compliance-container">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="d-card">
                            <h3>Recent Activity</h3>
                            <div id="activity-feed-container">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Col -->
                    <div>
                        <!-- Pending Requests -->
                        <div class="d-card">
                            <h3>Pending Requests (3)</h3>
                            <div class="activity-item">
                                <div class="activity-icon" style="background:#FEF3C7; color:#D97706;">??</div>
                                <div>
                                    <div style="font-weight:600;">Consultation Form</div>
                                    <div style="font-size:0.85rem; color:#64748b;">New Client Application</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon" style="background:#DBEAFE; color:#2563EB;">??</div>
                                <div>
                                    <div style="font-weight:600;">Payment Failed</div>
                                    <div style="font-size:0.85rem; color:#64748b;">Sarah J. - Subscription</div>
                                </div>
                            </div>
                        </div>

                        <!-- Daily Schedule -->
                        <div class="d-card">
                            <h3>Daily Schedule</h3>
                            <div class="activity-item">
                                <div style="font-weight:bold; color:var(--primary); width:50px;">09:00</div>
                                <div>Check-in Review</div>
                            </div>
                            <div class="activity-item">
                                <div style="font-weight:bold; color:var(--primary); width:50px;">14:30</div>
                                <div>Call with Jessica</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: CLIENTS (Deep Dive) -->
            <div id="coach-sec-clients" style="display:none;">
                <div class="coach-header">
                    <div class="coach-title">Client Profiles</div>
                    <input type="text" placeholder="Search clients..." style="padding:10px; border-radius:8px; border:1px solid #ccc;">
                </div>
                <!-- Simple Client List for Selection -->
                <div class="d-card" id="client-list-view">
                    <h3>All Clients</h3>
                    <div id="coach-client-list"></div>
                </div>

                <!-- SINGLE CLIENT VIEW (Hidden by default) -->
                <div id="single-client-view" style="display:none;">
                    <button onclick="closeClientProfile()" style="margin-bottom:20px; background:none; border:none; color:#64748b; cursor:pointer;">? Back to List</button>
                    
                    <div class="d-card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; gap:20px; align-items:center;">
                            <div id="sc-avatar" style="width:60px; height:60px; background:var(--primary); border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-size:1.5rem;">SJ</div>
                            <div>
                                <h2 id="sc-name" style="margin:0; font-size:1.5rem;">Sarah Jenkins</h2>
                                <div id="sc-status" style="color:#64748b;">Active  Wk 3  Cortisol Reset</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="app-btn" style="width:auto; background:var(--secondary);" onclick="openAsClient()">Open App as Client</button>
                            <button class="app-btn" style="width:auto;">Message</button>
                        </div>
                    </div>

                    <!-- Client Tabs -->
                    <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #e2e8f0;">
                        <div class="coach-nav-item active" style="color:var(--primary); border-bottom:2px solid var(--primary); border-radius:0;">Dash</div>
                        <div class="coach-nav-item" style="color:#64748b;">Progress</div>
                        <div class="coach-nav-item" style="color:#64748b;">Training</div>
                        <div class="coach-nav-item" style="color:#64748b;">Nutrition</div>
                        <div class="coach-nav-item" style="color:#64748b;">Notes ??</div>
                    </div>

                    <div class="dashboard-grid">
                        <!-- Stats Tiles -->
                        <div style="grid-column: 1 / -1; display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:20px;">
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">WEIGHT</div>
                                <div style="font-size:1.5rem; font-weight:bold;">64.5kg</div>
                                <div style="color:green; font-size:0.8rem;">? 0.5kg</div>
                            </div>
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">BODY FAT</div>
                                <div style="font-size:1.5rem; font-weight:bold;">22%</div>
                                <div style="color:green; font-size:0.8rem;">? 1.2%</div>
                            </div>
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">RHR</div>
                                <div style="font-size:1.5rem; font-weight:bold;">58</div>
                                <div style="color:green; font-size:0.8rem;">? 4 bpm</div>
                            </div>
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">KCALS</div>
                                <div style="font-size:1.5rem; font-weight:bold;">1850</div>
                                <div style="color:orange; font-size:0.8rem;">Avg</div>
                            </div>
                        </div>

                        <!-- Left: Photos & Badges -->
                        <div class="d-card">
                            <h3>Progress Photos</h3>
                            <div style="display:flex; gap:10px;">
                                <div style="flex:1; background:#f1f5f9; aspect-ratio:3/4; display:flex; align-items:center; justify-content:center; border-radius:8px;">Front</div>
                                <div style="flex:1; background:#f1f5f9; aspect-ratio:3/4; display:flex; align-items:center; justify-content:center; border-radius:8px;">Side</div>
                            </div>
                        </div>

                        <!-- Right: Trainer Notes -->
                        <div class="d-card">
                            <h3>Trainer Notes ??</h3>
                            <textarea style="width:100%; height:150px; border:1px solid #e2e8f0; border-radius:8px; padding:10px;" placeholder="Private notes about this client..."></textarea>
                            <button class="app-btn" style="width:auto; margin-top:10px;">Save Note</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Other sections (Calendar, Messages) placeholders -->
            <div id="coach-sec-messages" style="display:none;">
                <div class="coach-header"><div class="coach-title">Messages</div></div>
                <div class="d-card">
                     <p>Message Center Implementation Pending...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// COACH MODE LOGIC

// Real clients loaded from Supabase
let REAL_CLIENTS = [];

// Primary toggleCoachMode defined below in AI section

async function initCoachDashboard() {
    console.log('🎛️ Initializing Coach Dashboard...');
    await loadRealClients();
    renderComplianceGrid();
    renderActivityFeed();
    renderClientList();
}

async function loadRealClients() {
    try {
        // Fetch all users from Supabase
        const users = await dbHelpers.users.getAll();
        
        REAL_CLIENTS = await Promise.all(users.map(async (user) => {
            // Get last check-in to determine status
            let status = 'good';
            let lastAct = 'No recent activity';
            
            try {
                // Get their most recent conversation
                const history = await dbHelpers.conversations.getHistory(user.id, 'coach', 1);
                if (history && history.length > 0) {
                    const lastMsg = history[history.length - 1];
                    const msgDate = new Date(lastMsg.timestamp);
                    const daysDiff = Math.floor((Date.now() - msgDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff === 0) lastAct = 'Messaged today';
                    else if (daysDiff === 1) lastAct = 'Messaged yesterday';
                    else if (daysDiff < 7) lastAct = `Messaged ${daysDiff} days ago`;
                    else lastAct = `Inactive ${daysDiff} days`;
                    
                    // Set status based on activity
                    if (daysDiff > 7) status = 'danger';
                    else if (daysDiff > 3) status = 'warning';
                }
            } catch (e) { console.warn('Could not get activity for user', user.id); }
            
            // Calculate program day
            let programDay = 0;
            if (user.program_start_date) {
                const start = new Date(user.program_start_date);
                programDay = Math.ceil((Date.now() - start) / (1000 * 60 * 60 * 24));
            }
            
            // Get initials for avatar
            const name = user.name || user.email?.split('@')[0] || 'User';
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            return {
                id: user.id,
                name: name,
                email: user.email,
                status: status,
                avatar: initials,
                lastAct: lastAct,
                programDay: programDay,
                startDate: user.program_start_date,
                profile: user.profile || 'Standard',
                lastLogin: user.last_login
            };
        }));
        
        console.log(`✅ Loaded ${REAL_CLIENTS.length} clients from database`);
    } catch (error) {
        console.error('Failed to load clients:', error);
        REAL_CLIENTS = [];
    }
}

function renderComplianceGrid() {
    const container = document.getElementById('compliance-container');
    if (REAL_CLIENTS.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-style:italic;">No clients found</div>';
        return;
    }
    container.innerHTML = REAL_CLIENTS.map(c => `
        <div class="compliance-dot status-${c.status}" onclick="openClientProfile('${c.id}')" title="${c.name} - ${c.lastAct}">
            ${c.avatar}
        </div>
    `).join('');
}

function renderActivityFeed() {
    const container = document.getElementById('activity-feed-container');
    
    // Build activity from real clients
    const activities = REAL_CLIENTS
        .filter(c => c.lastAct && c.lastAct !== 'No recent activity')
        .slice(0, 5)
        .map(c => ({
            name: c.name,
            action: c.lastAct,
            icon: c.status === 'good' ? '✅' : c.status === 'warning' ? '⚠️' : '🔴'
        }));
    
    if (activities.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-style:italic;">No recent activity</div>';
        return;
    }
    
    container.innerHTML = activities.map(a => `
        <div class="activity-item">
            <div class="activity-icon">${a.icon}</div>
            <div>
                <div style="font-weight:600;">${a.name}</div>
                <div style="font-size:0.85rem; color:#64748b;">${a.action}</div>
            </div>
        </div>
    `).join('');
}

function showCoachSection(secId) {
    // Hide all
    ['overview', 'clients', 'messages'].forEach(id => {
        const el = document.getElementById('coach-sec-' + id);
        if(el) el.style.display = 'none';
    });
    
    // Show selected
    document.getElementById('coach-sec-' + secId).style.display = 'block';
}

function renderClientList() {
    const container = document.getElementById('coach-client-list');
    
    if (REAL_CLIENTS.length === 0) {
        container.innerHTML = '<div style="padding:20px; color:#64748b; font-style:italic;">No clients registered yet.</div>';
        return;
    }
    
    container.innerHTML = REAL_CLIENTS.map(c => `
        <div class="activity-item" style="cursor:pointer;" onclick="openClientProfile('${c.id}')">
            <div class="activity-icon" style="background:${c.status === 'danger' ? '#FEE2E2' : c.status === 'warning' ? '#FEF3C7' : '#F1F5F9'}">${c.avatar}</div>
            <div style="flex:1;">
                <div style="font-weight:600;">${c.name}</div>
                <div style="font-size:0.85rem; color:#64748b;">${c.email || ''}</div>
                <div style="font-size:0.75rem; color:#94a3b8; margin-top:2px;">Day ${c.programDay || '?'} • ${c.lastAct}</div>
            </div>
            <div style="color:var(--primary);">→</div>
        </div>
    `).join('');
}

async function openClientProfile(clientId) {
    document.getElementById('client-list-view').style.display = 'none';
    document.getElementById('single-client-view').style.display = 'block';
    
    const client = REAL_CLIENTS.find(c => c.id === clientId);
    if (!client) {
        console.error('Client not found:', clientId);
        return;
    }
    
    // Update header
    document.getElementById('sc-name').innerText = client.name;
    document.getElementById('sc-avatar').innerText = client.avatar;
    document.getElementById('sc-status').innerHTML = `
        <span style="color:${client.status === 'good' ? 'green' : client.status === 'warning' ? 'orange' : 'red'};">●</span>
        Day ${client.programDay || '?'} • ${client.profile} • ${client.email}
    `;
    
    // Try to get more detailed stats
    try {
        // Get their full chat history
        const chatHistory = await dbHelpers.conversations.getHistory(clientId, 'coach', 50);
        
        // Update the stats grid
        const statsGrid = document.querySelector('#single-client-view .dashboard-grid > div:first-child');
        if (statsGrid) {
            statsGrid.innerHTML = `
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">PROGRAM DAY</div>
                    <div style="font-size:1.5rem; font-weight:bold;">${client.programDay || '-'}</div>
                    <div style="color:var(--primary); font-size:0.8rem;">of 28</div>
                </div>
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">MESSAGES</div>
                    <div style="font-size:1.5rem; font-weight:bold;">${chatHistory.length}</div>
                    <div style="color:#64748b; font-size:0.8rem;">Total</div>
                </div>
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">LAST ACTIVE</div>
                    <div style="font-size:1rem; font-weight:bold;">${client.lastAct}</div>
                </div>
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">PROFILE</div>
                    <div style="font-size:1rem; font-weight:bold;">${client.profile}</div>
                </div>
            `;
        }
        
        // Add chat history viewer
        renderClientChatHistory(chatHistory);
        
    } catch (error) {
        console.error('Failed to load client details:', error);
    }
}

function renderClientChatHistory(history) {
    // Find or create chat history container
    let container = document.getElementById('client-chat-history');
    if (!container) {
        // Create container if it doesn't exist
        const singleView = document.getElementById('single-client-view');
        const existingGrid = singleView.querySelector('.dashboard-grid');
        
        const chatCard = document.createElement('div');
        chatCard.className = 'd-card';
        chatCard.style.gridColumn = '1 / -1';
        chatCard.innerHTML = `
            <h3>💬 Conversation History</h3>
            <div id="client-chat-history" style="max-height:400px; overflow-y:auto; padding:10px; background:#f8fafc; border-radius:12px;"></div>
        `;
        existingGrid.appendChild(chatCard);
        container = document.getElementById('client-chat-history');
    }
    
    if (history.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-style:italic; padding:10px;">No messages yet.</div>';
        return;
    }
    
    container.innerHTML = history.map(msg => {
        const isUser = msg.role === 'user';
        const time = msg.brisbane_time || new Date(msg.timestamp).toLocaleString();
        return `
            <div style="display:flex; gap:10px; margin-bottom:12px; ${isUser ? 'justify-content:flex-end;' : ''}">
                ${!isUser ? '<div style="width:32px; height:32px; background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; flex-shrink:0;">🤖</div>' : ''}
                <div style="max-width:70%; ${isUser ? 'background:#064e3b; color:white;' : 'background:white; border:1px solid #e2e8f0;'} padding:10px 14px; border-radius:16px;">
                    <div style="font-size:0.9rem; white-space:pre-wrap;">${msg.message_text}</div>
                    <div style="font-size:0.7rem; ${isUser ? 'color:rgba(255,255,255,0.7);' : 'color:#94a3b8;'} margin-top:5px;">${time}</div>
                </div>
                ${isUser ? '<div style="width:32px; height:32px; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; flex-shrink:0;">👤</div>' : ''}
            </div>
        `;
    }).join('');
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function closeClientProfile() {
    document.getElementById('single-client-view').style.display = 'none';
    document.getElementById('client-list-view').style.display = 'block';
}

function openAsClient() {
    // Switch to normal dashboard view
    toggleCoachMode(false);
    // Ideally we would load the specific client's data into the view
    // For "Current User", it's already there.
    // For others, we'd need to mock swap the data, but for this task we'll just close the coach view
    // and show the "Current" view as a demo of the "Open" functionality.
}

</script>

<!-- CHECK-IN MODAL (Moved to root) -->
<div id="checkin-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10005; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
    <div style="background:white; width:90%; max-width:400px; border-radius:24px; padding:30px; position:relative; animation: slideUp 0.3s ease-out;">
        <h2 style="color:var(--primary); margin:0 0 10px 0; text-align:center;">Daily Check-in</h2>
        <p style="text-align:center; color:#64748b; margin-bottom:25px; font-size:0.95rem;">Let's customize your session for today.</p>

        <!-- Step 1: Energy -->
        <div style="margin-bottom:20px;">
            <label style="display:block; font-weight:600; margin-bottom:10px; color:var(--text-main);">How is your energy?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="selectEnergy('high')" id="btn-energy-high" class="checkin-btn" style="padding:15px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer; transition:all 0.2s;">
                    <div style="font-size:1.5rem;">⚡</div>
                    <div style="font-weight:600; margin-top:5px;">High</div>
                </button>
                <button onclick="selectEnergy('low')" id="btn-energy-low" class="checkin-btn" style="padding:15px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer; transition:all 0.2s;">
                    <div style="font-size:1.5rem;">🪫</div>
                    <div style="font-weight:600; margin-top:5px;">Low</div>
                </button>
            </div>
        </div>

        <!-- Step 2: Equipment -->
        <div style="margin-bottom:30px;">
            <label style="display:block; font-weight:600; margin-bottom:10px; color:var(--text-main);">Equipment Access?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <button onclick="selectEquipment('none')" id="btn-eq-none" class="checkin-btn" style="padding:10px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer;">
                    <span style="font-size:1.2rem;">🧘</span><br><span style="font-size:0.8rem; font-weight:600;">None</span>
                </button>
                <button onclick="selectEquipment('dumbbells')" id="btn-eq-dumbbells" class="checkin-btn" style="padding:10px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer;">
                    <span style="font-size:1.2rem;">🏋️</span><br><span style="font-size:0.8rem; font-weight:600;">Dumbbells</span>
                </button>
                <button onclick="selectEquipment('gym')" id="btn-eq-gym" class="checkin-btn" style="padding:10px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer;">
                    <span style="font-size:1.2rem;">🏢</span><br><span style="font-size:0.8rem; font-weight:600;">Gym</span>
                </button>
            </div>
        </div>

        <button onclick="submitCheckIn()" style="width:100%; background:var(--primary); color:white; border:none; padding:16px; border-radius:50px; font-weight:700; font-size:1rem; cursor:pointer;">Build My Workout</button>
    </div>
</div>


<!-- Cycle Tracking Modal -->
<div class="onboarding-overlay" id="cycle-tracking-modal" style="display:none; z-index:12000;">
    <div class="onboarding-modal" style="max-width: 450px; padding: 0; overflow: hidden;">

        <!-- HEADER -->
        <div style="padding: 25px 25px 0 25px; text-align: center; position:relative;">
            <div onclick="closeCycleTrackingModal()" style="position:absolute; top:15px; right:15px; width:30px; height:30px; line-height:30px; background:#f1f5f9; border-radius:50%; cursor:pointer; font-size:1.2rem; color:#64748b; font-weight:bold;">&times;</div>
            <h2 style="margin:0; color:var(--primary);">Cycle Tracking</h2>
        </div>

        <!-- CONTENT -->
        <div style="padding: 25px;">
            <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🌸</div>
            <h3 style="text-align:center; margin-bottom:10px;">Cycle Syncing</h3>
            <p style="text-align:center; color:#666; margin-bottom:25px;">We tailor your daily movement to match your hormonal phase.</p>

            <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">When was your last period?</label>
                <input type="date" id="cycle-modal-period-date" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
            </div>

            <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Cycle Length (Days)</label>
                <input type="number" id="cycle-modal-cycle-length" value="28" min="21" max="35" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
            </div>

            <div style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:20px;">
                <input type="checkbox" id="cycle-modal-wellness-toggle">
                <label for="cycle-modal-wellness-toggle" style="font-size:0.9rem; color:#64748b;">I don't have a period (Wellness Mode)</label>
            </div>

            <button onclick="saveCycleTrackingData()" style="width:100%; background:var(--primary); color:white; border:none; padding:16px; border-radius:50px; font-weight:700; font-size:1rem; cursor:pointer;">Save Changes</button>
        </div>
    </div>
</div>

<!-- Onboarding Modal -->
<!-- ONBOARDING WIZARD -->
<div class="onboarding-overlay" id="onboarding-wizard" style="display:none; z-index:12000;">
    <div class="onboarding-modal wizard-container" style="max-width: 450px; max-height: 90vh; padding: 0; overflow: hidden; display: flex; flex-direction: column;">

        <!-- HEADER -->
        <div class="wizard-header" style="padding: 25px 25px 0 25px; text-align: center; position:relative; flex-shrink: 0;">
            <div onclick="closeWizardManually()" style="position:absolute; top:15px; right:15px; width:30px; height:30px; line-height:30px; background:#f1f5f9; border-radius:50%; cursor:pointer; font-size:1.2rem; color:#64748b; font-weight:bold;">&times;</div>
            <div class="wizard-progress" style="display:flex; justify-content:center; gap:8px; margin-bottom:15px;">
                <div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <h2 id="wizard-title" style="margin:0; color:var(--primary);">Let's Align Your Body</h2>
        </div>

        <!-- CONTENT SLIDES -->
        <div class="wizard-content" style="flex: 1; padding: 25px; overflow-y: auto; min-height: 0;">

            <!-- SLIDE 1: GENDER SELECTION -->
            <div class="wizard-slide active" id="slide-1">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🌟</div>
                <h3 style="text-align:center; margin-bottom:10px;">Welcome to Your Journey</h3>
                <p style="text-align:center; color:#666; margin-bottom:30px;">Select your program to get started:</p>

                <div style="display:flex; flex-direction:column; gap:15px; max-width:300px; margin:0 auto;">
                    <button type="button" id="gender-btn-female" onclick="selectGender('female')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">🌸</span>
                        <span>For Her</span>
                    </button>

                    <button type="button" id="gender-btn-male" onclick="selectGender('male')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">💪</span>
                        <span>For Him</span>
                    </button>
                </div>

                <input type="hidden" id="wizard-gender" value="">
            </div>

            <!-- SLIDE 2: ESSENTIAL DATA COLLECTION -->
            <div class="wizard-slide" id="slide-2" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">📋</div>
                <h3 style="text-align:center; margin-bottom:10px;">Let's Get Started</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">We need a few details to personalize your program.</p>

                <!-- Name -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">What's your name?</label>
                    <input type="text" id="wizard-name" class="wizard-input" placeholder="Enter your name" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Age -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Age</label>
                    <input type="number" id="wizard-age" class="wizard-input" placeholder="25" min="18" max="100" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Height & Weight -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Height (cm)</label>
                        <input type="number" id="wizard-height" class="wizard-input" placeholder="170" min="100" max="250" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Weight (kg)</label>
                        <input type="number" id="wizard-weight" class="wizard-input" placeholder="70" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                </div>

                <!-- Goal Weight -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Goal Weight (kg)</label>
                    <input type="number" id="wizard-goal-weight" class="wizard-input" placeholder="65" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Equipment Access -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Where do you train?</label>
                    <select id="wizard-equipment" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="gym">Full Gym Access</option>
                        <option value="dumbbells">Home Equipment (Dumbbells/Bands)</option>
                        <option value="none">Bodyweight Only</option>
                    </select>
                </div>

                <!-- Activity Level -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Activity Level</label>
                    <select id="wizard-activity-level" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="sedentary">Sedentary (Little or no exercise)</option>
                        <option value="light">Lightly Active (Exercise 1-3 days/week)</option>
                        <option value="moderate">Moderately Active (Exercise 3-5 days/week)</option>
                        <option value="very">Very Active (Exercise 6-7 days/week)</option>
                    </select>
                </div>

                <!-- Energy Level -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Energy Status</label>
                    <select id="wizard-energy-level" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="low">Low Energy (Often tired)</option>
                        <option value="normal">Normal Energy</option>
                        <option value="high">High Energy</option>
                    </select>
                </div>
            </div>

            <!-- SLIDE 3: CYCLE SETUP (females only) -->
            <div class="wizard-slide" id="slide-3" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🌸</div>
                <h3 style="text-align:center; margin-bottom:10px;">Cycle Syncing</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">We tailor your daily movement to match your hormonal phase.</p>
                
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">When was your last period?</label>
                    <input type="date" id="wizard-period-date" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>
                
                <div class="wizard-option" style="display:flex; align-items:center; gap:10px; justify-content:center;">
                    <input type="checkbox" id="wizard-wellness-toggle" onchange="toggleWizardPeriodInput()">
                    <label for="wizard-wellness-toggle" style="font-size:0.9rem; color:#64748b;">I don't have a period (Wellness Mode)</label>
                </div>
            </div>

            <!-- SLIDE 4: NUTRITION LOGIC -->
            <div class="wizard-slide" id="slide-4" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🥑</div>
                <h3 style="text-align:center; margin-bottom:10px;">Food as Medicine</h3>
                <p style="color:#475569; line-height:1.6; text-align:center;">
                    Log symptoms like <strong>Hot Flashes</strong> or <strong>Bloating</strong> in your daily check-in.
                </p>
                <div style="background:#f0fdf4; border:1px solid #bbf7d0; padding:15px; border-radius:12px; margin-top:20px;">
                    <p style="margin:0; font-size:0.9rem; color:#166534;">
                        <strong>✨ Smart Swap:</strong><br>
                        If you report "Hot Flashes", we'll recommend cooling foods like <em>Overnight Soy Oats</em>.
                    </p>
                </div>
            </div>

            <!-- SLIDE 5: ACCOUNTABILITY -->
            <div class="wizard-slide" id="slide-5" style="display:none;">
                 <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🤝</div>
                <h3 style="text-align:center; margin-bottom:15px;">You Are Supported</h3>
                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:15px;">
                    <li style="display:flex; align-items:center; gap:15px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.5rem;">📸</span> 
                        <div><strong>Track Meals</strong><br><span style="font-size:0.85rem; color:#666;">Snap photos for accountability.</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:15px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.5rem;">💬</span> 
                        <div><strong>Coach Chat</strong><br><span style="font-size:0.85rem; color:#666;">Ask specific questions anytime.</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:15px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.5rem;">👥</span> 
                        <div><strong>Group</strong><br><span style="font-size:0.85rem; color:#666;">Share wins with your squad.</span></div>
                    </li>
                </ul>
            </div>
            
            <!-- SLIDE 6: PROFILE EVOLUTION -->
            <div class="wizard-slide" id="slide-6" style="display:none;">
                 <div style="text-align:center; margin-bottom:20px; font-size:3rem;">⚙️</div>
                <h3 style="text-align:center; margin-bottom:15px;">Protocol Evolves</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">
                    Symptoms leaving or joined a gym? <br><br>
                    <strong>Update your profile anytime.</strong><br>
                    We'll instantly unlock harder workouts or adjust your nutrition plan.
                </p>
                <div style="display:flex; justify-content:center;">
                    <span style="background:#f1f5f9; padding:8px 16px; border-radius:20px; font-size:0.85rem; color:#64748b;">Go to <strong>Settings > Edit Profile</strong></span>
                </div>
            </div>

            <!-- SLIDE 7: READY -->
            <div class="wizard-slide" id="slide-7" style="display:none; text-align:center;">
                 <div style="font-size:4rem; margin-bottom:20px;">🚀</div>
                <h3 style="margin-bottom:10px;">You're All Set!</h3>
                <p style="color:#64748b; margin-bottom:25px;">Your custom 28-day plan is ready.</p>

                <div id="wizard-hormone-goal" style="background:var(--secondary); color:white; padding:15px; border-radius:12px; display:inline-block; font-weight:600;">
                    Goal: Reduce Cortisol & Detox Estrogen
                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <div class="wizard-footer" style="padding: 25px; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; flex-shrink: 0;">
            <button class="wizard-btn secondary" id="wizard-back" onclick="wizardPrev()" style="background:transparent; border:none; color:#64748b; font-weight:600; cursor:pointer; visibility:hidden;">Back</button>
            <button class="wizard-btn primary" id="wizard-next" onclick="wizardNext()" style="background:var(--primary); color:white; border:none; padding:12px 30px; border-radius:25px; font-weight:700; cursor:pointer; box-shadow:0 4px 10px rgba(4,106,56,0.2);">Next &rarr;</button>
        </div>
    </div>
</div>

<style>
.wizard-progress .dot { width: 8px; height: 8px; background: #e2e8f0; border-radius: 50%; transition: all 0.3s; }
.wizard-progress .dot.active { background: var(--primary); width: 20px; border-radius: 10px; }
.wizard-slide { animation: fadeIn 0.4s ease; }

/* Gender selection button styles */
.gender-select-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.gender-select-btn:active {
    transform: translateY(0);
}


/* DBZ Theme Decorations */
#dbz-decorations {
    display: none;
    pointer-events: none;
    z-index: 1;
}

.dbz-character-corner {
    position: fixed;
    bottom: 70px;
    right: 5px;
    width: 120px;
    height: auto;
    max-height: 200px;
    object-fit: contain;
    opacity: 0.95;
    z-index: 100;
    animation: dbzFloat 3s ease-in-out infinite;
    filter: drop-shadow(0 4px 15px rgba(0, 0, 0, 0.5));
    border-radius: 8px;
}

.dbz-lightning-left {
    position: fixed;
    top: 120px;
    left: 10px;
    width: 35px;
    height: 60px;
    opacity: 0.7;
    z-index: 100;
    animation: dbzLightning 2s ease-in-out infinite;
}

.dbz-lightning-right {
    position: fixed;
    top: 200px;
    right: 15px;
    width: 30px;
    height: 50px;
    opacity: 0.6;
    z-index: 100;
    animation: dbzLightning 2.5s ease-in-out infinite 0.5s;
}

@keyframes dbzFloat {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-10px) scale(1.05); }
}

@keyframes dbzLightning {
    0%, 100% { opacity: 0.4; transform: scaleY(1); }
    50% { opacity: 0.9; transform: scaleY(1.1); }
}

/* Flower Garden Decorations (Female users only) */
#flower-decorations {
    display: none;
    pointer-events: none;
    z-index: 1;
}

.flower-corner {
    position: fixed;
    width: 60px;
    height: 60px;
    object-fit: contain;
    opacity: 0.4;
    z-index: 100;
    filter: drop-shadow(0 2px 8px rgba(217, 139, 156, 0.3));
    animation: flowerFloat 4s ease-in-out infinite;
}

.flower-top-right {
    top: 80px;
    right: 15px;
    animation-delay: 0s;
}

.flower-bottom-left {
    bottom: 80px;
    left: 15px;
    transform: rotate(180deg);
    animation-delay: 1s;
}

.flower-top-left {
    top: 180px;
    left: 20px;
    animation-delay: 2s;
    width: 55px;
    height: 55px;
}

.flower-bottom-right {
    bottom: 180px;
    right: 20px;
    transform: rotate(-15deg);
    animation-delay: 3s;
    width: 50px;
    height: 50px;
}

@keyframes flowerFloat {
    0%, 100% {
        transform: translateY(0) rotate(0deg) scale(1);
    }
    25% {
        transform: translateY(-8px) rotate(5deg) scale(1.05);
    }
    50% {
        transform: translateY(-12px) rotate(-3deg) scale(1.08);
    }
    75% {
        transform: translateY(-6px) rotate(3deg) scale(1.03);
    }
}

/* Additional rotations for specific corners */
.flower-bottom-left {
    animation-name: flowerFloatRotated;
}

@keyframes flowerFloatRotated {
    0%, 100% {
        transform: translateY(0) rotate(180deg) scale(1);
    }
    25% {
        transform: translateY(-8px) rotate(185deg) scale(1.05);
    }
    50% {
        transform: translateY(-12px) rotate(177deg) scale(1.08);
    }
    75% {
        transform: translateY(-6px) rotate(183deg) scale(1.03);
    }
}

/* Flower Garden Theme - Falling Flower Animation */
@keyframes flowerFall {
    0% {
        transform: translateY(-100px) translateX(0) rotate(0deg);
        opacity: 0;
    }
    10% {
        opacity: 1;
    }
    25% {
        transform: translateY(25vh) translateX(20px) rotate(90deg);
    }
    50% {
        transform: translateY(50vh) translateX(-15px) rotate(180deg);
    }
    75% {
        transform: translateY(75vh) translateX(10px) rotate(270deg);
        opacity: 0.8;
    }
    90% {
        opacity: 0.5;
    }
    100% {
        transform: translateY(100vh) translateX(0) rotate(360deg);
        opacity: 0;
    }
}

.falling-flower {
    position: fixed;
    width: 40px;
    height: 40px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    pointer-events: none;
    z-index: 9999;
    will-change: transform, opacity;
}

/* DBZ theme specific gradient for welcome section */
body.dbz-theme-active .dashboard-welcome {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--primary-light) 100%) !important;
    position: relative;
    overflow: hidden;
}

/* Goku theme (Super Saiyan) - orange/gold gradient with Goku in welcome */
body.dbz-goku-theme .dashboard-welcome::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('assets/goku-ssj.webp') no-repeat right -10px bottom -20px;
    background-size: 100px auto;
    opacity: 0.3;
    pointer-events: none;
}

/* Vegeta theme (Saiyan Prince) - blue/gold gradient with Vegeta in welcome */
body.dbz-vegeta-theme .dashboard-welcome::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('assets/vegeta-ssj.webp') no-repeat right -20px bottom -10px;
    background-size: auto 90px;
    opacity: 0.3;
    pointer-events: none;
}

/* Mobile responsive adjustments */
@media (max-width: 480px) {
    .dbz-character-corner {
        width: 90px;
        max-height: 150px;
        bottom: 65px;
        right: 3px;
    }
    .dbz-lightning-left,
    .dbz-lightning-right {
        display: none;
    }
}

/* Settings icon toggle for DBZ themes */
.settings-icon-dragonball {
    display: none !important;
}

body.dbz-theme-active .settings-icon-gear {
    display: none !important;
}

body.dbz-theme-active .settings-icon-dragonball {
    display: inline-block !important;
}

/* Profile icon Dragon Ball for DBZ themes */
body.dbz-theme-active .profile-icon {
    background-image: url('assets/dragon-ball.svg');
    background-size: cover;
    background-position: center;
    color: transparent !important; /* Hide the "S" text */
    font-size: 0; /* Extra measure to hide text */
}
</style>

<script>
// --- COACH CHAT DEBOUNCE LOGIC ---
let coachMessageBuffer = [];
let coachDebounceTimer = null;

window.submitCoachMessage = async function() {
    const input = document.getElementById('coach-chat-input');
    if(!input) return;
    const text = input.value.trim();
    if (!text) return;
    
    // 1. Render User Message Immediately
    const container = document.getElementById('chat-messages-container');
    if(container) {
        // ... (Rendering logic identical) ...
        const rowDiv = document.createElement('div');
        rowDiv.style.cssText = "display: flex; justify-content: flex-end; align-items: flex-end; margin-bottom: 20px; animation: fadeIn 0.3s ease;";
        rowDiv.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: flex-end; max-width: 80%;">
                <div style="background: var(--chat-bg-user); color: var(--chat-text-user); padding: 12px 18px; border-radius: 18px 18px 0 18px; font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">${text}</div>
                <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-right: 5px;">You Just now</span>
            </div>
            <img src="https://ui-avatars.com/api/?name=You&background=cbd5e1&color=fff" style="width: 36px; height: 36px; border-radius: 50%; margin-left: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        `;
        container.appendChild(rowDiv);
        scrollToBottomOfChat();

        // Save to DB immediately
        try {
            await saveToHistory('user', text);
        } catch (dbError) {
            console.error("❌ Failed to save user message to DB:", dbError);
            alert("Warning: Message may not have been saved. Check console.");
        }
    }
    
    input.value = '';

    // 2. Buffer the Message
    coachMessageBuffer.push(text);

    // 3. Clear existing timer
    if (coachDebounceTimer) clearTimeout(coachDebounceTimer);

    // 4. Set Logic to Fire
    coachDebounceTimer = setTimeout(() => {
        const combinedText = coachMessageBuffer.join('\n');
        // Track how many messages are in this buffer before clearing
        window._lastBufferedCount = coachMessageBuffer.length;
        coachMessageBuffer = []; // Clear buffer
        triggerCoachResponse(combinedText);
    }, 15000); // 15s wait
};
</script>

<script>
    // ... (Onboarding script skipped in replacement context, assuming only replacing target lines) ...
    // Wait, I can't skip lines if I target a range.
    // I need to target specifically submitCoachMessage to triggerCoachResponse.
    // But they are far apart (8922 vs 9245).
    // I should do two separate replacements.
    
    // Replacement 1: submitCoachMessage
    // Replacement 2: triggerCoachResponse
    
    // I will return logic for just Replacement 1 for now.
    
    // Wait, the tool validates TargetContent.
    // I will just Refactor submitCoachMessage first.
    

</script>

<script>
    // Initialize Onboarding
    function initOnboarding() {
        // Check if user has seen onboarding
        const hasSeenOnboarding = localStorage.getItem('plantbased_onboarding_complete');
        
        if (!hasSeenOnboarding) {
            // Show modal immediately
            setTimeout(() => {
                const overlay = document.getElementById('onboarding-overlay');
                if(overlay) {
                    overlay.style.display = 'flex';
                    // Trigger reflow
                    overlay.offsetHeight;
                    overlay.classList.add('active');
                }
            }, 100); // Reduced delay for instant feel
        }
    }

    function completeOnboarding() {
        const overlay = document.getElementById('onboarding-overlay');
        overlay.classList.remove('active');
        
        // Wait for animation
        setTimeout(() => {
            overlay.style.display = 'none';
            // Set flag in localStorage
            localStorage.setItem('plantbased_onboarding_complete', 'true');
        }, 400);
    }
    
    // Run initialization
    if(document.readyState === 'complete') {
        loadCommunityFeed();
        initOnboarding();
    } else {
        window.addEventListener('load', () => {
            loadCommunityFeed();
            initOnboarding();
        });
    }
</script>

<script>
// --- PWA INSTALL BANNER LOGIC ---
let deferredPrompt;
let installBannerDismissed = localStorage.getItem('pwa_banner_dismissed_v2') === 'true'; // Reset key to force show

// Detect if running as installed PWA
const isInstalledPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

// Only show on mobile devices - REMOVED RESTRICTION
const isMobile = true; 

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    console.log("Install Prompt Captured");
});

// Force check on load - Show banner if not installed
// (Duplicate logic removed)

window.addEventListener('load', () => {
    // Only show if not installed and not dismissed and NOT iOS (since iOS can't "one-click" install)
    // Actually user wants "Click -> Download". If iOS, we can't do that. 
    // We will show transparency.
    
    if (!isInstalledPWA && !installBannerDismissed) {
        showPwaBanner();
    }
    
    // Make Coach Bubble Draggable
    initDraggableBubble();
});

function showPwaBanner() {
    const banner = document.getElementById('pwa-install-banner');
    if(banner) {
        banner.style.display = 'flex';
        // Push body content down to avoid overlap
        document.body.style.transition = 'padding-top 0.3s ease';
        document.body.style.paddingTop = banner.offsetHeight + 'px';
    }
}

function initDraggableBubble() {
    const bubble = document.getElementById('coach-floating-btn');
    if(!bubble) return;
    
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;
    const moveThreshold = 5; // Pixels to satisfy 'drag'

    const handleStart = (e) => {
        if(e.target.closest('.notification-badge')) return; // Don't drag if clicking badge
        isDragging = false; // Assume click first
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        startX = clientX;
        startY = clientY;
        
        const rect = bubble.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;

        // Remove transition during drag
        bubble.style.transition = 'none';
    };

    const handleMove = (e) => {
        e.preventDefault(); // Prevent scrolling
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        const dx = clientX - startX;
        const dy = clientY - startY;

        if (Math.abs(dx) > moveThreshold || Math.abs(dy) > moveThreshold) {
            isDragging = true;
        }

        if (isDragging) {
             bubble.style.right = 'auto';
             bubble.style.bottom = 'auto';
             bubble.style.left = (initialLeft + dx) + 'px';
             bubble.style.top = (initialTop + dy) + 'px';
        }
    };

    const handleEnd = (e) => {
        bubble.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        // Snap to nearest edge logic could go here, but free floating is fine for now
    };

    bubble.addEventListener('mousedown', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', handleEnd);
    
    bubble.addEventListener('touchstart', handleStart, {passive: false});
    window.addEventListener('touchmove', handleMove, {passive: false});
    window.addEventListener('touchend', handleEnd);
}


window.installPWA = async function() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            dismissInstall();
        }
        deferredPrompt = null;
    } else {
        // User requested "No instructions, just download".
        // If we are here, the browser hasn't fired the event yet or doesn't support it (iOS).
        // specific check for iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
             alert("On iOS, please tap 'Share' then 'Add to Home Screen' manually."); 
        } else {
             console.log("Install prompt not ready yet.");
             // Try to force it? No API for that.
             alert("App installation is getting ready. Please try again in a moment.");
        }
    }
};

window.dismissInstall = function() {
    const banner = document.getElementById('pwa-install-banner');
    if(banner) {
        banner.style.display = 'none';
        document.body.style.paddingTop = '0';
    }
    localStorage.setItem('pwa_banner_dismissed_v2', 'true');
};
</script>

<script>
// --- AI COACH DRAFT MODE LOGIC & AUTHENTICATION ---
// Overrides and Extensions for the Coach Command Center

let isCoachMode = false;


function checkUserRole() {
    // DISABLED: Coach Mode is replaced by admin-dashboard.html
    // All users should see the normal dashboard.
    return;
}

window.toggleCoachMode = function(show) {
    isCoachMode = show;
    const dash = document.getElementById('view-coach-dashboard');
    if (show) {
        if(dash) dash.style.display = 'block';
        if(typeof initCoachDashboard === 'function') initCoachDashboard();
        const returnBtn = document.getElementById('return-to-coach-btn');
        if(returnBtn) returnBtn.remove();
    } else {
        if(dash) dash.style.display = 'none';
    }
};

// User fact tracking - remembers key details across sessions
// User fact tracking - remembers key details across sessions
async function getUserFacts() {
    const user = window.currentUser;
    if (!user) return {};
    
    try {
        const facts = await dbHelpers.userFacts.get(user.id);
        if (facts) return facts;
        return {
            location: '',
            struggles: [],
            preferences: [],
            health_notes: [],
            personal_details: [],
            goals: []
        };
    } catch (e) {
        console.error("Error fetching user facts", e);
        return {};
    }
}

async function saveUserFact(category, fact) {
    const user = window.currentUser;
    if (!user) return;

    try {
        const facts = await getUserFacts();
        if (category === 'location') {
            facts.location = fact;
        } else if (Array.isArray(facts[category])) {
            // Avoid duplicates
            if (!facts[category].includes(fact)) {
                facts[category].push(fact);
            }
        } else {
             // Create array if missing
             facts[category] = [fact];
        }
        await dbHelpers.userFacts.upsert(user.id, facts);
    } catch(e) {
        console.error("Error saving user fact", e);
    }
}

async function gatherContext() {
    let dayNum = 1;
    const profile = await window.getUserProfile();
    
    if(profile && profile.program_start_date) {
         const start = new Date(profile.program_start_date);
         if(!isNaN(start)) {
             const diff = new Date() - start;
             dayNum = Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
             if(dayNum < 1) dayNum = 1;
         }
    }
    
    // Get latest check-in for energy/sleep
    let energy = 'Unknown';
    let sleep = 'Unknown';
    try {
        const user = window.currentUser;
        if(user) {
            const today = new Date().toISOString().split('T')[0];
            const checkin = await dbHelpers.checkins.get(user.id, today);
            if(checkin) {
                energy = checkin.energy;
                sleep = checkin.sleep;
            }
        }
    } catch(e) {}

    const facts = await getUserFacts();

    return {
        name: profile?.name || "Friend",
        profile: (profile?.result || 'CORTISOL').toUpperCase(),
        sleep: sleep,
        energy: energy,
        challengeDay: dayNum,
        userFacts: facts
    };
}

window.triggerCoachResponse = async function(userMsg) {
    const container = document.getElementById('chat-messages-container');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'coach-typing';
    typingDiv.style.cssText = "display: flex; align-items: center; margin-bottom: 20px; margin-left:10px;";
    typingDiv.innerHTML = `
        <div style="width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both;"></div>
        <div style="width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; margin: 0 4px; animation: bounce 1.4s infinite ease-in-out both 0.16s;"></div>
        <div style="width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both 0.32s;"></div>
    `;
    if(container) {
        container.appendChild(typingDiv);
        scrollToBottomOfChat();
    }

    const removeTypingIndicator = () => {
        const el = document.getElementById('coach-typing');
        if(el) el.remove();
    };

    let context = await gatherContext();
    const history = await getChatHistory();

    // Determine Conversation Status (New vs Continuing)
    // Simplified: check if there's been a recent coach message
    let conversationStatus = 'new';

    if (history.length > 0) {
        // Find the most recent coach/model message
        const lastCoachMsg = [...history].reverse().find(m => m.role === 'model' || m.role === 'assistant');
        if (lastCoachMsg) {
            const gap = Date.now() - lastCoachMsg.timestamp;
            if (gap < (60 * 60 * 1000)) { // 1 hour threshold
                conversationStatus = 'continuing';
            }
        }
    }

    // Determine how many messages are in the current buffer to avoid sending them twice
    // (since they were already pushed to history in submitCoachMessage)
    const messagesToSlice = (typeof window._lastBufferedCount === 'number') ? window._lastBufferedCount : 0;
    const historyContext = history.slice(0, history.length - messagesToSlice);

    // Enhanced timestamp context with Brisbane time for each message
    const now = new Date();
    const payloadHistory = historyContext.map(m => {
        const msgDate = new Date(m.timestamp);
        const msgBneTime = msgDate.toLocaleString("en-US", {
            timeZone: "Australia/Brisbane",
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
        return {
            role: m.role === 'user' ? 'user' : 'model',
            text: m.text,
            timestamp: m.timestamp,
            brisbaneTime: msgBneTime
        };
    });

    // Get current Brisbane time
    const currentBneTime = now.toLocaleString("en-US", {
        timeZone: "Australia/Brisbane",
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    });

    try {
        const response = await fetch('/.netlify/functions/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mode: 'coach',
                message: userMsg,
                contextData: context,
                chatHistory: payloadHistory,
                conversationStatus: conversationStatus,
                currentDateTime: currentBneTime,
                brisbaneTime: currentBneTime
            })
        });

        const data = await response.json();

        if (!response.ok) {
            removeTypingIndicator();
            throw new Error(data.error?.message || "Connection Issue");
        }

        if (data.reply) {
            removeTypingIndicator();

            // APPROVAL FLOW: Save response as pending instead of displaying immediately
            const fullResponse = data.reply;

            // Get current user ID for the pending response
            const user = await window.supabaseClient.auth.getUser();
            const currentUserId = user?.data?.user?.id;

            if (currentUserId) {
                // Save to pending_coach_responses table
                await db.pendingResponses.create(
                    currentUserId,
                    fullResponse,
                    userMsg,
                    { context: context, conversationStatus: conversationStatus }
                );

                // Notify admin about pending response
                await notifyAdminOfPendingResponse(currentUserId, fullResponse);
            }
        } else {
            removeTypingIndicator();
        }
    } catch (err) {
        console.error("Coach Error", err);
        removeTypingIndicator();
        // Silent fail or very subtle hint - but never "AI Error"
    }
};

// ==========================================
// APPROVAL SYSTEM FUNCTIONS
// ==========================================

// VAPID Public Key for Web Push - Must match VAPID_PUBLIC_KEY in Netlify env vars
const VAPID_PUBLIC_KEY = 'BLYkAQao_i-6MnaGCpr3hST-GqSEjcAnA3JYOGEEOtVS8dn1LX3FkpFqAbIFNbjsafyPJRoHa6n-dRq6NvT1OBI';

/**
 * Subscribe to push notifications (for admin users)
 */
window.subscribeToAdminNotifications = async function() {
    try {
        // Check if user is admin
        const isAdmin = await db.pushSubscriptions.isAdmin();
        if (!isAdmin) {
            alert('Only admins can subscribe to approval notifications');
            return false;
        }

        // Request notification permission
        if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert('Notification permission denied. Please enable notifications in your browser settings.');
                return false;
            }
        } else {
            alert('This browser does not support notifications');
            return false;
        }

        // Get service worker registration
        const registration = await navigator.serviceWorker.ready;

        // Subscribe to push
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });

        // Convert subscription to JSON
        const subscriptionJson = subscription.toJSON();

        // Save to database
        await db.pushSubscriptions.subscribe({
            endpoint: subscriptionJson.endpoint,
            keys: {
                p256dh: subscriptionJson.keys.p256dh,
                auth: subscriptionJson.keys.auth
            }
        }, true); // isAdmin = true

        console.log('Subscribed to admin notifications!');
        alert('Push notifications enabled! You will now receive alerts on this device when messages need approval.');
        return true;

    } catch (error) {
        console.error('Failed to subscribe to notifications:', error);
        alert('Failed to enable notifications: ' + error.message);
        return false;
    }
};

/**
 * Unsubscribe from push notifications
 */
window.unsubscribeFromNotifications = async function() {
    try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();

        if (subscription) {
            await subscription.unsubscribe();
            await db.pushSubscriptions.unsubscribe(subscription.endpoint);
            alert('Notifications disabled.');
        }
    } catch (error) {
        console.error('Failed to unsubscribe:', error);
    }
};

/**
 * Check if admin is subscribed to notifications
 */
window.checkAdminNotificationStatus = async function() {
    try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        return !!subscription;
    } catch (error) {
        return false;
    }
};

/**
 * Toggle admin notifications (called from settings button)
 */
window.toggleAdminNotifications = async function() {
    const btn = document.getElementById('admin-notif-btn');
    const isSubscribed = await checkAdminNotificationStatus();

    if (isSubscribed) {
        // Unsubscribe
        await unsubscribeFromNotifications();
        btn.textContent = 'Enable';
        btn.style.background = 'var(--primary)';
    } else {
        // Subscribe
        btn.textContent = 'Enabling...';
        btn.disabled = true;
        const success = await subscribeToAdminNotifications();
        btn.disabled = false;
        if (success) {
            btn.textContent = 'Disable';
            btn.style.background = '#ef4444';
        } else {
            btn.textContent = 'Enable';
        }
    }
};

/**
 * Initialize admin settings on page load
 * Auto-subscribes admins to notifications if they have permission
 */
async function initAdminSettings() {
    try {
        const isAdmin = await db.pushSubscriptions.isAdmin();
        if (isAdmin) {
            // Show the admin notifications setting
            const setting = document.getElementById('admin-notifications-setting');
            if (setting) {
                setting.style.display = 'block';
            }

            // Check if already subscribed
            const isSubscribed = await checkAdminNotificationStatus();
            const btn = document.getElementById('admin-notif-btn');

            if (isSubscribed) {
                if (btn) {
                    btn.textContent = 'Disable';
                    btn.style.background = '#ef4444';
                }
            } else {
                // Auto-subscribe admin if notification permission is already granted
                if ('Notification' in window && Notification.permission === 'granted') {
                    console.log('Auto-subscribing admin to notifications...');
                    const success = await subscribeToAdminNotifications();
                    if (success && btn) {
                        btn.textContent = 'Disable';
                        btn.style.background = '#ef4444';
                    }
                } else if ('Notification' in window && Notification.permission === 'default') {
                    // Request permission and subscribe if granted
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        console.log('Permission granted, auto-subscribing admin...');
                        const success = await subscribeToAdminNotifications();
                        if (success && btn) {
                            btn.textContent = 'Disable';
                            btn.style.background = '#ef4444';
                        }
                    }
                }
            }
        }
    } catch (error) {
        console.log('Not admin or error checking:', error);
    }
}

// Call on page load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initAdminSettings, 1000); // Delay to ensure auth is ready
});

/**
 * Helper: Convert VAPID key to Uint8Array
 */
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

/**
 * Notify admin about pending coach response via server-side push
 */
async function notifyAdminOfPendingResponse(userId, responseText) {
    // Get user name for the notification
    const profile = await window.getUserProfile();
    const userName = profile?.name || 'A user';

    const notificationTitle = 'Coach Response Pending Approval';
    const notificationBody = `${userName}: ${responseText.substring(0, 100)}${responseText.length > 100 ? '...' : ''}`;

    // Send push notification via server (reaches admin even when not on site)
    try {
        const response = await fetch('/.netlify/functions/send-push-notification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: notificationTitle,
                body: notificationBody,
                data: {
                    type: 'pending_approval',
                    userId: userId,
                    url: '/dashboard.html'
                }
            })
        });

        const result = await response.json();
        console.log('Push notification result:', result);
    } catch (error) {
        console.error('Error sending push notification:', error);
    }

    // Also set app badge locally if we're on the app
    if ('setAppBadge' in navigator) {
        const pendingCount = await db.pendingResponses.getPendingCount();
        navigator.setAppBadge(pendingCount).catch(e => console.error(e));
    }
}

/**
 * Open approval modal for a pending response
 */
window.openApprovalModal = async function(pendingId = null) {
    let pendingResponse;

    if (pendingId) {
        // Load specific pending response
        pendingResponse = await db.pendingResponses.getById(pendingId);
    } else {
        // Load the most recent pending response
        const pending = await db.pendingResponses.getPending(1);
        if (pending && pending.length > 0) {
            pendingResponse = pending[0];
        }
    }

    if (!pendingResponse) {
        alert('No pending responses found.');
        return;
    }

    // Store current pending response ID
    window.currentPendingResponseId = pendingResponse.id;

    // Open the approval modal
    const modal = document.getElementById('approval-modal');
    if (modal) {
        // Populate modal with response data
        const userName = pendingResponse.users?.name || 'User';
        const userMessage = pendingResponse.user_message_text || '';
        const responseText = pendingResponse.message_text || '';

        document.getElementById('approval-user-name').textContent = userName;
        document.getElementById('approval-user-message').textContent = userMessage;
        document.getElementById('approval-response-text').value = responseText;

        modal.style.display = 'flex';
    }
};

/**
 * Close approval modal
 */
window.closeApprovalModal = function() {
    const modal = document.getElementById('approval-modal');
    if (modal) {
        modal.style.display = 'none';
    }
};

/**
 * Approve and send the response
 */
window.approveResponse = async function() {
    const responseId = window.currentPendingResponseId;
    if (!responseId) return;

    try {
        // Get the (possibly edited) response text
        const editedText = document.getElementById('approval-response-text').value;

        // Get current user (admin)
        const user = await window.supabaseClient.auth.getUser();
        const adminId = user?.data?.user?.id;

        // Get the pending response to find the original user_id
        const pendingResponse = await db.pendingResponses.getById(responseId);
        const originalUserId = pendingResponse.user_id;

        // Approve the response in pending_coach_responses table
        await db.pendingResponses.approve(responseId, adminId, editedText);

        // Save the approved message to the conversations table for the ORIGINAL USER
        // Split by ||| for multi-part messages
        const parts = editedText.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());

        for (const part of parts) {
            await db.conversations.create(
                originalUserId,  // The user who asked the question
                'coach',         // chat_type - must match what getChatHistory queries for
                'assistant',     // role
                part,           // message text
                'Coach Shannon'  // author name
            );
        }

        // Close the modal
        closeApprovalModal();

        // Clear app badge if no more pending
        const pendingCount = await db.pendingResponses.getPendingCount();
        if ('setAppBadge' in navigator) {
            if (pendingCount === 0) {
                navigator.clearAppBadge().catch(e => console.error(e));
            } else {
                navigator.setAppBadge(pendingCount).catch(e => console.error(e));
            }
        }

        // Show success message
        alert('Response approved and sent to user!');
    } catch (error) {
        console.error('Error approving response:', error);
        alert('Error approving response: ' + error.message);
    }
};

/**
 * Reject the response
 */
window.rejectResponse = async function() {
    const responseId = window.currentPendingResponseId;
    if (!responseId) return;

    const reason = prompt('Why are you rejecting this response? (optional)');

    try {
        await db.pendingResponses.reject(responseId, reason || 'No reason provided');

        // Close the modal
        closeApprovalModal();

        // Clear app badge if no more pending
        const pendingCount = await db.pendingResponses.getPendingCount();
        if ('setAppBadge' in navigator) {
            if (pendingCount === 0) {
                navigator.clearAppBadge().catch(e => console.error(e));
            } else {
                navigator.setAppBadge(pendingCount).catch(e => console.error(e));
            }
        }

        alert('Response rejected.');
    } catch (error) {
        console.error('Error rejecting response:', error);
        alert('Error rejecting response. Please try again.');
    }
};

// ==========================================
// COMMUNITY CHAT HELPER FUNCTIONS
// ==========================================

// Helper: Add typing indicator for community member
function addCommunityTypingIndicator(personaName) {
    const container = document.getElementById('community-messages-container');
    if (!container) return;

    const typingDiv = document.createElement('div');
    typingDiv.className = 'community-typing-indicator';
    typingDiv.dataset.persona = personaName;
    typingDiv.style.cssText = "display: flex; align-items: center; margin-bottom: 12px; margin-left:10px;";
    typingDiv.innerHTML = `
        <div style="font-size: 0.75rem; color: #94a3b8; margin-right: 8px;">${personaName} is typing</div>
        <div style="width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both;"></div>
        <div style="width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; margin: 0 3px; animation: bounce 1.4s infinite ease-in-out both 0.16s;"></div>
        <div style="width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both 0.32s;"></div>
    `;
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
}

// Helper: Remove all typing indicators (or specific one)
function removeCommunityTypingIndicators(personaName = null) {
    if (personaName) {
        const indicators = document.querySelectorAll(`.community-typing-indicator[data-persona="${personaName}"]`);
        indicators.forEach(ind => ind.remove());
    } else {
        const indicators = document.querySelectorAll('.community-typing-indicator');
        indicators.forEach(ind => ind.remove());
    }
}

// Helper: Add emoji reaction to a message
function addEmojiReaction(messageIndex, emoji, reactorId) {
    const messages = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
    if (messageIndex >= 0 && messageIndex < messages.length) {
        if (!messages[messageIndex].reactions) {
            messages[messageIndex].reactions = [];
        }
        messages[messageIndex].reactions.push({ emoji, reactorId });
        localStorage.setItem('community_chat_history', JSON.stringify(messages));
        renderChat(messages);
    }
}

// Helper: Mark message as read by member
function markMessageAsRead(messageIndex, memberId) {
    const messages = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
    if (messageIndex >= 0 && messageIndex < messages.length) {
        if (!messages[messageIndex].readBy) {
            messages[messageIndex].readBy = [];
        }
        if (!messages[messageIndex].readBy.includes(memberId)) {
            messages[messageIndex].readBy.push(memberId);
        }
        localStorage.setItem('community_chat_history', JSON.stringify(messages));
    }
}

// Helper: Get member online status based on time of day (Brisbane time)
function getMemberOnlineStatus() {
    const now = new Date();
    const bneTime = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Brisbane"}));
    const hour = bneTime.getHours();

    // Online status based on time of day
    // Peak activity: 7am-10am, 12pm-2pm, 2pm-6pm, 6pm-10pm
    // Low activity: 10pm-7am
    const onlineMembers = [];

    AI_MEMBERS.forEach(member => {
        let onlineChance = 0.3; // Base 30% chance

        if (hour >= 7 && hour < 10) onlineChance = 0.7; // Morning peak
        else if (hour >= 12 && hour < 14) onlineChance = 0.6; // Lunch peak
        else if (hour >= 14 && hour < 18) onlineChance = 0.5; // Afternoon moderate
        else if (hour >= 18 && hour < 22) onlineChance = 0.8; // Evening peak (highest)
        else if (hour >= 22 || hour < 7) onlineChance = 0.1; // Night/early morning

        if (Math.random() < onlineChance) {
            onlineMembers.push(member.id);
        }
    });

    return onlineMembers;
}

// Helper: Check if should respond to message and when
function shouldRespondToMessage() {
    const rand = Math.random();

    // 10% - No response (dead air)
    if (rand < 0.10) return { type: false };

    // 40% - Immediate response (2-10s)
    if (rand < 0.50) {
        const subRand = Math.random();
        if (subRand < 0.3) return { type: 'emoji', delay: 0 }; // 12% emoji immediate
        return { type: 'text', delay: 0 }; // 28% text immediate
    }

    // 25% - Quick delay (1-3 minutes)
    if (rand < 0.75) {
        const delay = 60000 + Math.random() * 120000; // 1-3 min
        return { type: 'text', delay: delay };
    }

    // 15% - Medium delay (5-15 minutes)
    if (rand < 0.90) {
        const delay = 300000 + Math.random() * 600000; // 5-15 min
        return { type: 'text', delay: delay };
    }

    // 10% - Long delay (30min-2 hours)
    const delay = 1800000 + Math.random() * 5400000; // 30min-2hrs
    return { type: 'text', delay: delay };
}

async function triggerAICommunityResponse(userMsg, chainCount = 0) {
    const lowMsg = userMsg.toLowerCase();
    const fullHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');

    // Check if there's been recent activity (conversation flow)
    const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
    const recentActivity = fullHistory.slice(-5).some(m =>
        m.timestamp > fiveMinutesAgo && m.authorId !== 'current-user'
    );
    const isActiveConversation = recentActivity || chainCount > 0;

    // Mark user's message as read by some members
    const lastMsgIndex = fullHistory.length - 1;
    if (lastMsgIndex >= 0 && fullHistory[lastMsgIndex].authorId === 'current-user') {
        const onlineMembers = getMemberOnlineStatus();
        const readersCount = Math.floor(Math.random() * Math.min(onlineMembers.length, 8)) + 2;
        for (let i = 0; i < readersCount; i++) {
            const randomMember = onlineMembers[Math.floor(Math.random() * onlineMembers.length)];
            markMessageAsRead(lastMsgIndex, randomMember);
        }
        renderChat(fullHistory);
    }

    // Check if should respond and when
    const response = shouldRespondToMessage();

    if (response.type === false) {
        // Dead air - no response
        return;
    }

    // Calculate total delay (base delay from shouldRespond + immediate response timing)
    const baseDelay = response.delay || 0;

    if (response.type === 'emoji') {
        // Just emoji reaction, no text
        const emojis = ['👍', '❤️', '🎉', '😂', '💪', '🙌', '✨', '🔥', '💯', '👏'];
        const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
        const onlineMembers = getMemberOnlineStatus();
        const randomReactor = AI_MEMBERS.find(m => onlineMembers.includes(m.id)) || AI_MEMBERS[0];

        // Delay before reaction - quicker than text but still realistic
        let emojiImmediateDelay;
        if (isActiveConversation) {
            emojiImmediateDelay = 5000 + Math.random() * 25000; // 5-30s during active chat
        } else {
            emojiImmediateDelay = 30000 + Math.random() * 90000; // 30s-2min cold start
        }
        const emojiDelay = baseDelay + emojiImmediateDelay;
        setTimeout(() => {
            addEmojiReaction(lastMsgIndex, randomEmoji, randomReactor.id);
        }, emojiDelay);
        return;
    }

    // TEXT RESPONSE - Full logic (can be immediate or delayed)

    // 1. Thread Persistence & Direct Address Logic
    let persona = null;
    const onlineMembers = getMemberOnlineStatus();

    // A) Check for direct address (highest priority)
    for (const m of AI_MEMBERS) {
        const firstName = m.name.split(' ')[0].toLowerCase();
        if (lowMsg.includes(firstName)) {
            persona = m;
            break;
        }
    }

    // B) Active participants tracking (like real group chats!)
    if (!persona && fullHistory.length > 0) {
        const fifteenMinsAgo = Date.now() - (15 * 60 * 1000);
        const recentMessages = fullHistory.slice(-10).filter(m => m.timestamp > fifteenMinsAgo);

        const activeParticipants = [];
        const participantCounts = {};

        recentMessages.forEach(msg => {
            if (msg.authorId && msg.authorId !== 'current-user') {
                if (!participantCounts[msg.authorId]) {
                    participantCounts[msg.authorId] = 0;
                    const member = AI_MEMBERS.find(m => m.id === msg.authorId);
                    if (member && onlineMembers.includes(member.id)) {
                        activeParticipants.push(member);
                    }
                }
                participantCounts[msg.authorId]++;
            }
        });

        if (activeParticipants.length > 0) {
            const pickFromActive = Math.random() < 0.7; // 70% chance

            if (pickFromActive) {
                const weighted = [];
                activeParticipants.forEach(p => {
                    const count = participantCounts[p.id] || 1;
                    for (let i = 0; i < count; i++) {
                        weighted.push(p);
                    }
                });
                persona = weighted[Math.floor(Math.random() * weighted.length)];
            }
        }
    }

    // C) Fallback: pick someone random who's online
    if (!persona) {
        const onlineAIMembers = AI_MEMBERS.filter(m => onlineMembers.includes(m.id));
        persona = onlineAIMembers.length > 0
            ? onlineAIMembers[Math.floor(Math.random() * onlineAIMembers.length)]
            : AI_MEMBERS[Math.floor(Math.random() * AI_MEMBERS.length)];
    }

    // Multiple people typing at once (30% chance)
    const multipleTyping = Math.random() < 0.3 && chainCount === 0;
    let secondTyper = null;
    if (multipleTyping) {
        const otherOnlineMembers = AI_MEMBERS.filter(m => onlineMembers.includes(m.id) && m.id !== persona.id);
        if (otherOnlineMembers.length > 0) {
            secondTyper = otherOnlineMembers[Math.floor(Math.random() * otherOnlineMembers.length)];
        }
    }

    // Variable response timing based on conversation flow
    // Plus any delay from shouldRespondToMessage (for delayed responses)
    let immediateDelay;
    if (isActiveConversation) {
        // Active conversation: 15 seconds to 2 minutes
        immediateDelay = 15000 + Math.random() * 105000; // 15s-2min
    } else {
        // Cold start: 2-5 minutes
        immediateDelay = 120000 + Math.random() * 180000; // 2-5min
    }
    const totalDelay = baseDelay + immediateDelay;

    setTimeout(async () => {
        // Show typing indicator(s)
        addCommunityTypingIndicator(persona.name.split(' ')[0]);
        if (secondTyper) {
            setTimeout(() => addCommunityTypingIndicator(secondTyper.name.split(' ')[0]), 500 + Math.random() * 1000);
        }

        try {
            const historyContext = fullHistory.slice(-20).map(m => ({
                role: m.authorId === 'current-user' ? 'user' : 'model',
                text: `${m.authorName || 'Member'}: ${m.text}`,
                timestamp: m.timestamp
            }));

            // Determine what to respond to (current message vs earlier message)
            let contextMessage = userMsg;
            if (fullHistory.length > 3 && Math.random() < 0.25) {
                // 25% chance to respond to an earlier message (2-4 messages back)
                const lookBack = Math.floor(Math.random() * 3) + 2;
                const earlierMsg = fullHistory[fullHistory.length - lookBack];
                if (earlierMsg) {
                    contextMessage = `(Responding to earlier: "${earlierMsg.text}") ${userMsg}`;
                }
            }

            const response = await fetch('/.netlify/functions/ai-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mode: 'community',
                    message: contextMessage,
                    memberPersona: persona,
                    chatHistory: historyContext,
                    currentDateTime: new Date().toLocaleString(),
                    allowShortAcknowledgments: true // New flag for AI
                })
            });
            const data = await response.json();

            // If second typer, remove their indicator after first person responds
            if (secondTyper) {
                setTimeout(() => removeCommunityTypingIndicators(secondTyper.name.split(' ')[0]), 1000 + Math.random() * 2000);
            }

            if (data.reply) {
                const parts = data.reply.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());
                let totalDelay = 0;

                parts.forEach((part, idx) => {
                    if (idx > 0) {
                        setTimeout(() => addCommunityTypingIndicator(persona.name.split(' ')[0]), totalDelay);
                        totalDelay += 800 + Math.random() * 400;
                    }

                    const partDelay = 1200 + (part.length * 20);
                    setTimeout(() => {
                        removeCommunityTypingIndicators(persona.name.split(' ')[0]);
                        saveCommunityMessage(persona, part);

                        // If secondTyper exists, have them respond too (cross-talk!)
                        if (idx === parts.length - 1 && secondTyper && Math.random() < 0.6) {
                            const crossTalkDelay = 1000 + Math.random() * 2000; // 1-3s
                            setTimeout(() => triggerCrossTalkResponse(userMsg, secondTyper), crossTalkDelay);
                        }

                        // If it's the last part, consider triggering a peer response or jump-in
                        if (idx === parts.length - 1 && !secondTyper) {
                            if (chainCount < 2 && Math.random() < 0.35) {
                                const availableOnline = AI_MEMBERS.filter(m => onlineMembers.includes(m.id) && m.id !== persona.id);
                                if (availableOnline.length > 0) {
                                    const peerPersona = availableOnline[Math.floor(Math.random() * availableOnline.length)];
                                    const peerDelay = Math.random() < 0.5
                                        ? 2000 + Math.random() * 2000  // Fast: 2-4s
                                        : 5000 + Math.random() * 3000; // Slower: 5-8s
                                    setTimeout(() => triggerJumpInResponse(part, peerPersona, chainCount + 1), peerDelay);
                                }
                            }
                        }
                    }, totalDelay);
                    totalDelay += partDelay;
                });
            } else {
                removeCommunityTypingIndicators();
            }
        } catch (e) {
            removeCommunityTypingIndicators();
            console.log("Comm skip", e);
        }
    }, totalDelay);
}

async function triggerJumpInResponse(prevContext, persona, chainCount) {
    try {
        // Show typing indicator first
        addCommunityTypingIndicator(persona.name.split(' ')[0]);

        const fullHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
        const historyContext = fullHistory.slice(-20).map(m => ({
            role: m.authorId === 'current-user' ? 'user' : 'model',
            text: `${m.authorName || 'Member'}: ${m.text}`,
            timestamp: m.timestamp
        }));

        const response = await fetch('/.netlify/functions/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mode: 'community',
                message: `(Respond to: "${prevContext}")`,
                memberPersona: persona,
                chatHistory: historyContext,
                currentDateTime: new Date().toLocaleString(),
                allowShortAcknowledgments: true
            })
        });
        const data = await response.json();

        if (data.reply) {
            const parts = data.reply.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());
            let totalDelay = 0;

            parts.forEach((part, idx) => {
                if (idx > 0) {
                    // Show typing indicator before subsequent messages
                    setTimeout(() => addCommunityTypingIndicator(persona.name.split(' ')[0]), totalDelay);
                    totalDelay += 800 + Math.random() * 400; // 0.8-1.2s typing indicator
                }

                const partDelay = 1200 + (part.length * 20);
                setTimeout(() => {
                    removeCommunityTypingIndicators(persona.name.split(' ')[0]);
                    saveCommunityMessage(persona, part);

                    // Chain limit check with variable timing (only for online members)
                    if (idx === parts.length - 1 && chainCount < 2 && Math.random() < 0.3) {
                        const onlineMembers = getMemberOnlineStatus();
                        const availableNext = AI_MEMBERS.filter(m => m.id !== persona.id && onlineMembers.includes(m.id));
                        if (availableNext.length > 0) {
                            const nextPersona = availableNext[Math.floor(Math.random() * availableNext.length)];
                            const nextDelay = Math.random() < 0.5
                                ? 2000 + Math.random() * 2000  // Fast: 2-4s
                                : 4000 + Math.random() * 4000; // Slower: 4-8s
                            setTimeout(() => triggerJumpInResponse(part, nextPersona, chainCount + 1), nextDelay);
                        }
                    }
                }, totalDelay);
                totalDelay += partDelay;
            });
        } else {
            removeCommunityTypingIndicators(persona.name.split(' ')[0]);
        }
    } catch (e) {
        removeCommunityTypingIndicators(persona.name.split(' ')[0]);
        console.log("JumpIn skip", e);
    }
}

// Cross-talk: Second person responds with their own take
async function triggerCrossTalkResponse(originalMsg, persona) {
    try {
        // Short delay, then show typing
        setTimeout(() => {
            addCommunityTypingIndicator(persona.name.split(' ')[0]);
        }, 200);

        const fullHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
        const historyContext = fullHistory.slice(-20).map(m => ({
            role: m.authorId === 'current-user' ? 'user' : 'model',
            text: `${m.authorName || 'Member'}: ${m.text}`,
            timestamp: m.timestamp
        }));

        // Cross-talk often responds with short acknowledgments or different perspectives
        const response = await fetch('/.netlify/functions/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mode: 'community',
                message: originalMsg,
                memberPersona: persona,
                chatHistory: historyContext,
                currentDateTime: new Date().toLocaleString(),
                allowShortAcknowledgments: true,
                crossTalk: true // Flag for potentially shorter, different-angle response
            })
        });
        const data = await response.json();

        if (data.reply) {
            const parts = data.reply.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());
            let totalDelay = 0;

            parts.forEach((part, idx) => {
                if (idx > 0) {
                    setTimeout(() => addCommunityTypingIndicator(persona.name.split(' ')[0]), totalDelay);
                    totalDelay += 800 + Math.random() * 400;
                }

                const partDelay = 1200 + (part.length * 20);
                setTimeout(() => {
                    removeCommunityTypingIndicators(persona.name.split(' ')[0]);
                    saveCommunityMessage(persona, part);
                }, totalDelay);
                totalDelay += partDelay;
            });
        } else {
            removeCommunityTypingIndicators(persona.name.split(' ')[0]);
        }
    } catch (e) {
        removeCommunityTypingIndicators(persona.name.split(' ')[0]);
        console.log("CrossTalk skip", e);
    }
}

// ========================================
// AUTONOMOUS COMMUNITY MESSAGING SYSTEM
// ========================================

// Autonomous message topics for random conversations
const AUTONOMOUS_TOPICS = [
    { type: 'workout', prompts: [
        'Just finished an amazing morning walk! The fresh air really helps clear my head. Anyone else moving today?',
        'Did a gentle yoga flow this morning and feeling so much better. How do you all prefer to move?',
        'Trying to stay consistent with strength training but some days are harder than others. Anyone else struggling with motivation this week?',
        'That new workout in the Build section was challenging! How did everyone else find it?',
        'Taking a rest day today and trying not to feel guilty about it. Self-compassion is hard sometimes!',
        'Swimming has been such a game-changer for my joint pain. What movement makes you feel best?'
    ]},
    { type: 'nutrition', prompts: [
        'Made the most delicious plant-based Buddha bowl for lunch! Feeling so nourished. What\'s everyone eating today?',
        'Anyone else notice their cravings change throughout their cycle? I\'m craving all the green things this week.',
        'Finally nailed a good protein smoothie recipe. The key is frozen banana and a pinch of cinnamon!',
        'Struggling with meal prep this week. Life got busy. Anyone have quick go-to meals?',
        'My hot flashes have been better since I cut back on spicy foods. Anyone else notice food triggers?',
        'Just meal prepped for the week and feeling so organized! How do you all stay on track?'
    ]},
    { type: 'wellness', prompts: [
        'Had the best sleep last night after doing that evening wind-down routine. Game changer!',
        'Brain fog is real today. Anyone else? How do you cope when you\'re feeling scattered?',
        'Trying to be more mindful about my stress levels. Noticed my shoulders are always tense!',
        'The guided meditation in the resources section has been so helpful. Anyone else trying meditation?',
        'Feeling really grateful for this community today. It helps knowing we\'re all in this together.',
        'Energy levels have been all over the place this week. Hormones are wild! How\'s everyone feeling?'
    ]},
    { type: 'progress', prompts: [
        'Finally feeling like my cortisol is balancing out. The changes are subtle but they\'re there!',
        'Tracking my symptoms has been so eye-opening. Highly recommend if you haven\'t started yet.',
        'Hit a milestone today - 30 days of consistent movement! Never thought I\'d get here.',
        'Some days feel like steps backward, but trying to trust the process. Anyone else feel this way?',
        'My mood has been so much more stable lately. Plant-based eating is really making a difference.',
        'Noticing improvements in my sleep quality. It\'s the small wins that keep me going!'
    ]},
    { type: 'support', prompts: [
        'Having a tough day today. Just needed to share that with people who understand.',
        'This journey isn\'t linear and that\'s okay. Being gentle with myself today.',
        'Anyone else find perimenopause harder than they expected? Some days I feel lost.',
        'The support in this group means everything. Thank you for being here.',
        'Reminder to drink water! I always forget and then wonder why I feel terrible.',
        'How is everyone\'s week going? Really curious to hear how you\'re all doing.'
    ]}
];

// Saturday morning check-in prompts (Coach Shannon initiates these)
const SATURDAY_CHECKIN_PROMPTS = [
    'Morning everyone! Check-in time. How\'d your week go? I want to hear the real stuff - wins, struggles, whatever\'s on your mind.',
    'Hey everyone, Saturday check-in. What happened this week that actually mattered to you? Big or small, I\'m curious.',
    'Happy Saturday! Let\'s take a moment to reflect. What was the most challenging thing you dealt with this week and how did you work through it?',
    'Morning! Weekly check-in time. What surprised you about yourself this week? I always find these reflections so revealing.',
    'Saturday vibes! How are you all really doing? Share what\'s going on - the good, the messy, all of it.',
    'Hey friends! Check-in time. What did you learn about your body or your patterns this week? Let\'s share.',
    'Morning everyone. What\'s one thing from this week that you\'re still thinking about? Could be a win, a struggle, or just something that stuck with you.',
    'Saturday check-in! How did you take care of yourself this week? And how did it actually feel doing it?',
    'Hey all! Time for our weekly reflection. What was different about this week compared to last? Even small shifts count.',
    'Morning! Let\'s hear your stories. What moment this week made you feel most like yourself?'
];

// Get a random item from array
function getRandomItem(array) {
    return array[Math.floor(Math.random() * array.length)];
}

// Get random autonomous message prompt
function getRandomAutonomousPrompt() {
    const topic = getRandomItem(AUTONOMOUS_TOPICS);
    return getRandomItem(topic.prompts);
}

// Determine number of responses based on probability
function getResponseCount() {
    const rand = Math.random() * 100;
    if (rand < 10) return 0;      // 10% - no replies
    if (rand < 40) return 1;      // 30% - one reply
    if (rand < 75) return 2;      // 35% - two replies
    if (rand < 90) return 3;      // 15% - three replies
    return 4;                     // 10% - four replies
}

// Initiate autonomous community conversation
async function initiateAutonomousConversation(isCheckIn = false) {
    try {
        const fullHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');

        // Select initiating member
        let initiator;
        if (isCheckIn) {
            // Coach Shannon always leads Saturday check-ins
            initiator = AI_MEMBERS.find(m => m.id === 'm0');
        } else {
            // For random messages, exclude Coach Shannon for more natural peer feel
            const nonCoachMembers = AI_MEMBERS.filter(m => m.id !== 'm0');
            initiator = getRandomItem(nonCoachMembers);
        }

        // Get message content
        const messageText = isCheckIn ? getRandomItem(SATURDAY_CHECKIN_PROMPTS) : getRandomAutonomousPrompt();

        // Add initiator message to chat
        saveCommunityMessage(initiator, messageText);

        // Determine number of responses
        const responseCount = isCheckIn ? Math.floor(Math.random() * 3) + 18 : getResponseCount(); // Check-ins get 18-20 responses

        if (responseCount === 0) {
            console.log('Autonomous message sent with no replies');
            return;
        }

        // Generate responses with varying delays
        const availableResponders = AI_MEMBERS.filter(m => m.id !== initiator.id);
        const responders = [];

        // Select unique responders
        for (let i = 0; i < responseCount && responders.length < availableResponders.length; i++) {
            let responder;
            do {
                responder = getRandomItem(availableResponders);
            } while (responders.find(r => r.id === responder.id));
            responders.push(responder);
        }

        // Schedule responses with realistic delays
        responders.forEach((responder, idx) => {
            let delay;
            if (isCheckIn) {
                // Spread check-ins over 3-5 hours (10,800,000 - 18,000,000 ms)
                const minDelay = 3 * 60 * 60 * 1000; // 3 hours in ms
                const maxDelay = 5 * 60 * 60 * 1000; // 5 hours in ms
                const timeRange = maxDelay - minDelay;
                // Distribute responders across the time range with some randomness
                const basePosition = (idx / responseCount) * timeRange;
                const randomJitter = (Math.random() - 0.5) * (timeRange / responseCount) * 2;
                delay = minDelay + basePosition + randomJitter;
            } else {
                // Regular messages have shorter delays
                const baseDelay = 8000;
                const randomDelay = baseDelay + (Math.random() * 15000);
                delay = (idx * 10000) + randomDelay;
            }

            setTimeout(async () => {
                try {
                    const currentHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
                    const historyContext = currentHistory.slice(-20).map(m => ({
                        role: m.authorId === 'current-user' ? 'user' : 'model',
                        text: `${m.authorName || 'Member'}: ${m.text}`,
                        timestamp: m.timestamp
                    }));

                    // Get previous check-in stories for this member to build continuity
                    let previousStories = '';
                    if (isCheckIn) {
                        const checkInHistory = JSON.parse(localStorage.getItem('saturday_checkin_stories') || '{}');
                        if (checkInHistory[responder.id] && checkInHistory[responder.id].length > 0) {
                            const recentStories = checkInHistory[responder.id].slice(-3); // Last 3 check-ins
                            previousStories = '\nYour previous check-in reflections: ' + recentStories.map(s => `"${s}"`).join(' | ');
                        }
                    }

                    // Enhanced prompt for check-ins
                    let promptMessage = messageText;
                    if (isCheckIn) {
                        promptMessage = `(This is your Saturday morning check-in. Shannon is asking the group to reflect on their week. Share an authentic, personal story from your week - something real and specific that happened to you. Talk about actual moments, feelings, struggles, or wins. Be vulnerable and detailed. Build on your journey over time.${previousStories} Respond to: "${messageText}")`;
                    }

                    // Call AI to generate response
                    const response = await fetch('/.netlify/functions/ai-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            mode: 'community',
                            message: promptMessage,
                            memberPersona: responder,
                            chatHistory: historyContext,
                            currentDateTime: new Date().toLocaleString(),
                            isAutonomous: true
                        })
                    });

                    const data = await response.json();
                    if (data.reply) {
                        const parts = data.reply.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());
                        let totalDelay = 0;

                        parts.forEach((part, partIdx) => {
                            const partDelay = 1200 + (part.length * 20);
                            setTimeout(() => {
                                const msgs = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
                                msgs.push({
                                    authorId: responder.id,
                                    authorName: responder.name,
                                    authorAvatar: responder.id.replace('m', ''),
                                    text: part,
                                    timestamp: Date.now()
                                });
                                localStorage.setItem('community_chat_history', JSON.stringify(msgs));
                                if (typeof renderChat === 'function') renderChat(msgs);

                                // Save check-in story for continuity (only on last part)
                                if (isCheckIn && partIdx === parts.length - 1) {
                                    const checkInHistory = JSON.parse(localStorage.getItem('saturday_checkin_stories') || '{}');
                                    if (!checkInHistory[responder.id]) {
                                        checkInHistory[responder.id] = [];
                                    }
                                    // Store the full response (all parts combined) for this member
                                    checkInHistory[responder.id].push(data.reply.replace(/\s*\|\|\|\s*/g, ' '));
                                    // Keep only last 5 check-ins per member
                                    if (checkInHistory[responder.id].length > 5) {
                                        checkInHistory[responder.id].shift();
                                    }
                                    localStorage.setItem('saturday_checkin_stories', JSON.stringify(checkInHistory));

                                    // 40% chance someone reacts to this check-in story
                                    if (Math.random() < 0.4) {
                                        // Pick someone who will respond or has already responded
                                        const potentialReactors = responders.filter(r => r.id !== responder.id);
                                        if (potentialReactors.length > 0) {
                                            const reactor = getRandomItem(potentialReactors);
                                            const reactionDelay = 5000 + Math.random() * 15000; // 5-20 seconds after story
                                            setTimeout(() => {
                                                triggerCheckInReaction(part, responder, reactor);
                                            }, reactionDelay);
                                        }
                                    }
                                }
                            }, totalDelay);
                            totalDelay += partDelay;
                        });
                    }
                } catch (e) {
                    console.log('Autonomous response skip', e);
                }
            }, delay);
        });

    } catch (e) {
        console.log('Autonomous conversation skip', e);
    }
}

// Trigger a reaction/comment to a check-in story
async function triggerCheckInReaction(storyText, originalAuthor, reactor) {
    try {
        const currentHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
        const historyContext = currentHistory.slice(-20).map(m => ({
            role: m.authorId === 'current-user' ? 'user' : 'model',
            text: `${m.authorName || 'Member'}: ${m.text}`,
            timestamp: m.timestamp
        }));

        // Generate a supportive reaction/comment
        const reactionPrompt = `(${originalAuthor.name} just shared their check-in story. React to it with a brief, supportive comment. Be empathetic, relate to their experience, offer encouragement, or share how you connect with what they said. Keep it short and genuine - 1-2 sentences max. You're commenting on: "${storyText}")`;

        const response = await fetch('/.netlify/functions/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mode: 'community',
                message: reactionPrompt,
                memberPersona: reactor,
                chatHistory: historyContext,
                currentDateTime: new Date().toLocaleString(),
                isAutonomous: true
            })
        });

        const data = await response.json();
        if (data.reply) {
            // Reactions should be quick and short, no multi-part needed
            const reactionText = data.reply.replace(/\s*\|\|\|\s*/g, ' ');
            saveCommunityMessage(reactor, reactionText);
            
            console.log(`💬 ${reactor.name} reacted to ${originalAuthor.name}'s story`);
        }
    } catch (e) {
        console.log('Check-in reaction skip', e);
    }
}

// Check if it's Saturday morning (7-9 AM Brisbane time)
function isSaturdayMorning() {
    const now = new Date();

    // Convert to Brisbane time (AEST/AEDT UTC+10/+11)
    const brisbaneTime = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Brisbane' }));
    const day = brisbaneTime.getDay();
    const hour = brisbaneTime.getHours();

    return day === 6 && hour >= 7 && hour < 9;
}

// Get last check-in date
function getLastCheckInDate() {
    const lastCheckIn = localStorage.getItem('last_saturday_checkin');
    return lastCheckIn ? new Date(lastCheckIn) : null;
}

// Check if check-in already happened this week
function checkInAlreadyDone() {
    const lastCheckIn = getLastCheckInDate();
    if (!lastCheckIn) return false;

    const now = new Date();
    const daysSinceLastCheckIn = (now - lastCheckIn) / (1000 * 60 * 60 * 24);

    // If less than 6 days since last check-in, it already happened this week
    return daysSinceLastCheckIn < 6;
}

// Trigger Saturday morning check-in
function triggerSaturdayCheckIn() {
    if (checkInAlreadyDone()) {
        console.log('Saturday check-in already done this week');
        return;
    }

    console.log('Initiating Saturday morning check-in...');
    localStorage.setItem('last_saturday_checkin', new Date().toISOString());
    initiateAutonomousConversation(true);
}

// Get last autonomous message time
function getLastAutonomousMessageTime() {
    const lastTime = localStorage.getItem('last_autonomous_message');
    return lastTime ? parseInt(lastTime) : 0;
}

// Check if it's time for autonomous message
function shouldTriggerAutonomousMessage() {
    const lastTime = getLastAutonomousMessageTime();
    const now = Date.now();
    const timeSinceLast = now - lastTime;

    // Random interval between 1-2 hours (3600000-7200000 ms)
    const minInterval = 60 * 60 * 1000; // 1 hour
    const maxInterval = 2 * 60 * 60 * 1000; // 2 hours
    const randomInterval = minInterval + Math.random() * (maxInterval - minInterval);

    return timeSinceLast > randomInterval;
}

// Trigger random autonomous message
function triggerAutonomousMessage() {
    console.log('Initiating autonomous community message...');
    localStorage.setItem('last_autonomous_message', Date.now().toString());
    initiateAutonomousConversation(false);
}

// Main autonomous system controller
function checkAutonomousActivity() {
    // Check for Saturday morning check-in first
    if (isSaturdayMorning()) {
        triggerSaturdayCheckIn();
        return; // Don't do random messages during check-in window
    }

    // Check for random autonomous messages
    if (shouldTriggerAutonomousMessage()) {
        triggerAutonomousMessage();
    }
}

// Initialize autonomous system
function initializeAutonomousSystem() {
    console.log('Autonomous community messaging system initialized');

    // Check immediately on load
    setTimeout(() => {
        checkAutonomousActivity();
    }, 5000); // Wait 5 seconds after page load

    // Check every 30 minutes
    setInterval(() => {
        checkAutonomousActivity();
    }, 30 * 60 * 1000);
}

// Start autonomous system when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAutonomousSystem);
} else {
    initializeAutonomousSystem();
}

// ========================================
// TESTING & DEBUG FUNCTIONS
// ========================================

// Manual triggers for testing (accessible via browser console)
window.testAutonomousMessage = function() {
    console.log('🧪 Testing autonomous message...');
    initiateAutonomousConversation(false);
};

window.testSaturdayCheckIn = function() {
    console.log('🧪 Testing Saturday check-in...');
    initiateAutonomousConversation(true);
};

window.resetAutonomousTimers = function() {
    console.log('🔄 Resetting autonomous timers...');
    localStorage.removeItem('last_autonomous_message');
    localStorage.removeItem('last_saturday_checkin');
    console.log('✅ Timers reset! Next check will trigger new messages.');
};

window.getAutonomousStatus = function() {
    const lastMsg = getLastAutonomousMessageTime();
    const lastCheckIn = getLastCheckInDate();
    const nextMsgIn = lastMsg ? Math.max(0, (60 * 60 * 1000) - (Date.now() - lastMsg)) : 0;

    console.log('📊 Autonomous System Status:');
    console.log('─────────────────────────────');
    console.log(`Last autonomous message: ${lastMsg ? new Date(lastMsg).toLocaleString() : 'Never'}`);
    console.log(`Next message in: ${Math.floor(nextMsgIn / 60000)} minutes (approximately)`);
    console.log(`Last Saturday check-in: ${lastCheckIn ? lastCheckIn.toLocaleString() : 'Never'}`);
    console.log(`Is Saturday morning now: ${isSaturdayMorning()}`);
    console.log(`Check-in already done this week: ${checkInAlreadyDone()}`);
    console.log('─────────────────────────────');
    console.log('💡 Try: testAutonomousMessage() or testSaturdayCheckIn()');
    console.log('💡 View stories: viewCheckInStories()');
};

window.viewCheckInStories = function(memberId) {
    const checkInHistory = JSON.parse(localStorage.getItem('saturday_checkin_stories') || '{}');

    if (memberId) {
        // Show specific member's stories
        const member = AI_MEMBERS.find(m => m.id === memberId);
        if (!member) {
            console.log(`❌ Member ${memberId} not found`);
            return;
        }
        console.log(`\n📖 Check-in Stories for ${member.name} (${memberId})`);
        console.log('═══════════════════════════════════════');
        if (checkInHistory[memberId] && checkInHistory[memberId].length > 0) {
            checkInHistory[memberId].forEach((story, idx) => {
                console.log(`\n[Week ${idx + 1}]:`);
                console.log(story);
                console.log('─────────────────────────────────────');
            });
        } else {
            console.log('No stories yet for this member.');
        }
    } else {
        // Show all members with stories
        console.log('\n📚 All Saturday Check-in Story History');
        console.log('═══════════════════════════════════════');
        const membersWithStories = Object.keys(checkInHistory);
        if (membersWithStories.length === 0) {
            console.log('No check-in stories recorded yet.');
            console.log('\n💡 Run testSaturdayCheckIn() to generate some stories!');
        } else {
            membersWithStories.forEach(id => {
                const member = AI_MEMBERS.find(m => m.id === id);
                const storyCount = checkInHistory[id].length;
                console.log(`\n${member ? member.name : id} (${id}): ${storyCount} check-in${storyCount > 1 ? 's' : ''}`);
                console.log(`💡 View details: viewCheckInStories('${id}')`);
            });
        }
    }
};

// ========================================
// END AUTONOMOUS COMMUNITY MESSAGING
// ========================================

window.openAsClient = function() {
    toggleCoachMode(false);
    if(typeof switchAppTab === 'function') switchAppTab('dashboard');
    const btn = document.createElement('div');
    btn.id = 'return-to-coach-btn';
    btn.innerHTML = '⏎ Return to Coach View';
    btn.style.cssText = 'position:fixed; bottom:90px; right:20px; background:#1e293b; color:white; padding:12px 20px; border-radius:50px; font-weight:bold; box-shadow:0 10px 25px rgba(0,0,0,0.3); z-index:10000; cursor:pointer; font-size:0.9rem;';
    btn.onclick = () => toggleCoachMode(true);
    document.body.appendChild(btn);
};

// Old submitCoachMessage removed as it is now defined earlier in the file.

async function getChatHistory() {
    if(!window.currentUser) return [];
    // Get both 'coach' and legacy 'shannon' messages and merge them
    const [coachHistory, shannonHistory] = await Promise.all([
        dbHelpers.conversations.getHistory(window.currentUser.id, 'coach'),
        dbHelpers.conversations.getHistory(window.currentUser.id, 'shannon')
    ]);
    // Combine and sort by timestamp
    const combined = [...coachHistory, ...shannonHistory];
    combined.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    return combined;
}

async function saveToHistory(role, text) {
    if(!window.currentUser) return;
    await dbHelpers.conversations.create(window.currentUser.id, 'coach', role, text);
}

window.loadChatHistory = async function() {
    const container = document.getElementById('chat-messages-container');
    if (!container) return;
    
    // Clear waiting for load
    container.innerHTML = ''; 

    const history = await getChatHistory();

    // Only show default welcome message if there's no chat history
    if (history.length === 0) {
        const profile = await window.getUserProfile();
        const userName = profile?.name || '';
        const greeting = userName ? `Hey ${userName}!` : 'Hey!';
        container.innerHTML = `
            <div style="display: flex; justify-content: flex-start; align-items: flex-end; margin-bottom: 20px; animation: fadeIn 0.3s ease;">
                 <img src="assets/coach_shannon.jpg" style="width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); object-fit: cover;">
                 <div style="display: flex; flex-direction: column; align-items: flex-start; max-width: 80%;">
                     <div style="background: var(--chat-bg-coach); color: var(--chat-text-coach); padding: 12px 18px; border-radius: 18px 18px 18px 0; border: 1px solid var(--chat-border-coach); font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">
                         <p style="margin: 0; white-space: pre-wrap;">${greeting} Shannon here. Thanks so much for joining the app! If you need anything or have ideas for new features, just let me know and I'll see what I can do.</p>
                     </div>
                     <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-left: 5px;">Shannon  Always here</span>
                 </div>
            </div>`;
    }

    history.forEach(msg => {
        const isUser = msg.role === 'user';
        const rowDiv = document.createElement('div');
        rowDiv.style.cssText = `display: flex; justify-content: ${isUser ? 'flex-end' : 'flex-start'}; align-items: flex-end; margin-bottom: 20px; animation: fadeIn 0.3s ease;`;
        
        const timestamp = msg.timestamp || msg.created_at || Date.now();
        const timeStr = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const msgText = msg.message_text || msg.text || '';

        if (isUser) {
             rowDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: flex-end; max-width: 80%;">
                    <div style="background: var(--chat-bg-user); color: var(--chat-text-user); padding: 12px 18px; border-radius: 18px 18px 0 18px; font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">${msgText}</div>
                    <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-right: 5px;">You ${timeStr}</span>
                </div>
                <img src="https://ui-avatars.com/api/?name=You&background=cbd5e1&color=fff" style="width: 36px; height: 36px; border-radius: 50%; margin-left: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            `;
        } else {
             rowDiv.innerHTML = `
                <img src="assets/coach_shannon.jpg" style="width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); object-fit: cover;">
                <div style="display: flex; flex-direction: column; align-items: flex-start; max-width: 80%;">
                    <div style="background: var(--chat-bg-coach); color: var(--chat-text-coach); padding: 12px 18px; border-radius: 18px 18px 18px 0; border: 1px solid var(--chat-border-coach); font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">
                        <p style="margin: 0; white-space: pre-wrap;">${msgText.replace(/\*\*/g, '').replace(/\*/g, '')}</p>
                    </div>
                    <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-left: 5px;">Shannon ${timeStr}</span>
                </div>
            `;
        }
        container.appendChild(rowDiv);
    });
    scrollToBottomOfChat();
};

window.appendCoachMessage = async function(text) {
    const container = document.getElementById('chat-messages-container');
    if (!container) return;
    
    const rowDiv = document.createElement('div');
    rowDiv.style.cssText = "display: flex; justify-content: flex-start; align-items: flex-end; margin-bottom: 20px; animation: fadeIn 0.3s ease;";
    
    const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    rowDiv.innerHTML = `
        <img src="assets/coach_shannon.jpg" style="width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); object-fit: cover;">
        <div style="display: flex; flex-direction: column; align-items: flex-start; max-width: 80%;">
            <div style="background: var(--chat-bg-coach); color: var(--chat-text-coach); padding: 12px 18px; border-radius: 18px 18px 18px 0; border: 1px solid var(--chat-border-coach); font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">
                <p style="margin: 0; white-space: pre-wrap;">${text.replace(/\*\*/g, '').replace(/\*/g, '')}</p>
            </div>
            <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-left: 5px;">Shannon ${timeStr}</span>
        </div>
    `;

    container.appendChild(rowDiv);
    scrollToBottomOfChat();

    // Save to DB (skip if already saved - e.g., from realtime subscription)
    if (!window._skipCoachMessageSave) {
        await saveToHistory('model', text);
    }
    window._skipCoachMessageSave = false;

    // Mark as unread (this will trigger the glow effect on the Support tab)
    localStorage.setItem('coach_unread_messages', 'true');

    // Send push notification
    if(typeof sendCoachNotification === 'function') sendCoachNotification(text);

    // Notification Badge on App Icon
    if ('setAppBadge' in navigator && document.visibilityState === 'hidden') {
        navigator.setAppBadge(1).catch(e => console.error(e));
    }
};

/**
 * Subscribe to Supabase Realtime for new coach messages
 * This allows messages to appear instantly when approved by admin
 */
window.subscribeToCoachMessages = function(userId) {
    if (!userId || !window.supabaseClient) return;

    // Track message IDs we've already shown to avoid duplicates
    window._shownMessageIds = window._shownMessageIds || new Set();

    const channel = window.supabaseClient
        .channel('coach-messages-' + userId)
        .on(
            'postgres_changes',
            {
                event: 'INSERT',
                schema: 'public',
                table: 'conversations',
                filter: `user_id=eq.${userId}`
            },
            (payload) => {
                const newMessage = payload.new;

                // Only show assistant/coach messages, not user messages
                if (newMessage.role === 'assistant' || newMessage.role === 'model') {
                    // Avoid duplicates
                    if (window._shownMessageIds.has(newMessage.id)) return;
                    window._shownMessageIds.add(newMessage.id);

                    // Skip the save since it's already in the DB
                    window._skipCoachMessageSave = true;

                    // Display the message
                    appendCoachMessage(newMessage.message_text);

                    console.log('Realtime: New coach message received!');
                }
            }
        )
        .subscribe((status) => {
            console.log('Realtime subscription status:', status);
        });

    // Store channel reference for cleanup
    window._coachMessagesChannel = channel;
};

window.openCoachChat = function() {
    document.getElementById('view-support').style.display = 'block';

    // Clear unread flag (this will remove the glow effect from the Support tab)
    localStorage.removeItem('coach_unread_messages');

    // Clear Badge
    if ('clearAppBadge' in navigator) {
        navigator.clearAppBadge().catch(e => console.error(e));
    }
    if ('setAppBadge' in navigator) {
        navigator.setAppBadge(0).catch(e => console.error(e));
    }
};

// Helper to save AI community messages to DB and Local Cache
async function saveCommunityMessage(persona, text) {
    // 1. Save to DB (Fire and forget to avoid blocking UI too much, or await if needed)
    const user = window.currentUser;
    if(user) {
        // We do not await this to keep UI snappy for animations, or we catch errors
        dbHelpers.conversations.create(user.id, 'community', 'model', text, persona.name).catch(e => console.error("DB Save Error", e));
    }

    // 2. Update Local Cache (for immediate UI and autonomous logic)
    let msgs = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
    
    // SAFETY LIMIT: Only keep last 50 messages to prevent crash
    if (msgs.length > 50) {
        msgs = msgs.slice(msgs.length - 50); 
    }

    msgs.push({
        authorId: persona.id,
        authorName: persona.name,
        authorAvatar: (persona.id || 'm1').replace('m', ''),
        text: text,
        timestamp: Date.now()
    });
    
    try {
        localStorage.setItem('community_chat_history', JSON.stringify(msgs));
    } catch(e) {
        console.warn("Storage full, clearing old history");
        localStorage.removeItem('community_chat_history'); // Emergency clear
    }
    
    // 3. Render
    if(typeof renderChat === 'function') renderChat(msgs);
}

window.loadCommunityFeed = async function() {
    if(!window.currentUser) return;

    try {
        // Get user's referral network (people they invited + who invited them)
        const network = await dbHelpers.referrals.getReferralNetwork(window.currentUser.id);

        // Create a Set of allowed user IDs (network + current user)
        const allowedUserIds = new Set([window.currentUser.id]);
        if (network && network.length > 0) {
            network.forEach(n => allowedUserIds.add(n.network_user_id));
        }

        // Get all community messages for this user
        const dbMessages = await dbHelpers.conversations.getHistory(window.currentUser.id, 'community');

        // Filter to only show messages from referral network
        const filteredMessages = dbMessages.filter(m => allowedUserIds.has(m.user_id));

        // Map DB messages to UI format for human-only chat
        const messages = filteredMessages.map(m => {
            const isCurrentUser = m.user_id === window.currentUser.id;

            return {
                authorId: isCurrentUser ? 'current-user' : (m.user_id || 'other-user'),
                authorName: m.author_name || (isCurrentUser ? 'You' : 'Friend'),
                authorAvatar: m.author_avatar || '', // Will show initials if no avatar
                text: m.message_text || m.text,
                timestamp: m.timestamp || new Date(m.created_at).getTime(),
                reactions: m.reactions || []
            };
        });

        // Cache for UI (keep last 50 messages)
        const cachedMessages = messages.slice(-50);
        localStorage.setItem('community_chat_history', JSON.stringify(cachedMessages));

        if(typeof renderChat === 'function') renderChat(cachedMessages);
    } catch (error) {
        console.error('Error loading community feed:', error);
        // Show empty chat on error
        if(typeof renderChat === 'function') renderChat([]);
    }
};

async function sendCommunityMessage() {
    const input = document.getElementById('community-chat-input');
    const text = input.value?.trim();
    if(!text) return;
    
    input.value = '';
    
    // Optimistic UI Update
    const user = window.currentUser || {};
    const userName = (await window.getUserProfile())?.name || 'Friend';
    
    const tempMsg = { 
        authorId: 'current-user', 
        authorName: userName,
        text, 
        timestamp: Date.now() 
    };
    
    const messages = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
    messages.push(tempMsg);
    renderChat(messages); // Render immediately
    
    // Save to DB
    await dbHelpers.conversations.create(user.id, 'community', 'user', text, userName);

    // No AI responses - this is human-only referral network chat
}

// --- REFERRAL SYSTEM ---

let currentReferralCode = null;

// Client-side fallback code generator (used if database function fails)
function generateReferralCodeFallback() {
    // Generate a random 8-character alphanumeric code
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    console.log('Generated fallback referral code:', code);
    return code;
}

// Check if referral code already exists in database
async function isReferralCodeUnique(code) {
    try {
        const existingUser = await window.dbHelpers.referrals.getUserByReferralCode(code);
        return !existingUser; // If no user found, code is unique
    } catch (error) {
        // If error is "not found", code is unique
        if (error.message && error.message.includes('not found')) {
            return true;
        }
        console.error('Error checking code uniqueness:', error);
        return true; // Assume unique if we can't check
    }
}

// Dismiss referral banner
function dismissReferralBanner() {
    const banner = document.getElementById('referral-invite-banner');
    if (banner) {
        banner.style.display = 'none';
        localStorage.setItem('referral_banner_dismissed', 'true');
    }
}

// Check if banner was dismissed and hide it
function checkReferralBannerDismissed() {
    const dismissed = localStorage.getItem('referral_banner_dismissed');
    if (dismissed === 'true') {
        const banner = document.getElementById('referral-invite-banner');
        if (banner) banner.style.display = 'none';
    }
}

// Load referral stats and update UI
async function loadReferralStats() {
    if (!window.currentUser) {
        const error = new Error('No current user found. Please ensure you are logged in.');
        console.error('loadReferralStats:', error.message);
        throw error;
    }

    // Check if banner was dismissed
    checkReferralBannerDismissed();

    try {
        console.log('Loading referral stats for user:', window.currentUser.id);
        const stats = await window.dbHelpers.referrals.getStats(window.currentUser.id);
        console.log('Referral stats loaded:', stats);

        // Check if user has a referral code, if not generate one using database function
        if (!stats.referralCode) {
            console.log('No referral code found, generating one...');

            let newCode = null;
            let usedFallback = false;

            try {
                // Try database function first
                console.log('Calling database generateReferralCode()...');
                newCode = await window.dbHelpers.referrals.generateReferralCode();
                console.log('Generated code via database:', newCode);

                if (!newCode) {
                    console.warn('Database function returned no code, using fallback generator');
                    usedFallback = true;
                    throw new Error('Database returned null');
                }
            } catch (dbError) {
                console.error('Database code generation failed:', dbError.message);
                console.log('Falling back to client-side code generation...');
                usedFallback = true;

                // Try client-side generation with uniqueness check
                let attempts = 0;
                const maxAttempts = 10;

                while (attempts < maxAttempts) {
                    newCode = generateReferralCodeFallback();
                    const isUnique = await isReferralCodeUnique(newCode);

                    if (isUnique) {
                        console.log('✓ Generated unique code (client-side):', newCode);
                        break;
                    }

                    attempts++;
                    console.log(`Code collision, retrying... (${attempts}/${maxAttempts})`);
                }

                if (attempts >= maxAttempts) {
                    throw new Error('Failed to generate unique referral code after multiple attempts');
                }
            }

            // Update user record with new referral code
            if (newCode) {
                try {
                    console.log('Updating user with new referral code...');
                    await window.dbHelpers.users.update(window.currentUser.id, {
                        referral_code: newCode
                    });
                    stats.referralCode = newCode;
                    console.log(`✓ Successfully saved referral code (${usedFallback ? 'fallback' : 'database'}):`, newCode);
                } catch (updateError) {
                    console.error('❌ Error saving referral code:', updateError);
                    throw new Error(`Failed to save referral code: ${updateError.message}`);
                }
            } else {
                throw new Error('No referral code generated');
            }
        }

        // Update stats in banner
        if (document.getElementById('referral-count')) {
            document.getElementById('referral-count').textContent = stats.totalReferrals || 0;
        }
        if (document.getElementById('free-days-count')) {
            document.getElementById('free-days-count').textContent = stats.freeDaysEarned || 0;
        }

        // Update network count in header
        const networkCount = stats.totalReferrals || 0;
        if (document.getElementById('referral-network-count')) {
            document.getElementById('referral-network-count').textContent =
                networkCount === 0 ? 'Invite your first friend' :
                networkCount === 1 ? '1 friend in your network' :
                `${networkCount} friends in your network`;
        }

        // Store code for modal
        currentReferralCode = stats.referralCode;
        console.log('✓ Current referral code set to:', currentReferralCode);

    } catch (error) {
        console.error('❌ Error loading referral stats:', error);
        console.error('Error stack:', error.stack);
        // Re-throw to allow caller to handle
        throw error;
    }
}

// Open share modal
async function openShareReferralModal() {
    const modal = document.getElementById('share-referral-modal');
    if (!modal) {
        console.error('Share referral modal not found');
        return;
    }

    // Show modal with flex display
    modal.style.display = 'flex';

    const codeDisplay = document.getElementById('referral-code-display');
    if (!codeDisplay) {
        console.error('Referral code display element not found');
        return;
    }

    // Show loading state
    codeDisplay.textContent = 'Loading...';
    codeDisplay.style.color = 'var(--text-muted)';

    // Wait for authentication if not ready
    if (!window.currentUser) {
        console.log('Waiting for authentication...');
        let attempts = 0;
        const maxAttempts = 30; // 3 seconds max wait

        while (!window.currentUser && attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }

        if (!window.currentUser) {
            console.error('Authentication timeout - user not available');
            codeDisplay.textContent = 'Please log in first';
            codeDisplay.style.color = '#ef4444';

            setTimeout(() => {
                codeDisplay.textContent = 'Tap to retry';
                codeDisplay.style.cursor = 'pointer';
                codeDisplay.onclick = async () => {
                    codeDisplay.onclick = null;
                    codeDisplay.style.cursor = 'default';
                    codeDisplay.textContent = 'Loading...';
                    codeDisplay.style.color = 'var(--text-muted)';
                    await openShareReferralModal();
                };
            }, 2000);
            return;
        }
    }

    // If we don't have a referral code yet, try to load it
    if (!currentReferralCode) {
        try {
            console.log('Loading referral stats...');
            await loadReferralStats();
        } catch (error) {
            console.error('Failed to load referral stats:', error);
            codeDisplay.textContent = 'Failed to load code';
            codeDisplay.style.color = '#ef4444';

            // Show user-friendly error message with details
            const errorMsg = error.message || 'Unknown error';
            console.error('Error details:', errorMsg);

            setTimeout(() => {
                codeDisplay.textContent = 'Tap to retry';
                codeDisplay.style.cursor = 'pointer';
                codeDisplay.onclick = async () => {
                    codeDisplay.onclick = null;
                    codeDisplay.style.cursor = 'default';
                    codeDisplay.textContent = 'Loading...';
                    codeDisplay.style.color = 'var(--text-muted)';
                    await openShareReferralModal();
                };
            }, 2000);
            return;
        }
    }

    // Load and display referral code
    if (currentReferralCode) {
        codeDisplay.textContent = currentReferralCode;
        codeDisplay.style.color = 'var(--primary)';
        codeDisplay.style.cursor = 'default';
        codeDisplay.onclick = null;
        console.log('✓ Referral code displayed:', currentReferralCode);
    } else {
        // Fallback if still no code after successful load
        console.error('No referral code available after loading');
        codeDisplay.textContent = 'Tap to retry';
        codeDisplay.style.color = '#ef4444';
        codeDisplay.style.cursor = 'pointer';
        codeDisplay.onclick = async () => {
            codeDisplay.onclick = null;
            codeDisplay.style.cursor = 'default';
            codeDisplay.textContent = 'Loading...';
            codeDisplay.style.color = 'var(--text-muted)';
            await openShareReferralModal();
        };
    }
}

// Close share modal
function closeShareReferralModal() {
    const modal = document.getElementById('share-referral-modal');
    if (modal) modal.style.display = 'none';
}

// Copy referral code
function copyReferralCode() {
    const codeDisplay = document.getElementById('referral-code-display');
    const code = codeDisplay.textContent;

    navigator.clipboard.writeText(code).then(() => {
        // Show feedback
        const originalText = codeDisplay.textContent;
        codeDisplay.textContent = 'Copied!';
        codeDisplay.style.color = '#22c55e';

        setTimeout(() => {
            codeDisplay.textContent = originalText;
            codeDisplay.style.color = 'var(--primary)';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy code. Please copy manually.');
    });
}

// Share via WhatsApp
function shareViaWhatsApp() {
    const code = currentReferralCode;
    const link = `${window.location.origin}/login.html?ref=${code}`;
    const message = `Hey! I've been loving Plant Based Balance for hormone health. Join me and we BOTH get 2 weeks free! Use my code ${code} or click here: ${link}`;

    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

// Share via Facebook Messenger
function shareViaFacebook() {
    const code = currentReferralCode;
    const link = `${window.location.origin}/login.html?ref=${code}`;
    const message = `Hey! I've been loving Plant Based Balance for hormone health. Join me and we BOTH get 2 weeks free! Use my code ${code} or click: ${link}`;

    // Try to open Facebook Messenger app
    const messengerUrl = `fb-messenger://share?link=${encodeURIComponent(link)}&app_id=`;

    // On mobile, this will open Messenger app
    // On desktop, fallback to sharing dialog
    window.location.href = messengerUrl;
}

// Share via SMS
function shareViaSMS() {
    const code = currentReferralCode;
    const link = `${window.location.origin}/login.html?ref=${code}`;
    const message = `Hey! Join me on Plant Based Balance. We BOTH get 2 weeks free! Use code ${code} or click: ${link}`;

    const smsUrl = `sms:?&body=${encodeURIComponent(message)}`;
    window.location.href = smsUrl;
}

// Load referral stats when community tab is opened
window.addEventListener('DOMContentLoaded', () => {
    // Attach to tab switching logic
    const originalShowSupportTab = window.showSupportTab;
    if (typeof originalShowSupportTab === 'function') {
        window.showSupportTab = function(tab, element) {
            originalShowSupportTab(tab, element);
            if (tab === 'community') {
                loadReferralStats();
            }
        };
    }
});

// --- THEME SYSTEM ---
// --- THEME SYSTEM ---
const APP_THEMES = {
    'default': {
        name: 'Forest (Premium)',
        colors: {
            '--primary': '#7BA883',
            '--primary-light': '#98C9A3',
            '--secondary': '#E8D68E',
            '--accent-green': '#f2f7f4',
            '--bg': '#f9f9f7',
            '--surface': '#ffffff',
            '--text-main': '#1a202c',
            '--text-muted': '#718096',
            '--chat-bg-user': '#7BA883',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f2f7f4',
            '--chat-text-coach': '#1a202c',
            '--chat-border-coach': '#e2e8f0'
        }
    },
    'flower-garden': {
        name: 'Flower Garden',
        colors: {
            '--primary': '#D98B9C',
            '--primary-light': '#F4B4C4',
            '--secondary': '#B4A7D6',
            '--accent-green': '#FFF8F5',
            '--bg': '#FFFBF9',
            '--surface': '#ffffff',
            '--text-main': '#4A3F44',
            '--text-muted': '#8B7D82',
            '--chat-bg-user': '#D98B9C',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#FFF8F5',
            '--chat-text-coach': '#4A3F44',
            '--chat-border-coach': '#F4B4C4'
        }
    },
    'antigravity-light': {
        name: 'Antigravity Light',
        colors: {
            '--primary': '#4f46e5',
            '--primary-light': '#6366f1',
            '--secondary': '#0891b2',
            '--accent-green': '#eff6ff',
            '--bg': '#ffffff',
            '--surface': '#f8fafc',
            '--text-main': '#0f172a',
            '--text-muted': '#64748b',
            '--chat-bg-user': '#4f46e5',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f1f5f9',
            '--chat-text-coach': '#0f172a',
            '--chat-border-coach': '#e2e8f0'
        }
    },
    'ocean': { 
        name: 'Ocean Calm', 
        colors: { 
            '--primary': '#0369a1', 
            '--primary-light': '#0ea5e9', 
            '--secondary': '#db2777', 
            '--accent-green': '#f0f9ff', 
            '--bg': '#f0f9ff', 
            '--surface': '#ffffff', 
            '--text-main': '#082f49', 
            '--text-muted': '#64748b',
            '--chat-bg-user': '#0369a1',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f1f5f9',
            '--chat-text-coach': '#082f49',
            '--chat-border-coach': '#e0f2fe'
        } 
    },
    'sunset': { 
        name: 'Sunset Glow', 
        colors: { 
            '--primary': '#9d174d', 
            '--primary-light': '#be123c', 
            '--secondary': '#ea580c', 
            '--accent-green': '#fff1f2', 
            '--bg': '#fff1f2', 
            '--surface': '#ffffff', 
            '--text-main': '#500724', 
            '--text-muted': '#9d174d',
            '--chat-bg-user': '#9d174d',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#fff5f5',
            '--chat-text-coach': '#500724',
            '--chat-border-coach': '#ffe4e6'
        } 
    },
    'cycle-pink': {
        name: 'Cycle Harmony',
        colors: {
            '--primary': '#D81B60',
            '--primary-light': '#F06292',
            '--secondary': '#AB47BC',
            '--accent-green': '#FCE4EC',
            '--bg': '#FCE4EC',
            '--surface': '#ffffff',
            '--text-main': '#880E4F',
            '--text-muted': '#AD1457',
            '--chat-bg-user': '#D81B60',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#F8BBD0',
            '--chat-text-coach': '#880E4F',
            '--chat-border-coach': '#F48FB1'
        }
    },
    'midnight': {
        name: 'Midnight Luxe',
        colors: {
            '--primary': '#0f172a', // Slate 900
            '--primary-light': '#1e293b', // Slate 800
            '--secondary': '#fbbf24', // Amber 400
            '--accent-green': '#334155', // Slate 700
            '--bg': '#020617', // Slate 950
            '--surface': '#1e293b', // Slate 800
            '--text-main': '#f8fafc', // Slate 50
            '--text-muted': '#94a3b8', // Slate 400
            '--chat-bg-user': '#3b82f6',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#1e293b',
            '--chat-text-coach': '#f8fafc',
            '--chat-border-coach': '#334155'
        }
    },
    'lavender': {
        name: 'Lavender Haze',
        colors: {
            '--primary': '#6b21a8', // Purple 800
            '--primary-light': '#7e22ce', // Purple 700
            '--secondary': '#fcd34d', // Amber 300
            '--accent-green': '#faf5ff', // Purple 50
            '--bg': '#faf5ff', 
            '--surface': '#ffffff',
            '--text-main': '#4c1d95',
            '--text-muted': '#9333ea',
            '--chat-bg-user': '#6b21a8',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f3e8ff',
            '--chat-text-coach': '#4c1d95',
            '--chat-border-coach': '#e9d5ff'
        }
    },
    'matcha': {
        name: 'Matcha Latte',
        colors: {
            '--primary': '#3f6212', // Lime 800
            '--primary-light': '#4d7c0f', // Lime 700
            '--secondary': '#a3e635', // Lime 400
            '--accent-green': '#f7fee7', // Lime 50
            '--bg': '#f7fee7',
            '--surface': '#ffffff',
            '--text-main': '#1a2e05',
            '--text-muted': '#4d7c0f',
            '--chat-bg-user': '#3f6212',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#ecfccb',
            '--chat-text-coach': '#1a2e05',
            '--chat-border-coach': '#d9f99d'
        }
    },
    'monochrome': {
        name: 'Monochrome',
        colors: {
            '--primary': '#1a1a1a', // Near black
            '--primary-light': '#333333', // Dark gray
            '--secondary': '#666666', // Medium gray
            '--accent-green': '#f5f5f5', // Light gray
            '--bg': '#ffffff', // White
            '--surface': '#fafafa', // Off-white
            '--text-main': '#1a1a1a', // Near black
            '--text-muted': '#737373', // Gray
            '--chat-bg-user': '#1a1a1a',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f5f5f5',
            '--chat-text-coach': '#1a1a1a',
            '--chat-border-coach': '#e5e5e5'
        }
    },
    'dbz-warrior': {
        name: 'Super Saiyan',
        maleOnly: true,
        colors: {
            '--primary': '#FF6B00', // Goku's gi orange
            '--primary-light': '#FF8C00', // Lighter orange
            '--secondary': '#FFD700', // Super Saiyan gold
            '--accent-green': '#FFF8E7', // Warm light background
            '--bg': '#FFFAF0', // Floral white warm
            '--surface': '#ffffff',
            '--text-main': '#1a1a1a',
            '--text-muted': '#8B4513', // Saddle brown
            '--chat-bg-user': '#FF6B00',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#FFF8E7',
            '--chat-text-coach': '#1a1a1a',
            '--chat-border-coach': '#FFD700'
        }
    },
    'dbz-vegeta': {
        name: 'Saiyan Prince',
        maleOnly: true,
        colors: {
            '--primary': '#0047AB', // Royal blue (Vegeta's suit)
            '--primary-light': '#1E90FF', // Dodger blue
            '--secondary': '#FFD700', // Super Saiyan gold
            '--accent-green': '#F0F8FF', // Alice blue
            '--bg': '#F5F9FF', // Light blue tint
            '--surface': '#ffffff',
            '--text-main': '#0a1628',
            '--text-muted': '#4a5568',
            '--chat-bg-user': '#0047AB',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#F0F8FF',
            '--chat-text-coach': '#0a1628',
            '--chat-border-coach': '#87CEEB'
        }
    }
};

// Function to create falling flower animation for flower-garden theme
function createFallingFlowerAnimation() {
    const flowerAssets = [
        'assets/flower-cherry-blossom.svg',
        'assets/flower-rose.svg',
        'assets/flower-daisy.svg',
        'assets/flower-peony.svg',
        'assets/flower-lavender.svg'
    ];

    const numberOfFlowers = 15; // Number of flowers to fall
    const containerWidth = window.innerWidth;

    for (let i = 0; i < numberOfFlowers; i++) {
        setTimeout(() => {
            const flower = document.createElement('div');
            flower.className = 'falling-flower';

            // Random flower type
            const randomFlower = flowerAssets[Math.floor(Math.random() * flowerAssets.length)];
            flower.style.backgroundImage = `url('${randomFlower}')`;

            // Random horizontal position
            const randomX = Math.random() * containerWidth;
            flower.style.left = randomX + 'px';
            flower.style.top = '-100px';

            // Random size variation (30px to 50px)
            const randomSize = 30 + Math.random() * 20;
            flower.style.width = randomSize + 'px';
            flower.style.height = randomSize + 'px';

            // Random animation duration (4s to 7s for graceful fall)
            const randomDuration = 4 + Math.random() * 3;
            flower.style.animation = `flowerFall ${randomDuration}s ease-in-out forwards`;

            // Random delay for staggered effect
            flower.style.animationDelay = (Math.random() * 0.5) + 's';

            document.body.appendChild(flower);

            // Remove flower element after animation completes
            setTimeout(() => {
                if (flower.parentNode) {
                    flower.parentNode.removeChild(flower);
                }
            }, (randomDuration + 0.5) * 1000);
        }, i * 200); // Stagger the creation of flowers
    }
}

async function applyAppTheme(themeKey) {
    const theme = APP_THEMES[themeKey];
    if(!theme) return;

    // DBZ themes are restricted to male users only
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    if (theme.maleOnly && !isMale) {
        // Non-male user trying to use male-only theme - fall back to default
        themeKey = 'default';
        const defaultTheme = APP_THEMES['default'];
        for (const [key, value] of Object.entries(defaultTheme.colors)) {
            document.documentElement.style.setProperty(key, value);
        }
        localStorage.setItem('userThemePreference', 'default');
        const selector = document.getElementById('theme-selector');
        if(selector) selector.value = 'default';

        // Save to Supabase
        if (window.currentUser?.id && typeof dbHelpers !== 'undefined') {
            try {
                await dbHelpers.users.update(window.currentUser.id, { theme_preference: 'default' });
                console.log("Theme preference saved to DB: default");
            } catch (e) {
                console.warn("Failed to save theme preference to DB:", e);
            }
        }
        return;
    }

    for (const [key, value] of Object.entries(theme.colors)) { document.documentElement.style.setProperty(key, value); }
    localStorage.setItem('userThemePreference', themeKey);
    const selector = document.getElementById('theme-selector');
    if(selector) selector.value = themeKey;

    // CRITICAL: Save theme preference to Supabase for persistence across cache clears
    if (window.currentUser?.id && typeof dbHelpers !== 'undefined') {
        try {
            await dbHelpers.users.update(window.currentUser.id, { theme_preference: themeKey });
            console.log("Theme preference saved to DB:", themeKey);
        } catch (e) {
            console.warn("Failed to save theme preference to DB:", e);
        }
    }

    // Update dashboard-welcome background - keep gradient for all themes
    const welcomeSection = document.querySelector('.dashboard-welcome');
    if(welcomeSection) {
        // Always use dynamic theme gradient
        welcomeSection.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%)';
        welcomeSection.style.color = 'white';
        // Ensure all child elements use white text for maximum readability
        const children = welcomeSection.querySelectorAll('*');
        children.forEach(c => {
             c.style.color = 'white';
        });
    }

    // Handle DBZ theme decorations (male users only)
    const isDbzTheme = themeKey.startsWith('dbz-');

    // Easter egg: Show video on first theme selection (male users only)
    if (isMale && isDbzTheme) {
        const easterEggKey = `dbz_easter_egg_${themeKey}`;
        const hasSeenEasterEgg = localStorage.getItem(easterEggKey);

        if (!hasSeenEasterEgg) {
            // Show the appropriate Easter egg video
            let videoUrl, videoTitle;

            if (themeKey === 'dbz-warrior') {
                // Super Saiyan theme - bigger video
                videoUrl = 'https://f005.backblazeb2.com/file/shannonsvideos/download_20260120_225718_0000.mp4';
                videoTitle = 'Super Saiyan Unlocked!';
            } else if (themeKey === 'dbz-vegeta') {
                // Saiyan Prince theme - smaller video
                videoUrl = 'https://f005.backblazeb2.com/file/shannonsvideos/download_20260120_231525_0000.mp4';
                videoTitle = 'Saiyan Prince Unlocked!';
            }

            if (videoUrl) {
                // Mark as seen so it only shows once
                localStorage.setItem(easterEggKey, 'true');

                // Show the Easter egg video after a short delay to let theme apply
                setTimeout(() => {
                    if (typeof openExerciseVideo === 'function') {
                        openExerciseVideo(videoUrl, videoTitle, true); // autoplay = true
                    }
                }, 300);
            }
        }
    }

    // Flower Garden theme animation - falling flowers on first selection (female users only)
    const isFlowerTheme = (themeKey === 'flower-garden');
    const isFemale = !isMale; // Female users get flower themes

    if (isFemale && isFlowerTheme) {
        const flowerEasterEggKey = 'flower_garden_animation_seen';
        const hasSeenFlowerAnimation = localStorage.getItem(flowerEasterEggKey);

        if (!hasSeenFlowerAnimation) {
            // Mark as seen so it only shows once
            localStorage.setItem(flowerEasterEggKey, 'true');

            // Trigger falling flower animation after a short delay to let theme apply
            setTimeout(() => {
                if (typeof createFallingFlowerAnimation === 'function') {
                    createFallingFlowerAnimation();
                }
            }, 300);
        }
    }

    const dbzDecorations = document.getElementById('dbz-decorations');
    const gokuImg = document.getElementById('dbz-goku');
    const vegetaImg = document.getElementById('dbz-vegeta');

    if (dbzDecorations) {
        dbzDecorations.style.display = (isDbzTheme && isMale) ? 'block' : 'none';

        // Show the correct character based on theme
        if (gokuImg && vegetaImg) {
            if (themeKey === 'dbz-warrior') {
                // Super Saiyan theme - show Goku
                gokuImg.style.display = 'block';
                vegetaImg.style.display = 'none';
            } else if (themeKey === 'dbz-vegeta') {
                // Saiyan Prince theme - show Vegeta
                gokuImg.style.display = 'none';
                vegetaImg.style.display = 'block';
            }
        }
    }

    // Toggle DBZ body class for additional styling
    if (isDbzTheme && isMale) {
        document.body.classList.add('dbz-theme-active');
        // Add specific class for each character's theme
        document.body.classList.remove('dbz-goku-theme', 'dbz-vegeta-theme');
        document.body.classList.add(themeKey === 'dbz-warrior' ? 'dbz-goku-theme' : 'dbz-vegeta-theme');
    } else {
        document.body.classList.remove('dbz-theme-active', 'dbz-goku-theme', 'dbz-vegeta-theme');
    }

    // Handle Flower Garden decorations (female users only)
    const flowerDecorations = document.getElementById('flower-decorations');
    if (flowerDecorations) {
        flowerDecorations.style.display = (isFlowerTheme && isFemale) ? 'block' : 'none';
    }

    // Toggle Flower Garden body class for additional styling
    if (isFlowerTheme && isFemale) {
        document.body.classList.add('flower-theme-active');
    } else {
        document.body.classList.remove('flower-theme-active');
    }

    // Trigger icon toggle update
    updateSettingsIcon();
}

// Reusable function to toggle settings icon and profile icon based on current theme
function updateSettingsIcon() {
    const savedTheme = localStorage.getItem('userThemePreference') || 'default';
    const isDbzTheme = savedTheme.startsWith('dbz-');
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());

    setTimeout(() => {
        // Update settings icon (gear vs dragon ball)
        const gearIcon = document.getElementById('settings-icon-gear');
        const dragonBallIcon = document.getElementById('settings-icon-dragonball');

        if (gearIcon && dragonBallIcon) {
            if (isDbzTheme && isMale) {
                // DBZ theme: show dragon ball, hide gear
                gearIcon.style.setProperty('display', 'none', 'important');
                dragonBallIcon.style.setProperty('display', 'inline-block', 'important');
                console.log('✅ Dragon Ball settings icon activated');
            } else {
                // Default: show gear, hide dragon ball
                gearIcon.style.setProperty('display', 'inline-block', 'important');
                dragonBallIcon.style.setProperty('display', 'none', 'important');
                console.log('✅ Gear settings icon activated (theme: ' + savedTheme + ', male: ' + isMale + ')');
            }
        } else {
            console.warn('⚠️ Settings icons not found in DOM yet');
        }

        // Update profile icons (all instances with class profile-icon)
        const profileIcons = document.querySelectorAll('.profile-icon');
        profileIcons.forEach(icon => {
            if (isDbzTheme && isMale) {
                // DBZ theme: show dragon ball background
                icon.style.setProperty('background-image', 'url(assets/dragon-ball.svg)', 'important');
                icon.style.setProperty('background-size', 'cover', 'important');
                icon.style.setProperty('background-position', 'center', 'important');
                icon.style.setProperty('color', 'transparent', 'important');
                icon.style.setProperty('font-size', '0', 'important');
                console.log('✅ Dragon Ball profile icon activated');
            } else {
                // Default: remove dragon ball background, show "S"
                icon.style.removeProperty('background-image');
                icon.style.setProperty('background', 'var(--accent-green)', 'important');
                icon.style.setProperty('color', 'var(--primary)', 'important');
                icon.style.setProperty('font-size', '', 'important');
                console.log('✅ Standard profile icon activated');
            }
        });
    }, 50); // Small delay to ensure DOM is ready
}

// Diagnostic function for debugging Dragon Ball icons
function debugDragonBallIcon() {
    const profileIconElements = document.querySelectorAll('.profile-icon');
    const firstProfileIcon = profileIconElements[0];

    const results = {
        userGender: localStorage.getItem('userGender'),
        isMale: isMaleUser(),
        currentTheme: localStorage.getItem('userThemePreference'),
        bodyClasses: Array.from(document.body.classList),
        hasDbzThemeActive: document.body.classList.contains('dbz-theme-active'),
        settingsGearIcon: {
            exists: !!document.getElementById('settings-icon-gear'),
            display: document.getElementById('settings-icon-gear')?.style.display,
            computedDisplay: window.getComputedStyle(document.getElementById('settings-icon-gear') || document.createElement('div')).display
        },
        settingsDragonBallIcon: {
            exists: !!document.getElementById('settings-icon-dragonball'),
            display: document.getElementById('settings-icon-dragonball')?.style.display,
            computedDisplay: window.getComputedStyle(document.getElementById('settings-icon-dragonball') || document.createElement('div')).display,
            src: document.getElementById('settings-icon-dragonball')?.src
        },
        profileIcons: {
            count: profileIconElements.length,
            firstIcon: firstProfileIcon ? {
                backgroundImage: window.getComputedStyle(firstProfileIcon).backgroundImage,
                color: window.getComputedStyle(firstProfileIcon).color,
                textContent: firstProfileIcon.textContent
            } : null
        }
    };

    console.log('=== Dragon Ball Icon Debug Info ===');
    console.table(results);
    console.log('Full results:', results);

    // Show user-friendly message
    if (results.isMale && results.currentTheme?.startsWith('dbz-')) {
        console.log('✅ DBZ theme active for male user');
        console.log('  → Settings: Dragon Ball should show, Gear should hide');
        console.log('  → Profile icon (top right S): Should show Dragon Ball background');

        if (!results.hasDbzThemeActive) {
            console.log('  ❌ body.dbz-theme-active class is MISSING');
        }
        if (results.profileIcons.firstIcon?.backgroundImage.includes('dragon-ball')) {
            console.log('  ✅ Profile icon has Dragon Ball background');
        } else {
            console.log('  ❌ Profile icon does NOT have Dragon Ball background');
        }
    } else {
        console.log('ℹ️ Dragon Ball icons should NOT be visible because:');
        if (!results.isMale) console.log('  - User is not male (gender: ' + results.userGender + ')');
        if (!results.currentTheme?.startsWith('dbz-')) console.log('  - Current theme is not DBZ (theme: ' + results.currentTheme + ')');
    }

    return results;
}

// Make functions available in console for debugging
window.debugDragonBallIcon = debugDragonBallIcon;
window.updateSettingsIcon = updateSettingsIcon;

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Wait for Auth before loading user-specific data
    const waitForAuth = () => new Promise(resolve => {
        if(window.currentUser) return resolve(window.currentUser);
        const check = setInterval(() => {
            if(window.currentUser) { clearInterval(check); resolve(window.currentUser); }
        }, 100);
        setTimeout(() => { clearInterval(check); resolve(null); }, 3000);
    });

    waitForAuth().then(() => {
        // Only load user-specific data after auth is confirmed
        if(window.currentUser) {
            loadChatHistory();
            loadCommunityFeed();

            // Subscribe to Realtime updates for new coach messages
            subscribeToCoachMessages(window.currentUser.id);
        }
        checkUserRole();
        // Theme is now applied in the main initialization sequence after gender is loaded
    });

    // Event Listeners (Community only - Coach uses form onsubmit)
    document.getElementById('community-chat-input')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendCommunityMessage(); });
});
</script>

<!-- VIDEO MODAL (Ensured Existence) -->
<!-- VIDEO MODAL (Improved) -->
<div id="video-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10010; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <!-- Close Button (Top Right) -->
    <div onclick="closeVideoModal()" style="position: absolute; top: 25px; right: 25px; width: 45px; height: 45px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; z-index: 10011;">
        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: white;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </div>

    <div style="width:100%; max-width:900px; position:relative; padding: 20px;">
        <div style="background:black; width:100%; aspect-ratio:16/9; border-radius:24px; overflow:hidden; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); position:relative;">

            <!-- Native Video (Backblaze B2) -->
            <video id="video-direct" style="width:100%; height:100%; display:none; object-fit:cover;" controls playsinline crossorigin="anonymous"></video>

            <!-- Poster Overlay -->
            <div id="video-poster" onclick="playVideo()" style="position:absolute; inset:0; background-size:cover; background-position:center; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:10; background-color: #0f172a;">
                 <div style="width:70px; height:70px; background:rgba(0,0,0,0.6); border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid rgba(255,255,255,0.8); backdrop-filter:blur(4px); transition: transform 0.2s;">
                      <svg viewBox="0 0 24 24" style="width:34px; height:34px; fill:white; margin-left:4px;"><path d="M8 5v14l11-7z"/></svg>
                 </div>
            </div>

        </div>
        
        <div style="margin-top:25px; text-align:center;">
             <h3 id="video-modal-title" style="color:white; margin:0; font-size:1.1rem; font-weight:600; opacity:0.9; letter-spacing: 0.5px;">Exercise Video</h3>
        </div>
    </div>
</div>

<!-- DBZ Character Decorations (Male Only) -->
<div id="dbz-decorations" style="display:none;">
    <img src="assets/goku-ssj.webp" alt="Goku Super Saiyan" class="dbz-character-corner" id="dbz-goku" />
    <img src="assets/vegeta-ssj.webp" alt="Vegeta Super Saiyan" class="dbz-character-corner" id="dbz-vegeta" style="display:none;" />
    <img src="assets/dbz-lightning.svg" alt="Lightning" class="dbz-lightning-left" />
    <img src="assets/dbz-lightning.svg" alt="Lightning" class="dbz-lightning-right" />
</div>

<!-- Flower Garden Decorations (Female users only) -->
<div id="flower-decorations" style="display:none;">
    <img src="assets/flower-cherry-blossom.svg" alt="Cherry Blossom" class="flower-corner flower-top-right" />
    <img src="assets/flower-rose.svg" alt="Rose" class="flower-corner flower-bottom-left" />
    <img src="assets/flower-peony.svg" alt="Peony" class="flower-corner flower-top-left" />
    <img src="assets/flower-daisy.svg" alt="Daisy" class="flower-corner flower-bottom-right" />
</div>

<!-- PWA INSTALL BANNER (Fixed Floating) -->
<!-- PWA INSTALL BANNER (Moved to TOP) -->
<div id="pwa-install-banner" style="display:none; position:fixed; top:0; left:0; width:100%; background:#046A38 !important; color:white; font-size:0.9rem; padding:12px 20px; z-index:99999; box-shadow:0 4px 15px rgba(0,0,0,0.2); align-items:center; justify-content:space-between;">
    <div style="display:flex; align-items:center; gap:12px;">
        <span style="font-size:1.2rem;">📲</span>
        <span style="font-weight:600;">Install App for Best Experience</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="dismissInstall()" style="background:transparent; border:1px solid rgba(255,255,255,0.4); color:white; padding:6px 12px; border-radius:20px; font-size:70%; font-weight:600;">LATER</button>
        <button onclick="installPWA()" style="background:white; color:var(--primary); border:none; padding:6px 16px; border-radius:20px; font-size:0.8rem; font-weight:700; box-shadow:0 2px 10px rgba(0,0,0,0.1);">INSTALL</button>
    </div>
</div>

<script src="exercise_videos.js"></script>
<script src="workout_library.js"></script>
<script>
// Video Logic
let currentVideoUrl = '';

function findVideoMatch(name) {
    if(EXERCISE_VIDEOS[name]) return EXERCISE_VIDEOS[name];

    // Clean name logic: Remove common prefixes and trim
    const cleanName = name.replace(/(Dumbbell|Barbell|Body Weight|Band|Cable|Machine) /gi, '').trim();
    if(EXERCISE_VIDEOS[cleanName]) return EXERCISE_VIDEOS[cleanName];

    // Fuzzy Search (Simple Includes)
    const keys = Object.keys(EXERCISE_VIDEOS);
    
    // 1. Try to find a key that CONTAINS the clean name
    const partialMatch = keys.find(k => k.toLowerCase().includes(cleanName.toLowerCase()));
    if(partialMatch) return EXERCISE_VIDEOS[partialMatch];
    
    // 2. Try to find a key that is CONTAINED BY the clean name
    const reverseMatch = keys.find(k => cleanName.toLowerCase().includes(k.toLowerCase()));
    if(reverseMatch) return EXERCISE_VIDEOS[reverseMatch];

    return '';
}

// Inline video playback for workout cards
let currentInlineVideo = null;

function playInlineVideo(event, videoUrl) {
    event.stopPropagation();
    event.preventDefault();

    // Get the container that was clicked
    const container = event.currentTarget;
    const video = container.querySelector('video');
    const playOverlay = container.querySelector('.inline-play-overlay');

    if (!video || !videoUrl) return;

    // Stop any other playing inline video
    if (currentInlineVideo && currentInlineVideo !== video) {
        stopInlineVideo(currentInlineVideo);
    }

    // Check if video is already playing - if so, pause it
    if (!video.paused) {
        video.pause();
        if (playOverlay) playOverlay.style.display = 'flex';
        video.controls = false;
        currentInlineVideo = null;
        return;
    }

    // Hide play overlay and show controls
    if (playOverlay) playOverlay.style.display = 'none';
    video.controls = true;
    video.muted = false;

    // Set source directly on video element (currentSrc may be from source tag)
    if (!video.currentSrc || !video.currentSrc.includes('backblazeb2')) {
        video.src = videoUrl;
    }

    // Play the video
    video.play().catch(e => {
        console.error("Inline video play error:", e);
        if (playOverlay) playOverlay.style.display = 'flex';
        video.controls = false;
    });

    currentInlineVideo = video;

    // Listen for video end to reset
    video.onended = function() {
        if (playOverlay) playOverlay.style.display = 'flex';
        video.controls = false;
        video.currentTime = 0;
        currentInlineVideo = null;
    };

    // Listen for pause to show overlay
    video.onpause = function() {
        if (video.ended) return;
        // Small delay to allow user to use controls
        setTimeout(() => {
            if (video.paused && !video.ended) {
                if (playOverlay) playOverlay.style.display = 'flex';
            }
        }, 100);
    };
}

function stopInlineVideo(video) {
    if (!video) return;
    video.pause();
    video.currentTime = 0;
    video.controls = false;
    const container = video.closest('[data-video-container]');
    if (container) {
        const playOverlay = container.querySelector('.inline-play-overlay');
        if (playOverlay) playOverlay.style.display = 'flex';
    }
}

let pendingVideoUrl = '';

function playVideo() {
    const direct = document.getElementById('video-direct');
    const poster = document.getElementById('video-poster');

    if(poster) poster.style.display = 'none';

    // Play Backblaze B2 video in native player
    if (direct && pendingVideoUrl) {
        direct.style.display = 'block';
        direct.src = pendingVideoUrl;
        direct.play().catch(e => {
            console.error("Video play error:", e);
            alert("Unable to play video. The video file may not be accessible.");
        });
    }
}

function openExerciseVideo(url, title, autoplay = false) {
    console.log("Opening video for:", title);

    // 1. Resolve URL if missing
    if (!url) {
        url = findVideoMatch(title);
        if(!url) {
            console.log("No video found for:", title);
            alert("Video coming soon for: " + title);
            return;
        }
    }

    // 2. Check if this is a Google Drive video (not yet migrated)
    if (url.includes('drive.google.com')) {
        alert(`This video hasn't been migrated yet.\n\n"${title}" is still on Google Drive and needs to be uploaded to Backblaze B2.\n\nPlease check the migration list.`);
        console.log("Google Drive video not migrated:", title, url);
        return;
    }

    // 3. Only support Backblaze B2 and direct video files
    if (!url.includes('backblazeb2.com') && !url.match(/\.(mp4|mov|webm)$/i)) {
        alert(`Unsupported video format.\n\nOnly Backblaze B2 videos are supported. This video needs to be migrated: "${title}"`);
        console.log("Unsupported video format:", title, url);
        return;
    }

    // 4. Setup video for Backblaze B2
    let embedUrl = url;
    let viewUrl = url;
    let type = 'b2'; // Backblaze B2 native video

    // 5. Setup Modal State
    currentVideoUrl = viewUrl;
    pendingVideoUrl = embedUrl;
    window.pendingVideoType = type;

    // 6. Setup Modal
    const modal = document.getElementById('video-modal');
    const direct = document.getElementById('video-direct');
    const poster = document.getElementById('video-poster');
    const titleEl = document.getElementById('video-modal-title');

    if(titleEl) titleEl.innerText = title;

    // Reset video player
    if(direct) {
        direct.src = '';
        direct.style.display = 'none';
    }

    // Show poster with play button
    if(poster) {
        poster.style.display = 'flex';
        poster.style.backgroundImage = 'none'; // B2 videos don't have thumbnails
    }

    modal.style.display = 'flex';

    // Autoplay and auto-close for Easter egg videos
    if (autoplay && direct) {
        // Auto-play the video after a short delay
        setTimeout(() => {
            playVideo();

            // Add event listener to close modal when video ends
            const handleVideoEnd = () => {
                closeVideoModal();
                direct.removeEventListener('ended', handleVideoEnd);
            };
            direct.addEventListener('ended', handleVideoEnd);
        }, 500);
    }
}

function openVideoNewTab() {
    if(currentVideoUrl) window.open(currentVideoUrl, '_blank');
}

function closeVideoModal() {
    const modal = document.getElementById('video-modal');
    const direct = document.getElementById('video-direct');

    modal.style.display = 'none';

    // Stop video player
    if(direct) {
        direct.pause();
        direct.src = '';
    }
}

// Close on background click
document.getElementById('video-modal').addEventListener('click', function(e) {
    if (e.target === this) closeVideoModal();
});
</script>

<script>
// --- COACH CHAT ENHANCEMENTS ---

// 1. Office Hours Config (Brisbane Time)
const COACH_CONFIG = {
    timezone: 'Australia/Brisbane',
    startHour: 7,    // 7 AM
    endHour: 20,     // 8 PM
    endMin: 30       // :30
};

function getCoachState() {
    try {
        const now = new Date();
        const bneTimeStr = now.toLocaleString("en-US", {timeZone: COACH_CONFIG.timezone});
        const bneTime = new Date(bneTimeStr);
        
        const totalMins = bneTime.getHours() * 60 + bneTime.getMinutes();
        const startMins = COACH_CONFIG.startHour * 60;
        const endMins = COACH_CONFIG.endHour * 60 + COACH_CONFIG.endMin;
        
        const isOnline = totalMins >= startMins && totalMins < endMins;
        return { isOnline, totalMins };
    } catch(e) {
        return { isOnline: true }; // Fail-safe
    }
}

function updateCoachUI() {
    const { isOnline } = getCoachState();
    const headerStatus = document.getElementById('coach-header-status-text');

    // Check for unread messages and apply glow to Support tab
    const hasUnread = localStorage.getItem('coach_unread_messages') === 'true';
    const supportTab = document.querySelector('.nav-item[onclick*="support"]');
    if (supportTab) {
        if (hasUnread) {
            supportTab.classList.add('has-notification');
        } else {
            supportTab.classList.remove('has-notification');
        }
    }

    const color = isOnline ? '#22c55e' : '#94a3b8'; // Green vs Slate
    const text = isOnline ? 'Active Now' : 'Offline (Back 7am)';

    if(headerStatus) {
        headerStatus.innerText = text;
        headerStatus.style.color = isOnline ? 'var(--primary)' : '#64748b';
    }
}

// 2. Override Trigger for Offline Logic
const _originalTriggerCoach = window.triggerCoachResponse;

window.triggerCoachResponse = async function(userMsg) {
    const { isOnline } = getCoachState();
    
    if (!isOnline) {
        // Coach is Offline
        const container = document.getElementById('chat-messages-container');
        if(container) {
            const typing = document.createElement('div');
            typing.id = 'coach-typing-indicator';
            typing.style.cssText = "display: flex; align-items: center; margin-bottom: 20px; margin-left:10px;";
            typing.innerHTML = `<div style="font-size:0.8rem; color:#94a3b8; font-style:italic;">Coach is offline...</div>`;
            container.appendChild(typing);
            scrollToBottomOfChat();
            
            await new Promise(r => setTimeout(r, 1200));
            typing.remove();
        }
        
        appendCoachMessage("I've officially clocked off for the night! 🌙 \n\nI'll be back online at 7am Brisbane time to review your message properly. Get some rest and chat soon!");
        return;
    }
    
    // Online: Pass through
    if(_originalTriggerCoach) await _originalTriggerCoach(userMsg);
};

// 3. Daily Greeting
// Daily greeting removed - coach now responds only when user messages
async function checkCoachGreeting() {
    // Function kept for compatibility but no longer sends automated greetings
    return;
}

// 4. Bubble Interaction
function openCoachChat() {
    switchAppTab('support');
    const btns = document.querySelectorAll('#view-support .sub-nav .sub-btn');
    if(btns.length > 0 && typeof showSupportTab === 'function') {
        showSupportTab('chat', btns[0]);
    }
}

// 5. Push Notifications
async function requestNotificationPermission() {
    if (!('Notification' in window)) {
        console.log('This browser does not support notifications');
        return;
    }

    // Check if permission already granted
    if (Notification.permission === 'granted') {
        return;
    }

    // Only request if not already denied
    if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted');
        }
    }
}

/**
 * Toggle user notifications preference
 */
window.toggleUserNotifications = async function(enabled) {
    localStorage.setItem('user_notifications_enabled', enabled ? 'true' : 'false');

    if (enabled) {
        // Request permission if enabling
        if ('Notification' in window && Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                // Revert toggle if permission denied
                const toggle = document.getElementById('user-notifications-toggle');
                if (toggle) toggle.checked = false;
                localStorage.setItem('user_notifications_enabled', 'false');
                alert('Please enable notifications in your browser settings to receive coach message alerts.');
                return;
            }
        }
    }

    console.log('User notifications:', enabled ? 'enabled' : 'disabled');
};

/**
 * Initialize user notification toggle state
 */
function initUserNotificationToggle() {
    const toggle = document.getElementById('user-notifications-toggle');
    if (toggle) {
        const enabled = localStorage.getItem('user_notifications_enabled') !== 'false'; // Default to true
        toggle.checked = enabled;
    }
}

async function sendCoachNotification(messageText) {
    // Check if user has disabled notifications
    if (localStorage.getItem('user_notifications_enabled') === 'false') {
        return;
    }

    // Check if notifications are supported and permitted
    if (!('Notification' in window) || Notification.permission !== 'granted') {
        return;
    }

    // Only send notification if app is in background
    if (document.visibilityState === 'hidden') {
        try {
            const registration = await navigator.serviceWorker.ready;

            // Truncate long messages for notification
            const displayText = messageText.length > 100
                ? messageText.substring(0, 100) + '...'
                : messageText;

            await registration.showNotification('Coach Shannon', {
                body: displayText,
                icon: './assets/coach_shannon.jpg',
                badge: './assets/Logo_dots.jpg',
                vibrate: [200, 100, 200],
                tag: 'coach-message',
                requireInteraction: false,
                data: {
                    url: './dashboard.html'
                }
            });
        } catch (error) {
            console.error('Error sending notification:', error);
        }
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updateCoachUI();
    setInterval(updateCoachUI, 1000); // Check every second for visibility toggle
    // Removed: setTimeout(checkCoachGreeting, 2000); - no more automated greetings
    requestNotificationPermission();
    initUserNotificationToggle();
});

// Immediate
updateCoachUI();

// 5. Welcome Modal Logic (REMOVED - Using original onboarding-modal instead)
// setTimeout(() => { ... }, 1000);
</script>
<!-- WORKOUT BUILDER VIEW -->
<div id="view-workout-builder" class="app-view" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:500; overflow-y:auto; padding-bottom: 100px;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
        <div style="font-weight: 700; font-size: 1.2rem;">Build Workout</div>
        <div onclick="switchAppTab('movement-tab')" style="cursor:pointer; color:var(--text-muted); font-weight:600;">Close</div>
    </div>

    <div style="padding: 20px;">
        <div style="position:relative; margin-bottom: 20px;">
            <input type="text" id="builder-search" placeholder="Search 1800+ exercises..." onkeyup="filterExerciseLibrary(this.value)"
                   style="width:100%; padding:15px 15px 15px 45px; border-radius:16px; border:1px solid #e2e8f0; font-size:1rem; background: #f8fafc;">
            <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#94a3b8; position:absolute; left:15px; top:50%; transform:translateY(-50%);"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </div>

        <!-- Exercise Filters -->
        <div style="margin-bottom: 20px;">
            <!-- Workout Type Filter -->
            <div style="margin-bottom: 8px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                <div onclick="toggleFilterSection('workoutType')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: #334155;">Workout Type</div>
                    <svg id="chevron-workoutType" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #64748b; transition: transform 0.2s;">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
                <div id="filter-content-workoutType" style="display: none; padding: 12px; background: white;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="toggleFilter('workoutType', 'yoga')" class="filter-chip" data-category="workoutType" data-value="yoga" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Yoga</button>
                        <button onclick="toggleFilter('workoutType', 'pilates')" class="filter-chip" data-category="workoutType" data-value="pilates" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Pilates</button>
                        <button onclick="toggleFilter('workoutType', 'cardio')" class="filter-chip" data-category="workoutType" data-value="cardio" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Cardio</button>
                        <button onclick="toggleFilter('workoutType', 'stretch')" class="filter-chip" data-category="workoutType" data-value="stretch" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Stretch</button>
                    </div>
                </div>
            </div>

            <!-- Equipment Filter -->
            <div style="margin-bottom: 8px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                <div onclick="toggleFilterSection('equipment')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: #334155;">Equipment</div>
                    <svg id="chevron-equipment" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #64748b; transition: transform 0.2s;">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
                <div id="filter-content-equipment" style="display: none; padding: 12px; background: white;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="toggleFilter('equipment', 'bodyweight')" class="filter-chip" data-category="equipment" data-value="bodyweight" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Bodyweight</button>
                        <button onclick="toggleFilter('equipment', 'dumbbell')" class="filter-chip" data-category="equipment" data-value="dumbbell" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Dumbbell</button>
                        <button onclick="toggleFilter('equipment', 'barbell')" class="filter-chip" data-category="equipment" data-value="barbell" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Barbell</button>
                        <button onclick="toggleFilter('equipment', 'cable')" class="filter-chip" data-category="equipment" data-value="cable" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Cable</button>
                        <button onclick="toggleFilter('equipment', 'band')" class="filter-chip" data-category="equipment" data-value="band" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Band</button>
                        <button onclick="toggleFilter('equipment', 'kettlebell')" class="filter-chip" data-category="equipment" data-value="kettlebell" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Kettlebell</button>
                        <button onclick="toggleFilter('equipment', 'machine')" class="filter-chip" data-category="equipment" data-value="machine" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Machine</button>
                    </div>
                </div>
            </div>

            <!-- Muscle Group Filter -->
            <div style="margin-bottom: 8px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                <div onclick="toggleFilterSection('muscle')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: #334155;">Muscle Group</div>
                    <svg id="chevron-muscle" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #64748b; transition: transform 0.2s;">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
                <div id="filter-content-muscle" style="display: none; padding: 12px; background: white;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="toggleFilter('muscle', 'chest')" class="filter-chip" data-category="muscle" data-value="chest" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Chest</button>
                        <button onclick="toggleFilter('muscle', 'back')" class="filter-chip" data-category="muscle" data-value="back" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Back</button>
                        <button onclick="toggleFilter('muscle', 'shoulders')" class="filter-chip" data-category="muscle" data-value="shoulders" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Shoulders</button>
                        <button onclick="toggleFilter('muscle', 'arms')" class="filter-chip" data-category="muscle" data-value="arms" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Arms</button>
                        <button onclick="toggleFilter('muscle', 'core')" class="filter-chip" data-category="muscle" data-value="core" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Core</button>
                        <button onclick="toggleFilter('muscle', 'legs')" class="filter-chip" data-category="muscle" data-value="legs" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Legs</button>
                        <button onclick="toggleFilter('muscle', 'glutes')" class="filter-chip" data-category="muscle" data-value="glutes" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Glutes</button>
                    </div>
                </div>
            </div>

            <!-- Clear Filters Button -->
            <div id="clear-filters-btn" style="display: none; margin-top: 12px;">
                <button onclick="clearAllFilters()" style="width: 100%; padding: 10px; border-radius: 12px; border: 1.5px solid #ef4444; background: #fef2f2; color: #ef4444; font-size: 0.85rem; font-weight: 700; cursor: pointer;">Clear All Filters</button>
            </div>
        </div>

        <div id="builder-library-list" style="display:flex; flex-direction:column; gap:10px;">
            <!-- Dynamic Content -->
        </div>
    </div>
    
    <div id="builder-floating-action" style="position:fixed; bottom:0; left:0; right:0; width:100%; padding:20px; display:none; z-index: 1000; background: white; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); pointer-events: auto;">
        <div style="display:flex; gap:10px;">
            <button onclick="saveCustomBuilderWorkout()" style="flex:1; background:white; color:var(--primary); border:2px solid var(--primary); padding:18px; border-radius:50px; font-weight:800; box-shadow:0 10px 25px rgba(0,0,0,0.05); font-size: 1.1rem; cursor:pointer; min-height:56px; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1); -webkit-touch-callout: none; user-select: none; position: relative;">
                SAVE
            </button>
            <button onclick="startCustomBuilderWorkout()" style="flex:2; background:var(--primary); color:white; padding:18px; border-radius:50px; font-weight:800; border:none; box-shadow:0 10px 25px rgba(4,106,56,0.3); font-size: 1.1rem; cursor:pointer; min-height:56px; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1); -webkit-touch-callout: none; user-select: none; position: relative;">
                START (<span id="builder-count">0</span>)
            </button>
        </div>
    </div>
    
    <script>
    async function saveCustomBuilderWorkout() {
        if (customWorkoutSelection.length === 0) return;
        const name = prompt("Name your workout:");
        if(!name) return;
        
        try {
            const user = window.currentUser;
            if(user) {
                 await dbHelpers.workouts.saveCustomWorkout(user.id, name, { 
                     exercises: customWorkoutSelection,
                     date: new Date().toISOString()
                 });
                 alert("Workout saved! You can find it in the Movement tab.");
                 switchAppTab('movement-tab');
                 renderMovementView(); // refresh list
            }
        } catch(e) {
            console.error("Failed to save workout:", e);
            alert("Failed to save workout. Please try again.");
        }
    }
    </script>
</div>
<script>
    function startSavedWorkout(id) {
        // Use cache populated by renderMovementView
        const saved = window.savedWorkoutsCache || [];
        const workout = saved.find(w => w.id === id);
        if(!workout) return;
        
        // Map DB format to Player format
        // workout.template_data.exercises is array of strings (names)
        const exerciseNames = workout.template_data?.exercises || [];
        
        const customWorkout = {
            title: workout.template_name || 'Custom Workout',
            name: workout.template_name || 'Custom Workout',
            description: 'Saved Session • ' + new Date(workout.created_at || new Date()).toLocaleDateString(),
            exercises: exerciseNames.map(key => ({
                name: key,
                sets: 3,
                reps: '12',
                videoUrl: '', 
                desc: ''
            }))
        };
        
        // Hijack the player
        document.getElementById('workout-player-title').innerText = customWorkout.title;
        document.getElementById('workout-player-goal').innerText = customWorkout.description;
        
        const list = document.getElementById('workout-exercises-list');
        list.innerHTML = '';
        
        customWorkout.exercises.forEach((ex, idx) => {
            const card = document.createElement('div');
            card.style.cssText = "background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9;";
            const videoUrl = typeof getExerciseVideoUrl === 'function' ? getExerciseVideoUrl(ex.name) : '';
            
            // Re-render card content with inline video
            card.innerHTML = `
            <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0 0 5px 0; font-size:1.05rem; font-weight:700; color:var(--text-main);">${ex.name}</h3>
                <div style="font-size:0.8rem; color:var(--text-muted);">Target: 3 Sets x 12 Reps</div>
            </div>

            ${videoUrl ? `
            <div data-video-container style="position:relative; width:100%; padding-top:56.25%; background:black; cursor:pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:60px; height:60px; background:rgba(255,255,255,0.9); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width:30px; height:30px; fill:var(--primary); margin-left:3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            <!-- Sets Container -->
            <div style="background:#f8fafc; padding:0 20px 20px 20px;" id="sets-container-${idx}">
                <div style="display:flex; padding:10px 0; font-size:0.75rem; color:var(--text-muted); font-weight:600; text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid #e2e8f0; margin-bottom:10px;">
                    <div style="width:40px; text-align:center;">Set</div>
                    <div style="flex:1; text-align:center;">kg</div>
                    <div style="flex:1; text-align:center;">Reps</div>
                    <div style="width:40px;"></div>
                </div>
                ${ [1,2,3].map(s => getSetRowHtml(ex.name, s, false)).join('') }

                 <button onclick="addSetRow('${ex.name.replace(/'/g, "\\'")}', ${idx})" style="width:100%; padding:12px; background:white; border:2px dashed #e2e8f0; border-radius:12px; color:var(--primary); font-weight:600; font-size:0.85rem; margin-top:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>+ Add Set</span>
                </button>
            </div>`;
            list.appendChild(card);
        });
        
        hideAllAppViews();
        document.getElementById('view-active-workout').style.display = 'block';
        window.activeWorkoutSessions = customWorkout; 
    }
</script>

<!-- SUPERBOOST CHECK-IN MODAL -->
<div id="check-in-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center; padding:15px;">
    <div class="modal-content" style="background: white; width: 100%; border-radius: 24px; padding: 0; max-width: 480px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeInScale 0.2s ease-out;">
        
        <!-- Header (Fixed) -->
        <div style="padding: 20px 25px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="margin:0; font-family:'Playfair Display'; font-size: 1.5rem; color: var(--primary);">Daily Check-in</h3>
                <p style="margin:5px 0 0 0; color: var(--text-muted); font-size: 0.85rem;">Tailor your plan instantly.</p>
            </div>
            <div onclick="closeCheckInModal()" style="width:36px; height:36px; background:#f8fafc; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); font-weight:bold; transition:all 0.2s;">✕</div>
        </div>
        
        <!-- Scrollable Content -->
        <div id="check-in-questions" style="overflow-y: auto; padding: 25px; flex:1;">
            
            <!-- 1. Bleeding (Female Only) -->
            <div id="check-in-period-section" style="margin-bottom: 25px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Flow Status</label>
                <div class="check-in-options" style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'none', this)" data-group="flow">None</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'spotting', this)" data-group="flow">Spotting</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'light', this)" data-group="flow">Light 🩸</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'medium', this)" data-group="flow">Medium 🩸🩸</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'heavy', this)" data-group="flow">Heavy 🩸🩸🩸</div>
                </div>
            </div>

            <!-- 2. Physical Symptoms -->
            <div style="margin-bottom: 25px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Physical</label>
                <div class="check-in-options" style="display:flex; flex-wrap:wrap; gap:8px;">
                     <div class="check-in-chip female-only-chip" onclick="toggleCheckInOption('symptoms', 'cramps', this)">Cramps ⚡</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'bloating', this)">Bloating 🎈</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'headache', this)">Headache 🤕</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'back_pain', this)">Back Pain 🦴</div>
                     <div class="check-in-chip female-only-chip" onclick="toggleCheckInOption('symptoms', 'tender_breasts', this)">Tender Breasts 👙</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'acne', this)">Acne / Skin 🫧</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'digestion', this)">Digestion Issues 🤢</div>
                     <div class="check-in-chip male-only-chip" onclick="toggleCheckInOption('symptoms', 'muscle_soreness', this)" style="display:none;">Muscle Soreness 💪</div>
                </div>
            </div>

            <!-- 3. Mind & Energy -->
            <div style="margin-bottom: 25px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Energy & Mood</label>
                <div class="check-in-options" style="display:flex; flex-wrap:wrap; gap:8px;">
                     <div class="check-in-chip" onclick="selectCheckInOption('energy', 'high', this)" data-group="energy">High Energy ⚡</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('energy', 'medium', this)" data-group="energy">Balanced ⚖️</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('energy', 'low', this)" data-group="energy">Low / Tired 💤</div>
                     <div style="flex-basis:100%; height:8px;"></div>
                     <div class="check-in-chip" onclick="selectCheckInOption('mood', 'happy', this)" data-group="mood">Happy / Calm 😌</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('mood', 'anxious', this)" data-group="mood">Anxious 😰</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('mood', 'sad', this)" data-group="mood">Sad / Weepy 😢</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('mood', 'irritated', this)" data-group="mood">Irritated 😠</div>
                </div>
            </div>

             <!-- 4. Fluid (Female Only) -->
             <div id="check-in-cervical-section" style="margin-bottom: 15px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Cervical Fluid</label>
                <div class="check-in-options" style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="check-in-chip" onclick="selectCheckInOption('fluid', 'dry', this)" data-group="fluid">Dry</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('fluid', 'sticky', this)" data-group="fluid">Sticky</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('fluid', 'creamy', this)" data-group="fluid">Creamy</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('fluid', 'egg_white', this)" data-group="fluid">Egg White 🥚</div>
                </div>
            </div>

            <!-- Recovery Section (Male Only - hidden by default) -->
            <div id="check-in-recovery-section" style="margin-bottom: 15px; display:none;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Recovery Status</label>
                <div class="check-in-options" style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="check-in-chip" onclick="selectCheckInOption('recovery', 'fresh', this)" data-group="recovery">Fully Recovered 💯</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('recovery', 'moderate', this)" data-group="recovery">Slightly Fatigued 😐</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('recovery', 'tired', this)" data-group="recovery">Need Rest 😴</div>
                </div>
            </div>

            <!-- Equipment Access Today -->
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Equipment Access Today</label>
                <div class="check-in-options" style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="check-in-chip" onclick="selectCheckInOption('equipment', 'none', this)" data-group="equipment">None 🧘</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('equipment', 'dumbbells', this)" data-group="equipment">Dumbbells 🏋️</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('equipment', 'gym', this)" data-group="equipment">Full Gym 💪</div>
                </div>
            </div>

        </div>

        <!-- Footer (Fixed) -->
        <div style="padding: 20px 25px; border-top:1px solid #f1f5f9; background:white; border-radius: 0 0 24px 24px;">
            <button onclick="submitDailyCycleSync()" style="width:100%; background:var(--primary); color:white; padding:16px; border-radius:50px; border:none; font-weight:700; font-size:1.1rem; box-shadow: 0 4px 15px rgba(45, 74, 62, 0.3); cursor:pointer; transition: transform 0.1s;">
                SAVE & START DAY ✨
            </button>
        </div>
    </div>
</div>

<style>
    .check-in-chip {
        padding: 10px 18px;
        background: #f8fafc;
        border-radius: 12px;
        font-size: 0.95rem;
        color: var(--text-main);
        cursor: pointer;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        flex-grow: 0;
        text-align: center;
        justify-content: center;
    }
    .check-in-chip:hover {
        background: #f1f5f9;
        border-color: #cbd5e0;
    }
    .check-in-chip.selected {
        background: var(--primary); /* Green for wellness vibe */
        color: white;
        border-color: var(--primary);
        box-shadow: 0 4px 10px rgba(43, 61, 38, 0.2);
    }
    /* Separate colors for categories if desired, but green is safe/premium */
    
    @keyframes fadeInScale {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
</style>

<!-- Share Referral Modal -->
<div id="share-referral-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10006; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
    <div style="background:white; border-radius:20px; max-width:500px; width:90%; max-height:85vh; overflow-y:auto; animation:fadeInScale 0.3s ease-out; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <!-- Header -->
        <div style="padding:24px 24px 20px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; justify-content:space-between;">
            <div>
                <h2 style="margin:0 0 4px 0; font-size:1.5rem; color:var(--text-main);">Share Your Invite Link</h2>
                <p style="margin:0; font-size:0.875rem; color:#64748b;">You BOTH get 2 weeks free when they join!</p>
            </div>
            <button onclick="closeShareReferralModal()" style="background:none; border:none; font-size:1.8rem; color:#94a3b8; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:all 0.2s;">×</button>
        </div>

        <!-- Content -->
        <div style="padding:24px;">
            <!-- Referral Code Display -->
            <div style="margin-bottom:24px;">
                <label style="display:block; font-size:0.875rem; font-weight:600; color:var(--text-main); margin-bottom:8px;">Your Referral Code</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <div id="referral-code-display" style="flex:1; padding:14px; background:#f8fafc; border:2px solid #e2e8f0; border-radius:12px; font-family:monospace; font-size:1.1rem; font-weight:700; color:var(--primary); text-align:center; letter-spacing:2px;">
                        Loading...
                    </div>
                    <button onclick="copyReferralCode()" style="padding:14px 20px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; white-space:nowrap; transition:all 0.2s;">
                        Copy
                    </button>
                </div>
            </div>

            <!-- Share Options -->
            <div style="margin-bottom:16px;">
                <label style="display:block; font-size:0.875rem; font-weight:600; color:var(--text-main); margin-bottom:12px;">Share via</label>
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                    <!-- WhatsApp -->
                    <button onclick="shareViaWhatsApp()" style="padding:14px; background:#25D366; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                        WhatsApp
                    </button>

                    <!-- Facebook Messenger -->
                    <button onclick="shareViaFacebook()" style="padding:14px; background:#1877F2; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </button>

                    <!-- SMS -->
                    <button onclick="shareViaSMS()" style="padding:14px; background:#22c55e; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s; grid-column:span 2;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 11H7V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/>
                        </svg>
                        SMS
                    </button>
                </div>
            </div>

            <!-- Info -->
            <div style="padding:16px; background:#f0fdf4; border:2px solid #bbf7d0; border-radius:12px; margin-top:20px;">
                <div style="display:flex; gap:12px; align-items:start;">
                    <div style="font-size:1.5rem; flex-shrink:0;">💡</div>
                    <div style="font-size:0.875rem; color:#15803d; line-height:1.5;">
                        <strong>How it works:</strong> When your friend signs up using your code, you BOTH automatically get 2 weeks (14 days) free! The more friends you invite, the more free time you unlock. Share away!
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Story Camera Modal (Instagram-style) -->
<div id="story-camera-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10008; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Camera Preview -->
    <video id="camera-preview" autoplay playsinline style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0;"></video>

    <!-- Captured Preview (shown after capture) -->
    <div id="captured-preview" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:11;">
        <img id="captured-photo" style="width:100%; height:100%; object-fit:cover; display:none;">
        <video id="captured-video" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover; display:none;"></video>
    </div>

    <!-- Close Button -->
    <button onclick="closeCameraModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:12;">
        &times;
    </button>

    <!-- Post Button (shown after capture) -->
    <button id="post-story-btn" onclick="postCapturedStory()" style="display:none; position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:12px 30px; border:none; border-radius:25px; font-weight:600; font-size:1rem; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.5); z-index:12;">
        Post
    </button>

    <!-- Retake Button (shown after capture) -->
    <button id="retake-btn" onclick="retakePhoto()" style="display:none; position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:12px 24px; border:none; border-radius:25px; font-weight:600; font-size:1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:12;">
        Retake
    </button>

    <!-- Camera Controls -->
    <div id="camera-controls" style="position:absolute; bottom:40px; left:0; right:0; display:flex; justify-content:center; align-items:center; z-index:10;">
        <!-- Single Capture Button (Tap = Photo, Hold = Video) -->
        <button id="camera-capture-btn"
                onmousedown="handleCameraButtonDown()"
                onmouseup="handleCameraButtonUp()"
                onmouseleave="handleCameraButtonUp()"
                ontouchstart="handleCameraButtonDown()"
                ontouchend="handleCameraButtonUp()"
                style="width:70px; height:70px; background:white; border:5px solid rgba(255,255,255,0.8); border-radius:50%; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3); transition:all 0.2s;">
        </button>
    </div>

    <!-- Recording Indicator -->
    <div id="recording-indicator" style="position:absolute; top:20px; left:20px; background:rgba(239,68,68,0.9); color:white; padding:8px 16px; border-radius:20px; font-weight:600; display:none; z-index:10;">
        ⏺ Recording...
    </div>
</div>

<!-- Story Choice Modal (Photo or Video?) -->
<div id="story-choice-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10010; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <div style="width:90%; max-width:400px; background:white; border-radius:20px; overflow:hidden; text-align:center;">
        <!-- Header -->
        <div style="padding:30px 20px 20px 20px;">
            <h3 style="margin:0 0 10px 0; color:var(--primary); font-size:1.5rem;">Create Your Story</h3>
            <p style="margin:0; color:var(--text-muted); font-size:0.9rem;">Choose what you'd like to share</p>
        </div>

        <!-- Choice Buttons -->
        <div style="padding:0 20px 30px 20px; display:flex; flex-direction:column; gap:12px;">
            <button onclick="openNativeCamera('photo')" style="width:100%; padding:20px; background:linear-gradient(135deg, var(--primary), var(--secondary)); color:white; border:none; border-radius:15px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.15); transition:transform 0.2s; display:flex; align-items:center; justify-content:center; gap:10px;">
                <svg viewBox="0 0 24 24" style="width:24px; height:24px; fill:white;">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                Take Photo
            </button>

            <button onclick="openNativeCamera('video')" style="width:100%; padding:20px; background:linear-gradient(135deg, #8b5cf6, #ec4899); color:white; border:none; border-radius:15px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.15); transition:transform 0.2s; display:flex; align-items:center; justify-content:center; gap:10px;">
                <svg viewBox="0 0 24 24" style="width:24px; height:24px; fill:white;">
                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                </svg>
                Record Video
            </button>

            <button onclick="closeChoiceModal()" style="width:100%; padding:16px; background:rgba(0,0,0,0.05); color:var(--text-muted); border:none; border-radius:15px; font-weight:600; font-size:1rem; cursor:pointer; transition:background 0.2s;">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Story Preview Modal (After Native Camera Capture) -->
<div id="story-preview-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10011; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Preview Content -->
    <img id="story-preview-photo" style="width:100%; height:100%; object-fit:contain; display:none; position:absolute; top:0; left:0;">
    <video id="story-preview-video-player" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:contain; display:none; position:absolute; top:0; left:0;"></video>

    <!-- Text Overlay Preview (user-added text) -->
    <div id="story-text-overlay-preview" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; font-size:1.5rem; font-weight:700; text-align:center; text-shadow:2px 2px 4px rgba(0,0,0,0.8); padding:10px 20px; max-width:80%; word-wrap:break-word; z-index:11; pointer-events:none;">
    </div>

    <!-- Close Button -->
    <button onclick="closePreviewModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:12; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Add Text Button -->
    <button id="add-text-btn" onclick="showTextEditor()" style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.5); border:none; color:white; padding:10px 20px; border-radius:20px; font-weight:600; cursor:pointer; z-index:12; backdrop-filter:blur(10px); display:flex; align-items:center; gap:8px;">
        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
            <path d="M5 4v3h5.5v12h3V7H19V4z"/>
        </svg>
        Add Text
    </button>

    <!-- Text Editor Overlay -->
    <div id="text-editor-overlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:13; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
        <textarea id="story-text-input" placeholder="Type your text..." maxlength="100" style="width:90%; max-width:400px; background:transparent; border:none; color:white; font-size:1.5rem; font-weight:700; text-align:center; resize:none; outline:none; font-family:inherit; min-height:100px; text-shadow:2px 2px 4px rgba(0,0,0,0.8);"></textarea>
        <div style="display:flex; gap:15px; margin-top:30px;">
            <button onclick="cancelTextEditor()" style="padding:12px 30px; background:rgba(255,255,255,0.2); color:white; border:none; border-radius:25px; font-weight:600; cursor:pointer; backdrop-filter:blur(10px);">
                Cancel
            </button>
            <button onclick="saveTextOverlay()" style="padding:12px 30px; background:var(--primary); color:white; border:none; border-radius:25px; font-weight:600; cursor:pointer;">
                Done
            </button>
        </div>
    </div>

    <!-- Post Button -->
    <button id="preview-post-btn" onclick="postCapturedStory()" style="position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:14px 35px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.6); z-index:12; transition:transform 0.2s;">
        Post
    </button>

    <!-- Retake Button -->
    <button onclick="retakeFromPreview()" style="position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:14px 28px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:12; transition:transform 0.2s;">
        Retake
    </button>
</div>

<!-- Meal Photo Preview Modal (After Native Camera Capture) -->
<div id="meal-preview-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10012; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Photo Preview -->
    <img id="meal-preview-photo" style="width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0;">

    <!-- Close Button -->
    <button onclick="closeMealPreviewModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:13; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Meal Description Input -->
    <div style="position:absolute; bottom:110px; left:20px; right:20px; z-index:13;">
        <textarea id="meal-description-input" placeholder="Add a description (optional)..." style="width:100%; max-width:500px; margin:0 auto; display:block; background:rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.3); border-radius:15px; color:white; padding:12px 15px; font-size:1rem; resize:none; height:60px; backdrop-filter:blur(10px); font-family:inherit;" maxlength="200"></textarea>
    </div>

    <!-- Analyze Button -->
    <button onclick="useMealPhoto()" style="position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:14px 35px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.6); z-index:13; transition:transform 0.2s;">
        Analyze Meal
    </button>

    <!-- Retake Button -->
    <button onclick="retakeMealPhotoFromPreview()" style="position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:14px 28px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:13; transition:transform 0.2s;">
        Retake
    </button>
</div>

<!-- Workout Photo Preview Modal -->
<div id="workout-preview-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10012; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Photo Preview -->
    <img id="workout-preview-photo" style="width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0;">

    <!-- Close Button -->
    <button onclick="closeWorkoutPreviewModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:13; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Loading Indicator -->
    <div id="workout-photo-loading" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); padding:30px 40px; border-radius:20px; z-index:14; text-align:center;">
        <div style="width:50px; height:50px; border:4px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 15px;"></div>
        <div id="workout-photo-loading-text" style="color:white; font-size:1rem;">Verifying workout...</div>
    </div>

    <!-- Error Message -->
    <div id="workout-photo-error" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(220,38,38,0.9); padding:25px 35px; border-radius:16px; z-index:14; text-align:center; max-width:80%;">
        <div style="color:white; font-size:1rem; font-weight:600;" id="workout-photo-error-text">Error</div>
        <button onclick="document.getElementById('workout-photo-error').style.display='none'" style="margin-top:15px; background:white; color:#dc2626; border:none; padding:10px 25px; border-radius:20px; font-weight:600; cursor:pointer;">OK</button>
    </div>

    <!-- Verify Button -->
    <button onclick="verifyWorkoutPhoto()" id="workout-verify-btn" style="position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:14px 35px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.6); z-index:13; transition:transform 0.2s;">
        Verify Workout
    </button>

    <!-- Cancel Button -->
    <button onclick="closeWorkoutPreviewModal()" style="position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:14px 28px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:13; transition:transform 0.2s;">
        Cancel
    </button>
</div>

<!-- Story Upload Modal -->
<div id="story-upload-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10007; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <div style="width:90%; max-width:500px; background:white; border-radius:20px; overflow:hidden;">
        <!-- Header -->
        <div style="padding:20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:var(--primary);">Create Your Story</h3>
            <button onclick="closeStoryUploadModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>

        <!-- Preview Area -->
        <div id="story-preview-area" style="padding:30px; text-align:center; min-height:300px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#f8fafc;">
            <div id="story-preview-placeholder" style="color:var(--text-muted);">
                <svg viewBox="0 0 24 24" style="width:80px; height:80px; fill:var(--text-muted); margin-bottom:15px;">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <p style="font-size:0.9rem;">Select a photo or video to share</p>
            </div>
            <img id="story-preview-image" src="" style="display:none; max-width:100%; max-height:400px; border-radius:12px; object-fit:contain;">
            <video id="story-preview-video" controls style="display:none; max-width:100%; max-height:400px; border-radius:12px;"></video>
        </div>

        <!-- Caption Input -->
        <div style="padding:20px; border-top:1px solid #e5e7eb;">
            <textarea id="story-caption-input" placeholder="Add a caption (optional)..." style="width:100%; min-height:60px; padding:12px; border:1px solid #e5e7eb; border-radius:10px; font-size:0.9rem; resize:vertical; font-family:inherit;"></textarea>
        </div>

        <!-- Actions -->
        <div style="padding:0 20px 20px 20px; display:flex; gap:10px;">
            <label for="story-file-input" style="flex:1; padding:14px; background:var(--secondary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; text-align:center; transition:all 0.2s;">
                Choose Photo/Video
            </label>
            <input type="file" id="story-file-input" accept="image/*,video/*" capture="environment" style="display:none;" onchange="handleStoryFileSelect(event)">

            <button id="story-upload-button" onclick="uploadStory()" disabled style="flex:1; padding:14px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; transition:all 0.2s; opacity:0.5;">
                Share Story
            </button>
        </div>
    </div>
</div>

<!-- Story Viewer Modal -->
<div id="story-viewer-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.98); z-index:10008; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Close Button -->
    <button onclick="closeStoryViewer()" style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.5rem; z-index:10009; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Story Header -->
    <div id="story-viewer-header" style="position:absolute; top:0; left:0; right:0; padding:20px; display:flex; align-items:center; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 100%); z-index:10009;">
        <div id="story-user-avatar" style="width:40px; height:40px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:600; overflow:hidden;">

        </div>
        <div style="flex:1;">
            <div id="story-user-name" style="color:white; font-weight:600; font-size:0.95rem;"></div>
            <div id="story-timestamp" style="color:rgba(255,255,255,0.8); font-size:0.75rem;"></div>
        </div>

        <!-- Delete button (only show for own stories) -->
        <button id="story-delete-button" onclick="deleteCurrentStory()" style="display:none; background:rgba(239,68,68,0.9); border:none; color:white; padding:8px 16px; border-radius:20px; cursor:pointer; font-size:0.85rem; font-weight:600;">
            Delete
        </button>
    </div>

    <!-- Progress Bars -->
    <div id="story-progress-bars" style="position:absolute; top:0; left:0; right:0; padding:15px 20px; display:flex; gap:4px; z-index:10009;">
        <!-- Progress bars will be injected here -->
    </div>

    <!-- Story Content -->
    <div id="story-content-container" style="width:100%; max-width:500px; height:100%; display:flex; align-items:center; justify-content:center; position:relative;">
        <img id="story-image" src="" style="max-width:100%; max-height:100%; object-fit:contain; border-radius:0;">
        <video id="story-video" playsinline style="display:none; max-width:100%; max-height:100%; object-fit:contain; border-radius:0;"></video>
        <div id="story-caption-overlay" style="position:absolute; bottom:60px; left:0; right:0; padding:20px; background:linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%); color:white; font-size:0.9rem; text-align:center; display:none;">
        </div>
    </div>

    <!-- Navigation Areas (tap left/right to navigate) -->
    <div onclick="previousStory()" style="position:absolute; left:0; top:0; bottom:0; width:30%; z-index:10009; cursor:pointer;"></div>
    <div onclick="nextStory()" style="position:absolute; right:0; top:0; bottom:0; width:70%; z-index:10009; cursor:pointer;"></div>

    <!-- Story Viewers List (bottom section - only show for own stories) -->
    <div id="story-viewers-section" style="display:none; position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.9); padding:20px; max-height:40%; overflow-y:auto; z-index:10009;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h4 style="margin:0; color:white; font-size:0.95rem;">Viewers</h4>
            <span id="story-view-count" style="color:rgba(255,255,255,0.7); font-size:0.85rem;"></span>
        </div>
        <div id="story-viewers-list">
            <!-- Viewers will be injected here -->
        </div>
    </div>
</div>

<script>
// --- PROGRESS / ANALYTICS VIEW ---
async function initProgressView() {
    const user = window.currentUser;
    if (!user) {
        console.error('No user logged in');
        return;
    }

    console.log('Initializing Progress View for user:', user.id);

    try {
        // Show loading
        document.getElementById('progress-loading').style.display = 'block';
        document.getElementById('progress-main-content').style.display = 'none';

        // Fetch data individually with fallbacks
        let workoutCount = 0;
        let workoutHistory = [];
        let milestones = [];
        let checkins = [];
        let pointsData = null;
        let recentExercises = [];

        // Load workout count
        try {
            workoutCount = await dbHelpers.workouts.getWorkoutCount(user.id);
            console.log('Workout count:', workoutCount);
        } catch (e) {
            console.warn('Failed to load workout count:', e);
        }

        // Load workout history
        try {
            workoutHistory = await dbHelpers.workouts.getHistory(user.id, 30);
            console.log('Workout history:', workoutHistory?.length || 0, 'records');
        } catch (e) {
            console.warn('Failed to load workout history:', e);
        }

        // Load milestones
        try {
            milestones = await dbHelpers.milestones.getAll(user.id, 20);
            console.log('Milestones:', milestones?.length || 0);
        } catch (e) {
            console.warn('Failed to load milestones:', e);
        }

        // Load check-ins
        try {
            checkins = await dbHelpers.checkins.getRecent(user.id, 14);
            console.log('Check-ins:', checkins?.length || 0);
        } catch (e) {
            console.warn('Failed to load check-ins:', e);
        }

        // Load points data
        try {
            pointsData = await dbHelpers.points.getPoints(user.id);
            console.log('Points data:', pointsData);
        } catch (e) {
            console.warn('Failed to load points data:', e);
        }

        // Load recent exercises
        try {
            recentExercises = await dbHelpers.workouts.getRecentExercises(user.id, 10);
            console.log('Recent exercises:', recentExercises?.length || 0);
        } catch (e) {
            console.warn('Failed to load recent exercises:', e);
        }

        // Update overview stats
        document.getElementById('total-workouts-stat').innerText = workoutCount || 0;
        document.getElementById('current-streak-stat').innerText = pointsData?.current_streak || 0;
        document.getElementById('total-points-stat').innerText = pointsData?.current_points || 0;
        document.getElementById('avg-calories-stat').innerText = '-';

        // Render sections
        renderWorkoutHistory(workoutHistory);
        renderMilestones(milestones);
        renderCheckins(checkins);
        await renderExerciseProgress(user.id, recentExercises);

        // Hide loading, show content
        document.getElementById('progress-loading').style.display = 'none';
        document.getElementById('progress-main-content').style.display = 'block';

        console.log('✅ Progress view loaded successfully');

    } catch (error) {
        console.error('Critical error loading progress view:', error);
        document.getElementById('progress-loading').innerHTML = `
            <div style="font-size: 2rem; margin-bottom: 10px;">😔</div>
            <div style="color: var(--text-muted); margin-bottom: 10px;">Failed to load progress data</div>
            <div style="font-size: 0.85rem; color: var(--text-muted); font-family: monospace;">${error.message}</div>
        `;
    }
}

function renderWorkoutHistory(workoutHistory) {
    const container = document.getElementById('workout-history-list');

    if (!workoutHistory || workoutHistory.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No workouts yet. Start your first workout!</div>';
        return;
    }

    // Group by date
    const grouped = {};
    workoutHistory.forEach(w => {
        const date = w.workout_date;
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(w);
    });

    // Get unique dates and sort descending
    const dates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).slice(0, 7);

    const html = dates.map(date => {
        const workouts = grouped[date];
        const exercises = [...new Set(workouts.map(w => w.exercise_name))];
        const formattedDate = new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        return `
            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9;">
                <div style="font-weight: 600; color: var(--primary); margin-bottom: 5px;">${formattedDate}</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                    ${exercises.slice(0, 3).join(', ')}${exercises.length > 3 ? ` +${exercises.length - 3} more` : ''}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html || '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No recent workouts</div>';
}

function renderMilestones(milestones) {
    const container = document.getElementById('milestones-list');

    if (!milestones || milestones.length === 0) {
        container.innerHTML = '<div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); text-align: center; color: var(--text-muted);">Complete your first workout to unlock achievements!</div>';
        return;
    }

    const getMilestoneEmoji = (type, value) => {
        if (type === 'workout_count') {
            if (value === 1) return '🎉';
            if (value >= 100) return '👑';
            if (value >= 50) return '🏆';
            if (value >= 25) return '🌟';
            if (value >= 10) return '🔥';
            return '💪';
        }
        if (type === 'workout_streak') return '⚡';
        return '🎖️';
    };

    const getMilestoneMessage = (type, value) => {
        if (type === 'workout_count') {
            if (value === 1) return 'First Workout!';
            if (value >= 100) return '100 Workouts - Legend!';
            if (value >= 50) return '50 Workouts - Unstoppable!';
            if (value >= 25) return '25 Workouts - Amazing!';
            if (value >= 10) return '10 Workouts - On Fire!';
            return `${value} Workouts Complete`;
        }
        if (type === 'workout_streak') return `${value}-Day Streak!`;
        return 'Achievement Unlocked';
    };

    const html = milestones.slice(0, 6).map(m => {
        const emoji = getMilestoneEmoji(m.milestone_type, m.milestone_value);
        const message = getMilestoneMessage(m.milestone_type, m.milestone_value);
        const date = new Date(m.achieved_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        return `
            <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 12px; display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 2.5rem;">${emoji}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--primary); font-size: 1rem; margin-bottom: 3px;">${message}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${date}</div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

function renderCheckins(checkins) {
    const container = document.getElementById('checkins-list');

    if (!checkins || checkins.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No check-ins yet</div>';
        return;
    }

    const getEnergyEmoji = (level) => {
        if (level === 'high') return '⚡';
        if (level === 'moderate') return '🔋';
        return '🪫';
    };

    const getSleepEmoji = (quality) => {
        if (quality === 'excellent') return '😴';
        if (quality === 'good') return '😊';
        if (quality === 'fair') return '😐';
        return '😓';
    };

    const html = checkins.slice(0, 7).map(c => {
        const date = new Date(c.checkin_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const energyEmoji = getEnergyEmoji(c.energy);
        const sleepEmoji = getSleepEmoji(c.sleep);

        return `
            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 3px;">${date}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                        Energy: ${energyEmoji} ${c.energy || 'N/A'} | Sleep: ${sleepEmoji} ${c.sleep || 'N/A'}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.85rem; color: var(--text-muted);">💧 ${c.water_intake || 0} cups</div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

async function renderExerciseProgress(userId, exercises) {
    const container = document.getElementById('exercise-progress-list');

    if (!exercises || exercises.length === 0) {
        container.innerHTML = '<div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); text-align: center; color: var(--text-muted);">No exercises tracked yet</div>';
        return;
    }

    // Get progress for each exercise
    const progressPromises = exercises.slice(0, 5).map(async exercise => {
        try {
            const progress = await dbHelpers.workouts.getExerciseProgress(userId, exercise, 5);
            return { exercise, progress };
        } catch (e) {
            return { exercise, progress: [] };
        }
    });

    const results = await Promise.all(progressPromises);

    const html = results.map(({ exercise, progress }) => {
        if (!progress || progress.length === 0) return '';

        const latest = progress[progress.length - 1];
        const first = progress[0];

        const latestWeight = parseFloat(latest.weight_kg) || 0;
        const latestReps = parseInt(latest.reps) || 0;
        const firstWeight = parseFloat(first.weight_kg) || 0;
        const firstReps = parseInt(first.reps) || 0;

        const weightGain = latestWeight - firstWeight;
        const repsGain = latestReps - firstReps;

        let improvement = '';
        if (weightGain > 0 && repsGain > 0) {
            improvement = `<span style="color: #10b981; font-weight: 600;">↗ +${weightGain}kg, +${repsGain} reps</span>`;
        } else if (weightGain > 0) {
            improvement = `<span style="color: #10b981; font-weight: 600;">↗ +${weightGain}kg</span>`;
        } else if (repsGain > 0) {
            improvement = `<span style="color: #10b981; font-weight: 600;">↗ +${repsGain} reps</span>`;
        } else {
            improvement = `<span style="color: var(--text-muted);">Maintaining</span>`;
        }

        return `
            <div onclick="showExerciseDetailChart('${exercise.replace(/'/g, "\\'")}', '${userId}')" style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform=''; this.style.boxShadow='var(--card-shadow)';">
                <div style="font-weight: 700; color: var(--primary); font-size: 1rem; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span>${exercise}</span>
                    <span style="font-size: 0.85rem; color: var(--text-muted);">📊</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                        Best: ${latestWeight > 0 ? latestWeight + 'kg' : ''} ${latestReps > 0 ? 'x ' + latestReps : ''}
                    </div>
                    <div style="font-size: 0.85rem;">
                        ${improvement}
                    </div>
                </div>
            </div>
        `;
    }).filter(Boolean).join('');

    container.innerHTML = html || '<div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); text-align: center; color: var(--text-muted);">No exercise progress data yet</div>';
}

// Show detailed exercise chart modal
async function showExerciseDetailChart(exerciseName, userId) {
    console.log('Opening chart for:', exerciseName);

    // Show modal
    const modal = document.getElementById('exercise-chart-modal');
    modal.style.display = 'flex';
    document.getElementById('exercise-chart-title').innerText = exerciseName;
    document.getElementById('exercise-chart-content').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Loading chart...</div>';

    try {
        // Fetch detailed progress (last 20 workouts)
        const progress = await dbHelpers.workouts.getExerciseProgress(userId, exerciseName, 20);

        if (!progress || progress.length === 0) {
            document.getElementById('exercise-chart-content').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No progress data available</div>';
            return;
        }

        // Render the chart
        renderExerciseChart(progress);

    } catch (error) {
        console.error('Error loading exercise chart:', error);
        document.getElementById('exercise-chart-content').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Failed to load chart</div>';
    }
}

// Close the exercise chart modal
function closeExerciseChartModal() {
    document.getElementById('exercise-chart-modal').style.display = 'none';
}

// Render SVG chart for exercise progress
function renderExerciseChart(progress) {
    const container = document.getElementById('exercise-chart-content');

    // Prepare data
    const dates = progress.map(p => {
        const d = new Date(p.workout_date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    const weights = progress.map(p => parseFloat(p.weight_kg) || 0);
    const reps = progress.map(p => parseInt(p.reps) || 0);

    const hasWeight = weights.some(w => w > 0);
    const hasReps = reps.some(r => r > 0);

    // Chart dimensions
    const width = 400;
    const height = 250;
    const padding = { top: 20, right: 50, bottom: 40, left: 50 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // Calculate scales
    const maxWeight = Math.max(...weights, 1);
    const maxReps = Math.max(...reps, 1);

    // Create SVG
    let svg = `<svg viewBox="0 0 ${width} ${height}" style="width: 100%; max-width: 500px; margin: 0 auto; display: block; overflow: visible;">`;

    // Grid lines
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#f1f5f9" stroke-width="1"/>`;
    }

    // X-axis labels (dates)
    const labelFrequency = Math.ceil(dates.length / 5);
    const xStep = dates.length > 1 ? chartWidth / (dates.length - 1) : 0;
    dates.forEach((date, i) => {
        if (i % labelFrequency === 0 || i === dates.length - 1) {
            const x = padding.left + xStep * i;
            // Use text-anchor start for first label, end for last, middle for others
            let anchor = 'middle';
            if (i === 0) anchor = 'start';
            else if (i === dates.length - 1 && dates.length > 1) anchor = 'end';
            svg += `<text x="${x}" y="${height - 10}" text-anchor="${anchor}" font-size="10" fill="#718096">${date}</text>`;
        }
    });

    // Y-axis labels and data lines
    const dataXStep = dates.length > 1 ? chartWidth / (dates.length - 1) : 0;

    if (hasWeight) {
        // Weight line (primary - green)
        let weightPath = 'M';
        weights.forEach((weight, i) => {
            const x = padding.left + dataXStep * i;
            const y = padding.top + chartHeight - (weight / maxWeight) * chartHeight;
            weightPath += ` ${x},${y}`;

            // Add point
            svg += `<circle cx="${x}" cy="${y}" r="4" fill="#7BA883" stroke="white" stroke-width="2"/>`;
        });
        svg += `<path d="${weightPath}" fill="none" stroke="#7BA883" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>`;

        // Y-axis labels for weight
        for (let i = 0; i <= 4; i++) {
            const value = (maxWeight / 4) * (4 - i);
            const y = padding.top + (chartHeight / 4) * i;
            svg += `<text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" font-size="10" fill="#7BA883" font-weight="600">${value.toFixed(0)}kg</text>`;
        }
    }

    if (hasReps) {
        // Reps line (secondary - gold)
        let repsPath = 'M';
        reps.forEach((rep, i) => {
            const x = padding.left + dataXStep * i;
            const y = padding.top + chartHeight - (rep / maxReps) * chartHeight;
            repsPath += ` ${x},${y}`;

            // Add point
            svg += `<circle cx="${x}" cy="${y}" r="4" fill="#E8D68E" stroke="white" stroke-width="2"/>`;
        });
        svg += `<path d="${repsPath}" fill="none" stroke="#E8D68E" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>`;

        // Y-axis labels for reps (on right side)
        for (let i = 0; i <= 4; i++) {
            const value = (maxReps / 4) * (4 - i);
            const y = padding.top + (chartHeight / 4) * i;
            svg += `<text x="${width - padding.right + 10}" y="${y + 4}" text-anchor="start" font-size="10" fill="#E8D68E" font-weight="600">${value.toFixed(0)} reps</text>`;
        }
    }

    svg += '</svg>';

    // Add legend
    let legend = '<div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px; font-size: 0.85rem;">';
    if (hasWeight) {
        legend += '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 3px; background: #7BA883; border-radius: 2px;"></div><span style="color: var(--text-muted);">Weight (kg)</span></div>';
    }
    if (hasReps) {
        legend += '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 3px; background: #E8D68E; border-radius: 2px;"></div><span style="color: var(--text-muted);">Reps</span></div>';
    }
    legend += '</div>';

    // Stats summary
    const firstWeight = weights[0] || 0;
    const lastWeight = weights[weights.length - 1] || 0;
    const firstReps = reps[0] || 0;
    const lastReps = reps[reps.length - 1] || 0;
    const weightChange = lastWeight - firstWeight;
    const repsChange = lastReps - firstReps;

    let stats = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">';

    if (hasWeight && weightChange !== 0) {
        stats += `
            <div style="background: #f0fdf4; padding: 15px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: ${weightChange > 0 ? '#10b981' : '#ef4444'};">${weightChange > 0 ? '+' : ''}${weightChange.toFixed(1)}kg</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">Weight Change</div>
            </div>
        `;
    }

    if (hasReps && repsChange !== 0) {
        stats += `
            <div style="background: #fefce8; padding: 15px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: ${repsChange > 0 ? '#10b981' : '#ef4444'};">${repsChange > 0 ? '+' : ''}${repsChange}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">Reps Change</div>
            </div>
        `;
    }

    stats += '</div>';

    container.innerHTML = `
        <div style="padding: 20px; overflow: visible;">
            ${svg}
            ${legend}
            ${stats}
        </div>
    `;
}
</script>

<script>
// --- HORMONE HUB & SUPERBOOST ENGINE ---

let checkInProgress = { flow:null, symptoms:[], mood:null, energy:null, fluid:null };

function initCycleView() {
    // 1. Ensure Data Loaded
    if(typeof initCalendarView === 'function') initCalendarView(); // Legacy loader
    
    // 2. Render Wheel
    renderCycleStatus();
    
    // 3. Render Calendar
    if(typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();
    
    // 4. Check Daily Log Status
    const today = new Date().toISOString().split('T')[0];
    const hasLog = userCycleData.logs && userCycleData.logs[today];
    
    const promptCard = document.getElementById('check-in-prompt-card');
    const completeCard = document.getElementById('check-in-completed-card');
    
    if(promptCard && completeCard) {
        if(hasLog) {
            promptCard.style.display = 'none';
            completeCard.style.display = 'block';
        } else {
            promptCard.style.display = 'flex';
            completeCard.style.display = 'none';
        }
    }
}

function renderCycleStatus() {
    const today = new Date();
    // Default values
    let dayNum = 1;
    let phase = 'wellness';
    
    if (userCycleData.lastPeriod && !userCycleData.noPeriodMode) {
        const lastP = new Date(userCycleData.lastPeriod);
        const diff = Math.floor((today - lastP) / (1000 * 60 * 60 * 24));
        dayNum = (diff % userCycleData.cycleLength) + 1;
        
        // Determine Phase
        if (dayNum >= 1 && dayNum <= 5) phase = 'menstrual';
        else if (dayNum <= 13) phase = 'follicular';
        else if (dayNum <= 16) phase = 'ovulation';
        else phase = 'luteal';
    }
    
    // Update UI
    const dayDisplay = document.getElementById('cycle-day-display');
    const nameDisplay = document.getElementById('cycle-phase-name');
    const descDisplay = document.getElementById('cycle-phase-desc');
    const tagsContainer = document.getElementById('cycle-phase-tags');
    
    if(dayDisplay) dayDisplay.innerText = dayNum;
    
    const info = PHASE_INFO[phase];
    if(nameDisplay && info) {
        nameDisplay.innerText = info.name;
        nameDisplay.style.color = info.color;
    }
    if(descDisplay && info) {
        descDisplay.innerText = info.rec || "Listen to your body.";
    }
    
    // Tags
    if(tagsContainer && info) {
        tagsContainer.innerHTML = `
            <span style="background:${info.color}20; color:${info.color}; padding:4px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">${info.icon} ${phase.toUpperCase()}</span>
        `;
    }
}

// --- CHECK-IN LOGIC ---

function openCheckInModal() {
    // Ensure gender-specific UI is applied before showing modal
    if (typeof applyGenderSpecificUI === 'function') {
        applyGenderSpecificUI();
    }
    document.getElementById('check-in-modal').style.display = 'flex';
    // Clear previous selection visually? Or keep if re-opening?
    // For now, keep state
}

function closeCheckInModal() {
    document.getElementById('check-in-modal').style.display = 'none';
}

function selectCheckInOption(category, value, el) {
    // 1. Update State
    checkInProgress[category] = value;

    // 2. Update UI (Siblings)
    const options = document.querySelectorAll(`.check-in-chip[data-group="${category}"]`);
    options.forEach(opt => opt.classList.remove('selected'));

    // 3. Select Clicked
    el.classList.add('selected');
}

function toggleCheckInOption(category, value, el) {
    // 1. Update State (Array)
    if(!checkInProgress[category]) checkInProgress[category] = [];
    
    const idx = checkInProgress[category].indexOf(value);
    if(idx > -1) {
        checkInProgress[category].splice(idx, 1); // Remove
        el.classList.remove('selected');
    } else {
        checkInProgress[category].push(value); // Add
        el.classList.add('selected');
    }
}

async function submitDailyCycleSync() {
    // 1. Save Log locally
    const today = new Date().toISOString().split('T')[0];
    if(!userCycleData.logs) userCycleData.logs = {};

    // Clone to avoid ref issues
    userCycleData.logs[today] = JSON.parse(JSON.stringify(checkInProgress));

    // Update userCycleData.symptoms from check-in
    userCycleData.symptoms = checkInProgress.symptoms || [];

    // Persist to localStorage
    localStorage.setItem('userCycleData', JSON.stringify(userCycleData));

    // 2. Save to Supabase for persistence across refreshes
    if(window.currentUser && typeof dbHelpers !== 'undefined') {
        try {
            await dbHelpers.checkins.upsert(window.currentUser.id, today, {
                energy: checkInProgress.energy || null,
                equipment: checkInProgress.equipment || null,
                additional_data: {
                    symptoms: checkInProgress.symptoms || [],
                    mood: checkInProgress.mood || null,
                    flow: checkInProgress.flow || null,
                    fluid: checkInProgress.fluid || null,
                    recovery: checkInProgress.recovery || null
                }
            });
            console.log('✅ Check-in saved to Supabase');
        } catch (e) {
            console.error('Failed to save check-in to DB:', e);
        }
    }

    // Mark check-in as completed for today
    localStorage.setItem('lastWellnessCheck', new Date().toDateString());

    // 3. Update Active Symptoms display in Metabolic Protocol section
    const symptomsDisplay = document.getElementById('profile-symptoms-display');
    if (symptomsDisplay) {
        const symptoms = checkInProgress.symptoms || [];
        if (symptoms.length > 0) {
            // Format symptom names nicely (e.g., cramps -> Cramps, back_pain -> Back Pain)
            const formattedSymptoms = symptoms.map(s =>
                s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
            ).join(', ');
            symptomsDisplay.textContent = formattedSymptoms;
        } else {
            symptomsDisplay.textContent = 'None';
        }
    }

    // 4. Trigger Cycle Sync Engine (updates workout recommendations)
    applyCycleSync(checkInProgress);

    // 5. Close & Refresh views
    closeCheckInModal();
    initCycleView(); // Updates calendar
    renderWeeklyCalendar(); // Update weekly calendar view

    // CRITICAL: Refresh Movement view to apply equipment selection
    if (typeof renderMovementView === 'function') {
        renderMovementView();
    }

    // 6. Redirect to Dashboard with Animation
    switchAppTab('dashboard');

    // Show Toast/Banner on Dashboard
    showCycleSyncBanner();
}

function applyCycleSync(data) {
    console.log("🚀 Applying Cycle Sync:", data);
    // This function will be called by renderDashboard to override suggestions
    // For now, we save it to session state or global
    window.cycleSyncState = data;
    
    // Force Dashboard Refresh
    if(typeof updateDashboardWorkoutCard === 'function') updateDashboardWorkoutCard();
}

function showCycleSyncBanner() {
    // Create a temporary banner
    const banner = document.createElement('div');
    banner.innerText = "✨ Dashboard Updated with your Cycle Sync!";
    banner.style.cssText = "position:fixed; top:80px; left:50%; transform:translateX(-50%); background:var(--primary); color:white; padding:10px 20px; border-radius:20px; z-index:2000; font-weight:600; box-shadow:0 4px 12px rgba(0,0,0,0.2); animation: fadeIn 0.5s;";
    document.body.appendChild(banner);
    
    setTimeout(() => {
        banner.style.opacity = '0';
        setTimeout(() => banner.remove(), 500);
    }, 3000);
}

// --- CYCLE SYNC RECIPE DATABASE ---
const CYCLE_SYNC_RECIPES = {
    'bloating': {
        title: "Ginger Pear Smoothie",
        meta: "Anti-Bloat Elixir",
        img: "/assets/ginger_pear_smoothie.png",
        why: "Ginger and pear are natural diuretics that help flush excess water and soothe digestion.",
        ingredients: ["Pear 170g", "Spinach 50g", "Cucumber 80g", "Ginger 1 inch", "Pea Protein 30g"],
        prep: "Blend all ingredients with water and ice until smooth."
    },
    'cramps': {
        title: "Stuffed Sweet Potato",
        meta: "Magnesium Rescue",
        img: "/assets/stuffed_sweet_potato.jpg",
        why: "Sweet potatoes and black beans are rich in magnesium, which relaxes uterine muscles to ease cramps.",
        ingredients: ["Sweet Potato 1 large", "Black Beans 1/2 cup", "Quinoa 1/2 cup", "Pumpkin Seeds 1 tbsp"],
        prep: "Roast potato. Stuff with quinoa and beans. Top with seeds."
    },
    'mood': {
        title: "Cacao Night Calm",
        meta: "Serotonin Boost",
        img: "/assets/smoothie_cacao_calm.png",
        why: "Raw cacao stimulates serotonin, while almond butter stabilizes blood sugar to level out your mood.",
        ingredients: ["Frozen Banana 1", "Raw Cacao 1 tbsp", "Almond Butter 1 tbsp", "Oat Milk 1 cup"],
        prep: "Blend until creamy. Top with cacao nibs."
    },
    'fatigue': {
        title: "Matcha Mint Energy",
        meta: "Sustained Focus",
        img: "/assets/smoothie_matcha_mint.png",
        why: "L-Theanine in matcha provides calm, sustained energy without the cortisol spike of coffee.",
        ingredients: ["Matcha Powder 1 tsp", "Mint Leaves 5", "Frozen Banana 1/2", "Vanilla Protein 1 scoop"],
        prep: "Blend with coconut milk for a creamy energy boost."
    },
    'inflammation': {
        title: "Golden Turmeric Tonic",
        meta: "Inflammation Fighter",
        img: "/assets/smoothie_golden_turmeric.png",
        why: "Turmeric's curcumin is a potent anti-inflammatory compound, especially when paired with black pepper.",
        ingredients: ["Mango 1/2 cup", "Turmeric 1 tsp", "Black Pepper pinch", "Flax Oil 1 tsp"],
        prep: "Blend with coconut milk. Enjoy immediately."
    }
};

function renderCycleSyncMeal(reason, recipeKey) {
    const container = document.getElementById('today-meals-container'); // Need to ensure this exists or find where to inject
    const recipe = CYCLE_SYNC_RECIPES[recipeKey];
    if(!recipe || !container) return;

    // Save the swapped meal data so we can add it to the meal plan
    window.cycleSyncMealTitle = recipe.title;
    window.cycleSyncMealData = recipe;
    window.cycleSyncMealReason = reason;

    const html = `
    <div style="background: linear-gradient(135deg, #fff 0%, #fefce8 100%); border: 2px solid var(--secondary); border-radius: 16px; margin-bottom: 25px; overflow: hidden; box-shadow: 0 10px 30px rgba(180, 155, 10, 0.15); animation: slideUp 0.4s ease-out;">
        <div style="background: var(--secondary); color: black; padding: 8px 15px; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; display:flex; justify-content:space-between; align-items:center;">
             <span>✨ Cycle Sync Meal Swap</span>
             <span>${reason}</span>
        </div>
        <div style="display: flex; flex-direction: column; md:flex-row;">
            <div style="padding: 20px;">
                <div style="font-family:'Playfair Display'; font-size: 1.4rem; color: var(--primary); margin-bottom: 5px; font-weight:700;">${recipe.title}</div>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 12px; font-weight:500;">${recipe.meta}</div>
                <p style="font-size: 0.95rem; color: #4a5568; margin-bottom: 15px; line-height: 1.5; background: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; border-left: 3px solid var(--secondary);">${recipe.why}</p>
                
                <button onclick="switchAppTab('meals', this); setTimeout(() => switchWeek('today'), 50);" style="background: white; border: 1px solid #cbd5e0; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">View Recipe</button>
            </div>
            <img src="${recipe.img}" style="width: 100%; height: 180px; object-fit: cover; md:width: 150px; md:height: auto;" onerror="this.style.display='none'">
        </div>
        
        <!-- Collapsible Details (Hidden by default) -->
        <div class="card card-body" style="padding: 0 20px; margin:0; box-shadow:none; border:none; background:transparent;">
            <div style="padding: 20px 0;">
                <h4 style="margin-top:0;">Ingredients</h4>
                <ul style="margin-bottom:15px;">
                    ${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}
                </ul>
                <h4 style="margin-top:0;">Preparation</h4>
                <p>${recipe.prep}</p>
            </div>
        </div>
    </div>
    `;
    
    // Insert at top of meals
    const existing = document.getElementById('cycle-sync-meal-card');
    if(existing) existing.remove();
    
    // Create wrapper if implies
    const wrapper = document.createElement('div');
    wrapper.id = 'cycle-sync-meal-card';
    wrapper.innerHTML = html;
    
    container.insertBefore(wrapper, container.firstChild);
}

function checkAndRenderCycleSync() {
    // Check if we have a log for today
    if(!userCycleData || !userCycleData.logs) return;
    
    const today = new Date().toISOString().split('T')[0];
    const log = userCycleData.logs[today];
    
    if(log && log.symptoms && log.symptoms.length > 0) {
        // Prioritize symptoms for display
        const priorities = ['bloating', 'cramps', 'mood', 'fatigue', 'inflammation'];
        let match = null;
        
        // Find highest priority symptom
        for(let p of priorities) {
             // Basic matching - handle "mood" specially if it's a category
             if(p === 'mood') {
                 if(log.mood === 'sad' || log.mood === 'anxious') {
                     match = 'mood'; 
                     break; 
                 }
             }
             if(log.symptoms.includes(p)) {
                 match = p;
                 break;
             }
        }
        
        // Fallback to mood mapping if no physical symptoms but mood is low
        if(!match && (log.mood === 'sad' || log.mood === 'anxious')) {
            match = 'mood';
        }

        if(match) {
            renderCycleSyncMeal(match.charAt(0).toUpperCase() + match.slice(1), match);
        }
    
    } else if (log && log.energy === 'low') {
         renderCycleSyncMeal('Energy Boost', 'fatigue');
    }
}

// Initial Load
document.addEventListener('DOMContentLoaded', () => {
    // Load cycle data from localStorage first
    if(typeof initCalendarView === 'function') {
        initCalendarView().then(() => {
            // After data is loaded, check for Cycle Sync
            checkAndRenderCycleSync();
        }).catch(err => {
            console.log('Error loading calendar view:', err);
            // Still try to check Cycle Sync even if there was an error
            checkAndRenderCycleSync();
        });
    } else {
        // Fallback if initCalendarView doesn't exist
        setTimeout(checkAndRenderCycleSync, 1000);
    }
    // Check if we need to load cycle view
    // (Existing init calls will handle this if tab is active)
});

</script>

<script>
// ==========================================
// POINTS WIDGET FUNCTIONS
// ==========================================

const POINTS_FOR_FREE_WEEK = 200;

// Load and display user's points data
async function loadPointsWidget() {
    // Always show the widget (even with default values)
    const widget = document.getElementById('points-widget');
    if (widget) {
        widget.style.display = 'block';
    }

    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) {
            console.log('No user session, showing default points widget');
            updatePointsDisplay({ current_points: 0, current_streak: 0 });
            return;
        }

        const userId = session.user.id;

        // Try to get points data, fall back to defaults if table doesn't exist
        let pointsData = { current_points: 0, current_streak: 0 };
        try {
            const data = await window.db?.points?.getPoints(userId);
            if (data) {
                pointsData = data;
            }
        } catch (dbError) {
            console.log('Points table not set up yet, using defaults');
        }

        // Update points display
        updatePointsDisplay(pointsData);

    } catch (error) {
        console.error('Error loading points widget:', error);
        // Still show with defaults
        updatePointsDisplay({ current_points: 0, current_streak: 0 });
    }
}

// Update points display with current data
function updatePointsDisplay(pointsData) {
    const currentPoints = pointsData.current_points || 0;
    const currentStreak = pointsData.current_streak || 0;

    // Update points number
    const pointsEl = document.getElementById('points-current');
    if (pointsEl) {
        pointsEl.textContent = currentPoints.toLocaleString();
    }

    // Update streak
    const streakEl = document.getElementById('streak-current');
    if (streakEl) {
        streakEl.textContent = currentStreak;
    }

    // Update progress bar
    const progressPercent = Math.min(100, (currentPoints / POINTS_FOR_FREE_WEEK) * 100);
    const progressFill = document.getElementById('points-progress-fill');
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
    }

    // Update progress label
    const progressLabel = document.getElementById('points-progress-label');
    if (progressLabel) {
        const remaining = POINTS_FOR_FREE_WEEK - currentPoints;
        if (currentPoints >= POINTS_FOR_FREE_WEEK) {
            progressLabel.textContent = 'Ready to redeem a free week!';
        } else {
            progressLabel.textContent = `${currentPoints}/${POINTS_FOR_FREE_WEEK} to free week`;
        }
    }

    // Update redeem button
    const redeemBtn = document.getElementById('redeem-btn');
    if (redeemBtn) {
        if (currentPoints >= POINTS_FOR_FREE_WEEK) {
            redeemBtn.disabled = false;
            redeemBtn.textContent = 'Redeem Free Week!';
        } else {
            redeemBtn.disabled = true;
            redeemBtn.textContent = `Redeem Free Week (${POINTS_FOR_FREE_WEEK - currentPoints} more pts)`;
        }
    }
}

// Redeem points for free week
async function redeemPointsForFreeWeek() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) {
            alert('Please log in to redeem points');
            return;
        }

        const redeemBtn = document.getElementById('redeem-btn');
        if (redeemBtn) {
            redeemBtn.disabled = true;
            redeemBtn.textContent = 'Redeeming...';
        }

        const result = await window.db?.points?.redeemPoints(session.user.id);

        if (result?.success) {
            showMilestoneToast({
                label: 'Free Week Unlocked!',
                points: -POINTS_FOR_FREE_WEEK
            });

            // Refresh points display
            await loadPointsWidget();

            alert(`Congratulations! You've earned 7 free days!\n\nYour subscription has been extended.`);
        } else {
            alert(result?.message || 'Could not redeem points. Please try again.');
            // Re-enable button
            if (redeemBtn) {
                redeemBtn.disabled = false;
                redeemBtn.textContent = 'Redeem Free Week!';
            }
        }
    } catch (error) {
        console.error('Error redeeming points:', error);
        alert('An error occurred. Please try again.');
    }
}

// Show milestone achievement toast
function showMilestoneToast(milestone) {
    const toast = document.createElement('div');
    toast.className = 'milestone-toast';
    toast.innerHTML = `
        <div class="milestone-icon">&#x1F389;</div>
        <div>
            <div class="milestone-title">${milestone.label}</div>
            ${milestone.points > 0 ? `<div class="milestone-points">+${milestone.points} points</div>` : ''}
        </div>
    `;

    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 4 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Show points earned toast
function showPointsEarnedToast(points, bonusPoints = 0, streak = 0) {
    const toast = document.createElement('div');
    toast.className = 'points-earned-toast';
    toast.innerHTML = `
        <div class="points-earned-main">+${points} pt${points > 1 ? 's' : ''}</div>
        ${bonusPoints > 0 ? `<div class="points-earned-bonus">+${bonusPoints} streak bonus!</div>` : ''}
        ${streak > 0 ? `<div class="points-earned-streak">&#x1F525; ${streak} day streak</div>` : ''}
    `;

    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Award points for a meal (called after successful meal logging)
async function awardPointsForMeal(mealLogId, photoTimestamp, aiConfidence, photoHash) {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return null;

        const result = await window.db?.points?.awardPoints(
            session.user.id,
            'meal',
            mealLogId,
            { photoTimestamp, aiConfidence, photoHash }
        );

        if (result?.success) {
            // Show points earned toast
            showPointsEarnedToast(
                result.pointsAwarded,
                result.bonusPoints,
                result.currentStreak
            );

            // Show milestone toasts
            if (result.milestonesUnlocked?.length > 0) {
                result.milestonesUnlocked.forEach((milestone, index) => {
                    setTimeout(() => showMilestoneToast(milestone), (index + 1) * 500);
                });
            }

            // Refresh points widget
            await loadPointsWidget();
        } else if (result?.error) {
            console.log('Points not awarded:', result.reason || result.error);
            // Optionally show a subtle message about why points weren't awarded
        }

        return result;
    } catch (error) {
        console.error('Error awarding points for meal:', error);
        return null;
    }
}

// Award points for a workout (called after successful workout logging)
async function awardPointsForWorkout(workoutId, photoTimestamp = null, aiConfidence = null, photoHash = null) {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return null;

        const result = await window.db?.points?.awardPoints(
            session.user.id,
            'workout',
            workoutId,
            { photoTimestamp, aiConfidence, photoHash }
        );

        if (result?.success) {
            // Show points earned toast
            showPointsEarnedToast(
                result.pointsAwarded,
                result.bonusPoints,
                result.currentStreak
            );

            // Show milestone toasts
            if (result.milestonesUnlocked?.length > 0) {
                result.milestonesUnlocked.forEach((milestone, index) => {
                    setTimeout(() => showMilestoneToast(milestone), (index + 1) * 500);
                });
            }

            // Refresh points widget
            await loadPointsWidget();
        }

        return result;
    } catch (error) {
        console.error('Error awarding points for workout:', error);
        return null;
    }
}

// ==========================================
// WORKOUT PHOTO VERIFICATION FUNCTIONS
// ==========================================

let capturedWorkoutFile = null;
let workoutPhotoBase64 = null;

// Handle workout photo selection
async function handleWorkoutPhotoSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    capturedWorkoutFile = file;

    // Convert to base64 for preview and analysis
    workoutPhotoBase64 = await fileToBase64(file);

    // Show preview modal
    const previewModal = document.getElementById('workout-preview-modal');
    const previewPhoto = document.getElementById('workout-preview-photo');

    if (previewModal && previewPhoto) {
        previewPhoto.src = workoutPhotoBase64;
        previewModal.style.display = 'flex';
    }

    // Reset file input for future selections
    event.target.value = '';
}

// Close workout preview modal
function closeWorkoutPreviewModal() {
    const previewModal = document.getElementById('workout-preview-modal');
    if (previewModal) {
        previewModal.style.display = 'none';
    }
    capturedWorkoutFile = null;
    workoutPhotoBase64 = null;

    // Hide any loading/error states
    const loading = document.getElementById('workout-photo-loading');
    const error = document.getElementById('workout-photo-error');
    if (loading) loading.style.display = 'none';
    if (error) error.style.display = 'none';
}

// Verify workout photo with Gemini AI
async function verifyWorkoutPhoto() {
    if (!capturedWorkoutFile || !workoutPhotoBase64) {
        alert('No photo captured. Please try again.');
        return;
    }

    const loadingEl = document.getElementById('workout-photo-loading');
    const errorEl = document.getElementById('workout-photo-error');
    const verifyBtn = document.getElementById('workout-verify-btn');

    // Show loading
    if (loadingEl) loadingEl.style.display = 'block';
    if (verifyBtn) verifyBtn.disabled = true;

    try {
        // Get base64 data without prefix
        const base64Data = workoutPhotoBase64.split(',')[1];

        // Call Gemini API to verify workout photo
        const response = await fetch('/api/analyze-workout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                imageBase64: base64Data,
                mimeType: capturedWorkoutFile.type
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            throw new Error(errorData.error || 'Failed to verify workout photo');
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Verification failed');
        }

        const analysisData = result.data;

        // Check if photo is eligible for points
        if (!result.pointsEligible) {
            // Show why it wasn't eligible
            let reason = 'This photo could not be verified as a workout.';
            if (!analysisData.isWorkoutPhoto) {
                reason = 'This doesn\'t appear to be a workout photo. Try taking a photo at the gym, during exercise, or showing workout equipment.';
            } else if (analysisData.confidence === 'low') {
                reason = 'The photo quality or content couldn\'t be clearly verified. Try a clearer photo showing your workout.';
            } else if (analysisData.suspiciousIndicators?.length > 0) {
                reason = 'This photo appears to be a screenshot or stock image. Please take a real photo of your workout.';
            }

            if (errorEl) {
                document.getElementById('workout-photo-error-text').textContent = reason;
                errorEl.style.display = 'block';
            }
            if (loadingEl) loadingEl.style.display = 'none';
            if (verifyBtn) verifyBtn.disabled = false;
            return;
        }

        // Photo verified! Upload and save
        await saveVerifiedWorkoutPhoto(analysisData);

    } catch (error) {
        console.error('Error verifying workout photo:', error);
        if (errorEl) {
            document.getElementById('workout-photo-error-text').textContent = error.message || 'Failed to verify photo. Please try again.';
            errorEl.style.display = 'block';
        }
        if (loadingEl) loadingEl.style.display = 'none';
        if (verifyBtn) verifyBtn.disabled = false;
    }
}

// Save verified workout photo and award points
async function saveVerifiedWorkoutPhoto(analysisData) {
    const loadingEl = document.getElementById('workout-photo-loading');
    const loadingText = document.getElementById('workout-photo-loading-text');

    if (loadingText) loadingText.textContent = 'Saving workout...';

    try {
        const user = await window.supabaseClient.auth.getUser();
        const userId = user?.data?.user?.id;

        if (!userId) {
            throw new Error('User not authenticated');
        }

        // Upload photo to B2
        const formData = new FormData();
        formData.append('file', capturedWorkoutFile);
        formData.append('userId', userId);

        const uploadResponse = await fetch('/api/upload-workout-photo', {
            method: 'POST',
            body: formData
        });

        if (!uploadResponse.ok) {
            const errorData = await uploadResponse.json();
            throw new Error(errorData.error || 'Failed to upload photo');
        }

        const uploadData = await uploadResponse.json();
        const photoUrl = uploadData.url;

        // Generate photo hash for duplicate detection
        const photoHash = await window.db?.points?.generatePhotoHash(workoutPhotoBase64);

        // Save workout photo log to database
        const { data: savedLog, error: saveError } = await window.supabaseClient
            .from('workout_photo_logs')
            .insert({
                user_id: userId,
                photo_url: photoUrl,
                storage_path: uploadData.fileName,
                is_workout_photo: analysisData.isWorkoutPhoto,
                workout_type: analysisData.workoutType,
                detected_elements: analysisData.detectedElements || [],
                suspicious_indicators: analysisData.suspiciousIndicators || [],
                ai_confidence: analysisData.confidence,
                ai_notes: analysisData.notes,
                analysis_timestamp: new Date().toISOString(),
                points_eligible: true,
                photo_hash: photoHash
            })
            .select();

        if (saveError) {
            console.error('Error saving workout photo log:', saveError);
            // Continue anyway - we still want to award points
        }

        // Award points for the verified workout photo
        const workoutLogId = savedLog?.[0]?.id || `workout_photo_${Date.now()}`;
        const photoTimestamp = capturedWorkoutFile.lastModified
            ? new Date(capturedWorkoutFile.lastModified).toISOString()
            : null;

        const pointsResult = await awardPointsForWorkout(
            workoutLogId,
            photoTimestamp,
            analysisData.confidence,
            photoHash
        );

        // Update the saved log with points awarded
        if (savedLog?.[0]?.id && pointsResult?.pointsAwarded) {
            await window.supabaseClient
                .from('workout_photo_logs')
                .update({ points_awarded: pointsResult.pointsAwarded })
                .eq('id', savedLog[0].id);
        }

        // Close modal and show success
        closeWorkoutPreviewModal();

        // Update success screen to show points earned
        const photoSection = document.getElementById('workout-photo-section');
        const pointsAwarded = document.getElementById('workout-points-awarded');

        if (photoSection) photoSection.style.display = 'none';
        if (pointsAwarded) pointsAwarded.style.display = 'block';

        console.log('Workout photo verified and points awarded!', pointsResult);

    } catch (error) {
        console.error('Error saving workout photo:', error);
        const errorEl = document.getElementById('workout-photo-error');
        if (errorEl) {
            document.getElementById('workout-photo-error-text').textContent = error.message || 'Failed to save workout. Please try again.';
            errorEl.style.display = 'block';
        }
        if (loadingEl) loadingEl.style.display = 'none';
        const verifyBtn = document.getElementById('workout-verify-btn');
        if (verifyBtn) verifyBtn.disabled = false;
    }
}

// Upload workout photo to B2 storage
async function uploadWorkoutPhoto(file) {
    const user = await window.supabaseClient.auth.getUser();
    const userId = user?.data?.user?.id;

    if (!userId) {
        throw new Error('User not authenticated');
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('userId', userId);

    const response = await fetch('/api/upload-workout-photo', {
        method: 'POST',
        body: formData
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to upload photo');
    }

    const data = await response.json();
    return data.url;
}

// Initialize points widget on dashboard load
document.addEventListener('DOMContentLoaded', function() {
    // Load points widget after a short delay to ensure auth is ready
    setTimeout(loadPointsWidget, 1000);
});
</script>

<script>
// ==========================================
// CALORIE TRACKER FUNCTIONS
// ==========================================

let mealCameraSource = 'widget'; // Track where camera was opened from
let mealCameraStream = null; // Camera stream (legacy, no longer used)
let capturedMealFile = null; // Captured meal photo file

// Open native camera for meal photos (best quality and reliability)
function openMealCamera(source) {
    console.log('openMealCamera called from:', source);
    mealCameraSource = source || 'widget';

    // Create file input to trigger native camera
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.capture = 'environment'; // Opens native camera app
    fileInput.style.display = 'none';

    let hasProcessedFile = false;

    fileInput.onchange = function(e) {
        if (hasProcessedFile) return; // Prevent double-processing
        hasProcessedFile = true;

        const file = e.target.files[0];
        if (!file) {
            console.log('No photo selected from camera');
            cleanup();
            return;
        }

        console.log('Meal photo captured:', file.name, file.type, 'Size:', (file.size / 1024 / 1024).toFixed(2), 'MB');

        // Validate it's an image
        if (!file.type.startsWith('image/')) {
            alert('Invalid file type. Please take a photo.');
            cleanup();
            return;
        }

        // Set as captured meal file
        capturedMealFile = file;

        // Show preview in modal
        const reader = new FileReader();
        reader.onload = function(e) {
            showMealPhotoPreview(e.target.result);
        };
        reader.onerror = function(error) {
            console.error('FileReader error:', error);
            alert('Failed to load photo. Please try again.');
            cleanup();
        };
        reader.readAsDataURL(file);

        // Clean up after processing
        setTimeout(cleanup, 500);
    };

    function cleanup() {
        try {
            if (fileInput && fileInput.parentNode) {
                fileInput.parentNode.removeChild(fileInput);
            }
        } catch (e) {
            console.log('Cleanup error (non-critical):', e);
        }
    }

    // Handle cancel
    fileInput.addEventListener('cancel', function() {
        console.log('Camera cancelled by user');
        cleanup();
    });

    // Fallback cleanup after 2 minutes
    setTimeout(() => {
        if (!hasProcessedFile) {
            console.log('Camera timeout - cleaning up');
            cleanup();
        }
    }, 120000);

    // Add to DOM and trigger
    document.body.appendChild(fileInput);

    // Small delay to ensure proper triggering on all devices
    setTimeout(() => {
        try {
            fileInput.click();
        } catch (error) {
            console.error('Failed to trigger camera:', error);
            alert('Camera unavailable. Please check your browser permissions.');
            cleanup();
        }
    }, 100);
}

// Show meal photo preview in modal
function showMealPhotoPreview(dataUrl) {
    const previewModal = document.getElementById('meal-preview-modal');
    const previewPhoto = document.getElementById('meal-preview-photo');

    if (!previewModal || !previewPhoto) {
        console.error('Preview modal elements not found');
        return;
    }

    // Show modal with preview
    previewPhoto.src = dataUrl;
    previewModal.style.display = 'flex';
}

// Close meal preview modal
function closeMealPreviewModal() {
    const previewModal = document.getElementById('meal-preview-modal');
    if (previewModal) {
        previewModal.style.display = 'none';
    }

    // Clear description input
    const descriptionInput = document.getElementById('meal-description-input');
    if (descriptionInput) {
        descriptionInput.value = '';
    }

    capturedMealFile = null;
}

// Retake meal photo from preview
function retakeMealPhotoFromPreview() {
    closeMealPreviewModal();
    // Reopen camera with same source
    openMealCamera(mealCameraSource);
}

// Legacy functions - no longer needed with native camera

// Use captured meal photo for analysis
async function useMealPhoto() {
    if (!capturedMealFile) {
        alert('No photo captured. Please try again.');
        return;
    }

    // Store file reference before closing modal (modal clears capturedMealFile)
    const fileToAnalyze = capturedMealFile;

    // Get meal description if provided
    const descriptionInput = document.getElementById('meal-description-input');
    const mealDescription = descriptionInput ? descriptionInput.value.trim() : '';

    // Close preview modal
    closeMealPreviewModal();

    // Show loading state
    showMealAnalysisLoading();

    // Convert to base64 once
    const base64 = await fileToBase64(fileToAnalyze);
    const base64Data = base64.split(',')[1]; // Remove data:image/jpeg;base64, prefix

    // Retry logic - try up to 5 times
    const maxAttempts = 5;
    let attempt = 1;
    let success = false;
    let nutritionData = null;
    let lastError = null;

    while (!success && attempt <= maxAttempts) {
        try {
            // Update loading message with retry attempt
            if (attempt > 1) {
                showMealAnalysisLoading(`Analyzing meal... (attempt ${attempt})`);
            }

            // Call Gemini API via edge function
            console.log(`Analyzing food photo (attempt ${attempt})...`);
            const response = await fetch('/.netlify/functions/analyze-food', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    imageBase64: base64Data,
                    mimeType: fileToAnalyze.type,
                    description: mealDescription
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error occurred' }));
                throw new Error(errorData.error || `Failed to analyze food photo (${response.status})`);
            }

            const result = await response.json();

            if (!result.success || !result.data) {
                throw new Error('Invalid response from analysis');
            }

            nutritionData = result.data;
            success = true;

        } catch (error) {
            console.error(`Error analyzing meal (attempt ${attempt}):`, error);
            lastError = error;

            // If not the last attempt, wait before retrying (exponential backoff)
            if (attempt < maxAttempts) {
                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000); // Max 10 seconds
                console.log(`Retrying in ${delay}ms...`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            attempt++;
        }
    }

    // Check if we failed after all attempts
    if (!success) {
        const errorDetails = lastError?.message || "Unknown error";
        showMealAnalysisError(`Failed after ${maxAttempts} attempts. Error: ${errorDetails}`);
        return;
    }

    // Success - save meal to database
    try {
        // Upload photo to Supabase Storage
        const photoUrl = await uploadMealPhoto(fileToAnalyze);

        // Save meal log to database
        const savedMeal = await saveMealLog({
            photoUrl,
            foodItems: nutritionData.foodItems,
            totals: nutritionData.totals,
            micronutrients: nutritionData.micronutrients,
            confidence: nutritionData.confidence,
            notes: nutritionData.notes
        });

        // Award points for the meal (with anti-cheat data)
        if (savedMeal && savedMeal[0]?.id) {
            try {
                // Get photo timestamp from file
                const photoTimestamp = fileToAnalyze.lastModified ? new Date(fileToAnalyze.lastModified).toISOString() : null;

                // Generate photo hash for duplicate detection
                const photoHash = await window.db?.points?.generatePhotoHash(base64);

                // Award points
                await awardPointsForMeal(
                    savedMeal[0].id,
                    photoTimestamp,
                    nutritionData.confidence,
                    photoHash
                );
            } catch (pointsError) {
                console.error('Error awarding points (meal still saved):', pointsError);
                // Don't throw - meal was saved successfully, points are bonus
            }
        }

        // Recalculate daily nutrition totals
        await recalculateDailyNutrition();

        // Refresh display
        await loadTodayNutrition();

        // Show success message
        showMealAnalysisSuccess(nutritionData);

    } catch (error) {
        console.error('Error saving meal:', error);
        showMealAnalysisError(error.message);
    }
}

// Handle meal photo selection
async function handleMealPhotoSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Show loading state
    showMealAnalysisLoading();

    // Convert to base64 once
    const base64 = await fileToBase64(file);
    const base64Data = base64.split(',')[1]; // Remove data:image/jpeg;base64, prefix

    // Retry logic - try up to 5 times
    const maxAttempts = 5;
    let attempt = 1;
    let success = false;
    let nutritionData = null;
    let lastError = null;

    while (!success && attempt <= maxAttempts) {
        try {
            // Update loading message with retry attempt
            if (attempt > 1) {
                showMealAnalysisLoading(`Analyzing meal... (attempt ${attempt})`);
            }

            // Call Gemini API via edge function
            console.log(`Analyzing food photo (attempt ${attempt})...`);
            const response = await fetch('/.netlify/functions/analyze-food', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    imageBase64: base64Data,
                    mimeType: file.type
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error occurred' }));
                throw new Error(errorData.error || `Failed to analyze food photo (${response.status})`);
            }

            const result = await response.json();

            if (!result.success || !result.data) {
                throw new Error('Invalid response from analysis');
            }

            nutritionData = result.data;
            success = true;
            console.log('Food analysis complete:', nutritionData);

        } catch (error) {
            console.error(`Error analyzing meal (attempt ${attempt}):`, error);
            lastError = error;

            // If not the last attempt, wait before retrying (exponential backoff)
            if (attempt < maxAttempts) {
                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000); // Max 10 seconds
                console.log(`Retrying in ${delay}ms...`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            attempt++;
        }
    }

    // Check if we failed after all attempts
    if (!success) {
        const errorDetails = lastError?.message || "Unknown error";
        showMealAnalysisError(`Failed after ${maxAttempts} attempts. Error: ${errorDetails}`);
        // Reset file input
        event.target.value = '';
        return;
    }

    // Success - save meal to database
    try {
        // Upload photo to Supabase Storage
        const photoUrl = await uploadMealPhoto(file);

        // Save meal log to database
        const savedMeal = await saveMealLog({
            photoUrl,
            foodItems: nutritionData.foodItems,
            totals: nutritionData.totals,
            micronutrients: nutritionData.micronutrients,
            confidence: nutritionData.confidence,
            notes: nutritionData.notes
        });

        // Award points for the meal (with anti-cheat data)
        if (savedMeal && savedMeal[0]?.id) {
            try {
                // Get photo timestamp from file
                const photoTimestamp = file.lastModified ? new Date(file.lastModified).toISOString() : null;

                // Generate photo hash for duplicate detection
                const photoHash = await window.db?.points?.generatePhotoHash(base64);

                // Award points
                await awardPointsForMeal(
                    savedMeal[0].id,
                    photoTimestamp,
                    nutritionData.confidence,
                    photoHash
                );
            } catch (pointsError) {
                console.error('Error awarding points (meal still saved):', pointsError);
                // Don't throw - meal was saved successfully, points are bonus
            }
        }

        // Recalculate daily nutrition totals
        await recalculateDailyNutrition();

        // Refresh display
        await loadTodayNutrition();

        // Show success message
        showMealAnalysisSuccess(nutritionData);

    } catch (error) {
        console.error('Error saving meal:', error);
        showMealAnalysisError(error.message);
    } finally {
        // Reset file input
        event.target.value = '';
    }
}

// Convert file to base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Upload meal photo to Backblaze B2
async function uploadMealPhoto(file) {
    const user = await window.supabaseClient.auth.getUser();
    const userId = user?.data?.user?.id;

    if (!userId) {
        throw new Error('User not authenticated');
    }

    // Create form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('userId', userId);

    // Upload to B2 via edge function
    const response = await fetch('/api/upload-meal-photo', {
        method: 'POST',
        body: formData
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to upload photo');
    }

    const data = await response.json();
    return data.url;
}

// Helper function to get local date in YYYY-MM-DD format
// This ensures the date is based on user's local timezone, not UTC
function getLocalDateString(date = new Date()) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Save meal log to database
async function saveMealLog(mealData) {
    const user = await window.supabaseClient.auth.getUser();
    const userId = user?.data?.user?.id;

    if (!userId) {
        throw new Error('User not authenticated');
    }

    const now = new Date();
    const mealDate = getLocalDateString(now);
    const mealTime = now.toTimeString().split(' ')[0];

    const { data, error } = await window.supabaseClient
        .from('meal_logs')
        .insert({
            user_id: userId,
            meal_date: mealDate,
            meal_time: mealTime,
            photo_url: mealData.photoUrl,
            storage_path: mealData.photoUrl,
            food_items: mealData.foodItems,
            calories: mealData.totals.calories,
            protein_g: mealData.totals.protein_g,
            carbs_g: mealData.totals.carbs_g,
            fat_g: mealData.totals.fat_g,
            fiber_g: mealData.totals.fiber_g,
            micronutrients: mealData.micronutrients,
            notes: mealData.notes,
            ai_confidence: mealData.confidence,
            analysis_timestamp: new Date().toISOString()
        })
        .select();

    if (error) {
        console.error('Error saving meal log:', error);
        throw error;
    }

    return data;
}

// Manually recalculate and update daily nutrition totals
async function recalculateDailyNutrition() {
    try {
        const user = await window.supabaseClient.auth.getUser();
        const userId = user?.data?.user?.id;

        if (!userId) {
            console.log('User not authenticated');
            return;
        }

        const today = getLocalDateString();

        console.log('Recalculating nutrition for user:', userId, 'date:', today);

        // Get all meals for today
        const { data: meals, error: mealsError } = await window.supabaseClient
            .from('meal_logs')
            .select('*')
            .eq('user_id', userId)
            .eq('meal_date', today);

        if (mealsError) {
            console.error('Error fetching meals for recalculation:', mealsError);
            return;
        }

        console.log('Found meals:', meals?.length || 0, meals);

        // Calculate totals
        const totals = {
            total_calories: 0,
            total_protein_g: 0,
            total_carbs_g: 0,
            total_fat_g: 0,
            total_fiber_g: 0,
            meal_count: 0
        };

        if (meals && meals.length > 0) {
            meals.forEach(meal => {
                totals.total_calories += parseFloat(meal.calories) || 0;
                totals.total_protein_g += parseFloat(meal.protein_g) || 0;
                totals.total_carbs_g += parseFloat(meal.carbs_g) || 0;
                totals.total_fat_g += parseFloat(meal.fat_g) || 0;
                totals.total_fiber_g += parseFloat(meal.fiber_g) || 0;
            });
            totals.meal_count = meals.length;
        }

        console.log('Calculated totals:', totals);

        // Get existing goals or use defaults
        const { data: existingData } = await window.supabaseClient
            .from('daily_nutrition')
            .select('calorie_goal, protein_goal_g, carbs_goal_g, fat_goal_g')
            .eq('user_id', userId)
            .eq('nutrition_date', today)
            .single();

        console.log('Existing goals:', existingData);

        // Prepare upsert data
        const upsertData = {
            user_id: userId,
            nutrition_date: today,
            total_calories: totals.total_calories,
            total_protein_g: totals.total_protein_g,
            total_carbs_g: totals.total_carbs_g,
            total_fat_g: totals.total_fat_g,
            total_fiber_g: totals.total_fiber_g,
            meal_count: totals.meal_count,
            // Preserve existing goals or use defaults
            calorie_goal: existingData?.calorie_goal || 2000,
            protein_goal_g: existingData?.protein_goal_g || 50,
            carbs_goal_g: existingData?.carbs_goal_g || 250,
            fat_goal_g: existingData?.fat_goal_g || 70
        };

        console.log('Upserting data:', upsertData);

        // Upsert into daily_nutrition
        const { data: upsertResult, error: upsertError } = await window.supabaseClient
            .from('daily_nutrition')
            .upsert(upsertData, { onConflict: 'user_id,nutrition_date' })
            .select();

        if (upsertError) {
            console.error('Error updating daily nutrition:', upsertError);
        } else {
            console.log('Daily nutrition updated successfully:', upsertResult);
        }

    } catch (error) {
        console.error('Error in recalculateDailyNutrition:', error);
    }
}

// Check if it's a new day and reset if needed
function checkAndResetNewDay() {
    const today = getLocalDateString();
    const lastDate = localStorage.getItem('lastCalorieTrackerDate');

    if (lastDate !== today) {
        console.log('New day detected, resetting calorie tracker data');
        localStorage.setItem('lastCalorieTrackerDate', today);
        // Clear any cached data
        return true;
    }
    return false;
}

// Load weekly metrics (last 7 days)
async function loadWeeklyMetrics(userId) {
    try {
        if (!userId) {
            console.log('User not authenticated');
            return;
        }

        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6); // Last 7 days including today

        const startDate = getLocalDateString(sevenDaysAgo);
        const endDate = getLocalDateString(today);

        console.log('Loading weekly metrics from', startDate, 'to', endDate);

        // Fetch last 7 days of nutrition data
        const { data: weeklyData, error: weeklyError } = await window.supabaseClient
            .from('daily_nutrition')
            .select('*')
            .eq('user_id', userId)
            .gte('nutrition_date', startDate)
            .lte('nutrition_date', endDate)
            .order('nutrition_date', { ascending: true });

        if (weeklyError) {
            console.error('Error loading weekly metrics:', weeklyError);
            return;
        }

        console.log('Weekly data loaded:', weeklyData);

        // Calculate weekly totals and averages
        let totalCalories = 0;
        let totalProtein = 0;
        let totalCarbs = 0;
        let totalFat = 0;
        let daysWithData = 0;

        if (weeklyData && weeklyData.length > 0) {
            weeklyData.forEach(day => {
                if (day.total_calories > 0) {
                    totalCalories += day.total_calories || 0;
                    totalProtein += day.total_protein_g || 0;
                    totalCarbs += day.total_carbs_g || 0;
                    totalFat += day.total_fat_g || 0;
                    daysWithData++;
                }
            });
        }

        const weeklyMetrics = {
            totalCalories: Math.round(totalCalories),
            avgCalories: daysWithData > 0 ? Math.round(totalCalories / daysWithData) : 0,
            totalProtein: Math.round(totalProtein),
            totalCarbs: Math.round(totalCarbs),
            totalFat: Math.round(totalFat),
            daysWithData,
            dailyData: weeklyData || []
        };

        console.log('Weekly metrics calculated:', weeklyMetrics);

        // Update weekly metrics UI
        updateWeeklyMetricsUI(weeklyMetrics);

    } catch (error) {
        console.error('Error in loadWeeklyMetrics:', error);
    }
}

// Load today's nutrition data
async function loadTodayNutrition() {
    try {
        // Check if it's a new day
        checkAndResetNewDay();

        const user = await window.supabaseClient.auth.getUser();
        const userId = user?.data?.user?.id;

        if (!userId) {
            console.log('User not authenticated');
            return;
        }

        const today = getLocalDateString();

        // Load daily nutrition summary
        const { data: dailyData, error: dailyError } = await window.supabaseClient
            .from('daily_nutrition')
            .select('*')
            .eq('user_id', userId)
            .eq('nutrition_date', today)
            .single();

        if (dailyError && dailyError.code !== 'PGRST116') { // PGRST116 is "not found"
            console.error('Error loading daily nutrition:', dailyError);
        }

        // Load individual meals
        const { data: mealsData, error: mealsError } = await window.supabaseClient
            .from('meal_logs')
            .select('*')
            .eq('user_id', userId)
            .eq('meal_date', today)
            .order('meal_time', { ascending: true });

        if (mealsError) {
            console.error('Error loading meals:', mealsError);
        }

        // Load weekly metrics
        await loadWeeklyMetrics(userId);

        // Update UI
        updateNutritionUI(dailyData, mealsData);

    } catch (error) {
        console.error('Error in loadTodayNutrition:', error);
    }
}

// Update weekly metrics UI
function updateWeeklyMetricsUI(metrics) {
    // Update total weekly calories
    updateElement('weekly-total-calories', metrics.totalCalories);
    updateElement('weekly-avg-calories', metrics.avgCalories);
    updateElement('weekly-days-logged', metrics.daysWithData);

    // Update daily breakdown if elements exist
    const dailyBreakdownContainer = document.getElementById('weekly-daily-breakdown');
    if (dailyBreakdownContainer && metrics.dailyData.length > 0) {
        let html = '';
        metrics.dailyData.forEach(day => {
            const date = new Date(day.nutrition_date);
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const calories = Math.round(day.total_calories || 0);
            const percentage = day.calorie_goal > 0 ? Math.min((calories / day.calorie_goal) * 100, 100) : 0;

            html += `
                <div class="weekly-day-item">
                    <div class="weekly-day-header">
                        <span class="weekly-day-name">${dayName}</span>
                        <span class="weekly-day-calories">${calories} cal</span>
                    </div>
                    <div class="progress-bar-small">
                        <div class="progress-fill" style="width: ${percentage}%; background: var(--primary);"></div>
                    </div>
                </div>
            `;
        });
        dailyBreakdownContainer.innerHTML = html;
    }
}

// Update nutrition UI with data
function updateNutritionUI(dailyData, mealsData) {
    const defaults = {
        total_calories: 0,
        total_protein_g: 0,
        total_carbs_g: 0,
        total_fat_g: 0,
        total_fiber_g: 0,
        calorie_goal: 2000,
        protein_goal_g: 50,
        carbs_goal_g: 250,
        fat_goal_g: 70
    };

    const data = dailyData || defaults;

    // Update widget (dashboard)
    updateElement('widget-calories-current', Math.round(data.total_calories || 0));
    updateElement('widget-calories-goal', data.calorie_goal || 2000);
    updateElement('widget-protein', Math.round(data.total_protein_g || 0));
    updateElement('widget-protein-goal', data.protein_goal_g || 50);
    updateElement('widget-carbs', Math.round(data.total_carbs_g || 0));
    updateElement('widget-carbs-goal', data.carbs_goal_g || 250);
    updateElement('widget-fat', Math.round(data.total_fat_g || 0));
    updateElement('widget-fat-goal', data.fat_goal_g || 70);

    // Update progress bars (widget)
    updateProgressBar('widget-calories-bar', data.total_calories, data.calorie_goal);
    updateProgressBar('widget-protein-bar', data.total_protein_g, data.protein_goal_g);
    updateProgressBar('widget-carbs-bar', data.total_carbs_g, data.carbs_goal_g);
    updateProgressBar('widget-fat-bar', data.total_fat_g, data.fat_goal_g);

    // Update tracker (full view)
    updateElement('tracker-calories-current', Math.round(data.total_calories || 0));
    updateElement('tracker-calories-goal', data.calorie_goal || 2000);
    updateElement('tracker-protein', Math.round(data.total_protein_g || 0));
    updateElement('tracker-protein-goal', data.protein_goal_g || 50);
    updateElement('tracker-carbs', Math.round(data.total_carbs_g || 0));
    updateElement('tracker-carbs-goal', data.carbs_goal_g || 250);
    updateElement('tracker-fat', Math.round(data.total_fat_g || 0));
    updateElement('tracker-fat-goal', data.fat_goal_g || 70);
    updateElement('tracker-fiber', Math.round(data.total_fiber_g || 0));
    updateElement('tracker-fiber-goal', 25);

    // Update progress bars (tracker)
    updateProgressBar('tracker-protein-bar', data.total_protein_g, data.protein_goal_g);
    updateProgressBar('tracker-carbs-bar', data.total_carbs_g, data.carbs_goal_g);
    updateProgressBar('tracker-fat-bar', data.total_fat_g, data.fat_goal_g);
    updateProgressBar('tracker-fiber-bar', data.total_fiber_g, 25);

    // Update circular progress
    updateCircularProgress(data.total_calories, data.calorie_goal);

    // Update meals list
    if (mealsData && mealsData.length > 0) {
        renderMealsList(mealsData);
    }
}

// Helper function to update element text
function updateElement(id, value) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = value;
    }
}

// Helper function to update progress bar
function updateProgressBar(id, current, goal) {
    const el = document.getElementById(id);
    if (el && goal > 0) {
        const percent = Math.min((current / goal) * 100, 100);
        el.style.width = percent + '%';
    }
}

// Update circular progress (for calorie circle)
function updateCircularProgress(current, goal) {
    const circle = document.getElementById('calorie-circle-progress');
    if (circle && goal > 0) {
        const percent = Math.min(current / goal, 1);
        const circumference = 2 * Math.PI * 90; // radius is 90
        const offset = circumference * (1 - percent);
        circle.style.strokeDashoffset = offset;
    }
}

// Render meals list
function renderMealsList(meals) {
    const container = document.getElementById('meals-log-list');
    if (!container) return;

    if (!meals || meals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                    📸 No meals logged yet today.<br>
                    <span style="font-size: 0.9rem;">Take a photo of your meal to get started!</span>
                </p>
            </div>
        `;
        return;
    }

    let html = '';
    meals.forEach(meal => {
        const time = new Date(`2000-01-01T${meal.meal_time}`).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });

        const foodItemsText = Array.isArray(meal.food_items)
            ? meal.food_items.map(item => item.name).join(', ')
            : 'Food';

        html += `
            <div class="meal-log-card">
                <div class="meal-log-image" style="background-image: url('${meal.photo_url}')"></div>
                <div class="meal-log-content">
                    <div class="meal-log-time">${time}</div>
                    <div class="meal-log-foods">${foodItemsText}</div>
                    <div class="meal-log-macros">
                        <span>${Math.round(meal.calories)} cal</span>
                        <span>P: ${Math.round(meal.protein_g)}g</span>
                        <span>C: ${Math.round(meal.carbs_g)}g</span>
                        <span>F: ${Math.round(meal.fat_g)}g</span>
                    </div>
                </div>
                <button class="meal-log-delete" onclick="deleteMealLog('${meal.id}')" title="Delete meal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        `;
    });

    container.innerHTML = html;
}

// Delete meal log
async function deleteMealLog(mealId) {
    if (!confirm('Are you sure you want to delete this meal?')) {
        return;
    }

    try {
        const { error } = await window.supabaseClient
            .from('meal_logs')
            .delete()
            .eq('id', mealId);

        if (error) {
            console.error('Error deleting meal:', error);
            alert('Failed to delete meal. Please try again.');
            return;
        }

        // Recalculate daily nutrition totals
        await recalculateDailyNutrition();

        // Reload data
        await loadTodayNutrition();
    } catch (error) {
        console.error('Error deleting meal:', error);
        alert('Failed to delete meal. Please try again.');
    }
}

// Show loading state
function showMealAnalysisLoading(message = 'Analyzing meal...') {
    // Could add a modal or toast here
    console.log(message);
    if (typeof showToast === 'function') {
        showToast(message, 'info');
    }
}

// Show success message
function showMealAnalysisSuccess(data) {
    const message = `Meal logged! ${Math.round(data.totals.calories)} calories added.`;

    // Simple alert for now - could be replaced with a toast notification
    if (typeof showToast === 'function') {
        showToast(message, 'success');
    } else {
        console.log(message);
    }
}

// Show error message
function showMealAnalysisError(message) {
    const errorMsg = `Failed to analyze meal: ${message}`;

    // Simple alert for now - could be replaced with a toast notification
    if (typeof showToast === 'function') {
        showToast(errorMsg, 'error');
    } else {
        alert(errorMsg);
    }
}

// Initialize calorie tracker when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Initialize the last date tracker
    const today = getLocalDateString();
    if (!localStorage.getItem('lastCalorieTrackerDate')) {
        localStorage.setItem('lastCalorieTrackerDate', today);
    }

    // Load nutrition data after a short delay to ensure auth is ready
    setTimeout(async () => {
        // Check for daily reset
        checkAndResetNewDay();
        // Recalculate to ensure data is in sync
        await recalculateDailyNutrition();
        // Then load and display
        loadTodayNutrition();
    }, 1000);
});

</script>

<script>
// ==========================================
// SERVICE WORKER MESSAGE HANDLER
// ==========================================
// Listen for messages from service worker (e.g., notification clicks)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'open_approval_modal') {
            // Open the approval modal
            window.openApprovalModal();
        }
    });
}

// Check URL parameters for approval modal trigger
window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('openApproval') === 'true') {
        // Wait a bit for everything to load, then open approval modal
        setTimeout(() => {
            window.openApprovalModal();
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 1000);
    }
});
</script>

<!-- ========================================== -->
<!-- APPROVAL MODAL -->
<!-- ========================================== -->
<div id="approval-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <!-- Header -->
        <div style="padding: 24px; border-bottom: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 1.5rem; color: #1e293b;">Approve Coach Response</h2>
                <button onclick="closeApprovalModal()" style="background: none; border: none; font-size: 1.5rem; color: #64748b; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
        </div>

        <!-- Content -->
        <div style="padding: 24px;">
            <!-- User Info -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">User:</label>
                <div id="approval-user-name" style="padding: 12px; background: #f1f5f9; border-radius: 8px; color: #1e293b;"></div>
            </div>

            <!-- User Message -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">User Message:</label>
                <div id="approval-user-message" style="padding: 12px; background: #f1f5f9; border-radius: 8px; color: #1e293b; white-space: pre-wrap;"></div>
            </div>

            <!-- AI Response (Editable) -->
            <div style="margin-bottom: 24px;">
                <label for="approval-response-text" style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">AI Response (Editable):</label>
                <textarea id="approval-response-text" style="width: 100%; min-height: 200px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 1rem; resize: vertical; box-sizing: border-box;" placeholder="AI response will appear here..."></textarea>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="rejectResponse()" style="padding: 12px 24px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Reject
                </button>
                <button onclick="approveResponse()" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Approve & Send
                </button>
            </div>
        </div>
    </div>
</div>

</body>
</html>



