<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Screen Time - Balance</title>
<meta name="description" content="Track your daily phone usage and screen time habits">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet"/>
<link href="manifest.json" rel="manifest"/>

<!-- Supabase & Auth -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="lib/supabase.js?v=3"></script>
<script src="lib/auth-guard.js?v=3"></script>

<!-- Chart.js for trend graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root {
    --primary: #7BA883;
    --primary-light: #98C9A3;
    --secondary: #E8D68E;
    --accent-green: #f2f7f4;
    --bg: #f9f9f7;
    --surface: #ffffff;
    --text-main: #1a202c;
    --text-muted: #718096;
    --border: #e2e8f0;
    --radius: 16px;
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -1px rgba(0,0,0,0.04);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text-main);
    min-height: 100vh;
    padding-bottom: env(safe-area-inset-bottom);
    -webkit-font-smoothing: antialiased;
}

/* â”€â”€ Header â”€â”€ */
.page-header {
    position: sticky;
    top: 0;
    background: white;
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 100;
    padding-top: calc(16px + env(safe-area-inset-top));
}

.back-btn {
    width: 36px; height: 36px;
    background: var(--accent-green);
    border: none;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
}

.back-btn svg { fill: var(--primary); }

.page-header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    color: var(--primary);
    flex: 1;
}

/* â”€â”€ Cards â”€â”€ */
.card {
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    margin: 0 16px 16px;
    overflow: hidden;
}

.card-header {
    padding: 16px 20px 12px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-header h2 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-main);
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-body { padding: 20px; }

/* â”€â”€ Today summary pill â”€â”€ */
.today-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--accent-green);
    color: var(--primary);
    font-weight: 700;
    font-size: 0.85rem;
    padding: 6px 12px;
    border-radius: 20px;
}

/* â”€â”€ Big screen-time display â”€â”€ */
.screen-time-hero {
    text-align: center;
    padding: 28px 20px 20px;
}

.screen-time-hero .time-value {
    font-family: 'Playfair Display', serif;
    font-size: 3.5rem;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
}

.screen-time-hero .time-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 6px;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    padding: 0 20px 20px;
}

.stat-box {
    text-align: center;
    background: var(--accent-green);
    border-radius: 12px;
    padding: 12px 8px;
}

.stat-box .stat-val {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary);
}

.stat-box .stat-lbl {
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-top: 3px;
}

/* â”€â”€ Form â”€â”€ */
.form-group {
    margin-bottom: 18px;
}

.form-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 6px;
}

.form-hint {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 6px;
}

.form-row {
    display: flex;
    gap: 10px;
}

.form-row .form-group {
    flex: 1;
}

input[type="number"],
input[type="time"],
input[type="text"],
select,
textarea {
    width: 100%;
    padding: 12px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 0.95rem;
    color: var(--text-main);
    background: white;
    outline: none;
    transition: border-color 0.2s;
    -webkit-appearance: none;
}

input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
}

textarea { resize: vertical; min-height: 80px; }

/* â”€â”€ App breakdown rows â”€â”€ */
.app-row {
    display: grid;
    grid-template-columns: 1fr auto 90px 36px;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
}

.app-row select { font-size: 0.82rem; padding: 10px 8px; }

.remove-app-btn {
    width: 32px; height: 32px;
    background: #fee2e2;
    color: #ef4444;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem;
    line-height: 1;
    flex-shrink: 0;
}

.add-app-btn {
    width: 100%;
    padding: 10px;
    border: 1.5px dashed var(--primary);
    background: transparent;
    color: var(--primary);
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    margin-top: 4px;
}

/* â”€â”€ Primary button â”€â”€ */
.btn-primary {
    width: 100%;
    padding: 15px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: opacity 0.2s;
}

.btn-primary:active { opacity: 0.85; }
.btn-primary:disabled { opacity: 0.5; cursor: default; }

.btn-secondary {
    width: 100%;
    padding: 12px;
    background: transparent;
    color: var(--primary);
    border: 1.5px solid var(--primary);
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    margin-top: 10px;
}

/* â”€â”€ Category bar chart (app breakdown) â”€â”€ */
.category-bar {
    margin-bottom: 14px;
}

.category-bar-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.82rem;
    margin-bottom: 5px;
}

.category-bar-label span:first-child { font-weight: 600; }
.category-bar-label span:last-child { color: var(--text-muted); }

.category-bar-track {
    height: 8px;
    background: #f1f5f9;
    border-radius: 4px;
    overflow: hidden;
}

.category-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.6s ease;
}

/* â”€â”€ Info banner â”€â”€ */
.info-banner {
    background: linear-gradient(135deg, var(--accent-green), #e8f5e9);
    border: 1px solid var(--primary-light);
    border-radius: var(--radius);
    margin: 0 16px 16px;
    padding: 16px 20px;
}

.info-banner h3 {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.info-banner ol {
    padding-left: 18px;
    color: var(--text-main);
    font-size: 0.85rem;
    line-height: 1.8;
}

.platform-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
}

.platform-tab {
    flex: 1;
    padding: 8px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: white;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    color: var(--text-muted);
    transition: all 0.2s;
}

.platform-tab.active {
    border-color: var(--primary);
    color: var(--primary);
    background: var(--accent-green);
}

.platform-content { display: none; }
.platform-content.active { display: block; }

/* â”€â”€ Toast â”€â”€ */
.toast {
    position: fixed;
    bottom: calc(20px + env(safe-area-inset-bottom));
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--text-main);
    color: white;
    padding: 14px 24px;
    border-radius: 30px;
    font-weight: 600;
    font-size: 0.9rem;
    z-index: 9999;
    transition: transform 0.3s ease;
    white-space: nowrap;
    max-width: 90vw;
    text-align: center;
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* â”€â”€ Loading â”€â”€ */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9998;
    flex-direction: column;
    gap: 16px;
}

.spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.page-content { padding-top: 16px; display: none; }

/* â”€â”€ Section spacing â”€â”€ */
.section-top { padding-top: 24px; }

/* â”€â”€ Empty state â”€â”€ */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 12px; }
.empty-state p { font-size: 0.9rem; line-height: 1.5; }

/* â”€â”€ Chart container â”€â”€ */
.chart-container {
    position: relative;
    height: 180px;
    padding: 0 4px;
}

/* â”€â”€ Edit button â”€â”€ */
.edit-btn {
    padding: 6px 14px;
    background: var(--accent-green);
    color: var(--primary);
    border: none;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.8rem;
    cursor: pointer;
}

/* â”€â”€ Average badge â”€â”€ */
.avg-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: #fef9e7;
    border: 1px solid #f6d860;
    color: #b7790f;
    font-size: 0.78rem;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
}

@media (max-width: 360px) {
    .app-row { grid-template-columns: 1fr 70px 28px; }
    .app-row .app-category-select { display: none; }
}
</style>
</head>
<body>

<div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <div style="font-size:0.9rem; color:var(--text-muted);">Loading...</div>
</div>

<!-- â”€â”€ HEADER â”€â”€ -->
<header class="page-header">
    <button class="back-btn" onclick="history.back()">
        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </button>
    <h1>Screen Time</h1>
    <div id="header-date" style="font-size:0.8rem; color:var(--text-muted); white-space:nowrap;"></div>
</header>

<!-- â”€â”€ PAGE CONTENT â”€â”€ -->
<div class="page-content" id="page-content">

    <!-- â”€â”€ TODAY CARD â”€â”€ -->
    <div class="card" id="today-card">
        <div class="card-header">
            <h2>
                <svg viewBox="0 0 24 24" width="18" height="18" style="fill:var(--primary)"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg>
                Today
            </h2>
            <button class="edit-btn" id="edit-today-btn" onclick="showForm()" style="display:none;">Edit</button>
        </div>
        <div id="today-summary">
            <!-- populated by JS -->
        </div>
    </div>

    <!-- â”€â”€ LOG FORM (hidden until user taps Log) â”€â”€ -->
    <div class="card" id="log-form-card" style="display:none;">
        <div class="card-header">
            <h2 id="form-title">
                <svg viewBox="0 0 24 24" width="18" height="18" style="fill:var(--primary)"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                Log Today's Screen Time
            </h2>
            <button onclick="hideForm()" style="background:transparent; border:none; font-size:1.3rem; color:var(--text-muted); cursor:pointer; padding:4px;">&#x2715;</button>
        </div>
        <div class="card-body">
            <!-- Total screen time -->
            <div class="form-group">
                <label class="form-label">Total Screen Time</label>
                <div class="form-row">
                    <div class="form-group" style="margin-bottom:0;">
                        <input type="number" id="input-hours" placeholder="0" min="0" max="24" inputmode="numeric">
                        <div class="form-hint" style="margin-top:4px;">hours</div>
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <input type="number" id="input-minutes" placeholder="0" min="0" max="59" inputmode="numeric">
                        <div class="form-hint" style="margin-top:4px;">minutes</div>
                    </div>
                </div>
            </div>

            <!-- Pickups & notifications -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Pickups</label>
                    <input type="number" id="input-pickups" placeholder="e.g. 52" min="0" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label">Notifications</label>
                    <input type="number" id="input-notifications" placeholder="e.g. 89" min="0" inputmode="numeric">
                </div>
            </div>

            <!-- First pickup -->
            <div class="form-group">
                <label class="form-label">First Pickup Time <span style="font-weight:400; color:var(--text-muted);">(optional)</span></label>
                <input type="time" id="input-first-pickup">
            </div>

            <!-- App breakdown -->
            <div class="form-group">
                <label class="form-label">App Breakdown <span style="font-weight:400; color:var(--text-muted);">(optional, up to 5)</span></label>
                <div class="form-hint">Add your most-used apps from your Screen Time / Digital Wellbeing report</div>
                <div id="app-rows"></div>
                <button class="add-app-btn" onclick="addAppRow()" id="add-app-btn">+ Add an app</button>
            </div>

            <!-- Notes -->
            <div class="form-group">
                <label class="form-label">Notes <span style="font-weight:400; color:var(--text-muted);">(optional)</span></label>
                <textarea id="input-notes" placeholder="e.g. Mostly scrolling before bed, no social media after 9pm..."></textarea>
            </div>

            <button class="btn-primary" onclick="saveUsageLog()" id="save-btn">Save</button>
            <button class="btn-secondary" onclick="hideForm()">Cancel</button>
        </div>
    </div>

    <!-- â”€â”€ 30-DAY TREND CHART â”€â”€ -->
    <div class="card section-top" id="trend-card" style="margin-top:0;">
        <div class="card-header">
            <h2>
                <svg viewBox="0 0 24 24" width="18" height="18" style="fill:var(--primary)"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
                30-Day Trend
            </h2>
            <div class="avg-badge" id="avg-badge" style="display:none;">
                Avg <span id="avg-display"></span>
            </div>
        </div>
        <div class="card-body" style="padding-bottom: 12px;">
            <div class="chart-container">
                <canvas id="trend-chart"></canvas>
            </div>
            <div id="trend-empty" class="empty-state" style="display:none; padding: 30px 20px;">
                <div class="empty-icon">ðŸ“Š</div>
                <p>No data yet. Log your first day to see trends here.</p>
            </div>
        </div>
    </div>

    <!-- â”€â”€ APP CATEGORY BREAKDOWN (today) â”€â”€ -->
    <div class="card" id="breakdown-card" style="display:none;">
        <div class="card-header">
            <h2>
                <svg viewBox="0 0 24 24" width="18" height="18" style="fill:var(--primary)"><path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/></svg>
                Today's Category Breakdown
            </h2>
        </div>
        <div class="card-body" id="breakdown-body">
            <!-- populated by JS -->
        </div>
    </div>

    <!-- â”€â”€ ALL-TIME STATS â”€â”€ -->
    <div class="card" id="stats-card" style="display:none;">
        <div class="card-header">
            <h2>
                <svg viewBox="0 0 24 24" width="18" height="18" style="fill:var(--primary)"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                Your Stats
            </h2>
        </div>
        <div class="stats-row" id="stats-grid" style="padding: 20px;">
            <!-- populated by JS -->
        </div>
    </div>

    <!-- â”€â”€ HOW TO FIND YOUR DATA â”€â”€ -->
    <div class="info-banner">
        <h3>
            <svg viewBox="0 0 24 24" width="18" height="18" style="fill:var(--primary)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
            Where to find your screen time data
        </h3>

        <div class="platform-tabs">
            <button class="platform-tab active" onclick="switchPlatform('ios', this)">iPhone (iOS)</button>
            <button class="platform-tab" onclick="switchPlatform('android', this)">Android</button>
        </div>

        <div class="platform-content active" id="platform-ios">
            <ol>
                <li>Open the <strong>Settings</strong> app</li>
                <li>Tap <strong>Screen Time</strong></li>
                <li>Tap on today's bar in the chart at the top</li>
                <li>You'll see your total time and a breakdown by app</li>
            </ol>
            <p style="margin-top:10px; font-size:0.8rem; color:var(--text-muted);">
                Note: Apple doesn't let third-party apps read Screen Time data automatically â€” you'll need to enter it manually here.
            </p>
        </div>

        <div class="platform-content" id="platform-android">
            <ol>
                <li>Open <strong>Settings</strong></li>
                <li>Tap <strong>Digital Wellbeing &amp; Parental Controls</strong> (or <strong>Screen Time</strong> on some devices)</li>
                <li>Tap <strong>Dashboard</strong> to see your daily usage</li>
                <li>Tap any app to see its individual time</li>
            </ol>
            <p style="margin-top:10px; font-size:0.8rem; color:var(--text-muted);">
                Android auto-sync is on the roadmap â€” for now, log it manually each day.
            </p>
        </div>
    </div>

    <div style="height: 32px;"></div>
</div>

<!-- â”€â”€ TOAST â”€â”€ -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GLOBALS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = null;
let todayLog = null;
let allLogs = [];
let appRowCount = 0;
let trendChart = null;
let isEditing = false;

const CATEGORY_COLORS = {
    social:          '#7BA883',
    entertainment:   '#E8A87C',
    productivity:    '#7BAEC3',
    health:          '#A8D5A2',
    communication:   '#9B8EC4',
    games:           '#E8D68E',
    other:           '#B0BEC5',
};

const CATEGORY_LABELS = {
    social:          'Social Media',
    entertainment:   'Entertainment',
    productivity:    'Productivity',
    health:          'Health & Fitness',
    communication:   'Communication',
    games:           'Games',
    other:           'Other',
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', async () => {
    // Set header date
    const now = new Date();
    document.getElementById('header-date').textContent = now.toLocaleDateString('en-AU', {
        weekday: 'short', day: 'numeric', month: 'short'
    });

    // Wait for auth
    try {
        currentUser = await getCurrentUser();
        if (!currentUser) {
            window.location.href = 'login.html';
            return;
        }
    } catch (e) {
        window.location.href = 'login.html';
        return;
    }

    await loadData();

    document.getElementById('loading-overlay').style.display = 'none';
    document.getElementById('page-content').style.display = 'block';
});

async function getCurrentUser() {
    const { data: { user } } = await window.supabaseClient.auth.getUser();
    return user;
}

async function loadData() {
    const todayStr = getTodayStr();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 29);
    const fromStr = thirtyDaysAgo.toISOString().split('T')[0];

    const { data, error } = await window.supabaseClient
        .from('phone_usage_logs')
        .select('*')
        .eq('user_id', currentUser.id)
        .gte('log_date', fromStr)
        .order('log_date', { ascending: false });

    if (error) {
        console.error('Error loading phone usage:', error);
        allLogs = [];
    } else {
        allLogs = data || [];
    }

    todayLog = allLogs.find(l => l.log_date === todayStr) || null;

    renderTodayCard();
    renderTrendChart();
    renderStatsCard();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TODAY CARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTodayCard() {
    const container = document.getElementById('today-summary');
    const editBtn = document.getElementById('edit-today-btn');

    if (!todayLog) {
        editBtn.style.display = 'none';
        container.innerHTML = `
            <div class="empty-state" style="padding: 30px 20px;">
                <div class="empty-icon">ðŸ“±</div>
                <p style="margin-bottom:16px;">No screen time logged for today yet.</p>
                <button class="btn-primary" style="max-width:260px; margin:0 auto; display:block;" onclick="showForm()">
                    Log Today's Screen Time
                </button>
            </div>
        `;
    } else {
        editBtn.style.display = 'block';
        const h = Math.floor(todayLog.total_screen_time_minutes / 60);
        const m = todayLog.total_screen_time_minutes % 60;
        const timeStr = h > 0 ? `${h}h ${m}m` : `${m}m`;

        container.innerHTML = `
            <div class="screen-time-hero">
                <div class="time-value">${timeStr}</div>
                <div class="time-label">Screen time today</div>
            </div>
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-val">${todayLog.pickups ?? 'â€”'}</div>
                    <div class="stat-lbl">Pickups</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val">${todayLog.notifications_received ?? 'â€”'}</div>
                    <div class="stat-lbl">Notifications</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val">${todayLog.first_pickup_time ? todayLog.first_pickup_time.slice(0,5) : 'â€”'}</div>
                    <div class="stat-lbl">First pickup</div>
                </div>
            </div>
        `;

        renderBreakdownCard(todayLog);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BREAKDOWN CARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBreakdownCard(log) {
    const apps = log.app_usage || [];
    if (!apps.length) {
        document.getElementById('breakdown-card').style.display = 'none';
        return;
    }

    document.getElementById('breakdown-card').style.display = 'block';
    const totalMins = log.total_screen_time_minutes || 1;

    // Aggregate by category
    const byCat = {};
    apps.forEach(a => {
        const cat = a.category || 'other';
        byCat[cat] = (byCat[cat] || 0) + (a.minutes || 0);
    });

    const sorted = Object.entries(byCat).sort((a, b) => b[1] - a[1]);

    const body = document.getElementById('breakdown-body');
    body.innerHTML = '';

    // Per-app list first
    const sortedApps = [...apps].sort((a, b) => (b.minutes || 0) - (a.minutes || 0));
    let appsHtml = `<div style="margin-bottom:16px;">`;
    sortedApps.forEach(app => {
        const pct = Math.round((app.minutes / totalMins) * 100);
        const color = CATEGORY_COLORS[app.category] || CATEGORY_COLORS.other;
        appsHtml += `
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <div style="width:32px; height:32px; background:${color}22; border-radius:8px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                    <div style="width:12px; height:12px; background:${color}; border-radius:3px;"></div>
                </div>
                <div style="flex:1; min-width:0;">
                    <div style="font-weight:600; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escHtml(app.app_name)}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">${CATEGORY_LABELS[app.category] || 'Other'}</div>
                </div>
                <div style="text-align:right; flex-shrink:0;">
                    <div style="font-weight:700; font-size:0.9rem; color:var(--primary);">${formatMins(app.minutes)}</div>
                    <div style="font-size:0.72rem; color:var(--text-muted);">${pct}%</div>
                </div>
            </div>
        `;
    });
    appsHtml += `</div>`;

    // Category bars
    let catHtml = `<div style="border-top:1px solid #f1f5f9; padding-top:16px;">
        <div style="font-size:0.8rem; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:12px;">By Category</div>`;
    sorted.forEach(([cat, mins]) => {
        const pct = Math.round((mins / totalMins) * 100);
        const color = CATEGORY_COLORS[cat] || CATEGORY_COLORS.other;
        catHtml += `
            <div class="category-bar">
                <div class="category-bar-label">
                    <span>${CATEGORY_LABELS[cat] || cat}</span>
                    <span>${formatMins(mins)} (${pct}%)</span>
                </div>
                <div class="category-bar-track">
                    <div class="category-bar-fill" style="width:${pct}%; background:${color};"></div>
                </div>
            </div>
        `;
    });
    catHtml += `</div>`;

    body.innerHTML = appsHtml + catHtml;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TREND CHART
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTrendChart() {
    const trendEmpty = document.getElementById('trend-empty');
    const chartCanvas = document.getElementById('trend-chart');

    if (!allLogs.length) {
        chartCanvas.style.display = 'none';
        trendEmpty.style.display = 'block';
        document.getElementById('avg-badge').style.display = 'none';
        return;
    }

    chartCanvas.style.display = 'block';
    trendEmpty.style.display = 'none';

    // Build 30-day slots
    const slots = [];
    const today = new Date();
    for (let i = 29; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const log = allLogs.find(l => l.log_date === dateStr);
        slots.push({
            label: d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' }),
            shortLabel: d.getDate() % 5 === 0 ? d.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' }) : '',
            value: log ? log.total_screen_time_minutes : null,
        });
    }

    const labels = slots.map(s => s.shortLabel);
    const values = slots.map(s => s.value !== null ? +(s.value / 60).toFixed(2) : null);
    const fullLabels = slots.map(s => s.label);

    // Average
    const recorded = slots.filter(s => s.value !== null);
    if (recorded.length) {
        const avgMins = Math.round(recorded.reduce((sum, s) => sum + s.value, 0) / recorded.length);
        document.getElementById('avg-badge').style.display = 'inline-flex';
        document.getElementById('avg-display').textContent = formatMins(avgMins);
    }

    if (trendChart) {
        trendChart.destroy();
        trendChart = null;
    }

    trendChart = new Chart(chartCanvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Screen time (hours)',
                data: values,
                backgroundColor: values.map((v, i) =>
                    slots[i].label === new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })
                        ? '#7BA883'
                        : '#7BA88388'
                ),
                borderRadius: 5,
                borderSkipped: false,
                spanGaps: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: (items) => fullLabels[items[0].dataIndex],
                        label: (item) => {
                            if (item.raw === null) return 'Not logged';
                            const mins = Math.round(item.raw * 60);
                            return `  ${formatMins(mins)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 10 }, maxRotation: 0 },
                },
                y: {
                    beginAtZero: true,
                    grid: { color: '#f1f5f9' },
                    ticks: {
                        font: { size: 10 },
                        callback: (v) => v + 'h',
                        maxTicksLimit: 5,
                    }
                }
            }
        }
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS CARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStatsCard() {
    if (!allLogs.length) {
        document.getElementById('stats-card').style.display = 'none';
        return;
    }

    document.getElementById('stats-card').style.display = 'block';
    const grid = document.getElementById('stats-grid');

    const totalDays = allLogs.length;
    const avgMins = Math.round(allLogs.reduce((s, l) => s + l.total_screen_time_minutes, 0) / totalDays);
    const bestDay = allLogs.reduce((best, l) =>
        l.total_screen_time_minutes < best.total_screen_time_minutes ? l : best, allLogs[0]);

    grid.innerHTML = `
        <div class="stat-box">
            <div class="stat-val">${formatMins(avgMins)}</div>
            <div class="stat-lbl">Daily Avg</div>
        </div>
        <div class="stat-box">
            <div class="stat-val">${totalDays}</div>
            <div class="stat-lbl">Days Logged</div>
        </div>
        <div class="stat-box">
            <div class="stat-val">${formatMins(bestDay.total_screen_time_minutes)}</div>
            <div class="stat-lbl">Best Day</div>
        </div>
    `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FORM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showForm() {
    isEditing = !!todayLog;
    document.getElementById('form-title').innerHTML = isEditing
        ? `<svg viewBox="0 0 24 24" width="18" height="18" style="fill:var(--primary)"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Edit Today's Log`
        : `<svg viewBox="0 0 24 24" width="18" height="18" style="fill:var(--primary)"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Log Today's Screen Time`;

    // Pre-fill if editing
    if (todayLog) {
        const h = Math.floor(todayLog.total_screen_time_minutes / 60);
        const m = todayLog.total_screen_time_minutes % 60;
        document.getElementById('input-hours').value = h;
        document.getElementById('input-minutes').value = m;
        document.getElementById('input-pickups').value = todayLog.pickups ?? '';
        document.getElementById('input-notifications').value = todayLog.notifications_received ?? '';
        document.getElementById('input-first-pickup').value = todayLog.first_pickup_time ? todayLog.first_pickup_time.slice(0,5) : '';
        document.getElementById('input-notes').value = todayLog.notes ?? '';

        // Rebuild app rows
        document.getElementById('app-rows').innerHTML = '';
        appRowCount = 0;
        const apps = todayLog.app_usage || [];
        apps.forEach(a => addAppRow(a));
    } else {
        clearForm();
    }

    document.getElementById('log-form-card').style.display = 'block';
    document.getElementById('log-form-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hideForm() {
    document.getElementById('log-form-card').style.display = 'none';
    clearForm();
}

function clearForm() {
    ['input-hours','input-minutes','input-pickups','input-notifications','input-first-pickup','input-notes']
        .forEach(id => { document.getElementById(id).value = ''; });
    document.getElementById('app-rows').innerHTML = '';
    appRowCount = 0;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// APP ROWS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addAppRow(prefill) {
    if (appRowCount >= 5) {
        showToast('Maximum 5 apps');
        return;
    }

    const id = appRowCount++;
    const row = document.createElement('div');
    row.className = 'app-row';
    row.id = `app-row-${id}`;

    const cats = ['social','entertainment','productivity','health','communication','games','other'];
    const catOptions = cats.map(c =>
        `<option value="${c}" ${prefill?.category === c ? 'selected' : ''}>${CATEGORY_LABELS[c]}</option>`
    ).join('');

    row.innerHTML = `
        <input type="text" placeholder="App name" value="${escHtml(prefill?.app_name || '')}"
            class="app-name-input" data-row="${id}" style="font-size:0.88rem; padding:10px 10px;">
        <select class="app-category-select" data-row="${id}" style="min-width:110px;">${catOptions}</select>
        <input type="number" placeholder="mins" min="0" value="${prefill?.minutes ?? ''}"
            class="app-mins-input" data-row="${id}" inputmode="numeric" style="font-size:0.88rem; padding:10px 8px;">
        <button class="remove-app-btn" onclick="removeAppRow(${id})">&#x2715;</button>
    `;

    document.getElementById('app-rows').appendChild(row);

    if (appRowCount >= 5) {
        document.getElementById('add-app-btn').style.display = 'none';
    }
}

function removeAppRow(id) {
    const row = document.getElementById(`app-row-${id}`);
    if (row) row.remove();
    appRowCount--;
    document.getElementById('add-app-btn').style.display = 'block';
}

function collectAppRows() {
    const apps = [];
    document.querySelectorAll('[data-row]').forEach(el => {
        const rowId = el.dataset.row;
        if (!apps[rowId]) apps[rowId] = {};
        if (el.classList.contains('app-name-input')) apps[rowId].app_name = el.value.trim();
        if (el.classList.contains('app-category-select')) apps[rowId].category = el.value;
        if (el.classList.contains('app-mins-input')) apps[rowId].minutes = parseInt(el.value) || 0;
    });

    return Object.values(apps).filter(a => a.app_name);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SAVE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveUsageLog() {
    const hours = parseInt(document.getElementById('input-hours').value) || 0;
    const mins = parseInt(document.getElementById('input-minutes').value) || 0;
    const totalMins = hours * 60 + mins;

    if (totalMins <= 0) {
        showToast('Please enter your screen time');
        return;
    }
    if (totalMins > 1440) {
        showToast("That's more than 24 hours â€” double-check your entry");
        return;
    }

    const saveBtn = document.getElementById('save-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    const pickups = parseInt(document.getElementById('input-pickups').value) || null;
    const notifications = parseInt(document.getElementById('input-notifications').value) || null;
    const firstPickup = document.getElementById('input-first-pickup').value || null;
    const notes = document.getElementById('input-notes').value.trim() || null;
    const appUsage = collectAppRows();
    const todayStr = getTodayStr();

    const payload = {
        user_id: currentUser.id,
        log_date: todayStr,
        total_screen_time_minutes: totalMins,
        pickups: pickups,
        notifications_received: notifications,
        first_pickup_time: firstPickup,
        app_usage: appUsage,
        source: 'manual',
        notes: notes,
        updated_at: new Date().toISOString(),
    };

    let error;
    if (isEditing && todayLog) {
        ({ error } = await window.supabaseClient
            .from('phone_usage_logs')
            .update(payload)
            .eq('id', todayLog.id));
    } else {
        ({ error } = await window.supabaseClient
            .from('phone_usage_logs')
            .insert(payload));
    }

    saveBtn.disabled = false;
    saveBtn.textContent = 'Save';

    if (error) {
        console.error('Save error:', error);
        showToast('Error saving â€” please try again');
        return;
    }

    showToast(isEditing ? 'Updated!' : 'Logged! Keep tracking your habits.');
    hideForm();
    await loadData();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PLATFORM TABS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchPlatform(platform, btn) {
    document.querySelectorAll('.platform-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.platform-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('platform-' + platform).classList.add('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTodayStr() {
    return new Date().toISOString().split('T')[0];
}

function formatMins(mins) {
    if (!mins && mins !== 0) return 'â€”';
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    if (h === 0) return `${m}m`;
    if (m === 0) return `${h}h`;
    return `${h}h ${m}m`;
}

function escHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function showToast(msg, duration = 3000) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), duration);
}
</script>
</body>
</html>
