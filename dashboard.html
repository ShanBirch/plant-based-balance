<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Balance</title>
<meta name="description" content="Your fitness pet adventure — track workouts, raise your FitGotchi, and level up.">

<!-- Open Graph Tags -->
<meta property="og:title" content="Balance Dashboard">
<meta property="og:description" content="Access your personalized protocol and track your progress.">
<meta property="og:image" content="https://plantbased-balance.org/assets/Logo_dots.jpg">
<meta property="og:type" content="website">

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link rel="preconnect" href="https://f005.backblazeb2.com" crossorigin/>
<link rel="dns-prefetch" href="https://f005.backblazeb2.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="manifest.json" rel="manifest"/>
<link rel="apple-touch-icon" href="assets/Logo_dots.jpg">
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" defer></script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW Registered!', reg))
      .catch(err => console.log('SW Failed:', err));
  }
</script>

<!-- CRITICAL: Hide loading overlay for returning users and restore cached FitGotchi state -->
<script>
(function() {
    // If the user has already completed their first dashboard load,
    // hide the loading overlay instantly so it doesn't flash on page reloads
    // (e.g. when returning from native camera on mobile).
    var isReturning = localStorage.getItem('dashboardInitialized') === 'true';
    if (isReturning) {
        var style = document.createElement('style');
        style.textContent = '.login-loading-overlay { display: none !important; }';
        document.head.appendChild(style);
    }

    // For returning users, preload their actual character model instead of the baby
    var cachedModel = localStorage.getItem('fitgotchi_model_src');
    if (isReturning && cachedModel) {
        var preload = document.createElement('link');
        preload.rel = 'preload';
        preload.href = cachedModel;
        preload.as = 'fetch';
        preload.crossOrigin = '';
        document.head.appendChild(preload);
        // Mark that we have a cached model so the baby preload can be skipped
        window._fitgotchiCachedModel = cachedModel;
    }
})();
</script>

<!-- CRITICAL: Early theme application to prevent flash of default theme -->
<script>
(function() {
    // Immediately apply saved theme from localStorage before page renders
    const savedTheme = localStorage.getItem('userThemePreference');
    if (!savedTheme || savedTheme === 'default') return; // Default is already in CSS

    // Minimal theme definitions for instant application
    const EARLY_THEMES = {
        'flower-garden': {'--primary':'#D98B9C','--primary-light':'#F4B4C4','--secondary':'#B4A7D6','--secondary-light':'#D0C8E8','--accent-green':'#FFF8F5','--bg':'#FFFBF9','--surface':'#ffffff','--text-main':'#4A3F44','--text-muted':'#8B7D82','--chat-bg-user':'#D98B9C','--chat-text-user':'#ffffff','--chat-bg-coach':'#FFF8F5','--chat-text-coach':'#4A3F44','--chat-border-coach':'#F4B4C4'},
        'antigravity-light': {'--primary':'#4f46e5','--primary-light':'#6366f1','--secondary':'#0891b2','--secondary-light':'#22D3EE','--accent-green':'#eff6ff','--bg':'#ffffff','--surface':'#f8fafc','--text-main':'#0f172a','--text-muted':'#64748b','--chat-bg-user':'#4f46e5','--chat-text-user':'#ffffff','--chat-bg-coach':'#f1f5f9','--chat-text-coach':'#0f172a','--chat-border-coach':'#e2e8f0'},
        'ocean': {'--primary':'#0369a1','--primary-light':'#0ea5e9','--secondary':'#db2777','--secondary-light':'#F472B6','--accent-green':'#f0f9ff','--bg':'#f0f9ff','--surface':'#ffffff','--text-main':'#082f49','--text-muted':'#64748b','--chat-bg-user':'#0369a1','--chat-text-user':'#ffffff','--chat-bg-coach':'#f1f5f9','--chat-text-coach':'#082f49','--chat-border-coach':'#e0f2fe'},
        'sunset': {'--primary':'#9d174d','--primary-light':'#be123c','--secondary':'#ea580c','--secondary-light':'#FB923C','--accent-green':'#fff1f2','--bg':'#fff1f2','--surface':'#ffffff','--text-main':'#500724','--text-muted':'#9d174d','--chat-bg-user':'#9d174d','--chat-text-user':'#ffffff','--chat-bg-coach':'#fff5f5','--chat-text-coach':'#500724','--chat-border-coach':'#ffe4e6'},
        'cycle-pink': {'--primary':'#D81B60','--primary-light':'#F06292','--secondary':'#AB47BC','--secondary-light':'#CE93D8','--accent-green':'#FCE4EC','--bg':'#FCE4EC','--surface':'#ffffff','--text-main':'#880E4F','--text-muted':'#AD1457','--chat-bg-user':'#D81B60','--chat-text-user':'#ffffff','--chat-bg-coach':'#F8BBD0','--chat-text-coach':'#880E4F','--chat-border-coach':'#F48FB1'},
        'midnight': {'--primary':'#0f172a','--primary-light':'#1e293b','--secondary':'#fbbf24','--secondary-light':'#FDE68A','--accent-green':'#334155','--bg':'#020617','--surface':'#1e293b','--text-main':'#f8fafc','--text-muted':'#94a3b8','--chat-bg-user':'#3b82f6','--chat-text-user':'#ffffff','--chat-bg-coach':'#1e293b','--chat-text-coach':'#f8fafc','--chat-border-coach':'#334155'},
        'lavender': {'--primary':'#6b21a8','--primary-light':'#7e22ce','--secondary':'#fcd34d','--secondary-light':'#FEF08A','--accent-green':'#faf5ff','--bg':'#faf5ff','--surface':'#ffffff','--text-main':'#4c1d95','--text-muted':'#9333ea','--chat-bg-user':'#6b21a8','--chat-text-user':'#ffffff','--chat-bg-coach':'#f3e8ff','--chat-text-coach':'#4c1d95','--chat-border-coach':'#e9d5ff'},
        'matcha': {'--primary':'#3f6212','--primary-light':'#4d7c0f','--secondary':'#a3e635','--secondary-light':'#D9F99D','--accent-green':'#f7fee7','--bg':'#f7fee7','--surface':'#ffffff','--text-main':'#1a2e05','--text-muted':'#4d7c0f','--chat-bg-user':'#3f6212','--chat-text-user':'#ffffff','--chat-bg-coach':'#ecfccb','--chat-text-coach':'#1a2e05','--chat-border-coach':'#d9f99d'},
        'monochrome': {'--primary':'#1a1a1a','--primary-light':'#333333','--secondary':'#666666','--secondary-light':'#A3A3A3','--accent-green':'#f5f5f5','--bg':'#ffffff','--surface':'#fafafa','--text-main':'#1a1a1a','--text-muted':'#737373','--chat-bg-user':'#1a1a1a','--chat-text-user':'#ffffff','--chat-bg-coach':'#f5f5f5','--chat-text-coach':'#1a1a1a','--chat-border-coach':'#e5e5e5'},
        'dbz-warrior': {'--primary':'#FF6B00','--primary-light':'#FF8C00','--secondary':'#FFD700','--secondary-light':'#FDE68A','--accent-green':'#FFF8E7','--bg':'#FFFAF0','--surface':'#ffffff','--text-main':'#1a1a1a','--text-muted':'#8B4513','--chat-bg-user':'#FF6B00','--chat-text-user':'#ffffff','--chat-bg-coach':'#FFF8E7','--chat-text-coach':'#1a1a1a','--chat-border-coach':'#FFD700'},
        'dbz-vegeta': {'--primary':'#0047AB','--primary-light':'#1E90FF','--secondary':'#FFD700','--secondary-light':'#FDE68A','--accent-green':'#F0F8FF','--bg':'#F5F9FF','--surface':'#ffffff','--text-main':'#0a1628','--text-muted':'#4a5568','--chat-bg-user':'#0047AB','--chat-text-user':'#ffffff','--chat-bg-coach':'#F0F8FF','--chat-text-coach':'#0a1628','--chat-border-coach':'#87CEEB'},
        'sailor-moon': {'--primary':'#FF69B4','--primary-light':'#FFB6C1','--secondary':'#FFD700','--secondary-light':'#FDE68A','--accent-green':'#FFF0F5','--bg':'#FFF5FA','--surface':'#ffffff','--text-main':'#1a1a1a','--text-muted':'#8B4789','--chat-bg-user':'#FF69B4','--chat-text-user':'#ffffff','--chat-bg-coach':'#FFF0F5','--chat-text-coach':'#1a1a1a','--chat-border-coach':'#FFD700'},
        'sailor-venus': {'--primary':'#FFA500','--primary-light':'#FFB84D','--secondary':'#FFD700','--secondary-light':'#FDE68A','--accent-green':'#FFF8DC','--bg':'#FFFAF0','--surface':'#ffffff','--text-main':'#1a1a1a','--text-muted':'#B8860B','--chat-bg-user':'#FFA500','--chat-text-user':'#ffffff','--chat-bg-coach':'#FFF8DC','--chat-text-coach':'#1a1a1a','--chat-border-coach':'#FFD700'}
    };

    const theme = EARLY_THEMES[savedTheme];
    if (theme) {
        const root = document.documentElement;
        for (const [key, value] of Object.entries(theme)) {
            root.style.setProperty(key, value);
        }
        console.log('✅ Early theme applied:', savedTheme);
    }
})();
</script>

<!-- Supabase & Auth Guard -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="lib/supabase.js?v=3"></script>
<script src="lib/auth-guard.js?v=3"></script>
<script src="lib/migrate-localstorage.js"></script>
<script src="lib/stories.js"></script>
<script src="lib/games.js"></script>
<script src="lib/nutrition-calculator.js"></script>
<script src="lib/native-health.js"></script>
<script src="lib/native-push.js"></script>
<script src="lib/platform.js"></script>
<script src="lib/native-iap.js"></script>
<!-- 2D SVG Avatar system (reserved for future use) -->
<!-- <script src="lib/avatar.js"></script> -->
<!-- <link rel="stylesheet" href="lib/avatar.css"> -->
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.1.0/model-viewer.min.js"></script>
<!-- Preload onboarding 3D models so they display instantly in the wizard -->
<!-- Baby model preload only for first-time users (returning users preload their cached model above) -->
<script>
if (!window._fitgotchiCachedModel) {
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb" as="fetch" crossorigin>');
}
</script>
<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/arny.glb" as="fetch" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">

<!-- Early stub definitions to prevent "undefined" errors before main scripts load -->
<script>
// Stub for userCycleData - will be overwritten with real data later
var userCycleData = {
    lastPeriod: null,
    cycleLength: 28,
    mood: null,
    noPeriodMode: false,
    symptoms: [],
    logs: {},
    dailyCheckIn: null
};

// Stub for switchAppTab - queues calls until real function loads
var _switchAppTabQueue = [];
var _switchAppTabReady = false;
function switchAppTab(tabName, btn) {
    if (_switchAppTabReady && typeof _switchAppTabReal === 'function') {
        return _switchAppTabReal(tabName, btn);
    }
    // Queue the call for when the real function is ready
    _switchAppTabQueue.push({ tabName, btn });
}

// Stub for syncQuizDataToDb - safe no-op until real function loads
var _syncQuizDataToDbReal = null;
async function syncQuizDataToDb() {
    if (typeof _syncQuizDataToDbReal === 'function') {
        return await _syncQuizDataToDbReal();
    }
    // Real function not loaded yet, silently skip
    console.log('syncQuizDataToDb: waiting for initialization...');
}

// Stub for loadProfileData - safe no-op until real function loads
var _loadProfileDataReal = null;
async function loadProfileData() {
    if (typeof _loadProfileDataReal === 'function') {
        return await _loadProfileDataReal();
    }
    // Real function not loaded yet, silently skip
    console.log('loadProfileData: waiting for initialization...');
}

// Stub for applyAppTheme - safe no-op until real function loads
var _applyAppThemeReal = null;
async function applyAppTheme(themeKey) {
    if (typeof _applyAppThemeReal === 'function') {
        return await _applyAppThemeReal(themeKey);
    }
    // Real function not loaded yet, silently skip
    console.log('applyAppTheme: waiting for initialization with theme:', themeKey);
}
</script>

<style>
    :root {
        /* Premium Green & Gold Palette (Default) */
        --primary: #7BA883; /* Soft Sage Green (Pastel) */
        --primary-light: #98C9A3; /* Light Mint Green (Pastel) */
        --secondary: #E8D68E; /* Soft Golden Yellow */
        --secondary-light: #F2E5B0; /* Light Golden Yellow */
        --accent-green: #f2f7f4; /* Subtle Green Tint */

        --bg: #f9f9f7;
        --surface: #ffffff;
        --text-main: #1a202c;
        --text-muted: #718096;

        --border-radius: 16px;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --nav-height: 80px;
    }

    * { box-sizing: border-box; }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--bg);
        color: var(--text-main);
        margin: 0;
        padding-bottom: calc(var(--nav-height) + 20px + env(safe-area-inset-bottom)); /* Space for bottom nav + safe area */
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
    }

    /* Fixed Bottom Navigation */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: var(--nav-height);
        background: white;
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        z-index: 9999; /* Always on top */
        border-top: 1px solid rgba(0,0,0,0.05);
        padding-bottom: env(safe-area-inset-bottom);
    }


    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.75rem;
        font-weight: 500;
        gap: 6px;
        width: 100%;
        height: 100%;
        transition: color 0.2s;
        border: none;
        background: transparent;
        cursor: pointer;
    }

    .nav-item.active {
        color: var(--secondary);
    }
    
    .nav-item svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }

    /* Notification glow effect for tabs */
    .nav-item.has-notification {
        position: relative;
        animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
        0%, 100% {
            box-shadow: 0 0 0 rgba(251, 191, 36, 0);
        }
        50% {
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), inset 0 0 20px rgba(251, 191, 36, 0.2);
        }
    }

    .nav-item.has-notification svg,
    .nav-item.has-notification span {
        color: #fbbf24;
        filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.8));
    }

    /* Flower Theme Decorative Elements (used when flower-garden theme is active) */
    .flower-decoration-corner {
        position: absolute;
        width: 60px;
        height: 60px;
        background: url('assets/flower-cherry-blossom.svg') no-repeat center;
        background-size: contain;
        opacity: 0.25;
        pointer-events: none;
    }
    .flower-decoration-corner.top-right {
        top: 10px;
        right: 10px;
    }
    .flower-decoration-corner.bottom-left {
        bottom: 10px;
        left: 10px;
        transform: rotate(180deg);
    }

    /* Top Header for Views */
    .app-header {
        padding: 20px 25px;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 900;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .app-logo { font-family: 'Playfair Display'; font-weight: 700; font-size: 1.25rem; color: var(--primary); }
    .streak-header-widget {
        display: flex;
        align-items: center;
        gap: 5px;
        background: linear-gradient(135deg, #ff6400, #e85500);
        border-radius: 20px;
        padding: 5px 10px 5px 8px;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(255,100,0,0.25);
    }
    .streak-header-count {
        font-weight: 800;
        color: white;
        font-size: 0.85rem;
        font-family: 'Outfit', sans-serif;
        text-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .coin-header-widget {
        display: flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        border-radius: 20px;
        padding: 5px 10px 5px 8px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(245,158,11,0.25);
        white-space: nowrap;
    }
    .coin-header-widget .coin-emoji { font-size: 0.95rem; }
    .coin-header-widget .coin-amount {
        font-weight: 700;
        color: white;
        font-size: 0.85rem;
        min-width: 20px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .coin-header-widget .coin-buy-btn {
        background: rgba(255,255,255,0.3);
        border: 1.5px solid rgba(255,255,255,0.6);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 700;
        cursor: pointer;
    }
    /* Profile View Styles */
    .profile-header {
        text-align: center;
        padding: 40px 20px;
        background: white;
        border-bottom: 1px solid #f1f5f9;
        margin-bottom: 25px;
    }
    .profile-photo-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 20px auto;
        border-radius: 50%;
        border: 4px solid var(--accent-green);
        padding: 5px;
    }
    .profile-photo {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    .photo-edit-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: var(--secondary);
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .profile-name-large {
        font-family: 'Playfair Display';
        font-size: 1.8rem;
        margin-bottom: 5px;
        color: var(--primary);
    }
    .profile-email {
        color: var(--text-muted);
        font-size: 0.95rem;
    }
    .profile-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding: 0 25px;
        margin-bottom: 30px;
    }
    .detail-item {
        background: white;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #f1f5f9;
        text-align: center;
    }
    .detail-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
    }
    .detail-val {
        font-weight: 700;
        color: var(--primary);
        font-size: 1.1rem;
    }
    .connected-apps-list {
        padding: 0 25px;
    }
    .app-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        padding: 15px 20px;
        border-radius: 16px;
        margin-bottom: 15px;
        border: 1px solid #f1f5f9;
    }
    .app-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .app-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    .app-btn {
        padding: 8px 20px;
        border-radius: 50px;
        border: 1px solid var(--primary);
        background: transparent;
        color: var(--primary);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
    }
    .app-btn.connected {
        background: #f0fdf4;
        color: #166534;
        border-color: #166534;
    }

    .profile-icon { 
        width: 35px; 
        height: 35px; 
        background: var(--accent-green); 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-weight: bold; 
        color: var(--primary); 
        cursor: pointer;
        transition: transform 0.1s;
    }
    .profile-icon:active { transform: scale(0.95); }

    /* Week Sub-Navigation (Pills) */
    .week-scroller { 
        display: flex; 
        gap: 10px; 
        overflow-x: auto; 
        padding: 15px 25px; 
        background: var(--bg);
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }
    .week-scroller::-webkit-scrollbar { display: none; }

    .pill-btn {
        padding: 8px 16px;
        background: white;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 20px;
        color: var(--text-muted);
        white-space: nowrap;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .pill-btn.active {
        background: var(--secondary); /* Gold */
        color: white;
        border-color: var(--secondary);
        box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
    }

    /* Dashboard Styles */
    .dashboard-welcome {
        padding: 0;
        background: transparent;
        color: white;
        margin-bottom: 15px;
    }
    .dashboard-welcome h1, 
    .dashboard-welcome .user-name,
    .dashboard-welcome .stat-val,
    .dashboard-welcome h2,
    .dashboard-welcome h3,
    .dashboard-welcome h4,
    .dashboard-welcome p {
        color: white !important;
    }
    .welcome-text { opacity: 0.9; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: white; }
    .user-name { font-family: 'Playfair Display'; font-size: 2rem; margin: 5px 0 10px 0; }
    
    .stats-row { display: flex; gap: 15px; margin-top: 20px; }
    .stat-card {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(5px);
        padding: 15px;
        border-radius: 12px;
        flex: 1;
        text-align: center;
    }
    .stat-val { font-size: 1.5rem; font-weight: 700; display: block; }
    .stat-label { font-size: 0.75rem; opacity: 0.9; }

    /* Hero Level Display */
    .level-hero-container {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-top: 8px;
        padding-bottom: 8px;
    }

    .level-hero-badge {
        position: relative;
        width: 72px;
        height: 72px;
        flex-shrink: 0;
    }

    .level-ring-svg {
        position: absolute;
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }

    .level-ring-bg {
        fill: none;
        stroke: rgba(255, 255, 255, 0.2);
        stroke-width: 6;
    }

    .level-ring-progress {
        fill: none;
        stroke: #FFD700;
        stroke-width: 6;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.6s ease-out;
    }

    .level-hero-inner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .level-hero-number {
        font-size: 1.75rem;
        font-weight: 900;
        color: #FFD700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .level-hero-info {
        flex: 1;
        min-width: 0;
    }

    .level-hero-title {
        display: block;
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 6px;
        color: #FFD700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .level-hero-progress {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .level-hero-progress-bar {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        height: 8px;
        overflow: hidden;
    }

    .level-hero-progress-fill {
        background: linear-gradient(90deg, var(--secondary) 0%, #FFD700 100%);
        height: 100%;
        border-radius: 8px;
        transition: width 0.5s ease-out;
    }

    .level-hero-progress-text {
        font-size: 0.75rem;
        opacity: 0.85;
    }

    .streak-hero-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        padding: 10px 14px;
        backdrop-filter: blur(10px);
        min-width: 52px;
    }

    .streak-hero-fire {
        font-size: 1.25rem;
        line-height: 1;
    }

    .streak-hero-number {
        font-size: 1.1rem;
        font-weight: 800;
        margin-top: 2px;
    }

    /* Level up animation */
    @keyframes levelUpPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
    }

    .level-up-animation {
        animation: levelUpPulse 0.6s ease-out;
    }

    h1, h2, h3, h4 { 
        font-family: 'Playfair Display', serif; 
        color: var(--primary);
        margin-top: 0;
    }

    h1 { font-size: 2.5rem; letter-spacing: -0.5px; font-weight: 700; }
    h2 { font-size: 1.75rem; color: var(--primary-light); }
    
    /* Layout Container */
    .container { 
        max-width: 100%; 
        margin: 0 auto; 
        min-height: 100vh; 
        background: var(--bg); 
        display: flex; 
        flex-direction: column; 
        position: relative;
    }
    
    /* Sticky Navigation */
    .top-nav { 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(10px);
        position: sticky; 
        top: 0; 
        z-index: 1000; 
        border-bottom: 1px solid rgba(0,0,0,0.05); 
        padding: 15px 30px; 
        display: flex; 
        gap: 12px; 
        overflow-x: auto; 
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Hide scrollbar Firefox */
        box-shadow: var(--nav-shadow);
    }
    .top-nav::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome/Safari */

    .nav-btn { 
        padding: 10px 24px; 
        border-radius: 50px; 
        border: 1px solid transparent; 
        background: transparent; 
        color: var(--text-muted); 
        font-weight: 500; 
        cursor: pointer; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        font-family: 'Inter', sans-serif; 
        font-size: 0.95rem; 
        white-space: nowrap;
    }
    
    .nav-btn:hover { color: var(--primary); background: var(--accent-green); }
    
    .nav-btn.active { 
        background: var(--primary); 
        color: white; 
        box-shadow: 0 4px 12px rgba(30, 58, 95, 0.25); 
        transform: translateY(-1px);
    }

    /* Content Area */
    .view-section { 
        display: none; 
        padding: 40px 30px; 
        animation: fadeIn 0.4s ease-out; 
    }
    .view-section.active { display: block; }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    /* Hero Section (Cover) */
    .hero-card {
        text-align: center;
        padding: 100px 40px;
        background: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)), url('/assets/hero_image.webp');
        background-size: cover;
        background-position: center;
        border-radius: var(--border-radius);
        margin-bottom: 40px;
        border: 1px solid rgba(0,0,0,0.03);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .hero-title {
        font-size: 3rem;
        color: var(--primary);
        line-height: 1.1;
        margin-bottom: 15px;
    }
    .hero-subtitle {
        font-size: 1.25rem;
        color: var(--secondary);
        font-family: 'Inter', sans-serif;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 600;
        margin-bottom: 30px;
    }

    /* Sub Tabs (Week Days) */
    .sub-nav { 
        display: flex; 
        gap: 10px; 
        margin-bottom: 30px; 
        flex-wrap: wrap; 
        justify-content: center;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .sub-btn { 
        padding: 5px 12px; 
        border: none; 
        background: transparent; 
        border-radius: 6px; 
        font-size: 0.9rem; 
        font-weight: 500; 
        cursor: pointer; 
        transition: all 0.2s; 
        color: var(--text-muted);
    }
    
    .sub-btn:hover { color: var(--primary); }
    
    .sub-btn.active { 
        background: transparent; 
        color: var(--primary); 
        border: none;
        font-weight: 700;
        text-decoration: underline;
        text-underline-offset: 4px;
    }
    
    .day-view { display: none; }
    .day-view.active { display: block; }

    /* Meal Cards */
    .card { 
        background: var(--surface); 
        border-radius: var(--border-radius); 
        box-shadow: var(--card-shadow); 
        margin-bottom: 24px; 
        border: 1px solid rgba(0,0,0,0.04); 
        overflow: hidden; 
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.08);
    }
    
    .card-header { 
        padding: 25px; 
        cursor: pointer; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: white;
    }
    
    .meal-icon { font-size: 1.8rem; margin-right: 20px; filter: grayscale(0.2); }
    
    .meta { 
        font-size: 0.75rem; 
        color: var(--secondary); 
        font-weight: 700; 
        text-transform: uppercase; 
        letter-spacing: 1px; 
        margin-bottom: 6px; 
    }
    
    .meal-title {
        font-family: 'Playfair Display', serif;
        font-weight: 600;
        font-size: 1.25rem;
        color: var(--primary);
        line-height: 1.3;
    }

    .expand-icon {
        font-size: 1.5rem;
        color: var(--text-muted);
        transition: transform 0.3s ease;
        font-weight: 300;
    }
    .card.open .expand-icon { transform: rotate(45deg); }

    .card-body { 
        padding: 0 30px; 
        max-height: 0; 
        overflow: hidden; 
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        background: #fdfdfd; 
        border-top: 1px solid rgba(0,0,0,0.03); 
        opacity: 0;
    }
    .card.open .card-body { 
        max-height: 2000px; /* Safe large number */
        padding: 30px; 
        opacity: 1;
    }

    /* Content Styling */
    .nutrition-pill {
        display: inline-block;
        padding: 6px 12px;
        background: var(--accent-green);
        color: #2d4a3e;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 20px;
    }

    h4 { 
        font-size: 0.95rem; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
        color: var(--primary-light); 
        margin-bottom: 12px; 
        border-bottom: 2px solid rgba(0,0,0,0.05);
        padding-bottom: 6px;
        display: inline-block;
    }

    ul { padding-left: 20px; color: #4a5568; margin-bottom: 25px; }
    li { margin-bottom: 8px; }
    p { color: #4a5568; }

    /* Tables */
    table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 20px 0; font-size: 0.95rem; border: 1px solid #eee; border-radius: 12px; overflow: hidden; }
    th { background: var(--primary); color: white; padding: 15px; text-align: left; font-weight: 500; font-family: 'Playfair Display'; letter-spacing: 0.5px; }
    td { border-bottom: 1px solid #eee; padding: 12px 15px; color: #444; }
    tr:last-child td { border-bottom: none; }
    tr:nth-child(even) { background: #fcfcfc; }

    /* Mobile Tweaks */
    @media (max-width: 600px) {
        .top-nav { padding: 15px; gap: 8px; }
        .nav-btn { padding: 8px 16px; font-size: 0.85rem; }
        .hero-title { font-size: 2.2rem; }
        .view-section { padding: 25px 15px; }
        .card-body { padding: 0 20px; }
        .card.open .card-body { padding: 20px; }

        /* Responsive tamagotchi widget - scale down on smaller phones */
        #tamagotchi-widget-container {
            height: 340px !important;
        }
        #tamagotchi-stats-bar {
            padding: 12px 14px !important;
        }
        #tamagotchi-stats-bar #tamagotchi-level {
            font-size: 1.3rem !important;
        }
        #tamagotchi-stats-bar #tamagotchi-xp-text {
            font-size: 0.6rem !important;
        }
        #tamagotchi-stats-bar #tamagotchi-rank {
            font-size: 0.65rem !important;
        }

        /* Reduce header padding on mobile */
        .app-header {
            padding: 10px 14px !important;
        }
        /* Bottom nav compact on smaller screens */
        .bottom-nav {
            height: 68px;
        }
        .nav-item {
            font-size: 0.65rem;
            gap: 3px;
        }
        .nav-item .nav-icon {
            font-size: 1.2rem;
        }
        body {
            padding-bottom: calc(68px + 16px);
        }
    }
    @media (max-width: 380px) {
        /* Very small phones (iPhone SE, older Androids) */
        #tamagotchi-widget-container {
            height: 280px !important;
        }
        #tamagotchi-stats-bar {
            padding: 10px 12px !important;
        }
        .bottom-nav {
            height: 60px;
        }
        .nav-item {
            font-size: 0.6rem;
            gap: 2px;
        }
        body {
            padding-bottom: calc(60px + 12px);
        }
    }
    /* Image Modal */
    .image-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        display: none;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        padding: 20px;
        backdrop-filter: blur(5px);
    }
    .image-modal-overlay.active {
        display: flex;
        opacity: 1;
    }
    .image-modal-content {
        max-width: 90vw;
        max-height: 90vh;
        border-radius: 8px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        object-fit: contain;
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }
    .image-modal-overlay.active .image-modal-content {
        transform: scale(1);
    }
    .close-modal-btn {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 2.5rem;
        cursor: pointer;
        z-index: 2001;
        background: rgba(255, 255, 255, 0.1);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background 0.2s, transform 0.2s;
        line-height: 0;
        padding-bottom: 5px;
    }
    .close-modal-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }
    
    /* Meal Image Cursor */
    .card-body img {
        cursor: zoom-in;
        transition: opacity 0.2s;
    }
    .card-body img:hover {
        opacity: 0.9;
    }
    /* Shopping List Improvements */
    .shopping-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        margin-top: 10px;
    }
    .shopping-category h4 {
        color: var(--primary);
        border-bottom: 2px solid var(--accent-green);
        padding-bottom: 8px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .check-list {
        list-style: none; /* Remove default bullets */
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
    }
    .check-list li {
        position: relative;
        padding-left: 35px; /* Space for checkbox */
        line-height: 1.4;
        color: var(--text-main);
        cursor: pointer;
        transition: color 0.2s;
        display: flex; /* alignment */
        align-items: center;
    }
    .check-list li:hover {
        color: var(--primary);
    }
    /* Custom Checkbox */
    .check-list li::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        border: 2px solid #cbd5e0;
        border-radius: 5px;
        transition: all 0.2s;
        background: white;
    }
    .check-list li.checked {
        text-decoration: line-through;
        color: var(--text-muted);
        opacity: 0.7;
    }
    .check-list li.checked::before {
        background-color: var(--secondary); /* Gold background */
        border-color: var(--secondary);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='14px' height='14px'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
    }
    
    /* Sleep Guide Styles */
    .section-title {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        margin-top: 50px;
    }
    .section-number {
        background: var(--secondary);
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        font-size: 1.2rem;
    }
    .timeline-item {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        position: relative;
    }
    .timeline-item:last-child { margin-bottom: 0; }
    .timeline-time {
        min-width: 100px;
        text-align: right;
        font-weight: 600;
        color: var(--primary-light);
        padding-top: 2px;
    }
    .timeline-content {
        padding-bottom: 30px;
        border-left: 2px solid var(--accent-green);
        padding-left: 35px; /* More space for icon */
        position: relative;
    }
    .timeline-item:last-child .timeline-content { border-left: 2px solid transparent; }
    
    /* Icon Dot on Timeline */
    .timeline-content::before {
        content: '';
        position: absolute;
        left: -20px; /* Centered on line */
        top: 0;
        width: 40px;
        height: 40px;
        background: white;
        border: 2px solid var(--secondary);
        border-radius: 50%;
        z-index: 1;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    /* Simple CSS Icons using Emojis or content chars for simplicity/reliability without SVG bloat here */
    /* Simple CSS Icons using Emojis or content chars for simplicity/reliability without SVG bloat here */
    .timeline-item:nth-child(1) .timeline-content::after { content: '🌙'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }
    .timeline-item:nth-child(2) .timeline-content::after { content: '🍵'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }
    .timeline-item:nth-child(3) .timeline-content::after { content: '🧘'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }
    .timeline-item:nth-child(4) .timeline-content::after { content: '📵'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }
    .timeline-item:nth-child(5) .timeline-content::after { content: '🛌'; position: absolute; left: -14px; top: 6px; font-size: 1.2rem; z-index: 2; }

    /* Sleep Hero */
    .sleep-hero {
        background: linear-gradient(135deg, #1a2a44 0%, #2d4a6d 100%);
        color: white;
        padding: 60px 40px;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 50px;
        box-shadow: 0 10px 40px rgba(30, 58, 95, 0.2);
    }
    
    .recipe-card {
        background: #fffafa;
        border: 1px solid #ffecec;
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        display: flex;
        gap: 30px;
        align-items: center;
    }
    .rescue-card {
        background: #fdf6f6;
        border-left: 4px solid #e53e3e;
        padding: 25px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    @media (max-width: 700px) {
        .recipe-card { flex-direction: column; text-align: center; }
        .timeline-content::before { left: -15px; width: 30px; height: 30px; }
        .timeline-item:nth-child(n) .timeline-content::after { font-size: 1rem; left: -8px; top: 4px; }
        .timeline-content { padding-left: 25px; }
    }

    /* Today's Meals Redesign */
    .today-menu-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .today-menu-header h2 {
        font-size: 2rem;
        margin-bottom: 5px;
    }
    .today-menu-header p {
        color: var(--text-muted);
        font-weight: 500;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-size: 0.8rem;
    }
    #today .card {
        border-radius: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(0,0,0,0.03);
        box-shadow: 0 10px 25px rgba(0,0,0,0.03);
    }
    #today .card-header {
        padding: 20px 25px;
    }
    #today .meal-title {
        font-size: 1.15rem;
    }
    /* Onboarding Modal Styles */
    .onboarding-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(4, 106, 56, 0.6); /* Primary with opacity */
        backdrop-filter: blur(8px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        padding: 20px;
        opacity: 0;
        transition: opacity 0.4s ease;
    }
    .onboarding-overlay.active {
        display: flex;
        opacity: 1;
    }
    .onboarding-modal {
        background: white;
        width: 100%;
        max-width: 450px;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        animation: slideUp 0.5s ease-out;
    }
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideUpModal {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    @keyframes slideDown {
        from { transform: translate(-50%, -20px); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    .onboarding-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        padding: 30px;
        text-align: center;
        color: white;
    }
    .onboarding-content {
        padding: 30px;
    }
    .onboarding-step {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: flex-start;
    }
    .step-icon {
        font-size: 1.5rem;
        background: var(--accent-green);
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .step-text h4 {
        margin: 0 0 5px 0;
        color: var(--primary);
        font-size: 1rem;
        border: none;
    }
    .step-text p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted);
        line-height: 1.4;
    }
    .onboarding-btn {
        width: 100%;
        padding: 16px;
        background: var(--secondary);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: transform 0.2s;
        margin-top: 10px;
    }
    .onboarding-btn:hover {
        transform: translateY(-2px);
        background: #bfa64d; /* Darker gold */
    }

    /* ========================================== */
    /* MEAL PLAN STORE STYLES */
    /* ========================================== */

    .meal-store-container {
        padding: 20px;
    }

    .meal-store-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .meal-store-header h2 {
        font-family: 'Playfair Display', serif;
        font-size: 1.8rem;
        color: var(--primary);
        margin-bottom: 10px;
    }

    .meal-store-header p {
        color: var(--text-muted);
        font-size: 1rem;
        max-width: 400px;
        margin: 0 auto;
    }

    .meal-plan-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .meal-plan-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .meal-plan-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .meal-plan-card.featured {
        border: 2px solid var(--secondary);
    }

    .meal-plan-card .featured-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--secondary);
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .meal-plan-thumbnail {
        width: 100%;
        height: 160px;
        object-fit: cover;
        background: linear-gradient(135deg, var(--accent-green) 0%, var(--primary-light) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .meal-plan-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .meal-plan-thumbnail .plan-icon {
        font-size: 4rem;
    }

    .meal-plan-info {
        padding: 20px;
    }

    .meal-plan-info h3 {
        font-family: 'Playfair Display', serif;
        font-size: 1.3rem;
        color: var(--primary);
        margin-bottom: 8px;
    }

    .meal-plan-info .tagline {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 12px;
        line-height: 1.4;
    }

    .meal-plan-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 15px;
    }

    .meal-plan-tag {
        background: var(--accent-green);
        color: var(--primary);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .meal-plan-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 1px solid rgba(0,0,0,0.05);
    }

    .meal-plan-price {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--primary);
    }

    .meal-plan-price span {
        font-size: 0.85rem;
        font-weight: 400;
        color: var(--text-muted);
    }

    .meal-plan-cta {
        background: var(--secondary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .meal-plan-cta:hover {
        background: #bfa64d;
        transform: scale(1.02);
    }

    /* Diet variant pills for store */
    .diet-variants {
        display: flex;
        gap: 6px;
        margin-top: 10px;
    }

    .diet-variant-pill {
        font-size: 0.65rem;
        padding: 3px 8px;
        border-radius: 10px;
        background: rgba(123, 168, 131, 0.15);
        color: var(--primary);
        font-weight: 500;
    }

    /* Quiz user banner */
    .quiz-meal-plan-banner {
        background: linear-gradient(135deg, var(--accent-green) 0%, rgba(123, 168, 131, 0.3) 100%);
        border-radius: 16px;
        padding: 20px;
        margin: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .quiz-meal-plan-banner .banner-icon {
        font-size: 2.5rem;
    }

    .quiz-meal-plan-banner .banner-content h3 {
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        margin-bottom: 5px;
    }

    .quiz-meal-plan-banner .banner-content p {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin: 0;
    }

    /* ========================================== */
    /* PREFERENCE WIZARD STYLES */
    /* ========================================== */

    .pref-wizard-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .pref-wizard-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .pref-wizard-modal {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 450px;
        max-height: 85vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: transform 0.3s ease;
    }

    .pref-wizard-overlay.active .pref-wizard-modal {
        transform: translateY(0);
    }

    .pref-wizard-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: white;
        padding: 25px;
        text-align: center;
        border-radius: 20px 20px 0 0;
    }

    .pref-wizard-header h2 {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    .pref-wizard-header p {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .pref-wizard-progress {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 15px;
    }

    .pref-wizard-progress .step-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
    }

    .pref-wizard-progress .step-dot.active {
        background: white;
        transform: scale(1.2);
    }

    .pref-wizard-progress .step-dot.completed {
        background: var(--secondary);
    }

    .pref-wizard-body {
        padding: 25px;
    }

    .pref-wizard-step {
        display: none;
    }

    .pref-wizard-step.active {
        display: block;
        animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .pref-wizard-step h3 {
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        font-size: 1.2rem;
        margin-bottom: 20px;
        text-align: center;
    }

    .pref-option-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .pref-option {
        background: #f8f9fa;
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 20px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .pref-option:hover {
        border-color: var(--primary-light);
        background: var(--accent-green);
    }

    .pref-option.selected {
        border-color: var(--primary);
        background: var(--accent-green);
    }

    .pref-option .option-icon {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    .pref-option .option-label {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
    }

    .pref-option .option-desc {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .pref-checkbox-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .pref-checkbox {
        background: #f8f9fa;
        border: 2px solid transparent;
        border-radius: 25px;
        padding: 10px 18px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }

    .pref-checkbox:hover {
        border-color: var(--primary-light);
    }

    .pref-checkbox.selected {
        background: var(--accent-green);
        border-color: var(--primary);
        font-weight: 600;
    }

    .pref-wizard-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-top: 1px solid #eee;
    }

    .pref-wizard-btn {
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
    }

    .pref-wizard-btn.secondary {
        background: #f0f0f0;
        color: var(--text-muted);
    }

    .pref-wizard-btn.secondary:hover {
        background: #e0e0e0;
    }

    .pref-wizard-btn.primary {
        background: var(--secondary);
        color: white;
    }

    .pref-wizard-btn.primary:hover {
        background: #bfa64d;
    }

    .pref-wizard-btn.primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* ========================================== */
    /* CALORIE TRACKER STYLES */
    /* ========================================== */

    /* Calorie Widget Card (Dashboard) */
    .calorie-widget-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .calorie-widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .camera-btn-widget {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(123, 168, 131, 0.3);
    }

    .camera-btn-widget:hover {
        background: var(--primary-light);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(123, 168, 131, 0.4);
    }

    .camera-btn-widget:active {
        transform: scale(0.95);
    }

    /* Calorie Progress */
    .calorie-progress-main {
        margin-bottom: 20px;
    }

    .calorie-numbers {
        display: flex;
        align-items: baseline;
        justify-content: center;
        margin-bottom: 12px;
        gap: 4px;
    }

    .calorie-current {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
    }

    .calorie-separator {
        font-size: 1.5rem;
        color: var(--text-muted);
        margin: 0 4px;
    }

    .calorie-goal {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .calorie-unit {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-left: 4px;
    }

    /* Progress Bars */
    .progress-bar {
        height: 12px;
        background: #f0f0f0;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--primary-light));
        border-radius: 6px;
        transition: width 0.5s ease;
    }

    .progress-bar-small {
        height: 6px;
        background: #f0f0f0;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 6px;
    }

    .progress-fill-protein {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--primary-light));
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .progress-fill-carbs {
        height: 100%;
        background: linear-gradient(90deg, var(--secondary), var(--secondary-light));
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .progress-fill-fat {
        height: 100%;
        background: linear-gradient(90deg, #d4a574, #e6c29a);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .progress-fill-fiber {
        height: 100%;
        background: linear-gradient(90deg, #9b8dab, #b5a9c2);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    /* Macros Grid */
    .macros-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .macro-item {
        text-align: center;
    }

    .macro-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 4px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .macro-value {
        font-size: 0.85rem;
        color: var(--text-main);
        font-weight: 600;
        margin-bottom: 4px;
    }

    /* Widget Footer */
    .calorie-widget-footer {
        margin-top: 16px;
        text-align: center;
    }

    .view-details-btn {
        background: none;
        border: none;
        color: var(--primary);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .view-details-btn:hover {
        background: var(--accent-green);
    }

    /* Milestone Toast */
    .milestone-toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: linear-gradient(135deg, var(--secondary) 0%, var(--primary-light) 100%);
        border-radius: 16px;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 10009;
        transition: transform 0.3s ease;
    }

    .milestone-toast.show {
        transform: translateX(-50%) translateY(0);
    }

    .milestone-icon {
        font-size: 2rem;
    }

    .milestone-title {
        font-weight: 700;
        color: #333;
        font-size: 1.1rem;
    }

    .milestone-points {
        color: #666;
        font-weight: 600;
    }

    /* Points Earned Toast */
    .points-earned-toast {
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--primary);
        color: white;
        border-radius: 12px;
        padding: 12px 20px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        z-index: 10009;
        transform: translateX(200px);
        transition: transform 0.3s ease;
    }

    .points-earned-toast.show {
        transform: translateX(0);
    }

    .points-earned-main {
        font-size: 1.5rem;
        font-weight: 800;
    }

    .points-earned-bonus,
    .points-earned-streak {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    /* Level Up Toast */
    .level-up-toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.5);
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
        border-radius: 20px;
        padding: 0;
        box-shadow: 0 0 60px rgba(255, 215, 0, 0.6), 0 20px 60px rgba(0, 0, 0, 0.3);
        z-index: 10010;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: hidden;
    }

    .level-up-toast.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }

    .level-up-glow {
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, transparent 70%);
        animation: levelGlow 2s ease-in-out infinite;
    }

    @keyframes levelGlow {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }

    .level-up-content {
        position: relative;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 24px 32px;
    }

    .level-up-icon {
        font-size: 3rem;
        animation: starPulse 0.8s ease-in-out infinite;
    }

    @keyframes starPulse {
        0%, 100% { transform: scale(1) rotate(0deg); }
        50% { transform: scale(1.2) rotate(15deg); }
    }

    .level-up-text {
        text-align: left;
    }

    .level-up-title {
        font-size: 0.9rem;
        font-weight: 800;
        color: rgba(0, 0, 0, 0.6);
        letter-spacing: 2px;
        text-transform: uppercase;
    }

    .level-up-level {
        font-size: 2rem;
        font-weight: 900;
        color: #333;
        line-height: 1.1;
    }

    .level-up-rank {
        font-size: 1rem;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.7);
    }

    /* Level Up Enhanced - Glow Ring Pulse */
    .level-up-rings-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10005;
        overflow: hidden;
    }

    .level-up-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        border: 4px solid rgba(255, 215, 0, 0.8);
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 20px rgba(255, 215, 0, 0.3);
        animation: ringPulse 1.5s ease-out forwards;
    }

    .level-up-ring:nth-child(1) { animation-delay: 0s; }
    .level-up-ring:nth-child(2) { animation-delay: 0.2s; }
    .level-up-ring:nth-child(3) { animation-delay: 0.4s; }
    .level-up-ring:nth-child(4) { animation-delay: 0.6s; }

    @keyframes ringPulse {
        0% {
            width: 50px;
            height: 50px;
            opacity: 1;
            border-width: 4px;
        }
        100% {
            width: 400px;
            height: 400px;
            opacity: 0;
            border-width: 1px;
        }
    }

    /* XP Bar Rainbow Flash */
    @keyframes xpRainbowFlash {
        0% { background: linear-gradient(90deg, #ff0000, #ff7f00); }
        14% { background: linear-gradient(90deg, #ff7f00, #ffff00); }
        28% { background: linear-gradient(90deg, #ffff00, #00ff00); }
        42% { background: linear-gradient(90deg, #00ff00, #0000ff); }
        57% { background: linear-gradient(90deg, #0000ff, #4b0082); }
        71% { background: linear-gradient(90deg, #4b0082, #9400d3); }
        85% { background: linear-gradient(90deg, #9400d3, #ff0000); }
        100% { background: linear-gradient(90deg, var(--secondary), var(--primary-light)); }
    }

    .xp-bar-rainbow {
        animation: xpRainbowFlash 1.5s ease-out;
    }

    /* Level Up Title Transition */
    .level-up-title-transition {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        margin-top: 4px;
    }

    .level-up-old-title {
        color: rgba(0, 0, 0, 0.4);
        text-decoration: line-through;
    }

    .level-up-arrow {
        color: rgba(0, 0, 0, 0.6);
        font-weight: bold;
    }

    .level-up-new-title {
        color: rgba(0, 0, 0, 0.8);
        font-weight: 700;
        animation: newTitlePop 0.5s ease-out;
    }

    @keyframes newTitlePop {
        0% { transform: scale(0.5); opacity: 0; }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Level Up Stats Comparison */
    .level-up-stats {
        display: flex;
        gap: 16px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .level-up-stat {
        text-align: center;
        flex: 1;
    }

    .level-up-stat-value {
        font-size: 1.2rem;
        font-weight: 800;
        color: #333;
    }

    .level-up-stat-label {
        font-size: 0.65rem;
        color: rgba(0, 0, 0, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Streak Celebration */
    .level-up-streak-bonus {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        margin-top: 8px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        animation: streakBounce 0.6s ease-out;
    }

    @keyframes streakBounce {
        0% { transform: scale(0) rotate(-10deg); }
        50% { transform: scale(1.2) rotate(5deg); }
        100% { transform: scale(1) rotate(0deg); }
    }

    /* Enhanced Level Up Toast Layout */
    .level-up-toast-enhanced {
        min-width: 280px;
    }

    .level-up-toast-enhanced .level-up-content {
        flex-direction: column;
        text-align: center;
        padding: 28px 32px;
    }

    .level-up-toast-enhanced .level-up-icon {
        font-size: 3.5rem;
        margin-bottom: 8px;
    }

    .level-up-toast-enhanced .level-up-text {
        text-align: center;
    }

    /* ============================================
       IN-TAMAGOTCHI LEVEL UP CELEBRATION
       Shows level-up directly in the character view
       ============================================ */

    .tamagotchi-levelup-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 50;
        display: none;
        pointer-events: none;
        overflow: hidden;
    }

    .tamagotchi-levelup-overlay.active {
        display: block;
    }

    /* Radial burst effect behind character */
    .levelup-burst {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 0;
        height: 0;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, rgba(255, 165, 0, 0.2) 40%, transparent 70%);
        animation: burstExpand 1.5s ease-out forwards;
    }

    @keyframes burstExpand {
        0% { width: 0; height: 0; opacity: 1; }
        50% { opacity: 0.8; }
        100% { width: 600px; height: 600px; opacity: 0; }
    }

    /* Full-screen golden flash on level-up */
    @keyframes celebrationFlash {
        0% { opacity: 0.6; }
        100% { opacity: 0; }
    }

    /* Sparkle particles */
    .levelup-sparkle {
        position: absolute;
        width: 8px;
        height: 8px;
        background: #FFD700;
        border-radius: 50%;
        box-shadow: 0 0 10px 3px rgba(255, 215, 0, 0.8);
        animation: sparkleFloat 2s ease-out forwards;
    }

    @keyframes sparkleFloat {
        0% {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        100% {
            transform: translateY(-150px) scale(0);
            opacity: 0;
        }
    }

    /* Rising stars effect */
    .levelup-star {
        position: absolute;
        font-size: 1.5rem;
        animation: starRise 2.5s ease-out forwards;
        filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
    }

    @keyframes starRise {
        0% {
            transform: translateY(50px) scale(0) rotate(0deg);
            opacity: 0;
        }
        20% {
            opacity: 1;
            transform: translateY(0) scale(1.2) rotate(20deg);
        }
        80% {
            opacity: 1;
        }
        100% {
            transform: translateY(-200px) scale(0.5) rotate(360deg);
            opacity: 0;
        }
    }

    /* Level Up Banner - centered on screen */
    .levelup-banner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
        padding: 12px 28px;
        border-radius: 30px;
        box-shadow: 0 4px 20px rgba(255, 165, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3);
        z-index: 9999;
        pointer-events: auto;
        animation: bannerPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.3s forwards;
    }

    @keyframes bannerPop {
        0% { transform: translate(-50%, -50%) scale(0); }
        70% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); }
    }

    .levelup-banner-text {
        text-align: center;
    }

    .levelup-banner-title {
        font-size: 0.7rem;
        font-weight: 800;
        color: rgba(0, 0, 0, 0.5);
        letter-spacing: 3px;
        text-transform: uppercase;
        margin-bottom: 2px;
    }

    .levelup-banner-level {
        font-size: 1.8rem;
        font-weight: 900;
        color: #333;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .levelup-banner-level .star-icon {
        font-size: 1.4rem;
        animation: starPulse 0.8s ease-in-out infinite;
    }

    .levelup-banner-rank {
        font-size: 0.85rem;
        font-weight: 700;
        color: rgba(0, 0, 0, 0.6);
        margin-top: 4px;
    }

    .levelup-rank-transition {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        margin-top: 4px;
    }

    .levelup-rank-old {
        font-size: 0.75rem;
        color: rgba(0, 0, 0, 0.4);
        text-decoration: line-through;
    }

    .levelup-rank-arrow {
        font-size: 0.8rem;
        color: rgba(0, 0, 0, 0.6);
    }

    .levelup-rank-new {
        font-size: 0.85rem;
        font-weight: 800;
        color: rgba(0, 0, 0, 0.8);
    }

    /* Unlocked move display in banner */
    .levelup-unlocked-move {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(0, 0, 0, 0.15);
        animation: unlockSlideIn 0.5s ease-out 0.8s both;
    }

    @keyframes unlockSlideIn {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    .levelup-unlocked-label {
        font-size: 0.6rem;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.5);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 2px;
    }

    .levelup-unlocked-name {
        font-size: 0.85rem;
        font-weight: 700;
        color: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    .levelup-unlocked-icon {
        font-size: 1.1rem;
    }

    /* XP Bar Level-Up Animation */
    .xp-bar-levelup-fill {
        animation: xpBarLevelUp 1.5s ease-out forwards;
    }

    @keyframes xpBarLevelUp {
        0% { width: var(--start-width, 0%); }
        50% { width: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); }
        60% { width: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); }
        100% { width: var(--end-width, 0%); background: linear-gradient(90deg, var(--secondary), var(--primary-light)); }
    }

    /* Level number pulse on update */
    .level-number-update {
        animation: levelNumberPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes levelNumberPop {
        0% { transform: scale(1); }
        30% { transform: scale(1.3); color: #FFD700; }
        100% { transform: scale(1); }
    }

    /* Confetti effect */
    .levelup-confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        animation: confettiFall 3s ease-out forwards;
    }

    @keyframes confettiFall {
        0% {
            transform: translateY(-20px) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: translateY(450px) rotate(720deg);
            opacity: 0;
        }
    }

    /* Stats bar glow during celebration */
    .stats-bar-celebrating {
        animation: statsBarGlow 2s ease-out;
    }

    @keyframes statsBarGlow {
        0% { box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        30% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.6), 0 8px 24px rgba(0,0,0,0.3); }
        100% { box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    }

    /* Glass animation selector - inside tamagotchi */
    .animation-selector-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 100;
        display: none;
    }

    .animation-selector-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
    }

    .animation-selector-modal {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        bottom: 10px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow: hidden;
        animation: fadeInScale 0.25s ease-out;
        display: flex;
        flex-direction: column;
    }

    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .animation-selector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        flex-shrink: 0;
    }

    .animation-selector-header h3 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.95);
    }

    .animation-selector-close {
        font-size: 1.4rem;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        line-height: 1;
        padding: 4px;
        transition: color 0.2s;
    }

    .animation-selector-close:hover {
        color: rgba(255, 255, 255, 1);
    }

    .animation-selector-content {
        padding: 10px 12px 14px;
        overflow-y: auto;
        flex: 1;
    }

    .animation-category {
        margin-bottom: 12px;
    }

    .animation-category-title {
        font-size: 0.65rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .animation-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
    }

    .animation-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 4px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .animation-item.unlocked {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .animation-item.unlocked:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.03);
    }

    .animation-item.unlocked:active {
        transform: scale(0.97);
    }

    .animation-item.locked {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
        opacity: 0.5;
    }

    .animation-icon {
        font-size: 1.3rem;
        margin-bottom: 2px;
    }

    .animation-name {
        font-size: 0.55rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.1;
    }

    .animation-item.locked .animation-name {
        color: rgba(255, 255, 255, 0.4);
    }

    .animation-unlock-level {
        font-size: 0.5rem;
        color: rgba(255, 255, 255, 0.4);
        margin-top: 1px;
    }

    /* Skin levels grid in moves modal */
    .skin-levels-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
    }

    .skin-level-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 4px;
        border-radius: 10px;
        text-align: center;
        gap: 2px;
    }

    .skin-level-item.unlocked {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .skin-level-item.locked {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        opacity: 0.5;
    }

    .skin-level-badge {
        font-size: 0.55rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.6);
        text-transform: uppercase;
    }

    .skin-level-icon {
        font-size: 1.2rem;
    }

    .skin-level-title {
        font-size: 0.55rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.1;
    }

    .skin-level-item.locked .skin-level-title {
        color: rgba(255, 255, 255, 0.4);
    }

    /* Animation button on Tamagotchi widget */
    .animation-trigger-btn {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s ease;
        font-size: 1.3rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .animation-trigger-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.1);
    }

    .animation-trigger-btn:active {
        transform: scale(0.95);
    }

    /* Battle Trigger Button */
    .battle-trigger-btn {
        position: absolute;
        bottom: 15px;
        right: 65px; /* Positioned to the left of the film icon */
        background: rgba(220, 50, 50, 0.4);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 100, 100, 0.4);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s ease;
        font-size: 1.3rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        touch-action: manipulation;
        pointer-events: auto;
    }

    .battle-trigger-btn:hover {
        background: rgba(220, 50, 50, 0.6);
        transform: scale(1.1);
    }

    .battle-trigger-btn:active {
        transform: scale(0.95);
    }

    /* Arena Trigger Button */
    .arena-trigger-btn {
        position: absolute;
        bottom: 15px;
        right: 115px;
        background: rgba(16, 185, 129, 0.35);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(16, 185, 129, 0.45);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s ease;
        font-size: 1.3rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        touch-action: manipulation;
        pointer-events: auto;
    }

    .arena-trigger-btn:hover {
        background: rgba(16, 185, 129, 0.55);
        transform: scale(1.1);
    }

    .arena-trigger-btn:active {
        transform: scale(0.95);
    }

    .arena-trigger-btn.locked {
        opacity: 0.5;
        position: absolute;
    }

    .arena-trigger-btn.locked::after {
        content: 'Lv.10';
        position: absolute;
        bottom: -14px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.45rem;
        font-weight: 800;
        color: rgba(255,255,255,0.6);
        white-space: nowrap;
        background: rgba(0,0,0,0.5);
        padding: 1px 5px;
        border-radius: 4px;
    }

    /* ── Arena Invite Modal ── */
    .arena-invite-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(8px);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease-out;
    }

    .arena-invite-modal {
        background: linear-gradient(135deg, #0a1a2e 0%, #0e2a1e 50%, #1a2e0a 100%);
        border-radius: 24px;
        width: 100%;
        max-width: 380px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(16,185,129,0.15);
        border: 1px solid rgba(16,185,129,0.2);
        animation: fadeInScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: hidden;
    }

    .arena-invite-header {
        text-align: center;
        padding: 24px 20px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .arena-invite-header h2 {
        margin: 0 0 4px;
        font-size: 1.3rem;
        font-weight: 800;
        color: #10b981;
        text-shadow: 0 0 20px rgba(16,185,129,0.3);
    }

    .arena-invite-header p {
        margin: 0;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.6);
    }

    .arena-invite-body {
        padding: 12px 16px;
        overflow-y: auto;
        flex: 1;
    }

    .arena-invite-friend {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 14px;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.08);
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .arena-invite-friend:hover {
        background: rgba(255,255,255,0.12);
        border-color: rgba(16,185,129,0.3);
    }

    .arena-invite-friend:active {
        transform: scale(0.98);
    }

    .arena-invite-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(5,150,105,0.3));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
    }

    .arena-invite-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .arena-invite-info {
        flex: 1;
        min-width: 0;
    }

    .arena-invite-name {
        font-size: 0.9rem;
        font-weight: 700;
        color: white;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .arena-invite-status {
        font-size: 0.65rem;
        color: rgba(255,255,255,0.5);
        margin-top: 2px;
    }

    .arena-invite-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.15s;
        background: linear-gradient(135deg, rgba(16,185,129,0.6), rgba(5,150,105,0.4));
        color: white;
        border: 1px solid rgba(16,185,129,0.4);
        flex-shrink: 0;
    }

    .arena-invite-btn:hover {
        background: linear-gradient(135deg, rgba(16,185,129,0.8), rgba(5,150,105,0.6));
        transform: scale(1.05);
    }

    .arena-invite-footer {
        padding: 12px 16px 16px;
        border-top: 1px solid rgba(255,255,255,0.1);
        text-align: center;
    }

    .arena-invite-close {
        padding: 10px 24px;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        background: transparent;
        color: rgba(255,255,255,0.7);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .arena-invite-close:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }

    .arena-player-count {
        display: flex;
        gap: 6px;
        margin-top: 8px;
    }

    .arena-count-btn {
        flex: 1;
        padding: 8px;
        background: rgba(255,255,255,0.08);
        border: 2px solid rgba(255,255,255,0.15);
        border-radius: 8px;
        color: white;
        font-weight: 700;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.15s;
    }

    .arena-count-btn.active {
        background: rgba(16,185,129,0.2);
        border-color: rgba(16,185,129,0.5);
        color: #10b981;
    }

    /* Fireball Projectile */
    .fireball {
        position: absolute;
        width: 200px;
        height: 200px;
        pointer-events: none;
        z-index: 100;
        will-change: transform;
        filter: drop-shadow(0 0 25px #ff5500);
    }

    .fireball img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        image-rendering: pixelated;
    }

    /* Battle Flash Effect */
    .battle-flash {
        animation: battleFlash 0.3s ease-out;
    }

    @keyframes battleFlash {
        0% { filter: brightness(1); }
        50% { filter: brightness(2) contrast(1.2); }
        100% { filter: brightness(1); }
    }

    /* Battle Overlay Title */
    .battle-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
        pointer-events: none;
    }

    .battle-overlay.active {
        display: flex;
        animation: fadeIn 0.3s ease-out;
    }

    .battle-text {
        color: white;
        font-size: 2.5rem;
        font-weight: 900;
        text-shadow: 0 0 20px rgba(255,0,0,0.8);
        font-family: 'Outfit', sans-serif;
        text-transform: uppercase;
    }

    /* Animation unlock toast */
    .animation-unlock-toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px 32px;
        border-radius: 20px;
        text-align: center;
        z-index: 10010;
        opacity: 0;
        transition: all 0.3s ease;
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
    }

    .animation-unlock-toast.show {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }

    .animation-unlock-icon {
        font-size: 3rem;
        margin-bottom: 8px;
        animation: unlockBounce 0.6s ease-out;
    }

    @keyframes unlockBounce {
        0% { transform: scale(0) rotate(-20deg); }
        50% { transform: scale(1.3) rotate(10deg); }
        100% { transform: scale(1) rotate(0deg); }
    }

    .animation-unlock-title {
        font-size: 0.8rem;
        font-weight: 600;
        opacity: 0.9;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .animation-unlock-name {
        font-size: 1.4rem;
        font-weight: 800;
    }

    /* Calorie Tracker Summary (Full View) */
    .calorie-tracker-summary {
        background: white;
        border-radius: 16px;
        padding: 30px 20px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* Circular Progress */
    .calorie-progress-large {
        display: flex;
        justify-content: center;
        margin: 30px 0;
    }

    .calorie-circle {
        position: relative;
        width: 200px;
        height: 200px;
    }

    .calorie-circle-svg {
        width: 100%;
        height: 100%;
    }

    .calorie-circle-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .calorie-circle-numbers {
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 4px;
    }

    .calorie-circle-current {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary);
        line-height: 1;
    }

    .calorie-circle-separator {
        font-size: 1rem;
        color: var(--text-muted);
    }

    .calorie-circle-goal {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .calorie-circle-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Macro Ring Legend */
    .macro-ring-legend {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 12px;
        margin-bottom: 8px;
    }
    .macro-ring-legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.78rem;
    }
    .macro-ring-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    .macro-ring-label {
        color: var(--text-muted);
    }
    .macro-ring-pct {
        font-weight: 700;
        color: var(--text-main);
    }

    /* Micronutrient Tracker (inside daily tracker) */
    .tracker-micro-section {
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }
    .tracker-micro-header {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
    }
    .tracker-micro-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .micro-tracker-item {
        background: #f9f9f7;
        padding: 10px 14px;
        border-radius: 10px;
    }
    .micro-tracker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }
    .micro-tracker-name {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .micro-tracker-name .micro-tracker-icon {
        font-size: 0.9rem;
    }
    .micro-tracker-value {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
    }
    .micro-tracker-status {
        font-size: 0.68rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .progress-bar-micro {
        height: 6px;
        background: #e5e5e5;
        border-radius: 3px;
        overflow: hidden;
    }
    .progress-fill-micro {
        height: 100%;
        border-radius: 3px;
        transition: width 0.4s ease;
    }

    /* Macros Detail Grid */
    .macros-detail-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 30px;
    }

    .macro-detail-item {
        background: #f9f9f7;
        padding: 12px 16px;
        border-radius: 12px;
    }

    /* Weekly Metrics Styles */
    .weekly-day-item {
        margin-bottom: 12px;
    }

    .weekly-day-item:last-child {
        margin-bottom: 0;
    }

    .weekly-day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }

    .weekly-day-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-main);
    }

    .weekly-day-calories {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-muted);
    }

    .macro-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .macro-detail-name {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text-main);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .macro-detail-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-main);
    }

    .progress-bar-medium {
        height: 10px;
        background: #e5e5e5;
        border-radius: 5px;
        overflow: hidden;
    }

    /* ============================================================
       ENHANCED NUTRITION TAB STYLES
       ============================================================ */

    /* Daily Nutrition Score */
    .nutrition-score-ring {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto;
    }
    .nutrition-score-ring svg { width: 100%; height: 100%; }
    .nutrition-score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--text-main);
    }
    /* Inline Streak Badge */
    .streak-inline {
        display: flex;
        align-items: center;
        gap: 5px;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 1px solid #fde68a;
        border-radius: 20px;
        padding: 4px 12px;
    }
    .streak-inline-flame {
        font-size: 1rem;
    }
    .streak-inline-count {
        font-size: 1rem;
        font-weight: 800;
        color: #d97706;
    }
    .streak-inline-label {
        font-size: 0.72rem;
        color: #92400e;
        font-weight: 600;
    }

    /* Daily Score Popup */
    .score-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        animation: fadeInOverlay 0.2s ease;
    }
    @keyframes fadeInOverlay {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideUpPopup {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .score-popup-modal {
        background: white;
        border-radius: 20px;
        padding: 28px 24px;
        max-width: 380px;
        width: 100%;
        position: relative;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        animation: slideUpPopup 0.3s ease;
    }
    .score-popup-close {
        position: absolute;
        top: 12px;
        right: 16px;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px 8px;
        line-height: 1;
    }
    .score-popup-header {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-main);
        text-align: center;
        margin-bottom: 4px;
    }

    .nutrition-score-card {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border: 1px solid #bbf7d0;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
        text-align: center;
    }
    .nutrition-score-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .score-breakdown {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 14px;
        flex-wrap: wrap;
    }
    .score-breakdown-item {
        font-size: 0.78rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .score-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    /* Streak Tracker */
    .streak-tracker-card {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 1px solid #fde68a;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .streak-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
    }
    .streak-flame {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .streak-count {
        font-size: 1.6rem;
        font-weight: 800;
        color: #d97706;
    }
    .streak-label {
        font-size: 0.85rem;
        color: #92400e;
        font-weight: 600;
    }
    .streak-next-bonus {
        font-size: 0.78rem;
        color: #92400e;
        background: rgba(217, 119, 6, 0.12);
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
    }
    .streak-progress-bar {
        height: 8px;
        background: rgba(217, 119, 6, 0.15);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 10px;
    }
    .streak-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #f59e0b, #d97706);
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    .streak-days-grid {
        display: flex;
        gap: 6px;
        margin-top: 12px;
        justify-content: center;
    }
    .streak-day-dot {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 700;
        border: 2px solid #fde68a;
        color: #92400e;
        background: white;
    }
    .streak-day-dot.filled {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border-color: #d97706;
    }
    .streak-day-dot.today {
        border-color: #d97706;
        box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.3);
    }

    /* Multi-Week History */
    .multi-week-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .multi-week-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    .multi-week-nav {
        display: flex;
        gap: 6px;
    }
    .multi-week-nav button {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 0.8rem;
        cursor: pointer;
        color: var(--text-main);
        font-weight: 600;
    }
    .multi-week-nav button.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    .sparkline-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .sparkline-row:last-child { border-bottom: none; }
    .sparkline-label {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-main);
        width: 55px;
        flex-shrink: 0;
    }
    .sparkline-svg {
        flex: 1;
        height: 30px;
    }
    .sparkline-value {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-main);
        width: 60px;
        text-align: right;
        flex-shrink: 0;
    }
    .sparkline-trend {
        font-size: 0.75rem;
        font-weight: 700;
        width: 50px;
        text-align: right;
        flex-shrink: 0;
    }
    .sparkline-trend.up { color: #16a34a; }
    .sparkline-trend.down { color: #dc2626; }
    .sparkline-trend.neutral { color: #9ca3af; }
    .week-compare-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 14px;
    }
    .week-compare-stat {
        text-align: center;
        padding: 12px 8px;
        background: #f9fafb;
        border-radius: 10px;
    }
    .week-compare-stat .stat-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary);
    }
    .week-compare-stat .stat-label {
        font-size: 0.72rem;
        color: var(--text-muted);
        margin-top: 2px;
    }

    /* Micronutrient Insights */
    .micro-insights-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .micro-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 14px;
    }
    .micro-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        background: #f9fafb;
    }
    .micro-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }
    .micro-info {
        flex: 1;
        min-width: 0;
    }
    .micro-name {
        font-size: 0.78rem;
        font-weight: 700;
        color: var(--text-main);
    }
    .micro-bar-bg {
        height: 5px;
        background: #e5e7eb;
        border-radius: 3px;
        margin-top: 4px;
        overflow: hidden;
    }
    .micro-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.4s ease;
    }
    .micro-status {
        font-size: 0.68rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    /* Meal Pattern Analysis */
    .meal-pattern-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .pattern-insight {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        border-radius: 10px;
        background: #f9fafb;
        margin-bottom: 8px;
    }
    .pattern-insight:last-child { margin-bottom: 0; }
    .pattern-icon {
        font-size: 1.2rem;
        flex-shrink: 0;
        margin-top: 1px;
    }
    .pattern-text {
        font-size: 0.85rem;
        color: var(--text-main);
        line-height: 1.4;
    }
    .pattern-text strong {
        color: var(--primary);
    }

    /* AI Assistant Card */
    .ai-msg { margin-bottom: 12px; animation: fadeIn 0.3s ease; }
    .ai-msg-user { display: flex; justify-content: flex-end; }
    .ai-msg-user .ai-msg-bubble { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border-radius: 16px 16px 0 16px; }
    .ai-msg-bot { display: flex; justify-content: flex-start; }
    .ai-msg-bot .ai-msg-bubble { background: #f1f5f9; color: var(--text-main); border-radius: 0 16px 16px 16px; }
    .ai-msg-bubble { padding: 10px 14px; max-width: 85%; font-size: 0.88rem; line-height: 1.5; word-wrap: break-word; }
    .ai-msg-bubble p { margin: 0 0 8px 0; }
    .ai-msg-bubble p:last-child { margin-bottom: 0; }
    .ai-msg-bubble strong { font-weight: 600; }
    .ai-msg-bubble ul, .ai-msg-bubble ol { margin: 4px 0; padding-left: 18px; }
    .ai-msg-bubble li { margin: 2px 0; }
    .ai-typing-indicator { display: flex; gap: 4px; padding: 10px 14px; background: #f1f5f9; border-radius: 0 16px 16px 16px; width: fit-content; }
    .ai-typing-dot { width: 7px; height: 7px; background: #94a3b8; border-radius: 50%; animation: aiTypingBounce 1.4s infinite ease-in-out; }
    .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes aiTypingBounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
    .ai-action-card { background: #fefce8; border: 1px solid #fde68a; border-radius: 12px; padding: 12px 14px; margin-bottom: 8px; }
    .ai-action-card .ai-action-title { font-weight: 600; font-size: 0.85rem; color: #92400e; margin-bottom: 4px; }
    .ai-action-card .ai-action-desc { font-size: 0.82rem; color: #78716c; }
    .ai-action-btns { display: flex; gap: 8px; margin-top: 10px; }
    .ai-action-confirm { flex: 1; padding: 10px; border: none; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: opacity 0.2s; }
    .ai-action-confirm.accept { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .ai-action-confirm.decline { background: #f1f5f9; color: var(--text-muted); }

    /* Adaptive Calorie Adjustment Card */
    .adaptive-adjustment-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
        position: relative;
        overflow: hidden;
    }
    .adaptive-adjustment-card.has-suggestion {
        border-color: rgba(4, 106, 56, 0.3);
        background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
    }
    .adaptive-adjustment-card.on-track {
        border-color: rgba(34, 197, 94, 0.3);
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }
    .adaptive-progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        margin: 12px 0;
        overflow: hidden;
    }
    .adaptive-progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.6s ease;
        background: var(--primary);
    }
    .adaptive-stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 14px 0;
    }
    .adaptive-stat {
        text-align: center;
        padding: 10px 6px;
        background: rgba(4, 106, 56, 0.05);
        border-radius: 10px;
    }
    .adaptive-stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary);
    }
    .adaptive-stat-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 2px;
    }
    .adaptive-suggestion-box {
        background: #fffbeb;
        border: 1px solid #fde68a;
        border-radius: 12px;
        padding: 14px;
        margin-top: 14px;
    }
    .adaptive-suggestion-box.positive {
        background: #f0fdf4;
        border-color: #bbf7d0;
    }
    .adaptive-suggestion-text {
        font-size: 0.85rem;
        color: var(--text-main);
        line-height: 1.5;
        margin-bottom: 8px;
    }
    .adaptive-suggestion-question {
        font-size: 0.82rem;
        color: #92400e;
        font-style: italic;
        line-height: 1.4;
    }
    .adaptive-suggestion-box.positive .adaptive-suggestion-question {
        color: var(--primary);
    }
    .adaptive-adjust-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        margin-top: 14px;
        padding: 12px 16px;
        background: linear-gradient(135deg, var(--primary), #059669);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .adaptive-adjust-btn:active {
        transform: scale(0.97);
    }
    .adaptive-dismiss-btn {
        display: block;
        width: 100%;
        margin-top: 8px;
        padding: 8px;
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 0.8rem;
        cursor: pointer;
    }
    /* Adaptive Adjustment Confirmation Modal */
    .adaptive-modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }
    .adaptive-modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }
    .adaptive-modal {
        background: white;
        border-radius: 20px;
        padding: 28px 24px;
        width: 90%;
        max-width: 360px;
        text-align: center;
        transform: scale(0.9);
        transition: transform 0.2s;
    }
    .adaptive-modal-overlay.active .adaptive-modal {
        transform: scale(1);
    }
    .adaptive-modal-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }
    .adaptive-modal-title {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 8px;
    }
    .adaptive-modal-body {
        font-size: 0.88rem;
        color: var(--text-muted);
        line-height: 1.5;
        margin-bottom: 20px;
    }
    .adaptive-modal-change {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin: 16px 0;
        padding: 14px;
        background: #f0fdf4;
        border-radius: 12px;
    }
    .adaptive-modal-old {
        font-size: 1rem;
        color: var(--text-muted);
        text-decoration: line-through;
    }
    .adaptive-modal-arrow {
        font-size: 1.2rem;
        color: var(--primary);
    }
    .adaptive-modal-new {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary);
    }
    .adaptive-modal-confirm {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, var(--primary), #059669);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 8px;
    }
    .adaptive-modal-cancel {
        width: 100%;
        padding: 10px;
        background: none;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        color: var(--text-muted);
        font-size: 0.88rem;
        cursor: pointer;
    }

    /* Photo Meal Journal */
    .meal-journal-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .journal-timeline {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 14px;
    }
    .journal-day {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }
    .journal-date-col {
        width: 45px;
        text-align: center;
        flex-shrink: 0;
    }
    .journal-date-day {
        font-size: 0.72rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
    }
    .journal-date-num {
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--text-main);
    }
    .journal-photos {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        flex: 1;
        padding-bottom: 4px;
        -webkit-overflow-scrolling: touch;
    }
    .journal-photo {
        width: 64px;
        height: 64px;
        border-radius: 10px;
        overflow: hidden;
        flex-shrink: 0;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .journal-photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .journal-photo .placeholder {
        font-size: 1.5rem;
    }
    .journal-day-cals {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 4px;
        white-space: nowrap;
    }

    /* Cycle-Synced Nutrition Tips */
    .cycle-nutrition-card {
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
        border: 1px solid;
    }
    .cycle-nutrition-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 14px;
    }
    .cycle-nutrition-phase {
        font-size: 1rem;
        font-weight: 700;
    }
    .cycle-tip-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .cycle-tip {
        display: flex;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 0.85rem;
        line-height: 1.4;
    }
    .cycle-tip-icon {
        font-size: 1rem;
        flex-shrink: 0;
    }

    /* ============================================================
       ENHANCED NUTRITION TAB STYLES - PHASE 2
       ============================================================ */

    /* Weekly Score History */
    .score-history-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .score-history-bars {
        display: flex;
        align-items: flex-end;
        gap: 4px;
        height: 100px;
        margin-top: 14px;
        padding: 0 4px;
    }
    .score-bar-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        height: 100%;
        justify-content: flex-end;
    }
    .score-bar {
        width: 100%;
        border-radius: 6px 6px 2px 2px;
        min-height: 4px;
        transition: height 0.4s ease;
    }
    .score-bar-label {
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--text-muted);
    }
    .score-bar-value {
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--text-main);
    }

    /* Smart Meal Suggestions */
    .smart-suggestions-card {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 1px solid #bfdbfe;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .suggestion-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 14px;
    }
    .suggestion-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .suggestion-emoji {
        font-size: 1.6rem;
        flex-shrink: 0;
        width: 40px;
        text-align: center;
    }
    .suggestion-info {
        flex: 1;
        min-width: 0;
    }
    .suggestion-name {
        font-size: 0.88rem;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 2px;
    }
    .suggestion-macros {
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    .suggestion-tag {
        font-size: 0.68rem;
        font-weight: 700;
        padding: 3px 8px;
        border-radius: 12px;
        white-space: nowrap;
    }

    /* Hydration Tracker - Circular Cup */
    .hydration-circle-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 0 10px 0;
        border-top: 1px solid #e5e7eb;
        margin-top: 20px;
    }
    .hydration-circle-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 16px;
        font-size: 0.9rem;
        font-weight: 700;
        color: #0369a1;
    }
    .hydration-circle-wrap {
        position: relative;
        width: 100px;
        height: 100px;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
    }
    .hydration-circle-wrap:active {
        transform: scale(0.95);
    }
    .hydration-circle-svg {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
    }
    .hydration-circle-bg {
        fill: none;
        stroke: #e0f2fe;
        stroke-width: 8;
    }
    .hydration-circle-fill {
        fill: none;
        stroke: #0284c7;
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
    }
    .hydration-cup-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        pointer-events: none;
    }
    .hydration-cup-svg {
        width: 28px;
        height: 28px;
        fill: #0284c7;
        transition: fill 0.3s ease;
    }
    .hydration-cup-count {
        font-size: 0.7rem;
        font-weight: 700;
        color: #0369a1;
    }
    .hydration-circle-label {
        margin-top: 8px;
        font-size: 0.78rem;
        color: #0369a1;
        font-weight: 600;
    }
    .hydration-circle-hint {
        font-size: 0.68rem;
        color: #7dd3fc;
        margin-top: 2px;
    }
    .hydration-ripple {
        animation: hydrationRipple 0.4s ease-out;
    }
    @keyframes hydrationRipple {
        0% { transform: scale(1); }
        50% { transform: scale(1.08); }
        100% { transform: scale(1); }
    }

    /* Weekly Trends Button */
    .weekly-trends-btn {
        width: 100%;
        padding: 16px 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: 1px solid #cbd5e1;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-main);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 25px 0;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .weekly-trends-btn:active {
        transform: scale(0.98);
    }
    .weekly-trends-btn-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .weekly-trends-btn-arrow {
        font-size: 1.2rem;
        color: var(--text-muted);
    }

    /* Weekly Trends Page */
    .weekly-trends-page {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-main, #f5f5f5);
        z-index: 999;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    .weekly-trends-page.active {
        display: block;
    }
    .weekly-trends-page-header {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px 20px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .weekly-trends-page-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-main);
    }
    .weekly-trends-page-content {
        padding: 20px;
        padding-bottom: 100px;
    }

    /* Macro Ratio Pie Chart */
    .macro-pie-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .macro-pie-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 24px;
        margin-top: 14px;
    }
    .macro-pie-svg {
        width: 120px;
        height: 120px;
        flex-shrink: 0;
    }
    .macro-pie-legend {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .macro-pie-legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.82rem;
    }
    .macro-legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    .macro-legend-label {
        color: var(--text-muted);
    }
    .macro-legend-value {
        font-weight: 700;
        color: var(--text-main);
        margin-left: auto;
    }

    /* Meal Prep Score */
    .meal-prep-card {
        background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
        border: 1px solid #fde047;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .prep-score-ring {
        position: relative;
        width: 70px;
        height: 70px;
    }
    .prep-score-ring svg { width: 100%; height: 100%; }
    .prep-score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.2rem;
        font-weight: 800;
        color: #854d0e;
    }
    .prep-stats {
        display: flex;
        gap: 12px;
        margin-top: 14px;
    }
    .prep-stat {
        flex: 1;
        text-align: center;
        padding: 10px 8px;
        background: rgba(255,255,255,0.7);
        border-radius: 10px;
    }
    .prep-stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: #854d0e;
    }
    .prep-stat-label {
        font-size: 0.72rem;
        color: #a16207;
        margin-top: 2px;
    }

    /* Nutrition Badges */
    .badges-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .badges-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 14px;
    }
    .badge-item {
        text-align: center;
        padding: 12px 6px;
        border-radius: 12px;
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
    }
    .badge-item.earned {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border-color: #86efac;
    }
    .badge-item.locked {
        opacity: 0.5;
    }
    .badge-icon {
        font-size: 1.6rem;
        margin-bottom: 4px;
    }
    .badge-name {
        font-size: 0.7rem;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1.2;
    }
    .badge-progress {
        font-size: 0.62rem;
        color: var(--text-muted);
        margin-top: 2px;
    }

    /* User Profile Page */
    .up-pb-card {
        background: white;
        border-radius: 10px;
        padding: 8px 6px;
        border: 1px solid #f1f5f9;
        text-align: center;
        transition: transform 0.2s;
    }
    .up-pb-card:active {
        transform: scale(0.97);
    }
    .up-pb-weight {
        font-size: 1rem;
        font-weight: 800;
        color: var(--text-main);
        margin-bottom: 1px;
    }
    .up-pb-exercise {
        font-size: 0.65rem;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .up-pb-reps {
        font-size: 0.6rem;
        color: var(--primary);
        font-weight: 500;
    }
    .up-badge-card {
        text-align: center;
        padding: 14px 8px;
        border-radius: 14px;
        background: white;
        border: 1px solid #f1f5f9;
    }
    .up-badge-card.earned {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border-color: #86efac;
    }
    .up-badge-emoji {
        font-size: 1.6rem;
        margin-bottom: 4px;
    }
    .up-badge-label {
        font-size: 0.68rem;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1.2;
    }
    .up-post-thumb {
        aspect-ratio: 1;
        background: #f1f5f9;
        overflow: hidden;
        cursor: pointer;
        position: relative;
    }
    .up-post-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    .up-post-thumb .up-post-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .up-post-thumb:active .up-post-overlay {
        opacity: 1;
    }
    .up-post-card-thumb {
        aspect-ratio: 1;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
    }
    .up-post-card-thumb span {
        font-size: 2rem;
    }

    /* Social Comparison */
    .social-compare-card {
        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        border: 1px solid #e9d5ff;
        border-radius: 16px;
        padding: 20px;
        margin: 25px 0;
    }
    .social-stat-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(255,255,255,0.7);
        border-radius: 10px;
        margin-bottom: 8px;
    }
    .social-stat-row:last-child { margin-bottom: 0; }
    .social-percentile {
        font-size: 1.1rem;
        font-weight: 800;
        color: #7c3aed;
        width: 50px;
        flex-shrink: 0;
    }
    .social-bar-bg {
        flex: 1;
        height: 8px;
        background: #e9d5ff;
        border-radius: 4px;
        overflow: hidden;
    }
    .social-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #a78bfa, #7c3aed);
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    .social-stat-label {
        font-size: 0.78rem;
        color: #6b21a8;
        width: 60px;
        flex-shrink: 0;
    }

    /* Camera Button Large */
    .camera-btn-large {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 16px;
        padding: 16px 32px;
        font-size: 1.1rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(123, 168, 131, 0.3);
    }

    .camera-btn-large:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(123, 168, 131, 0.4);
    }

    .camera-btn-large:active {
        transform: translateY(0);
    }

    .meal-icon-btn {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(123, 168, 131, 0.3);
    }

    .meal-icon-btn:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(123, 168, 131, 0.4);
    }

    .meal-icon-btn:active {
        transform: translateY(0);
    }

    /* Recent Meals Modal */
    .recent-meals-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 10011;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        backdrop-filter: blur(10px);
    }

    .recent-meals-modal.visible {
        display: flex;
    }

    .recent-meals-container {
        background: white;
        border-radius: 20px 20px 0 0;
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
        animation: slideUpRecent 0.3s ease;
    }

    @keyframes slideUpRecent {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .recent-meals-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px 16px;
        border-bottom: 1px solid #f0f0f0;
        flex-shrink: 0;
    }

    .recent-meals-header h3 {
        margin: 0;
        font-size: 1.15rem;
        color: var(--text-main);
    }

    .recent-meals-close {
        background: none;
        border: none;
        font-size: 1.8rem;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .recent-meals-list {
        overflow-y: auto;
        padding: 12px 16px 24px;
        flex: 1;
    }

    .recent-meal-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 12px;
        border-radius: 14px;
        cursor: pointer;
        transition: background 0.15s ease;
        border: 1px solid transparent;
    }

    .recent-meal-item:hover {
        background: #f8faf8;
        border-color: #e8f0e8;
    }

    .recent-meal-item:active {
        background: #f0f5f0;
    }

    .recent-meal-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: #f0f5f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        flex-shrink: 0;
        overflow: hidden;
    }

    .recent-meal-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .recent-meal-info {
        flex: 1;
        min-width: 0;
    }

    .recent-meal-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .recent-meal-macros {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 3px;
    }

    .recent-meal-add {
        flex-shrink: 0;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.3rem;
        transition: all 0.15s ease;
    }

    .recent-meal-add:hover {
        background: var(--primary-light);
        transform: scale(1.1);
    }

    .recent-meals-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
    }

    .recent-meals-empty svg {
        margin-bottom: 12px;
        opacity: 0.4;
    }

    .recent-meal-confirm {
        padding: 20px 24px 28px;
        display: none;
    }

    .recent-meal-confirm.active {
        display: block;
    }

    .recent-meal-confirm-info {
        text-align: center;
        margin-bottom: 20px;
    }

    .recent-meal-confirm-name {
        font-weight: 700;
        font-size: 1.05rem;
        color: var(--text-main);
        margin-bottom: 6px;
    }

    .recent-meal-confirm-macros {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .recent-meal-confirm-btns {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .recent-meal-btn-photo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 14px 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 14px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .recent-meal-btn-photo:hover {
        background: var(--primary-light);
    }

    .recent-meal-btn-photo .xp-badge {
        background: rgba(255,255,255,0.25);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .recent-meal-btn-quick {
        width: 100%;
        padding: 14px 20px;
        background: #f0f5f0;
        color: var(--text-main);
        border: none;
        border-radius: 14px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .recent-meal-btn-quick:hover {
        background: #e5ede5;
    }

    .recent-meal-confirm-back {
        text-align: center;
        margin-top: 14px;
    }

    .recent-meal-confirm-back button {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 0.9rem;
        cursor: pointer;
        text-decoration: underline;
    }

    /* Simple Text Input Modal */
    .meal-text-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 10011;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .meal-text-modal.visible {
        display: flex;
    }

    .meal-text-modal-container {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
        padding: 24px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .meal-text-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .meal-text-modal-header h3 {
        margin: 0;
        color: var(--primary);
        font-size: 1.3rem;
    }

    .meal-text-modal-close {
        background: none;
        border: none;
        font-size: 1.8rem;
        color: #999;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .meal-text-modal-close:hover {
        color: #666;
    }

    .meal-photo-type-pill {
        flex: 1;
        padding: 8px 4px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 20px;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(10px);
        cursor: pointer;
        font-size: 0.82rem;
        font-weight: 600;
        color: rgba(255,255,255,0.7);
        text-align: center;
        transition: all 0.2s ease;
        font-family: inherit;
    }

    .meal-photo-type-pill.active {
        border-color: var(--primary);
        background: rgba(123, 168, 131, 0.35);
        color: white;
    }

    .meal-photo-type-pill:hover:not(.active) {
        border-color: rgba(255,255,255,0.5);
        color: white;
    }

    .simple-meal-type-row {
        display: flex;
        gap: 8px;
        margin-bottom: 14px;
    }

    .simple-meal-type-bubble {
        flex: 1;
        padding: 8px 4px;
        border: 2px solid #e0e0e0;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        font-size: 0.82rem;
        font-weight: 600;
        color: #999;
        text-align: center;
        transition: all 0.2s ease;
        font-family: inherit;
    }

    .simple-meal-type-bubble.active {
        border-color: var(--primary);
        background: rgba(123, 168, 131, 0.12);
        color: var(--primary);
    }

    .simple-meal-type-bubble:hover:not(.active) {
        border-color: #ccc;
        color: #666;
    }

    .simple-meal-textarea {
        width: 100%;
        min-height: 120px;
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        box-sizing: border-box;
        transition: border-color 0.2s ease;
    }

    .simple-meal-textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .simple-meal-submit {
        width: 100%;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 16px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 16px;
        transition: all 0.2s ease;
    }

    .simple-meal-submit:hover:not(:disabled) {
        background: var(--primary-light);
    }

    .simple-meal-submit:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Meal Input Modal Styles */
    .meal-input-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 10011;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .meal-input-modal.visible {
        display: flex;
    }

    .meal-input-container {
        width: 92%;
        max-width: 420px;
        background: white;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        max-height: 90vh;
        overflow-y: auto;
    }

    .meal-input-header {
        padding: 20px 24px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .meal-input-header h3 {
        margin: 0;
        font-size: 1.25rem;
        color: var(--primary);
    }

    .meal-input-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
        padding: 4px;
    }

    .meal-type-selector {
        display: flex;
        gap: 10px;
        padding: 20px 24px;
        background: #f8f9fa;
        overflow-x: auto;
    }

    .meal-type-btn {
        flex: 1;
        min-width: 70px;
        padding: 12px 8px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        background: white;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
    }

    .meal-type-btn.active {
        border-color: var(--primary);
        background: rgba(123, 168, 131, 0.1);
    }

    .meal-type-btn:hover:not(.active) {
        border-color: var(--primary-light);
    }

    .meal-type-emoji {
        font-size: 1.5rem;
        display: block;
        margin-bottom: 4px;
    }

    .meal-type-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .meal-type-btn.active .meal-type-label {
        color: var(--primary);
    }

    .meal-input-methods {
        padding: 24px;
    }

    .input-method-btn {
        width: 100%;
        padding: 18px 20px;
        margin-bottom: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.2s ease;
    }

    .input-method-btn:hover {
        border-color: var(--primary);
        background: rgba(123, 168, 131, 0.05);
        transform: translateX(4px);
    }

    .input-method-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .input-method-icon.photo { background: #e3f2fd; }
    .input-method-icon.text { background: #fff3e0; }
    .input-method-icon.voice { background: #fce4ec; }

    .input-method-info {
        flex: 1;
        text-align: left;
    }

    .input-method-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 2px;
    }

    .input-method-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    /* Text Input Section */
    .meal-text-section {
        display: none;
        padding: 24px;
        border-top: 1px solid #f0f0f0;
    }

    .meal-text-section.visible {
        display: block;
    }

    .meal-text-input {
        width: 100%;
        min-height: 100px;
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        transition: border-color 0.2s ease;
    }

    .meal-text-input:focus {
        outline: none;
        border-color: var(--primary);
    }

    .meal-text-input::placeholder {
        color: #aaa;
    }

    .meal-text-examples {
        margin-top: 12px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .meal-text-examples p {
        margin: 0 0 8px 0;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .meal-text-examples ul {
        margin: 0;
        padding-left: 20px;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .meal-text-examples li {
        margin-bottom: 4px;
    }

    /* Voice Input Section */
    .meal-voice-section {
        display: none;
        padding: 24px;
        border-top: 1px solid #f0f0f0;
        text-align: center;
    }

    .meal-voice-section.visible {
        display: block;
    }

    .voice-record-btn {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        font-size: 2.5rem;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        transition: all 0.2s ease;
        margin: 20px 0;
    }

    .voice-record-btn:hover {
        transform: scale(1.05);
    }

    .voice-record-btn.recording {
        animation: pulse-recording 1.5s infinite;
    }

    @keyframes pulse-recording {
        0%, 100% { transform: scale(1); box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4); }
        50% { transform: scale(1.1); box-shadow: 0 12px 35px rgba(239, 68, 68, 0.6); }
    }

    .voice-status {
        font-size: 0.95rem;
        color: var(--text-muted);
        margin: 15px 0;
    }

    .voice-transcript {
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
        min-height: 60px;
        text-align: left;
        font-size: 0.95rem;
        color: var(--text-main);
        margin-top: 15px;
    }

    .voice-transcript.empty {
        color: #aaa;
        font-style: italic;
    }

    .voice-transcript-wrapper {
        position: relative;
        margin-top: 15px;
    }

    .voice-transcript-wrapper .voice-transcript {
        margin-top: 0;
    }

    .voice-transcript-delete {
        display: block;
        margin: 12px auto 0;
        padding: 8px 20px;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .voice-transcript-delete:hover {
        background: #fee2e2;
        border-color: #fca5a5;
        color: #dc2626;
    }

    /* Submit Button */
    .meal-submit-section {
        padding: 20px 24px 24px;
        display: none;
    }

    .meal-submit-section.visible {
        display: block;
    }

    .meal-submit-btn {
        width: 100%;
        padding: 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 14px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .meal-submit-btn:hover {
        background: var(--primary-light);
    }

    .meal-submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Meals Log List */
    #meals-log-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .meal-log-card {
        background: white;
        border-radius: 12px;
        padding: 12px;
        display: flex;
        gap: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        align-items: center;
        transition: all 0.2s ease;
    }

    .meal-log-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .meal-log-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        background-size: cover;
        background-position: center;
        background-color: #f0f0f0;
        flex-shrink: 0;
    }

    .meal-log-content {
        flex: 1;
        min-width: 0;
    }

    .meal-log-time {
        font-size: 0.75rem;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .meal-type-tag {
        display: inline-block;
        background: rgba(123, 168, 131, 0.12);
        color: var(--primary);
        font-size: 0.6rem;
        font-weight: 700;
        padding: 1px 6px;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        vertical-align: middle;
        margin-right: 2px;
    }

    .meal-log-foods {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 6px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .meal-log-macros {
        display: flex;
        gap: 10px;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .meal-log-macros span {
        white-space: nowrap;
    }

    /* Verification Badge Styles */
    .verified-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        font-size: 0.65rem;
        font-weight: 700;
        background: #10b981;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
        margin-left: 6px;
        letter-spacing: 0.5px;
    }

    .verified-badge-pill {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        font-size: 0.65rem;
        background: #ecfdf5;
        color: #059669;
        border: 1px solid #10b981;
        padding: 1px 5px;
        border-radius: 10px;
        font-weight: 600;
    }

    .verified-badge-pill svg {
        width: 10px;
        height: 10px;
        fill: currentColor;
    }

    .meal-log-delete {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .meal-log-delete:hover {
        background: #fee2e2;
    }

    /* Make meal card clickable area */
    .meal-log-card {
        cursor: pointer;
    }

    .meal-log-card .meal-log-clickable {
        display: flex;
        gap: 12px;
        flex: 1;
        min-width: 0;
        align-items: center;
    }

    /* Meal Detail Popup Styles */
    .meal-detail-popup {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 10012;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
    }

    .meal-detail-popup.visible {
        display: flex;
    }

    .meal-detail-container {
        width: 92%;
        max-width: 400px;
        background: white;
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        max-height: 90vh;
        overflow-y: auto;
    }

    .meal-detail-photo {
        width: 100%;
        aspect-ratio: 4/3;
        background-size: cover;
        background-position: center;
        background-color: #f0f0f0;
        position: relative;
    }

    .meal-detail-photo-placeholder {
        width: 100%;
        aspect-ratio: 4/3;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        position: relative;
    }

    .meal-detail-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 36px;
        height: 36px;
        background: rgba(255,255,255,0.9);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: var(--text-muted);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
    }

    .meal-detail-close:hover {
        background: white;
        transform: scale(1.1);
    }

    .meal-detail-content {
        padding: 20px 24px 24px;
    }

    .meal-detail-header {
        margin-bottom: 16px;
    }

    .meal-detail-time {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .meal-detail-foods {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-main);
        line-height: 1.4;
    }

    .meal-detail-calories {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, rgba(123, 168, 131, 0.1) 0%, rgba(123, 168, 131, 0.05) 100%);
        border-radius: 16px;
        margin-bottom: 16px;
    }

    .meal-detail-calories-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary);
        line-height: 1;
    }

    .meal-detail-calories-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .meal-detail-macros {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .meal-detail-macro {
        text-align: center;
        padding: 16px 12px;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .meal-detail-macro-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1;
    }

    .meal-detail-macro-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 4px;
        font-weight: 500;
    }

    .meal-detail-macro.protein .meal-detail-macro-value {
        color: #ef4444;
    }

    .meal-detail-macro.carbs .meal-detail-macro-value {
        color: #f59e0b;
    }

    .meal-detail-macro.fat .meal-detail-macro-value {
        color: #3b82f6;
    }

    .meal-detail-items {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #f0f0f0;
    }

    .meal-detail-items-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .meal-detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f5f5f5;
    }

    .meal-detail-item:last-child {
        border-bottom: none;
    }

    .meal-detail-item-name {
        font-size: 0.95rem;
        color: var(--text-main);
        flex: 1;
    }

    .meal-detail-item-cals {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .meal-detail-edit-btn {
        display: block;
        width: 100%;
        margin-top: 16px;
        padding: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .meal-detail-edit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .meal-detail-edit-btn:active {
        transform: translateY(0);
    }

    /* Edit Items Modal Styles */
    .edit-items-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10015;
        padding: 20px;
    }

    .edit-items-modal.visible {
        display: flex;
    }

    .edit-items-container {
        background: white;
        border-radius: 20px;
        width: 100%;
        max-width: 420px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    }

    .edit-items-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #f0f0f0;
    }

    .edit-items-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-main);
    }

    .edit-items-close {
        width: 32px;
        height: 32px;
        border: none;
        background: #f5f5f5;
        border-radius: 50%;
        font-size: 1.2rem;
        color: #666;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .edit-items-close:hover {
        background: #eee;
    }

    .edit-items-list {
        flex: 0 1 auto;
        overflow-y: auto;
        padding: 16px 20px;
        max-height: 300px;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .edit-items-list::-webkit-scrollbar {
        display: none;
    }

    .edit-item-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 12px;
        margin-bottom: 10px;
    }

    .edit-item-row:last-child {
        margin-bottom: 0;
    }

    .edit-item-inputs {
        flex: 1;
        display: flex;
        gap: 8px;
    }

    .edit-item-input {
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
        background: white;
    }

    .edit-item-input.edit-item-name {
        flex: 1;
        min-width: 0;
    }

    .edit-item-input.edit-item-portion {
        max-width: 100px;
        flex-shrink: 0;
    }

    .edit-item-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    .edit-item-delete {
        width: 32px;
        height: 32px;
        border: none;
        background: #fee2e2;
        border-radius: 8px;
        color: #ef4444;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .edit-item-delete:hover {
        background: #fecaca;
    }

    .edit-items-add {
        display: flex;
        gap: 10px;
        padding: 0 20px 16px;
    }

    .edit-items-add input {
        flex: 1;
        min-width: 0;
        padding: 12px;
        border: 2px dashed #e0e0e0;
        border-radius: 12px;
        font-size: 0.9rem;
        background: #fafafa;
    }

    .edit-items-add input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
    }

    .edit-items-add button {
        padding: 12px 16px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .edit-items-add button:hover {
        background: #059669;
    }

    .edit-items-actions {
        display: flex;
        gap: 12px;
        padding: 16px 20px;
        border-top: 1px solid #f0f0f0;
        background: #fafafa;
    }

    .edit-items-cancel {
        flex: 1;
        padding: 14px;
        background: #f5f5f5;
        color: var(--text-muted);
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
    }

    .edit-items-cancel:hover {
        background: #eee;
    }

    .edit-items-recalculate {
        flex: 2;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .edit-items-recalculate:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .edit-items-recalculate:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .edit-items-empty {
        text-align: center;
        padding: 30px;
        color: var(--text-muted);
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
        .macros-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .calorie-circle {
            width: 160px;
            height: 160px;
        }

        .calorie-circle-current {
            font-size: 1.6rem;
        }

        .calorie-circle-goal {
            font-size: 1rem;
        }

        .meal-log-image {
            width: 60px;
            height: 60px;
        }

        .meal-log-macros {
            flex-wrap: wrap;
            gap: 6px;
        }
    }

    /* Learning Tab Styles */
    .learning-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e5e7eb;
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: learningSpin 0.8s linear infinite;
        margin: 0 auto;
    }

    @keyframes learningSpin {
        to { transform: rotate(360deg); }
    }

    .learning-module-card:active {
        transform: scale(0.98);
    }

    .learning-progress-ring {
        transform: rotate(-90deg);
    }

    .fill-blank-option:hover {
        border-color: var(--primary);
        background: var(--accent-green);
    }

    .fill-blank-option.selected {
        border-color: var(--primary);
        background: var(--accent-green);
    }

    .order-item:active {
        cursor: grabbing;
    }

    .match-item:hover:not(.matched) {
        border-color: #a5b4fc;
        background: #f5f3ff;
    }

    /* ========================================
       LEARNING MASCOT STYLES
       ======================================== */

    .learn-mascot {
        position: fixed;
        bottom: 100px;
        right: 20px;
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .learn-mascot.visible {
        display: flex;
    }

    .learn-mascot-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: hidden;
        border: 3px solid white;
    }

    .learn-mascot-avatar:hover {
        transform: scale(1.1);
    }

    .learn-mascot-avatar model-viewer {
        width: 120%;
        height: 120%;
        margin-top: 15px;
    }

    .learn-mascot-speech {
        position: absolute;
        bottom: 85px;
        right: 0;
        background: white;
        padding: 10px 14px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        font-size: 12px;
        font-weight: 600;
        color: #1a4d2e;
        max-width: 160px;
        text-align: center;
        opacity: 0;
        transform: translateY(10px) scale(0.9);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: none;
    }

    .learn-mascot-speech.visible {
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    .learn-mascot-speech::after {
        content: '';
        position: absolute;
        bottom: -8px;
        right: 20px;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid white;
    }

    /* Mascot Reactions */
    .learn-mascot-avatar.happy {
        animation: mascotHappy 0.6s ease;
    }

    .learn-mascot-avatar.sad {
        animation: mascotSad 0.5s ease;
    }

    .learn-mascot-avatar.excited {
        animation: mascotExcited 0.4s ease infinite;
    }

    .learn-mascot-avatar.thinking {
        animation: mascotThinking 1s ease-in-out infinite;
    }

    @keyframes mascotHappy {
        0%, 100% { transform: scale(1) rotate(0deg); }
        25% { transform: scale(1.2) rotate(-10deg); }
        50% { transform: scale(1.15) rotate(10deg); }
        75% { transform: scale(1.1) rotate(-5deg); }
    }

    @keyframes mascotSad {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(5px); }
    }

    @keyframes mascotExcited {
        0%, 100% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-8px) scale(1.1); }
    }

    @keyframes mascotThinking {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-3deg); }
        75% { transform: rotate(3deg); }
    }

    /* ============================================================
       BATTLE STATS SYSTEM - STR / HP / MANA
       ============================================================ */
    .battle-stats-row {
        display: flex;
        gap: 8px;
        padding: 8px 20px 0;
        background: linear-gradient(180deg, #16213e 0%, #1a1a2e 100%);
    }

    .battle-stat {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 6px;
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 5px 8px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .battle-stat:hover {
        background: rgba(255,255,255,0.1);
    }

    .battle-stat-icon {
        font-size: 0.75rem;
        line-height: 1;
    }

    .battle-stat-info {
        flex: 1;
        min-width: 0;
    }

    .battle-stat-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2px;
    }

    .battle-stat-name {
        font-size: 0.5rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255,255,255,0.6);
    }

    .battle-stat-value {
        font-size: 0.55rem;
        font-weight: 800;
        font-family: 'Outfit', sans-serif;
    }

    .battle-stat-bar {
        height: 4px;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .battle-stat-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .battle-stat.str .battle-stat-value { color: #ff6b6b; }
    .battle-stat.str .battle-stat-fill { background: linear-gradient(90deg, #ff4444, #ff6b6b); }

    .battle-stat.hp .battle-stat-value { color: #4ecdc4; }
    .battle-stat.hp .battle-stat-fill { background: linear-gradient(90deg, #2ecc71, #4ecdc4); }

    .battle-stat.mana .battle-stat-value { color: #45b7d1; }
    .battle-stat.mana .battle-stat-fill { background: linear-gradient(90deg, #3498db, #45b7d1); }

    /* ============================================================
       STAT ALLOCATION MODAL
       ============================================================ */
    .stat-alloc-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(8px);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease-out;
    }

    .stat-alloc-modal {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        border-radius: 24px;
        width: 100%;
        max-width: 380px;
        padding: 0;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(69,183,209,0.15);
        border: 1px solid rgba(255,255,255,0.1);
        animation: fadeInScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: hidden;
    }

    .stat-alloc-header {
        text-align: center;
        padding: 24px 20px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .stat-alloc-header h2 {
        margin: 0 0 4px;
        font-size: 1.3rem;
        font-weight: 800;
        color: #FFD700;
        text-shadow: 0 0 20px rgba(255,215,0,0.3);
    }

    .stat-alloc-points-left {
        font-size: 0.85rem;
        color: rgba(255,255,255,0.8);
        font-weight: 600;
    }

    .stat-alloc-points-left span {
        color: #FFD700;
        font-weight: 900;
        font-size: 1.1rem;
    }

    .stat-alloc-body {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .stat-alloc-row {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255,255,255,0.06);
        border-radius: 14px;
        padding: 14px;
        border: 1px solid rgba(255,255,255,0.08);
        transition: all 0.2s;
    }

    .stat-alloc-row:hover {
        background: rgba(255,255,255,0.1);
    }

    .stat-alloc-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        flex-shrink: 0;
    }

    .stat-alloc-icon.str { background: rgba(255,68,68,0.2); }
    .stat-alloc-icon.hp { background: rgba(46,204,113,0.2); }
    .stat-alloc-icon.mana { background: rgba(52,152,219,0.2); }

    .stat-alloc-details {
        flex: 1;
        min-width: 0;
    }

    .stat-alloc-name {
        font-size: 0.85rem;
        font-weight: 700;
        color: white;
        margin-bottom: 2px;
    }

    .stat-alloc-desc {
        font-size: 0.6rem;
        color: rgba(255,255,255,0.5);
    }

    .stat-alloc-current {
        font-size: 1.2rem;
        font-weight: 900;
        font-family: 'Outfit', sans-serif;
        min-width: 30px;
        text-align: center;
    }

    .stat-alloc-current.str { color: #ff6b6b; }
    .stat-alloc-current.hp { color: #4ecdc4; }
    .stat-alloc-current.mana { color: #45b7d1; }

    .stat-alloc-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 12px;
        font-size: 1.4rem;
        font-weight: 900;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .stat-alloc-btn.str { background: rgba(255,68,68,0.3); color: #ff6b6b; }
    .stat-alloc-btn.str:hover { background: rgba(255,68,68,0.5); transform: scale(1.1); }
    .stat-alloc-btn.hp { background: rgba(46,204,113,0.3); color: #4ecdc4; }
    .stat-alloc-btn.hp:hover { background: rgba(46,204,113,0.5); transform: scale(1.1); }
    .stat-alloc-btn.mana { background: rgba(52,152,219,0.3); color: #45b7d1; }
    .stat-alloc-btn.mana:hover { background: rgba(52,152,219,0.5); transform: scale(1.1); }

    .stat-alloc-btn:active {
        transform: scale(0.95);
    }

    .stat-alloc-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        transform: none !important;
    }

    .stat-alloc-footer {
        padding: 16px 20px 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .stat-alloc-confirm {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 14px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: #1a1a2e;
    }

    .stat-alloc-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255,215,0,0.4);
    }

    .stat-alloc-confirm:disabled {
        background: rgba(255,255,255,0.1);
        color: rgba(255,255,255,0.3);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    @keyframes statAllocPop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }

    .stat-pop {
        animation: statAllocPop 0.3s ease-out;
    }

    /* ============================================================
       BATTLE LEVEL GATE
       ============================================================ */
    .battle-trigger-btn.locked {
        opacity: 0.5;
        position: relative;
    }

    .battle-trigger-btn.locked::after {
        content: 'Lv.10';
        position: absolute;
        bottom: -14px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.45rem;
        font-weight: 800;
        color: rgba(255,255,255,0.6);
        white-space: nowrap;
        background: rgba(0,0,0,0.5);
        padding: 1px 5px;
        border-radius: 4px;
    }

    /* ============================================================
       BATTLE HP BARS (In-Battle)
       ============================================================ */
    .battle-hp-container {
        position: absolute;
        top: 12px;
        left: 12px;
        right: 12px;
        display: none;
        justify-content: space-between;
        z-index: 150;
        pointer-events: none;
    }

    .battle-hp-container.active {
        display: flex;
    }

    .battle-hp-box {
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(6px);
        border-radius: 10px;
        padding: 6px 10px;
        min-width: 120px;
        border: 1px solid rgba(255,255,255,0.15);
    }

    .battle-hp-box.enemy {
        text-align: right;
    }

    .battle-hp-name {
        font-size: 0.6rem;
        font-weight: 700;
        color: rgba(255,255,255,0.8);
        margin-bottom: 3px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .battle-hp-bar-bg {
        height: 6px;
        background: rgba(255,255,255,0.15);
        border-radius: 6px;
        overflow: hidden;
    }

    .battle-hp-bar-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.4s ease-out;
    }

    .battle-hp-bar-fill.player {
        background: linear-gradient(90deg, #2ecc71, #4ecdc4);
    }

    .battle-hp-bar-fill.enemy {
        background: linear-gradient(90deg, #e74c3c, #ff6b6b);
    }

    .battle-hp-text {
        font-size: 0.5rem;
        font-weight: 800;
        color: rgba(255,255,255,0.7);
        margin-top: 2px;
        font-family: 'Outfit', sans-serif;
    }

    /* ============================================================
       BATTLE MANA BAR (In-Battle)
       ============================================================ */
    .battle-mana-container {
        position: absolute;
        bottom: 65px;
        left: 12px;
        right: 12px;
        z-index: 150;
        pointer-events: none;
        display: none;
    }

    .battle-mana-container.active {
        display: block;
    }

    .battle-mana-label {
        font-size: 0.5rem;
        font-weight: 700;
        color: rgba(255,255,255,0.6);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
    }

    .battle-mana-bar-bg {
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    .battle-mana-bar-fill {
        height: 100%;
        border-radius: 8px;
        background: linear-gradient(90deg, #3498db, #45b7d1, #9b59b6);
        transition: width 0.2s linear;
        box-shadow: 0 0 8px rgba(52,152,219,0.4);
    }

    .battle-mana-bar-fill.full {
        animation: manaReady 0.5s ease-in-out infinite alternate;
    }

    @keyframes manaReady {
        0% { box-shadow: 0 0 8px rgba(52,152,219,0.4); }
        100% { box-shadow: 0 0 20px rgba(155,89,182,0.8); }
    }

    /* ============================================================
       BATTLE BASH BUTTON (Digimon-style single button)
       ============================================================ */
    .battle-action-container {
        position: absolute;
        bottom: 12px;
        right: 12px;
        z-index: 200;
        display: none;
        pointer-events: none;
    }

    .battle-action-container.active {
        display: flex;
        align-items: center;
        gap: 12px;
        pointer-events: auto;
    }

    .battle-bash-btn {
        width: 80px;
        height: 80px;
        border: none;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #ff6b4a, #e63946);
        color: white;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0;
        position: relative;
        box-shadow: 0 4px 20px rgba(230,57,70,0.5), inset 0 2px 4px rgba(255,255,255,0.2);
        transition: transform 0.05s;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        touch-action: manipulation;
    }

    .battle-bash-btn:active {
        transform: scale(0.88);
        box-shadow: 0 2px 10px rgba(230,57,70,0.7), inset 0 2px 4px rgba(0,0,0,0.2);
    }

    .battle-bash-btn .bash-icon {
        font-size: 1.5rem;
        line-height: 1;
    }

    .battle-bash-btn .bash-label {
        font-size: 0.55rem;
        font-weight: 900;
        letter-spacing: 1px;
        text-transform: uppercase;
    }


    .battle-bash-btn .bash-progress-ring {
        position: absolute;
        inset: -4px;
        pointer-events: none;
    }

    .battle-bash-btn .bash-progress-ring svg {
        width: 100%;
        height: 100%;
    }

    .bash-ring-bg {
        fill: none;
        stroke: rgba(255,255,255,0.15);
        stroke-width: 3;
    }

    .bash-ring-fill {
        fill: none;
        stroke: #FFD700;
        stroke-width: 3;
        stroke-dasharray: 163.36;
        stroke-dashoffset: 163.36;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.1s;
        transform: rotate(-90deg);
        transform-origin: center;
    }

    .battle-bash-btn.attack-ready {
        animation: bashReady 0.3s ease-in-out infinite alternate;
        background: radial-gradient(circle at 30% 30%, #FFD700, #ff8c00);
    }

    @keyframes bashReady {
        0% { box-shadow: 0 0 15px rgba(255,215,0,0.5); transform: scale(1); }
        100% { box-shadow: 0 0 30px rgba(255,215,0,0.9); transform: scale(1.05); }
        box-shadow: inset 0 0 15px rgba(255,215,0,0.3);
    }

    @keyframes bashRumble {
        0%   { transform: translate(0, 0) scale(0.92); }
        15%  { transform: translate(-4px, 2px) scale(0.92); }
        30%  { transform: translate(4px, -2px) scale(0.95); }
        45%  { transform: translate(-3px, -1px) scale(0.97); }
        60%  { transform: translate(3px, 1px) scale(0.99); }
        75%  { transform: translate(-1px, 1px) scale(1); }
        100% { transform: translate(0, 0) scale(1); }
    }

    .battle-bash-btn.bash-rumble {
        animation: bashRumble 0.35s ease-out;
    }

    /* FIRE and BLOCK action buttons */
    .battle-action-btn {
        width: 64px;
        height: 64px;
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0;
        position: relative;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        touch-action: manipulation;
        animation: actionBtnAppear 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .battle-action-btn .action-btn-icon { font-size: 1.3rem; line-height: 1; }
    .battle-action-btn .action-btn-label { font-size: 0.5rem; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; }
    .battle-action-btn:active { transform: scale(0.85); }

    .battle-fire-btn {
        background: radial-gradient(circle at 30% 30%, #FFD700, #ff6b00);
        box-shadow: 0 0 20px rgba(255,215,0,0.7), 0 0 40px rgba(255,107,0,0.4);
        animation: actionBtnAppear 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), firePulse 0.5s ease-in-out infinite alternate;
    }
    @keyframes firePulse {
        0% { box-shadow: 0 0 15px rgba(255,215,0,0.6), 0 0 30px rgba(255,107,0,0.3); transform: scale(1); }
        100% { box-shadow: 0 0 25px rgba(255,215,0,0.9), 0 0 50px rgba(255,107,0,0.5); transform: scale(1.08); }
    }

    .battle-block-btn {
        background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb);
        box-shadow: 0 0 20px rgba(96,165,250,0.7), 0 0 40px rgba(37,99,235,0.4);
        animation: actionBtnAppear 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), blockPulse 0.4s ease-in-out infinite alternate;
    }
    @keyframes blockPulse {
        0% { box-shadow: 0 0 15px rgba(96,165,250,0.6), 0 0 30px rgba(37,99,235,0.3); transform: scale(1); }
        100% { box-shadow: 0 0 25px rgba(96,165,250,0.9), 0 0 50px rgba(37,99,235,0.5); transform: scale(1.08); }
    }

    @keyframes actionBtnAppear {
        0% { transform: scale(0); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    @keyframes actionBtnDisappear {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(0); opacity: 0; }
    }

    /* Shield overlay when block succeeds */
    .battle-shield-overlay {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at center, rgba(96,165,250,0.3) 0%, transparent 70%);
        border: 3px solid rgba(96,165,250,0.6);
        border-radius: 12px;
        z-index: 997;
        pointer-events: none;
        animation: shieldFlash 0.5s ease-out forwards;
    }
    @keyframes shieldFlash {
        0% { opacity: 1; transform: scale(0.95); }
        50% { opacity: 0.8; transform: scale(1.02); }
        100% { opacity: 0; transform: scale(1); }
    }

    /* Battle screen shake */
    @keyframes battleShake {
        0%, 100% { transform: translateX(0); }
        10%, 50%, 70% { transform: translateX(-6px); }
        30%, 60% { transform: translateX(6px); }
        80% { transform: translateX(-3px); }
        90% { transform: translateX(3px); }
    }

    /* Round transition overlay */
    .battle-round-text {
        font-size: 2.5rem;
        font-weight: 900;
        color: white;
        text-shadow: 0 0 30px rgba(255,255,255,0.5);
        animation: roundTextPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-align: center;
        line-height: 1.3;
    }
    .battle-round-score {
        font-size: 1.2rem;
        font-weight: 700;
        color: rgba(255,255,255,0.7);
        margin-top: 8px;
        letter-spacing: 3px;
    }
    @keyframes roundTextPop {
        0% { transform: scale(0.3); opacity: 0; }
        60% { transform: scale(1.15); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* ============================================================
       MOVE PICKER (Pre-Battle)
       ============================================================ */
    .move-picker-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.8);
        backdrop-filter: blur(8px);
        z-index: 200;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease-out;
    }

    .move-picker-title {
        font-size: 0.9rem;
        font-weight: 800;
        color: #FFD700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 16px;
    }

    .move-picker-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        width: 100%;
        max-width: 280px;
    }

    .move-picker-item {
        background: rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 14px;
        padding: 12px 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }

    .move-picker-item:hover {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,215,0,0.5);
        transform: scale(1.05);
    }

    .move-picker-item:active {
        transform: scale(0.97);
    }

    .move-picker-item .pick-icon {
        font-size: 1.6rem;
        margin-bottom: 4px;
    }

    .move-picker-item .pick-name {
        font-size: 0.7rem;
        font-weight: 700;
        color: white;
    }

    .move-picker-item .pick-power {
        font-size: 0.55rem;
        color: rgba(255,255,255,0.5);
        margin-top: 2px;
    }

    /* ============================================================
       BATTLE INVITE MODAL
       ============================================================ */
    .battle-invite-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(8px);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease-out;
    }

    .battle-invite-modal {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        border-radius: 24px;
        width: 100%;
        max-width: 380px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(220,50,50,0.15);
        border: 1px solid rgba(255,255,255,0.1);
        animation: fadeInScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: hidden;
    }

    .battle-invite-header {
        text-align: center;
        padding: 24px 20px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .battle-invite-header h2 {
        margin: 0 0 4px;
        font-size: 1.3rem;
        font-weight: 800;
        color: #ff6b6b;
        text-shadow: 0 0 20px rgba(255,107,107,0.3);
    }

    .battle-invite-header p {
        margin: 0;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.6);
    }

    .battle-invite-body {
        padding: 12px 16px;
        overflow-y: auto;
        flex: 1;
    }

    .battle-invite-friend {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 14px;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.08);
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .battle-invite-friend:hover {
        background: rgba(255,255,255,0.12);
        border-color: rgba(255,100,100,0.3);
    }

    .battle-invite-friend:active {
        transform: scale(0.98);
    }

    .battle-invite-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(255,100,100,0.3), rgba(255,150,100,0.3));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
    }

    .battle-invite-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .battle-invite-info {
        flex: 1;
        min-width: 0;
    }

    .battle-invite-name {
        font-size: 0.9rem;
        font-weight: 700;
        color: white;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .battle-invite-status {
        font-size: 0.65rem;
        color: rgba(255,255,255,0.5);
        margin-top: 2px;
    }

    .battle-invite-status.active {
        color: #4ecdc4;
    }

    .battle-invite-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.15s;
        background: linear-gradient(135deg, rgba(255,68,68,0.6), rgba(255,100,100,0.4));
        color: white;
        border: 1px solid rgba(255,100,100,0.4);
        flex-shrink: 0;
    }

    .battle-invite-btn:hover {
        background: linear-gradient(135deg, rgba(255,68,68,0.8), rgba(255,100,100,0.6));
        transform: scale(1.05);
    }

    .battle-invite-footer {
        padding: 12px 16px 16px;
        border-top: 1px solid rgba(255,255,255,0.1);
        text-align: center;
    }

    .battle-invite-close {
        padding: 10px 24px;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        background: transparent;
        color: rgba(255,255,255,0.7);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .battle-invite-close:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }

    .battle-invite-empty {
        text-align: center;
        padding: 30px 20px;
    }

    .battle-invite-empty .empty-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }

    .battle-invite-empty .empty-text {
        font-size: 0.85rem;
        color: rgba(255,255,255,0.6);
        margin-bottom: 16px;
    }

    .battle-invite-empty .empty-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 12px;
        background: var(--primary, #7BA883);
        color: white;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
    }

    /* Challenge Buy-In Modal (Battle-mode style) */
    .challenge-buyin-modal {
        background: linear-gradient(135deg, #1a1a2e 0%, #2e1a0e 50%, #3d2e0a 100%);
        border-radius: 24px;
        width: 100%;
        max-width: 380px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(245,158,11,0.15);
        border: 1px solid rgba(255,255,255,0.1);
        animation: fadeInScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: hidden;
    }

    .challenge-buyin-header {
        text-align: center;
        padding: 24px 20px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .challenge-buyin-header h2 {
        margin: 0 0 4px;
        font-size: 1.3rem;
        font-weight: 800;
        color: #fbbf24;
        text-shadow: 0 0 20px rgba(251,191,36,0.3);
    }

    .challenge-buyin-header p {
        margin: 0;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.6);
    }

    .challenge-buyin-body {
        padding: 12px 16px;
        overflow-y: auto;
        flex: 1;
    }

    .challenge-buyin-benefits {
        background: rgba(251,191,36,0.1);
        border: 1px solid rgba(251,191,36,0.2);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 14px;
    }

    .challenge-buyin-benefit {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }

    .challenge-buyin-benefit:last-child {
        margin-bottom: 0;
    }

    .challenge-buyin-benefit span.check {
        color: #fbbf24;
        font-size: 0.9rem;
        font-weight: 700;
    }

    .challenge-buyin-benefit span.text {
        color: rgba(255,255,255,0.8);
        font-size: 0.82rem;
    }

    .challenge-bet-btn {
        flex: 1;
        min-width: 60px;
        padding: 8px;
        background: rgba(255,255,255,0.08);
        border: 2px solid rgba(255,255,255,0.15);
        border-radius: 8px;
        color: white;
        font-weight: 700;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.15s;
    }

    .challenge-bet-btn:hover {
        background: rgba(251,191,36,0.15);
        border-color: rgba(251,191,36,0.4);
    }

    .challenge-bet-btn.active {
        background: rgba(251,191,36,0.2);
        border-color: rgba(251,191,36,0.6);
    }

    .challenge-buyin-footer {
        padding: 12px 16px 16px;
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
    }

    .challenge-buyin-join-btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 700;
        cursor: pointer;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(245,158,11,0.3);
        transition: all 0.2s;
    }

    .challenge-buyin-join-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 20px rgba(245,158,11,0.4);
    }

    .challenge-buyin-join-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .challenge-buyin-secondary-btn {
        width: 100%;
        padding: 10px;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        background: transparent;
        color: rgba(255,255,255,0.7);
        font-size: 0.82rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .challenge-buyin-secondary-btn:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }

    .challenge-buyin-cancel {
        background: none;
        border: none;
        color: rgba(255,255,255,0.4);
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 2px;
        transition: color 0.2s;
    }

    .challenge-buyin-cancel:hover {
        color: rgba(255,255,255,0.7);
    }

    /* Waiting for opponent overlay */
    .battle-waiting-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        z-index: 200;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease-out;
    }

    .battle-waiting-text {
        font-size: 0.9rem;
        font-weight: 700;
        color: white;
        margin-bottom: 8px;
    }

    .battle-waiting-sub {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.6);
        margin-bottom: 20px;
    }

    .battle-waiting-spinner {
        width: 30px;
        height: 30px;
        border: 3px solid rgba(255,255,255,0.2);
        border-top-color: #ff6b6b;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .battle-waiting-cancel {
        padding: 8px 20px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 10px;
        background: transparent;
        color: rgba(255,255,255,0.7);
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
    }

    /* Incoming battle challenge notification */
    .battle-challenge-toast {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background: linear-gradient(135deg, #1a1a2e, #2d1515);
        border: 2px solid rgba(255,100,100,0.5);
        border-radius: 20px;
        padding: 16px 20px;
        z-index: 10002;
        box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 0 20px rgba(255,100,100,0.2);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        min-width: 280px;
        max-width: 340px;
    }

    .battle-challenge-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .battle-challenge-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
    }

    .battle-challenge-icon {
        font-size: 1.5rem;
    }

    .battle-challenge-title {
        font-size: 0.85rem;
        font-weight: 800;
        color: #ff6b6b;
    }

    .battle-challenge-from {
        font-size: 0.75rem;
        color: rgba(255,255,255,0.7);
    }

    .battle-challenge-actions {
        display: flex;
        gap: 8px;
    }

    .battle-challenge-accept {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, #ff4444, #ff6b6b);
        color: white;
        font-size: 0.85rem;
        font-weight: 700;
        cursor: pointer;
    }

    .battle-challenge-decline {
        padding: 10px 16px;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        background: transparent;
        color: rgba(255,255,255,0.6);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
    }

    /* ============================================================
       BACKGROUND THEMES
       ============================================================ */
    .tamagotchi-bg-gym {
        background: url('./assets/gym_bg.jpeg') center center / cover no-repeat !important;
    }

    .tamagotchi-bg-gym::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.15);
        pointer-events: none;
        z-index: 0;
    }

    .tamagotchi-bg-park {
        background: linear-gradient(180deg, #0d2b1a 0%, #1a3d2e 40%, #0d2b1a 100%) !important;
    }

    .tamagotchi-bg-park::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background:
            radial-gradient(ellipse 20% 40% at 10% 50%, rgba(34,139,34,0.1) 0%, transparent 100%),
            radial-gradient(ellipse 15% 30% at 90% 55%, rgba(34,139,34,0.08) 0%, transparent 100%);
        pointer-events: none;
        z-index: 0;
    }

    .tamagotchi-bg-dojo {
        background: url('./assets/battle_dojo_bg.jpeg') center center / cover no-repeat !important;
    }

    .tamagotchi-bg-dojo::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.15);
        pointer-events: none;
        z-index: 0;
    }

    .tamagotchi-bg-beach {
        background: linear-gradient(180deg, #0a192f 0%, #0d2847 40%, #14344e 100%) !important;
    }

    .tamagotchi-bg-beach::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background:
            radial-gradient(ellipse 60% 15% at 50% 90%, rgba(194,178,128,0.1) 0%, transparent 100%),
            radial-gradient(ellipse 30% 20% at 80% 30%, rgba(255,255,200,0.03) 0%, transparent 100%);
        pointer-events: none;
        z-index: 0;
    }

    .tamagotchi-bg-home {
        background: linear-gradient(180deg, #1a1612 0%, #2a2218 40%, #1a1612 100%) !important;
    }

    .tamagotchi-bg-home::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background:
            radial-gradient(ellipse 40% 40% at 50% 60%, rgba(255,180,80,0.08) 0%, transparent 100%),
            radial-gradient(ellipse 20% 25% at 20% 70%, rgba(200,160,100,0.06) 0%, transparent 100%);
        pointer-events: none;
        z-index: 0;
    }

    .tamagotchi-bg-mountain {
        background: linear-gradient(180deg, #0f1a2e 0%, #1a2a3e 40%, #0f1a2e 100%) !important;
    }

    .tamagotchi-bg-mountain::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background:
            radial-gradient(ellipse 50% 30% at 50% 75%, rgba(200,200,220,0.06) 0%, transparent 100%),
            radial-gradient(ellipse 30% 20% at 30% 60%, rgba(180,200,220,0.05) 0%, transparent 100%),
            radial-gradient(ellipse 25% 15% at 70% 65%, rgba(180,200,220,0.04) 0%, transparent 100%);
        pointer-events: none;
        z-index: 0;
    }

    .tamagotchi-bg-arena {
        background: linear-gradient(180deg, #0a0015 0%, #1a0040 40%, #0a0015 100%) !important;
    }

    .tamagotchi-bg-arena::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background:
            radial-gradient(ellipse 50% 50% at 50% 50%, rgba(155,89,182,0.08) 0%, transparent 100%),
            radial-gradient(ellipse 30% 30% at 50% 50%, rgba(255,215,0,0.05) 0%, transparent 100%);
        pointer-events: none;
        z-index: 0;
        animation: arenaGlow 3s ease-in-out infinite alternate;
    }

    @keyframes arenaGlow {
        0% { opacity: 0.6; }
        100% { opacity: 1; }
    }

    /* Character model-viewer: starts opaque (matching container) during load,
       then JS switches to transparent after model loads so 3D background shows through.
       This ensures Safari users see the dark bg instead of a blank void while loading. */
    #tamagotchi-model {
        --poster-color: #1a1a2e;
    }
    #tamagotchi-model.model-loaded {
        background: transparent !important;
        --poster-color: transparent;
    }

    /* 3D background model-viewer fills behind the character */
    #tamagotchi-bg-model {
        background: transparent !important;
        --poster-color: transparent;
    }

    /* Selected background highlight in Unlocks panel */
    .bg-selected {
        border: 2px solid #4ade80 !important;
        box-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
    }

    /* ===== Login Loading Overlay ===== */
    .login-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg, #f9f9f7);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    .login-loading-overlay.fade-out {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
    }
    .login-loading-logo {
        width: 80px;
        height: 80px;
        margin-bottom: 32px;
        border-radius: 20px;
        animation: loadingPulse 2s ease-in-out infinite;
    }
    @keyframes loadingPulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.85; }
    }
    .login-loading-text {
        font-family: 'Inter', sans-serif;
        font-size: 15px;
        font-weight: 500;
        color: var(--text-muted, #718096);
        margin-bottom: 20px;
        min-height: 22px;
        transition: opacity 0.3s ease;
    }
    .login-loading-bar-track {
        width: 220px;
        height: 6px;
        background: rgba(0,0,0,0.08);
        border-radius: 3px;
        overflow: hidden;
    }
    .login-loading-bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--primary, #7BA883), var(--primary-light, #98C9A3));
        border-radius: 3px;
        transition: width 0.6s ease;
    }

    </style>
</head>
<body>
<!-- Login Loading Overlay -->
<div id="login-loading-overlay" class="login-loading-overlay">
    <img src="assets/Logo_dots.jpg" alt="FitGotchi" class="login-loading-logo">
    <div id="login-loading-text" class="login-loading-text">Loading your dashboard...</div>
    <div class="login-loading-bar-track">
        <div id="login-loading-bar" class="login-loading-bar-fill"></div>
    </div>
</div>

<!-- Learning Mascot Character (Mini Tamagotchi) -->
<div class="learn-mascot" id="learnMascot">
    <div class="learn-mascot-speech" id="learnMascotSpeech">You got this!</div>
    <div class="learn-mascot-avatar" id="learnMascotAvatar" onclick="window.LearningMascot?.tapped()">
        <model-viewer
            id="mascot-model"
            src="https://f005.backblazeb2.com/file/shannonsvideos/level_1_good_final.glb"
            camera-orbit="0deg 85deg 2.5m"
            field-of-view="30deg"
            disable-zoom
            disable-pan
            auto-rotate
            rotation-per-second="30deg"
            shadow-intensity="0"
            exposure="1.2"
            style="width: 100%; height: 100%; pointer-events: none; --poster-color: transparent;"
            interaction-prompt="none">
        </model-viewer>
    </div>
</div>

<div class="container">
<!-- DASHBOARD VIEW (HOME) -->
<div id="view-dashboard" class="app-view">
    <div class="app-header">
        <div class="app-logo">Home</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div id="tamagotchi-streak-container" class="streak-header-widget">
                <span style="font-size: 0.85rem;">🔥</span>
                <span id="tamagotchi-streak" class="streak-header-count">0</span>
            </div>
            <div class="coin-header-widget" onclick="openCoinShop()">
                <span class="coin-emoji">🪙</span>
                <span class="coin-amount coin-balance-sync">0</span>
                <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
            </div>
            <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
        </div>
    </div>
    <div class="dashboard-welcome">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <span id="daily-progress-counter" class="welcome-text" style="display: none; color: white; font-weight: 700;">Day 1 of 28</span>
        </div>
        <!-- Tamagotchi Widget (Modern Header View) -->
        <div id="tamagotchi-widget-container" style="background: #1a1a2e; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 0; overflow: hidden; margin: 0; height: 420px; position: relative;">
            <!-- Room floor with perspective depth (hidden when static bg is active) -->
            <div id="tamagotchi-floor" style="position: absolute; bottom: 0; left: 0; right: 0; height: 55%; background: linear-gradient(180deg, transparent 0%, rgba(30,40,60,0.3) 20%, rgba(40,55,80,0.6) 50%, rgba(50,70,100,0.8) 80%, rgba(60,85,120,0.95) 100%); transform: perspective(500px) rotateX(25deg); transform-origin: bottom center; pointer-events: none; z-index: 1; display: none;"></div>
            <!-- Static gym background image -->
            <div id="tamagotchi-static-bg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; display: none;"></div>
            <!-- 3D Background Environment - part of the scene with camera sync -->
            <model-viewer
                id="tamagotchi-bg-model"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; display: none; pointer-events: none; background: transparent;"
                camera-orbit="0deg 85deg 8.0m"
                camera-target="0m -0.1m 0m"
                field-of-view="16deg"
                min-field-of-view="5deg"
                max-field-of-view="120deg"
                shadow-intensity="0.8"
                exposure="1.0"
                environment-image="neutral"
                interaction-prompt="none"
                disable-zoom
                disable-pan>
            </model-viewer>
            <!-- Character model - starts with visible background, goes transparent after load so 3D environment shows through -->
            <!-- src is set dynamically below to avoid baby model flash for returning users -->
            <model-viewer
                id="tamagotchi-model"
                camera-controls
                disable-zoom
                disable-pan
                auto-rotate
                loading="eager"
                rotation-intensity="0.5"
                shadow-intensity="1.5"
                shadow-softness="0.8"
                exposure="0.9"
                environment-image="neutral"
                camera-orbit="0deg 85deg 22m"
                field-of-view="55deg"
                min-field-of-view="20deg"
                max-field-of-view="120deg"
                style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 3; --poster-color: #1a1a2e; touch-action: pan-y; background: #1a1a2e;"
                interaction-prompt="none">
            </model-viewer>
            <script>
            // Set model src from cache (returning users) or default to baby (new users).
            // Runs before model-viewer custom element registers, so the correct model loads from the start.
            (function() {
                var mv = document.getElementById('tamagotchi-model');
                if (!mv) return;

                var cachedModel = window._fitgotchiCachedModel || localStorage.getItem('fitgotchi_model_src');
                var cachedOrbit = localStorage.getItem('fitgotchi_camera_orbit');
                var cachedFov = localStorage.getItem('fitgotchi_fov');
                var cachedScale = localStorage.getItem('fitgotchi_scale');
                var isReturning = localStorage.getItem('dashboardInitialized') === 'true';

                if (isReturning && cachedModel) {
                    mv.setAttribute('src', cachedModel);
                    if (cachedOrbit) mv.setAttribute('camera-orbit', cachedOrbit);
                    if (cachedFov) mv.setAttribute('field-of-view', cachedFov);
                    if (cachedScale) {
                        mv.style.transform = cachedScale;
                        mv.style.transformOrigin = 'center center';
                    }
                } else {
                    mv.setAttribute('src', 'https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb');
                }

                // After model loads, add class to make background transparent so 3D environment shows through.
                // Keeping it opaque during load ensures Safari users see a dark bg instead of a blank void.
                mv.addEventListener('load', function() {
                    mv.classList.add('model-loaded');
                });
            })();
            </script>

            <!-- Fallback: only shown if model-viewer script fails to register or model errors -->
            <div id="tamagotchi-fallback" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:4; background:#1a1a2e; justify-content:center; align-items:center; flex-direction:column; text-align:center; color:white; padding:20px;">
                <div style="font-size:64px; margin-bottom:12px;">🐣</div>
                <div style="font-size:1.1rem; font-weight:700; margin-bottom:6px;">Your FitGotchi</div>
                <div id="tamagotchi-fallback-msg" style="font-size:0.8rem; color:rgba(255,255,255,0.6);">Loading your character...</div>
            </div>
            <script>
            // Fallback detection — only triggers for genuine failures.
            // Does NOT use canvas pixel checks (unreliable with preserveDrawingBuffer:false).
            (function() {
                var mv = document.getElementById('tamagotchi-model');
                var fb = document.getElementById('tamagotchi-fallback');
                if (!mv || !fb) return;

                var loaded = false;
                var fallbackShown = false;

                function showFallback(msg) {
                    if (fallbackShown) return;
                    fallbackShown = true;
                    var msgEl = document.getElementById('tamagotchi-fallback-msg');
                    if (msgEl && msg) msgEl.textContent = msg;
                    fb.style.display = 'flex';
                    mv.style.display = 'none';
                }

                // Listen for successful load
                mv.addEventListener('load', function() { loaded = true; });

                // Listen for explicit errors (e.g. GLB fetch failure)
                mv.addEventListener('error', function() {
                    showFallback('Could not load 3D model. Please check your connection and reload.');
                });

                // Check if model-viewer custom element registered (script loaded).
                // If the ES module script failed (e.g. blocked by privacy settings),
                // the custom element won't be defined and model-viewer is inert.
                setTimeout(function() {
                    if (!customElements.get('model-viewer')) {
                        showFallback('3D viewer could not load. Please try reloading the page.');
                        return;
                    }
                }, 5000);

                // Final timeout: if model hasn't loaded after 20s, show fallback.
                // Generous timeout to give Safari extra time for WebGL initialization.
                setTimeout(function() {
                    if (!loaded && !fallbackShown) {
                        showFallback('Taking too long to load. Please try reloading the page.');
                    }
                }, 20000);
            })();
            </script>

            <!-- Level Up Celebration Overlay (appears inside Tamagotchi widget) -->
            <div id="tamagotchi-levelup-overlay" class="tamagotchi-levelup-overlay">
                <!-- Burst effect, sparkles, and stars will be dynamically injected here -->
            </div>

            <!-- Level Up Banner (appears at top of Tamagotchi during celebration) -->
            <div id="levelup-banner" class="levelup-banner" style="display: none;">
                <div class="levelup-banner-text">
                    <div class="levelup-banner-title">LEVEL UP!</div>
                    <div class="levelup-banner-level">
                        <span class="star-icon">⭐</span>
                        <span id="levelup-banner-number">2</span>
                        <span class="star-icon">⭐</span>
                    </div>
                    <div id="levelup-banner-rank" class="levelup-banner-rank">Newcomer</div>
                    <!-- Unlocked move display (shown if a move was unlocked) -->
                    <div id="levelup-unlocked-container" class="levelup-unlocked-move" style="display: none;">
                        <div class="levelup-unlocked-label">New Move Unlocked!</div>
                        <div id="levelup-unlocked-name" class="levelup-unlocked-name">
                            <span id="levelup-unlocked-icon" class="levelup-unlocked-icon">🎬</span>
                            <span id="levelup-unlocked-text">Victory</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Arena Trigger Button -->
            <div class="arena-trigger-btn" onclick="event.stopPropagation(); showArenaInviteModal();" title="Arena Mode">
                🗺️
            </div>

            <!-- Battle Trigger Button -->
            <div class="battle-trigger-btn" onclick="event.stopPropagation(); startBattle();" title="Battle Mode">
                🥊
            </div>

            <!-- Animation Selector Button -->
            <div class="animation-trigger-btn" onclick="showAnimationSelector()" title="Unlocks">
                🎬
            </div>

            <!-- Battle Overlay -->
            <div id="battle-mode-overlay" class="battle-overlay">
                <div class="battle-text">BATTLE!</div>
            </div>

            <!-- Battle HP Bars (shown during battle) -->
            <div id="battle-hp-container" class="battle-hp-container">
                <div class="battle-hp-box player">
                    <div class="battle-hp-name">YOU</div>
                    <div class="battle-hp-bar-bg">
                        <div id="battle-hp-player" class="battle-hp-bar-fill player" style="width: 100%;"></div>
                    </div>
                    <div id="battle-hp-player-text" class="battle-hp-text">500 / 500</div>
                </div>
                <div class="battle-hp-box enemy">
                    <div class="battle-hp-name">OPPONENT</div>
                    <div class="battle-hp-bar-bg">
                        <div id="battle-hp-enemy" class="battle-hp-bar-fill enemy" style="width: 100%;"></div>
                    </div>
                    <div id="battle-hp-enemy-text" class="battle-hp-text">500 / 500</div>
                </div>
            </div>

            <!-- Battle Mana Bar (shown during battle) -->
            <div id="battle-mana-container" class="battle-mana-container">
                <div class="battle-mana-label">SPECIAL <span id="battle-mana-pct">0%</span></div>
                <div class="battle-mana-bar-bg">
                    <div id="battle-mana-fill" class="battle-mana-bar-fill" style="width: 0%;"></div>
                </div>
            </div>

            <!-- Battle Action Buttons -->
            <div id="battle-action-container" class="battle-action-container">
                <!-- Block button (appears before incoming attacks) -->
                <button id="battle-btn-block" class="battle-action-btn battle-block-btn" style="display:none;">
                    <span class="action-btn-icon">🛡️</span>
                    <span class="action-btn-label">BLOCK</span>
                </button>
                <!-- Fire button (appears when super is charged) -->
                <button id="battle-btn-fire" class="battle-action-btn battle-fire-btn" style="display:none;">
                    <span class="action-btn-icon">🔥</span>
                    <span class="action-btn-label">FIRE!</span>
                </button>
                <!-- Bash button (always visible during battle) -->
                <button id="battle-btn-bash" class="battle-bash-btn">
                    <span class="bash-icon">👊</span>
                    <span class="bash-label">BASH!</span>
                    <div class="bash-progress-ring">
                        <svg viewBox="0 0 60 60">
                            <circle cx="30" cy="30" r="26" class="bash-ring-bg"/>
                            <circle cx="30" cy="30" r="26" class="bash-ring-fill" id="bash-ring-fill"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>

        <!-- Tamagotchi Stats Bar (Below Character) -->
        <div id="tamagotchi-stats-bar" style="background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; margin: 0; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
            <!-- Level & XP Section -->
            <div style="display: flex; align-items: center; gap: 14px;">
                <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 8px 14px; min-width: 60px; text-align: center;">
                    <div style="color: #888; font-size: 0.55rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Level</div>
                    <div id="tamagotchi-level" style="color: #fff; font-size: 1.6rem; font-weight: 900; line-height: 1; font-family: 'Outfit', sans-serif;">1</div>
                </div>
                <div style="flex: 1;">
                    <div id="tamagotchi-xp-text" style="color: rgba(255,255,255,0.8); font-size: 0.7rem; font-weight: 600; margin-bottom: 5px; letter-spacing: 0.3px;">0 / 8 XP to Level 2</div>
                    <div style="width: 120px; height: 7px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
                        <div id="tamagotchi-xp-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary-light)); transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);"></div>
                    </div>
                </div>
            </div>

            <!-- Rank Section -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="tamagotchi-rank" style="color: var(--secondary); font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">NEWCOMER</div>
            </div>
        </div>

        <!-- Restore cached stats for returning users to prevent flash of default values -->
        <script>
        (function() {
            if (localStorage.getItem('dashboardInitialized') !== 'true') return;
            var lvl = localStorage.getItem('fitgotchi_level');
            var rank = localStorage.getItem('fitgotchi_rank');
            var xpText = localStorage.getItem('fitgotchi_xp_text');
            var xpPct = localStorage.getItem('fitgotchi_xp_percent');
            var streak = localStorage.getItem('fitgotchi_streak');
            if (lvl) { var el = document.getElementById('tamagotchi-level'); if (el) el.textContent = lvl; }
            if (rank) { var el = document.getElementById('tamagotchi-rank'); if (el) el.textContent = rank; }
            if (xpText) { var el = document.getElementById('tamagotchi-xp-text'); if (el) el.textContent = xpText; }
            if (xpPct) { var el = document.getElementById('tamagotchi-xp-bar'); if (el) el.style.width = xpPct; }
            if (streak) { var el = document.getElementById('tamagotchi-streak'); if (el) el.textContent = streak; }
        })();
        </script>

        <!-- Battle Stats Row (STR / HP / MANA) -->
        <div id="battle-stats-row" class="battle-stats-row" style="border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; padding-bottom: 10px; margin-bottom: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
            <div class="battle-stat str" onclick="showStatTooltip('str')" title="Strength - Increases attack damage">
                <div class="battle-stat-icon">⚔️</div>
                <div class="battle-stat-info">
                    <div class="battle-stat-label">
                        <span class="battle-stat-name">STR</span>
                        <span class="battle-stat-value" id="stat-str-value">0</span>
                    </div>
                    <div class="battle-stat-bar">
                        <div class="battle-stat-fill" id="stat-str-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="battle-stat hp" onclick="showStatTooltip('hp')" title="Health Points - Increases battle HP">
                <div class="battle-stat-icon">❤️</div>
                <div class="battle-stat-info">
                    <div class="battle-stat-label">
                        <span class="battle-stat-name">HP</span>
                        <span class="battle-stat-value" id="stat-hp-value">0</span>
                    </div>
                    <div class="battle-stat-bar">
                        <div class="battle-stat-fill" id="stat-hp-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="battle-stat mana" onclick="showStatTooltip('mana')" title="Mana - Faster special move charge">
                <div class="battle-stat-icon">🔮</div>
                <div class="battle-stat-info">
                    <div class="battle-stat-label">
                        <span class="battle-stat-name">MANA</span>
                        <span class="battle-stat-value" id="stat-mana-value">0</span>
                    </div>
                    <div class="battle-stat-bar">
                        <div class="battle-stat-fill" id="stat-mana-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Duplicate Install Banner Removed -->

    <!-- Hidden inputs for camera -->
    <input type="file" id="story-camera-input" accept="image/*,video/*" capture style="display:none;" onchange="handleStoryFileSelect(event)">
    <input type="file" id="meal-camera-input" accept="image/*" capture="environment" style="display:none;" onchange="handleMealPhotoSelect(event)">
    <!-- Hidden stories carousel (kept for compatibility but not displayed) -->
    <div id="stories-carousel-container" style="display: none;">
        <div id="stories-carousel" style="display: inline-flex; gap: 15px;">
            <div class="story-ring add-story-btn" onclick="openStoryCamera()" style="display: inline-block; text-align: center; cursor: pointer;"></div>
        </div>
    </div>

    <!-- Friends Pill Widget -->
    <div id="home-friends-pill" onclick="openHomeFriendsModal()" style="margin: 12px 25px 14px; display: flex; align-items: center; gap: 10px; padding: 10px 16px; background: white; border-radius: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #f1f5f9; transition: transform 0.15s;">
        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center;">
            <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: white;"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        </div>
        <div style="flex: 1;">
            <span style="font-weight: 700; font-size: 0.9rem; color: var(--text-main);">Friends</span>
            <span id="home-friends-pill-count" style="font-size: 0.8rem; color: var(--text-muted); margin-left: 6px;">0</span>
        </div>
        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #94a3b8;"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </div>

    <!-- Friends Modal (Home Page) -->
    <div id="home-friends-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10007; align-items: flex-end; justify-content: center; backdrop-filter: blur(3px);" onclick="if(event.target===this) closeHomeFriendsModal();">
        <div style="background: white; border-radius: 20px 20px 0 0; max-width: 500px; width: 100%; max-height: 70vh; overflow: hidden; animation: slideUpModal 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 16px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main);">Friends</h3>
                    <span id="home-friends-modal-count" style="background: var(--primary); color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 10px;">0</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button onclick="closeHomeFriendsModal(); openAddFriendModal();" style="background: linear-gradient(135deg, var(--primary), #10b981); color: white; border: none; padding: 6px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; cursor: pointer;">+ Add</button>
                    <button onclick="closeHomeFriendsModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; line-height: 1;">&times;</button>
                </div>
            </div>
            <!-- Friends List -->
            <div id="home-friends-modal-list" style="overflow-y: auto; max-height: calc(70vh - 60px); padding: 8px 0;">
                <div style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Card -->
    <div id="ai-assistant-card" style="margin: 15px 25px; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #e2e8f0;">
        <!-- Header -->
        <div style="padding: 14px 18px 10px; display: flex; align-items: center; gap: 10px;">
            <div style="width: 34px; height: 34px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: white;"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 700; font-size: 0.9rem; color: var(--text-main);">FITGotchi AI</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">Ask me anything or tell me what to change</div>
            </div>
            <button id="ai-assistant-expand-btn" onclick="toggleAiAssistantExpand()" style="background: none; border: none; padding: 4px; cursor: pointer; color: #94a3b8; display: none;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/></svg>
            </button>
        </div>
        <!-- Messages area (hidden until conversation starts) -->
        <div id="ai-assistant-messages" style="display: none; max-height: 320px; overflow-y: auto; padding: 0 18px 10px; scroll-behavior: smooth;">
        </div>
        <!-- Action confirmation area -->
        <div id="ai-assistant-actions" style="display: none; padding: 0 18px 10px;">
        </div>
        <!-- Input area -->
        <div style="padding: 8px 14px 12px; display: flex; gap: 8px; align-items: center; border-top: 1px solid #f1f5f9;">
            <input type="text" id="ai-assistant-input" placeholder="e.g. Create me a meal plan, swap workouts..." style="flex: 1; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 0.88rem; outline: none; background: #f8fafc; color: var(--text-main); transition: border-color 0.2s;" onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e2e8f0'" onkeypress="if(event.key==='Enter') sendAiAssistantMessage()">
            <button id="ai-assistant-send-btn" onclick="sendAiAssistantMessage()" style="width: 38px; height: 38px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: opacity 0.2s;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <!-- Daily Weigh-In Card (disappears after completion) -->
    <div id="daily-weigh-in-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 20px; color: white; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>

        <div style="position: relative; z-index: 1;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 700;">Daily Weigh-In</h3>
                    <p style="margin: 0; font-size: 0.85rem; opacity: 0.9;">Track your progress, earn XP!</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                    +1 XP
                </div>
            </div>

            <div id="weigh-in-input-section" style="display: flex; gap: 10px; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input type="number" id="weigh-in-weight-input" placeholder="Enter weight" step="0.1" min="20" max="500" style="width: 100%; padding: 12px 50px 12px 15px; border: none; border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.95); color: #333; box-sizing: border-box;">
                    <span id="weigh-in-unit-label" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.9rem; font-weight: 500;">kg</span>
                </div>
                <button onclick="submitDailyWeighIn()" style="background: white; color: #667eea; border: none; padding: 12px 20px; border-radius: 10px; font-weight: 700; font-size: 0.95rem; cursor: pointer; white-space: nowrap; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                    Log It
                </button>
            </div>

            <div id="weigh-in-success-section" style="display: none; text-align: center; padding: 10px 0;">
                <div style="font-size: 2rem; margin-bottom: 8px;">+1 XP</div>
                <p style="margin: 0; font-weight: 600;">Weigh-in complete!</p>
            </div>
        </div>
    </div>

    <!-- Daily Weigh-In Completed Card -->
    <div id="daily-weigh-in-done-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 16px 20px; color: white; align-items: center; gap: 15px; position: relative;">
        <button onclick="dismissWeighInDoneCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0;">&#x2715;</button>
        <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">&#x2705;</div>
        <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 1rem;">Weigh-In Complete!</div>
            <div style="font-size: 0.82rem; opacity: 0.9; margin-top: 2px;">+1 XP earned. Come back tomorrow!</div>
        </div>
    </div>

    <!-- Daily Quiz Card (disappears after completion) -->
    <div id="daily-quiz-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); border-radius: 16px; padding: 20px; color: white; position: relative; overflow: hidden; cursor: pointer;">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        <div style="position: relative; z-index: 1;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 700;">Daily Quiz</h3>
                    <p id="daily-quiz-subtitle" style="margin: 0; font-size: 0.85rem; opacity: 0.9;">Complete a lesson, earn bonus XP!</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                    +10 XP
                </div>
            </div>
            <div id="daily-quiz-lesson-info" style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px;">
                <div id="daily-quiz-icon" style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;"></div>
                <div style="flex: 1;">
                    <div id="daily-quiz-lesson-title" style="font-weight: 600; font-size: 0.95rem;"></div>
                    <div id="daily-quiz-lesson-context" style="font-size: 0.8rem; opacity: 0.85; margin-top: 2px;"></div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: rgba(255,255,255,0.7);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
            </div>
        </div>
    </div>

    <!-- Daily Quiz Completed Card -->
    <div id="daily-quiz-done-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 16px; padding: 16px 20px; color: white; align-items: center; gap: 15px; position: relative;">
        <button onclick="dismissQuizDoneCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0;">&#x2715;</button>
        <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">&#x2705;</div>
        <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 1rem;">Daily Quiz Complete!</div>
            <div style="font-size: 0.82rem; opacity: 0.9; margin-top: 2px;">+10 XP earned. Come back tomorrow!</div>
        </div>
    </div>

    <!-- Weekly Progress Photo Card (shows on Mondays) -->
    <div id="weekly-progress-photo-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); border-radius: 16px; padding: 20px; color: white; position: relative; overflow: hidden; cursor: pointer;">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        <input type="file" id="progress-photo-input" accept="image/*" capture="environment" style="display:none;">
        <div style="position: relative; z-index: 1;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 700;">Weekly Progress Photo</h3>
                    <p style="margin: 0; font-size: 0.85rem; opacity: 0.9;">Snap a pic to track your transformation!</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                    +15 XP
                </div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px;">
                <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">📸</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.95rem;">Take your weekly photo</div>
                    <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 2px;">Every Monday - track your journey</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: rgba(255,255,255,0.7);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
            </div>
        </div>
    </div>

    <!-- Weekly Progress Photo Upload Loading -->
    <div id="weekly-progress-photo-uploading" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); border-radius: 16px; padding: 20px; color: white; text-align: center;">
        <div style="font-size: 2rem; margin-bottom: 8px;">📸</div>
        <p style="margin: 0; font-weight: 600;">Uploading your progress photo...</p>
    </div>

    <!-- Weekly Progress Photo Completed Card -->
    <div id="weekly-progress-photo-done-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); border-radius: 16px; padding: 16px 20px; color: white; align-items: center; gap: 15px; position: relative;">
        <button onclick="dismissProgressPhotoDoneCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0;">&#x2715;</button>
        <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">&#x2705;</div>
        <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 1rem;">Progress Photo Saved!</div>
            <div style="font-size: 0.82rem; opacity: 0.9; margin-top: 2px;">+15 XP earned. See you next Monday!</div>
        </div>
    </div>

    <!-- Daily Meal Tip Card -->
    <div id="daily-meal-tip-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 18px 20px; color: white; position: relative; overflow: hidden; cursor: pointer;" onclick="openWeeklyTrendsPage()">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        <button onclick="event.stopPropagation(); dismissMealTipCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0; z-index: 2;">&#x2715;</button>
        <div style="position: relative; z-index: 1;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0;">🥗</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 4px;">Meal Insight</div>
                    <div id="daily-meal-tip-text" style="font-size: 0.82rem; opacity: 0.95; line-height: 1.4;">Loading your latest meal pattern...</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 10px; gap: 6px; font-size: 0.78rem; opacity: 0.8;">
                <span>View all trends</span>
                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: rgba(255,255,255,0.8);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
            </div>
        </div>
    </div>

    <!-- Daily Workout Trend Card -->
    <div id="daily-workout-trend-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 16px; padding: 18px 20px; color: white; position: relative; overflow: hidden; cursor: pointer;" onclick="switchAppTab('movement-tab', this)">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        <button onclick="event.stopPropagation(); dismissWorkoutTrendCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0; z-index: 2;">&#x2715;</button>
        <div style="position: relative; z-index: 1;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0;">💪</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 4px;">Workout Trend</div>
                    <div id="daily-workout-trend-text" style="font-size: 0.82rem; opacity: 0.95; line-height: 1.4;">Loading your workout stats...</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 10px; gap: 6px; font-size: 0.78rem; opacity: 0.8;">
                <span>Open Movement Studio</span>
                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: rgba(255,255,255,0.8);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
            </div>
        </div>
    </div>

    <script>
    // ===== DAILY WEIGH-IN CARD LOGIC =====

    /**
     * Check if user has weighed in today and show/hide card accordingly
     */
    async function checkAndShowWeighInCard() {
        if (!window.currentUser) return;

        // Don't show weigh-in card if onboarding wizard is active or pending
        if (window._onboardingWizardPending) return;
        const wizard = document.getElementById('onboarding-wizard');
        if (wizard && wizard.style.display !== 'none') return;

        try {
            const todaysWeighIn = await db.weighIns.getTodaysWeighIn(window.currentUser.id);
            const card = document.getElementById('daily-weigh-in-card');
            const doneCard = document.getElementById('daily-weigh-in-done-card');

            if (card) {
                if (todaysWeighIn) {
                    // Already weighed in today - hide input card, show done card (unless dismissed)
                    card.style.display = 'none';
                    if (doneCard) {
                        var d = new Date();
                        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                        doneCard.style.display = localStorage.getItem('weighInDoneCardDismissedDate') === today ? 'none' : 'flex';
                    }
                } else {
                    // Show the card for today's weigh-in
                    card.style.display = 'block';
                    if (doneCard) doneCard.style.display = 'none';

                    // Pre-fill with last known weight if available
                    const latestWeighIn = await db.weighIns.getLatest(window.currentUser.id);
                    if (latestWeighIn) {
                        const input = document.getElementById('weigh-in-weight-input');
                        if (input) input.placeholder = `Last: ${latestWeighIn.weight_kg} kg`;
                    }

                    // Check user's preferred unit and update label
                    updateWeighInUnitLabel();
                }
            }
        } catch (error) {
            console.error('Error checking weigh-in status:', error);
        }
    }

    /**
     * Update the unit label based on user preference
     */
    function updateWeighInUnitLabel() {
        const unitLabel = document.getElementById('weigh-in-unit-label');
        const input = document.getElementById('weigh-in-weight-input');

        // Check if user prefers lbs (from localStorage or user settings)
        const preferLbs = localStorage.getItem('weightUnitPreference') === 'lbs';

        if (unitLabel && input) {
            if (preferLbs) {
                unitLabel.textContent = 'lbs';
                input.step = '1';
            } else {
                unitLabel.textContent = 'kg';
                input.step = '0.1';
            }
        }
    }

    /**
     * Submit the daily weigh-in
     */
    async function submitDailyWeighIn() {
        if (!window.currentUser) {
            alert('Please log in to track your weight.');
            return;
        }

        const input = document.getElementById('weigh-in-weight-input');
        const inputSection = document.getElementById('weigh-in-input-section');
        const successSection = document.getElementById('weigh-in-success-section');
        const card = document.getElementById('daily-weigh-in-card');

        let weightValue = parseFloat(input?.value);

        if (!weightValue || weightValue < 20 || weightValue > 500) {
            alert('Please enter a valid weight.');
            return;
        }

        // Convert lbs to kg if needed
        const preferLbs = localStorage.getItem('weightUnitPreference') === 'lbs';
        if (preferLbs) {
            weightValue = weightValue * 0.453592; // Convert lbs to kg
        }

        try {
            // Log the weigh-in
            await db.weighIns.log(window.currentUser.id, weightValue);

            // Award 1 XP (add to lifetime_points for leveling)
            try {
                const { data: currentPoints } = await supabaseClient
                    .from('user_points')
                    .select('lifetime_points')
                    .eq('user_id', window.currentUser.id)
                    .maybeSingle();

                if (currentPoints) {
                    await supabaseClient
                        .from('user_points')
                        .update({ lifetime_points: (currentPoints.lifetime_points || 0) + 1 })
                        .eq('user_id', window.currentUser.id);
                } else {
                    // Create user_points record if doesn't exist
                    await supabaseClient
                        .from('user_points')
                        .insert({ user_id: window.currentUser.id, lifetime_points: 1, current_points: 0 });
                }

                // Trigger XP bar animation if available
                if (typeof triggerXPBarRainbow === 'function') triggerXPBarRainbow();
                if (typeof refreshLevelDisplay === 'function') refreshLevelDisplay();
            } catch (xpError) {
                console.log('XP award skipped:', xpError);
            }

            // Show success animation
            if (inputSection) inputSection.style.display = 'none';
            if (successSection) successSection.style.display = 'block';

            // Update user's current weight in profile
            try {
                await db.users.update(window.currentUser.id, { weight: weightValue });
            } catch (updateError) {
                console.log('Profile weight update skipped:', updateError);
            }

            // Hide input card after 2 seconds and show done card
            setTimeout(() => {
                if (card) {
                    card.style.transition = 'opacity 0.5s, transform 0.5s';
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(-20px)';
                    setTimeout(() => {
                        card.style.display = 'none';
                        // Reset for next day
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                        if (inputSection) inputSection.style.display = 'flex';
                        if (successSection) successSection.style.display = 'none';
                        if (input) input.value = '';
                        // Show the completed card
                        const doneCard = document.getElementById('daily-weigh-in-done-card');
                        if (doneCard) doneCard.style.display = 'flex';
                    }, 500);
                }
            }, 2000);

            // Refresh points display if visible
            if (typeof refreshPointsDisplay === 'function') {
                refreshPointsDisplay();
            }

        } catch (error) {
            console.error('Error logging weigh-in:', error);
            alert('Failed to log weigh-in. Please try again.');
        }
    }

    function dismissWeighInDoneCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('weighInDoneCardDismissedDate', today);
        document.getElementById('daily-weigh-in-done-card').style.display = 'none';
    }

    // Make functions globally available
    window.dismissWeighInDoneCard = dismissWeighInDoneCard;
    window.submitDailyWeighIn = submitDailyWeighIn;
    window.checkAndShowWeighInCard = checkAndShowWeighInCard;

    // PWA resume: re-check weigh-in when app comes back to foreground
    // (e.g., user opens PWA the next day without a hard refresh)
    let _lastWeighInCheckDate = new Date().toDateString();
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            const today = new Date().toDateString();
            if (today !== _lastWeighInCheckDate) {
                // It's a new day since last check - refresh weigh-in card, modal & daily quiz
                _lastWeighInCheckDate = today;
                console.log('🔄 New day detected on PWA resume, refreshing daily cards');
                if (typeof checkAndShowWeighInCard === 'function') checkAndShowWeighInCard();
                if (typeof checkAndShowWeighInModal === 'function') checkAndShowWeighInModal();
                if (typeof checkAndShowDailyQuizCard === 'function') checkAndShowDailyQuizCard();
                if (typeof checkAndShowMealTipCard === 'function') checkAndShowMealTipCard();
                if (typeof checkAndShowProgressPhotoCard === 'function') checkAndShowProgressPhotoCard();
                if (typeof checkAndShowWorkoutTrendCard === 'function') checkAndShowWorkoutTrendCard();
                if (typeof initFitbitDashboard === 'function') initFitbitDashboard();
                if (typeof initWhoopDashboard === 'function') initWhoopDashboard();
                if (typeof initOuraDashboard === 'function') initOuraDashboard();
                if (typeof initStravaDashboard === 'function') initStravaDashboard();
            }
        }
    });
    </script>

    <script>
    // ===== FITBIT INTEGRATION LOGIC =====

    /**
     * Check Fitbit connection status and load data
     */
    async function initFitbitDashboard() {
        if (!window.currentUser) return;

        try {
            const response = await fetch(`/api/fitbit/data?user_id=${window.currentUser.id}`);
            const data = await response.json();

            if (data.connected) {
                // Show dashboard card
                const card = document.getElementById('fitbit-dashboard-card');
                if (card) card.style.display = 'block';

                // Update settings button
                const btn = document.getElementById('fitbit-connect-btn');
                const statusText = document.getElementById('fitbit-status-text');
                if (btn) {
                    btn.textContent = 'Disconnect';
                    btn.style.background = '#ef4444';
                }
                if (statusText) statusText.textContent = 'Connected and syncing';

                // Populate today's data
                updateFitbitDisplay(data);
            } else {
                // Not connected - ensure card is hidden
                const card = document.getElementById('fitbit-dashboard-card');
                if (card) card.style.display = 'none';

                // Reset settings button
                const btn = document.getElementById('fitbit-connect-btn');
                const statusText = document.getElementById('fitbit-status-text');
                if (btn) {
                    btn.textContent = 'Connect';
                    btn.style.background = '#00B0B9';
                }
                if (statusText) statusText.textContent = 'Sync steps, sleep & heart rate';
            }
        } catch (err) {
            console.warn('Fitbit init error:', err);
        }
    }

    /**
     * Update the Fitbit display cards with data
     */
    function updateFitbitDisplay(data) {
        // Today's activity
        const todayActivity = data.activity && data.activity[0];
        if (todayActivity) {
            const stepsEl = document.getElementById('fitbit-steps');
            const activeMinsEl = document.getElementById('fitbit-active-mins');
            const caloriesEl = document.getElementById('fitbit-calories');

            if (stepsEl) stepsEl.textContent = (todayActivity.steps || 0).toLocaleString();
            if (activeMinsEl) activeMinsEl.textContent = (todayActivity.active_minutes || 0) + ' min';
            if (caloriesEl) caloriesEl.textContent = (todayActivity.calories_burned || 0).toLocaleString();
        }

        // Today's sleep
        const todaySleep = data.sleep && data.sleep[0];
        if (todaySleep) {
            const sleepEl = document.getElementById('fitbit-sleep');
            if (sleepEl) {
                const hours = Math.floor((todaySleep.duration_minutes || 0) / 60);
                const mins = (todaySleep.duration_minutes || 0) % 60;
                sleepEl.textContent = hours + 'h ' + mins + 'm';
            }
        }

        // Today's heart rate
        const todayHR = data.heart_rate && data.heart_rate[0];
        if (todayHR && todayHR.resting_heart_rate) {
            const hrEl = document.getElementById('fitbit-heart-rate');
            if (hrEl) hrEl.textContent = todayHR.resting_heart_rate;
        }

        // Last sync time
        if (data.last_sync) {
            const syncEl = document.getElementById('fitbit-last-sync');
            if (syncEl) {
                const syncDate = new Date(data.last_sync);
                const now = new Date();
                const diffMins = Math.floor((now - syncDate) / 60000);
                let timeAgo;
                if (diffMins < 1) timeAgo = 'Just now';
                else if (diffMins < 60) timeAgo = diffMins + 'm ago';
                else if (diffMins < 1440) timeAgo = Math.floor(diffMins / 60) + 'h ago';
                else timeAgo = Math.floor(diffMins / 1440) + 'd ago';
                syncEl.textContent = 'Last synced ' + timeAgo;
            }
        }
    }

    /**
     * Connect or disconnect Fitbit
     */
    function toggleFitbitConnection() {
        if (!window.currentUser) return;

        const btn = document.getElementById('fitbit-connect-btn');
        if (btn && btn.textContent.trim() === 'Disconnect') {
            // Disconnect
            if (confirm('Disconnect your Fitbit? Your synced data will remain.')) {
                btn.textContent = '...';
                btn.disabled = true;
                fetch('/api/fitbit/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.id }),
                }).then(() => {
                    btn.textContent = 'Connect';
                    btn.style.background = '#00B0B9';
                    btn.disabled = false;
                    const statusText = document.getElementById('fitbit-status-text');
                    if (statusText) statusText.textContent = 'Sync steps, sleep & heart rate';
                    const card = document.getElementById('fitbit-dashboard-card');
                    if (card) card.style.display = 'none';
                }).catch(() => {
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    alert('Failed to disconnect. Please try again.');
                });
            }
        } else {
            // Connect - redirect to Fitbit OAuth
            window.location.href = '/api/fitbit/auth?user_id=' + window.currentUser.id;
        }
    }

    /**
     * Manual sync button
     */
    function syncFitbitNow() {
        if (!window.currentUser) return;

        const btn = document.getElementById('fitbit-sync-btn');
        if (btn) {
            btn.style.opacity = '0.5';
            btn.style.pointerEvents = 'none';
        }

        fetch('/api/fitbit/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: window.currentUser.id }),
        }).then(r => r.json()).then(() => {
            // Refresh display
            return fetch('/api/fitbit/data?user_id=' + window.currentUser.id);
        }).then(r => r.json()).then(data => {
            if (data.connected) updateFitbitDisplay(data);
        }).catch(err => {
            console.warn('Fitbit sync error:', err);
        }).finally(() => {
            if (btn) {
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }
        });
    }

    /**
     * Handle Fitbit OAuth redirect results
     */
    function checkFitbitOAuthResult() {
        const params = new URLSearchParams(window.location.search);
        const fitbitResult = params.get('fitbit');

        if (fitbitResult) {
            // Clean URL
            const cleanUrl = window.location.pathname;
            window.history.replaceState({}, '', cleanUrl);

            if (fitbitResult === 'connected') {
                // Show success message
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:14px 24px; border-radius:12px; font-weight:600; z-index:99999; box-shadow:0 4px 12px rgba(0,0,0,0.15); font-size:0.9rem;';
                toast.textContent = 'Fitbit connected! Syncing your data...';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);

                // Refresh Fitbit data
                setTimeout(() => initFitbitDashboard(), 2000);
            } else if (fitbitResult === 'denied') {
                alert('Fitbit connection was cancelled. You can connect anytime from Settings.');
            } else if (fitbitResult === 'error') {
                alert('There was a problem connecting to Fitbit. Please try again.');
            }
        }
    }

    // Make functions globally available
    window.toggleFitbitConnection = toggleFitbitConnection;
    window.syncFitbitNow = syncFitbitNow;
    window.initFitbitDashboard = initFitbitDashboard;

    // Check OAuth result on page load
    checkFitbitOAuthResult();
    </script>

    <script>
    // ===== WHOOP INTEGRATION LOGIC =====

    async function initWhoopDashboard() {
        if (!window.currentUser) return;
        try {
            const response = await fetch(`/api/whoop/data?user_id=${window.currentUser.id}`);
            const data = await response.json();
            if (data.connected) {
                const card = document.getElementById('whoop-dashboard-card');
                if (card) card.style.display = 'block';
                const btn = document.getElementById('whoop-connect-btn');
                const statusText = document.getElementById('whoop-status-text');
                if (btn) { btn.textContent = 'Disconnect'; btn.style.background = '#ef4444'; }
                if (statusText) statusText.textContent = 'Connected and syncing';
                updateWhoopDisplay(data);
            } else {
                const card = document.getElementById('whoop-dashboard-card');
                if (card) card.style.display = 'none';
                const btn = document.getElementById('whoop-connect-btn');
                const statusText = document.getElementById('whoop-status-text');
                if (btn) { btn.textContent = 'Connect'; btn.style.background = '#1a1a1a'; }
                if (statusText) statusText.textContent = 'Sync recovery, strain & sleep';
            }
        } catch (err) { console.warn('WHOOP init error:', err); }
    }

    function updateWhoopDisplay(data) {
        const todayRecovery = data.recovery && data.recovery[0];
        if (todayRecovery) {
            const recEl = document.getElementById('whoop-recovery');
            const hrEl = document.getElementById('whoop-resting-hr');
            const hrvEl = document.getElementById('whoop-hrv');
            if (recEl) recEl.textContent = (todayRecovery.recovery_score || 0) + '%';
            if (hrEl && todayRecovery.resting_heart_rate) hrEl.textContent = todayRecovery.resting_heart_rate;
            if (hrvEl && todayRecovery.hrv_rmssd) hrvEl.textContent = Math.round(todayRecovery.hrv_rmssd);
        }
        const todaySleep = data.sleep && data.sleep[0];
        if (todaySleep) {
            const sleepEl = document.getElementById('whoop-sleep');
            if (sleepEl) {
                const hours = Math.floor((todaySleep.duration_minutes || 0) / 60);
                const mins = (todaySleep.duration_minutes || 0) % 60;
                sleepEl.textContent = hours + 'h ' + mins + 'm';
            }
        }
        const todayWorkout = data.workouts && data.workouts[0];
        if (todayWorkout) {
            const strainEl = document.getElementById('whoop-strain');
            if (strainEl) strainEl.textContent = (todayWorkout.strain || 0).toFixed(1);
        }
        if (data.last_sync) {
            const syncEl = document.getElementById('whoop-last-sync');
            if (syncEl) syncEl.textContent = 'Last synced ' + formatTimeAgo(data.last_sync);
        }
    }

    function toggleWhoopConnection() {
        if (!window.currentUser) return;
        const btn = document.getElementById('whoop-connect-btn');
        if (btn && btn.textContent.trim() === 'Disconnect') {
            if (confirm('Disconnect your WHOOP? Your synced data will remain.')) {
                btn.textContent = '...'; btn.disabled = true;
                fetch('/api/whoop/disconnect', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.id }),
                }).then(() => {
                    btn.textContent = 'Connect'; btn.style.background = '#1a1a1a'; btn.disabled = false;
                    document.getElementById('whoop-status-text').textContent = 'Sync recovery, strain & sleep';
                    const card = document.getElementById('whoop-dashboard-card');
                    if (card) card.style.display = 'none';
                }).catch(() => { btn.textContent = 'Disconnect'; btn.disabled = false; alert('Failed to disconnect.'); });
            }
        } else {
            window.location.href = '/api/whoop/auth?user_id=' + window.currentUser.id;
        }
    }

    function syncWhoopNow() {
        if (!window.currentUser) return;
        const btn = document.getElementById('whoop-sync-btn');
        if (btn) { btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; }
        fetch('/api/whoop/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: window.currentUser.id }) })
            .then(r => r.json()).then(() => fetch('/api/whoop/data?user_id=' + window.currentUser.id))
            .then(r => r.json()).then(data => { if (data.connected) updateWhoopDisplay(data); })
            .catch(err => console.warn('WHOOP sync error:', err))
            .finally(() => { if (btn) { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; } });
    }

    function checkWhoopOAuthResult() {
        const params = new URLSearchParams(window.location.search);
        const result = params.get('whoop');
        if (result) {
            window.history.replaceState({}, '', window.location.pathname);
            if (result === 'connected') {
                showWearableToast('WHOOP connected! Syncing your data...');
                setTimeout(() => initWhoopDashboard(), 2000);
            } else if (result === 'denied') {
                alert('WHOOP connection was cancelled. You can connect anytime from Settings.');
            } else if (result === 'error') {
                alert('There was a problem connecting to WHOOP. Please try again.');
            }
        }
    }

    window.toggleWhoopConnection = toggleWhoopConnection;
    window.syncWhoopNow = syncWhoopNow;
    window.initWhoopDashboard = initWhoopDashboard;
    checkWhoopOAuthResult();
    </script>

    <script>
    // ===== OURA RING INTEGRATION LOGIC =====

    async function initOuraDashboard() {
        if (!window.currentUser) return;
        try {
            const response = await fetch(`/api/oura/data?user_id=${window.currentUser.id}`);
            const data = await response.json();
            if (data.connected) {
                const card = document.getElementById('oura-dashboard-card');
                if (card) card.style.display = 'block';
                const btn = document.getElementById('oura-connect-btn');
                const statusText = document.getElementById('oura-status-text');
                if (btn) { btn.textContent = 'Disconnect'; btn.style.background = '#ef4444'; }
                if (statusText) statusText.textContent = 'Connected and syncing';
                updateOuraDisplay(data);
            } else {
                const card = document.getElementById('oura-dashboard-card');
                if (card) card.style.display = 'none';
                const btn = document.getElementById('oura-connect-btn');
                const statusText = document.getElementById('oura-status-text');
                if (btn) { btn.textContent = 'Connect'; btn.style.background = '#c4a862'; }
                if (statusText) statusText.textContent = 'Sync readiness, sleep & activity';
            }
        } catch (err) { console.warn('Oura init error:', err); }
    }

    function updateOuraDisplay(data) {
        const todayActivity = data.activity && data.activity[0];
        if (todayActivity) {
            const stepsEl = document.getElementById('oura-steps');
            const caloriesEl = document.getElementById('oura-calories');
            if (stepsEl) stepsEl.textContent = (todayActivity.steps || 0).toLocaleString();
            if (caloriesEl) caloriesEl.textContent = (todayActivity.active_calories || 0).toLocaleString();
        }
        const todaySleep = data.sleep && data.sleep[0];
        if (todaySleep) {
            const sleepEl = document.getElementById('oura-sleep');
            const scoreEl = document.getElementById('oura-sleep-score');
            if (sleepEl) {
                const hours = Math.floor((todaySleep.total_sleep_minutes || 0) / 60);
                const mins = (todaySleep.total_sleep_minutes || 0) % 60;
                sleepEl.textContent = hours + 'h ' + mins + 'm';
            }
            if (scoreEl && todaySleep.sleep_score) scoreEl.textContent = todaySleep.sleep_score;
        }
        const todayReadiness = data.readiness && data.readiness[0];
        if (todayReadiness && todayReadiness.readiness_score) {
            const readyEl = document.getElementById('oura-readiness');
            if (readyEl) readyEl.textContent = todayReadiness.readiness_score;
        }
        if (data.last_sync) {
            const syncEl = document.getElementById('oura-last-sync');
            if (syncEl) syncEl.textContent = 'Last synced ' + formatTimeAgo(data.last_sync);
        }
    }

    function toggleOuraConnection() {
        if (!window.currentUser) return;
        const btn = document.getElementById('oura-connect-btn');
        if (btn && btn.textContent.trim() === 'Disconnect') {
            if (confirm('Disconnect your Oura Ring? Your synced data will remain.')) {
                btn.textContent = '...'; btn.disabled = true;
                fetch('/api/oura/disconnect', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.id }),
                }).then(() => {
                    btn.textContent = 'Connect'; btn.style.background = '#c4a862'; btn.disabled = false;
                    document.getElementById('oura-status-text').textContent = 'Sync readiness, sleep & activity';
                    const card = document.getElementById('oura-dashboard-card');
                    if (card) card.style.display = 'none';
                }).catch(() => { btn.textContent = 'Disconnect'; btn.disabled = false; alert('Failed to disconnect.'); });
            }
        } else {
            window.location.href = '/api/oura/auth?user_id=' + window.currentUser.id;
        }
    }

    function syncOuraNow() {
        if (!window.currentUser) return;
        const btn = document.getElementById('oura-sync-btn');
        if (btn) { btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; }
        fetch('/api/oura/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: window.currentUser.id }) })
            .then(r => r.json()).then(() => fetch('/api/oura/data?user_id=' + window.currentUser.id))
            .then(r => r.json()).then(data => { if (data.connected) updateOuraDisplay(data); })
            .catch(err => console.warn('Oura sync error:', err))
            .finally(() => { if (btn) { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; } });
    }

    function checkOuraOAuthResult() {
        const params = new URLSearchParams(window.location.search);
        const result = params.get('oura');
        if (result) {
            window.history.replaceState({}, '', window.location.pathname);
            if (result === 'connected') {
                showWearableToast('Oura Ring connected! Syncing your data...');
                setTimeout(() => initOuraDashboard(), 2000);
            } else if (result === 'denied') {
                alert('Oura connection was cancelled. You can connect anytime from Settings.');
            } else if (result === 'error') {
                alert('There was a problem connecting to Oura. Please try again.');
            }
        }
    }

    window.toggleOuraConnection = toggleOuraConnection;
    window.syncOuraNow = syncOuraNow;
    window.initOuraDashboard = initOuraDashboard;
    checkOuraOAuthResult();
    </script>

    <script>
    // ===== STRAVA INTEGRATION LOGIC =====

    async function initStravaDashboard() {
        if (!window.currentUser) return;
        try {
            const response = await fetch(`/api/strava/data?user_id=${window.currentUser.id}`);
            const data = await response.json();
            if (data.connected) {
                const card = document.getElementById('strava-dashboard-card');
                if (card) card.style.display = 'block';
                const btn = document.getElementById('strava-connect-btn');
                const statusText = document.getElementById('strava-status-text');
                if (btn) { btn.textContent = 'Disconnect'; btn.style.background = '#ef4444'; }
                if (statusText) statusText.textContent = 'Connected and syncing';
                updateStravaDisplay(data);
            } else {
                const card = document.getElementById('strava-dashboard-card');
                if (card) card.style.display = 'none';
                const btn = document.getElementById('strava-connect-btn');
                const statusText = document.getElementById('strava-status-text');
                if (btn) { btn.textContent = 'Connect'; btn.style.background = '#FC4C02'; }
                if (statusText) statusText.textContent = 'Sync workouts, runs & rides';
            }
        } catch (err) { console.warn('Strava init error:', err); }
    }

    function updateStravaDisplay(data) {
        const latest = data.activities && data.activities[0];
        if (latest) {
            const nameEl = document.getElementById('strava-activity-name');
            const typeEl = document.getElementById('strava-activity-type');
            const distEl = document.getElementById('strava-distance');
            const durEl = document.getElementById('strava-duration');
            const hrEl = document.getElementById('strava-heart-rate');
            const calEl = document.getElementById('strava-calories');
            const elevEl = document.getElementById('strava-elevation');

            if (nameEl) nameEl.textContent = latest.name || 'Activity';
            if (typeEl) typeEl.textContent = latest.sport_type || '';

            // Distance: convert meters to km or miles
            if (distEl) {
                const km = ((latest.distance_meters || 0) / 1000).toFixed(1);
                distEl.textContent = km + ' km';
            }
            // Duration: convert seconds to h:mm
            if (durEl) {
                const totalMins = Math.round((latest.moving_time_seconds || 0) / 60);
                const hours = Math.floor(totalMins / 60);
                const mins = totalMins % 60;
                durEl.textContent = hours > 0 ? hours + 'h ' + mins + 'm' : mins + 'm';
            }
            if (hrEl && latest.avg_heart_rate) hrEl.textContent = latest.avg_heart_rate;
            if (calEl) calEl.textContent = (latest.calories || 0).toLocaleString();
            if (elevEl) elevEl.textContent = Math.round(latest.total_elevation_gain || 0) + 'm';
        }
        if (data.last_sync) {
            const syncEl = document.getElementById('strava-last-sync');
            if (syncEl) syncEl.textContent = 'Last synced ' + formatTimeAgo(data.last_sync);
        }
    }

    function toggleStravaConnection() {
        if (!window.currentUser) return;
        const btn = document.getElementById('strava-connect-btn');
        if (btn && btn.textContent.trim() === 'Disconnect') {
            if (confirm('Disconnect your Strava? Your synced data will remain.')) {
                btn.textContent = '...'; btn.disabled = true;
                fetch('/api/strava/disconnect', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.id }),
                }).then(() => {
                    btn.textContent = 'Connect'; btn.style.background = '#FC4C02'; btn.disabled = false;
                    document.getElementById('strava-status-text').textContent = 'Sync workouts, runs & rides';
                    const card = document.getElementById('strava-dashboard-card');
                    if (card) card.style.display = 'none';
                }).catch(() => { btn.textContent = 'Disconnect'; btn.disabled = false; alert('Failed to disconnect.'); });
            }
        } else {
            window.location.href = '/api/strava/auth?user_id=' + window.currentUser.id;
        }
    }

    function syncStravaNow() {
        if (!window.currentUser) return;
        const btn = document.getElementById('strava-sync-btn');
        if (btn) { btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; }
        fetch('/api/strava/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: window.currentUser.id }) })
            .then(r => r.json()).then(() => fetch('/api/strava/data?user_id=' + window.currentUser.id))
            .then(r => r.json()).then(data => { if (data.connected) updateStravaDisplay(data); })
            .catch(err => console.warn('Strava sync error:', err))
            .finally(() => { if (btn) { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; } });
    }

    function checkStravaOAuthResult() {
        const params = new URLSearchParams(window.location.search);
        const result = params.get('strava');
        if (result) {
            window.history.replaceState({}, '', window.location.pathname);
            if (result === 'connected') {
                showWearableToast('Strava connected! Syncing your data...');
                setTimeout(() => initStravaDashboard(), 2000);
            } else if (result === 'denied') {
                alert('Strava connection was cancelled. You can connect anytime from Settings.');
            } else if (result === 'error') {
                alert('There was a problem connecting to Strava. Please try again.');
            }
        }
    }

    window.toggleStravaConnection = toggleStravaConnection;
    window.syncStravaNow = syncStravaNow;
    window.initStravaDashboard = initStravaDashboard;
    checkStravaOAuthResult();
    </script>

    <script>
    // ===== SHARED WEARABLE HELPERS =====

    function formatTimeAgo(dateStr) {
        const syncDate = new Date(dateStr);
        const now = new Date();
        const diffMins = Math.floor((now - syncDate) / 60000);
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return diffMins + 'm ago';
        if (diffMins < 1440) return Math.floor(diffMins / 60) + 'h ago';
        return Math.floor(diffMins / 1440) + 'd ago';
    }

    function showWearableToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:14px 24px; border-radius:12px; font-weight:600; z-index:99999; box-shadow:0 4px 12px rgba(0,0,0,0.15); font-size:0.9rem;';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Initialize all wearable dashboards on page load
    function initAllWearableDashboards() {
        if (typeof initWhoopDashboard === 'function') initWhoopDashboard();
        if (typeof initOuraDashboard === 'function') initOuraDashboard();
        if (typeof initStravaDashboard === 'function') initStravaDashboard();
    }

    // Call after user is loaded (piggyback on Fitbit init timing)
    if (window.currentUser) {
        initAllWearableDashboards();
    } else {
        // Wait for user to be set, then init
        const _origInitFitbit = window.initFitbitDashboard;
        window.initFitbitDashboard = function() {
            if (_origInitFitbit) _origInitFitbit();
            initAllWearableDashboards();
        };
    }
    </script>

    <script>
    // ===== DAILY QUIZ CARD LOGIC =====

    /**
     * Check if user has completed their daily quiz and show/hide card accordingly.
     * Uses learning system state exposed via window functions.
     */
    async function checkAndShowDailyQuizCard() {
        if (!window.currentUser) return;

        // Don't show if onboarding wizard is active
        if (window._onboardingWizardPending) return;
        const wizard = document.getElementById('onboarding-wizard');
        if (wizard && wizard.style.display !== 'none') return;

        const card = document.getElementById('daily-quiz-card');
        const doneCard = document.getElementById('daily-quiz-done-card');
        if (!card || !doneCard) return;

        try {
            // Ensure learning progress is loaded before checking
            if (typeof window._ensureLearningProgressLoaded === 'function') {
                await window._ensureLearningProgressLoaded();
            }

            // Check if daily quiz already completed today (uses learning-inline.js exposed fn)
            if (typeof window._isDailyQuizCompletedToday === 'function' && window._isDailyQuizCompletedToday()) {
                card.style.display = 'none';
                var d = new Date();
                var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                doneCard.style.display = localStorage.getItem('quizDoneCardDismissedDate') === today ? 'none' : 'flex';
                return;
            }

            // Find a random available lesson from any category (uses learning-inline.js exposed fn)
            if (typeof window._getRandomAvailableLesson !== 'function') {
                card.style.display = 'none';
                doneCard.style.display = 'none';
                return;
            }

            // Check if we already picked a daily quiz lesson for today
            var d2 = new Date();
            var todayStr = d2.getFullYear() + '-' + String(d2.getMonth()+1).padStart(2,'0') + '-' + String(d2.getDate()).padStart(2,'0');
            var savedQuizLesson = null;
            try {
                var saved = JSON.parse(localStorage.getItem('dailyQuizLessonToday') || 'null');
                if (saved && saved.date === todayStr && saved.lessonId) {
                    // Use the saved lesson if it hasn't been completed yet
                    if (typeof window._getLessonById === 'function') {
                        var savedLesson = window._getLessonById(saved.lessonId);
                        if (savedLesson) {
                            savedQuizLesson = savedLesson;
                        }
                    }
                }
            } catch (e) { /* ignore parse errors */ }

            var lesson, unit, module;
            if (savedQuizLesson) {
                // Check if the saved lesson was already completed (e.g., via regular learning path)
                if (typeof window._isLessonCompleted === 'function' && window._isLessonCompleted(savedQuizLesson.lesson.id)) {
                    // Lesson was completed outside daily quiz flow — treat daily quiz as done
                    card.style.display = 'none';
                    doneCard.style.display = 'none';
                    return;
                }
                lesson = savedQuizLesson.lesson;
                unit = savedQuizLesson.unit;
                module = savedQuizLesson.module;
            } else {
                const nextLesson = window._getRandomAvailableLesson();
                if (!nextLesson) {
                    // All lessons completed
                    card.style.display = 'none';
                    doneCard.style.display = 'none';
                    return;
                }
                lesson = nextLesson.lesson;
                unit = nextLesson.unit;
                module = nextLesson.module;
                // Save today's daily quiz lesson so it stays consistent
                localStorage.setItem('dailyQuizLessonToday', JSON.stringify({ date: todayStr, lessonId: lesson.id }));
            }

            const moduleEmojis = { body: '💪', fuel: '🥗', mind: '🧠', longevity: '⏳', workouts: '🏋️', hormones: '🧪' };

            // Populate card content
            document.getElementById('daily-quiz-icon').textContent = moduleEmojis[module.id] || '📚';
            document.getElementById('daily-quiz-lesson-title').textContent = lesson.title;
            document.getElementById('daily-quiz-lesson-context').textContent = module.title + ' \u2022 ' + unit.title;

            card.onclick = function() {
                // Switch to learning tab and start the daily quiz
                if (typeof switchAppTab === 'function') {
                    const learningNav = document.querySelectorAll('.nav-item')[3];
                    switchAppTab('learning', learningNav);
                    // Wait for learning to init, then start the daily quiz
                    // Use polling instead of fixed timeout to handle slow DB calls
                    var attempts = 0;
                    var waitForInit = setInterval(function() {
                        attempts++;
                        if (typeof window.startDailyQuiz === 'function' && !window._learningInitInProgress) {
                            clearInterval(waitForInit);
                            window.startDailyQuiz(lesson.id);
                        } else if (attempts > 20) { // 4 second max wait
                            clearInterval(waitForInit);
                            if (typeof window.startDailyQuiz === 'function') {
                                window.startDailyQuiz(lesson.id);
                            }
                        }
                    }, 200);
                }
            };

            card.style.display = 'block';
            doneCard.style.display = 'none';

        } catch (error) {
            console.error('Error checking daily quiz status:', error);
        }
    }

    window.checkAndShowDailyQuizCard = checkAndShowDailyQuizCard;

    function dismissQuizDoneCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('quizDoneCardDismissedDate', today);
        document.getElementById('daily-quiz-done-card').style.display = 'none';
    }
    window.dismissQuizDoneCard = dismissQuizDoneCard;

    /**
     * Called after daily quiz is completed to update dashboard card
     */
    window.refreshDailyQuizCard = function() {
        const card = document.getElementById('daily-quiz-card');
        const doneCard = document.getElementById('daily-quiz-done-card');
        if (card) {
            card.style.transition = 'opacity 0.5s, transform 0.5s';
            card.style.opacity = '0';
            card.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                card.style.display = 'none';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
                if (doneCard) doneCard.style.display = 'flex';
            }, 500);
        }
    };
    </script>

    <script>
    // ===== WEEKLY PROGRESS PHOTO CARD LOGIC =====

    /**
     * Check if it's Monday and user hasn't uploaded a progress photo this week.
     * Shows the card only on Mondays (or any day the user hasn't done it that week).
     */
    async function checkAndShowProgressPhotoCard() {
        if (!window.currentUser) return;
        if (window._onboardingWizardPending) return;
        const wizard = document.getElementById('onboarding-wizard');
        if (wizard && wizard.style.display !== 'none') return;

        const card = document.getElementById('weekly-progress-photo-card');
        const doneCard = document.getElementById('weekly-progress-photo-done-card');
        const uploadingCard = document.getElementById('weekly-progress-photo-uploading');
        if (!card || !doneCard) return;

        try {
            // Only show on Mondays (day 1)
            const today = new Date();
            if (today.getDay() !== 1) {
                card.style.display = 'none';
                doneCard.style.display = 'none';
                if (uploadingCard) uploadingCard.style.display = 'none';
                return;
            }

            // Check if user already uploaded this week
            const thisWeeksPhoto = await db.progressPhotos.getThisWeeksPhoto(window.currentUser.id);

            if (thisWeeksPhoto) {
                // Already done this week
                card.style.display = 'none';
                if (uploadingCard) uploadingCard.style.display = 'none';
                var d = new Date();
                var todayStr = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                doneCard.style.display = localStorage.getItem('progressPhotoDoneCardDismissedDate') === todayStr ? 'none' : 'flex';
            } else {
                // Show the upload card
                card.style.display = 'block';
                doneCard.style.display = 'none';
                if (uploadingCard) uploadingCard.style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking progress photo status:', error);
        }
    }

    /**
     * Handle progress photo file selection and upload
     */
    async function handleProgressPhotoSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const card = document.getElementById('weekly-progress-photo-card');
        const uploadingCard = document.getElementById('weekly-progress-photo-uploading');
        const doneCard = document.getElementById('weekly-progress-photo-done-card');

        try {
            // Show uploading state
            if (card) card.style.display = 'none';
            if (uploadingCard) uploadingCard.style.display = 'block';

            const user = await window.supabaseClient.auth.getUser();
            const userId = user?.data?.user?.id;

            if (!userId) {
                throw new Error('User not authenticated');
            }

            // Upload photo to B2
            const formData = new FormData();
            formData.append('file', file);
            formData.append('userId', userId);

            const uploadResponse = await fetch('/api/upload-progress-photo', {
                method: 'POST',
                body: formData
            });

            if (!uploadResponse.ok) {
                const errorData = await uploadResponse.json();
                throw new Error(errorData.error || 'Failed to upload photo');
            }

            const uploadData = await uploadResponse.json();

            // Save to database
            await db.progressPhotos.save(userId, uploadData.url, uploadData.fileName);

            // Award 15 XP (add to lifetime_points for leveling)
            try {
                const { data: currentPoints } = await supabaseClient
                    .from('user_points')
                    .select('lifetime_points')
                    .eq('user_id', userId)
                    .maybeSingle();

                if (currentPoints) {
                    await supabaseClient
                        .from('user_points')
                        .update({ lifetime_points: (currentPoints.lifetime_points || 0) + 15 })
                        .eq('user_id', userId);
                } else {
                    await supabaseClient
                        .from('user_points')
                        .insert({ user_id: userId, lifetime_points: 15, current_points: 0 });
                }

                if (typeof triggerXPBarRainbow === 'function') triggerXPBarRainbow();
                if (typeof refreshLevelDisplay === 'function') refreshLevelDisplay();
            } catch (xpError) {
                console.log('XP award skipped:', xpError);
            }

            // Show success - transition to done card
            if (uploadingCard) uploadingCard.style.display = 'none';
            if (doneCard) doneCard.style.display = 'flex';

            // Refresh points display if visible
            if (typeof refreshPointsDisplay === 'function') {
                refreshPointsDisplay();
            }

            console.log('Progress photo uploaded successfully!');

        } catch (error) {
            console.error('Error uploading progress photo:', error);
            if (uploadingCard) uploadingCard.style.display = 'none';
            if (card) card.style.display = 'block';
            alert('Failed to upload progress photo. Please try again.');
        }

        // Reset file input so same file can be re-selected
        event.target.value = '';
    }

    function dismissProgressPhotoDoneCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('progressPhotoDoneCardDismissedDate', today);
        document.getElementById('weekly-progress-photo-done-card').style.display = 'none';
    }

    // Set up event listeners
    (function() {
        // Card click triggers file input
        var photoCard = document.getElementById('weekly-progress-photo-card');
        var photoInput = document.getElementById('progress-photo-input');
        if (photoCard && photoInput) {
            photoCard.onclick = function() { photoInput.click(); };
            photoInput.onchange = handleProgressPhotoSelect;
        }
    })();

    // Make functions globally available
    window.dismissProgressPhotoDoneCard = dismissProgressPhotoDoneCard;
    window.checkAndShowProgressPhotoCard = checkAndShowProgressPhotoCard;
    </script>

    <script>
    // ===== DAILY MEAL TIP CARD LOGIC =====

    /**
     * Check and show the daily meal tip card with the most recent meal pattern insight.
     * Shows one insight per day, dismissible. Reappears next day with a new insight.
     */
    async function checkAndShowMealTipCard() {
        if (!window.currentUser) return;
        if (window._onboardingWizardPending) return;
        const wizard = document.getElementById('onboarding-wizard');
        if (wizard && wizard.style.display !== 'none') return;

        const card = document.getElementById('daily-meal-tip-card');
        if (!card) return;

        // Check if dismissed today
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        if (localStorage.getItem('mealTipCardDismissedDate') === today) {
            card.style.display = 'none';
            return;
        }

        try {
            const session = await window.authHelpers?.getSession();
            if (!session?.user) { card.style.display = 'none'; return; }

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);

            const { data: meals, error } = await window.supabaseClient
                .from('meal_logs')
                .select('meal_date, meal_time, meal_type, calories, protein_g, carbs_g, fat_g, fiber_g, micronutrients')
                .eq('user_id', session.user.id)
                .gte('meal_date', getLocalDateString(sevenDaysAgo))
                .order('meal_date', { ascending: true });

            if (error || !meals || meals.length < 3) {
                card.style.display = 'none';
                return;
            }

            // Reuse the existing analyzeMealPatterns function
            var insights = [];
            if (typeof analyzeMealPatterns === 'function') {
                insights = analyzeMealPatterns(meals);
            }

            if (!insights || insights.length === 0) {
                card.style.display = 'none';
                return;
            }

            // Pick one insight for today (rotate by day-of-year so it changes daily)
            var dayOfYear = Math.floor((d - new Date(d.getFullYear(), 0, 0)) / 86400000);
            var insightIndex = dayOfYear % insights.length;
            var tip = insights[insightIndex];

            // Strip HTML tags for the card (keep it clean)
            var tipText = tip.text.replace(/<strong>/g, '').replace(/<\/strong>/g, '');
            document.getElementById('daily-meal-tip-text').textContent = tipText;

            card.style.display = 'block';
        } catch (err) {
            console.error('Error in checkAndShowMealTipCard:', err);
            card.style.display = 'none';
        }
    }

    function dismissMealTipCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('mealTipCardDismissedDate', today);
        var card = document.getElementById('daily-meal-tip-card');
        if (card) {
            card.style.transition = 'opacity 0.4s, transform 0.4s';
            card.style.opacity = '0';
            card.style.transform = 'translateY(-15px)';
            setTimeout(function() { card.style.display = 'none'; card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }, 400);
        }
    }

    window.checkAndShowMealTipCard = checkAndShowMealTipCard;
    window.dismissMealTipCard = dismissMealTipCard;
    </script>

    <script>
    // ===== DAILY WORKOUT TREND CARD LOGIC =====

    /**
     * Check and show the daily workout trend card on the home screen.
     * Analyzes recent workout history and shows a summary insight.
     */
    async function checkAndShowWorkoutTrendCard() {
        if (!window.currentUser) return;
        if (window._onboardingWizardPending) return;
        const wizard = document.getElementById('onboarding-wizard');
        if (wizard && wizard.style.display !== 'none') return;

        const card = document.getElementById('daily-workout-trend-card');
        if (!card) return;

        // Check if dismissed today
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        if (localStorage.getItem('workoutTrendCardDismissedDate') === today) {
            card.style.display = 'none';
            return;
        }

        try {
            var workoutData = await _getWorkoutTrendData();
            if (!workoutData) {
                card.style.display = 'none';
                return;
            }

            var textEl = document.getElementById('daily-workout-trend-text');
            if (textEl) textEl.textContent = workoutData.insight;
            card.style.display = 'block';
        } catch (err) {
            console.error('Error in checkAndShowWorkoutTrendCard:', err);
            card.style.display = 'none';
        }
    }

    /**
     * Load and show workout trend in the Movement tab card.
     */
    async function loadMovementTrendCard() {
        var card = document.getElementById('movement-workout-trend-card');
        if (!card) return;

        // Check if dismissed today
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        if (localStorage.getItem('movementTrendCardDismissedDate') === today) {
            card.style.display = 'none';
            return;
        }

        try {
            var workoutData = await _getWorkoutTrendData();
            if (!workoutData) {
                card.style.display = 'none';
                return;
            }

            // Update Movement tab trend stats
            var weekEl = document.getElementById('movement-trend-week-count');
            var totalEl = document.getElementById('movement-trend-total-count');
            var streakEl = document.getElementById('movement-trend-streak');
            var insightEl = document.getElementById('movement-trend-insight');

            if (weekEl) weekEl.textContent = workoutData.thisWeekCount;
            if (totalEl) totalEl.textContent = workoutData.totalCount;
            if (streakEl) streakEl.textContent = workoutData.weekStreak;
            if (insightEl) insightEl.textContent = workoutData.insight;

            card.style.display = 'block';
        } catch (err) {
            console.error('Error loading movement trend card:', err);
            card.style.display = 'none';
        }
    }

    /**
     * Get workout trend data from history. Shared between home and movement tab.
     */
    async function _getWorkoutTrendData() {
        if (!window.currentUser) return null;

        try {
            // Get workout history (last 60 days worth)
            var history = await dbHelpers.workouts.getHistory(window.currentUser.id, 500);
            if (!history || history.length === 0) return null;

            // Get unique workout dates
            var uniqueDates = [];
            var dateSet = {};
            history.forEach(function(w) {
                if (w.workout_date && !dateSet[w.workout_date]) {
                    dateSet[w.workout_date] = true;
                    uniqueDates.push(w.workout_date);
                }
            });

            uniqueDates.sort(function(a, b) { return new Date(b) - new Date(a); });

            var totalCount = uniqueDates.length;
            if (totalCount === 0) return null;

            // This week's workouts (Mon-Sun)
            var now = new Date();
            var dayOfWeek = now.getDay(); // 0=Sun, 1=Mon...
            var mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            var monday = new Date(now);
            monday.setDate(monday.getDate() - mondayOffset);
            monday.setHours(0, 0, 0, 0);

            var thisWeekCount = 0;
            uniqueDates.forEach(function(dateStr) {
                var dateObj = new Date(dateStr + 'T12:00:00');
                if (dateObj >= monday) thisWeekCount++;
            });

            // Calculate week streak (consecutive weeks with at least 1 workout)
            var weekStreak = 0;
            var checkWeekStart = new Date(monday);

            for (var w = 0; w < 52; w++) {
                var weekStart = new Date(checkWeekStart);
                weekStart.setDate(weekStart.getDate() - (w * 7));
                var weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);

                var hasWorkout = uniqueDates.some(function(dateStr) {
                    var dateObj = new Date(dateStr + 'T12:00:00');
                    return dateObj >= weekStart && dateObj < weekEnd;
                });

                if (hasWorkout) {
                    weekStreak++;
                } else {
                    break;
                }
            }

            // Last week's workouts for comparison
            var lastMonday = new Date(monday);
            lastMonday.setDate(lastMonday.getDate() - 7);
            var lastWeekCount = 0;
            uniqueDates.forEach(function(dateStr) {
                var dateObj = new Date(dateStr + 'T12:00:00');
                if (dateObj >= lastMonday && dateObj < monday) lastWeekCount++;
            });

            // Generate insight
            var insight = '';
            if (thisWeekCount === 0 && lastWeekCount > 0) {
                insight = 'No workouts logged this week yet. Last week you hit ' + lastWeekCount + ' session' + (lastWeekCount !== 1 ? 's' : '') + ' \u2014 keep the momentum going!';
            } else if (thisWeekCount > lastWeekCount && lastWeekCount > 0) {
                insight = 'You\'re ahead of last week! ' + thisWeekCount + ' workout' + (thisWeekCount !== 1 ? 's' : '') + ' so far vs ' + lastWeekCount + ' last week. Keep pushing!';
            } else if (thisWeekCount === lastWeekCount && thisWeekCount > 0) {
                insight = 'Matching last week\'s pace with ' + thisWeekCount + ' workout' + (thisWeekCount !== 1 ? 's' : '') + '. Consistency is key!';
            } else if (thisWeekCount > 0 && lastWeekCount === 0) {
                insight = 'Great start! ' + thisWeekCount + ' workout' + (thisWeekCount !== 1 ? 's' : '') + ' this week. You\'re building a solid habit!';
            } else if (thisWeekCount > 0) {
                insight = thisWeekCount + ' workout' + (thisWeekCount !== 1 ? 's' : '') + ' this week. ' + (weekStreak > 1 ? weekStreak + '-week streak \u2014 you\'re on fire!' : 'Keep it up!');
            } else {
                insight = 'Start your week strong \u2014 your ' + totalCount + ' total workout' + (totalCount !== 1 ? 's' : '') + ' show you\'ve got what it takes!';
            }

            return {
                thisWeekCount: thisWeekCount,
                lastWeekCount: lastWeekCount,
                totalCount: totalCount,
                weekStreak: weekStreak,
                insight: insight
            };
        } catch (err) {
            console.error('Error computing workout trend data:', err);
            return null;
        }
    }

    function dismissWorkoutTrendCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('workoutTrendCardDismissedDate', today);
        var card = document.getElementById('daily-workout-trend-card');
        if (card) {
            card.style.transition = 'opacity 0.4s, transform 0.4s';
            card.style.opacity = '0';
            card.style.transform = 'translateY(-15px)';
            setTimeout(function() { card.style.display = 'none'; card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }, 400);
        }
    }

    function dismissMovementTrendCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('movementTrendCardDismissedDate', today);
        var card = document.getElementById('movement-workout-trend-card');
        if (card) {
            card.style.transition = 'opacity 0.4s, transform 0.4s';
            card.style.opacity = '0';
            card.style.transform = 'translateY(-15px)';
            setTimeout(function() { card.style.display = 'none'; card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }, 400);
        }
    }

    window.checkAndShowWorkoutTrendCard = checkAndShowWorkoutTrendCard;
    window.loadMovementTrendCard = loadMovementTrendCard;
    window.dismissWorkoutTrendCard = dismissWorkoutTrendCard;
    window.dismissMovementTrendCard = dismissMovementTrendCard;
    </script>

    <div style="padding: 0 25px;">
        <!-- Calorie Counter Widget -->
        <div class="calorie-widget-card">
            <div class="calorie-widget-header">
                <h3 style="margin: 0; font-size: 1.1rem;">Today's Nutrition</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="camera-btn-widget" onclick="openMealCameraDirect('widget')" title="Take a photo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </button>
                    <button class="camera-btn-widget" onclick="openMealTextInput('widget')" title="Type your meal">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                            <path d="M2 2l7.586 7.586"></path>
                            <circle cx="11" cy="11" r="2"></circle>
                        </svg>
                    </button>
                    <button class="camera-btn-widget" onclick="openRecentMealsModal()" title="Recent meals">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="calorie-widget-content">
                <!-- Calories Progress -->
                <div class="calorie-progress-main">
                    <div class="calorie-numbers">
                        <span class="calorie-current" id="widget-calories-current">0</span>
                        <span class="calorie-separator">/</span>
                        <span class="calorie-goal" id="widget-calories-goal">2000</span>
                        <span class="calorie-unit">kcal</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="widget-calories-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Macros Grid -->
                <div class="macros-grid">
                    <div class="macro-item">
                        <div class="macro-label">Protein</div>
                        <div class="macro-value"><span id="widget-protein">0</span>g / <span id="widget-protein-goal">50</span>g</div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-protein" id="widget-protein-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-label">Carbs</div>
                        <div class="macro-value"><span id="widget-carbs">0</span>g / <span id="widget-carbs-goal">250</span>g</div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-carbs" id="widget-carbs-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-label">Fat</div>
                        <div class="macro-value"><span id="widget-fat">0</span>g / <span id="widget-fat-goal">70</span>g</div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-fat" id="widget-fat-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="calorie-widget-footer">
                    <button class="view-details-btn" onclick="switchAppTab('meals', this); setTimeout(() => switchWeek('calorie-tracker', document.querySelector('.pill-btn')), 100)">
                        View Details →
                    </button>
                </div>
            </div>
        </div>

        <!-- Avatar Companion Widget - Disabled for now -->

        <!-- Today's Priority Section - Only shown when user has meal plan -->
        <div id="todays-priority-section">
            <h3 style="margin-bottom: 15px; margin-top: 30px;">Today's Priority</h3>

            <!-- Cycle Sync Injection Container -->
            <div id="today-meals-container"></div>
            <!-- Quick Action Card -->
             <div class="card" onclick="switchAppTab('meals', this);" style="cursor: pointer;">
                <div class="card-body" style="max-height: none; padding: 25px; opacity: 1; display: flex; align-items: center; gap: 20px;">
                    <div style="background: var(--accent-green); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">🌿</div>
                    <div>
                        <h4 style="margin: 0 0 5px 0; border: none; padding: 0;">Current Phase</h4>
                        <p style="margin: 0; font-weight: 500; color: var(--primary);">Week 1: The Flush</p>
                        <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">View today's menu &rarr;</p>
                    </div>
                </div>
             </div>
        </div>


        <!-- Fitbit Activity Card (hidden until connected) -->
        <div id="fitbit-dashboard-card" style="display: none; margin: 20px 0 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#00B0B9;"><circle cx="12" cy="4" r="2.5"/><circle cx="12" cy="9.5" r="2.5"/><circle cx="12" cy="15" r="2"/><circle cx="12" cy="19.5" r="1.5"/><circle cx="7" cy="9.5" r="1.5"/><circle cx="17" cy="9.5" r="1.5"/></svg>
                    Fitbit
                </h3>
                <button onclick="syncFitbitNow()" id="fitbit-sync-btn" style="background: none; border: none; color: #00B0B9; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" style="width:14px; height:14px; fill:#00B0B9;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    Sync
                </button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <!-- Steps -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">👟</div>
                    <div id="fitbit-steps" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Steps</div>
                </div>
                <!-- Sleep -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">😴</div>
                    <div id="fitbit-sleep" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Sleep</div>
                </div>
                <!-- Heart Rate -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">❤️</div>
                    <div id="fitbit-heart-rate" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">BPM</div>
                </div>
            </div>
            <div id="fitbit-details-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <!-- Active Minutes -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #FFF7ED; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">🔥</div>
                    <div>
                        <div id="fitbit-active-mins" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Active Mins</div>
                    </div>
                </div>
                <!-- Calories -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #F0FDF4; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">⚡</div>
                    <div>
                        <div id="fitbit-calories" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Cal Burned</div>
                    </div>
                </div>
            </div>
            <div id="fitbit-last-sync" style="text-align: right; font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; padding-right: 4px;"></div>
        </div>

        <!-- WHOOP Activity Card (hidden until connected) -->
        <div id="whoop-dashboard-card" style="display: none; margin: 20px 0 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#1a1a1a;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    WHOOP
                </h3>
                <button onclick="syncWhoopNow()" id="whoop-sync-btn" style="background: none; border: none; color: #1a1a1a; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" style="width:14px; height:14px; fill:#1a1a1a;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    Sync
                </button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <!-- Recovery -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">💚</div>
                    <div id="whoop-recovery" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Recovery</div>
                </div>
                <!-- Sleep -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">😴</div>
                    <div id="whoop-sleep" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Sleep</div>
                </div>
                <!-- Resting HR -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">❤️</div>
                    <div id="whoop-resting-hr" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">RHR</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <!-- HRV -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #EFF6FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">📊</div>
                    <div>
                        <div id="whoop-hrv" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">HRV (ms)</div>
                    </div>
                </div>
                <!-- Strain -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #FFF7ED; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">🔥</div>
                    <div>
                        <div id="whoop-strain" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Strain</div>
                    </div>
                </div>
            </div>
            <div id="whoop-last-sync" style="text-align: right; font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; padding-right: 4px;"></div>
        </div>

        <!-- Oura Ring Activity Card (hidden until connected) -->
        <div id="oura-dashboard-card" style="display: none; margin: 20px 0 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#c4a862;"><circle cx="12" cy="12" r="9" stroke="#c4a862" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="5" stroke="#c4a862" stroke-width="1.5" fill="none"/></svg>
                    Oura
                </h3>
                <button onclick="syncOuraNow()" id="oura-sync-btn" style="background: none; border: none; color: #c4a862; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" style="width:14px; height:14px; fill:#c4a862;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    Sync
                </button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <!-- Steps -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">👟</div>
                    <div id="oura-steps" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Steps</div>
                </div>
                <!-- Sleep -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">😴</div>
                    <div id="oura-sleep" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Sleep</div>
                </div>
                <!-- Readiness -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">🎯</div>
                    <div id="oura-readiness" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Ready</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <!-- Sleep Score -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #F0F0FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">💤</div>
                    <div>
                        <div id="oura-sleep-score" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Sleep Score</div>
                    </div>
                </div>
                <!-- Calories -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #F0FDF4; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">⚡</div>
                    <div>
                        <div id="oura-calories" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Active Cal</div>
                    </div>
                </div>
            </div>
            <div id="oura-last-sync" style="text-align: right; font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; padding-right: 4px;"></div>
        </div>

        <!-- Strava Activity Card (hidden until connected) -->
        <div id="strava-dashboard-card" style="display: none; margin: 20px 0 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#FC4C02;"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                    Strava
                </h3>
                <button onclick="syncStravaNow()" id="strava-sync-btn" style="background: none; border: none; color: #FC4C02; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" style="width:14px; height:14px; fill:#FC4C02;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    Sync
                </button>
            </div>
            <div id="strava-latest-activity" style="background: white; border-radius: 14px; padding: 16px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div id="strava-activity-name" style="font-weight: 700; color: var(--text-main);">No recent activity</div>
                    <div id="strava-activity-type" style="font-size: 0.7rem; background: #FFF4ED; color: #FC4C02; padding: 2px 8px; border-radius: 6px; font-weight: 600;"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div style="text-align: center;">
                        <div id="strava-distance" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Distance</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="strava-duration" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Time</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="strava-heart-rate" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Avg HR</div>
                    </div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <!-- Calories -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #FFF7ED; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">🔥</div>
                    <div>
                        <div id="strava-calories" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Calories</div>
                    </div>
                </div>
                <!-- Elevation -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #F0FDF4; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">⛰️</div>
                    <div>
                        <div id="strava-elevation" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Elevation</div>
                    </div>
                </div>
            </div>
            <div id="strava-last-sync" style="text-align: right; font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; padding-right: 4px;"></div>
        </div>

        <!-- Live Challenges Section -->
        <div style="margin: 20px 0 15px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-green); padding-bottom: 8px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h3 style="margin: 0;">Monthly Rares</h3>
                <span style="background: linear-gradient(135deg, #f59e0b, #f97316); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; letter-spacing: 1px;">LIMITED</span>
            </div>
            <button onclick="openRareRewardsModal()" style="background: none; border: none; color: var(--primary); font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; text-decoration: underline;">
                View Collection &rarr;
            </button>
        </div>

        <div id="rare-challenges-preview" style="display: flex; gap: 12px; overflow-x: auto; padding: 5px 5px 15px 5px; margin-bottom: 20px; scrollbar-width: none; -ms-overflow-style: none;">
            <style>#rare-challenges-preview::-webkit-scrollbar { display: none; }</style>
            <!-- Featured monthly rare card rendered dynamically by renderFeaturedRareCard() -->
        </div>

        <div style="margin: 20px 0 15px 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">Friend Challenges</h3>
            <button onclick="openCreateChallengeModal()" style="background: none; border: none; color: var(--primary); font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Create Challenge
            </button>
        </div>
        <div id="home-challenges-container">
            <!-- Challenges will be loaded here by loadHomeChallenges() -->
            <div id="home-challenges-empty" class="card" style="border-left: 5px solid #7c3aed;">
                <div class="card-body" style="max-height: none; padding: 16px; opacity: 1; display: flex; align-items: center; gap: 12px;">
                    <div style="background: linear-gradient(135deg, rgba(124,58,237,0.15), rgba(99,102,241,0.15)); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">🏆</div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 4px 0; border: none; padding: 0; font-size: 0.95rem;">Start Level Up Challenge</h4>
                        <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Challenge friends, earn 2x XP & win rare drops</p>
                    </div>
                    <button onclick="openCreateChallengeModal()" style="background: linear-gradient(135deg, #7c3aed, #6366f1); color: white; border: none; padding: 8px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap;">
                        Start
                    </button>
                </div>
            </div>
            <div id="home-challenges-list"></div>
        </div>

    </div>
</div>

<!-- MEALS VIEW (Contains Week Tabs) -->
<div id="view-meals" class="app-view" style="display:none;">
    <div class="app-header">
        <div class="app-logo">Meals</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="coin-header-widget" onclick="openCoinShop()">
                <span class="coin-emoji">🪙</span>
                <span class="coin-amount coin-balance-sync">0</span>
                <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
            </div>
            <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
        </div>
    </div>
    
    <!-- Week Pills Navigation -->
    <div class="week-scroller" id="meals-nav-pills">
        <button class="pill-btn active" onclick="switchWeek('today', this)">Today</button>
        <button class="pill-btn" onclick="switchWeek('calorie-tracker', this)" style="background: var(--accent-green); color: var(--primary); font-weight: 600; border-color: rgba(4, 106, 56, 0.2);">📸 Calorie Tracker</button>
        <button class="pill-btn" onclick="switchWeek('week1', this)">Week 1</button>
        <button class="pill-btn" onclick="switchWeek('week2', this)">Week 2</button>
        <button class="pill-btn" onclick="switchWeek('week3', this)">Week 3</button>
        <button class="pill-btn" onclick="switchWeek('week4', this)">Week 4</button>
        <button class="pill-btn" onclick="switchWeek('dining', this)">Dining Out</button>
        <button class="pill-btn" onclick="switchWeek('shopping', this)" style="background: var(--accent-green); color: var(--primary); font-weight: 600; border-color: rgba(4, 106, 56, 0.2);">🛒 Shopping List</button>
    </div>

    <!-- Container for Week Content -->
    <div id="meals-content-container">
        <!-- Today's Meals View -->
        <div class="view-section active" id="today">
            <div id="today-meals-content">
                <!-- Current day's meals will be injected here -->
                <div style="text-align:center; padding:40px; color:var(--text-muted);">
                    <p>Loading your meals for today...</p>
                </div>
            </div>
        </div>

        <!-- Your Tailored Meal Plan View -->
        <div class="view-section" id="meal-plan-store" style="display: none;">
            <div id="ai-meal-plan-container">
                <!-- State 1: No plan yet - CTA to generate -->
                <div id="ai-plan-empty" style="padding: 30px 20px; text-align: center;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(123,168,131,0.15), rgba(99,102,241,0.15)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2.2rem;">
                        🥗
                    </div>
                    <h2 style="margin: 0 0 10px; font-family: 'Playfair Display'; color: var(--primary); font-size: 1.5rem;">Your Tailored Meal Plan</h2>
                    <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 25px; line-height: 1.6;">Get a personalized weekly meal plan tailored to your goals, dietary preferences and nutritional targets. Generate a fresh plan each week with meal photos!</p>
                    <button onclick="requestAiMealPlan()" style="background: linear-gradient(135deg, var(--primary) 0%, #10b981 100%); color: white; border: none; padding: 14px 32px; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(123,168,131,0.3);">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        Generate My Meal Plan
                    </button>
                    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 15px;">Or ask your FITGotchi coach: "Create me a meal plan"</p>
                </div>

                <!-- State 2: Generating -->
                <div id="ai-plan-generating" style="display: none; padding: 40px 20px; text-align: center;">
                    <div class="learning-spinner" style="margin: 0 auto 20px;"></div>
                    <h3 style="margin: 0 0 10px; color: var(--text-main);">Creating Your Meal Plan...</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem;" id="ai-plan-gen-status">Analyzing your goals and preferences...</p>
                    <div style="max-width: 300px; margin: 20px auto 0;">
                        <div style="height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden;">
                            <div id="ai-plan-gen-progress" style="height: 100%; background: linear-gradient(90deg, var(--primary), #10b981); width: 10%; transition: width 0.5s ease; border-radius: 2px;"></div>
                        </div>
                    </div>
                </div>

                <!-- State 3: Plan loaded - week navigation + meals -->
                <div id="ai-plan-loaded" style="display: none;">
                    <!-- Plan Header -->
                    <div id="ai-plan-header" style="padding: 20px; background: linear-gradient(135deg, rgba(123,168,131,0.08), rgba(99,102,241,0.05)); border-bottom: 1px solid #f1f5f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 id="ai-plan-name" style="margin: 0 0 4px; font-family: 'Playfair Display'; color: var(--primary); font-size: 1.3rem;">Your Meal Plan</h2>
                                <p id="ai-plan-desc" style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">Tailored to your goals</p>
                            </div>
                            <button onclick="regenerateAiMealPlan()" style="background: none; border: 1px solid var(--primary); color: var(--primary); padding: 6px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                                Regenerate
                            </button>
                        </div>
                    </div>

                    <!-- Week Tabs (dynamically rendered based on generated weeks) -->
                    <div class="week-scroller" id="ai-plan-week-tabs" style="padding: 10px 15px;">
                        <!-- Tabs rendered by renderAiPlanWeekTabs() -->
                    </div>

                    <!-- Week Theme Banner -->
                    <div id="ai-plan-week-theme" style="padding: 0 15px 10px;">
                        <div style="background: linear-gradient(to right, #eef2f3, #ffffff); border-radius: 12px; padding: 20px;">
                            <div style="font-family: 'Inter'; text-transform: uppercase; color: var(--secondary); font-weight: 600; letter-spacing: 1px; margin-bottom: 6px; font-size: 0.75rem;" id="ai-week-label">Week 1</div>
                            <h3 id="ai-week-theme-title" style="margin: 0 0 6px; font-size: 1.2rem; color: var(--text-main);">Foundation</h3>
                            <p id="ai-week-theme-desc" style="margin: 0; font-size: 0.9rem; color: #555;"></p>
                        </div>
                    </div>

                    <!-- Day Tabs -->
                    <div class="sub-nav" id="ai-plan-day-tabs" style="padding: 0 15px;">
                        <button class="sub-btn active" onclick="switchAiPlanDay(0, this)">Mon</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(1, this)">Tue</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(2, this)">Wed</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(3, this)">Thu</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(4, this)">Fri</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(5, this)">Sat</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(6, this)">Sun</button>
                    </div>

                    <!-- Daily Nutrition Summary -->
                    <div id="ai-plan-day-nutrition" style="padding: 10px 15px;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <div class="ai-plan-macro-pill" id="ai-day-cal" style="background: #f1f5f9; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: var(--text-main);">0 cal</div>
                            <div class="ai-plan-macro-pill" style="background: rgba(59,130,246,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: #3b82f6;" id="ai-day-protein">0g protein</div>
                            <div class="ai-plan-macro-pill" style="background: rgba(245,158,11,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: #f59e0b;" id="ai-day-carbs">0g carbs</div>
                            <div class="ai-plan-macro-pill" style="background: rgba(239,68,68,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: #ef4444;" id="ai-day-fat">0g fat</div>
                        </div>
                    </div>

                    <!-- Meals List for the Day -->
                    <div id="ai-plan-meals-list" style="padding: 0 15px 20px;">
                        <!-- Meal cards rendered dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Calorie Tracker View -->
        <div class="view-section" id="calorie-tracker">
            <div style="padding: 25px;">
                <!-- Log Meal Buttons - Camera and Text -->
                <div style="text-align: center; margin: 0 0 25px 0; display: flex; justify-content: center; gap: 16px;">
                    <button class="meal-icon-btn" onclick="openMealCameraDirect('tracker')" title="Take a photo">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </button>
                    <button class="meal-icon-btn" onclick="openMealTextInput('tracker')" title="Type your meal">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                            <path d="M2 2l7.586 7.586"></path>
                            <circle cx="11" cy="11" r="2"></circle>
                        </svg>
                    </button>
                    <button class="meal-icon-btn" onclick="openRecentMealsModal()" title="Recent meals">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </button>
                </div>

                <!-- Daily Summary Card -->
                <div class="calorie-tracker-summary">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 0 0 20px 0;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-main);">Daily Nutrition Tracker</h2>
                        <div class="streak-inline" id="streak-inline-section">
                            <span class="streak-inline-flame">&#x1F525;</span>
                            <span class="streak-inline-count" id="streak-inline-count">0</span>
                        </div>
                    </div>

                    <!-- Calorie Progress Large (Tri-color macro ring) -->
                    <div class="calorie-progress-large">
                        <div class="calorie-circle">
                            <svg class="calorie-circle-svg" viewBox="0 0 200 200" id="calorie-circle-svg">
                                <circle class="calorie-circle-bg" cx="100" cy="100" r="90" fill="none" stroke="#f0f0f0" stroke-width="12"/>
                            </svg>
                            <div class="calorie-circle-text">
                                <div class="calorie-circle-numbers">
                                    <span class="calorie-circle-current" id="tracker-calories-current">0</span>
                                    <span class="calorie-circle-separator">/</span>
                                    <span class="calorie-circle-goal" id="tracker-calories-goal">2000</span>
                                </div>
                                <div class="calorie-circle-label">calories</div>
                            </div>
                        </div>
                    </div>

                    <!-- Macro Ring Legend -->
                    <div class="macro-ring-legend" id="macro-ring-legend">
                        <div class="macro-ring-legend-item"><span class="macro-ring-dot" style="background: #3b82f6;"></span><span class="macro-ring-label">Protein</span><span class="macro-ring-pct" id="macro-ring-protein-pct">--</span></div>
                        <div class="macro-ring-legend-item"><span class="macro-ring-dot" style="background: #f59e0b;"></span><span class="macro-ring-label">Carbs</span><span class="macro-ring-pct" id="macro-ring-carbs-pct">--</span></div>
                        <div class="macro-ring-legend-item"><span class="macro-ring-dot" style="background: #ef4444;"></span><span class="macro-ring-label">Fat</span><span class="macro-ring-pct" id="macro-ring-fat-pct">--</span></div>
                    </div>

                    <!-- Macros Progress Bars -->
                    <div class="macros-detail-grid">
                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Protein</span>
                                <span class="macro-detail-value"><span id="tracker-protein">0</span> / <span id="tracker-protein-goal">50</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-protein" id="tracker-protein-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Carbs</span>
                                <span class="macro-detail-value"><span id="tracker-carbs">0</span> / <span id="tracker-carbs-goal">250</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-carbs" id="tracker-carbs-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Fat</span>
                                <span class="macro-detail-value"><span id="tracker-fat">0</span> / <span id="tracker-fat-goal">70</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-fat" id="tracker-fat-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Fiber</span>
                                <span class="macro-detail-value"><span id="tracker-fiber">0</span> / <span id="tracker-fiber-goal">25</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-fiber" id="tracker-fiber-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Micronutrients Section -->
                    <div class="tracker-micro-section">
                        <div class="tracker-micro-header">Micronutrients</div>
                        <div class="tracker-micro-grid" id="tracker-micro-grid">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <!-- Hydration Circle (inside daily tracker card) -->
                    <div class="hydration-circle-container" id="hydration-section">
                        <div class="hydration-circle-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#0284c7"><path d="M12 2c0 0-8 9.5-8 14a8 8 0 0 0 16 0C20 11.5 12 2 12 2z"/></svg>
                            Hydration
                        </div>
                        <div id="hydration-goal-display" style="font-size:0.72rem; color:#0369a1; font-weight:600; margin-bottom:10px;">Goal: 2,000 ml</div>
                        <div class="hydration-circle-wrap" id="hydration-circle-tap" onclick="addHydrationGlass()">
                            <svg class="hydration-circle-svg" viewBox="0 0 100 100">
                                <circle class="hydration-circle-bg" cx="50" cy="50" r="42"/>
                                <circle class="hydration-circle-fill" id="hydration-circle-fill" cx="50" cy="50" r="42"
                                    stroke-dasharray="264" stroke-dashoffset="264"/>
                            </svg>
                            <div class="hydration-cup-icon">
                                <svg class="hydration-cup-svg" viewBox="0 0 24 24" id="hydration-cup-svg">
                                    <path d="M18 8h2a2 2 0 0 1 2 2v2a4 4 0 0 1-4 4h-.5M6 2h12l-1.5 16.5a2 2 0 0 1-2 1.5H9.5a2 2 0 0 1-2-1.5L6 2z"/>
                                </svg>
                                <span class="hydration-cup-count" id="hydration-cup-count">0/8</span>
                            </div>
                        </div>
                        <div class="hydration-circle-label" id="hydration-circle-label">0 / 2,000 ml</div>
                        <div class="hydration-circle-hint" id="hydration-circle-hint">Tap to add 250ml</div>
                    </div>
                </div>

                <!-- Today's Meals List -->
                <h3 style="margin: 25px 0 15px 0;">Today's Meals</h3>
                <div id="meals-log-list">
                    <div class="empty-state">
                        <p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                            📸 No meals logged yet today.<br>
                            <span style="font-size: 0.9rem;">Take a photo of your meal to get started!</span>
                        </p>
                    </div>
                </div>

                <!-- Log Your Day Button -->
                <div id="daily-log-bonus-section" style="margin: 25px 0; text-align: center;">
                    <button id="daily-log-btn" onclick="openDailyScorePopup()" style="
                        width: 100%;
                        padding: 16px 24px;
                        background: linear-gradient(135deg, var(--primary) 0%, #065f3a 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        box-shadow: 0 4px 12px rgba(4, 106, 56, 0.3);
                        transition: transform 0.15s ease, box-shadow 0.15s ease;
                    ">
                        <span style="font-size: 1.3rem;">&#x2705;</span>
                        <span>Log Your Meals for the Day</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 20px; font-size: 0.85rem;">+2 pts</span>
                    </button>
                    <p id="daily-log-hint" style="margin: 8px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">
                        Hit within 20% of your calorie &amp; macro goals to earn 2 bonus points
                    </p>
                </div>

                <!-- Daily Score Popup Modal -->
                <div class="score-popup-overlay" id="score-popup-overlay" style="display: none;" onclick="closeDailyScorePopup(event)">
                    <div class="score-popup-modal" onclick="event.stopPropagation()">
                        <button class="score-popup-close" onclick="closeDailyScorePopup()">&times;</button>
                        <div class="score-popup-header">Daily Score</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0;">
                            <div class="nutrition-score-ring">
                                <svg viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="42" fill="none" stroke="#bbf7d0" stroke-width="8"/>
                                    <circle id="popup-score-circle" cx="50" cy="50" r="42" fill="none" stroke="var(--primary)" stroke-width="8" stroke-linecap="round"
                                        style="stroke-dasharray: 264; stroke-dashoffset: 264; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.6s ease;"/>
                                </svg>
                                <div class="nutrition-score-value" id="popup-score-value">--</div>
                            </div>
                            <div style="text-align: left;">
                                <div style="font-size: 1.4rem; font-weight: 700; color: var(--text-main);" id="popup-score-grade">Track meals to see score</div>
                            </div>
                        </div>
                        <div class="score-breakdown" id="popup-score-breakdown">
                            <div class="score-breakdown-item"><span class="score-dot" style="background: var(--primary);"></span> Calories</div>
                            <div class="score-breakdown-item"><span class="score-dot" style="background: #3b82f6;"></span> Protein</div>
                            <div class="score-breakdown-item"><span class="score-dot" style="background: #f59e0b;"></span> Carbs</div>
                            <div class="score-breakdown-item"><span class="score-dot" style="background: #ef4444;"></span> Fat</div>
                        </div>
                        <button id="popup-claim-btn" onclick="claimDailyNutritionBonus()" style="
                            width: 100%;
                            padding: 14px 24px;
                            background: linear-gradient(135deg, var(--primary) 0%, #065f3a 100%);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 10px;
                            margin-top: 20px;
                            box-shadow: 0 4px 12px rgba(4, 106, 56, 0.3);
                        ">
                            <span style="font-size: 1.3rem;">&#x2705;</span>
                            <span>Claim Daily Bonus</span>
                            <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 20px; font-size: 0.85rem;">+2 pts</span>
                        </button>
                        <p id="popup-claim-hint" style="margin: 8px 0 0 0; font-size: 0.8rem; color: var(--text-muted); text-align: center;">
                            Hit within 20% of your calorie &amp; macro goals to earn 2 bonus points
                        </p>
                        <button id="popup-finish-day-btn" onclick="finishDayWithoutBonus()" style="
                            display: none;
                            width: 100%;
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 0.95rem;
                            font-weight: 600;
                            cursor: pointer;
                            align-items: center;
                            justify-content: center;
                            gap: 10px;
                            margin-top: 10px;
                        ">
                            <span>Finish Day Without Bonus</span>
                        </button>
                        <p id="popup-finish-hint" style="display: none; margin: 6px 0 0 0; font-size: 0.75rem; color: var(--text-muted); text-align: center;">
                            This marks all your meals as tracked for today so your AI coach knows you're done
                        </p>
                    </div>
                </div>

                <!-- Weekly Trends Button -->
                <button class="weekly-trends-btn" onclick="openWeeklyTrendsPage()">
                    <span class="weekly-trends-btn-left">
                        <span style="font-size: 1.3rem;">📊</span>
                        <span>Weekly Trends</span>
                    </span>
                    <span class="weekly-trends-btn-arrow">&#x203A;</span>
                </button>

                <!-- Daily Nutrition Score (hidden - now shown as popup) -->
                <div class="nutrition-score-card" id="nutrition-score-section" style="display: none;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                        <div class="nutrition-score-ring">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="42" fill="none" stroke="#bbf7d0" stroke-width="8"/>
                                <circle id="nutrition-score-circle" cx="50" cy="50" r="42" fill="none" stroke="var(--primary)" stroke-width="8" stroke-linecap="round"
                                    style="stroke-dasharray: 264; stroke-dashoffset: 264; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.6s ease;"/>
                            </svg>
                            <div class="nutrition-score-value" id="nutrition-score-value">--</div>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-size: 1rem; font-weight: 700; color: var(--text-main);">Daily Score</div>
                            <div class="nutrition-score-label" id="nutrition-score-grade">Track meals to see score</div>
                        </div>
                    </div>
                    <div class="score-breakdown" id="score-breakdown">
                        <div class="score-breakdown-item"><span class="score-dot" style="background: var(--primary);"></span> Calories</div>
                        <div class="score-breakdown-item"><span class="score-dot" style="background: #3b82f6;"></span> Protein</div>
                        <div class="score-breakdown-item"><span class="score-dot" style="background: #f59e0b;"></span> Carbs</div>
                        <div class="score-breakdown-item"><span class="score-dot" style="background: #ef4444;"></span> Fat</div>
                    </div>
                    <!-- Share Nutrition Card Button -->
                    <button id="share-nutrition-btn" onclick="shareNutritionToFeed()" style="display:flex; align-items:center; justify-content:center; gap:6px; width:100%; margin-top:12px; padding:10px 16px; background:linear-gradient(135deg, rgba(99,102,241,0.15), rgba(129,140,248,0.15)); border:1px solid rgba(99,102,241,0.25); border-radius:10px; color:var(--text-main); font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s;">
                        <span style="font-size:1rem;">🥗</span>
                        <span style="font-size:0.85rem;">Share Nutrition</span>
                    </button>
                </div>

                <!-- Streak Tracker (hidden - now inline in header) -->
                <div class="streak-tracker-card" id="streak-tracker-section" style="display: none;">
                    <div class="streak-header">
                        <div class="streak-flame">
                            <span style="font-size: 1.8rem;">&#x1F525;</span>
                            <div>
                                <div class="streak-count" id="streak-count">0</div>
                                <div class="streak-label">Day Streak</div>
                            </div>
                        </div>
                        <div class="streak-next-bonus" id="streak-next-bonus">Loading...</div>
                    </div>
                    <div class="streak-days-grid" id="streak-days-grid">
                        <!-- 7 day dots rendered by JS -->
                    </div>
                    <div class="streak-progress-bar">
                        <div class="streak-progress-fill" id="streak-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 6px;">
                        <span style="font-size: 0.72rem; color: #92400e;">Current</span>
                        <span style="font-size: 0.72rem; color: #92400e;" id="streak-target-label">Next: 7-day (5 pts)</span>
                    </div>
                </div>

                <!-- Weekly trends, meal patterns, meal journal moved to Weekly Trends page -->

                <!-- Cycle-Synced Nutrition Tips -->
                <div class="cycle-nutrition-card" id="cycle-nutrition-section" style="display: none;">
                    <div class="cycle-nutrition-header">
                        <span id="cycle-nutrition-icon" style="font-size: 1.5rem;"></span>
                        <div>
                            <div class="cycle-nutrition-phase" id="cycle-nutrition-phase">Loading...</div>
                            <div style="font-size: 0.78rem; color: var(--text-muted);">Nutrition tips for your cycle phase</div>
                        </div>
                    </div>
                    <div class="cycle-tip-list" id="cycle-tip-list">
                        <!-- Rendered by JS -->
                    </div>
                </div>

                <!-- Smart Suggestions removed -->
                <!-- Hydration moved inside daily tracker card above -->

                <!-- Score History, Meal Prep Score, Nutrition Badges, Social Comparison removed -->

            </div>
        </div>

        <!-- Week views will be injected/shown here -->

    <!-- Weekly Trends Page (full-screen overlay) -->
    <div class="weekly-trends-page" id="weekly-trends-page">
        <div class="weekly-trends-page-header">
            <span class="weekly-trends-page-title">Weekly Trends</span>
        </div>
        <div class="weekly-trends-page-content">
            <!-- Weekly Summary -->
            <div class="weekly-metrics-card" style="padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border: 1px solid #dee2e6; margin-bottom: 20px;">
                <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                    Weekly Summary
                </h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Total Calories</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><span id="weekly-total-calories">0</span></div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Daily Average</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><span id="weekly-avg-calories">0</span></div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Days Logged</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><span id="weekly-days-logged">0</span>/7</div>
                    </div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 12px;">Last 7 Days</div>
                    <div id="weekly-daily-breakdown">
                        <p style="text-align: center; color: var(--text-muted); padding: 20px 0;">Loading weekly data...</p>
                    </div>
                </div>
            </div>

            <!-- Weekly Meals (Photo Journal) -->
            <div class="meal-journal-card" id="meal-journal-section">
                <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: var(--text-main);">Weekly Meals</h3>
                <p style="margin: 0; font-size: 0.78rem; color: var(--text-muted);">Your recent meals at a glance</p>
                <div class="journal-timeline" id="journal-timeline">
                    <p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Loading your meal photos...</p>
                </div>
            </div>

            <!-- Weekly Trends (Multi-Week History) -->
            <div class="multi-week-card" id="multi-week-section">
                <div class="multi-week-header">
                    <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-main);">Weekly Trends</h3>
                    <div class="multi-week-nav" id="multi-week-nav">
                        <button class="active" onclick="loadMultiWeekData(4)">4 Weeks</button>
                        <button onclick="loadMultiWeekData(8)">8 Weeks</button>
                    </div>
                </div>
                <div id="multi-week-sparklines">
                    <p style="text-align: center; color: var(--text-muted); padding: 20px 0; font-size: 0.85rem;">Loading trend data...</p>
                </div>
                <div class="week-compare-grid" id="week-compare-grid">
                    <!-- Comparison stats rendered by JS -->
                </div>
            </div>

            <!-- Meal Pattern Analysis -->
            <div class="meal-pattern-card" id="meal-pattern-section">
                <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: var(--text-main);">Meal Patterns</h3>
                <p style="margin: 0 0 14px 0; font-size: 0.78rem; color: var(--text-muted);">Insights from your last 7 days</p>
                <div id="meal-pattern-insights">
                    <p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Log more meals to see patterns</p>
                </div>
            </div>

            <!-- Adaptive Calorie Adjustment -->
            <div class="adaptive-adjustment-card" id="adaptive-adjustment-section" style="display: none;">
                <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.3rem;">&#x1F4CA;</span> Adaptive Adjustment
                </h3>
                <p style="margin: 0; font-size: 0.78rem; color: var(--text-muted);">Based on your last 2 weeks of tracking &amp; weigh-ins</p>

                <!-- Progress toward eligibility (shown when not yet eligible) -->
                <div id="adaptive-progress-section" style="display: none;">
                    <div style="margin-top: 14px; font-size: 0.85rem; color: var(--text-main);">
                        <span id="adaptive-progress-label">Tracking progress</span>
                    </div>
                    <div class="adaptive-progress-bar">
                        <div class="adaptive-progress-fill" id="adaptive-progress-fill" style="width: 0%;"></div>
                    </div>
                    <p id="adaptive-progress-message" style="margin: 0; font-size: 0.82rem; color: var(--text-muted); line-height: 1.4;"></p>
                </div>

                <!-- Stats + suggestion (shown when eligible) -->
                <div id="adaptive-eligible-section" style="display: none;">
                    <div class="adaptive-stats-grid">
                        <div class="adaptive-stat">
                            <div class="adaptive-stat-value" id="adaptive-stat-tracked">0</div>
                            <div class="adaptive-stat-label">Days Tracked</div>
                        </div>
                        <div class="adaptive-stat">
                            <div class="adaptive-stat-value" id="adaptive-stat-adherence">0%</div>
                            <div class="adaptive-stat-label">On Target</div>
                        </div>
                        <div class="adaptive-stat">
                            <div class="adaptive-stat-value" id="adaptive-stat-weight-change">0</div>
                            <div class="adaptive-stat-label">Weight Change</div>
                        </div>
                    </div>

                    <div id="adaptive-suggestion-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Adaptive Calorie Adjustment Confirmation Modal -->
    <div class="adaptive-modal-overlay" id="adaptive-modal-overlay">
        <div class="adaptive-modal">
            <div class="adaptive-modal-icon" id="adaptive-modal-icon">&#x2696;&#xFE0F;</div>
            <div class="adaptive-modal-title" id="adaptive-modal-title">Adjust Your Calories?</div>
            <div class="adaptive-modal-body" id="adaptive-modal-body">
                Based on your tracking data and weight trends, we suggest updating your daily calorie goal.
            </div>
            <div class="adaptive-modal-change">
                <span class="adaptive-modal-old" id="adaptive-modal-old">2000 kcal</span>
                <span class="adaptive-modal-arrow">&#x2192;</span>
                <span class="adaptive-modal-new" id="adaptive-modal-new">1850 kcal</span>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0 0 16px 0;">
                Your macros (protein, carbs, fat) will be recalculated proportionally.
            </p>
            <button class="adaptive-modal-confirm" onclick="confirmAdaptiveAdjustment()">Yes, update my goals</button>
            <button class="adaptive-modal-cancel" onclick="closeAdaptiveModal()">No thanks, keep current goals</button>
        </div>
    </div>

<!-- START HERE -->
    <!-- Protocol Section Removed -->

<script>
    (function() {
        try {
            // 1. Get User Data
            const rawProfile = sessionStorage.getItem('userProfile');
            const data = rawProfile ? JSON.parse(rawProfile) : {};
            // 0. Unified App Content Configuration
            const APP_CONTENT = {
                CORTISOL: {
                    title: "Your Cortisol Recovery Protocol",
                    subtitle: "<strong>The \"Survival Mode\" Profile.</strong> Your body is stuck in fight-or-flight, holding onto belly fat. This plan powers down your adrenaline response to signal safety and shedding.",
                    goldenRules: `
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">1. Carbs at Night</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Save starchy carbs (Sweet Potato/Rice) for <strong>dinner</strong>. This blunts the evening cortisol spike and boosts serotonin for deep sleep.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">2. No Fasting</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Eat within <strong>30 minutes</strong> of waking. Fasting spikes cortisol and keeps your body in emergency storage mode.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">3. Magnesium</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Prioritize magnesium-rich foods (Spinach, Pumpkin Seeds, Dark Choc) to physically relax the nervous system.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">4. 4-Hour Rhythm</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p><strong>Never go >4 hours without food.</strong> Frequent protein feedings assure your ancient brain that you are safe from starvation.</p></div></div>
                    `,
                    spotlight: `
                        <img src="protocols/cortisol/images/sweet_potato_spotlight.png" style="width:150px; height:150px; object-fit:cover; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
                        <div><h3 style="color:var(--secondary);">Medicinal Power: The Sweet Potato</h3><p><strong>Why simple carbs?</strong> When eaten at night, the strategic insulin release helps lower cortisol and drives Tryptophan into the brain to create <strong>Serotonin</strong>. It is your biochemistry hack for sleep and calm.</p></div>
                    `,
                    whyWorks: `
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Calming Your Adrenals</h4><p>This plan specifically excludes stimulants and high-glycemic spikes that trigger cortisol release. By stabilizing your blood sugar with complex carbs and protein, we tell your body it is "safe," allowing your adrenal glands to rest and recover.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Strategic Carb Timing</h4><p>We include specific slow-releasing carbohydrates in the evening (like sweet potatoes). This naturally lowers cortisol levels and boosts serotonin production, helping you wind down and improving sleep qualitythe foundation of hormone repair.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Magnesium-Rich Ingredients</h4><p>High-stress burns through magnesium. This menu is packed with magnesium-rich foods like leafy greens, seeds, and cacao to actively replenish your stores, relaxing your nervous system and reducing anxiety.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Anti-Inflammatory fats</h4><p>Healthy fats from avocados, nuts, and seeds provide the raw materials for hormone production while damping down the systemic inflammation caused by chronic stress.</p></div>
                    `,
                    welcomeText: "Your biochemical reset is active. Cortisol levels are stabilizing."
                },
                ESTROGEN: {
                    title: "Your Estrogen Detox Protocol",
                    subtitle: "<strong>The \"Dominance\" Profile.</strong> Heavy cycles, bloating, and mood swings. This plan amplifies fiber and liver support to safely flush excess hormones.",
                    goldenRules: `
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">1. Cruciferous Daily</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Eat Broccoli, Kale, or Brussels Sprouts <strong>daily</strong>. They contain compounds (DIM) that active the liver's detox pathways.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">2. Raw Carrot Salad</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Eat your raw carrot salad <strong>every day</strong>. Its unique fiber acts like a sponge for endotoxins and excess estrogen.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">3. Hydration</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p>Drink <strong>3 Liters</strong> of water. Your kidneys are a major detox organ; keep them flushed to reduce bloating.</p></div></div>
                        <div class="card" style="margin:0;"><div class="card-header" style="background:var(--secondary); color:white;"><div class="meal-title" style="color:white;">4. Zero Alcohol</div></div><div class="card-body" style="max-height:none; opacity:1; padding:20px;"><p><strong>Strict No Alcohol.</strong> Ethanol pauses fat burning and liver detox for up to 48 hours. Give your liver a break.</p></div></div>
                    `,
                    spotlight: `
                        <img src="protocols/estrogen/images/raw_carrot_salad_spotlight.png" style="width:150px; height:150px; object-fit:cover; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
                         <div><h3 style="color:var(--secondary);">Medicinal Power: Raw Carrot Salad</h3><p><strong>Not just a side dish.</strong> Raw carrots contain a unique fiber that binds to estrogen in the intestine, preventing reabsorption. Paired with coconut oil and vinegar, it is a powerful daily detox tool.</p></div>
                    `,
                    whyWorks: `
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Supporting Liver Detoxification</h4><p>Your liver is responsible for clearing excess estrogen. This plan is rich in cruciferous vegetables (broccoli, kale, cauliflower) containing Indole-3-Carbinol, a compound that directly supports the liver's ability to safely metabolize and excrete used hormones.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Fiber "Estrogen Trap"</h4><p>Once the liver processes estrogen, it needs to be eliminated. The high soluble fiber content in this plan (from oats, beans, flax) acts like a sponge in your gut, binding to this "old" estrogen and ensuring it leaves your body instead of being reabsorbed.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Phytoestrogen Modulation</h4><p>We use specific plant foods like flaxseeds and legumes that contain phytoestrogens. These smart compounds help balance your levelsproviding a weak estrogenic effect if you're low, but competing with potent estrogens if you're high, creating a smoother ride.</p></div>
                        <div style="margin-bottom: 20px;"><h4 style="color: var(--primary);">Gut Microbiome Support</h4><p>A healthy gut minimizes the enzyme beta-glucuronidase, which can recycle bad estrogen. This diverse, plant-based menu feeds the beneficial bacteria needed to keep this enzyme in check.</p></div>
                    `,
                    welcomeText: "Your biochemical reset is active. Estrogen detoxification is active."
                }
            };

            const selectedSymptoms = (data.symptoms || '').split(',').map(s => s.trim()).filter(Boolean);

            // 0.5. Apply Unified Content
            const resultType = sessionStorage.getItem('userResult') || 'CORTISOL';
            const profileKey = (resultType.toUpperCase().includes('ESTROGEN')) ? 'ESTROGEN' : 'CORTISOL';
            const content = APP_CONTENT[profileKey];

            if(content) {
                // Intro / Dashboard
                const heroTitle = document.getElementById('hero-title');
                if(heroTitle) heroTitle.innerHTML = content.title;

                const heroSubtitle = document.getElementById('hero-subtitle');
                if(heroSubtitle) heroSubtitle.innerHTML = content.subtitle;
                
                // Welcome Text (Day 1)
                const welcomeMsg = document.getElementById('welcome-message');
                if(welcomeMsg) welcomeMsg.textContent = content.welcomeText;

                // Golden Rules
                const rulesContainer = document.getElementById('golden-rules-container');
                if(rulesContainer) rulesContainer.innerHTML = content.goldenRules;

                // Spotlight
                const spotlightBody = document.getElementById('spotlight-body');
                if(spotlightBody) spotlightBody.innerHTML = content.spotlight;

                // Why Works
                const whyWorksBody = document.getElementById('why-works-body');
                if(whyWorksBody) whyWorksBody.innerHTML = content.whyWorks;
            }
            
            // 2. Symptom Data (Mirrored from Landing Page)
            const symptomData = {
                bloating: {
                    title: 'SYMPTOM: BLOATING & DIGESTION',
                    wrong: "Dwindling estrogen slows gastric emptying. Your digestion is literally moving slower, causing fermentation and that 'hard' belly feeling.",
                    fix: "We use the 'Flora-Flush' sequence. By rotating specific enzyme-active plants, we clear the digestive backlog and flatten the 'Endo-Belly' in days."
                },
                joint_pain: {
                    title: 'SYMPTOM: JOINTS & INFLAMMATION',
                    wrong: "Estrogen is nature's anti-inflammatory. As it drops, your joints lose hydration and fascia becomes sticky, causing that 'stiff and achy' feeling.",
                    fix: "We implement 'Structural Hydration.' We use specific mineral-dense liquids and collagen-protecting plants to re-lubricate your joints from the inside out."
                },
                mood: {
                    title: 'SYMPTOM: MOOD & IRRITABILITY',
                    wrong: "Estrogen protects your serotonin receptors. When it fluctuates, your emotional 'buffer' disappears, leading to sudden rage or weepiness.",
                    fix: "The 'Neuro-Buffering' Protocol. We use amino-acid rich plant pairings to stabilize your dopamine and serotonin pathways, giving you your patience back."
                },
                hair_skin: {
                    title: 'SYMPTOM: HAIR & SKIN CHANGES',
                    wrong: "As estrogen drops, your relative testosterone levels become dominant, attacking hair follicles and causing 'crepey' or dry skin.",
                    fix: "The 'Follicle-Fortress' Strategy. We block DHT naturally using specific plant sterols and re-hydrate the dermal layers with essential fatty acids."
                },
                hot_flashes: {
                    title: 'SYMPTOM: HOT FLASHES & SWEATS',
                    wrong: "Your hypothalamus is misreading low estrogen as 'overheating,' triggering a false panic-cooldown response that results in sweats.",
                    fix: "The 'Thermostat Reset.' We use cooling phytoestrogens and evening primrose timing to 'lie' to your brain's thermostat and keep your core temperature stable."
                },
                libido: {
                    title: 'SYMPTOM: LOW LIBIDO',
                    wrong: "Dopamine drives desire, but it needs estrogen to fire effectively. Without it, the 'spark' feels physically and mentally distant.",
                    fix: "The 'Spark-Ignition' Protocol. We clear neural pathways and use natural vasodilation plants to increase physical sensitivity and mental desire."
                },
                anxiety: {
                    title: 'SYMPTOM: ANXIETY & DREAD',
                    wrong: "Progesterone is your brain's natural 'chill-pill.' When it crashes, your GABA receptors are left unprotected, causing spikes of dread.",
                    fix: "The 'GABA-Guard' Sequence. We use magnesium-rich plant chelation and specific breathing windows to manually override the panic response."
                },
                weight_gain: {
                    title: 'SYMPTOM: UNEXPECTED WEIGHT GAIN',
                    wrong: "Your body is in 'Storage Mode.' It's hoarding fat to protect your bones and produce emergency estrogen, making standard dieting useless.",
                    fix: "The 'Metabolic Flip.' We switch your body from 'Storage' to 'Fuel' mode by hitting specific insulin triggers and using anti-inflammatory fats."
                }
            };

            // 3. Render Logic
            const container = document.getElementById('symptom-content-container');
            const wrapper = document.getElementById('dynamic-symptom-section');
            
            const activeSymptoms = selectedSymptoms
                .filter(s => symptomData[s])
                .map(s => symptomData[s]);

            if (activeSymptoms.length > 0) {
                wrapper.style.display = 'block';
                container.innerHTML = activeSymptoms.map(s => `
                    <div style="margin-bottom: 20px; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <h4 style="color: #48864B; margin: 0 0 10px 0; font-size: 0.9rem;">${s.title}</h4>
                        <p style="font-size: 0.9rem; color: #475569; margin-bottom: 10px;"><strong>The Issue:</strong> ${s.wrong}</p>
                        <p style="font-size: 0.9rem; color: #1e293b; margin: 0;"><strong>The Fix:</strong> ${s.fix}</p>
                    </div>
                `).join('');

                // 4. Meal Card Badging Logic
                applyMealBadges(selectedSymptoms);
            }

            // Expose function globally for re-triggering
            window.applyMealBadges = function(symptomList) {
                let _parsedProfile = {};
                try { _parsedProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
                const symptoms = symptomList || _parsedProfile.symptoms || [];

                // Map symptoms to keywords/meal types
                const mappings = {
                    'mood': { type: 'BREAKFAST', badge: '🧠 Brain-Fat Focus', color: '#fef3c7', text: '#8a7e30' }, /* Greeny Gold Text */
                    'bloating': { type: 'DINNER', badge: '🦠 Flora-Flush', color: '#dcfce7', text: '#166534' },
                    'joint_pain': { type: 'SMOOTHIE', badge: '🦴 Structural Hydration', color: '#dbeafe', text: '#1e40af' },
                    'anxiety': { type: 'SNACK', badge: '🛡️ GABA-Guard', color: '#f3e8ff', text: '#6b21a8' },
                    'weight_gain': { type: 'LUNCH', badge: '🔥 Metabolic Spark', color: '#ffe4e6', text: '#9f1239' }
                };

                symptoms.forEach(s => {
                    const map = mappings[s];
                    if (map) {
                        document.querySelectorAll('.meta').forEach(meta => {
                            if (meta.textContent.toUpperCase().includes(map.type)) {
                                const titleInfoDiv = meta.parentElement;
                                const title = titleInfoDiv.querySelector('.meal-title');
                                
                                if (title && !title.querySelector('.dynamic-badge')) {
                                    const badge = document.createElement('span');
                                    badge.className = 'dynamic-badge';
                                    badge.textContent = map.badge;
                                    badge.style.cssText = `
                                        background: ${map.color}; 
                                        color: ${map.text}; 
                                        padding: 4px 8px; 
                                        border-radius: 4px; 
                                        font-size: 0.65rem; 
                                        font-weight: 700; 
                                        text-transform: uppercase; 
                                        margin-left: 10px;
                                        display: inline-block;
                                        vertical-align: middle;
                                        line-height: 1.2;
                                    `;
                                    title.appendChild(badge);
                                }
                            }
                        });
                    }
                });
            };

            // Run on load
            window.applyMealBadges();

        } catch(e) { console.error("Symptom Injection and Badging Error", e); }
    })();

    // --- NEW: Coach & Photo Logic ---
    window.addEventListener('DOMContentLoaded', async () => {
        injectReflectionsIntoDays();

        // NOTE: Do NOT call applyGenderTheme() here - it must run AFTER loadProfileData()
        // restores gender from the database, otherwise it defaults to female

        // --- Login Loading Bar Progress Helper ---
        function updateLoginProgress(percent, message) {
            const bar = document.getElementById('login-loading-bar');
            const text = document.getElementById('login-loading-text');
            if (bar) bar.style.width = percent + '%';
            if (text) text.textContent = message;
        }

        updateLoginProgress(10, 'Authenticating...');

        // Wait for Auth before loading user-specific data
        const waitForAuth = () => new Promise(resolve => {
            if(window.currentUser) return resolve(window.currentUser);
            const check = setInterval(() => {
                if(window.currentUser) {
                    clearInterval(check);
                    resolve(window.currentUser);
                }
            }, 100);
            // Timeout after 5s just in case
            setTimeout(() => { clearInterval(check); resolve(null); }, 5000);
        });

        await waitForAuth();

        if(window.currentUser) {
            try {
            updateLoginProgress(25, 'Loading your profile...');

            // Fire-and-forget: non-blocking background loads
            loadChat();
            loadJournalHistory();

            // Phase 1: Run independent async operations in parallel for faster startup
            // - syncQuizDataToDb: sync local quiz data to DB (independent)
            // - seedTestAccount: inject test data if test user (independent)
            // - initCalendarView: load cycle data (loadProfileData depends on this)
            // - loadCharacterColorsFromDb: load gender & colors (loadPointsWidget depends on this)
            await Promise.all([
                syncQuizDataToDb().catch(e => console.warn('Quiz sync error:', e)),
                seedTestAccount().catch(e => console.warn('Seed error:', e)),
                (typeof initCalendarView === 'function'
                    ? initCalendarView().then(() => console.log('✅ Cycle data loaded'))
                    : Promise.resolve()),
                (typeof window.loadCharacterColorsFromDb === 'function'
                    ? window.loadCharacterColorsFromDb()
                    : Promise.resolve())
            ]);

            updateLoginProgress(50, 'Setting up your experience...');

            // Phase 2: Profile data (depends on cycle data from Phase 1)
            await loadProfileData();
            initProgramDate();

            // Apply saved theme AFTER gender is loaded from database
            const savedTheme = localStorage.getItem('userThemePreference') || 'default';
            if (typeof applyAppTheme === 'function') {
                applyAppTheme(savedTheme);
            }

            // Check if essential quiz data is missing and trigger onboarding wizard
            await checkAndTriggerOnboarding();

            updateLoginProgress(65, 'Preparing your FitGotchi...');

            // Phase 3: Load points and update FitGotchi (depends on character colors from Phase 1)
            if (typeof loadPointsWidget === 'function') {
                await loadPointsWidget();
            }

            updateLoginProgress(80, 'Almost there...');

            // Phase 4: Non-critical UI updates (fire-and-forget, don't block)
            if(typeof checkAndShowWeighInModal === 'function') checkAndShowWeighInModal();
            if(typeof checkAndShowWeighInCard === 'function') checkAndShowWeighInCard();
            if(typeof checkAndShowDailyQuizCard === 'function') checkAndShowDailyQuizCard();
            if(typeof checkAndShowMealTipCard === 'function') checkAndShowMealTipCard();
            if(typeof checkAndShowProgressPhotoCard === 'function') checkAndShowProgressPhotoCard();
            if(typeof checkAndShowWorkoutTrendCard === 'function') checkAndShowWorkoutTrendCard();
            if(typeof initFitbitDashboard === 'function') initFitbitDashboard();
            if(typeof window.loadCommunityFeed === 'function') window.loadCommunityFeed();

            // Native app: init Health Connect/HealthKit + push notifications
            if (window.NativeHealth && window.NativeHealth.isNativeApp()) {
                console.log('📱 Native app detected — initializing Health Connect/HealthKit');
                window.NativeHealth.init().then(ready => {
                    if (ready) {
                        console.log('✅ Native health ready — fetching summary');
                        window.NativeHealth.getSummary().then(summary => {
                            if (summary) console.log('📊 Native health summary:', summary);
                        });
                    }
                });
            }
            if (window.NativePush && window.NativePush.isNativeApp()) {
                console.log('📱 Native app detected — initializing native push notifications');
                window.NativePush.init();
            }

            // Switch to dashboard as default entry point
            if(typeof switchAppTab === 'function') {
                const homeNav = document.querySelector('.nav-item');
                switchAppTab('dashboard', homeNav);
            }
            } catch(initError) {
                console.error('Initialization error (dismissing overlay anyway):', initError);
            }

            // --- Dismiss Login Loading Overlay ---
            // Wait for the character model to finish loading, then fade out
            (function dismissLoginOverlay() {
                const overlay = document.getElementById('login-loading-overlay');
                if (!overlay) return;

                let dismissed = false;
                function fadeOut() {
                    if (dismissed) return;
                    dismissed = true;
                    updateLoginProgress(100, 'Ready!');
                    // Mark that the user has completed their first dashboard load,
                    // so the loading overlay won't show on subsequent page reloads.
                    try { localStorage.setItem('dashboardInitialized', 'true'); } catch(e) {}
                    setTimeout(() => {
                        overlay.classList.add('fade-out');
                        // Remove from DOM after transition
                        overlay.addEventListener('transitionend', () => overlay.remove(), { once: true });
                    }, 300);
                }

                const modelViewer = document.getElementById('tamagotchi-model');
                if (modelViewer && !modelViewer.getAttribute('src')) {
                    // Model src not set yet — wait for it to load
                    const onSrcSet = new MutationObserver(() => {
                        if (modelViewer.getAttribute('src')) {
                            onSrcSet.disconnect();
                            modelViewer.addEventListener('load', fadeOut, { once: true });
                            // Safety timeout if model load takes too long
                            setTimeout(fadeOut, 8000);
                        }
                    });
                    onSrcSet.observe(modelViewer, { attributes: true, attributeFilter: ['src'] });
                    // Absolute safety timeout
                    setTimeout(fadeOut, 12000);
                } else if (modelViewer && modelViewer.getAttribute('src')) {
                    // src already set — wait for load or dismiss if already loaded
                    if (modelViewer.loaded) {
                        fadeOut();
                    } else {
                        modelViewer.addEventListener('load', fadeOut, { once: true });
                        setTimeout(fadeOut, 8000);
                    }
                } else {
                    // No model viewer found — just dismiss after a short delay
                    setTimeout(fadeOut, 2000);
                }
            })();

            // --- TEST DATA SEEDING ---
            async function seedTestAccount() {
                if (window.currentUser?.email === 'shannonbirch@cocospersonaltraining.com') {
                    console.log("🧪 Seeding Test Account Data...");
                    
                    const coreUpdates = {
                        name: 'Shannon Test'
                    };

                    const factUpdates = {
                        profile: 'CORTISOL', // Hormone Type
                        equipment_access: 'none', // Just a mat (Triggers: Yoga, Bodyweight only)
                        energy_status: 'moderate',
                        goal: 'Fat Loss',
                        // Quiz Answers mapping to symptoms
                        keeps_awake: 'worry',     // -> Anxiety
                        midday_crash: 'yes',      // -> Fatigue
                        brain_fog: 'yes',         // -> Fatigue
                        symptoms: ['anxiety', 'fatigue'] // Explicitly set for immediate testing
                    };
                    
                    try {
                        // 1. Core Profile (users table)
                        try {
                            await dbHelpers.users.update(window.currentUser.id, coreUpdates);
                        } catch (coreError) {
                            console.warn("⚠️ Could not update core 'users' table (likely RLS). Proceeding to 'user_facts'.", coreError);
                        }
                        
                        // 2. Extended Facts (user_facts table)
                        let existingFacts = {}; 
                        try { existingFacts = await dbHelpers.userFacts.get(window.currentUser.id); } catch(e){}
                        const currentDetails = existingFacts?.personal_details || {};
                        
                        // Force explicit symptoms to prove it works
                        const finalFacts = { ...currentDetails, ...factUpdates };
                        // Ensure symptoms are set if not already present or if forceful overwrite needed
                        // For test account, we force them.
                        finalFacts.symptoms = ['anxiety', 'bloating', 'fatigue'];

                        await dbHelpers.userFacts.upsert(window.currentUser.id, {
                            personal_details: finalFacts
                        });

                        window.userProfile = { ...window.userProfile, ...coreUpdates, ...factUpdates, symptoms: finalFacts.symptoms };
                        console.log("✅ Test Data Injected Successfully: ", window.userProfile);
                        
                        // Force UI refresh if profile view is active
                        if(typeof loadProfileData === 'function') setTimeout(loadProfileData, 500);
                    } catch (e) {
                        console.error("❌ Failed to seed test data (Fatal)", e);
                    }
                }

                // Test account that skips quiz but shows onboarding slides
                if (window.currentUser?.email === 'shannonrhysbirch@gmail.com') {
                    console.log("🧪 Setting up Onboarding Test Account (skips quiz, shows onboarding)...");

                    // Clear onboarding complete flag to ensure wizard shows
                    localStorage.removeItem('onboardingComplete');

                    // Clear any cached quiz data from sessionStorage
                    sessionStorage.removeItem('userProfile');

                    // Clear quiz results from database to ensure onboarding triggers
                    try {
                        await window.supabaseClient
                            .from('quiz_results')
                            .delete()
                            .eq('user_id', window.currentUser.id);
                        console.log("✅ Cleared quiz results for onboarding test account");
                    } catch(e) {
                        console.warn("⚠️ Could not clear quiz results:", e);
                    }

                    console.log("✅ Onboarding Test Account Ready - wizard will show");
                }
            }

            // Auto-show Daily Wellness check-in (once per day)
            // NOTE: Moved to after onboarding completes - handled by finishOnboarding()
            // This ensures check-in only shows AFTER user selects gender in onboarding
        } else {
            // Auth failed — dismiss overlay (auth guard will redirect to login)
            const overlay = document.getElementById('login-loading-overlay');
            if (overlay) overlay.remove();
        }
    });

    function injectReflectionsIntoDays() {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        // Find all day views
        document.querySelectorAll('.day-view').forEach(view => {
            const id = view.id; // e.g., week1-Monday
            if (!id) return;
            
            // Check if it ends with a day name
            const isDay = days.some(day => id.endsWith(day));
            if (!isDay) return;

            // Check if already injected
            if (view.querySelector('.reflection-card')) return;

            const div = document.createElement('div');
            div.className = 'card reflection-card';
            div.innerHTML = `
                <div class="card-header" style="background: white; cursor: default;">
                    <div class="meal-title" style="color: var(--primary);">End of Day Reflection</div>
                </div>
                <div class="card-body" style="padding: 25px; max-height: none; opacity: 1;">
                    <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 20px;">How did you feel today? Any wins or challenges?</p>
                    <textarea id="ref-${id}" placeholder="Journal your thoughts here..." style="width: 100%; height: 120px; padding: 15px; border: 1px solid #cbd5e0; border-radius: 8px; font-family: 'Inter'; font-size: 0.95rem; resize: vertical; margin-bottom: 15px;"></textarea>
                    <button onclick="saveDayReflection('${id}')" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">Save Entry</button>
                    <span id="status-${id}" style="margin-left: 15px; font-size: 0.85rem; color: #166534;"></span>
                </div>
            `;
            view.appendChild(div);

            // Load saved reflection
            const saved = localStorage.getItem('reflection_' + id);
            if (saved) {
                div.querySelector('textarea').value = saved;
            }
        });
    }

    window.saveDayReflection = function(id) {
        const el = document.getElementById('ref-' + id);
        if (!el) return;
        const val = el.value;
        if (!val.trim()) return;

        // Save locally
        localStorage.setItem('reflection_' + id, val);

        const status = document.getElementById('status-' + id);
        if (status) {
            status.textContent = "Saved to your journal.";
            setTimeout(() => { status.textContent = ""; }, 3000);
        }

        // Re-render journal history
        loadJournalHistory();

        // Trigger Celebration
        // Parse "week1-Monday" to get "Day X" or just confirm "Day Complete"
        // For simplicity, we can map days to numbers or just say "You did it!"
        showDayCompletion(id);
    };

    window.showDayCompletion = function(dayId) {
        const modal = document.getElementById('day-completion-modal');
        const text = document.getElementById('completion-text');
        
        // Simple heuristic for day number
        // Assuming we are on Day 1 for demo if not strictly tracked elsewhere in this simpler version
        // Or extract from dayId if it was "day1" etc. 
        // dayId format: "week1-Monday"
        
        let displayDay = "Today";
        if(dayId.includes('Monday')) displayDay = "Day 1";
        if(dayId.includes('Tuesday')) displayDay = "Day 2";
        if(dayId.includes('Wednesday')) displayDay = "Day 3";
        if(dayId.includes('Thursday')) displayDay = "Day 4";
        if(dayId.includes('Friday')) displayDay = "Day 5";
        if(dayId.includes('Saturday')) displayDay = "Day 6";
        if(dayId.includes('Sunday')) displayDay = "Day 7";

        text.textContent = `You have successfully completed ${displayDay}.`;
        modal.style.display = 'flex';
        triggerConfetti();
    }

    window.closeCompletionModal = function() {
        const modal = document.getElementById('day-completion-modal');
        if (modal) modal.style.display = 'none';
    }

    window.triggerConfetti = function() {
        // Simple JS confetti
        const colors = ['#d4af37', '#046A38', '#ffffff', '#f0fdf4'];
        for(let i=0; i<50; i++) {
            const el = document.createElement('div');
            el.className = 'confetti-piece';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            el.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 5000);
        }
    }
    
    // Inject confetti styles if not present
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    `;
    document.head.appendChild(style);

    // --- MOVEMENT STUDIO DB & LOGIC ---
    // --- WORKOUT TRACKER & DATABASE LOGIC ---
    
    // 1. Configuration
    const DEFAULT_WORKOUT = [
        { id: 'sq_01', name: 'Goblet Squat', thumb: 'https://images.unsplash.com/photo-1574680096145-d05b474e2155?w=150', video: 'MeIiIdhvOUg', sets: 3 },
        { id: 'dl_01', name: 'Romanian Deadlift', thumb: 'https://images.unsplash.com/photo-1605296867304-46d5465a13f1?w=150', video: 'vI2jU4zFfK8', sets: 3 },
        { id: 'push_01', name: 'Kneeling Push Up', thumb: 'https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?w=150', video: 'WPHG8tJ9bO0', sets: 3 }
    ];

    let myWorkout = DEFAULT_WORKOUT;
    try { myWorkout = JSON.parse(localStorage.getItem('myCurrentWorkout')) || DEFAULT_WORKOUT; } catch(e) {}
    let rapidApiKey = localStorage.getItem('rapidApiKey') || ''; // User needs to set this

    // 2. Initialize
    async function loadMovementStudio() {
        renderWorkoutList();
    }

    // 3. Render Workout List (Trainerize Style)
    function renderWorkoutList() {
        const container = document.getElementById('workout-list');
        if(!container) return;
        
        if(myWorkout.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">No exercises added. Go to Library to add some!</div>`;
            return;
        }

        container.innerHTML = myWorkout.map((ex, index) => `
            <div class="card" style="margin-bottom:20px; border:1px solid #e2e8f0; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <!-- Header -->
                <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <img src="${ex.thumb || 'https://via.placeholder.com/50'}" style="width:50px; height:50px; border-radius:8px; object-fit:cover; background:white;">
                        <div>
                            <h4 style="margin:0; color:var(--primary); font-size:1rem;">${ex.name}</h4>
                            ${ex.video ? `<button onclick="openExerciseModal('${ex.video}')" style="background:none; border:none; color:#3b82f6; font-size:0.75rem; cursor:pointer; padding:0; display:flex; align-items:center; gap:4px; margin-top:4px;">? Watch Demo</button>` : ''}
                        </div>
                    </div>
                     <button onclick="removeExercise(${index})" style="color:#ef4444; background:none; border:none; font-size:0.8rem; cursor:pointer;">Remove</button>
                </div>
                <!-- Sets -->
                <div style="padding:15px;">
                    <div style="display:grid; grid-template-columns: 40px 1fr 1fr 40px; gap:10px; margin-bottom:10px; font-size:0.7rem; color:#64748b; font-weight:700; text-transform:uppercase; text-align:center;">
                        <div>Set</div>
                        <div>kg / lbs</div>
                        <div>Reps</div>
                        <div></div>
                    </div>
                    ${Array(ex.sets || 3).fill(0).map((_, i) => `
                        <div style="display:grid; grid-template-columns: 40px 1fr 1fr 40px; gap:10px; margin-bottom:8px; align-items:center;">
                            <div style="text-align:center; color:#94a3b8; font-weight:600; font-size:0.9rem;">${i + 1}</div>
                            <input type="number" placeholder="0" style="width:100%; padding:8px; border:1px solid #cbd5e0; border-radius:6px; text-align:center; background:#f8fafc;">
                            <input type="number" placeholder="0" style="width:100%; padding:8px; border:1px solid #cbd5e0; border-radius:6px; text-align:center; background:#f8fafc;">
                            <div class="check-circle" onclick="this.classList.toggle('completed')" style="width:32px; height:32px; border:2px solid #e2e8f0; border-radius:50%; margin:0 auto; cursor:pointer; display:flex; align-items:center; justify-content:center; color:white; transition:all 0.2s;">✓</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    // 4. ExerciseDB Integration (RapidAPI)
    window.searchRapidAPI = async function() {
        const searchEl = document.getElementById('db-search-input');
        if (!searchEl) return;
        const query = searchEl.value.trim();
        const grid = document.getElementById('library-results');
        
        if(!rapidApiKey) {
            alert("Please set your RapidAPI Key first (click 'Update API Key'). Using Demo Data for now.");
            // Demo Fallback
            renderLibraryResults([
                { id: 'demo1', name: 'Barbell Squat', bodyPart: 'legs', gifUrl: 'https://v2.exercisedb.io/image/demo-squat.gif', target: 'glutes' },
                { id: 'demo2', name: 'Dumbbell Lunge', bodyPart: 'legs', gifUrl: 'https://v2.exercisedb.io/image/demo-lunge.gif', target: 'quads' },
                { id: 'demo3', name: 'Plank', bodyPart: 'core', gifUrl: 'https://v2.exercisedb.io/image/demo-plank.gif', target: 'abs' }
            ]); 
            return;
        }

        if(!query) return;

        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;">Searching ExerciseDB...</div>';

        try {
            const url = `https://exercisedb.p.rapidapi.com/exercises/name/${query}`;
            const options = {
                method: 'GET',
                headers: {
                    'X-RapidAPI-Key': rapidApiKey,
                    'X-RapidAPI-Host': 'exercisedb.p.rapidapi.com'
                }
            };

            const response = await fetch(url, options);
            const result = await response.json();
            
            if(Array.isArray(result)) {
                renderLibraryResults(result.slice(0, 20)); // Limit 20
            } else {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;">No results found.</div>';
            }

        } catch (error) {
            console.error(error);
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red; padding:20px;">Error fetching data. Check Console.</div>';
        }
    }

    function renderLibraryResults(list) {
        const grid = document.getElementById('library-results');
        grid.innerHTML = list.map(item => `
            <div class="card" style="margin:0; text-align:center; padding:10px; cursor:pointer; transition:all 0.2s; touch-action: manipulation; user-select: none;" onclick="addToWorkout('${item.name.replace(/'/g, "\\'")}', '${item.gifUrl}')">
                <img src="${item.gifUrl}" style="width:100%; height:120px; object-fit:contain; mix-blend-mode:multiply; margin-bottom:10px; pointer-events: none;">
                <h5 style="margin:0 0 5px 0; font-size:0.85rem; color:var(--primary);">${item.name}</h5>
                <small style="color:#64748b; text-transform:uppercase; font-size:0.7rem;">${item.bodyPart || item.target}</small>
                <div style="margin-top:10px; color:var(--secondary); font-size:0.8rem; font-weight:600;">+ Add</div>
            </div>
        `).join('');
    }

    // Load exercise library from EXERCISE_VIDEOS (Google Drive)
    window.loadExerciseLibrary = function(searchQuery = '') {
        const grid = document.getElementById('library-results');

        // Safety check for library loading
        if (typeof EXERCISE_VIDEOS === 'undefined') {
            grid.innerHTML = `
                <div style="grid-column:1/-1; padding:20px; text-align:center; color:red; background:#fee2e2; border-radius:12px;">
                    <strong>Error: Exercise Library Not Loaded</strong><br>
                    <div style="font-size:0.8rem; margin-top:5px;">Please verify 'exercise_videos.js' file exists and is in the same folder.</div>
                </div>`;
            return;
        }

        const allExercises = Object.keys(EXERCISE_VIDEOS);

        if (allExercises.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">Exercise library is empty.</div>';
            return;
        }

        // Filter by search query if provided
        let filteredExercises = allExercises;
        if (searchQuery) {
            const terms = searchQuery.toLowerCase().split(' ');
            filteredExercises = allExercises.filter(name => {
                const nameLower = name.toLowerCase();
                return terms.every(term => nameLower.includes(term));
            });
        }

        if (filteredExercises.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">No exercises found matching your search.</div>';
            return;
        }

        // Limit to first 100 exercises for performance
        const displayExercises = filteredExercises.slice(0, 100);

        grid.innerHTML = displayExercises.map(name => {
            const videoUrl = EXERCISE_VIDEOS[name];
            const escapedName = name.replace(/'/g, "\\'");
            const escapedUrl = videoUrl.replace(/'/g, "\\'");

            return `
                <div class="card" style="margin:0; text-align:center; padding:12px; cursor:pointer; transition:all 0.2s; position:relative;" onclick="openExerciseVideo('${escapedUrl}', '${escapedName}')">
                    <div style="width:100%; height:120px; background:#f8fafc; border-radius:8px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; position:relative; overflow:hidden;">
                        <svg style="width:48px; height:48px; color:#cbd5e0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div style="position:absolute; bottom:5px; right:5px; background:rgba(0,0,0,0.6); color:white; font-size:0.65rem; padding:2px 6px; border-radius:4px;">VIDEO</div>
                    </div>
                    <h5 style="margin:0 0 5px 0; font-size:0.85rem; color:var(--primary); line-height:1.3;">${name}</h5>
                    <div style="margin-top:8px; color:var(--secondary); font-size:0.75rem; font-weight:600;">▶ Watch</div>
                </div>
            `;
        }).join('');

        if (displayExercises.length < filteredExercises.length) {
            grid.innerHTML += `<div style="grid-column:1/-1; text-align:center; padding:20px; color:#94a3b8; font-size:0.9rem;">Showing first ${displayExercises.length} of ${filteredExercises.length} exercises. Use search to narrow down.</div>`;
        }
    }

    window.addToWorkout = function(name, gif) {
        myWorkout.push({
            id: 'ex_' + Date.now(),
            name: name,
            thumb: gif,
            video: null, // No YT video for API items
            sets: 3
        });
        localStorage.setItem('myCurrentWorkout', JSON.stringify(myWorkout));
        alert(`${name} added to workout!`);
        switchTrackerView('workout');
    }

    window.removeExercise = function(index) {
        if(confirm('Remove this exercise?')) {
            myWorkout.splice(index, 1);
            localStorage.setItem('myCurrentWorkout', JSON.stringify(myWorkout));
            renderWorkoutList();
        }
    }

    window.promptApiKey = function() {
        const key = prompt("Enter your RapidAPI Key for ExerciseDB:", rapidApiKey);
        if(key) {
            rapidApiKey = key;
            localStorage.setItem('rapidApiKey', key);
            alert("API Key Saved.");
        }
    }

    window.switchTrackerView = function(view) {
        document.getElementById('view-workout').style.display = view === 'workout' ? 'block' : 'none';
        document.getElementById('view-library').style.display = view === 'library' ? 'block' : 'none';

        const btnW = document.getElementById('btn-workout');
        const btnL = document.getElementById('btn-library');

        if(view === 'workout') {
            btnW.style.color = 'var(--primary)'; btnW.style.borderBottomColor = 'var(--primary)';
            btnL.style.color = '#94a3b8'; btnL.style.borderBottomColor = 'transparent';
            renderWorkoutList();
        } else {
            btnL.style.color = 'var(--primary)'; btnL.style.borderBottomColor = 'var(--primary)';
            btnW.style.color = '#94a3b8'; btnW.style.borderBottomColor = 'transparent';
            loadExerciseLibrary(); // Load exercise library with videos
        }
    }
    
    // Style check circles
    document.head.insertAdjacentHTML('beforeend', `<style>.check-circle.completed { background: #10b981 !important; border-color: #10b981 !important; }</style>`);

    // --- END TRACKER LOGIC ---

    // Call this on load
    window.addEventListener('DOMContentLoaded', () => {
         loadMovementStudio();
    });

    // Chat
    window.toggleFloatingChat = function() {
        const box = document.getElementById('floating-chat-box');
        if(box.style.display === 'none' || !box.style.display) {
            box.style.display = 'flex';
        } else {
            box.style.display = 'none';
        }
    }

    window.sendChatMessage = function(inputEl) {
        let input;
        if (inputEl) {
            input = inputEl;
        } else {
            input = document.getElementById('chat-input');
        }
        
        const txt = input.value.trim();
        if(!txt) return;

        // Add user msg to ALL containers
        addMessage(txt, 'user');
        
        // Clear inputs
        document.querySelectorAll('input[type="text"]').forEach(el => {
             if(el.id === 'chat-input' || el.classList.contains('chat-input-field')) el.value = '';
        });
        
        // Save
        saveChatToStorage(txt, 'user');

        // Simulate AI Pending
        setTimeout(() => {
        }, 1000);
    }
    
    function addMessage(text, sender) {
        document.querySelectorAll('.chat-history-container').forEach(container => {
            const div = document.createElement('div');
            const isUser = sender === 'user';
            
            div.style.cssText = isUser 
                ? "align-self: flex-end; background: var(--primary); color: white; padding: 12px 16px; border-radius: 12px 12px 0 12px; max-width: 85%;"
                : "align-self: flex-start; background: white; padding: 12px 16px; border-radius: 12px 12px 12px 0; border: 1px solid #e2e8f0; max-width: 85%;";
                
            div.innerHTML = `
                <p style="margin: 0; font-size: 0.95rem;">${text}</p>
                <span style="font-size: 0.75rem; color: ${isUser ? 'rgba(255,255,255,0.7)' : '#94a3b8'}; display: block; margin-top: 5px; text-align: right;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        });
    }

    function saveChatToStorage(text, sender) {
        let chat = [];
        try { chat = JSON.parse(localStorage.getItem('myChatStats') || '[]'); } catch(e) {}
        chat.push({ text, sender, time: new Date().toISOString() });
        localStorage.setItem('myChatStats', JSON.stringify(chat));
    }

    function loadChat() {
        let chat = [];
        try { chat = JSON.parse(localStorage.getItem('myChatStats') || '[]'); } catch(e) {}
        chat.forEach(msg => addMessage(msg.text, msg.sender));
    }

    // Journal History
    function loadJournalHistory() {
        const journalContainer = document.getElementById('journal-history');
        if (!journalContainer) return;
        journalContainer.innerHTML = ''; // Clear previous entries

        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const weeks = ['week1', 'week2', 'week3', 'week4'];

        let hasEntries = false;

        weeks.forEach(week => {
            days.forEach(day => {
                const id = `${week}-${day}`;
                const savedReflection = localStorage.getItem('reflection_' + id);
                if (savedReflection) {
                    hasEntries = true;
                    const entryDiv = document.createElement('div');
                    entryDiv.style.cssText = 'margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;';
                    entryDiv.innerHTML = `
                        <h5 style="margin: 0 0 8px 0; color: var(--primary-light); font-size: 0.95rem;">${week.charAt(0).toUpperCase() + week.slice(1)} - ${day}</h5>
                        <p style="margin: 0; font-size: 0.9rem; color: #4a5568;">${savedReflection}</p>
                    `;
                    journalContainer.appendChild(entryDiv);
                }
            });
        });

        if (!hasEntries) {
            journalContainer.innerHTML = '<p style="font-style: italic; color: var(--text-muted);">No journal entries yet. Start writing your daily reflections!</p>';
        }
    }

    // ==========================================
    // REFLECTIONS DIARY SYSTEM
    // ==========================================

    // Load all reflections (meal plan + standalone) and display chronologically
    function loadAllReflections() {
        const container = document.getElementById('reflections-list');
        if (!container) return;

        const reflections = [];

        // 1. Load meal plan reflections
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const weeks = ['week1', 'week2', 'week3', 'week4'];

        weeks.forEach(week => {
            days.forEach(day => {
                const id = `${week}-${day}`;
                const savedReflection = localStorage.getItem('reflection_' + id);
                if (savedReflection) {
                    reflections.push({
                        type: 'mealplan',
                        id: id,
                        title: `${week.charAt(0).toUpperCase() + week.slice(1)} - ${day}`,
                        text: savedReflection,
                        timestamp: 0 // Meal plan reflections don't have timestamps, will show at bottom
                    });
                }
            });
        });

        // 2. Load standalone reflections
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('standalone_reflection_')) {
                let data;
                try { data = JSON.parse(localStorage.getItem(key)); } catch(e) { continue; }
                if (!data) continue;
                reflections.push({
                    type: 'standalone',
                    id: key,
                    title: formatReflectionDate(data.timestamp),
                    text: data.text,
                    timestamp: data.timestamp
                });
            }
        }

        // 3. Sort by timestamp (newest first, meal plan at bottom)
        reflections.sort((a, b) => b.timestamp - a.timestamp);

        // 4. Render
        if (reflections.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">📔</div>
                    <p style="margin: 0; font-size: 1rem; font-weight: 500;">No reflections yet</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.875rem;">Start by adding your first reflection or complete a meal plan day</p>
                </div>
            `;
        } else {
            container.innerHTML = '';
            reflections.forEach(r => {
                const entryDiv = document.createElement('div');
                entryDiv.style.cssText = 'margin-bottom: 15px; padding: 18px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;';
                entryDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--primary);">${r.title}</div>
                        ${r.type === 'standalone' ? `<button onclick="deleteReflection('${r.id}')" style="background: none; border: none; color: #94a3b8; cursor: pointer; padding: 0; font-size: 1.2rem; line-height: 1;">&times;</button>` : ''}
                    </div>
                    <div style="font-size: 0.95rem; color: #1e293b; line-height: 1.6; white-space: pre-wrap;">${r.text}</div>
                `;
                container.appendChild(entryDiv);
            });
        }
    }

    // Format timestamp to readable date
    function formatReflectionDate(timestamp) {
        if (!timestamp) return 'Meal Plan Entry';
        const date = new Date(timestamp);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        // Check if today
        if (date.toDateString() === today.toDateString()) {
            return 'Today, ' + date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
        }

        // Check if yesterday
        if (date.toDateString() === yesterday.toDateString()) {
            return 'Yesterday, ' + date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
        }

        // Otherwise show full date
        return date.toLocaleDateString('en-AU', {
            weekday: 'short',
            day: 'numeric',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Open modal to add new reflection
    window.openNewReflectionModal = function() {
        const modal = document.createElement('div');
        modal.id = 'reflection-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; max-width: 500px; width: 100%; padding: 25px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 1.3rem; color: var(--text-main);">New Reflection</h3>
                    <button onclick="closeReflectionModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                </div>
                <p style="margin: 0 0 15px 0; font-size: 0.9rem; color: #64748b;">How are you feeling? Any wins or challenges today?</p>
                <textarea id="new-reflection-text" placeholder="Write your thoughts..." style="width: 100%; height: 200px; padding: 15px; border: 1px solid #cbd5e0; border-radius: 8px; font-family: 'Inter'; font-size: 1rem; resize: vertical; margin-bottom: 20px;"></textarea>
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeReflectionModal()" style="flex: 1; background: #f1f5f9; color: #64748b; border: none; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Cancel</button>
                    <button onclick="saveNewReflection()" style="flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">Save</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Focus textarea
        setTimeout(() => {
            document.getElementById('new-reflection-text').focus();
        }, 100);
    }

    // Close modal
    window.closeReflectionModal = function() {
        const modal = document.getElementById('reflection-modal');
        if (modal) modal.remove();
    }

    // Save new standalone reflection
    window.saveNewReflection = function() {
        const text = document.getElementById('new-reflection-text').value.trim();
        if (!text) return;

        const timestamp = Date.now();
        const id = `standalone_reflection_${timestamp}`;

        localStorage.setItem(id, JSON.stringify({
            text: text,
            timestamp: timestamp
        }));

        closeReflectionModal();
        loadAllReflections();
    }

    // Delete a standalone reflection
    window.deleteReflection = function(id) {
        if (confirm('Delete this reflection?')) {
            localStorage.removeItem(id);
            loadAllReflections();
        }
    }



</script>

<!-- SMOOTHIE BOOKLOAD -->
<div class="view-section" id="smoothies">
    <div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
        <div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Adrenal Rescue</div>
        <h1 style="margin-bottom: 15px;">The Balance Smoothie Guide</h1>
        <p style="font-size: 1.1rem; color: #555;">Delicious, grounding recipes to stop the jitters and stabilize blood sugar.</p>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
        <!-- Recipes (Extracted from old bonuses) -->
        <div style="background: #fffdf0; border:1px solid #efe5c0; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_berry_blast.png" alt="Berry Blast" style="width:100%; height:180px; object-fit:cover; background:#e0dbe9;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">1. Cortisol-Control Berry Blast</h4>
                <div style="display:inline-block; background:#e0dbe9; color:#4a3b69; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Antioxidant Shield</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 cup frozen wild blueberries</li>
                    <li>1 handful spinach</li>
                    <li>1/4 avocado</li>
                    <li>1 scoop vanilla pea protein</li>
                    <li>1 tbsp chia seeds</li>
                    <li>1.5 cups almond milk</li>
                </ul>
            </div>
        </div>

        <div style="background: #f4f8f5; border:1px solid #dbece0; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_zen_green.png" alt="Zen Green" style="width:100%; height:180px; object-fit:cover; background:#dbece0;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">2. The "Zen Green" Rescue</h4>
                <div style="display:inline-block; background:#dbece0; color:#2d4a3e; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Cooling & Hydrating</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 cucumber, 1/2 pear</li>
                    <li>1 inch fresh ginger</li>
                    <li>Squeeze of lime</li>
                    <li>1 tbsp hemp seeds</li>
                    <li>Coconut water base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fdf6f6; border:1px solid #eadddd; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_cacao_calm.png" alt="Cacao Calm" style="width:100%; height:180px; object-fit:cover; background:#eadddd;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">3. Cacao "Night Calm"</h4>
                <div style="display:inline-block; background:#eadddd; color:#5c4242; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Serotonin Boost</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 frozen banana</li>
                    <li>1 tbsp raw cacao powder</li>
                    <li>1 tbsp almond butter</li>
                    <li>Pinch sea salt</li>
                    <li>Oat milk base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fffbef; border:1px solid #efeac0; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_golden_turmeric.png" alt="Golden Turmeric" style="width:100%; height:180px; object-fit:cover; background:#efeac0;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">4. Golden Anti-Inflammatory</h4>
                <div style="display:inline-block; background:#efeac0; color:#7a6b28; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Joint Relief</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 cup frozen mango</li>
                    <li>1 tsp turmeric + pinch pepper</li>
                    <li>1 scoop unflavored protein</li>
                    <li>1 tsp flax oil</li>
                    <li>Coconut milk base</li>
                </ul>
            </div>
        </div>

        <!-- Additional recipes to reach 10+ -->
        <div style="background: #f0fdf4; border:1px solid #dcfce7; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_avocado_lime.png" alt="Avocado Lime" style="width:100%; height:180px; object-fit:cover; background:#dcfce7;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">5. Creamy Avocado Lime</h4>
                <div style="display:inline-block; background:#dcfce7; color:#166534; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Healthy Fats</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 ripe avocado</li>
                    <li>Zest & juice of 1 lime</li>
                    <li>1 serving vanilla protein</li>
                    <li>Handful of spinach</li>
                    <li>Unsweetened cashew milk</li>
                </ul>
            </div>
        </div>

        <div style="background: #fdf2f8; border:1px solid #fce7f3; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_cherry_sleep.png" alt="Cherry Sleep" style="width:100%; height:180px; object-fit:cover; background:#fce7f3;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">6. Cherry Chamomile Sleep</h4>
                <div style="display:inline-block; background:#fce7f3; color:#9d174d; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Natural Melatonin</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 cup frozen tart cherries</li>
                    <li>1/2 cup chamomile tea (chilled)</li>
                    <li>1 tbsp almond butter</li>
                    <li>1 tsp honey (optional)</li>
                    <li>Almond milk base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fff7ed; border:1px solid #ffedd5; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_pumpkin_pie.png" alt="Pumpkin Pie" style="width:100%; height:180px; object-fit:cover; background:#ffedd5;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">7. Pumpkin Pie Protein</h4>
                <div style="display:inline-block; background:#ffedd5; color:#9a3412; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Zinc & Magnesium</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 cup pumpkin pure</li>
                    <li>1 frozen banana</li>
                    <li>1 tsp pumpkin spice</li>
                    <li>1 tbsp pumpkin seeds</li>
                    <li>Vanilla protein & oat milk</li>
                </ul>
            </div>
        </div>

        <div style="background: #f0fdfa; border:1px solid #ccfbf1; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_matcha_mint.png" alt="Matcha Mint" style="width:100%; height:180px; object-fit:cover; background:#ccfbf1;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">8. Matcha Mint Energy</h4>
                <div style="display:inline-block; background:#ccfbf1; color:#115e59; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">L-Theanine Focus</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 tsp matcha powder</li>
                    <li>Fresh mint leaves</li>
                    <li>1/2 frozen banana</li>
                    <li>Vanilla protein</li>
                    <li>Coconut milk base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fff1f2; border:1px solid #ffe4e6; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_beet_berry.png" alt="Beet Berry" style="width:100%; height:180px; object-fit:cover; background:#ffe4e6;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">9. Beet & Berry Detox</h4>
                <div style="display:inline-block; background:#ffe4e6; color:#be123c; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Liver Support</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/4 raw beet (peeled)</li>
                    <li>1 cup mixed berries</li>
                    <li>1/2 lemon (juiced)</li>
                    <li>1 tsp flax seeds</li>
                    <li>Coconut water base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fffbeb; border:1px solid #fef3c7; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_banana_nut.png" alt="Banana Bread" style="width:100%; height:180px; object-fit:cover; background:#fef3c7;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">10. Banana Nut Pre-Workout</h4>
                <div style="display:inline-block; background:#fef3c7; color:#92400e; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Sustained Fuel</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 large frozen banana</li>
                    <li>1/4 cup rolled oats</li>
                    <li>1 tbsp walnut butter</li>
                    <li>Dash of cinnamon</li>
                    <li>Almond milk base</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Print Button -->
    <div style="margin-top: 50px; text-align: center;">
         <p style="color:var(--text-muted);">Prefer a printed copy?</p>
         <a href="adrenal_smoothie_guide.html" target="_blank" style="text-decoration:none;"><button style="background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-size:1rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='var(--primary)'">Download Printable Guide</button></a>
    </div>
</div>

<!-- MOVEMENT STUDIO SECTION -->
<div class="view-section" id="movement-archive">
    <div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); color: white;">
        <div style="font-family:'Inter'; text-transform:uppercase; color:#99f6e4; font-weight:600; letter-spacing:1px; margin-bottom:10px;">Body & Mind Connection</div>
        <h1 style="margin-bottom: 15px; color: white;">Movement Studio</h1>
        <p style="font-size: 1.1rem; color: #ccfbf1;">Gentle exercises designed to support hormone balance without spiking cortisol.</p>
    </div>

    <!-- MAIN PLAYER STAGE -->
    <div id="video-stage" style="display:none; margin-bottom:30px; background:black; border-radius:15px; overflow:hidden; aspect-ratio:16/9; position:relative;">
        <div id="video-placeholder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; background:#1e293b;">
            <div style="font-size:3rem; margin-bottom:20px;">??</div>
            <div id="video-title-display" style="color:white; font-size:1.2rem; font-weight:600;">Select a Workout</div>
            <p id="video-desc-display" style="color:#94a3b8; margin-top:10px;">Duration: -- min</p>
        </div>
        <button onclick="closeVideoStage()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">&times;</button>
    </div>

    <!-- EXERCISE DATABASE GRID -->
    <h3 style="color:var(--primary); margin: 30px 0 20px 0;">Featured Sessions</h3>
    
    <!-- EXERCISE TRACKER & DATABASE (Trainerize Style) -->
    <div id="tracker-interface" style="max-width: 800px; margin: 0 auto;">
        
        <!-- Tab Switcher -->
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:30px; border-bottom:1px solid #e2e8f0; padding-bottom:15px;">
            <button onclick="switchTrackerView('workout')" id="btn-workout" style="border:none; background:none; font-weight:700; color:var(--primary); border-bottom:3px solid var(--primary); padding-bottom:5px; cursor:pointer;">Today's Workout</button>
            <button onclick="switchTrackerView('library')" id="btn-library" style="border:none; background:none; font-weight:600; color:#94a3b8; border-bottom:3px solid transparent; padding-bottom:5px; cursor:pointer;">Exercise Library</button>
        </div>

        <!-- VIEW 1: TODAY'S WORKOUT -->
        <div id="view-workout">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
               <h3 style="margin:0; color:var(--primary); display:flex; align-items:center; gap:10px;">
                   <span>??</span> Today's Session
               </h3>
               <button onclick="saveWorkout()" style="background:var(--secondary); color:white; border:none; padding:10px 25px; border-radius:30px; font-weight:600; cursor:pointer; box-shadow:0 4px 10px rgba(16, 185, 129, 0.2);">
                   ? Complete
               </button>
            </div>

            <!-- Dynamic Workout List -->
            <div id="workout-list">
                <!-- Exercises injected here -->
            </div>
            
            <button onclick="switchTrackerView('library')" style="width:100%; padding:15px; border:2px dashed #cbd5e0; color:#64748b; background:transparent; border-radius:12px; font-weight:600; cursor:pointer; margin-top:20px; transition:all 0.2s; touch-action: manipulation; user-select: none; min-height: 50px;" onmouseover="this.style.borderColor='var(--primary)'; this.style.color='var(--primary)'" onmouseout="this.style.borderColor='#cbd5e0'; this.style.color='#64748b'">
                + Add Exercise
            </button>
        </div>

        <!-- VIEW 2: EXERCISE LIBRARY (DB) -->
        <div id="view-library" style="display:none;">
            <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px;">
                <h4 style="margin:0 0 10px 0; color:#334155;">Search Exercise Library</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="db-search-input" placeholder="e.g. Squat, Lunge, Plank..." style="flex:1; padding:12px; border:1px solid #cbd5e0; border-radius:8px; outline:none;" onkeyup="if(event.key === 'Enter') loadExerciseLibrary(this.value)">
                    <button onclick="loadExerciseLibrary(document.getElementById('db-search-input').value)" style="background:var(--primary); color:white; border:none; padding:0 25px; border-radius:8px; cursor:pointer; font-weight:600;">Search</button>
                </div>
                <div style="margin-top:10px; font-size:0.8rem; color:#64748b;">
                    Browse 1700+ exercise videos from our library. All videos hosted on Google Drive.
                </div>
            </div>

            <div id="library-results" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:15px;">
                <!-- Search Results -->
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">
                    Use the search bar above to browse 1300+ exercises.
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div id="exercise-video-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:black; width:90%; max-width:500px; aspect-ratio:16/9; position:relative; border-radius:12px; overflow:hidden;">
             <button onclick="closeExerciseModal()" style="position:absolute; top:10px; right:10px; z-index:10; background:rgba(0,0,0,0.5); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer;">&times;</button>
             <iframe id="modal-video-frame" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>
</div>

<!-- DINING OUT GUIDE -->
<div class="view-section" id="dining">
    <div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
        <div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">The Vegan Socialite</div>
        <h1 style="margin-bottom: 15px;">Restaurant Cheat Sheet</h1>
        <p style="font-size: 1.1rem; color: #555;">Never worry about what to order. Use these cheat codes to stay on track mentre dining out.</p>
    </div>

    <div class="card">
        <div class="card-body" style="opacity: 1; max-height: none; padding: 30px;">
            <h3 style="color:var(--secondary); text-transform:uppercase; letter-spacing:1px; font-size:1rem; margin-top:0;">General Dining Rules</h3>
            <ul style="margin-bottom:30px;">
                <li><strong>Protein First:</strong> Always scan for the protein options (Tofu, Beans, Lentils).</li>
                <li><strong>Sauce on Side:</strong> Most hidden oils and sugars are in the dressing.</li>
                <li><strong>Hydrate:</strong> Order sparkling water with lime immediately to settle in.</li>
            </ul>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:25px;">
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Italian</h4>
                    <p><strong>Order:</strong> Grilled vegetable antipasto, Minestrone soup, or simple Marinara pasta with a side of steamed spinach.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Heavy cream sauces (Alfredo) or excessive bread basket grazing.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Mexican</h4>
                    <p><strong>Order:</strong> The Burrito Bowl. Base of black beans and lettuce. Load up on Guacamole (healthy fats!) and Salsa.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Fried chips and heavy cheese quesadillas.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Thai</h4>
                    <p><strong>Order:</strong> Green or Red Curry with Tofu (coconut milk is great for hormones). Papaya Salad (Som Tum).</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Pad Thai (sugar) and deep-fried spring rolls.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Japanese</h4>
                    <p><strong>Order:</strong> Edamame, Miso Soup, Seaweed Salad, Avocado/Cucumber Rolls, Agedashi Tofu.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Tempura (deep fried) and hidden mayo in "spicy" rolls.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">?? Middle Eastern</h4>
                    <p><strong>Order:</strong> Hummus, Baba Ganoush, Falafel (request baked), Tabbouleh, grilled veggie skewers.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Deep-fried pita chips and heavy oil-based tahini swirls.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">?? Indian</h4>
                    <p><strong>Order:</strong> Dal Tadka, Chana Masala, Baingan Bharta (baked eggplant). High fiber and spices.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Heavy cream curries (Korma) or excessive Naan bread.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Greek</h4>
                    <p><strong>Order:</strong> Giant Beans (Gigantes), Greek Salad (no feta), Stuffed vine leaves (Dolmades).</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Feta-heavy dishes and phyllo pastries (Spanakopita).</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">?? Fast Casual</h4>
                    <p><strong>Order:</strong> Portobello Mushroom Burger (lettuce wrap), Bean-based Veggie Bowl, sweet potato sides.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Processed "fake meat" patties and white flour buns.</p>
                </div>
            </div>

            <!-- Print Button -->
            <div style="margin-top: 50px; text-align: center;">
                 <p style="color:var(--text-muted);">Want a pocket guide?</p>
                 <a href="adrenal_dining_guide.html" target="_blank" style="text-decoration:none;"><button style="background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-size:1rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='var(--primary)'">Download Printable Guide</button></a>
            </div>
        </div>
    </div>
</div>








<div class="view-section" id="bonuses">
     <div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
        <div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Exclusive Extras</div>
        <h1 style="margin-bottom: 15px;">Your Protocol Bonuses</h1>
        <p style="font-size: 1.1rem; color: #555;">Tools to support your adrenal recovery journey.</p>
    </div>

    <!-- The content of the original bonuses section (Smoothie, Dining, Acupressure) has been moved to dedicated sections above. -->
    <!-- This section can now be used for other bonuses or removed if no other bonuses are planned. -->
</div>

<div class="view-section" id="week1">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week1', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week1', 'Monday')">Day 1</button><button class="sub-btn" onclick="switchDay('week1', 'Tuesday')">Day 2</button><button class="sub-btn" onclick="switchDay('week1', 'Wednesday')">Day 3</button><button class="sub-btn" onclick="switchDay('week1', 'Thursday')">Day 4</button><button class="sub-btn" onclick="switchDay('week1', 'Friday')">Day 5</button><button class="sub-btn" onclick="switchDay('week1', 'Saturday')">Day 6</button><button class="sub-btn" onclick="switchDay('week1', 'Sunday')">Day 7</button>
</div>
<div class="day-view active" id="week1-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(to right, #eef2f3, #ffffff);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 1</div>
<h1 style="margin-bottom: 15px;">Reset and Debloat</h1>
<p style="font-size: 1.1rem; color: #555;">Flush inflammation with mineral-rich hydration.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>This week reduces the inflammatory load on your adrenal glands. By removing common stressors and flooding your system with minerals (potassium/magnesium), we signal safety to your nervous system, allowing baseline cortisol levels to drop so true restoration can begin.</p>
</div></div>
</div>
<div class="day-view" id="week1-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Stuffed Sweet Potato</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Stuffed Sweet Potato" src="/assets/stuffed_sweet_potato.jpg" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sweet potato 200g</li><li>Quinoa 150g</li><li>Black beans 150g</li><li>Kale 50g</li><li>Tahini 15g</li><li>Lemon juice</li><li>Pumpkin seeds 10g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast:</strong> Bake sweet potato (whole or cubed) until tender (approx 25-30 mins).<br/>
<strong>2. Stuff/Assemble:</strong> Mix cooked quinoa, rinsed black beans, and massaged kale. Stuff into the split potato or arrange in a bowl.<br/>
<strong>3. Serve:</strong> Drizzle with a dressing made of tahini and lemon juice. Top with pumpkin seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Miso Glazed Tempeh</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Miso Glazed Tempeh" src="/assets/miso_glazed_tempeh.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Miso 15g</li><li>Tamari 10ml</li><li>Maple 10ml</li><li>Bok choy 150g</li><li>Cauliflower rice 150g</li><li>Sesame oil</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Whisk miso, tamari, maple syrup, and sesame oil. Cube tempeh and toss in marinade. Let sit for 15-30 mins.<br/>
<strong>2. Cook Tempeh:</strong> Pan-fry tempeh over medium-high heat until golden and caramelized (approx 5-8 mins).<br/>
<strong>3. Sides:</strong> Steam bok choy (3-4 mins). Saut cauliflower rice with a splash of water or oil until tender.<br/>
<strong>4. Serve:</strong> Assemble in a bowl and drizzle with any remaining fresh tahini.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Chamomile Maca Moon Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Chamomile Maca Moon Milk" src="/assets/chamomile_maca_moon_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca 5g</li><li>Cinnamon</li><li>Magnesium</li><li>Chamomile tea</li></ul>
<h4>Preparation</h4>
<p>Steep tea in hot milk. Whisk powders.</p>
</div>
</div>
</div><div class="day-view" id="week1-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Cucumber Mint Green Juice + Tofu Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cucumber Mint Green Juice + Tofu Scramble" src="/assets/cucumber_mint_juice_tofu_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cucumber 200g</li><li>Fresh mint 10g</li><li>Firm tofu 200g</li><li>Asparagus 100g</li><li>Dill 5g</li><li>Olive oil 10ml</li><li>Turmeric 2g</li><li>Black salt 1g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Juice:</strong> Juice cucumber and mint (or blend and strain).<br/>
<strong>2. Scramble:</strong> Crumble firm tofu. Saut in olive oil with turmeric and black salt for 5 mins.<br/>
<strong>3. Veggies:</strong> Steam asparagus until tender-crisp. Chop and mix with tofu and fresh dill.<br/>
<strong>4. Serve:</strong> Plate the scramble with the green juice on the side.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Rainbow Collard Wraps</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Collard Wraps" src="/assets/rainbow_collard_wraps.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Collard greens 6 leaves</li><li>Carrot 100g</li><li>Red lentils 250g</li><li>Avocado 100g</li><li>Bean sprouts 50g</li><li>Tahini 20g</li><li>Garlic 2g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prepare Leaves:</strong> Blanch collard leaves in boiling water for 30 seconds, then plunge into ice water. Pat dry and trim the thick stem spine carefully.<br/>
<strong>2. Make Paste:</strong> Mash red lentils (cooked) with tahini, minced garlic, and a squeeze of lemon until spreadable.<br/>
<strong>3. Assemble:</strong> Spread lentil paste on each leaf. Top with shredded carrot, avocado slices, and bean sprouts.<br/>
<strong>4. Roll:</strong> Fold sides in and roll tightly like a burrito.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Coconut Curry Red Lentil Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Coconut Curry Red Lentil Soup" src="/assets/coconut_curry_red_lentil_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Red lentils 250g</li><li>Light coconut milk 200ml</li><li>Curry paste 20g</li><li>Delicata squash 150g</li><li>Onion/Garlic/Ginger</li><li>Stock 300ml</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Squash:</strong> Toss delicata squash cubes with oil and roast at 200C for 20-25 mins until tender.<br/>
<strong>2. Base:</strong> Saut diced onion, garlic, and ginger until fragrant. Stir in curry paste for 1 minute.<br/>
<strong>3. Simmer:</strong> Add red lentils, coconut milk, and stock. Simmer for 15-20 mins until lentils are soft.<br/>
<strong>4. Serve:</strong> Ladle soup into bowls and top with roasted squash.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Tea" src="/assets/lemon_balm_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lemon balm tea</li><li>Ground flax 5g</li></ul>
<h4>Preparation</h4>
<p>Steep tea. Stir in flax.</p>
</div>
</div>
</div><div class="day-view" id="week1-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Glow Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Glow Bowl" src="/assets/glow_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Baby greens 100g</li><li>Fennel bulb 150g</li><li>White beans 200g</li><li>Artichoke hearts 100g</li><li>Pesto 25g</li><li>Lemon/Oil</li></ul>
<h4>Preparation</h4>
<p>Roast fennel. Arrange greens. Top with beans/artichokes/fennel. Drizzle with pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Zucchini Noodle Pho</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Zucchini Noodle Pho" src="/assets/zucchini_noodle_pho.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 250g</li><li>Veg broth 300ml</li><li>Star anise/Cinnamon</li><li>Tofu 200g</li><li>Edamame 50g</li><li>Shiitake 100g</li><li>Mung sprouts</li><li>Basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Infuse Broth:</strong> Simmer vegetable broth with star anise, cinnamon stick, ginger slices, and onion for 15 mins. Strain if desired.<br/>
<strong>2. Add Veggies:</strong> Add sliced shiitake mushrooms and simmer for 5 mins.<br/>
<strong>3. Finish:</strong> Add tofu cubes and zucchini noodles (zoodles) for just the last 1-2 minutes to warm through without overcooking.<br/>
<strong>4. Serve:</strong> Top with fresh basil, sprouts, and lime.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Golden Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Golden Milk" src="/assets/golden_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Turmeric</li><li>Ginger</li><li>Coconut oil 3g</li><li>Triphala</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Whisk all ingredients in hot milk.</p>
</div>
</div>
</div><div class="day-view" id="week1-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Cucumber Mint Green Juice + Tofu Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cucumber Mint Green Juice + Tofu Scramble" src="/assets/cucumber_mint_juice_tofu_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cucumber 200g</li><li>Fresh mint 10g</li><li>Firm tofu 200g</li><li>Asparagus 100g</li><li>Dill 5g</li><li>Olive oil 10ml</li><li>Turmeric 2g</li><li>Black salt 1g</li></ul>
<h4>Preparation</h4>
<p>Juice cucumber/mint. Saut crumbled tofu with spices. Steam asparagus. Mix tofu with dill/asparagus. Serve with juice.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lemony Quinoa &amp; Chickpea Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemony Quinoa &amp; Chickpea Bowl" src="/assets/lemony_quinoa_chickpea_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Quinoa 150g</li><li>Pumpkin seeds 20g</li><li>Mint &amp; Parsley 10g</li><li>Lemon juice 15ml</li><li>Plant protein 20g</li></ul>
<h4>Preparation</h4>
<p>Assemble bowl. Whisk lemon juice/oil dressing. Drizzle over.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Miso Glazed Tempeh</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Miso Glazed Tempeh" src="/assets/miso_glazed_tempeh.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Miso 15g</li><li>Tamari 10ml</li><li>Maple 10ml</li><li>Bok choy 150g</li><li>Cauliflower rice 150g</li><li>Sesame oil</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p>Marinate/fry tempeh. Steam bok choy. Saut rice. Serve bowl style.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Chamomile Maca Moon Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Chamomile Maca Moon Milk" src="/assets/chamomile_maca_moon_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca 5g</li><li>Cinnamon</li><li>Magnesium</li><li>Chamomile tea</li></ul>
<h4>Preparation</h4>
<p>Steep tea in hot milk. Whisk powders.</p>
</div>
</div>
</div><div class="day-view" id="week1-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Rainbow Collard Wraps</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Collard Wraps" src="/assets/rainbow_collard_wraps.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Collard greens 6 leaves</li><li>Carrot 100g</li><li>Red lentils 250g</li><li>Avocado 100g</li><li>Bean sprouts 50g</li><li>Tahini 20g</li><li>Garlic 2g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prepare Leaves:</strong> Blanch collard leaves in boiling water for 30 seconds, then plunge into ice water. Pat dry and trim the thick stem spine carefully.<br/>
<strong>2. Make Paste:</strong> Mash red lentils (cooked) with tahini, minced garlic, and a squeeze of lemon until spreadable.<br/>
<strong>3. Assemble:</strong> Spread lentil paste on each leaf. Top with shredded carrot, avocado slices, and bean sprouts.<br/>
<strong>4. Roll:</strong> Fold sides in and roll tightly like a burrito.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Coconut Curry Red Lentil Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Coconut Curry Red Lentil Soup" src="/assets/coconut_curry_red_lentil_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Red lentils 250g</li><li>Light coconut milk 200ml</li><li>Curry paste 20g</li><li>Delicata squash 150g</li><li>Onion/Garlic/Ginger</li><li>Stock 300ml</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Squash:</strong> Toss delicata squash cubes with oil and roast at 200C for 20-25 mins until tender.<br/>
<strong>2. Base:</strong> Saut diced onion, garlic, and ginger until fragrant. Stir in curry paste for 1 minute.<br/>
<strong>3. Simmer:</strong> Add red lentils, coconut milk, and stock. Simmer for 15-20 mins until lentils are soft.<br/>
<strong>4. Serve:</strong> Ladle soup into bowls and top with roasted squash.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Tea" src="/assets/lemon_balm_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lemon balm tea</li><li>Ground flax 5g</li></ul>
<h4>Preparation</h4>
<p>Steep tea. Stir in flax.</p>
</div>
</div>
</div><div class="day-view" id="week1-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Cucumber Mint Green Juice + Tofu Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cucumber Mint Green Juice + Tofu Scramble" src="/assets/cucumber_mint_juice_tofu_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cucumber 200g</li><li>Fresh mint 10g</li><li>Firm tofu 200g</li><li>Asparagus 100g</li><li>Dill 5g</li><li>Olive oil 10ml</li><li>Turmeric 2g</li><li>Black salt 1g</li></ul>
<h4>Preparation</h4>
<p>Juice cucumber/mint. Saut crumbled tofu with spices. Steam asparagus. Mix tofu with dill/asparagus. Serve with juice.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Glow Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Glow Bowl" src="/assets/glow_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Baby greens 100g</li><li>Fennel bulb 150g</li><li>White beans 200g</li><li>Artichoke hearts 100g</li><li>Pesto 25g</li><li>Lemon/Oil</li></ul>
<h4>Preparation</h4>
<p>Roast fennel. Arrange greens. Top with beans/artichokes/fennel. Drizzle with pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Zucchini Noodle Pho</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Zucchini Noodle Pho" src="/assets/zucchini_noodle_pho.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 250g</li><li>Veg broth 300ml</li><li>Star anise/Cinnamon</li><li>Tofu 200g</li><li>Shiitake 100g</li><li>Mung sprouts</li><li>Basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Infuse Broth:</strong> Simmer vegetable broth with star anise, cinnamon stick, ginger slices, and onion for 15 mins. Strain if desired.<br/>
<strong>2. Add Veggies:</strong> Add sliced shiitake mushrooms and simmer for 5 mins.<br/>
<strong>3. Finish:</strong> Add tofu cubes and zucchini noodles (zoodles) for just the last 1-2 minutes to warm through without overcooking.<br/>
<strong>4. Serve:</strong> Top with fresh basil, sprouts, and lime.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Golden Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Golden Milk" src="/assets/golden_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Turmeric</li><li>Ginger</li><li>Coconut oil 3g</li><li>Triphala</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Whisk all ingredients in hot milk.</p>
</div>
</div>
</div><div class="day-view" id="week1-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lemony Quinoa &amp; Chickpea Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemony Quinoa &amp; Chickpea Bowl" src="/assets/lemony_quinoa_chickpea_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Quinoa 150g</li><li>Pumpkin seeds 20g</li><li>Mint &amp; Parsley 10g</li><li>Lemon juice 15ml</li><li>Plant protein 20g</li></ul>
<h4>Preparation</h4>
<p>Assemble bowl. Whisk lemon juice/oil dressing. Drizzle over.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Miso Glazed Tempeh</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Miso Glazed Tempeh" src="/assets/miso_glazed_tempeh.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Miso 15g</li><li>Tamari 10ml</li><li>Maple 10ml</li><li>Bok choy 150g</li><li>Cauliflower rice 150g</li><li>Sesame oil</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Whisk miso, tamari, maple syrup, and sesame oil. Cube tempeh and toss in marinade. Let sit for 15-30 mins.<br/>
<strong>2. Cook Tempeh:</strong> Pan-fry tempeh over medium-high heat until golden and caramelized (approx 5-8 mins).<br/>
<strong>3. Sides:</strong> Steam bok choy (3-4 mins). Saut cauliflower rice with a splash of water or oil until tender.<br/>
<strong>4. Serve:</strong> Assemble in a bowl and drizzle with any remaining fresh tahini.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Chamomile Maca Moon Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Chamomile Maca Moon Milk" src="/assets/chamomile_maca_moon_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca 5g</li><li>Cinnamon</li><li>Magnesium</li><li>Chamomile tea</li></ul>
<h4>Preparation</h4>
<p>Steep tea in hot milk. Whisk powders.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="week2">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week2', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week2', 'Monday')">Day 8</button><button class="sub-btn" onclick="switchDay('week2', 'Tuesday')">Day 9</button><button class="sub-btn" onclick="switchDay('week2', 'Wednesday')">Day 10</button><button class="sub-btn" onclick="switchDay('week2', 'Thursday')">Day 11</button><button class="sub-btn" onclick="switchDay('week2', 'Friday')">Day 12</button><button class="sub-btn" onclick="switchDay('week2', 'Saturday')">Day 13</button><button class="sub-btn" onclick="switchDay('week2', 'Sunday')">Day 14</button>
</div>
<div class="day-view active" id="week2-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 2</div>
<h1 style="margin-bottom: 15px;">Strength &amp; Blood Sugar</h1>
<p style="font-size: 1.1rem; color: #555;">Higher protein and fiber dense carbs.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>Bio-availability is key. We pair protein with slow-burning complex carbs to prevent the blood sugar dips that trigger "panic" cortisol spikes. This steady energy supply keeps your mood stable and your adrenal output calm throughout the day.</p>
</div></div>
</div>
<div class="day-view" id="week2-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Warm Apple Pie Oat Bake</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Warm Apple Pie Oat Bake" src="/assets/warm_apple_pie_oat_bake.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 50g</li><li>Apple 120g</li><li>Cardamom</li><li>Hemp yogurt 80g</li><li>Pear 80g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine rolled oats, chopped apple, cardamom, and a splash of almond milk/water in a baking dish.<br/>
<strong>2. Bake:</strong> Bake at 180C for 20-25 minutes until oats are set and apples are soft.<br/>
<strong>3. Serve:</strong> Top with a dollop of hemp yogurt and fresh pear slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Farro Power Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Farro Power Bowl" src="/assets/farro_power_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Farro 80g</li><li>Tempeh 150g</li><li>Brussels sprouts 100g</li><li>Pomegranate</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prep Components:</strong> Cook farro according to package instructions. Roast halved Brussels sprouts at 200C for 20 mins.<br/>
<strong>2. Tempeh:</strong> Pan-fry tempeh cubes with a splash of tamari until crispy.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, 1 tbsp water, and a drop of maple syrup until smooth.<br/>
<strong>4. Assemble:</strong> Combine farro, sprouts, and tempeh. Top with pomegranate seeds and dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Walnut Crusted Tofu</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Walnut Crusted Tofu" src="/assets/walnut_crusted_tofu.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Walnuts 20g</li><li>Sweet potato 200g</li><li>Green beans</li></ul>
<h4>Preparation</h4>
<p><strong>1. Crust Tofu:</strong> Mix crushed walnuts with spices. Dip pressed tofu slabs in almond milk, then press into walnut mix.<br/>
<strong>2. Bake:</strong> Place tofu and sweet potato wedges on a baking sheet. Bake at 200C for 25-30 minutes until crispy.<br/>
<strong>3. Veggies:</strong> Briefly steam or saut green beans with garlic.<br/>
<strong>4. Serve:</strong> Plate tofu with fries and beans.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Reishi Hot Chocolate</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Reishi Hot Chocolate" src="/assets/reishi_hot_chocolate.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk</li><li>Cacao</li><li>Reishi</li><li>Monk fruit</li></ul>
<h4>Preparation</h4>
<p>Whisk heated ingredients.</p>
</div>
</div>
</div><div class="day-view" id="week2-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Savory Chickpea Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Savory Chickpea Scramble" src="/assets/savory_chickpea_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Tofu 200g</li><li>Spinach 100g</li><li>Pesto 10g</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Scramble Base:</strong> Roughly mash chickpeas and tofu with a fork.<br/>
<strong>2. Saut:</strong> Saut chopped onion and tomatoes in a pan until soft. Add chickpea/tofu mix.<br/>
<strong>3. Season:</strong> Add turmeric, black salt (kala namak), and pepper. Cook 5-7 mins.<br/>
<strong>4. Finish:</strong> Stir in fresh spinach until wilted. Remove from heat and fold in pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Hearty Tempeh Chili</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Hearty Tempeh Chili" src="/assets/hearty_tempeh_chili.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Kidney beans 100g</li><li>Cacao</li><li>Tomatoes 200g</li><li>Chili spices</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Cook onions, garlic, and peppers until soft. Add crumbled tempeh and brown lightly.<br/>
<strong>2. Simmer:</strong> Add kidney beans, crushed tomatoes, chili powder, cumin, and vegetable broth. Simmer for 20-30 mins to thicken.<br/>
<strong>3. Finish:</strong> Stir in raw cacao powder right before serving for depth.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Sheet Pan Lemon Seitan</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sheet Pan Lemon Seitan" src="/assets/sheet_pan_lemon_seitan.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seitan 150g</li><li>Asparagus 150g</li><li>Fennel 100g</li><li>Orange</li></ul>
<h4>Preparation</h4>
<p><strong>1. Toss:</strong> Combine seitan chunks, asparagus spears, and fennel wedges on a sheet pan. Toss with olive oil, lemon juice, dried oregano, and garlic powder.<br/>
<strong>2. Bake:</strong> Roast at 200C for 20 minutes until golden and veggies are tender.<br/>
<strong>3. Serve:</strong> Garnish with fresh orange zest or slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tulsi Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tulsi Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tulsi tea</li><li>Lemon</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Blue Spirulina Smoothie Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Blue Spirulina Smoothie Bowl" src="/assets/blue_spirulina_smoothie_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cauli rice 100g</li><li>Blueberries 150g</li><li>Pea protein</li><li>Spirulina</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p>Blend all. Decoration optional.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Mediterranean Lentil Salad</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mediterranean Lentil Salad" src="/assets/mediterranean_lentil_salad.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 100g</li><li>Eggplant 200g</li><li>Tahini 15g</li><li>Parsley</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Eggplant:</strong> Cube eggplant, toss with oil and salt. Roast at 200C for 25 mins.<br/>
<strong>2. Salad Base:</strong> Combine cooked lentils, roasted eggplant, diced tomatoes, chopped parsley, and cucumber.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, garlic, and a splash of water.<br/>
<strong>4. Serve:</strong> Toss salad with dressing while warm or cold.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Rainbow Sushi Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Sushi Bowl" src="/assets/rainbow_sushi_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Black rice 150g</li><li>Smoked tofu 150g</li><li>Avocado</li><li>Cucumber</li><li>Nori</li></ul>
<h4>Preparation</h4>
<p><strong>1. Rice:</strong> Cook black rice according to package. Stir in a little rice vinegar when done.<br/>
<strong>2. Prep:</strong> Cube smoked tofu. Slice avocado and cucumber. Cut nori into small strips.<br/>
<strong>3. Assemble:</strong> Arrange everything in a bowl.<br/>
<strong>4. Dress:</strong> Drizzle with tamari and sesame oil.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Sage &amp; Lavender Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sage &amp; Lavender Tea" src="/assets/sage_lavender_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sage</li><li>Lavender</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Overnight Buckwheat Groats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Overnight Buckwheat Groats" src="/assets/overnight_buckwheat_groats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Buckwheat 60g</li><li>Almond milk 150ml</li><li>Cacao nibs</li><li>Cherries</li><li>Alhond yogurt</li></ul>
<h4>Preparation</h4>
<p>Soak overnight. Top with cherries/yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Farro Power Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Farro Power Bowl" src="/assets/farro_power_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Farro 80g</li><li>Tempeh 150g</li><li>Brussels sprouts 100g</li><li>Pomegranate</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prep Components:</strong> Cook farro according to package instructions. Roast halved Brussels sprouts at 200C for 20 mins.<br/>
<strong>2. Tempeh:</strong> Pan-fry tempeh cubes with a splash of tamari until crispy.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, 1 tbsp water, and a drop of maple syrup until smooth.<br/>
<strong>4. Assemble:</strong> Combine farro, sprouts, and tempeh. Top with pomegranate seeds and dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Walnut Crusted Tofu</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Walnut Crusted Tofu" src="/assets/walnut_crusted_tofu.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Walnuts 20g</li><li>Sweet potato 200g</li><li>Green beans</li></ul>
<h4>Preparation</h4>
<p><strong>1. Crust Tofu:</strong> Mix crushed walnuts with spices. Dip pressed tofu slabs in almond milk, then press into walnut mix.<br/>
<strong>2. Bake:</strong> Place tofu and sweet potato wedges on a baking sheet. Bake at 200C for 25-30 minutes until crispy.<br/>
<strong>3. Veggies:</strong> Briefly steam or saut green beans with garlic.<br/>
<strong>4. Serve:</strong> Plate tofu with fries and beans.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Reishi Hot Chocolate</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Reishi Hot Chocolate" src="/assets/reishi_hot_chocolate.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk</li><li>Cacao</li><li>Reishi</li><li>Monk fruit</li></ul>
<h4>Preparation</h4>
<p>Whisk heated ingredients.</p>
</div>
</div>
</div><div class="day-view" id="week2-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Warm Apple Pie Oat Bake</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Warm Apple Pie Oat Bake" src="/assets/warm_apple_pie_oat_bake.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 50g</li><li>Apple 120g</li><li>Cardamom</li><li>Hemp yogurt 80g</li><li>Pear 80g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine rolled oats, chopped apple, cardamom, and a splash of almond milk/water in a baking dish.<br/>
<strong>2. Bake:</strong> Bake at 180C for 20-25 minutes until oats are set and apples are soft.<br/>
<strong>3. Serve:</strong> Top with a dollop of hemp yogurt and fresh pear slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Hearty Tempeh Chili</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Hearty Tempeh Chili" src="/assets/hearty_tempeh_chili.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Kidney beans 100g</li><li>Cacao</li><li>Tomatoes 200g</li><li>Chili spices</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Cook onions, garlic, and peppers until soft. Add crumbled tempeh and brown lightly.<br/>
<strong>2. Simmer:</strong> Add kidney beans, crushed tomatoes, chili powder, cumin, and vegetable broth. Simmer for 20-30 mins to thicken.<br/>
<strong>3. Finish:</strong> Stir in raw cacao powder right before serving for depth.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Sheet Pan Lemon Seitan</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sheet Pan Lemon Seitan" src="/assets/sheet_pan_lemon_seitan.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seitan 150g</li><li>Asparagus 150g</li><li>Fennel 100g</li><li>Orange</li></ul>
<h4>Preparation</h4>
<p><strong>1. Toss:</strong> Combine seitan chunks, asparagus spears, and fennel wedges on a sheet pan. Toss with olive oil, lemon juice, dried oregano, and garlic powder.<br/>
<strong>2. Bake:</strong> Roast at 200C for 20 minutes until golden and veggies are tender.<br/>
<strong>3. Serve:</strong> Garnish with fresh orange zest or slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tulsi Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tulsi Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tulsi tea</li><li>Lemon</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Savory Chickpea Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Savory Chickpea Scramble" src="/assets/savory_chickpea_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Tofu 200g</li><li>Spinach 100g</li><li>Pesto 10g</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Scramble Base:</strong> Roughly mash chickpeas and tofu with a fork.<br/>
<strong>2. Saut:</strong> Saut chopped onion and tomatoes in a pan until soft. Add chickpea/tofu mix.<br/>
<strong>3. Season:</strong> Add turmeric, black salt (kala namak), and pepper. Cook 5-7 mins.<br/>
<strong>4. Finish:</strong> Stir in fresh spinach until wilted. Remove from heat and fold in pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Mediterranean Lentil Salad</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mediterranean Lentil Salad" src="/assets/mediterranean_lentil_salad.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 100g</li><li>Eggplant 200g</li><li>Tahini 15g</li><li>Parsley</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Eggplant:</strong> Cube eggplant, toss with oil and salt. Roast at 200C for 25 mins.<br/>
<strong>2. Salad Base:</strong> Combine cooked lentils, roasted eggplant, diced tomatoes, chopped parsley, and cucumber.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, garlic, and a splash of water.<br/>
<strong>4. Serve:</strong> Toss salad with dressing while warm or cold.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Rainbow Sushi Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Sushi Bowl" src="/assets/rainbow_sushi_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Black rice 150g</li><li>Smoked tofu 150g</li><li>Avocado</li><li>Cucumber</li><li>Nori</li></ul>
<h4>Preparation</h4>
<p><strong>1. Rice:</strong> Cook black rice according to package. Stir in a little rice vinegar when done.<br/>
<strong>2. Prep:</strong> Cube smoked tofu. Slice avocado and cucumber. Cut nori into small strips.<br/>
<strong>3. Assemble:</strong> Arrange everything in a bowl.<br/>
<strong>4. Dress:</strong> Drizzle with tamari and sesame oil.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Sage &amp; Lavender Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sage &amp; Lavender Tea" src="/assets/sage_lavender_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sage</li><li>Lavender</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Blue Spirulina Smoothie Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Blue Spirulina Smoothie Bowl" src="/assets/blue_spirulina_smoothie_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cauli rice 100g</li><li>Blueberries 150g</li><li>Pea protein</li><li>Spirulina</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p>Blend all. Decoration optional.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Farro Power Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Farro Power Bowl" src="/assets/farro_power_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Farro 80g</li><li>Tempeh 150g</li><li>Brussels sprouts 100g</li><li>Pomegranate</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast sprouts. Fry tempeh. Assemble bowl with tahini dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Walnut Crusted Tofu</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Walnut Crusted Tofu" src="/assets/walnut_crusted_tofu.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Walnuts 20g</li><li>Sweet potato 200g</li><li>Green beans</li></ul>
<h4>Preparation</h4>
<p>Crust tofu/fry. Roast potato. Saut beans.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Reishi Hot Chocolate</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Reishi Hot Chocolate" src="/assets/reishi_hot_chocolate.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk</li><li>Cacao</li><li>Reishi</li><li>Monk fruit</li></ul>
<h4>Preparation</h4>
<p>Whisk heated ingredients.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="week3">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week3', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week3', 'Monday')">Day 15</button><button class="sub-btn" onclick="switchDay('week3', 'Tuesday')">Day 16</button><button class="sub-btn" onclick="switchDay('week3', 'Wednesday')">Day 17</button><button class="sub-btn" onclick="switchDay('week3', 'Thursday')">Day 18</button><button class="sub-btn" onclick="switchDay('week3', 'Friday')">Day 19</button><button class="sub-btn" onclick="switchDay('week3', 'Saturday')">Day 20</button><button class="sub-btn" onclick="switchDay('week3', 'Sunday')">Day 21</button>
</div>
<div class="day-view active" id="week3-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(to right, #fbfdef, #ffffff);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 3</div>
<h1 style="margin-bottom: 15px;">Metabolism Boost</h1>
<p style="font-size: 1.1rem; color: #555;">Thermogenic foods and spices.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>We gently support your metabolic rate with warming, nutrient-dense foods rather than stimulants. Selenium and Zinc nourish the thyroidyour adrenals' partner in energy productionensuring you feel energized without the "tired-wired" crash.</p>
</div></div>
</div>
<div class="day-view" id="week3-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Fire Tonic &amp; Lentil Waffles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fire Tonic &amp; Lentil Waffles" src="/assets/fire_tonic_lentil_waffles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tonic: ACV, Ginger, Cayenne</li><li>Lentils 150g</li><li>Chickpea flour 50g</li><li>Kimchi</li><li>Avocado</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tonic:</strong> Mix warm water, apple cider vinegar, grated ginger, and a pinch of cayenne.<br/>
<strong>2. Waffles:</strong> Blend soaked red lentils (or use flour), chickpea flour, water, baking powder, and salt. Cook in a greased waffle iron until crisp.<br/>
<strong>3. Serve:</strong> Drink tonic first. Top waffles with kimchi and sliced avocado.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Thai Basil Zucchini Noodles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Thai Basil Zucchini Noodles" src="/assets/thai_basil_zucchini_noodles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 300g</li><li>Tofu 200g</li><li>Almond butter</li><li>Coconut milk</li><li>Thai basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tofu:</strong> Pan-fry tofu cubes with soy sauce until golden.<br/>
<strong>2. Sauce:</strong> Whisk almond butter, coconut milk, lime juice, ginger, and garlic until creamy.<br/>
<strong>3. Noodles:</strong> Spiralize zucchini. Toss zoodles in the sauce briefly to warm (don't cook too long).<br/>
<strong>4. Serve:</strong> Top with tofu and fresh Thai basil leaves.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p><strong>1. Steaks:</strong> Slice cauliflower into thick "steaks". Brush with oil, turmeric, cumin, and paprika.<br/>
<strong>2. Roast:</strong> Bake at 200C for 25-30 minutes, flipping halfway, until tender and charred.<br/>
<strong>3. Base:</strong> Warm the cooked beluga lentils and massage the kale with lemon.<br/>
<strong>4. Serve:</strong> Place steaks over lentils/kale and drizzle with tahini.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Dandelion Root Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Dandelion Root Latte" src="/assets/dandelion_root_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dandelion root</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p>Heat and whisk.</p>
</div>
</div>
</div><div class="day-view" id="week3-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Carrot Cake Chia Parfait</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Chia Parfait" src="/assets/carrot_cake_chia_parfait.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 30g</li><li>Carrot 100g</li><li>Cashew butter</li><li>Coconut cream</li><li>Walnuts</li></ul>
<h4>Preparation</h4>
<p>Layer chia pudding with grated carrot/cream.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Moroccan Chickpea Stew</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Moroccan Chickpea Stew" src="/assets/moroccan_chickpea_stew.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 200g</li><li>Millet 150g</li><li>Apricots</li><li>Tomatoes</li><li>Spinach</li></ul>
<h4>Preparation</h4>
<p><strong>1. Base:</strong> Saut onion, garlic, and ginger with cumin, cinnamon, and turmeric.<br/>
<strong>2. Simmer:</strong> Add chickpeas, chopped tomatoes, dried apricots, and broth. Simmer for 20 mins.<br/>
<strong>3. Greens:</strong> Stir in spinach at the end to wilt.<br/>
<strong>4. Serve:</strong> Spoon stew over fluffy cooked millet.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Grilled Tofu Tikka</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grilled Tofu Tikka" src="/assets/grilled_tofu_tikka.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Cauli rice 150g</li><li>Cucumber/Mint salad</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Coat tofu in coconut yogurt mixed with tikka spices, lime, and ginger. Let sit for 20+ mins.<br/>
<strong>2. Grill/Bake:</strong> Grill skewers or bake tofu at 220C until edges are charred (approx 20 mins).<br/>
<strong>3. Sides:</strong> Serve with heated cauliflower rice and a cooling cucumber/mint salad.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Holy Basil Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Holy Basil Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fresh basil</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Metabolic Mocha Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Metabolic Mocha Smoothie" src="/assets/metabolic_mocha_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cold brew</li><li>Cacao</li><li>Chili</li><li>Pea protein</li><li>Banana</li></ul>
<h4>Preparation</h4>
<p>Blend.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Charred Broccoli &amp; Bean Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Charred Broccoli &amp; Bean Bowl" src="/assets/charred_broccoli_bean_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Broccoli 200g</li><li>Cannellini beans 150g</li><li>Romesco sauce</li></ul>
<h4>Preparation</h4>
<p><strong>1. Char:</strong> Toss broccoli florets with oil and roast at high heat (220C) or pan-sear until charred/browned.<br/>
<strong>2. Combine:</strong> Mix warm broccoli with cannellini beans.<br/>
<strong>3. Serve:</strong> Toss generously with Romesco sauce (roasted red pepper &amp; almond sauce).</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast cauliflower. Serve over lentils/kale.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Fennel Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Tea" src="/assets/fennel_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel seeds</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Fire Tonic &amp; Lentil Waffles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fire Tonic &amp; Lentil Waffles" src="/assets/fire_tonic_lentil_waffles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tonic: ACV, Ginger, Cayenne</li><li>Lentils 150g</li><li>Chickpea flour 50g</li><li>Kimchi</li><li>Avocado</li></ul>
<h4>Preparation</h4>
<p>Drink tonic. Blend/cook waffles. Top with kimchi/avo.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Sweet Potato Nourish Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sweet Potato Nourish Bowl" src="/assets/sweet_potato_nourish_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sweet potato 200g</li><li>Kale</li><li>Quinoa</li><li>Maple Miso dressing</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast:</strong> Roast sweet potato wedges at 200C until tender.<br/>
<strong>2. Kale:</strong> Remove kale stems and massage leaves with a little olive oil and salt to soften.<br/>
<strong>3. Dressing:</strong> Whisk maple, miso, and apple cider vinegar.<br/>
<strong>4. Serve:</strong> Assemble bowl with quinoa, potato, kale, and drizzle with dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Grilled Tofu Tikka</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grilled Tofu Tikka" src="/assets/grilled_tofu_tikka.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Cauli rice 150g</li><li>Cucumber/Mint salad</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p>Grill marinated tofu. Serve with rice/salad.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Dandelion Root Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Dandelion Root Latte" src="/assets/dandelion_root_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dandelion root</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p>Heat and whisk.</p>
</div>
</div>
</div><div class="day-view" id="week3-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Carrot Cake Chia Parfait</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Chia Parfait" src="/assets/carrot_cake_chia_parfait.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 30g</li><li>Carrot 100g</li><li>Cashew butter</li><li>Coconut cream</li><li>Walnuts</li></ul>
<h4>Preparation</h4>
<p>Layer chia pudding with grated carrot/cream.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Thai Basil Zucchini Noodles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Thai Basil Zucchini Noodles" src="/assets/thai_basil_zucchini_noodles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 300g</li><li>Tofu 200g</li><li>Almond butter</li><li>Coconut milk</li><li>Thai basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tofu:</strong> Pan-fry tofu cubes with soy sauce until golden.<br/>
<strong>2. Sauce:</strong> Whisk almond butter, coconut milk, lime juice, ginger, and garlic until creamy.<br/>
<strong>3. Noodles:</strong> Spiralize zucchini. Toss zoodles in the sauce briefly to warm (don't cook too long).<br/>
<strong>4. Serve:</strong> Top with tofu and fresh Thai basil leaves.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast cauliflower. Serve over lentils/kale.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Holy Basil Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Holy Basil Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fresh basil</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Metabolic Mocha Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Metabolic Mocha Smoothie" src="/assets/metabolic_mocha_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cold brew</li><li>Cacao</li><li>Chili</li><li>Pea protein</li><li>Banana</li></ul>
<h4>Preparation</h4>
<p>Blend.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Moroccan Chickpea Stew</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Moroccan Chickpea Stew" src="/assets/moroccan_chickpea_stew.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 200g</li><li>Millet 150g</li><li>Apricots</li><li>Tomatoes</li><li>Spinach</li></ul>
<h4>Preparation</h4>
<p><strong>1. Base:</strong> Saut onion, garlic, and ginger with cumin, cinnamon, and turmeric.<br/>
<strong>2. Simmer:</strong> Add chickpeas, chopped tomatoes, dried apricots, and broth. Simmer for 20 mins.<br/>
<strong>3. Greens:</strong> Stir in spinach at the end to wilt.<br/>
<strong>4. Serve:</strong> Spoon stew over fluffy cooked millet.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Grilled Tofu Tikka</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grilled Tofu Tikka" src="/assets/grilled_tofu_tikka.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Cauli rice 150g</li><li>Cucumber/Mint salad</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Coat tofu in coconut yogurt mixed with tikka spices, lime, and ginger. Let sit for 20+ mins.<br/>
<strong>2. Grill/Bake:</strong> Grill skewers or bake tofu at 220C until edges are charred (approx 20 mins).<br/>
<strong>3. Sides:</strong> Serve with heated cauliflower rice and a cooling cucumber/mint salad.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Fennel Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Tea" src="/assets/fennel_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel seeds</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Fire Tonic &amp; Lentil Waffles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fire Tonic &amp; Lentil Waffles" src="/assets/fire_tonic_lentil_waffles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tonic: ACV, Ginger, Cayenne</li><li>Lentils 150g</li><li>Chickpea flour 50g</li><li>Kimchi</li><li>Avocado</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tonic:</strong> Mix warm water, apple cider vinegar, grated ginger, and a pinch of cayenne.<br/>
<strong>2. Waffles:</strong> Blend soaked red lentils (or use flour), chickpea flour, water, baking powder, and salt. Cook in a greased waffle iron until crisp.<br/>
<strong>3. Serve:</strong> Drink tonic first. Top waffles with kimchi and sliced avocado.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Charred Broccoli &amp; Bean Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Charred Broccoli &amp; Bean Bowl" src="/assets/charred_broccoli_bean_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Broccoli 200g</li><li>Cannellini beans 150g</li><li>Romesco sauce</li></ul>
<h4>Preparation</h4>
<p><strong>1. Char:</strong> Toss broccoli florets with oil and roast at high heat (220C) or pan-sear until charred/browned.<br/>
<strong>2. Combine:</strong> Mix warm broccoli with cannellini beans.<br/>
<strong>3. Serve:</strong> Toss generously with Romesco sauce (roasted red pepper &amp; almond sauce).</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast cauliflower. Serve over lentils/kale.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Dandelion Root Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Dandelion Root Latte" src="/assets/dandelion_root_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dandelion root</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p>Heat and whisk.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="week4">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week4', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week4', 'Monday')">Day 22</button><button class="sub-btn" onclick="switchDay('week4', 'Tuesday')">Day 23</button><button class="sub-btn" onclick="switchDay('week4', 'Wednesday')">Day 24</button><button class="sub-btn" onclick="switchDay('week4', 'Thursday')">Day 25</button><button class="sub-btn" onclick="switchDay('week4', 'Friday')">Day 26</button><button class="sub-btn" onclick="switchDay('week4', 'Saturday')">Day 27</button><button class="sub-btn" onclick="switchDay('week4', 'Sunday')">Day 28</button>
</div>
<div class="day-view active" id="week4-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(to right, #f7f9fc, #ffffff);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 4</div>
<h1 style="margin-bottom: 15px;">Hormone Harmony</h1>
<p style="font-size: 1.1rem; color: #555;">Mood stabilizing carbs and magnesium.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>Strategic carbohydrates in the evening boost serotonin production, your brain's natural "off switch." Combined with magnesium-rich ingredients, this week prepares your body for deep, restorative sleepthe only time your adrenals truly repair.</p>
</div></div>
</div>
<div class="day-view" id="week4-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Baked Raspberry Almond Oats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Baked Raspberry Almond Oats" src="/assets/baked_raspberry_almond_oats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 60g</li><li>Almonds</li><li>Raspberries</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine oats, baking powder, cinnamon, and almonds.<br/>
<strong>2. Wet:</strong> Mix mashed banana (if using in base) or maple syrup with milk and melted coconut oil. Fold into dry mix.<br/>
<strong>3. Bake:</strong> Stir in raspberries. Pour into ramekin. Bake at 180C for 20-25 mins.<br/>
<strong>4. Serve:</strong> Drizzle with coconut yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Creamy White Bean Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy White Bean Soup" src="/assets/creamy_white_bean_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>White beans 200g</li><li>Rosemary</li><li>Sourdough side</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut onion, garlic, and celery until soft.<br/>
<strong>2. Simmer:</strong> Add white beans (cannellini) and veggie stock. Add a sprig of rosemary. Simmer 15 mins.<br/>
<strong>3. Blend:</strong> Remove rosemary. Blend soup until creamy (add almond milk if needed).<br/>
<strong>4. Serve:</strong> Serve hot with a slice of sourdough.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Smoky Tempeh Pot Pie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Smoky Tempeh Pot Pie" src="/assets/smoky_tempeh_pot_pie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh</li><li>Root veg</li><li>Cassava crust</li></ul>
<h4>Preparation</h4>
<p><strong>1. Filling:</strong> Saut onion, carrots, celery. Add crumbled tempeh. Stir in flour or starch to coat, then pour in broth to create gravy.<br/>
<strong>2. Crust:</strong> Make a simple cassava flour dough (flour, oil, water) or top with mashed potato.<br/>
<strong>3. Bake:</strong> Place filling in dish, top with crust. Bake at 200C for 25-30 mins until bubbling and golden.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tart Cherry Mocktail</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tart Cherry Mocktail" src="/assets/tart_cherry_mocktail.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tart cherry</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Mix.</p>
</div>
</div>
</div><div class="day-view" id="week4-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Banana Buckwheat Muffins</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Banana Buckwheat Muffins" src="/assets/banana_buckwheat_muffins.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Buckwheat flour 60g</li><li>Banana</li><li>Walnuts</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p><strong>1. Batter:</strong> Mash banana. Whisk with almond milk and a tsp of oil. Stir in buckwheat flour, baking powder, and cinnamon.<br/>
<strong>2. Bake:</strong> Fold in walnuts. Spoon into muffin tin.<br/>
<strong>3. Cook:</strong> Bake at 180C for 20-25 minutes. Let cool slightly.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Cozy Miso Soba Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cozy Miso Soba Bowl" src="/assets/cozy_miso_soba_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Soba noodles</li><li>Miso</li><li>Shiitake</li><li>Tofu 200g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Broth:</strong> Simmer ginger slices, garlic, and shiitake mushrooms in vegetable stock for 10 mins.<br/>
<strong>2. Miso:</strong> Whisk miso with a little hot water separately. Turn off heat and stir into broth (don't boil miso).<br/>
<strong>3. Noodles:</strong> Cook soba noodles, rinse cold. Place in bowl.<br/>
<strong>4. Serve:</strong> Ladle soup over noodles. Top with tofu cubes and scallions.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Gnocchi Sage Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Gnocchi Sage Butter" src="/assets/gnocchi_sage_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Gnocchi</li><li>White beans 150g</li><li>Sage</li><li>Walnuts</li><li>Rocket</li></ul>
<h4>Preparation</h4>
<p><strong>1. Cook Gnocchi:</strong> Boil gnocchi until they float. Drain.<br/>
<strong>2. Sage Sauce:</strong> Heat olive oil or vegan butter in a pan. Fry fresh sage leaves until crisp. Add walnuts.<br/>
<strong>3. Toss:</strong> Add gnocchi to the pan and saut for a few minutes to crisp the outside.<br/>
<strong>4. Serve:</strong> Pile over a bed of fresh rocket.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Valerian</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Valerian" src="/assets/lemon_balm_valerian.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tea</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Berry Chia Jam Toast</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Berry Chia Jam Toast" src="/assets/berry_chia_jam_toast.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seeded bread</li><li>Chia jam</li><li>Tofu scramble side</li></ul>
<h4>Preparation</h4>
<p>Toast bread. Top with jam. Serve with tofu.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lentil Bolognese Squash</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lentil Bolognese Squash" src="/assets/lentil_bolognese_squash.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 200g</li><li>Tomato sauce</li><li>Spaghetti squash</li></ul>
<h4>Preparation</h4>
<p><strong>1. Squash:</strong> Cut squash in half lengthwise, remove seeds. Roast cut-side down at 200C for 40 mins. Scrape out strands.<br/>
<strong>2. Sauce:</strong> Saut onion, carrot, celery. Add lentils, crushed tomatoes, and dried herbs. Simmer 20 mins.<br/>
<strong>3. Serve:</strong> Top squash strands with heavy scoop of bolognese.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Creamy Mushroom Stroganoff</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy Mushroom Stroganoff" src="/assets/creamy_mushroom_stroganoff.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Mushrooms</li><li>Smoked tofu 200g</li><li>Rice noodles</li><li>Cashew cream</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut sliced mushrooms in olive oil until browned. Add garlic and thyme.<br/>
<strong>2. Sauce:</strong> Stir in cashew cream (blended cashews + water), nutritional yeast, and mustard. Simmer to thicken.<br/>
<strong>3. Noodles:</strong> Cook rice noodles. Toss immediately with the sauce.<br/>
<strong>4. Serve:</strong> Top with parsley.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Kava Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Kava Tea" src="/assets/kava_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Kava</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Baked Raspberry Almond Oats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Baked Raspberry Almond Oats" src="/assets/baked_raspberry_almond_oats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 60g</li><li>Almonds</li><li>Raspberries</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine oats, baking powder, cinnamon, and almonds.<br/>
<strong>2. Wet:</strong> Mix mashed banana (if using in base) or maple syrup with milk and melted coconut oil. Fold into dry mix.<br/>
<strong>3. Bake:</strong> Stir in raspberries. Pour into ramekin. Bake at 180C for 20-25 mins.<br/>
<strong>4. Serve:</strong> Drizzle with coconut yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Creamy White Bean Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy White Bean Soup" src="/assets/creamy_white_bean_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>White beans 200g</li><li>Rosemary</li><li>Sourdough side</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut onion, garlic, and celery until soft.<br/>
<strong>2. Simmer:</strong> Add white beans (cannellini) and veggie stock. Add a sprig of rosemary. Simmer 15 mins.<br/>
<strong>3. Blend:</strong> Remove rosemary. Blend soup until creamy (add almond milk if needed).<br/>
<strong>4. Serve:</strong> Serve hot with a slice of sourdough.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Smoky Tempeh Pot Pie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Smoky Tempeh Pot Pie" src="/assets/smoky_tempeh_pot_pie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh</li><li>Root veg</li><li>Cassava crust</li></ul>
<h4>Preparation</h4>
<p><strong>1. Filling:</strong> Saut onion, carrots, celery. Add crumbled tempeh. Stir in flour or starch to coat, then pour in broth to create gravy.<br/>
<strong>2. Crust:</strong> Make a simple cassava flour dough (flour, oil, water) or top with mashed potato.<br/>
<strong>3. Bake:</strong> Place filling in dish, top with crust. Bake at 200C for 25-30 mins until bubbling and golden.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tart Cherry Mocktail</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tart Cherry Mocktail" src="/assets/tart_cherry_mocktail.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tart cherry</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Mix.</p>
</div>
</div>
</div><div class="day-view" id="week4-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Banana Buckwheat Muffins</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Banana Buckwheat Muffins" src="/assets/banana_buckwheat_muffins.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Buckwheat flour 60g</li><li>Banana</li><li>Walnuts</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p><strong>1. Batter:</strong> Mash banana. Whisk with almond milk and a tsp of oil. Stir in buckwheat flour, baking powder, and cinnamon.<br/>
<strong>2. Bake:</strong> Fold in walnuts. Spoon into muffin tin.<br/>
<strong>3. Cook:</strong> Bake at 180C for 20-25 minutes. Let cool slightly.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Cozy Miso Soba Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cozy Miso Soba Bowl" src="/assets/cozy_miso_soba_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Soba noodles</li><li>Miso</li><li>Shiitake</li><li>Tofu 200g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Broth:</strong> Simmer ginger slices, garlic, and shiitake mushrooms in vegetable stock for 10 mins.<br/>
<strong>2. Miso:</strong> Whisk miso with a little hot water separately. Turn off heat and stir into broth (don't boil miso).<br/>
<strong>3. Noodles:</strong> Cook soba noodles, rinse cold. Place in bowl.<br/>
<strong>4. Serve:</strong> Ladle soup over noodles. Top with tofu cubes and scallions.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Gnocchi Sage Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Gnocchi Sage Butter" src="/assets/gnocchi_sage_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Gnocchi</li><li>White beans 150g</li><li>Sage</li><li>Walnuts</li><li>Rocket</li></ul>
<h4>Preparation</h4>
<p><strong>1. Cook Gnocchi:</strong> Boil gnocchi until they float. Drain.<br/>
<strong>2. Sage Sauce:</strong> Heat olive oil or vegan butter in a pan. Fry fresh sage leaves until crisp. Add walnuts.<br/>
<strong>3. Toss:</strong> Add gnocchi to the pan and saut for a few minutes to crisp the outside.<br/>
<strong>4. Serve:</strong> Pile over a bed of fresh rocket.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Valerian</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Valerian" src="/assets/lemon_balm_valerian.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tea</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Berry Chia Jam Toast</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Berry Chia Jam Toast" src="/assets/berry_chia_jam_toast.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seeded bread</li><li>Chia jam</li><li>Tofu scramble side</li></ul>
<h4>Preparation</h4>
<p>Toast bread. Top with jam. Serve with tofu.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lentil Bolognese Squash</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lentil Bolognese Squash" src="/assets/lentil_bolognese_squash.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 200g</li><li>Tomato sauce</li><li>Spaghetti squash</li></ul>
<h4>Preparation</h4>
<p><strong>1. Squash:</strong> Cut squash in half lengthwise, remove seeds. Roast cut-side down at 200C for 40 mins. Scrape out strands.<br/>
<strong>2. Sauce:</strong> Saut onion, carrot, celery. Add lentils, crushed tomatoes, and dried herbs. Simmer 20 mins.<br/>
<strong>3. Serve:</strong> Top squash strands with heavy scoop of bolognese.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Creamy Mushroom Stroganoff</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy Mushroom Stroganoff" src="/assets/creamy_mushroom_stroganoff.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Mushrooms</li><li>Smoked tofu 200g</li><li>Rice noodles</li><li>Cashew cream</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut sliced mushrooms in olive oil until browned. Add garlic and thyme.<br/>
<strong>2. Sauce:</strong> Stir in cashew cream (blended cashews + water), nutritional yeast, and mustard. Simmer to thicken.<br/>
<strong>3. Noodles:</strong> Cook rice noodles. Toss immediately with the sauce.<br/>
<strong>4. Serve:</strong> Top with parsley.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Kava Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Kava Tea" src="/assets/kava_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Kava</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Baked Raspberry Almond Oats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Baked Raspberry Almond Oats" src="/assets/baked_raspberry_almond_oats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 60g</li><li>Almonds</li><li>Raspberries</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine oats, baking powder, cinnamon, and almonds.<br/>
<strong>2. Wet:</strong> Mix mashed banana (if using in base) or maple syrup with milk and melted coconut oil. Fold into dry mix.<br/>
<strong>3. Bake:</strong> Stir in raspberries. Pour into ramekin. Bake at 180C for 20-25 mins.<br/>
<strong>4. Serve:</strong> Drizzle with coconut yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Creamy White Bean Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy White Bean Soup" src="/assets/creamy_white_bean_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>White beans 200g</li><li>Rosemary</li><li>Sourdough side</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut onion, garlic, and celery until soft.<br/>
<strong>2. Simmer:</strong> Add white beans (cannellini) and veggie stock. Add a sprig of rosemary. Simmer 15 mins.<br/>
<strong>3. Blend:</strong> Remove rosemary. Blend soup until creamy (add almond milk if needed).<br/>
<strong>4. Serve:</strong> Serve hot with a slice of sourdough.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Smoky Tempeh Pot Pie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Smoky Tempeh Pot Pie" src="/assets/smoky_tempeh_pot_pie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh</li><li>Root veg</li><li>Cassava crust</li></ul>
<h4>Preparation</h4>
<p><strong>1. Filling:</strong> Saut onion, carrots, celery. Add crumbled tempeh. Stir in flour or starch to coat, then pour in broth to create gravy.<br/>
<strong>2. Crust:</strong> Make a simple cassava flour dough (flour, oil, water) or top with mashed potato.<br/>
<strong>3. Bake:</strong> Place filling in dish, top with crust. Bake at 200C for 25-30 mins until bubbling and golden.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tart Cherry Mocktail</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tart Cherry Mocktail" src="/assets/tart_cherry_mocktail.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tart cherry</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Mix.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="supplements">
    <h1>Supplement Guide</h1>
    <div style="background: #fff3e0; padding: 20px; border-radius: 12px; border: 1px solid #ffe0b2; margin-bottom: 30px;">
        <h4 style="color: #e65100; margin-bottom: 5px; border: none;">Medical Disclaimer</h4>
        <p style="font-size: 0.9rem; margin: 0; color: #666;">Supplements should be taken under the guidance of a healthcare professional. Dosages listed are general guidelines.</p>
    </div>

    <h3 style="color:var(--secondary); margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">Cortisol Calm (Your Essentials)</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-bottom: 50px;">
        <!-- Ashwagandha -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Ashwagandha" src="/assets/ashwagandha_spp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Stress</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Ashwagandha</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">200mg evening. Lowers cortisol and helps manage stress.</p>
            </div>
        </div>
        <!-- Magnesium -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Magnesium Glycinate" src="/assets/magnesium_glycinate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Sleep</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Magnesium Glycinate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">300-400mg nightly. Aids sleep, reduces cramps and anxiety.</p>
            </div>
        </div>
        <!-- Omega 3 -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Omega 3 DHA/EPA" src="/assets/omega_3_algae_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Inflammation</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Omega 3 DHA/EPA</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">300-600mg DHA + 150mg EPA daily. Supports brain health &amp; reduces hot flashes.</p>
            </div>
        </div>
        <!-- B12 -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Vitamin B12" src="/assets/vitamin_b12_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Essentials</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Vitamin B12</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">1,000 mcg 3x weekly. Supports energy levels and nerve function.</p>
            </div>
        </div>
    </div>


    <h3 style="color:var(--text-muted); margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">General Vitality (Optional)</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px;">
        <!-- Iron -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Iron Bisglycinate" src="/assets/iron_bisglycinate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Deficiency Only</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Iron Bisglycinate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">18-25mg every other day (ONLY if deficient). Pair with Vit C for absorption.</p>
            </div>
        </div>
        <!-- Calcium -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Calcium Citrate" src="/assets/calcium_citrate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Bone Health</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Calcium Citrate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">500mg Ca + 2000IU D3 + 90mcg K2. Critical for bone density protection.</p>
            </div>
        </div>
        <!-- Zinc -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Zinc" src="/assets/zinc_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Immunity</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Zinc</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">15mg alternating days. Supports thyroid function. Take with food.</p>
            </div>
        </div>
        <!-- Selenium -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Selenium" src="/assets/selenium_brazil_nut.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Thyroid</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Selenium</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">100mcg (or 1 Brazil nut) alternating days. Key for thyroid conversion.</p>
            </div>
        </div>
        <!-- Iodine -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Iodine (Kelp)" src="/assets/iodine_kelp_granules.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Thyroid</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Iodine (Kelp)</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">150mcg kelp granules (ONLY if deficient). Supports thyroid hormones.</p>
            </div>
        </div>
        <!-- Maca -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Maca" src="/assets/maca_powder.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Hormone Balance</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Maca</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">1 tsp morning (Gelatinized). Adaptogen for mood, energy, and libido.</p>
            </div>
        </div>
        <!-- Flax -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Ground Flax" src="/assets/ground_flax_seeds.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Daily Essential</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Ground Flax</h4>
                <p id="flax-description" style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">1-2 tbsp daily. Rich in lignans to help balance estrogen.</p>
            </div>
        </div>
        <!-- Creatine -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Creatine Monohydrate" src="/assets/creatine_monohydrate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Muscle & Brain</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Creatine Monohydrate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">3-5g daily. Vital for vegans: supports muscle retention, bone density, and cognitive function.</p>
            </div>
        </div>
    </div>
</div>
<div class="view-section" id="swaps">
<h1 style="text-align: center; margin-bottom: 20px;">Quick Swaps</h1>
<div class="card">
<div class="card-body active" style="max-height:2000px; padding:0; opacity:1; overflow:hidden;">
<div style="padding: 30px 30px 20px 30px; background: linear-gradient(to bottom, #fdfbf7, #ffffff); border-bottom: 1px solid rgba(0,0,0,0.03);">
<p style="margin: 0; text-align: center; color: var(--text-muted); font-size: 0.95rem;">Flexible options for allergies, dietary preferences, or pantry availability.</p>
</div>
<div style="overflow-x: auto;">
<table style="margin: 0; border: none; border-radius: 0;">
<thead>
<tr style="background: var(--primary);">
<th style="padding: 18px 30px; width: 40%; color: white; font-weight: 500; letter-spacing: 0.5px;">Original Item</th>
<th style="padding: 18px 30px; width: 60%; color: white; font-weight: 500; letter-spacing: 0.5px;">Alternative Options</th>
</tr>
</thead>
<tbody>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Almond Yogurt</td>
<td style="padding: 15px 30px;">Coconut or Oat yogurt</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Ashwagandha</td>
<td style="padding: 15px 30px;">Maca powder or simply skip</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Cassava Flour</td>
<td style="padding: 15px 30px;">Chickpea or Rice flour</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Cauliflower <span style="font-size:0.8em; color:var(--text-muted); font-weight:400;">(Low FODMAP)</span></td>
<td style="padding: 15px 30px;">Zucchini</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Chickpeas <span style="font-size:0.8em; color:var(--text-muted); font-weight:400;">(Low FODMAP)</span></td>
<td style="padding: 15px 30px;">Firm tofu</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Coconut Aminos</td>
<td style="padding: 15px 30px;">Tamari or Soy sauce</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Cooked Lunches</td>
<td style="padding: 15px 30px;">Raw wraps or salads</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Dates</td>
<td style="padding: 15px 30px;">Ripe bananas</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Farro / Barley</td>
<td style="padding: 15px 30px;">Quinoa or Millet</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Garlic</td>
<td style="padding: 15px 30px;">Infused oil (adds flavor without fiber)</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Hemp Hearts</td>
<td style="padding: 15px 30px;">Sunflower, Pumpkin, or Chia seeds</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Jackfruit</td>
<td style="padding: 15px 30px;">Hearts of Palm or Tofu</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Kelp Noodles</td>
<td style="padding: 15px 30px;">Soba, Rice, or Zucchini noodles</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Lupini Beans</td>
<td style="padding: 15px 30px;">Chickpeas or Edamame</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Miso</td>
<td style="padding: 15px 30px;">Vegetable stock cube or paste</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Monk Fruit</td>
<td style="padding: 15px 30px;">Stevia, Maple syrup, or Coconut sugar</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Nutritional Yeast</td>
<td style="padding: 15px 30px;">A small pinch of Miso</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Tempeh</td>
<td style="padding: 15px 30px;">Tofu, Seitan, or Chickpeas</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Tofu</td>
<td style="padding: 15px 30px;">Chickpea tofu, Lupini beans, or Seitan</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="view-section" id="shopping">
<h1>Shopping Lists</h1>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 1 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Asparagus</li><li onclick="this.classList.toggle('checked')">Avocado</li><li onclick="this.classList.toggle('checked')">Baby Greens</li><li onclick="this.classList.toggle('checked')">Basil</li><li onclick="this.classList.toggle('checked')">Bean Sprouts</li><li onclick="this.classList.toggle('checked')">Bok Choy</li><li onclick="this.classList.toggle('checked')">Broccoli</li><li onclick="this.classList.toggle('checked')">Carrots</li><li onclick="this.classList.toggle('checked')">Cauliflower</li><li onclick="this.classList.toggle('checked')">Collard Greens</li><li onclick="this.classList.toggle('checked')">Cucumber</li><li onclick="this.classList.toggle('checked')">Delicata Squash</li><li onclick="this.classList.toggle('checked')">Dill</li><li onclick="this.classList.toggle('checked')">Fennel</li><li onclick="this.classList.toggle('checked')">Garlic</li><li onclick="this.classList.toggle('checked')">Ginger</li><li onclick="this.classList.toggle('checked')">Lemons</li><li onclick="this.classList.toggle('checked')">Limes</li><li onclick="this.classList.toggle('checked')">Mint</li><li onclick="this.classList.toggle('checked')">Mixed Berries</li><li onclick="this.classList.toggle('checked')">Mung Sprouts</li><li onclick="this.classList.toggle('checked')">Onion</li><li onclick="this.classList.toggle('checked')">Parsley</li><li onclick="this.classList.toggle('checked')">Pear</li><li onclick="this.classList.toggle('checked')">Scallions</li><li onclick="this.classList.toggle('checked')">Shiitake Mushrooms</li><li onclick="this.classList.toggle('checked')">Spinach</li><li onclick="this.classList.toggle('checked')">Zucchini</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Almond Butter</li><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Aloe Vera Juice</li><li onclick="this.classList.toggle('checked')">Artichoke Hearts</li><li onclick="this.classList.toggle('checked')">Brazil Nuts</li><li onclick="this.classList.toggle('checked')">Chamomile Tea</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Chickpeas</li><li onclick="this.classList.toggle('checked')">Cinnamon</li><li onclick="this.classList.toggle('checked')">Coconut Milk</li><li onclick="this.classList.toggle('checked')">Coconut Oil</li><li onclick="this.classList.toggle('checked')">Cranberries</li><li onclick="this.classList.toggle('checked')">Curry Paste</li><li onclick="this.classList.toggle('checked')">Edamame</li><li onclick="this.classList.toggle('checked')">Flaxseed</li><li onclick="this.classList.toggle('checked')">Lemon Balm Tea</li><li onclick="this.classList.toggle('checked')">Maca</li><li onclick="this.classList.toggle('checked')">Magnesium</li><li onclick="this.classList.toggle('checked')">Maple Syrup</li><li onclick="this.classList.toggle('checked')">Miso</li><li onclick="this.classList.toggle('checked')">Nori</li><li onclick="this.classList.toggle('checked')">Pea Protein</li><li onclick="this.classList.toggle('checked')">Pesto</li><li onclick="this.classList.toggle('checked')">Pumpkin Seeds</li><li onclick="this.classList.toggle('checked')">Quinoa</li><li onclick="this.classList.toggle('checked')">Red Lentils</li><li onclick="this.classList.toggle('checked')">Sesame Oil</li><li onclick="this.classList.toggle('checked')">Star Anise</li><li onclick="this.classList.toggle('checked')">Tamari</li><li onclick="this.classList.toggle('checked')">Tempeh</li><li onclick="this.classList.toggle('checked')">Tofu (Firm)</li><li onclick="this.classList.toggle('checked')">Triphala</li><li onclick="this.classList.toggle('checked')">Vegetable Broth</li><li onclick="this.classList.toggle('checked')">Wakame</li><li onclick="this.classList.toggle('checked')">White Beans</li></ul></div></div></div></div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 2 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Apples</li><li onclick="this.classList.toggle('checked')">Asparagus</li><li onclick="this.classList.toggle('checked')">Avocado</li><li onclick="this.classList.toggle('checked')">Blueberries</li><li onclick="this.classList.toggle('checked')">Brussels Sprouts</li><li onclick="this.classList.toggle('checked')">Cauliflower</li><li onclick="this.classList.toggle('checked')">Cherries</li><li onclick="this.classList.toggle('checked')">Cucumber</li><li onclick="this.classList.toggle('checked')">Eggplant</li><li onclick="this.classList.toggle('checked')">Fennel</li><li onclick="this.classList.toggle('checked')">Green Beans</li><li onclick="this.classList.toggle('checked')">Limes</li><li onclick="this.classList.toggle('checked')">Onion</li><li onclick="this.classList.toggle('checked')">Orange</li><li onclick="this.classList.toggle('checked')">Pears</li><li onclick="this.classList.toggle('checked')">Pomegranate</li><li onclick="this.classList.toggle('checked')">Raspberries</li><li onclick="this.classList.toggle('checked')">Spinach</li><li onclick="this.classList.toggle('checked')">Sweet Potato</li><li onclick="this.classList.toggle('checked')">Tomatoes</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Black Rice</li><li onclick="this.classList.toggle('checked')">Buckwheat</li><li onclick="this.classList.toggle('checked')">Cacao Powder</li><li onclick="this.classList.toggle('checked')">Cardamom</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Chili Powder</li><li onclick="this.classList.toggle('checked')">Cinnamon</li><li onclick="this.classList.toggle('checked')">Edamame</li><li onclick="this.classList.toggle('checked')">Farro</li><li onclick="this.classList.toggle('checked')">Hemp Yogurt</li><li onclick="this.classList.toggle('checked')">Kidney Beans</li><li onclick="this.classList.toggle('checked')">Lavender Tea</li><li onclick="this.classList.toggle('checked')">Lentils</li><li onclick="this.classList.toggle('checked')">Maca</li><li onclick="this.classList.toggle('checked')">Monk Fruit</li><li onclick="this.classList.toggle('checked')">Nori</li><li onclick="this.classList.toggle('checked')">Oats</li><li onclick="this.classList.toggle('checked')">Pea Protein</li><li onclick="this.classList.toggle('checked')">Pepitas</li><li onclick="this.classList.toggle('checked')">Pesto</li><li onclick="this.classList.toggle('checked')">Reishi</li><li onclick="this.classList.toggle('checked')">Sage</li><li onclick="this.classList.toggle('checked')">Seitan</li><li onclick="this.classList.toggle('checked')">Sesame Oil</li><li onclick="this.classList.toggle('checked')">Smoked Tofu</li><li onclick="this.classList.toggle('checked')">Spirulina</li><li onclick="this.classList.toggle('checked')">Tahini</li><li onclick="this.classList.toggle('checked')">Tamari</li><li onclick="this.classList.toggle('checked')">Tempeh</li><li onclick="this.classList.toggle('checked')">Tulsi Tea</li><li onclick="this.classList.toggle('checked')">Walnuts</li></ul></div></div></div></div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 3 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Apple</li><li onclick="this.classList.toggle('checked')">Apricots</li><li onclick="this.classList.toggle('checked')">Avocado</li><li onclick="this.classList.toggle('checked')">Banana</li><li onclick="this.classList.toggle('checked')">Broccoli</li><li onclick="this.classList.toggle('checked')">Carrot</li><li onclick="this.classList.toggle('checked')">Cauliflower</li><li onclick="this.classList.toggle('checked')">Cucumber</li><li onclick="this.classList.toggle('checked')">Dandelion Root</li><li onclick="this.classList.toggle('checked')">Ginger</li><li onclick="this.classList.toggle('checked')">Grapefruit</li><li onclick="this.classList.toggle('checked')">Holy Basil</li><li onclick="this.classList.toggle('checked')">Kale</li><li onclick="this.classList.toggle('checked')">Mint</li><li onclick="this.classList.toggle('checked')">Rosemary</li><li onclick="this.classList.toggle('checked')">Sweet Potato</li><li onclick="this.classList.toggle('checked')">Thai Basil</li><li onclick="this.classList.toggle('checked')">Tomato</li><li onclick="this.classList.toggle('checked')">Zucchini</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">ACV</li><li onclick="this.classList.toggle('checked')">Almond Butter</li><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Beluga Lentils</li><li onclick="this.classList.toggle('checked')">Cacao Powder</li><li onclick="this.classList.toggle('checked')">Cannellini Beans</li><li onclick="this.classList.toggle('checked')">Cashews (Butter & Whole)</li><li onclick="this.classList.toggle('checked')">Cayenne</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Chickpea Flour</li><li onclick="this.classList.toggle('checked')">Chickpeas</li><li onclick="this.classList.toggle('checked')">Chili Powder</li><li onclick="this.classList.toggle('checked')">Coconut Cream</li><li onclick="this.classList.toggle('checked')">Coconut Milk</li><li onclick="this.classList.toggle('checked')">Coconut Oil</li><li onclick="this.classList.toggle('checked')">Coconut Yogurt</li><li onclick="this.classList.toggle('checked')">Cold Brew Coffee</li><li onclick="this.classList.toggle('checked')">Dandelion Root Powder</li><li onclick="this.classList.toggle('checked')">Fennel Seeds/Tea</li><li onclick="this.classList.toggle('checked')">Kimchi</li><li onclick="this.classList.toggle('checked')">Maple Syrup</li><li onclick="this.classList.toggle('checked')">Millet</li><li onclick="this.classList.toggle('checked')">Miso</li><li onclick="this.classList.toggle('checked')">Pea Protein</li><li onclick="this.classList.toggle('checked')">Pumpkin Seeds</li><li onclick="this.classList.toggle('checked')">Quinoa</li><li onclick="this.classList.toggle('checked')">Romesco Sauce</li><li onclick="this.classList.toggle('checked')">Tahini</li><li onclick="this.classList.toggle('checked')">Tofu</li><li onclick="this.classList.toggle('checked')">Walnuts</li></ul></div></div></div></div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 4 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Banana</li><li onclick="this.classList.toggle('checked')">Carrots</li><li onclick="this.classList.toggle('checked')">Lemon Balm</li><li onclick="this.classList.toggle('checked')">Mushrooms (Shiitake/Button)</li><li onclick="this.classList.toggle('checked')">Orange</li><li onclick="this.classList.toggle('checked')">Raspberries</li><li onclick="this.classList.toggle('checked')">Rocket</li><li onclick="this.classList.toggle('checked')">Root Vegetables</li><li onclick="this.classList.toggle('checked')">Rosemary</li><li onclick="this.classList.toggle('checked')">Sage</li><li onclick="this.classList.toggle('checked')">Squash (Spaghetti)</li><li onclick="this.classList.toggle('checked')">Tart Cherry Juice</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Almonds</li><li onclick="this.classList.toggle('checked')">Buckwheat Flour</li><li onclick="this.classList.toggle('checked')">Cacao Powder</li><li onclick="this.classList.toggle('checked')">Cashews</li><li onclick="this.classList.toggle('checked')">Cassava Flour</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Coconut Flour</li><li onclick="this.classList.toggle('checked')">Coconut Yogurt</li><li onclick="this.classList.toggle('checked')">Dark Chocolate</li><li onclick="this.classList.toggle('checked')">Dates</li><li onclick="this.classList.toggle('checked')">Gnocchi</li><li onclick="this.classList.toggle('checked')">Kava Tea</li><li onclick="this.classList.toggle('checked')">Lentils</li><li onclick="this.classList.toggle('checked')">Magnesium</li><li onclick="this.classList.toggle('checked')">Miso</li><li onclick="this.classList.toggle('checked')">Oats</li><li onclick="this.classList.toggle('checked')">Pepitas</li><li onclick="this.classList.toggle('checked')">Rice Noodles</li><li onclick="this.classList.toggle('checked')">Seeded Bread</li><li onclick="this.classList.toggle('checked')">Soba Noodles</li><li onclick="this.classList.toggle('checked')">Sourdough Bread</li><li onclick="this.classList.toggle('checked')">Tart Cherry</li><li onclick="this.classList.toggle('checked')">Tempeh</li><li onclick="this.classList.toggle('checked')">Tofu</li><li onclick="this.classList.toggle('checked')">Tomato Sauce</li><li onclick="this.classList.toggle('checked')">Valerian Tea</li><li onclick="this.classList.toggle('checked')">Walnuts</li><li onclick="this.classList.toggle('checked')">White Beans</li></ul></div></div></div></div>
</div>
<!-- Sleep Protocol Section -->
<div class="view-section" id="sleep">
    <div class="sleep-hero">
        <h1 style="color:white; margin-bottom:10px;">The Adrenal Sleep Architecture</h1>
        <p style="font-size:1.15rem; opacity:0.9; max-width:600px; margin:0 auto;">Use this specific sequence to lower your core body temperature and signal safety to your nervous system.</p>
        
        <div class="glass-effect">
            <span style="font-size:2rem; display:block; margin-bottom:10px;">???</span>
            <strong>Why Temperature Matters:</strong> Deep sleep only occurs when your core temperature drops by 2-3F. Cortisol keeps you hot. This routine forces the drop.
        </div>
    </div>

    <!-- Wind Down Routine -->
    <div class="section-title">
        <div class="section-number">1</div>
        <h2>The Wind Down Routine</h2>
    </div>

    <div style="margin-bottom: 60px;">
        <div class="timeline-item">
            <div class="timeline-time">12:00 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">The Caffeine Hard Stop</span>
                Switch to herbal tea or water. Caffeine has a quarter-life of 12 hours. Drinking it at 2PM means 25% is still active in your brain at 2AM, blocking deep sleep.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">7:00 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">Kitchen Closed</span>
                Finish your last meal 3 hours before bed. Digestion is a thermogenic (heat-producing) process. We need your body cool to initiate sleep.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">8:30 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">The Blue Light Block</span>
                Laptops closed. Phone on 'Night Shift' or 'Eye Comfort' mode. Blue light stimulates the same cortisol receptors as sunlight.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">9:00 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">Thermal Dump Shower</span>
                Take a <strong>warm</strong> shower or bath. When you step out into cool air, your body heat rapidly dissipates. This steep drop mimics the biological signal for sleep onset.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">9:45 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">The Brain Dump</span>
                Write down your top 3 'Must Do' items for tomorrow on paper. Get them out of your head so your Reticular Activating System (brain's alarm) can stand down.
            </div>
        </div>
    </div>

    <!-- Adrenal Mocktail Feature -->
    <div class="section-title">
        <div class="section-number">2</div>
        <h2>Your Sleep Cocktail</h2>
    </div>

    <div class="recipe-card">
        <div style="font-size: 5rem; line-height: 1;">??</div>
        <div style="flex-grow:1;">
            <h3 style="color:var(--primary); margin-top:0;">The 'Adrenal Mocktail'</h3>
            <p>Drink this 1 hour before bed instead of wine. It provides the building blocks for melatonin without the blood sugar crash.</p>
            <ul style="margin-bottom:0;">
                <li><strong>1/2 cup Tart Cherry Juice</strong> (Natural source of Melatonin)</li>
                <li><strong>1 scoop Magnesium Glycinate</strong> (The relaxation mineral)</li>
                <li><strong>Pinch of Sea Salt</strong> (Lowers adrenaline)</li>
                <li><strong>Sparkling Water</strong></li>
            </ul>
        </div>
    </div>

    <!-- 3AM Protocol -->
     <div class="section-title">
        <div class="section-number">3</div>
        <h2>The 3 A.M. Emergency Protocol</h2>
    </div>
    
    <div class="rescue-card">
        <h4 style="color:#c53030; margin-top:0; display:flex; align-items:center; gap:10px;">? Woke up wired?</h4>
        <p>This is a liver glycogen crash causing an adrenaline spike. <strong>Do NOT look at the clock.</strong> Looking at the time engages your logical brain and wakefulness.</p>
        <p style="font-weight:600; margin-bottom:5px;">Try this:</p>
        <ol style="margin-top:0; padding-left:20px;">
            <li style="margin-bottom:5px;"><strong>Physiological Sigh:</strong> Two sharp inhales through nose, one long exhale through mouth. Repeat 3 times.</li>
            <li style="margin-bottom:5px;"><strong>Cool the Palm:</strong> Stick a foot or hand out from the covers to dump heat.</li>
            <li><strong>Last Resort:</strong> If awake >20 mins, get up and do a boring task (fold laundry) in dim light until tired.</li>
        </ol>
    </div>

    <!-- Bedroom Setup Checklist -->
    <div class="section-title" style="margin-top:60px;">
        <div class="section-number">4</div>
        <h2>Bedroom Sanctuary Checklist</h2>
    </div>

    <div class="checklist-grid">
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>Temperature Drop</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Set thermostat to 65-68F (18-20C). Cool rooms promote deeper REM cycles.</span>
            </div>
        </div>
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>Total Blackout</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Cover all LEDs (even the TV standby light). Use blackout curtains or a sleep mask.</span>
            </div>
        </div>
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>Phone Quarantine</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Charge your phone in the bathroom or hallway, not on the nightstand.</span>
            </div>
        </div>
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>White Noise</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Use a fan or sound machine to mask sudden noises that trigger 'light sleeper' wakeups.</span>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 50px; text-align: center;">
         <p style="color:var(--text-muted);">Prefer a printed copy?</p>
         <a href="adrenal_sleep_guide.html" target="_blank" style="text-decoration:none;"><button style="background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-size:1rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='var(--primary)'">Download Printable Guide</button></a>
    </div>

        </div> <!-- End meals-content-container -->
    </div> <!-- End view-meals -->

    <!-- Placeholder for moved sections (Movement, Support) - they will be moved here by JS -->
    <!-- Duplicate movement view removed -->

    <!-- INSTALL APP BANNER (Hidden by default) -->
    <!-- INSTALL APP BANNER MOVED TO FOOTER FOR FIXED POSITIONING -->


    <!-- SUPPORT VIEW REMOVED - Coach Chat moved to modal -->

    <!-- ACTIVE WORKOUT PLAYER (Hidden by default) -->
    <div id="view-active-workout-stub" class="app-view" style="display:none; background: #fff; padding-bottom: 0;">
        <!-- Workout Header -->
        <div style="position: sticky; top:0; z-index:100; background:white; border-bottom:1px solid #eee; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <div onclick="quitWorkout()" style="cursor:pointer; color:var(--text-muted);">✕</div>
            <div style="font-weight:700;" id="stub-workout-player-title">Workout</div>
            <div style="font-family:monospace; font-size:1.1rem; color:var(--primary);" id="stub-workout-timer">00:00</div>
        </div>

        <!-- Video Player Stub -->
        <div style="width:100%; height:220px; background:black; display:flex; align-items:center; justify-content:center; position:relative;">
            <div id="stub-workout-video-placeholder" style="color:white; text-align:center;">
                <div style="font-size:3rem;">▶</div>
                <div>Play Video Tutorial</div>
            </div>
            <!-- In real app, proper video tag here -->
        </div>

        <!-- Exercise List -->
        <div id="stub-workout-exercises-list" style="padding: 20px; padding-bottom: 100px;">
            <!-- Dynamic Content Injected Here -->
        </div>

        <!-- Finish Bar -->
        <div style="position: fixed; bottom:0; left:0; width:100%; padding: 20px; background:white; border-top:1px solid #eee; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 50;">
            <button onclick="finishWorkout()" class="btn-primary" style="width:100%; border-radius:30px; touch-action: manipulation; user-select: none; min-height: 56px; cursor: pointer;">FINISH WORKOUT</button>
        </div>
    </div>

    <!-- WORKOUT SUCCESS SCREEN -->
    <div id="view-workout-success-stub" class="app-view" style="display:none; background: var(--primary); color:white; text-align:center; flex-direction:column; align-items:center; justify-content:center; height:100%;">
        <div style="font-size: 5rem; margin-bottom: 20px;">🎉</div>
        <h1 style="font-family: 'Playfair Display'; font-size: 3rem; margin-bottom: 10px;">High Five!</h1>
        <p style="font-size: 1.2rem; opacity: 0.9;">Workout Complete</p>
        <div style="margin-top: 40px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 16px;">
            <div style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Duration</div>
            <div style="font-size: 2rem; font-weight: 700;" id="stub-success-duration">24:00</div>
        </div>
        <button onclick="closeSuccessScreen()" style="margin-top: 50px; background: white; color: var(--primary); border:none; padding: 15px 40px; border-radius: 30px; font-weight: 700; font-size: 1rem; cursor: pointer;">DONE</button>
    </div>

    <style>
        /* Workout Logger Styles */
        .exercise-logger-card {
            border: 1px solid #eee;
            border-radius: 12px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        .exercise-header {
            background: #f8fafc;
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .set-row {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f1f5f9;
            gap: 10px;
        }
        .set-col-label {
            font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; text-align: center;
        }
        .set-input {
            background: #f1f5f9;
            border: 1px solid transparent;
            border-radius: 6px;
            text-align: center;
            padding: 8px;
            width: 100%;
            font-weight: 600;
            color: var(--text-main);
        }
        .set-input:focus { background: white; border-color: var(--primary); outline: none; }
        .set-check {
            width: 35px; height: 35px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: transparent;
            transition: all 0.2s;
        }
        .set-check.completed {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Drop Set Styles */
        .drop-set-toggle {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.6rem;
            font-weight: 800;
            color: #94a3b8;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .drop-set-toggle:hover {
            border-color: #f97316;
            color: #f97316;
        }
        .drop-set-toggle.active {
            background: #f97316;
            border-color: #f97316;
            color: white;
        }
        .drop-set-container {
            display: none;
            padding: 8px 15px 8px 50px;
            background: #fef3e2;
            border-top: 1px dashed #f97316;
        }
        .drop-set-container.visible {
            display: block;
        }
        .drop-set-row {
            display: grid;
            grid-template-columns: 24px 1fr 1fr 24px;
            gap: 8px;
            align-items: center;
            padding: 6px 0;
        }
        .drop-set-row input {
            width: 100%;
            border: none;
            background: white;
            border-radius: 6px;
            padding: 8px 5px;
            text-align: center;
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.85rem;
        }
        .drop-indicator {
            font-size: 0.7rem;
            color: #f97316;
            font-weight: 800;
            text-align: center;
        }
        .drop-add-btn, .drop-remove-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
        }
        .drop-add-btn {
            background: #dcfce7;
            color: #16a34a;
        }
        .drop-remove-btn {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Day Completion Modal */
        .completion-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.5s ease-out;
        }
        .completion-modal {
            background: white;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: popUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 4px solid var(--secondary);
        }
        @keyframes popUp {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .confetti-piece {
            position: absolute;
            width: 10px; height: 10px;
            background: #ffd700;
            top: -10px;
            z-index: 10000;
        }
    </style>

    <!-- DAY COMPLETION MODAL -->
    <div id="day-completion-modal" class="completion-modal-overlay">
        <div class="completion-modal">
            <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce 1s infinite;">??</div>
            <h2 style="color: var(--primary); font-size: 1.8rem; margin: 0 0 10px 0;">Day Complete!</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;" id="completion-text">You have successfully finished Day 1.</p>
            
            <div style="background: #f0fdf4; padding: 15px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #bbf7d0;">
                <div style="font-size: 0.9rem; color: #166534; font-weight: 600;">Cortisol Level: Stabilizing ??</div>
            </div>

            <button onclick="closeCompletionModal()" style="background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-weight: 700; font-size: 1.1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(4, 106, 56, 0.3);">
                CONTINUE
            </button>
        </div>
    </div>


<!-- MOVEMENT VIEW (Shared Main Tab) -->
<div id="movement-tab" class="app-view" style="display:none;">
    <div class="app-header">
        <div class="app-logo">Movement Studio</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="coin-header-widget" onclick="openCoinShop()">
                <span class="coin-emoji">🪙</span>
                <span class="coin-amount coin-balance-sync">0</span>
                <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
            </div>
            <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
        </div>
    </div>
    
    <div style="padding: 25px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
            <div>
                <h1 style="color:var(--primary); margin:0; font-size:2rem; letter-spacing:-1px;">Movement</h1>
            </div>
            <!-- Button Removed -->
        </div>

        <!-- Weekly Workout Trend Card (Movement Tab) -->
        <div id="movement-workout-trend-card" style="display: none; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 16px; padding: 18px 20px; color: white; position: relative; overflow: hidden; margin-bottom: 20px;">
            <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
            <button onclick="dismissMovementTrendCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0; z-index: 2;">&#x2715;</button>
            <div style="position: relative; z-index: 1;">
                <div style="font-weight: 700; font-size: 1rem; margin-bottom: 10px;">Your Workout Trend</div>
                <div id="movement-trend-stats" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 10px; text-align: center;">
                        <div id="movement-trend-week-count" style="font-size: 1.4rem; font-weight: 700;">0</div>
                        <div style="font-size: 0.7rem; opacity: 0.85;">This Week</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 10px; text-align: center;">
                        <div id="movement-trend-total-count" style="font-size: 1.4rem; font-weight: 700;">0</div>
                        <div style="font-size: 0.7rem; opacity: 0.85;">All Time</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 10px; text-align: center;">
                        <div id="movement-trend-streak" style="font-size: 1.4rem; font-weight: 700;">0</div>
                        <div style="font-size: 0.7rem; opacity: 0.85;">Week Streak</div>
                    </div>
                </div>
                <div id="movement-trend-insight" style="font-size: 0.82rem; opacity: 0.9; line-height: 1.4;"></div>
            </div>
        </div>

        <!-- Dynamic Grid Container -->
        <div id="movement-grid-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>

        <!-- Weekly Trends Button -->
        <button class="weekly-trends-btn" onclick="openMovementWeeklyTrendsPage()" style="margin-top: 25px;">
            <span class="weekly-trends-btn-left">
                <span style="font-size: 1.3rem;">📊</span>
                <span>Weekly Trends</span>
            </span>
            <span class="weekly-trends-btn-arrow">&#x203A;</span>
        </button>

        <!-- Workout Feedback Insights Card -->
        <div id="workout-insights-card" style="display:none; margin-top:15px; background:white; border-radius:16px; padding:18px 20px; border:1px solid #e2e8f0; box-shadow:0 2px 8px rgba(0,0,0,0.04);">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;">
                <div style="font-weight:700; font-size:1rem; color:var(--text-main); display:flex; align-items:center; gap:8px;">
                    <span style="font-size:1.2rem;">💬</span> Body Feedback
                </div>
                <span id="insights-period" style="font-size:0.75rem; color:var(--text-muted);">Last 30 days</span>
            </div>

            <!-- Average gauges -->
            <div id="insights-gauges" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:14px;">
                <div style="text-align:center; padding:10px 6px; background:#f8fafc; border-radius:10px;">
                    <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:4px;">Feeling</div>
                    <div id="insight-avg-feeling" style="font-size:1.4rem; font-weight:700; color:var(--primary);">-</div>
                    <div id="insight-avg-feeling-emoji" style="font-size:1rem;">-</div>
                </div>
                <div style="text-align:center; padding:10px 6px; background:#f8fafc; border-radius:10px;">
                    <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:4px;">Difficulty</div>
                    <div id="insight-avg-difficulty" style="font-size:1.4rem; font-weight:700; color:#6366f1;">-</div>
                    <div id="insight-avg-difficulty-emoji" style="font-size:1rem;">-</div>
                </div>
                <div style="text-align:center; padding:10px 6px; background:#f8fafc; border-radius:10px;">
                    <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:4px;">Energy</div>
                    <div id="insight-avg-energy" style="font-size:1.4rem; font-weight:700; color:#f59e0b;">-</div>
                    <div id="insight-avg-energy-emoji" style="font-size:1rem;">-</div>
                </div>
            </div>

            <!-- Intensity preference bar -->
            <div id="insights-intensity-bar" style="margin-bottom:10px;">
                <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:6px; font-weight:600;">Next time intensity preference</div>
                <div style="display:flex; height:8px; border-radius:4px; overflow:hidden; background:#f1f5f9;">
                    <div id="insight-bar-lighter" style="background:#60a5fa; height:100%; transition:width 0.3s;" title="Lighter"></div>
                    <div id="insight-bar-perfect" style="background:#22c55e; height:100%; transition:width 0.3s;" title="Same"></div>
                    <div id="insight-bar-harder" style="background:#f97316; height:100%; transition:width 0.3s;" title="Harder"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.65rem; color:var(--text-muted); margin-top:3px;">
                    <span id="insight-lighter-pct">Lighter</span>
                    <span id="insight-perfect-pct">Same</span>
                    <span id="insight-harder-pct">Harder</span>
                </div>
            </div>

            <!-- Alert if overtraining detected -->
            <div id="insights-alert" style="display:none; padding:10px 14px; border-radius:10px; background:#fef3c7; border:1px solid #fbbf24; margin-top:10px;">
                <div style="font-size:0.85rem; font-weight:600; color:#92400e;" id="insights-alert-text"></div>
            </div>

            <!-- Recent ratings -->
            <div id="insights-recent" style="margin-top:12px;"></div>
        </div>
    </div>
</div>

<!-- Movement Weekly Trends Page (full-screen overlay) -->
<div class="weekly-trends-page" id="movement-weekly-trends-page">
    <div class="weekly-trends-page-header">
        <span class="weekly-trends-page-title">Movement Trends</span>
    </div>
    <div class="weekly-trends-page-content">
        <!-- Weekly Summary -->
        <div class="weekly-metrics-card" style="padding: 20px; background: linear-gradient(135deg, #f0f0ff 0%, #e8e0f0 100%); border-radius: 12px; border: 1px solid #d4d0e0; margin-bottom: 20px;">
            <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                Weekly Summary
            </h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Workouts</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1;"><span id="mvmt-weekly-workouts">0</span></div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Total Exercises</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1;"><span id="mvmt-weekly-exercises">0</span></div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Active Days</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1;"><span id="mvmt-weekly-active-days">0</span>/7</div>
                </div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 12px;">Last 7 Days</div>
                <div id="mvmt-weekly-daily-breakdown">
                    <p style="text-align: center; color: var(--text-muted); padding: 20px 0;">Loading workout data...</p>
                </div>
            </div>
        </div>

        <!-- Workout Journal -->
        <div class="meal-journal-card" id="mvmt-workout-journal-section">
            <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: var(--text-main);">Workout Journal</h3>
            <p style="margin: 0; font-size: 0.78rem; color: var(--text-muted);">Your recent workouts at a glance</p>
            <div class="journal-timeline" id="mvmt-workout-journal-timeline" style="gap: 10px;">
                <p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Loading your workouts...</p>
            </div>
        </div>

        <!-- Multi-Week Trends -->
        <div class="multi-week-card" id="mvmt-multi-week-section">
            <div class="multi-week-header">
                <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-main);">Weekly Trends</h3>
                <div class="multi-week-nav" id="mvmt-multi-week-nav">
                    <button class="active" onclick="loadMovementMultiWeekData(4)">4 Weeks</button>
                    <button onclick="loadMovementMultiWeekData(8)">8 Weeks</button>
                </div>
            </div>
            <div id="mvmt-multi-week-sparklines">
                <p style="text-align: center; color: var(--text-muted); padding: 20px 0; font-size: 0.85rem;">Loading trend data...</p>
            </div>
            <div class="week-compare-grid" id="mvmt-week-compare-grid">
            </div>
        </div>

        <!-- Workout Pattern Analysis -->
        <div class="meal-pattern-card" id="mvmt-workout-pattern-section">
            <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: var(--text-main);">Workout Patterns</h3>
            <p style="margin: 0 0 14px 0; font-size: 0.78rem; color: var(--text-muted);">Insights from your last 7 days</p>
            <div id="mvmt-workout-pattern-insights">
                <p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Log more workouts to see patterns</p>
            </div>
        </div>
    </div>
</div>

<!-- MOVED CHECK-IN MODAL TO BODY ROOT -->

<style>
    .checkin-btn.selected {
        border-color: var(--primary) !important;
        background: #f0fdf4 !important;
        color: var(--primary);
    }
</style>





<script>
let customWorkoutSelection = [];

function openWorkoutBuilder() {
    customWorkoutSelection = []; // Reset on open
    document.getElementById('builder-search').value = '';
    filterExerciseLibrary('');
    updateBuilderUI();
    hideAllAppViews();
    document.getElementById('view-workout-builder').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    if (typeof pushNavigationState === 'function') {
        pushNavigationState('view-workout-builder', () => switchAppTab('movement-tab'));
    }
}

// Initialize filter state
if (typeof window.activeFilters === 'undefined') {
    window.activeFilters = {
        workoutType: [],
        equipment: [],
        muscle: []
    };
}

// Toggle filter chip
function toggleFilter(category, value) {
    const filters = window.activeFilters[category];
    const index = filters.indexOf(value);

    // Find the button element
    const btn = document.querySelector(`.filter-chip[data-category="${category}"][data-value="${value}"]`);

    if (index > -1) {
        // Remove filter
        filters.splice(index, 1);
        btn.style.background = 'white';
        btn.style.color = '#64748b';
        btn.style.borderColor = '#e2e8f0';
    } else {
        // Add filter
        filters.push(value);
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--primary)';
    }

    // Show/hide clear button
    const hasActiveFilters = Object.values(window.activeFilters).some(arr => arr.length > 0);
    document.getElementById('clear-filters-btn').style.display = hasActiveFilters ? 'block' : 'none';

    // Re-run filter
    filterExerciseLibrary(document.getElementById('builder-search').value);
}

// Clear all filters
function clearAllFilters() {
    window.activeFilters = {
        workoutType: [],
        equipment: [],
        muscle: []
    };

    // Reset all filter chip styles
    document.querySelectorAll('.filter-chip').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#64748b';
        btn.style.borderColor = '#e2e8f0';
    });

    // Hide clear button
    document.getElementById('clear-filters-btn').style.display = 'none';

    // Re-run filter
    filterExerciseLibrary(document.getElementById('builder-search').value);
}

// Toggle filter section expand/collapse
function toggleFilterSection(sectionId) {
    const content = document.getElementById(`filter-content-${sectionId}`);
    const chevron = document.getElementById(`chevron-${sectionId}`);

    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
    }
}

// Check if exercise matches category filter
function matchesFilter(exerciseName) {
    const nameLower = exerciseName.toLowerCase();

    // Check workout type filters
    if (window.activeFilters.workoutType.length > 0) {
        const matchesWorkoutType = window.activeFilters.workoutType.some(type => {
            if (type === 'yoga') return nameLower.includes('yoga');
            if (type === 'pilates') return nameLower.includes('pilates');
            if (type === 'cardio') return nameLower.includes('sprint') || nameLower.includes('run') || nameLower.includes('jump') || nameLower.includes('hop') || nameLower.includes('burpee');
            if (type === 'stretch') return nameLower.includes('stretch') || nameLower.includes('foam roller');
            return false;
        });
        if (!matchesWorkoutType) return false;
    }

    // Check equipment filters
    if (window.activeFilters.equipment.length > 0) {
        const matchesEquipment = window.activeFilters.equipment.some(equip => {
            if (equip === 'dumbbell') return nameLower.includes('dumbbell');
            if (equip === 'barbell') return nameLower.includes('barbell');
            if (equip === 'cable') return nameLower.includes('cable');
            if (equip === 'band') return nameLower.includes('band') || nameLower.includes('miniband');
            if (equip === 'kettlebell') return nameLower.includes('kettlebell');
            if (equip === 'machine') return nameLower.includes('machine');
            if (equip === 'bodyweight') {
                // Bodyweight = doesn't contain any equipment keywords
                return !nameLower.includes('dumbbell') &&
                       !nameLower.includes('barbell') &&
                       !nameLower.includes('cable') &&
                       !nameLower.includes('band') &&
                       !nameLower.includes('kettlebell') &&
                       !nameLower.includes('machine') &&
                       !nameLower.includes('ball') &&
                       !nameLower.includes('trx') &&
                       !nameLower.includes('sled');
            }
            return false;
        });
        if (!matchesEquipment) return false;
    }

    // Check muscle group filters
    if (window.activeFilters.muscle.length > 0) {
        const matchesMuscle = window.activeFilters.muscle.some(muscle => {
            if (muscle === 'chest') return nameLower.includes('chest') || nameLower.includes('pec') || (nameLower.includes('press') && (nameLower.includes('bench') || nameLower.includes('floor')));
            if (muscle === 'back') return nameLower.includes('back') || nameLower.includes('lat') || nameLower.includes('row') || nameLower.includes('pull up') || nameLower.includes('pullup');
            if (muscle === 'shoulders') return nameLower.includes('shoulder') || nameLower.includes('delt') || nameLower.includes('raise') || nameLower.includes('overhead press');
            if (muscle === 'arms') return nameLower.includes('bicep') || nameLower.includes('tricep') || nameLower.includes('curl') || nameLower.includes('extension') && !nameLower.includes('leg') && !nameLower.includes('back');
            if (muscle === 'core') return nameLower.includes('ab') || nameLower.includes('core') || nameLower.includes('crunch') || nameLower.includes('plank') || nameLower.includes('oblique');
            if (muscle === 'legs') return nameLower.includes('squat') || nameLower.includes('lunge') || nameLower.includes('leg') || nameLower.includes('quad') || nameLower.includes('hamstring') || nameLower.includes('calf');
            if (muscle === 'glutes') return nameLower.includes('glute') || nameLower.includes('hip') || nameLower.includes('kickback');
            return false;
        });
        if (!matchesMuscle) return false;
    }

    return true;
}

function filterExerciseLibrary(query) {
    const list = document.getElementById('builder-library-list');
    if (!list) {
        console.error("Builder library list element not found!");
        return;
    }
    list.innerHTML = '';

    // Safety check for library loading
    if (typeof EXERCISE_VIDEOS === 'undefined') {
        list.innerHTML = `
            <div style="padding:20px; text-align:center; color:red; background:#fee2e2; border-radius:12px;">
                <strong>Error: Exercise Library Not Loaded</strong><br>
                <div style="font-size:0.8rem; margin-top:5px;">Please verify 'exercise_videos.js' file exists and is in the same folder.</div>
            </div>`;
        return;
    }

    // Global or scoped state for pagination
    if(typeof window.builderLimit === 'undefined') window.builderLimit = 50;

    const terms = query.toLowerCase().split(' ').filter(t => t);

    const allKeys = Object.keys(EXERCISE_VIDEOS);
    if (allKeys.length === 0) {
        list.innerHTML = '<div style="padding:20px; text-align:center;">Library is empty.</div>';
        return;
    }

    // 1. Gather Matches (search query + category filters)
    const matchedKeys = [];
    for (let key of allKeys) {
        const keyLower = key.toLowerCase();

        // Check search query
        let matchesQuery = true;
        if (terms.length > 0) {
            for (let term of terms) {
                if (!keyLower.includes(term)) {
                    matchesQuery = false;
                    break;
                }
            }
        }

        // Check category filters
        const matchesCategories = matchesFilter(key);

        if (matchesQuery && matchesCategories) {
            matchedKeys.push(key);
        }
    }

    // 2. Sort by relevance score if there's a search query
    if (terms.length > 0) {
        matchedKeys.sort((a, b) => {
            const scoreA = scoreExerciseMatch(a, terms, query);
            const scoreB = scoreExerciseMatch(b, terms, query);
            return scoreB - scoreA;
        });
    }

    // 3. Render Selection
    const keysToRender = matchedKeys.slice(0, window.builderLimit);

    keysToRender.forEach(key => {
        const isSelected = customWorkoutSelection.includes(key);
        const div = document.createElement('div');
        div.style.cssText = `background:white; border:1px solid ${isSelected ? 'var(--primary)' : '#f1f5f9'}; padding:15px; border-radius:16px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; min-height:60px;`;
        if(isSelected) div.style.background = '#f0fdf4';

        div.innerHTML = `
            <div style="font-weight:600; font-size:0.95rem; color:var(--text-main); flex:1; padding-right:10px;">${key}</div>
            <button onclick="toggleBuilderItem(this, '${key.replace(/'/g, "\\'")}')" style="width:32px; height:32px; border-radius:50%; border:none; background:${isSelected ? 'var(--primary)' : '#f1f5f9'}; color:${isSelected ? 'white' : '#94a3b8'}; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                ${isSelected ? '✓' : '+'}
            </button>
        `;
        list.appendChild(div);
    });

    // 4. Load More Button
    if (matchedKeys.length > window.builderLimit) {
        const moreDiv = document.createElement('div');
        moreDiv.innerHTML = `<button onclick="window.builderLimit += 50; filterExerciseLibrary(document.getElementById('builder-search').value)" style="width:100%; padding:15px; border:none; background:#f1f5f9; color:var(--text-muted); font-weight:600; border-radius:12px; cursor:pointer;">Load More (${matchedKeys.length - window.builderLimit} remaining)</button>`;
        list.appendChild(moreDiv);
    }

    if (matchedKeys.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted);">No exercises found</div>';
    }
}

// Ensure limit reset on open
const originalOpenBuilder = window.openWorkoutBuilder;
window.openWorkoutBuilder = function() {
    window.builderLimit = 50;
    if(originalOpenBuilder) originalOpenBuilder(); // Recursion risk if defined by name? 
    // Wait, openWorkoutBuilder is defined above. We should edit it directly or just resetting global var here is risky.
    // Better: Update openWorkoutBuilder in a separate chunk or rely on the input handler resetting it?
    // Let's simple check: if query length < previous query? No.
    // I'll just Replace openWorkoutBuilder in a separate edit or use MultiReplace.
};

function toggleBuilderItem(btn, key) {
    const index = customWorkoutSelection.indexOf(key);
    const parent = btn.parentElement;
    
    if (index > -1) {
        customWorkoutSelection.splice(index, 1);
        parent.style.borderColor = '#f1f5f9';
        parent.style.background = 'white';
        btn.style.background = '#f1f5f9';
        btn.style.color = '#94a3b8';
        btn.innerHTML = '+';
    } else {
        customWorkoutSelection.push(key);
        parent.style.borderColor = 'var(--primary)';
        parent.style.background = '#f0fdf4';
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        btn.innerHTML = '✓';
    }
    updateBuilderUI();
}

function updateBuilderUI() {
    const floatAction = document.getElementById('builder-floating-action');
    const countSpan = document.getElementById('builder-count');
    
    if (customWorkoutSelection.length > 0) {
        floatAction.style.display = 'block';
        countSpan.innerText = customWorkoutSelection.length;
    } else {
        floatAction.style.display = 'none';
    }
}

async function startCustomBuilderWorkout() {
    if (customWorkoutSelection.length === 0) return;

    // Prompt for workout name
    const workoutName = prompt("Name your workout:");
    if (!workoutName) return; // User cancelled

    // Auto-save the workout to database
    const user = window.currentUser;
    if (user) {
        try {
            const savedWorkout = await dbHelpers.workouts.saveCustomWorkout(user.id, workoutName, {
                exercises: customWorkoutSelection,
                date: new Date().toISOString()
            });
            // Track the workout ID so any added exercises get saved back
            window.currentCustomWorkoutId = savedWorkout?.id || null;
            window.currentWorkoutName = workoutName;
            // Refresh the cache
            const savedWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
            window.savedWorkoutsCache = savedWorkouts;
            // Preload workout history for previous stats and volume tracking
            const rawHistory1 = await dbHelpers.workouts.getHistory(user.id);
            window.workoutHistoryCache = normalizeHistoryCache(rawHistory1);
        } catch(e) {
            console.error("Failed to auto-save workout:", e);
            window.currentCustomWorkoutId = null;
        }
    }

    // Preload personal bests for all exercises in this workout
    if (user) {
        try {
            window.personalBestsCache = await dbHelpers.personalBests.getForExercises(user.id, customWorkoutSelection);
        } catch(e) { console.error("Failed to load personal bests", e); window.personalBestsCache = {}; }
    }

    // Construct a dynamic workout object
    const customWorkout = {
        title: workoutName,
        name: workoutName,
        description: 'Your personalized session',
        exercises: customWorkoutSelection.map(key => ({
            name: key,
            sets: 3,
            reps: '12',
            videoUrl: '', // Will be looked up
            desc: ''
        }))
    };

    // Hijack the player
    document.getElementById('workout-player-title').innerText = customWorkout.title;
    document.getElementById('workout-player-goal').innerText = customWorkout.description;
    
    const list = document.getElementById('workout-exercises-list');
    list.innerHTML = '';
    
    customWorkout.exercises.forEach((ex, idx) => {
        const card = document.createElement('div');
        card.className = 'exercise-logger-card'; // Required for addWorkoutSet to find parent
        card.setAttribute('data-exercise-name', ex.name);
        card.setAttribute('data-is-user-added', 'false');
        card.style.cssText = "background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9;";

        const videoUrl = findVideoMatch(ex.name);
        const previousSummaryHtml = formatPreviousWorkoutSummary(ex.name);
        const previousSummary = getPreviousWorkoutSummary(ex.name);
        const escapedName = ex.name.replace(/'/g, "\\'");

        card.innerHTML = `
            <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <h3 style="margin: 0 0 5px 0; font-size: 1.05rem; font-weight: 700; color: var(--text-main);">${ex.name}</h3>
                <div style="color: var(--text-muted); font-size: 0.85rem;">Custom Exercise</div>
                ${previousSummaryHtml}
            </div>

            ${videoUrl ? `
            <div data-video-container style="position: relative; width: 100%; padding-top: 56.25%; background: black; cursor: pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: var(--primary); margin-left: 3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            <!-- Volume Tracker -->
            <div class="volume-display" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-bottom: 1px solid #fef08a;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #ca8a04;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    <span style="font-size: 0.75rem; font-weight: 700; color: #a16207; text-transform: uppercase;">Volume</span>
                </div>
                <div style="text-align: right;">
                    <div class="volume-value" style="font-size: 1rem; font-weight: 800; color: #854d0e;">0 kg</div>
                    <div class="volume-comparison" style="font-size: 0.7rem; font-weight: 600;">${previousSummary && previousSummary.totalVolume > 0 ? `<span style="color: #94a3b8;">Last: ${previousSummary.totalVolume.toLocaleString()} kg — beat it!</span>` : '<span style="color: #94a3b8;">Enter weight & reps</span>'}</div>
                </div>
                <div class="volume-progress-container" style="display: ${previousSummary && previousSummary.totalVolume > 0 ? 'block' : 'none'}; margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span class="volume-target-label" style="font-size: 0.65rem; font-weight: 600; color: #a16207;">Target: ${previousSummary && previousSummary.totalVolume > 0 ? previousSummary.totalVolume.toLocaleString() + ' kg' : '—'}</span>
                        <span class="volume-percentage" style="font-size: 0.65rem; font-weight: 700; color: #a16207;">0%</span>
                    </div>
                    <div style="height: 6px; background: #fef08a; border-radius: 3px; overflow: hidden;">
                        <div class="volume-progress-bar" style="height: 100%; width: 0%; background: #ca8a04; border-radius: 3px; transition: width 0.3s ease, background 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr 32px 32px; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div><div></div><div></div>
            </div>

            <div class="sets-list-container">
                ${(() => {
                    const numSets = previousSummary && previousSummary.setCount > 0 ? previousSummary.setCount : ex.sets;
                    return Array.from({length: numSets}, (_, setIdx) => {
                        const prevSet = previousSummary && previousSummary.sets[setIdx] ? previousSummary.sets[setIdx] : null;
                        const prefillKg = prevSet && prevSet.kg && prevSet.kg !== '0' && prevSet.kg !== '' ? prevSet.kg : '';
                        const prefillReps = prevSet && prevSet.reps ? prevSet.reps : '';
                        const hasPrefill = prefillKg || prefillReps;
                        return `
                        <div class="set-wrapper"${hasPrefill ? ' data-prefilled="true"' : ''}>
                            <div class="workout-set-row" style="display: grid; grid-template-columns: 40px 1fr 1fr 1fr 32px 32px; gap: 8px; align-items: center; padding: 10px 15px; border-top: 1px solid #f8fafc;">
                                <div class="set-number" style="font-weight: 800; color: #94a3b8; font-size: 0.85rem; text-align: center;">${setIdx + 1}</div>
                                <input type="text" class="input-time" placeholder="-" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="time" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                                <input type="text" class="input-reps" placeholder="Reps" value="${prefillReps}" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="reps" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                                <input type="text" class="input-kg" placeholder="Kg" value="${prefillKg}" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="weight" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                                <button class="drop-set-toggle" onclick="toggleDropSet(this)" title="Toggle Drop Set">DS</button>
                                <button class="delete-set-btn" onclick="deleteSetRow(this)" title="Delete Set" style="width:32px; height:32px; border:none; background:transparent; color:#ef4444; cursor:pointer; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;"><svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:currentColor;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                            </div>
                            <div class="drop-set-container">
                                <div class="drop-set-inputs">
                                    <div class="drop-set-row">
                                        <div class="drop-indicator">↓1</div>
                                        <input type="text" class="drop-reps" placeholder="Reps">
                                        <input type="text" class="drop-kg" placeholder="Kg">
                                        <button class="drop-add-btn" onclick="addDropRow(this)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                })()}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${ex.name.replace(/'/g, "\\'")}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>
        `;
        list.appendChild(card);

        // Setup volume tracking for this card
        setupVolumeTracking(card);
    });

    hideAllAppViews();
    document.getElementById('view-active-workout').style.display = 'block';
    startWorkoutTimer();

    // Push navigation state for Android back button
    pushNavigationState('view-active-workout', () => quitWorkout());

    // Show total volume popup and tracker
    showLastVolumePopup();
}
</script>

<!-- YOUR WORKOUTS VIEW -->
<div id="view-your-workouts" class="app-view" style="display:none; min-height: 100vh; height: auto; background: #f8fafc; z-index: 100000; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; overflow-y: auto; overflow-x: hidden;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Your Workouts</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 20px;">
        <!-- My Programs Section -->
        <div id="your-programs-section" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 1rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2rem;">📅</span> My Programs
                </h3>
                <button onclick="closeYourWorkouts(); openProgramBuilder();" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 50px; font-weight: 600; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: white;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    Build Program
                </button>
            </div>
            <div id="your-programs-list" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Saved programs will be rendered here -->
            </div>
            <div id="your-programs-empty" style="display: none; text-align: center; padding: 25px 20px; color: var(--text-muted); background: white; border-radius: 16px; border: 2px dashed #e2e8f0;">
                <p style="margin: 0 0 12px 0; font-size: 0.9rem;">Create your own workout program</p>
                <p style="margin: 0 0 15px 0; font-size: 0.8rem; color: #94a3b8;">Choose workouts for each day, set your duration (4, 6, or 8 weeks), and follow your personalized plan!</p>
            </div>
        </div>

        <!-- Custom Workouts Section -->
        <div id="your-workouts-custom-section" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 1rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2rem;">🛠️</span> Custom Workouts
                </h3>
                <button onclick="closeYourWorkouts(); openWorkoutBuilder();" style="background: #f1f5f9; color: var(--text-main); border: none; padding: 8px 16px; border-radius: 50px; font-weight: 600; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--text-main);"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    New
                </button>
            </div>
            <div id="your-workouts-list" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Saved workouts will be rendered here -->
            </div>
            <div id="your-workouts-empty" style="display: none; text-align: center; padding: 25px 20px; color: var(--text-muted); background: white; border-radius: 16px; border: 2px dashed #e2e8f0;">
                <p style="margin: 0; font-size: 0.85rem;">Build single workouts from 1800+ exercises</p>
            </div>
        </div>

    </div>
</div>

<script>
function openYourWorkouts() {
    console.log('openYourWorkouts: Starting...');

    try {
        // First, hide all other views
        hideAllAppViews();

        // Get the view element
        const viewEl = document.getElementById('view-your-workouts');
        if (!viewEl) {
            console.error('openYourWorkouts: view-your-workouts element not found!');
            return;
        }

        // Show the view with explicit styles to ensure visibility
        viewEl.style.display = 'block';
        viewEl.style.visibility = 'visible';
        viewEl.style.opacity = '1';
        viewEl.scrollTop = 0; // Scroll to top of view
        window.scrollTo(0, 0); // Also scroll main window
        console.log('openYourWorkouts: View displayed');

        // Hide bottom nav safely
        const bottomNav = document.querySelector('.bottom-nav');
        if (bottomNav) {
            bottomNav.style.display = 'none';
        }

        // Hide any open modals/overlays that might be covering the view
        // Skip the onboarding wizard — closing it without setting completion flags causes it to re-trigger
        document.querySelectorAll('.modal-overlay, .onboarding-overlay, .completion-modal-overlay').forEach(el => {
            if (el.id === 'onboarding-wizard') return;
            el.style.display = 'none';
            el.classList.remove('active');
        });

        // Render library immediately (doesn't need database)
        const libraryContainer = document.getElementById('your-workouts-library-list');
        if (libraryContainer) {
            try {
                renderYourWorkoutsLibrary(libraryContainer);
                console.log('openYourWorkouts: Library rendered');
            } catch(libErr) {
                console.error('openYourWorkouts: Failed to render library', libErr);
                libraryContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Could not load workout library</div>';
            }
        }

        // Then load async data (custom workouts and programs)
        renderYourWorkoutsList().catch(err => {
            console.error('openYourWorkouts: Failed to render workouts list', err);
        });

        renderYourProgramsList().catch(err => {
            console.error('openYourWorkouts: Failed to render programs list', err);
        });

        // Push navigation state
        if (typeof pushNavigationState === 'function') {
            pushNavigationState('view-your-workouts', () => closeYourWorkouts());
        }

        console.log('openYourWorkouts: Complete');
    } catch(err) {
        console.error('openYourWorkouts: Error occurred', err);
        // Even if there's an error, try to show the view
        const viewEl = document.getElementById('view-your-workouts');
        if (viewEl) {
            viewEl.style.display = 'block';
        }
    }
}

function closeYourWorkouts() {
    document.getElementById('view-your-workouts').style.display = 'none';
    switchAppTab('movement-tab');
}

function openProgressFromMovement() {
    hideAllAppViews();

    const viewEl = document.getElementById('view-progress');
    if (viewEl) {
        viewEl.style.display = 'block';
        viewEl.scrollTop = 0;
        window.scrollTo(0, 0);
    }

    // Hide bottom nav
    const bottomNav = document.querySelector('.bottom-nav');
    if (bottomNav) {
        bottomNav.style.display = 'none';
    }

    // Initialize progress data
    if (typeof initProgressView === 'function') {
        initProgressView();
    }

    // Push navigation state for back button support
    if (typeof pushNavigationState === 'function') {
        pushNavigationState('view-progress', () => closeProgressView());
    }
}

function closeProgressView() {
    const viewEl = document.getElementById('view-progress');
    if (viewEl) {
        viewEl.style.display = 'none';
    }
    switchAppTab('movement-tab');
}

async function renderYourWorkoutsList() {
    console.log('renderYourWorkoutsList: Starting...');
    const listContainer = document.getElementById('your-workouts-list');
    const emptyState = document.getElementById('your-workouts-empty');

    if (!listContainer) {
        console.error('renderYourWorkoutsList: listContainer not found');
        return;
    }

    try {
        const user = window.currentUser;
        if (!user) {
            console.log('renderYourWorkoutsList: No user logged in');
            // Show empty state when not logged in
            if (listContainer) listContainer.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        // Try to use cached workouts first, then fetch if needed
        let savedWorkouts = window.savedWorkoutsCache;

        if (!savedWorkouts && typeof dbHelpers !== 'undefined' && dbHelpers.workouts) {
            console.log('renderYourWorkoutsList: Fetching from database...');
            savedWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
            window.savedWorkoutsCache = savedWorkouts;
        }

        console.log('renderYourWorkoutsList: Found', savedWorkouts?.length || 0, 'workouts');

        // Render Custom Workouts
        if (!savedWorkouts || savedWorkouts.length === 0) {
            if (listContainer) listContainer.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
        } else {
            if (listContainer) listContainer.style.display = 'flex';
            if (emptyState) emptyState.style.display = 'none';

            listContainer.innerHTML = savedWorkouts.map(w => {
                const name = w.template_name || 'Untitled Workout';
                const exercises = w.template_data?.exercises || [];
                const date = new Date(w.created_at || Date.now()).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                return `
                <div onclick="startSavedWorkout('${w.id}')" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #22c55e); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 1.2rem; flex-shrink: 0;">
                        ${name.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; color: var(--text-main); font-size: 0.95rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${exercises.length} exercises • Saved ${date}</div>
                    </div>
                    <div style="color: var(--primary); font-weight: 600; font-size: 0.8rem;">Start →</div>
                </div>
                `;
            }).join('');
            console.log('renderYourWorkoutsList: Rendered', savedWorkouts.length, 'workout cards');
        }

    } catch(err) {
        console.error('renderYourWorkoutsList: Error loading workouts:', err);
        if (listContainer) listContainer.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
    }
}

async function renderYourProgramsList() {
    console.log('renderYourProgramsList: Starting...');
    const listContainer = document.getElementById('your-programs-list');
    const emptyState = document.getElementById('your-programs-empty');

    if (!listContainer) {
        console.error('renderYourProgramsList: listContainer not found');
        return;
    }

    try {
        const user = window.currentUser;
        if (!user) {
            console.log('renderYourProgramsList: No user logged in');
            if (listContainer) listContainer.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        // Fetch programs from database
        let programs = [];
        if (typeof dbHelpers !== 'undefined' && dbHelpers.customPrograms) {
            console.log('renderYourProgramsList: Fetching from database...');
            programs = await dbHelpers.customPrograms.getAll(user.id);
            window.savedProgramsCache = programs;
        }

        console.log('renderYourProgramsList: Found', programs?.length || 0, 'programs');

        if (!programs || programs.length === 0) {
            if (listContainer) listContainer.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
        } else {
            if (listContainer) listContainer.style.display = 'flex';
            if (emptyState) emptyState.style.display = 'none';

            listContainer.innerHTML = programs.map(p => {
                const name = p.program_name || 'Untitled Program';
                const duration = p.duration_weeks || 4;
                const isActive = p.is_active;
                const schedule = p.weekly_schedule || [];
                const workoutDays = schedule.filter(s => s.workout && s.workout.type !== 'rest').length;

                // Calculate progress if active
                let progressHtml = '';
                if (isActive && p.start_date) {
                    const startDate = new Date(p.start_date);
                    const today = new Date();
                    const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                    const weeksElapsed = Math.floor((today - startDate) / msPerWeek) + 1;
                    const progress = Math.min(100, Math.round((weeksElapsed / duration) * 100));
                    progressHtml = `
                        <div style="margin-top: 8px; background: #e2e8f0; border-radius: 4px; height: 4px; overflow: hidden;">
                            <div style="background: var(--primary); height: 100%; width: ${progress}%;"></div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">Week ${Math.min(weeksElapsed, duration)} of ${duration}</div>
                    `;
                }

                return `
                <div onclick="viewProgramDetails('${p.id}')" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: ${isActive ? '2px solid var(--primary)' : '1px solid #f1f5f9'}; ${isActive ? 'border-left: 4px solid var(--primary);' : ''}">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: ${isActive ? 'linear-gradient(135deg, var(--primary), #22c55e)' : 'linear-gradient(135deg, #64748b, #94a3b8)'}; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 1rem; flex-shrink: 0;">
                            ${duration}w
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="font-weight: 700; color: var(--text-main); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                                ${isActive ? '<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; font-weight: 700;">ACTIVE</span>' : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${workoutDays} workout days • ${duration} weeks</div>
                            ${progressHtml}
                        </div>
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8; flex-shrink: 0;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </div>
                </div>
                `;
            }).join('');
            console.log('renderYourProgramsList: Rendered', programs.length, 'program cards');
        }

    } catch(err) {
        console.error('renderYourProgramsList: Error loading programs:', err);
        if (listContainer) listContainer.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
    }
}

async function viewProgramDetails(programId) {
    // Show program details with options to activate, edit, or delete
    try {
        const user = window.currentUser;
        if (!user) return;

        const programs = window.savedProgramsCache || await dbHelpers.customPrograms.getAll(user.id);
        const program = programs.find(p => p.id === programId);
        if (!program) return;

        const schedule = program.weekly_schedule || [];
        const scheduleText = schedule.map(s => {
            if (!s.workout) return `${s.day}: Not set`;
            if (s.workout.type === 'rest') return `${s.day}: Rest Day`;
            return `${s.day}: ${s.workout.name}`;
        }).join('\n');

        const action = prompt(
            `${program.program_name}\n` +
            `Duration: ${program.duration_weeks} weeks\n` +
            `Status: ${program.is_active ? 'Active' : 'Inactive'}\n\n` +
            `Weekly Schedule:\n${scheduleText}\n\n` +
            `Options:\n` +
            `1 = ${program.is_active ? 'Deactivate' : 'Activate'}\n` +
            `2 = Delete\n` +
            `Cancel = Close`,
            ''
        );

        if (action === '1') {
            if (program.is_active) {
                await dbHelpers.customPrograms.deactivate(programId);
                alert('Program deactivated. Your calendar will use the default schedule.');
            } else {
                await dbHelpers.customPrograms.activate(user.id, programId);
                alert(`Program "${program.program_name}" activated! Your ${program.duration_weeks}-week program starts today.`);
            }
            renderYourProgramsList();
            if (typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();
            if (typeof renderMovementView === 'function') renderMovementView();
        } else if (action === '2') {
            if (confirm(`Are you sure you want to delete "${program.program_name}"? This cannot be undone.`)) {
                await dbHelpers.customPrograms.delete(programId);
                alert('Program deleted.');
                renderYourProgramsList();
                if (typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();
                if (typeof renderMovementView === 'function') renderMovementView();
            }
        }
    } catch (err) {
        console.error('viewProgramDetails: Error', err);
        alert('An error occurred. Please try again.');
    }
}

function renderYourWorkoutsLibrary(container) {
    console.log('renderYourWorkoutsLibrary: Starting...');
    if (typeof WORKOUT_LIBRARY === 'undefined') {
        console.warn('renderYourWorkoutsLibrary: WORKOUT_LIBRARY is undefined');
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Workout library not available</div>';
        return;
    }

    const categories = Object.keys(WORKOUT_LIBRARY);
    const categoryIcons = {
        'gym': '🏋️',
        'yoga': '🧘',
        'bodyweight': '💪',
        'home': '🏠',
        'cardio': '🏃',
        'hiit': '⚡'
    };

    container.innerHTML = categories.map(categoryKey => {
        const category = WORKOUT_LIBRARY[categoryKey];
        const icon = categoryIcons[categoryKey] || category.icon || '💪';
        const name = category.name || categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1);

        // Count total workouts in category
        let totalWorkouts = 0;
        if (category.subcategories) {
            Object.values(category.subcategories).forEach(sub => {
                if (sub.workouts) totalWorkouts += sub.workouts.length;
            });
        }

        return `
        <div onclick="openLibraryCategory('${categoryKey}')" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b, #ef4444); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                ${icon}
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 700; color: var(--text-main); font-size: 0.95rem; margin-bottom: 2px;">${name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${totalWorkouts} workouts available</div>
            </div>
            <div style="color: #f59e0b; font-weight: 600; font-size: 0.8rem;">Browse →</div>
        </div>
        `;
    }).join('');
    console.log('renderYourWorkoutsLibrary: Rendered', categories.length, 'categories');
}

function viewWorkoutHistoryDetail(date) {
    // Navigate to progress view (now inside Movement tab)
    closeYourWorkouts();
    setTimeout(() => { if(typeof openProgressFromMovement === 'function') openProgressFromMovement(); }, 100);
}

</script>

<!-- WORKOUT OVERVIEW VIEW -->
<div id="view-workout-overview" class="app-view" style="display:none; height: 100vh; background: white; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;">
        <div style="width: 40px;"></div>
        <div id="overview-header-title" style="font-weight: 700; color: var(--text-main);">Workout Overview</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 20px;">
        <div id="overview-hero-card" style="border-radius: 20px; overflow: hidden; margin-bottom: 25px; position: relative; height: 200px; background: #f1f5f9;">
            <img id="overview-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);"></div>
            <div style="position: absolute; bottom: 20px; left: 20px; color: white;">
                <h1 id="overview-title" style="margin: 0; font-size: 1.8rem;">Workout Name</h1>
                <div id="overview-meta" style="opacity: 0.9; font-size: 0.9rem;">22 mins  6 Exercises</div>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.1rem;">Equipment Needed</h3>
            <div id="overview-equipment" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <!-- Equipment Badges -->
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.1rem;">Instructions</h3>
            <p id="overview-instructions" style="color: var(--text-muted); line-height: 1.5; font-size: 0.95rem;"></p>
        </div>

        <div>
            <h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">Exercise List</h3>
            <div id="overview-exercise-list">
                <!-- Exercises List -->
            </div>
        </div>
        
        <div style="height: 100px;"></div>
    </div>


</div>

<!-- ACTIVE WORKOUT PLAYER VIEW -->
<div id="view-active-workout" class="app-view" style="display:none; height: 100vh; background: #f8fafc; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    
    <!-- Top Nav Bar -->
    <div style="position: sticky; top: 0; z-index: 100; background: black; color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;">
        <div onclick="quitWorkout()" style="font-weight: 600; cursor: pointer; color: #FF4444; padding: 10px; touch-action: manipulation; user-select: none;">Cancel</div>
        <div style="text-align: center;">
            <div id="workout-timer" style="font-family: monospace; font-size: 1.2rem; font-weight: 700; color: white;">00:00</div>
        </div>
        <div onclick="finishWorkout()" style="font-weight: 600; cursor: pointer; color: #44FF44; padding: 10px; touch-action: manipulation; user-select: none;">Save</div>
    </div>

    <!-- Total Workout Volume Bar -->
    <div id="total-volume-bar" style="display:none; position:sticky; top:0; z-index:99; padding:10px 20px; background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom:1px solid #334155;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div style="display:flex; align-items:center; gap:6px;">
                <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:#facc15;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                <span style="font-size:0.7rem; font-weight:800; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">Total Volume</span>
            </div>
            <span id="total-volume-value" style="font-size:1.1rem; font-weight:900; color:white;">0 kg</span>
        </div>
        <div id="total-volume-progress-wrap" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:3px;">
                <span id="total-volume-target-label" style="font-size:0.6rem; font-weight:600; color:#64748b;">Target: 0 kg</span>
                <span id="total-volume-diff" style="font-size:0.65rem; font-weight:700; color:#94a3b8;"></span>
            </div>
            <div style="height:5px; background:#334155; border-radius:3px; overflow:hidden;">
                <div id="total-volume-progress-bar" style="height:100%; width:0%; background:#facc15; border-radius:3px; transition:width 0.3s ease, background 0.3s ease;"></div>
            </div>
        </div>
    </div>

    <!-- Last Volume Popup Overlay -->
    <div id="last-volume-popup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:600; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;" onclick="dismissVolumePopup()">
        <div style="background:white; border-radius:20px; padding:30px 25px; max-width:320px; width:85%; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:slideInUp 0.3s ease;" onclick="event.stopPropagation()">
            <div style="font-size:2.5rem; margin-bottom:10px;">&#x1F4AA;</div>
            <h3 style="margin:0 0 8px 0; font-size:1.1rem; font-weight:800; color:#1e293b;">Last Workout Volume</h3>
            <div id="popup-last-volume" style="font-size:2rem; font-weight:900; color:var(--primary); margin:10px 0;"></div>
            <p style="font-size:0.85rem; color:#64748b; margin:0 0 20px 0; line-height:1.4;">Can you beat it today? Every rep counts!</p>
            <button onclick="dismissVolumePopup()" style="background:var(--primary); color:white; border:none; padding:12px 30px; border-radius:12px; font-weight:700; font-size:0.9rem; cursor:pointer; width:100%;">Let's Go!</button>
        </div>
    </div>

    <div style="padding: 15px; padding-bottom: 120px;">
        <h1 id="workout-player-title" style="margin: 0 0 5px 0; font-size: 1.3rem; line-height: 1.2;">Workout Title</h1>
        <p id="workout-player-goal" style="font-size: 0.85rem; color: var(--text-muted); margin: 0 0 20px 0; line-height: 1.4;"></p>

        <div id="workout-exercises-list">
            <!-- Dynamic Content Injected Here via JS -->
        </div>

        <!-- Quick Entry Button -->
        <div style="margin-top: 20px;">
            <button onclick="openBulkEntryModal()" style="width: 100%; background: var(--primary); border: none; color: white; font-weight: 700; font-size: 0.95rem; padding: 18px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(123, 168, 131, 0.3);">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
                Quick Entry
            </button>
        </div>

        <!-- Add Exercise Button -->
        <div style="margin-top: 12px; padding-bottom: 40px;">
            <button onclick="openAddExerciseModal()" style="width: 100%; background: transparent; border: 2px dashed var(--primary); color: var(--primary); font-weight: 700; font-size: 0.95rem; padding: 18px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Add Exercise
            </button>
        </div>
    </div>
</div>

</div>

<!-- ADD EXERCISE MODAL -->
<div id="add-exercise-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 600; overflow-y: auto;">
    <div style="background: white; min-height: 100%; max-width: 600px; margin: 0 auto; position: relative;">
        <!-- Modal Header -->
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div onclick="closeAddExerciseModal()" style="font-weight: 600; cursor: pointer; color: var(--text-muted); padding: 10px;">Cancel</div>
            <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Add Exercise</div>
            <div style="width: 60px;"></div>
        </div>

        <!-- Search Box -->
        <div style="padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
            <input type="text" id="add-exercise-search" placeholder="Search exercises..." oninput="searchExercisesForAdd(this.value)" style="width: 100%; padding: 12px 15px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; background: white;">
        </div>

        <!-- Exercise Results -->
        <div id="add-exercise-results" style="padding: 15px 20px; padding-bottom: 100px;">
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                Type to search for exercises from your library
            </div>
        </div>
    </div>
</div>

<!-- BULK ENTRY MODAL -->
<div id="bulk-entry-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 600; overflow-y: auto;">
    <div style="background: white; min-height: 100%; max-width: 600px; margin: 0 auto; position: relative;">
        <!-- Modal Header -->
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div onclick="closeBulkEntryModal()" style="font-weight: 600; cursor: pointer; color: var(--text-muted); padding: 10px;">Cancel</div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Quick Entry</span>
                <div onclick="showQuickEntryTutorial()" style="width: 22px; height: 22px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.75rem; font-weight: 700; color: var(--text-muted);">?</div>
            </div>
            <div onclick="processBulkEntry()" style="font-weight: 600; cursor: pointer; color: var(--primary); padding: 10px;">Add</div>
        </div>

        <!-- Input Section -->
        <div style="padding: 20px;">
            <div style="background: #f8fafc; border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                <label style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: block; margin-bottom: 10px;">
                    Type your sets in one go:
                </label>
                <textarea id="bulk-entry-input" placeholder="e.g. bench press 30 40 60&#10;or: 3 sets squat 80kg 8 reps" style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; font-family: inherit; resize: vertical; box-sizing: border-box;" oninput="previewBulkEntry()"></textarea>
            </div>

            <!-- Preview Section -->
            <div id="bulk-entry-preview" style="display: none;">
                <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 12px;">Preview:</div>
                <div id="bulk-entry-preview-content" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;"></div>
            </div>
        </div>
    </div>
</div>

<!-- QUICK ENTRY TUTORIAL MODAL -->
<div id="quick-entry-tutorial-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 700; display: none; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;">
    <div style="background: white; border-radius: 24px; max-width: 400px; width: 100%; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
        <div style="background: linear-gradient(135deg, var(--primary), #4ade80); padding: 25px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 10px;">✍️</div>
            <h2 style="color: white; margin: 0; font-family: 'Playfair Display', serif; font-size: 1.5rem;">Quick Entry</h2>
            <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 0.95rem;">Log your sets in seconds</p>
        </div>
        <div style="padding: 25px;">
            <p style="color: var(--text-main); font-size: 0.95rem; margin: 0 0 20px 0; line-height: 1.5;">
                Just type the exercise name followed by your weights. We'll create all the sets for you!
            </p>
            <div style="background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <div style="font-weight: 700; color: var(--text-main); font-size: 0.8rem; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Try typing:</div>
                <div style="font-family: monospace; background: white; padding: 12px; border-radius: 8px; color: var(--text-main); font-size: 0.95rem; border: 1px solid #e2e8f0;">
                    bench press 30 40 60
                </div>
                <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 10px; text-align: center;">
                    Creates 3 sets at 30kg, 40kg, 60kg
                </div>
            </div>
            <div style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                <strong>Other formats:</strong><br>
                <span style="font-family: monospace;">squat 80x8 x3</span> — same weight, 3 sets<br>
                <span style="font-family: monospace;">row 60x10 70x8 80x6</span> — weight x reps
            </div>
        </div>
        <div style="padding: 0 25px 25px 25px;">
            <button onclick="closeQuickEntryTutorial()" style="width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer;">
                Got it!
            </button>
        </div>
    </div>
</div>

<!-- WORKOUT SUCCESS VIEW -->
<div id="view-workout-success" class="app-view" style="display:none; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 500; background: var(--primary); color: white; overflow-y: auto;">
    <div style="padding: 20px; text-align: center; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column;">

        <!-- Header Section - Compact -->
        <div id="workout-capture-area" style="background: var(--primary); padding: 20px 15px; border-radius: 16px;">
            <div style="font-size: 3rem; margin-bottom: 10px;">🙌</div>
            <h1 style="font-family: 'Playfair Display'; font-size: 2rem; margin: 0; color: white;">High Five!</h1>
            <p style="font-size: 1rem; opacity: 0.9; margin-top: 5px;">Workout Completed</p>
        </div>

        <!-- Personal Bests - Right under header -->
        <div id="success-improvements" style="display: none; margin: 15px 0; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 16px;"></div>

        <!-- Milestones Container -->
        <div id="success-milestones" style="display: none; margin: 10px 0;"></div>

        <!-- Stats Row - Duration & Workout Count side by side -->
        <div style="display: flex; gap: 12px; margin: 15px 0;">
            <div style="flex: 1; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Duration</div>
                <div id="success-duration" style="font-size: 1.8rem; font-weight: 700; font-family: monospace; margin-top: 5px;">00:00</div>
            </div>
            <div id="success-workout-count-container" style="display: none; flex: 1; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Total Workouts</div>
                <div id="success-workout-count" style="font-size: 1.8rem; font-weight: 700; margin-top: 5px;">0</div>
            </div>
        </div>

        <!-- Earn Points by Sharing Section -->
        <div id="share-section-combined" style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 16px; margin: 10px 0; position: relative;">
            <button onclick="this.parentElement.style.display='none'; localStorage.setItem('share_section_dismissed','true');" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.25); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: white; line-height: 1;">×</button>
            <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; padding-right: 20px;">Share Your Workout</div>
            <p style="font-size: 0.85rem; opacity: 0.85; margin-bottom: 15px;">Snap a gym photo and share a beautiful workout card to your feed!</p>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button id="share-workout-card-btn" onclick="shareWorkoutCardToFeed()" style="width: 100%; background: linear-gradient(135deg, #ffffff, #f0fdf4); color: var(--primary); padding: 14px 15px; border-radius: 12px; font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 1.3rem;">💪</span>
                    <span style="font-size: 0.95rem;">Share Workout Card (+1 XP)</span>
                </button>
                <button onclick="shareWorkoutToStory()" style="width: 100%; background: rgba(255,255,255,0.15); color: white; padding: 12px 15px; border-radius: 12px; font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 1.1rem;">📸</span>
                    <span style="font-size: 0.85rem;">Post Photo Only (+1 XP)</span>
                </button>
            </div>
        </div>

        <!-- XP Awarded Confirmation (shown after sharing) -->
        <div id="workout-points-awarded" style="display: none; background: rgba(68, 255, 68, 0.2); padding: 12px 20px; border-radius: 14px; margin: 10px 0; border: 2px solid rgba(68, 255, 68, 0.5);">
            <div id="workout-points-text" style="font-size: 1.1rem; font-weight: 700;">+1 XP Earned!</div>
            <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 3px;">Workout photo posted</div>
        </div>

        <!-- Small spacer before DONE button -->
        <div style="min-height: 20px;"></div>

        <!-- DONE Button - Always visible at bottom -->
        <div style="padding: 15px 0 100px 0;">
            <button onclick="closeSuccessScreen()" style="background: white; color: var(--primary); border: none; padding: 16px 60px; border-radius: 50px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.2); width: 100%; max-width: 280px;">
                DONE
            </button>
        </div>
    </div>
</div>

<!-- POST-WORKOUT RATING MODAL -->
<div id="workout-rating-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:600; overflow-y:auto; padding:20px 10px;">
    <div style="background:white; width:100%; max-width:480px; margin:20px auto; border-radius:24px; overflow:hidden; box-shadow:0 25px 50px rgba(0,0,0,0.3);">
        <!-- Header -->
        <div style="padding:24px 20px 16px; text-align:center; background:linear-gradient(135deg, var(--primary), #4ade80); color:white;">
            <div style="font-size:2.5rem; margin-bottom:8px;">💬</div>
            <h2 style="margin:0; font-family:'Playfair Display',serif; font-size:1.5rem;">How Was That?</h2>
            <p id="rating-workout-name" style="margin:5px 0 0; opacity:0.9; font-size:0.9rem;">Rate your workout</p>
        </div>

        <div style="padding:20px;">
            <!-- Overall Feeling -->
            <div style="margin-bottom:22px;">
                <div style="font-weight:700; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:10px;">How do you feel?</div>
                <div id="rating-feeling-row" style="display:flex; gap:6px;">
                    <button onclick="selectRating('feeling',1)" class="rating-btn" data-group="feeling" data-val="1" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">😫</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Terrible</div>
                    </button>
                    <button onclick="selectRating('feeling',2)" class="rating-btn" data-group="feeling" data-val="2" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">😕</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Rough</div>
                    </button>
                    <button onclick="selectRating('feeling',3)" class="rating-btn" data-group="feeling" data-val="3" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">😐</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">OK</div>
                    </button>
                    <button onclick="selectRating('feeling',4)" class="rating-btn" data-group="feeling" data-val="4" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">😊</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Good</div>
                    </button>
                    <button onclick="selectRating('feeling',5)" class="rating-btn" data-group="feeling" data-val="5" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">🤩</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Amazing</div>
                    </button>
                </div>
            </div>

            <!-- Difficulty -->
            <div style="margin-bottom:22px;">
                <div style="font-weight:700; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:10px;">How hard was it?</div>
                <div id="rating-difficulty-row" style="display:flex; gap:6px;">
                    <button onclick="selectRating('difficulty',1)" class="rating-btn" data-group="difficulty" data-val="1" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">🥱</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Too Easy</div>
                    </button>
                    <button onclick="selectRating('difficulty',2)" class="rating-btn" data-group="difficulty" data-val="2" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">👌</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Easy</div>
                    </button>
                    <button onclick="selectRating('difficulty',3)" class="rating-btn" data-group="difficulty" data-val="3" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">💪</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Just Right</div>
                    </button>
                    <button onclick="selectRating('difficulty',4)" class="rating-btn" data-group="difficulty" data-val="4" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">😤</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Hard</div>
                    </button>
                    <button onclick="selectRating('difficulty',5)" class="rating-btn" data-group="difficulty" data-val="5" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">🤯</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Too Hard</div>
                    </button>
                </div>
            </div>

            <!-- Energy Level -->
            <div style="margin-bottom:22px;">
                <div style="font-weight:700; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:10px;">Energy after workout?</div>
                <div id="rating-energy-row" style="display:flex; gap:6px;">
                    <button onclick="selectRating('energy',1)" class="rating-btn" data-group="energy" data-val="1" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">🪫</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Dead</div>
                    </button>
                    <button onclick="selectRating('energy',2)" class="rating-btn" data-group="energy" data-val="2" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">😮‍💨</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Low</div>
                    </button>
                    <button onclick="selectRating('energy',3)" class="rating-btn" data-group="energy" data-val="3" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">🔋</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Medium</div>
                    </button>
                    <button onclick="selectRating('energy',4)" class="rating-btn" data-group="energy" data-val="4" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">⚡</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Good</div>
                    </button>
                    <button onclick="selectRating('energy',5)" class="rating-btn" data-group="energy" data-val="5" style="flex:1; padding:12px 4px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.5rem;">🔥</div>
                        <div style="font-size:0.65rem; font-weight:600; margin-top:3px; color:var(--text-muted);">Buzzing</div>
                    </button>
                </div>
            </div>

            <!-- Body Check: Soreness & Tightness side by side -->
            <div style="display:flex; gap:12px; margin-bottom:22px;">
                <div style="flex:1;">
                    <div style="font-weight:700; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:10px;">Soreness?</div>
                    <div id="rating-soreness-row" style="display:flex; gap:4px;">
                        <button onclick="selectRating('soreness',1)" class="rating-btn" data-group="soreness" data-val="1" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">1</div>
                        </button>
                        <button onclick="selectRating('soreness',2)" class="rating-btn" data-group="soreness" data-val="2" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">2</div>
                        </button>
                        <button onclick="selectRating('soreness',3)" class="rating-btn" data-group="soreness" data-val="3" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">3</div>
                        </button>
                        <button onclick="selectRating('soreness',4)" class="rating-btn" data-group="soreness" data-val="4" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">4</div>
                        </button>
                        <button onclick="selectRating('soreness',5)" class="rating-btn" data-group="soreness" data-val="5" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">5</div>
                        </button>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.6rem; color:var(--text-muted); margin-top:4px; padding:0 2px;">
                        <span>None</span><span>Very sore</span>
                    </div>
                </div>
                <div style="flex:1;">
                    <div style="font-weight:700; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:10px;">Tightness?</div>
                    <div id="rating-tightness-row" style="display:flex; gap:4px;">
                        <button onclick="selectRating('tightness',1)" class="rating-btn" data-group="tightness" data-val="1" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">1</div>
                        </button>
                        <button onclick="selectRating('tightness',2)" class="rating-btn" data-group="tightness" data-val="2" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">2</div>
                        </button>
                        <button onclick="selectRating('tightness',3)" class="rating-btn" data-group="tightness" data-val="3" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">3</div>
                        </button>
                        <button onclick="selectRating('tightness',4)" class="rating-btn" data-group="tightness" data-val="4" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">4</div>
                        </button>
                        <button onclick="selectRating('tightness',5)" class="rating-btn" data-group="tightness" data-val="5" style="flex:1; padding:10px 2px; border-radius:10px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                            <div style="font-size:1.2rem;">5</div>
                        </button>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.6rem; color:var(--text-muted); margin-top:4px; padding:0 2px;">
                        <span>Loose</span><span>Very tight</span>
                    </div>
                </div>
            </div>

            <!-- Next time preference -->
            <div style="margin-bottom:22px;">
                <div style="font-weight:700; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:10px;">Next time I'd go...</div>
                <div id="rating-intensity-row" style="display:flex; gap:8px;">
                    <button onclick="selectIntensityPref('lighter')" class="intensity-pref-btn" data-val="lighter" style="flex:1; padding:14px 8px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.3rem;">⬇️</div>
                        <div style="font-size:0.8rem; font-weight:700; margin-top:4px; color:var(--text-main);">Lighter</div>
                    </button>
                    <button onclick="selectIntensityPref('perfect')" class="intensity-pref-btn" data-val="perfect" style="flex:1; padding:14px 8px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.3rem;">✅</div>
                        <div style="font-size:0.8rem; font-weight:700; margin-top:4px; color:var(--text-main);">Same</div>
                    </button>
                    <button onclick="selectIntensityPref('harder')" class="intensity-pref-btn" data-val="harder" style="flex:1; padding:14px 8px; border-radius:12px; border:2px solid #e2e8f0; background:white; cursor:pointer; text-align:center; transition:all 0.2s;">
                        <div style="font-size:1.3rem;">⬆️</div>
                        <div style="font-size:0.8rem; font-weight:700; margin-top:4px; color:var(--text-main);">Harder</div>
                    </button>
                </div>
            </div>

            <!-- Notes -->
            <div style="margin-bottom:22px;">
                <div style="font-weight:700; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:8px;">Notes <span style="font-weight:400; text-transform:none;">(optional)</span></div>
                <textarea id="rating-notes-input" placeholder="Anything to remember? e.g. went too heavy on squats, need more stretching..." rows="2" style="width:100%; padding:12px 14px; border-radius:12px; border:2px solid #e2e8f0; background:#f8fafc; color:var(--text-main); font-size:0.9rem; box-sizing:border-box; resize:none; outline:none; font-family:inherit;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
            </div>

            <!-- Buttons -->
            <div style="display:flex; gap:10px;">
                <button onclick="skipWorkoutRating()" style="flex:1; padding:14px; border-radius:14px; border:2px solid #e2e8f0; background:white; color:var(--text-muted); font-weight:600; font-size:0.95rem; cursor:pointer;">
                    Skip
                </button>
                <button id="save-rating-btn" onclick="saveWorkoutRating()" style="flex:2; padding:14px; border-radius:14px; border:none; background:var(--primary); color:white; font-weight:700; font-size:0.95rem; cursor:pointer; opacity:0.5;" disabled>
                    Save Rating
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LOG ACTIVITY VIEW -->
<div id="view-log-activity" class="app-view" style="display:none; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 500; background: var(--bg); color: var(--text-main); overflow-y: auto;">
    <div style="padding: 0 20px 120px 20px; max-width: 500px; margin: 0 auto;">

        <!-- Header -->
        <div style="display: flex; align-items: center; padding: 16px 0; gap: 12px; position: sticky; top: 0; background: var(--bg); z-index: 10;">
            <div style="width: 40px;"></div>
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0; flex: 1; text-align: center;">Log Activity</h2>
            <div style="width: 40px;"></div>
        </div>

        <!-- Activity Type Grid -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Activity Type</div>
            <div id="activity-type-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
        </div>

        <!-- Custom Label -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px;">Session Name <span style="font-weight:400; text-transform:none;">(optional)</span></div>
            <input id="activity-label-input" type="text" placeholder="e.g. Morning Boxing, Barry's Bootcamp" style="width: 100%; padding: 14px 16px; border-radius: 14px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 1rem; box-sizing: border-box; outline: none;" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='var(--border)'">
        </div>

        <!-- Duration -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Duration</div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; background: var(--card-bg); border-radius: 16px; padding: 16px; border: 2px solid var(--border);">
                <button onclick="adjustActivityDuration(-5)" style="width: 44px; height: 44px; border-radius: 50%; background: var(--border); border: none; font-size: 1.3rem; cursor: pointer; color: var(--text-main); font-weight: 700;">−</button>
                <div style="text-align: center; min-width: 80px;">
                    <div id="activity-duration-display" style="font-size: 2rem; font-weight: 800; font-family: monospace;">30</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">minutes</div>
                </div>
                <button onclick="adjustActivityDuration(5)" style="width: 44px; height: 44px; border-radius: 50%; background: var(--border); border: none; font-size: 1.3rem; cursor: pointer; color: var(--text-main); font-weight: 700;">+</button>
            </div>
        </div>

        <!-- Intensity -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Intensity</div>
            <div id="activity-intensity-row" style="display: flex; gap: 8px;">
                <button onclick="selectActivityIntensity('light')" class="intensity-btn" data-intensity="light" style="flex: 1; padding: 14px 8px; border-radius: 14px; border: 2px solid var(--border); background: var(--card-bg); cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 1.2rem;">🚶</div>
                    <div style="font-weight: 700; font-size: 0.85rem; margin-top: 4px; color: var(--text-main);">Light</div>
                </button>
                <button onclick="selectActivityIntensity('moderate')" class="intensity-btn" data-intensity="moderate" style="flex: 1; padding: 14px 8px; border-radius: 14px; border: 2px solid #0ea5e9; background: rgba(14,165,233,0.1); cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 1.2rem;">🏃</div>
                    <div style="font-weight: 700; font-size: 0.85rem; margin-top: 4px; color: var(--text-main);">Moderate</div>
                </button>
                <button onclick="selectActivityIntensity('vigorous')" class="intensity-btn" data-intensity="vigorous" style="flex: 1; padding: 14px 8px; border-radius: 14px; border: 2px solid var(--border); background: var(--card-bg); cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 1.2rem;">🔥</div>
                    <div style="font-weight: 700; font-size: 0.85rem; margin-top: 4px; color: var(--text-main);">Vigorous</div>
                </button>
            </div>
        </div>

        <!-- Estimated Calories -->
        <div style="margin-bottom: 24px; background: linear-gradient(135deg, #0c4a6e, #0284c7); border-radius: 16px; padding: 20px; color: white; text-align: center;">
            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Estimated Burn</div>
            <div style="display: flex; align-items: baseline; justify-content: center; gap: 4px; margin-top: 6px;">
                <span id="activity-calories-display" style="font-size: 2.2rem; font-weight: 800;">0</span>
                <span style="font-size: 1rem; opacity: 0.8;">kcal</span>
            </div>
        </div>

        <!-- Photo Section -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Venue Photo</div>
            <div id="activity-photo-preview" style="display: none; margin-bottom: 12px; border-radius: 16px; overflow: hidden; position: relative;">
                <img id="activity-photo-img" src="" style="width: 100%; max-height: 250px; object-fit: cover;">
                <button onclick="removeActivityPhoto()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.1rem;">×</button>
            </div>
            <button id="activity-photo-btn" onclick="captureActivityPhoto()" style="width: 100%; padding: 16px; border-radius: 14px; border: 2px dashed var(--border); background: var(--card-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--text-main);">
                <span style="font-size: 1.3rem;">📸</span>
                <span style="font-weight: 600;">Add venue photo for XP</span>
            </button>
            <input id="activity-photo-input" type="file" accept="image/*" capture="environment" style="display: none;" onchange="handleActivityPhotoCapture(this)">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; text-align: center;">Photos of gyms, courts, pools, treadmills = XP. Outdoor scenery = no XP.</div>
        </div>

        <!-- Notes -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px;">Notes <span style="font-weight:400; text-transform:none;">(optional)</span></div>
            <textarea id="activity-notes-input" placeholder="How was your session?" rows="3" style="width: 100%; padding: 14px 16px; border-radius: 14px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 1rem; box-sizing: border-box; resize: none; outline: none; font-family: inherit;" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='var(--border)'"></textarea>
        </div>

        <!-- Save Button -->
        <button id="activity-save-btn" onclick="saveActivity()" style="width: 100%; padding: 18px; border-radius: 16px; background: linear-gradient(135deg, #0ea5e9, #06b6d4); color: white; border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer; box-shadow: 0 8px 20px rgba(14,165,233,0.3);">
            Log Activity
        </button>
    </div>
</div>

<!-- ACTIVITY SUCCESS VIEW -->
<div id="view-activity-success" class="app-view" style="display:none; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 500; background: linear-gradient(135deg, #0c4a6e, #0284c7, #0ea5e9); color: white; overflow-y: auto;">
    <div style="padding: 20px; text-align: center; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column;">

        <!-- Header -->
        <div style="padding: 30px 15px 20px;">
            <div id="activity-success-emoji" style="font-size: 3.5rem; margin-bottom: 10px;">🏃</div>
            <h1 style="font-family: 'Playfair Display', serif; font-size: 2rem; margin: 0; color: white;">Activity Logged!</h1>
            <p id="activity-success-label" style="font-size: 1rem; opacity: 0.9; margin-top: 5px;">Great work</p>
        </div>

        <!-- Stats -->
        <div style="display: flex; gap: 10px; margin: 15px 0;">
            <div style="flex: 1; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Duration</div>
                <div id="activity-success-duration" style="font-size: 1.6rem; font-weight: 700; margin-top: 5px;">30 min</div>
            </div>
            <div style="flex: 1; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Calories</div>
                <div id="activity-success-calories" style="font-size: 1.6rem; font-weight: 700; margin-top: 5px;">0 kcal</div>
            </div>
            <div style="flex: 1; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Intensity</div>
                <div id="activity-success-intensity" style="font-size: 1.6rem; font-weight: 700; margin-top: 5px;">🏃</div>
            </div>
        </div>

        <!-- Share Section -->
        <div id="activity-share-section" style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 16px; margin: 15px 0;">
            <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 10px;">Share to Feed</div>
            <button id="activity-share-btn" onclick="shareActivityCardToFeed()" style="width: 100%; background: white; color: #0284c7; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem;">
                <span style="font-size: 1.2rem;">📤</span>
                <span id="activity-share-btn-text">Share Activity Card</span>
            </button>
        </div>

        <!-- XP Status -->
        <div id="activity-xp-status" style="display: none; padding: 12px 20px; border-radius: 14px; margin: 10px 0;"></div>

        <!-- No XP hint -->
        <div id="activity-no-xp-hint" style="display: none; background: rgba(255,255,255,0.1); padding: 12px 20px; border-radius: 14px; margin: 10px 0;">
            <div style="font-size: 0.85rem; opacity: 0.85;">💡 Take a photo of your venue next time to earn XP!</div>
        </div>

        <!-- Done Button -->
        <div style="padding: 15px 0 100px 0; margin-top: 10px;">
            <button onclick="closeActivitySuccess()" style="background: white; color: #0284c7; border: none; padding: 16px 60px; border-radius: 50px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.2); width: 100%; max-width: 280px;">
                DONE
            </button>
        </div>
    </div>
</div>

<!-- QUICK SHARE TO GROUP CHAT MODAL -->
<div id="quick-share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); z-index: 2000; overflow-y: auto; padding: 20px 10px;">
    <div style="background: white; width: 100%; max-width: 480px; margin: 0 auto; border-radius: 28px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative;">
        <!-- Header -->
        <div style="padding: 22px 25px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, var(--primary), #4ade80); position: sticky; top: 0; z-index: 10;">
            <div style="font-weight: 800; color: white; font-size: 1.25rem; font-family: 'Playfair Display', serif;">Share Your Win</div>
            <div onclick="closeQuickShareModal()" style="color: white; cursor: pointer; font-size: 1.8rem; line-height: 1; padding: 5px;">&times;</div>
        </div>

        <div style="padding-bottom: 30px;">
            <!-- Win Preview -->
            <div id="quick-share-preview" style="padding: 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid #edf2f7;">
                    <div id="quick-share-badge" style="font-size: 2.5rem; margin-bottom: 12px;">🏆</div>
                    <div id="quick-share-message" style="font-size: 1.1rem; font-weight: 700; color: var(--text-main); line-height: 1.4;"></div>
                    <div id="quick-share-detail" style="font-size: 0.9rem; color: var(--text-muted); margin-top: 8px;"></div>
                </div>
            </div>

            <!-- Lift Selection -->
            <div id="lift-selection-section" style="display: none; padding: 20px; border-bottom: 1px solid #f1f5f9;">
                <div style="font-weight: 700; color: var(--text-main); margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="dumbbell" size="18" style="color: var(--primary);"></i> What do you want to share?
                </div>
                <div id="lift-selection-list" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <!-- Lifts populated here -->
                </div>
                <div id="multi-select-hint" style="display: none; margin-top: 12px; padding: 10px 14px; background: #f0fdf4; border-radius: 10px; font-size: 0.85rem; color: #166534; text-align: center;">
                    <strong>Tip:</strong> Tap multiple sets to share them together
                </div>
            </div>

            <!-- External Share Options -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9;">
                <div style="font-weight: 700; color: var(--text-main); margin-bottom: 15px; font-size: 1rem;">Share externally:</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <button onclick="shareWinToMessenger()" style="padding: 14px; background: #0084FF; color: white; border: none; border-radius: 16px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(0,132,255,0.25);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.36 2 2 6.13 2 11.7c0 2.91 1.19 5.44 3.14 7.17.16.14.26.34.29.54l.05 1.78c.04.59.64.96 1.17.72l1.98-.87c.17-.07.36-.09.53-.05.86.23 1.81.35 2.84.35 5.64 0 10-4.13 10-9.7C22 6.13 17.64 2 12 2zm5.89 7.58l-2.88 4.57c-.46.73-1.44.93-2.16.44l-2.29-1.72c-.19-.14-.45-.14-.64 0l-3.09 2.34c-.41.31-.95-.18-.68-.62l2.88-4.57c.46-.73 1.44-.93 2.16-.44l2.29 1.72.19.14.45.14.64 0l3.09-2.34c.41-.31.95.18.68.62z"/></svg> Messenger
                    </button>
                    <button onclick="shareWinToWhatsApp()" style="padding: 14px; background: #25D366; color: white; border: none; border-radius: 16px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(37,211,102,0.25);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> WhatsApp
                    </button>
                    <button onclick="copyWinMessage()" style="grid-column: span 2; padding: 14px; background: #f1f5f9; color: var(--text-main); border: 1px solid #e2e8f0; border-radius: 16px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> Copy Message
                    </button>
                </div>
            </div>

            <!-- Group Chat Selection -->
            <div style="padding: 20px;">
                <div style="font-weight: 700; color: var(--text-main); margin-bottom: 20px; font-size: 1rem;">Or share to a group chat:</div>
                <div id="quick-share-chats-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Chats will be loaded here -->
                </div>
                <div id="quick-share-no-chats" style="display: none; text-align: center; padding: 40px; color: var(--text-muted); background: #f8fafc; border-radius: 20px; border: 1px dashed #cbd5e0;">
                    <div style="font-size: 2.5rem; margin-bottom: 12px;">💬</div>
                    <p style="font-weight: 500;">No group chats yet!</p>
                    <button onclick="closeQuickShareModal(); goToGroupChatsToShare();" style="background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: 700; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 12px rgba(123, 168, 131, 0.3);">
                        Create a Chat
                    </button>
                </div>
            </div>

            <!-- Footer Action -->
            <div style="padding: 0 20px 20px 20px; text-align: center;">
                <button onclick="closeQuickShareModal()" style="width: 100%; padding: 16px; background: white; color: var(--text-muted); border: 1px solid #e2e8f0; border-radius: 50px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s;">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<!-- WORKOUT LIBRARY CATEGORIES VIEW -->
<div id="view-workout-library" class="app-view" style="display:none; height: 100vh; background: white; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Workout Library</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;">
            Choose your workout style and browse our complete library of professionally designed workouts.
        </p>

        <div id="library-categories-grid" style="display: grid; gap: 15px;">
            <!-- Categories will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- PRE-BUILT PROGRAMS VIEW -->
<div id="view-prebuilt-programs" class="app-view" style="display:none; height: 100vh; background: white; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Pre-built Programs</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;">
            Choose from our professionally designed workout programs tailored to your equipment and goals.
        </p>

        <div id="prebuilt-programs-grid" style="display: grid; gap: 20px;">
            <!-- Programs will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- WORKOUT LIBRARY SUBCATEGORIES VIEW -->
<div id="view-workout-subcategories" class="app-view" style="display:none; height: 100vh; background: white; z-index: 501; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div id="subcategory-header-title" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Category</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p id="subcategory-description" style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;"></p>

        <div id="subcategories-grid" style="display: grid; gap: 15px;">
            <!-- Subcategories will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- WORKOUT LIBRARY WORKOUTS LIST VIEW -->
<div id="view-workout-list" class="app-view" style="display:none; height: 100vh; background: white; z-index: 502; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div id="workout-list-header-title" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Workouts</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p id="workout-list-description" style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;"></p>

        <div id="workouts-list" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Workouts will be dynamically inserted here -->
        </div>
    </div>
</div>

<style>
.exercise-logger-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

/* Yoga exercise card styles */
.yoga-exercise-card {
    border: 2px solid #dcfce7;
}

.yoga-exercise-card .yoga-timer-section {
    background: linear-gradient(180deg, #ffffff 0%, #f0fdf4 100%);
}

.yoga-timer-section button:active {
    transform: scale(0.95);
}

.yoga-timer-section button:hover {
    opacity: 0.9;
}

.library-category-card {
    background: white;
    border: 2px solid #f1f5f9;
    border-radius: 16px;
    padding: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 20px;
}

.library-category-card:hover {
    border-color: var(--primary);
    background: #f0fdf4;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.library-category-icon {
    font-size: 2.5rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8fafc;
    border-radius: 12px;
}

.library-category-card:hover .library-category-icon {
    background: white;
}

.workout-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.workout-card:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transform: translateY(-1px);
}

.workout-difficulty-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.difficulty-beginner {
    background: #d1fae5;
    color: #065f46;
}

.difficulty-intermediate {
    background: #fed7aa;
    color: #9a3412;
}

.difficulty-advanced {
    background: #fecaca;
    color: #991b1b;
}
</style>

    <!-- Bottom Navigation (Moved Outside Container) -->
    <nav class="bottom-nav" style="z-index: 9999 !important; position: fixed; bottom: 0; left: 0; width: 100%;">
        <button class="nav-item active" onclick="switchAppTab('dashboard', this)">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('meals', this)">
            <svg viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>
            <span>Nutrition</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('movement-tab', this)">
            <svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 16.29 22 18.43 19.86 19.86 21.29 21.29 19.86l-1.43-1.43L21.29 17l-1.43-1.43L18.43 17l-3.57-3.57z"/></svg>
            <span>Movement</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('learning', this)">
            <svg viewBox="0 0 24 24"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/></svg>
            <span>Learn</span>
        </button>
        <button class="nav-item" id="nav-cycle-btn" onclick="switchAppTab('cycle', this)">
           <svg id="nav-cycle-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.22-7.52-3.22 3.22 7.52 3.22-7.52z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
           <span id="nav-cycle-label">Cycle</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('friends', this)">
            <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/></svg>
            <span>Feed</span>
        </button>
     </nav>

    <!-- FRIENDS VIEW (now primarily a Feed view) -->
    <div id="view-friends" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc;">
        <!-- Header -->
        <div style="padding: 20px 25px; background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
            <div>
                <h2 style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.5rem;">Feed</h2>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <!-- Coin Balance Widget -->
                <div class="coin-header-widget" onclick="openCoinShop()">
                    <span class="coin-emoji">🪙</span>
                    <span class="coin-amount coin-balance-sync">0</span>
                    <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
                </div>
                <!-- Message Inbox Icon (now holds Group Chats + Friends) -->
                <div onclick="openFeedMessagesPanel()" style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-muted);"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                    <div id="message-inbox-badge" style="display: none; position: absolute; top: -2px; right: -2px; width: 18px; height: 18px; background: #ef4444; color: white; font-size: 0.65rem; font-weight: 700; border-radius: 50%; display: flex; align-items: center; justify-content: center;">0</div>
                </div>
                <!-- Add Friend Button -->
                <div onclick="openAddFriendModal()" style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-muted);"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <!-- New Post Button -->
                <button onclick="openStoryCamera()" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: none;" stroke="white" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    Post
                </button>
            </div>
        </div>

        <!-- Referral Banner -->
        <div id="friends-referral-banner" style="margin: 15px; padding: 20px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 16px; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2); position: relative;">
            <button onclick="this.parentElement.style.display='none'; localStorage.setItem('referral_banner_dismissed','true');" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.25); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: white; line-height: 1;">×</button>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-right: 20px;">
                <div style="font-size: 2rem;">🎁</div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.1rem; color: white; margin-bottom: 4px;">You BOTH Get 1 Week Double XP!</div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.9);">Invite friends and you each get 1 week double XP when they join</div>
                </div>
            </div>
            <button onclick="openShareReferralModal()" style="width: 100%; background: white; color: #059669; border: none; padding: 12px; border-radius: 10px; font-size: 0.95rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #059669;"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                Share Your Link
            </button>
        </div>

        <!-- Points incentive for posting -->
        <div id="feed-post-incentive" style="margin: 0 15px 12px 15px; padding: 10px 14px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 10px; display: flex; align-items: center; gap: 10px; border: 1px solid #fcd34d; position: relative;">
            <button onclick="this.parentElement.style.display='none'; localStorage.setItem('feed_incentive_dismissed','true');" style="position: absolute; top: 6px; right: 6px; background: rgba(146,64,14,0.15); border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #92400e; line-height: 1;">×</button>
            <span style="font-size: 1.2rem;">+1</span>
            <span style="font-size: 0.8rem; color: #92400e; font-weight: 600; padding-right: 16px;">Post a workout photo to earn 1 XP!</span>
        </div>

        <!-- Challenge a Friend Banner -->
        <div style="margin: 0 15px 12px; padding: 14px 16px; background: linear-gradient(135deg, #1a1a2e 0%, #2e1a0e 50%, #3d2e0a 100%); border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 20px rgba(245,158,11,0.1); cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255,255,255,0.08);" onclick="openGameChallengeModal()">
            <div style="width: 44px; height: 44px; background: rgba(251,191,36,0.15); border: 1px solid rgba(251,191,36,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">🎮</div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 800; font-size: 0.95rem; color: #fbbf24; margin-bottom: 2px; text-shadow: 0 0 15px rgba(251,191,36,0.3);">Challenge a Friend</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Chess, Checkers, Connect 4 & more - bet coins!</div>
            </div>
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: rgba(251,191,36,0.6); flex-shrink: 0;"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
        </div>

        <!-- Active Games Container (populated dynamically) -->
        <div id="active-games-container" style="display: none;"></div>

        <!-- Friends Feed - Full photo feed grid -->
        <div id="friends-feed-section" style="padding: 0;">
            <div id="friends-photo-feed" style="display: flex; flex-direction: column; gap: 0; padding: 0;">
                <!-- Feed posts will be loaded here -->
            </div>
            <div id="friends-feed-empty" style="display: none; text-align: center; padding: 40px 20px;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">📸</div>
                <div style="font-size: 0.95rem; color: var(--text-main); font-weight: 600; margin-bottom: 5px;">No posts yet</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">Be the first to share a workout photo!</div>
                <button onclick="openStoryCamera()" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 10px 24px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; cursor: pointer;">
                    Share a Post
                </button>
            </div>
        </div>


        <!-- Hidden stories carousel (kept for compatibility) -->
        <div id="friends-stories-section" style="display: none;">
            <div id="friends-stories-carousel" style="display: flex; gap: 15px;">
                <div class="story-ring add-story-btn" onclick="openStoryCamera()" style="display: inline-block; text-align: center; cursor: pointer; flex-shrink: 0;"></div>
            </div>
        </div>

        <!-- Group Chats & Friends - now hidden, accessible via messages panel -->
        <div id="friends-messaging-section" style="display: none;">
            <div id="group-chats-container" style="display: flex; flex-direction: column; gap: 12px;">
                <div id="group-chats-empty" style="text-align: center; padding: 30px 20px; background: white; border-radius: 12px; border: 1px solid #f1f5f9;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">💬</div>
                    <div style="font-size: 0.95rem; color: var(--text-main); font-weight: 600; margin-bottom: 5px;">No group chats yet</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">Start a group chat to share wins with friends!</div>
                    <button onclick="openCreateGroupChatModal()" style="background: linear-gradient(135deg, var(--primary), #10b981); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">
                        Create Your First Group
                    </button>
                </div>
            </div>
            <div id="friends-cards-container" style="display: flex; flex-direction: column; gap: 2px; background: white; border-radius: 12px; overflow: hidden; border: 1px solid #f1f5f9;">
                <div onclick="openCoachChatFromFriends()" style="display: flex; align-items: center; padding: 12px 16px; cursor: pointer; background: linear-gradient(90deg, rgba(123,168,131,0.08) 0%, transparent 100%); border-bottom: 1px solid #f1f5f9;">
                    <div style="position: relative; margin-right: 12px;">
                        <div style="width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--primary);">
                            <img src="assets/coach_shannon.jpg" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<span style=\'color: white; font-size: 1.4rem; font-weight: 700;\'>S</span>'">
                        </div>
                        <div style="position: absolute; bottom: 2px; right: 2px; width: 14px; height: 14px; background: #22c55e; border-radius: 50%; border: 2px solid white;"></div>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">Coach Shannon</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);"><span style="color: var(--primary); font-weight: 500;">Your wellness guide</span></div>
                    </div>
                    <div style="width: 36px; height: 36px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--text-muted);"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                    </div>
                </div>
                <div id="friends-cards-list"></div>
            </div>
        </div>
    </div>

    <!-- USER PROFILE VIEW (View another user's profile from the feed) -->
    <div id="view-user-profile" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc; overflow-x: hidden;">
        <!-- Header -->
        <div style="padding: 16px 20px; background: white; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 10;">
            <h2 id="user-profile-header-name" style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.3rem; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Profile</h2>
        </div>

        <!-- Profile Top Section: Photo, Name, Level, Strength -->
        <div id="user-profile-top" style="background: white; padding: 24px 20px 20px; text-align: center; border-bottom: 1px solid #f1f5f9;">
            <div id="user-profile-avatar" style="width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; margin: 0 auto 14px; overflow: hidden; border: 3px solid var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <span style="font-size: 2.2rem; color: white; font-weight: 700;">?</span>
            </div>
            <h2 id="user-profile-name" style="margin: 0 0 4px; font-size: 1.3rem; font-weight: 700; color: var(--text-main);"></h2>
            <div id="user-profile-level-badge" style="display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 5px 14px; border-radius: 20px; margin-bottom: 12px; border: 1px solid #fcd34d;">
                <span style="font-size: 0.8rem; font-weight: 700; color: #92400e;">Lv. <span id="user-profile-level">1</span></span>
                <span style="font-size: 0.75rem; color: #a16207; font-weight: 600;" id="user-profile-level-title">Newcomer</span>
            </div>
            <!-- Stats row: Workouts, Streak, Points -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
                <div style="text-align: center;">
                    <div id="user-profile-workouts" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">0</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Workouts</div>
                </div>
                <div style="text-align: center;">
                    <div id="user-profile-streak" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">0</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Day Streak</div>
                </div>
                <div style="text-align: center;">
                    <div id="user-profile-points" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">0</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">XP</div>
                </div>
            </div>
        </div>

        <!-- Tamagotchi / FitGotchi Section -->
        <div id="user-profile-tamagotchi-section" style="padding: 0 20px 10px; display: none;">
            <div style="background: #1a1a2e; border-radius: 16px; overflow: hidden; height: 260px; position: relative;">
                <model-viewer
                    id="user-profile-tamagotchi-model"
                    camera-controls
                    disable-zoom
                    disable-pan
                    auto-rotate
                    rotation-intensity="0.5"
                    shadow-intensity="1.5"
                    shadow-softness="0.8"
                    exposure="0.9"
                    environment-image="neutral"
                    camera-orbit="0deg 85deg 22m"
                    field-of-view="55deg"
                    min-field-of-view="20deg"
                    max-field-of-view="120deg"
                    style="width: 100%; height: 100%; --poster-color: #1a1a2e; touch-action: pan-y;"
                    interaction-prompt="none">
                </model-viewer>
                <!-- Fallback -->
                <div id="user-profile-tamagotchi-fallback" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:4; background:#1a1a2e; justify-content:center; align-items:center; flex-direction:column; text-align:center; color:white; padding:20px;">
                    <div style="font-size:48px; margin-bottom:8px;">🐣</div>
                    <div style="font-size:0.9rem; font-weight:600;">FitGotchi</div>
                </div>
            </div>
        </div>

        <!-- Personal Bests Section -->
        <div id="user-profile-pbs-section" style="padding: 20px; display: none;">
            <h3 style="margin: 0 0 14px; font-size: 1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">🏋️</span> Personal Bests
            </h3>
            <div id="user-profile-pbs-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                <!-- PB cards rendered dynamically -->
            </div>
        </div>

        <!-- Badges / Milestones Section -->
        <div id="user-profile-badges-section" style="padding: 0 20px 20px; display: none;">
            <h3 style="margin: 0 0 14px; font-size: 1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">🏅</span> Badges
            </h3>
            <div id="user-profile-badges-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <!-- Badge cards rendered dynamically -->
            </div>
        </div>

        <!-- Posts Section -->
        <div id="user-profile-posts-section" style="padding: 0 20px 20px;">
            <h3 style="margin: 0 0 14px; font-size: 1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">📸</span> Posts
            </h3>
            <div id="user-profile-posts-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; border-radius: 12px; overflow: hidden;">
                <!-- Post thumbnails rendered dynamically -->
            </div>
            <div id="user-profile-posts-empty" style="display: none; text-align: center; padding: 30px 20px; background: white; border-radius: 12px; border: 1px solid #f1f5f9;">
                <div style="font-size: 2rem; margin-bottom: 8px;">📷</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">No posts yet</div>
            </div>
        </div>
    </div>

    <!-- MESSAGES PANEL (Slide-over for Group Chats + Friends) -->
    <div id="feed-messages-panel" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10006; backdrop-filter: blur(3px);">
        <div id="feed-messages-panel-content" style="position: absolute; right: 0; top: 0; bottom: 0; width: 100%; max-width: 400px; background: white; box-shadow: -5px 0 20px rgba(0,0,0,0.15); overflow-y: auto; animation: slideInFromRight 0.3s ease-out;">
            <!-- Panel Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: white; z-index: 5;">
                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-main);">Messages</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div onclick="openAddFriendModal(); closeFeedMessagesPanel();" style="width: 36px; height: 36px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: white;"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <button onclick="closeFeedMessagesPanel()" style="background: none; border: none; font-size: 1.8rem; color: #94a3b8; cursor: pointer; line-height: 1; padding: 4px;">&times;</button>
                </div>
            </div>

            <!-- Group Chats in Panel -->
            <div style="padding: 15px 20px 5px 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-main); font-weight: 600;">Group Chats</h4>
                    <button onclick="openCreateGroupChatModal(); closeFeedMessagesPanel();" style="background: linear-gradient(135deg, var(--primary) 0%, #10b981 100%); color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; cursor: pointer;">+ New</button>
                </div>
                <div id="panel-group-chats" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                    <!-- Group chats loaded here -->
                    <div style="text-align: center; padding: 15px; color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                </div>
            </div>

            <div style="height: 1px; background: #f1f5f9; margin: 0 20px;"></div>

            <!-- Friends List in Panel -->
            <div style="padding: 15px 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-main); font-weight: 600;">Friends</h4>
                    <span id="panel-friends-count" style="font-size: 0.75rem; color: var(--text-muted);">0 friends</span>
                </div>

                <!-- Coach Shannon -->
                <div onclick="openCoachChatFromFriends(); closeFeedMessagesPanel();" style="display: flex; align-items: center; padding: 10px 0; cursor: pointer; border-bottom: 1px solid #f1f5f9;">
                    <div style="position: relative; margin-right: 12px;">
                        <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--primary);">
                            <img src="assets/coach_shannon.jpg" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<span style=\'color: white; font-size: 1.1rem; font-weight: 700;\'>S</span>'">
                        </div>
                        <div style="position: absolute; bottom: 1px; right: 1px; width: 12px; height: 12px; background: #22c55e; border-radius: 50%; border: 2px solid white;"></div>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-main); font-size: 0.9rem;">Coach Shannon</div>
                        <div style="font-size: 0.75rem; color: var(--primary); font-weight: 500;">Your wellness guide</div>
                    </div>
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--text-muted);"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                </div>

                <!-- Friends list -->
                <div id="panel-friends-list" style="display: flex; flex-direction: column;">
                    <!-- Friends loaded here -->
                    <div style="text-align: center; padding: 15px; color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <style>
    @keyframes slideInFromRight {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    </style>

    <!-- Direct Message Modal -->
    <div id="direct-message-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10007; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
                <div id="dm-profile-link" onclick="if(currentDMRecipient) { closeDirectMessageModal(); viewUserProfile(currentDMRecipient.id, currentDMRecipient.name, currentDMRecipient.photo); }" style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;" title="View profile">
                    <div id="dm-recipient-photo" style="width: 44px; height: 44px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; overflow: hidden;"></div>
                    <div>
                        <div id="dm-recipient-name" style="font-weight: 700; color: var(--text-main);"></div>
                        <div id="dm-recipient-status" style="font-size: 0.8rem; color: var(--text-muted);"></div>
                    </div>
                </div>
                <button onclick="closeDirectMessageModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">×</button>
            </div>
            <!-- Messages -->
            <div id="dm-messages-container" style="height: 300px; overflow-y: auto; padding: 15px; background: #f8fafc;">
                <!-- Messages will be loaded here -->
            </div>
            <!-- Input -->
            <div style="padding: 15px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <input type="text" id="dm-input" placeholder="Type a message..." style="flex: 1; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 24px; font-size: 0.95rem; outline: none;" onkeypress="if(event.key==='Enter') sendDirectMessage()">
                <button onclick="sendDirectMessage()" style="width: 44px; height: 44px; background: var(--primary); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Coach Chat Modal -->
    <div id="coach-chat-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10007; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
                <div style="width: 44px; height: 44px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; overflow: hidden;">
                    <span style="font-size: 1.2rem;">S</span>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--text-main);">Shannon</div>
                    <div id="coach-modal-status" style="font-size: 0.8rem; color: var(--primary); font-weight: 600;">Coach</div>
                </div>
                <button onclick="closeCoachChatModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">×</button>
            </div>
            <!-- Messages -->
            <div id="chat-messages-container" style="height: 300px; overflow-y: auto; padding: 15px; background: #f8fafc;">
                <!-- Intro Message -->
                <div style="display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 15px; max-width: 85%;">
                    <div style="background: white; padding: 12px 16px; border-radius: 0 16px 16px 16px; border: 1px solid #e2e8f0; color: var(--text-main);">
                        <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Hey! I'm Shannon. Send me a message any time - I'll get a notification and reply as soon as I can!</p>
                    </div>
                    <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 4px; margin-left: 2px;">Shannon</div>
                </div>
            </div>
            <!-- Input -->
            <div style="padding: 15px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <input type="text" id="coach-chat-input" placeholder="Message Shannon..." style="flex: 1; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 24px; font-size: 0.95rem; outline: none;" onkeypress="if(event.key==='Enter') submitCoachMessage()">
                <button onclick="submitCoachMessage()" style="width: 44px; height: 44px; background: var(--primary); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Message Selector Modal (Choose who to message) -->
    <div id="message-selector-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10007; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-main);">New Message</h3>
                <button onclick="closeMessageSelectorModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">&times;</button>
            </div>
            <!-- Friend List -->
            <div id="message-selector-list" style="max-height: 400px; overflow-y: auto; padding: 10px;">
                <!-- Friends will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Rare Rewards Collection Modal -->
    <div id="rare-rewards-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10009; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <div class="modal-content" style="width: 95%; max-width: 600px; max-height: 90vh; background: white; border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <div style="padding: 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to right, #ffffff, var(--accent-green));">
                <div>
                    <h2 style="margin: 0; font-family: 'Playfair Display'; color: var(--primary);">Rare Drops</h2>
                    <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">Win these by completing Monthly Challenges</p>
                </div>
                <button onclick="closeRareRewardsModal()" style="background: #f1f5f9; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 20px; height: 20px; stroke: #64748b;" fill="none" viewBox="0 0 24 24" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 25px;">
                <!-- 3D Preview Stage -->
                <div id="rare-preview-stage" style="width: 100%; height: 300px; background: radial-gradient(circle, #f8fafc 0%, #e2e8f0 100%); border-radius: 16px; margin-bottom: 25px; position: relative;">
                    <div id="rare-preview-loading" style="display: none; position: absolute; inset: 0; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); z-index: 2; border-radius: 16px;">
                        <div class="learning-spinner"></div>
                    </div>
                    <model-viewer id="rare-reward-viewer"
                                  camera-controls
                                  auto-rotate
                                  rotation-per-second="30deg"
                                  shadow-intensity="1"
                                  environment-image="neutral"
                                  style="width: 100%; height: 100%;"
                                  loading="eager">
                    </model-viewer>
                </div>

                <div id="rare-info-panel" style="text-align: center; margin-bottom: 25px; display: none;">
                    <h3 id="rare-reward-name" style="margin: 0; color: var(--primary);">Character Name</h3>
                    <p id="rare-reward-desc" style="margin: 5px 0; font-size: 0.9rem; color: var(--text-muted);">Description</p>
                    <div id="rare-reward-status" style="display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;">LOCKED</div>
                </div>

                <div id="rares-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <!-- Rares will be injected here -->
                </div>
            </div>
            
            <div style="padding: 20px; background: #f8fafc; border-top: 1px solid #f1f5f9;">
                <button onclick="closeRareRewardsModal(); switchAppTab('dashboard');" style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">Back to Challenges</button>
            </div>
        </div>
    </div>

    <!-- Badge Collection Modal -->
    <div id="badge-collection-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 10010; align-items: center; justify-content: center; backdrop-filter: blur(12px);">
        <div style="width: 95%; max-width: 440px; max-height: 85vh; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 60px rgba(0,0,0,0.6);">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <div>
                    <h2 style="margin: 0; font-size: 1.2rem; font-weight: 800; color: white;">🏅 Badge Collection</h2>
                    <p style="margin: 4px 0 0 0; font-size: 0.72rem; color: rgba(255,255,255,0.4);">Earn badges through gameplay achievements</p>
                </div>
                <button onclick="closeBadgeModal()" style="background: rgba(255,255,255,0.08); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 18px; height: 18px; stroke: rgba(255,255,255,0.5);" fill="none" viewBox="0 0 24 24" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <!-- Badge Grid Content -->
            <div id="badge-grid-content" style="flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch;">
            </div>
            <!-- Footer -->
            <div style="padding: 14px 20px; border-top: 1px solid rgba(255,255,255,0.08); flex-shrink: 0;">
                <button onclick="closeBadgeModal()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 12px; font-size: 0.85rem; font-weight: 700; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(59,130,246,0.3);">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Challenge Modal -->
    <div id="create-challenge-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10009; align-items: center; justify-content: center; backdrop-filter: blur(6px);">
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border-radius: 24px; max-width: 420px; width: 92%; max-height: 85vh; display: flex; flex-direction: column; animation: fadeInScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(59,130,246,0.15);">
            <!-- Header -->
            <div style="text-align: center; padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;">
                <h3 style="margin: 0 0 4px; font-size: 1.3rem; font-weight: 800; color: #60a5fa; text-shadow: 0 0 20px rgba(96,165,250,0.3);">🏆 Create Challenge</h3>
                <p style="margin: 0; font-size: 0.8rem; color: rgba(255,255,255,0.6);">30-day XP battle with friends</p>
            </div>
            <!-- Content -->
            <div style="padding: 16px; overflow-y: auto; flex: 1; min-height: 0;">
                <!-- Featured Rare Preview (shown when opening from featured card) -->
                <div id="challenge-rare-preview" style="display: none; text-align: center; margin-bottom: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 16px;">
                    <model-viewer id="challenge-rare-viewer" style="width: 280px; height: 280px; margin: 0 auto; --poster-color: transparent;" auto-rotate camera-controls interaction-prompt="none" shadow-intensity="0.5"></model-viewer>
                    <div id="challenge-rare-name" style="font-size: 1.1rem; font-weight: 800; color: white; margin-top: 8px;">Character Name</div>
                    <div id="challenge-rare-tier-badge" style="display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; letter-spacing: 1.5px; margin-top: 6px; color: white;">TIER</div>
                    <div style="margin-top: 8px; font-size: 0.75rem; color: #4ade80; font-weight: 700;">GUARANTEED DROP</div>
                </div>
                <!-- Random Rare Drop Info (shown for generic challenges) -->
                <div id="challenge-random-drop-info" style="display: none; background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.2); border-radius: 14px; padding: 14px; margin-bottom: 16px; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 6px;">🎲</div>
                    <div style="font-weight: 700; color: #c084fc; font-size: 0.9rem; margin-bottom: 4px;">Random Rare Drop</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 8px;">Winner receives a random rare skin!</div>
                    <div style="display: flex; justify-content: center; gap: 6px; flex-wrap: wrap;">
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; background: rgba(107,114,128,0.3); color: #9ca3af;">COMMON 53%</span>
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; background: rgba(59,130,246,0.3); color: #60a5fa;">RARE 26%</span>
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; background: rgba(168,85,247,0.3); color: #c084fc;">EPIC 16%</span>
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; background: rgba(251,191,36,0.3); color: #fbbf24;">LEGENDARY 5%</span>
                    </div>
                </div>
                <!-- How It Works -->
                <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); border-radius: 14px; padding: 14px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: #93c5fd; font-size: 0.8rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">How It Works</div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <span style="color: #60a5fa; font-weight: 700; font-size: 0.8rem; min-width: 18px;">1.</span>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Choose your wager (min. <strong style="color: #fbbf24;">1,000 Coins</strong>). Everyone pays in.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <span style="color: #60a5fa; font-weight: 700; font-size: 0.8rem; min-width: 18px;">2.</span>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Earn <strong style="color: #4ade80;">double XP</strong> on everything for 30 days.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <span style="color: #60a5fa; font-weight: 700; font-size: 0.8rem; min-width: 18px;">3.</span>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Most <strong style="color: #c084fc;">XP</strong> at the end wins.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <span style="color: #60a5fa; font-weight: 700; font-size: 0.8rem; min-width: 18px;">4.</span>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Winner gets <strong style="color: #fbbf24;">rare drops</strong> — 3D skins &amp; badges.</span>
                        </div>
                    </div>
                </div>

                <!-- Challenge Name -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Challenge Name</label>
                    <input type="text" id="challenge-name-input" placeholder="e.g., February Grind" style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.9rem; color: white; box-sizing: border-box;">
                </div>

                <!-- Duration (fixed 30 days, shown as info) -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Duration</label>
                    <div style="padding: 10px 12px; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.9rem; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8);">30 days</div>
                    <input type="hidden" id="challenge-duration-select" value="30">
                </div>

                <!-- Start Date -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Start Date</label>
                    <input type="date" id="challenge-start-date" style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.9rem; color: white; box-sizing: border-box; color-scheme: dark;">
                </div>

                <!-- Select Friends -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Invite Friends (min. 1)</label>
                    <div id="challenge-friends-list" style="max-height: 180px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; background: rgba(255,255,255,0.04);">
                        <!-- Friends will be loaded here -->
                        <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">Loading friends...</div>
                    </div>
                    <div style="margin-top: 6px; font-size: 0.75rem; color: rgba(255,255,255,0.4);">
                        <span id="challenge-selected-count">0</span> friend(s) selected
                    </div>
                </div>

                <!-- Wager Amount Picker -->
                <div id="challenge-wager-section" style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.75rem; color: rgba(255,255,255,0.6); font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Wager Coins</span>
                        <span style="font-size: 0.7rem; color: rgba(255,255,255,0.4);">Balance: 🪙 <span class="coin-balance-sync">0</span></span>
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                        <button type="button" onclick="window._setCreateChallengeBet(1000, this)" class="create-challenge-bet-btn active" style="flex: 1; min-width: 55px; padding: 9px 4px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; color: white; font-weight: 700; font-size: 0.78rem; cursor: pointer;">🪙 1K</button>
                        <button type="button" onclick="window._setCreateChallengeBet(2500, this)" class="create-challenge-bet-btn" style="flex: 1; min-width: 55px; padding: 9px 4px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.78rem; cursor: pointer;">🪙 2.5K</button>
                        <button type="button" onclick="window._setCreateChallengeBet(5000, this)" class="create-challenge-bet-btn" style="flex: 1; min-width: 55px; padding: 9px 4px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.78rem; cursor: pointer;">🪙 5K</button>
                        <button type="button" onclick="window._setCreateChallengeBet(10000, this)" class="create-challenge-bet-btn" style="flex: 1; min-width: 55px; padding: 9px 4px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.78rem; cursor: pointer;">🪙 10K</button>
                    </div>
                    <input type="number" id="create-challenge-custom-bet" placeholder="Or enter custom amount..." min="1000" step="500" style="width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-size: 0.85rem; box-sizing: border-box;" oninput="window._setCreateChallengeBet(parseInt(this.value) || 0)">
                </div>

                <!-- Entry Fee Info -->
                <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.2); border-radius: 12px; padding: 12px 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3rem;">🪙</span>
                    <div>
                        <div style="font-weight: 700; color: #fbbf24; font-size: 0.85rem;" id="create-challenge-fee-display">10,000 Coins entry fee</div>
                        <div style="font-size: 0.72rem; color: rgba(251,191,36,0.7);">Deducted when you and your friends join</div>
                    </div>
                </div>

                <!-- Prize Info -->
                <div style="background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.2); border-radius: 12px; padding: 12px 14px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3rem;">✨</span>
                    <div>
                        <div style="font-weight: 700; color: #c084fc; font-size: 0.85rem;">Winner Gets Rare Drops!</div>
                        <div style="font-size: 0.72rem; color: rgba(192,132,252,0.7);">Exclusive 3D skins &amp; badges</div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div style="padding: 12px 16px 16px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; flex-shrink: 0;">
                <button onclick="closeCreateChallengeModal()" style="flex: 1; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; background: transparent; color: rgba(255,255,255,0.7); font-size: 0.85rem; font-weight: 600; cursor: pointer;">Cancel</button>
                <button onclick="createChallenge()" id="create-challenge-btn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 12px; font-size: 0.85rem; font-weight: 700; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(59,130,246,0.4);">Create Challenge</button>
            </div>
        </div>
    </div>

    <!-- Rare Skin Unlock Celebration Modal -->
    <div id="rare-unlock-celebration" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10020; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <div style="text-align: center; max-width: 380px; width: 92%; animation: fadeInScale 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <!-- Sparkle burst background -->
            <div id="unlock-sparkles" style="position: absolute; inset: 0; pointer-events: none; overflow: hidden;"></div>

            <!-- Victory text -->
            <div style="font-size: 1rem; font-weight: 700; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 8px;">Challenge Complete</div>
            <div id="unlock-result-text" style="font-size: 1.8rem; font-weight: 900; color: #4ade80; margin-bottom: 6px; text-shadow: 0 0 30px rgba(74,222,128,0.5);">YOU WON!</div>

            <!-- 3D Model Reveal -->
            <div style="position: relative; margin: 20px auto;">
                <div id="unlock-glow-ring" style="position: absolute; inset: -20px; border-radius: 50%; background: radial-gradient(circle, rgba(251,191,36,0.3) 0%, transparent 70%); animation: pulseGlow 2s ease-in-out infinite;"></div>
                <model-viewer id="unlock-rare-viewer" style="width: 200px; height: 200px; margin: 0 auto; position: relative; z-index: 2; --poster-color: transparent;" auto-rotate camera-controls interaction-prompt="none" shadow-intensity="0.8" auto-rotate-delay="0" rotation-per-second="40deg"></model-viewer>
            </div>

            <!-- Rare info -->
            <div id="unlock-tier-badge" style="display: inline-block; padding: 4px 14px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; letter-spacing: 2px; color: white; margin-bottom: 10px;">LEGENDARY</div>
            <div id="unlock-rare-name" style="font-size: 1.6rem; font-weight: 900; color: white; margin-bottom: 4px;">Character Name</div>
            <div id="unlock-rare-desc" style="font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-bottom: 24px;">Description</div>

            <!-- NEW badge -->
            <div style="display: inline-flex; align-items: center; gap: 6px; background: rgba(74,222,128,0.15); border: 1px solid rgba(74,222,128,0.3); border-radius: 10px; padding: 8px 16px; margin-bottom: 24px;">
                <span style="font-size: 1.2rem;">🎉</span>
                <span style="color: #4ade80; font-weight: 700; font-size: 0.85rem;">NEW RARE SKIN UNLOCKED!</span>
            </div>

            <!-- Action buttons -->
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="equipUnlockedRare()" id="unlock-equip-btn" style="padding: 14px 28px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 14px; color: white; font-weight: 700; font-size: 0.9rem; cursor: pointer; box-shadow: 0 4px 20px rgba(59,130,246,0.4); transition: transform 0.2s;">Equip Now</button>
                <button onclick="closeUnlockCelebration()" style="padding: 14px 28px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 14px; color: rgba(255,255,255,0.7); font-weight: 600; font-size: 0.9rem; cursor: pointer;">Later</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulseGlow {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.15); opacity: 1; }
        }
        @keyframes sparkleFloat {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(-120px) rotate(360deg) scale(0); opacity: 0; }
        }
        @keyframes slideReveal {
            0% { transform: scale(0.3) rotateY(180deg); opacity: 0; }
            60% { transform: scale(1.1) rotateY(10deg); opacity: 1; }
            100% { transform: scale(1) rotateY(0deg); opacity: 1; }
        }
    </style>

    <!-- Challenge Leaderboard View -->
    <div id="challenge-leaderboard-modal" style="display: none; position: fixed; inset: 0; background: #f0f7ff; z-index: 10009; overflow-y: auto;">
        <!-- Header -->
        <div style="background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10;">
            <button onclick="closeChallengeLeaderboard()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main);">&larr;</button>
            <h3 id="challenge-leaderboard-title" style="margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main);">Challenge</h3>
            <div style="width: 24px;"></div>
        </div>

        <!-- Podium Section -->
        <div style="background: linear-gradient(180deg, #e0f2fe 0%, #f0f7ff 100%); padding: 20px 15px 30px;">
            <!-- Days Remaining -->
            <div id="challenge-days-remaining" style="text-align: center; margin-bottom: 20px; font-size: 0.9rem; color: #0369a1; font-weight: 600;">
                -- days remaining
            </div>

            <!-- Podium -->
            <div id="challenge-podium" style="display: flex; justify-content: center; align-items: flex-end; gap: 8px; height: 200px;">
                <!-- 2nd Place -->
                <div id="podium-2nd" style="text-align: center; width: 100px;">
                    <div id="podium-2nd-name" style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 5px;">--</div>
                    <div id="podium-2nd-photo" style="width: 50px; height: 50px; border-radius: 50%; background: #e2e8f0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #94a3b8;">
                        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #94a3b8;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div style="background: #bfdbfe; border-radius: 8px 8px 0 0; padding: 15px 10px; height: 80px; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #1e40af;">2</div>
                        <div id="podium-2nd-pts" style="font-size: 0.75rem; font-weight: 600; color: #1e40af;">0 PTS</div>
                    </div>
                </div>

                <!-- 1st Place -->
                <div id="podium-1st" style="text-align: center; width: 110px;">
                    <div id="podium-1st-name" style="font-weight: 700; font-size: 0.9rem; color: var(--text-main); margin-bottom: 5px;">--</div>
                    <div id="podium-1st-photo" style="width: 60px; height: 60px; border-radius: 50%; background: #e2e8f0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #fbbf24;">
                        <svg viewBox="0 0 24 24" style="width: 28px; height: 28px; fill: #94a3b8;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div style="background: #93c5fd; border-radius: 8px 8px 0 0; padding: 15px 10px; height: 110px; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: #1e40af;">1</div>
                        <div id="podium-1st-pts" style="font-size: 0.85rem; font-weight: 600; color: #1e40af;">0 PTS</div>
                    </div>
                </div>

                <!-- 3rd Place -->
                <div id="podium-3rd" style="text-align: center; width: 100px;">
                    <div id="podium-3rd-name" style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 5px;">--</div>
                    <div id="podium-3rd-photo" style="width: 50px; height: 50px; border-radius: 50%; background: #e2e8f0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #d97706;">
                        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #94a3b8;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div style="background: #dbeafe; border-radius: 8px 8px 0 0; padding: 15px 10px; height: 60px; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: #1e40af;">3</div>
                        <div id="podium-3rd-pts" style="font-size: 0.75rem; font-weight: 600; color: #1e40af;">0 PTS</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Graph -->
        <div style="background: white; margin: 15px; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <h4 style="margin: 0 0 15px; font-size: 0.95rem; font-weight: 600; color: var(--text-main);">Progress Over Time</h4>
            <div id="challenge-graph-container" style="height: 200px; position: relative;">
                <canvas id="challenge-progress-chart"></canvas>
            </div>
        </div>

        <!-- Full Rankings List -->
        <div style="background: white; margin: 0 15px 15px; border-radius: 16px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <h4 style="margin: 0 0 15px; font-size: 0.95rem; font-weight: 600; color: var(--text-main);">Full Rankings</h4>
            <div id="challenge-full-rankings">
                <!-- Rankings will be loaded here -->
            </div>
        </div>

        <!-- Leave Challenge Button -->
        <div style="padding: 15px; text-align: center;">
            <button onclick="leaveCurrentChallenge()" style="background: none; border: none; color: #ef4444; font-size: 0.9rem; cursor: pointer; text-decoration: underline;">
                Leave Challenge
            </button>
        </div>
    </div>

    <!-- Challenge Buy-In Modal (Coins) - Battle Mode Style -->
    <div id="challenge-pass-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10010; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="challenge-buyin-modal">
            <div class="challenge-buyin-header">
                <h2>🏆 Challenge Mode</h2>
                <p>Bet coins &amp; earn double XP for 30 days</p>
            </div>
            <div class="challenge-buyin-body">
                <!-- Rare Reward Info (dynamically shown) -->
                <div id="challenge-pass-rare-info" style="display: none;"></div>

                <!-- Locked Entry Fee Display -->
                <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.2); border-radius: 12px; padding: 12px 14px; margin-bottom: 12px; text-align: center;">
                    <div id="challenge-pass-fee-info" style="font-weight: 700; color: #fbbf24; font-size: 1rem;">🪙 10,000 Coins entry fee</div>
                    <div style="font-size: 0.7rem; color: rgba(251,191,36,0.6); margin-top: 2px;">Matches the challenger's entry fee</div>
                </div>

                <!-- Benefits -->
                <div class="challenge-buyin-benefits">
                    <div class="challenge-buyin-benefit">
                        <span class="check">✓</span>
                        <span class="text">Double XP on all activities for 30 days</span>
                    </div>
                    <div class="challenge-buyin-benefit">
                        <span class="check">✓</span>
                        <span class="text">Winner gets exclusive rare drops</span>
                    </div>
                    <div class="challenge-buyin-benefit">
                        <span class="check">✓</span>
                        <span class="text">All participants get a reward</span>
                    </div>
                </div>

                <!-- Coin Bet Picker (hidden — accepter must match creator's fee) -->
                <div class="challenge-bet-picker" style="padding: 10px 0 14px; display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.8rem; color: rgba(255,255,255,0.6); font-weight: 600;">WAGER COINS (min. 1,000)</span>
                        <span style="font-size: 0.75rem; color: rgba(255,255,255,0.4);">Balance: 🪙 <span id="challenge-modal-coin-balance">0</span></span>
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <button onclick="window._setChallengeBet(1000, this)" class="challenge-bet-btn active">🪙 1K</button>
                        <button onclick="window._setChallengeBet(2500, this)" class="challenge-bet-btn">🪙 2.5K</button>
                        <button onclick="window._setChallengeBet(5000, this)" class="challenge-bet-btn">🪙 5K</button>
                        <button onclick="window._setChallengeBet(10000, this)" class="challenge-bet-btn">🪙 10K</button>
                    </div>
                    <div style="margin-top: 8px;">
                        <input type="number" id="challenge-custom-bet" placeholder="Or enter custom amount (min 1,000)..." min="1000" step="500" style="width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-size: 0.85rem; box-sizing: border-box;" oninput="window._setChallengeBet(parseInt(this.value) || 0)">
                    </div>
                </div>
            </div>
            <div class="challenge-buyin-footer">
                <button id="buy-challenge-pass-btn" onclick="spendCoinsToJoinChallenge()" class="challenge-buyin-join-btn">
                    Spend 🪙 1,000 Coins &amp; Join
                </button>
                <button onclick="openCoinShop(); closeChallengePassModal();" class="challenge-buyin-secondary-btn">
                    Need more coins? Buy here
                </button>
                <button onclick="closeChallengePassModal()" class="challenge-buyin-cancel">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Coin Shop Modal -->
    <div id="coin-shop-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10010; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 24px; max-width: 420px; width: 92%; padding: 0; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); padding: 20px; text-align: center; position: relative;">
                <button onclick="closeCoinShop()" style="position: absolute; top: 12px; right: 16px; background: none; border: none; font-size: 1.5rem; color: rgba(255,255,255,0.8); cursor: pointer;">&times;</button>
                <span style="font-size: 2.5rem;">🪙</span>
                <h3 style="margin: 8px 0 4px; font-size: 1.3rem; font-weight: 700; color: white; font-family: 'Montserrat', sans-serif;">Coin Shop</h3>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.9);">Your balance: <strong id="coin-shop-balance">0</strong> coins</div>
            </div>
            <!-- Packs -->
            <div style="padding: 20px; display: flex; flex-direction: column; gap: 10px;">
                <!-- Starter -->
                <div onclick="buyCoinPack('starter')" class="coin-pack-option" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">500 Coins</div>
                        <div style="font-size: 0.78rem; color: var(--text-muted);">Starter Pack</div>
                    </div>
                    <div style="background: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;">$4.99</div>
                </div>
                <!-- Popular -->
                <div onclick="buyCoinPack('popular')" class="coin-pack-option" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #fffbeb; border: 2px solid #fbbf24; border-radius: 12px; cursor: pointer; transition: all 0.2s; position: relative;">
                    <div style="position: absolute; top: -8px; right: 12px; background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700;">BEST VALUE</div>
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">1,200 Coins</div>
                        <div style="font-size: 0.78rem; color: #f59e0b; font-weight: 600;">+20% bonus</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;">$9.99</div>
                </div>
                <!-- Pro -->
                <div onclick="buyCoinPack('pro')" class="coin-pack-option" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">2,800 Coins</div>
                        <div style="font-size: 0.78rem; color: #16a34a; font-weight: 600;">+40% bonus</div>
                    </div>
                    <div style="background: #16a34a; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;">$19.99</div>
                </div>
                <!-- Ultimate -->
                <div onclick="buyCoinPack('ultimate')" class="coin-pack-option" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: linear-gradient(135deg, #eff6ff, #e0e7ff); border: 2px solid #818cf8; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">8,000 Coins</div>
                        <div style="font-size: 0.78rem; color: #6366f1; font-weight: 600;">+60% bonus</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #6366f1, #7c3aed); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;">$49.99</div>
                </div>
            </div>
            <!-- Restore Purchases (native only) -->
            <div id="restore-purchases-row" style="display: none; padding: 0 20px 10px; text-align: center;">
                <button onclick="restoreIAPPurchases()" style="background: none; border: none; color: var(--primary); font-size: 0.82rem; cursor: pointer; text-decoration: underline; font-weight: 600;">Restore Purchases</button>
            </div>
            <!-- What coins are for -->
            <div style="padding: 0 20px 20px;">
                <div style="background: #f8fafc; border-radius: 10px; padding: 12px 14px;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px;">SPEND COINS ON</div>
                    <div style="display: flex; gap: 12px; font-size: 0.78rem; color: var(--text-main); flex-wrap: wrap;">
                        <span>🏆 Challenges</span>
                        <span>⚔️ Battle Bets</span>
                        <span>🎭 Characters</span>
                        <span>✨ Cosmetics</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Chat Modal -->
    <div id="group-chat-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10010; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 85vh; overflow: hidden; animation: fadeInScale 0.3s ease-out; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
                <div id="gc-chat-icon" style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">💬</div>
                <div style="flex: 1;">
                    <div id="gc-chat-name" style="font-weight: 700; color: var(--text-main);"></div>
                    <div id="gc-chat-members" style="font-size: 0.8rem; color: var(--text-muted);"></div>
                </div>
                <button onclick="closeGroupChatModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">×</button>
            </div>
            <!-- Messages -->
            <div id="gc-messages-container" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; min-height: 300px; max-height: 400px;">
                <!-- Messages will be loaded here -->
            </div>
            <!-- Share Win Button -->
            <div style="padding: 10px 15px; background: #f1f5f9; border-top: 1px solid #e2e8f0;">
                <button onclick="openShareWinInChat()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #f59e0b, #eab308); color: white; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 1.1rem;">🎉</span> Share a Win
                </button>
            </div>
            <!-- Input -->
            <div style="padding: 15px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <input type="text" id="gc-message-input" placeholder="Type a message..." style="flex: 1; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 24px; font-size: 0.95rem; outline: none;" onkeypress="if(event.key==='Enter') sendGroupChatMessage()">
                <button onclick="sendGroupChatMessage()" style="width: 44px; height: 44px; background: var(--primary); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Create Group Chat Modal -->
    <div id="create-group-chat-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10011; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 85vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-main);">New Group Chat</h3>
                <button onclick="closeCreateGroupChatModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">&times;</button>
            </div>
            <!-- Content -->
            <div style="padding: 20px; overflow-y: auto; max-height: calc(85vh - 140px);">
                <!-- Group Name -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px;">Group Name</label>
                    <input type="text" id="new-group-name" placeholder="e.g., Workout Squad" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; box-sizing: border-box;">
                </div>

                <!-- Select Friends -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px;">Add Friends</label>
                    <div id="group-friends-list" style="max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px;">
                        <!-- Friends will be loaded here -->
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading friends...</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                        <span id="group-selected-count">0</span> friend(s) selected
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div style="padding: 15px 20px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <button onclick="closeCreateGroupChatModal()" style="flex: 1; padding: 12px; background: #f1f5f9; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); cursor: pointer;">Cancel</button>
                <button onclick="createGroupChat()" id="create-group-btn" style="flex: 1; padding: 12px; background: var(--primary); border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; color: white; cursor: pointer;">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Share Win in Chat Modal -->
    <div id="share-win-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10012; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 85vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);">
                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: white; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.3rem;">🎉</span> Share a Win
                </h3>
                <button onclick="closeShareWinModal()" style="background: rgba(255,255,255,0.2); border: none; font-size: 1.2rem; color: white; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <!-- Content -->
            <div style="padding: 20px; overflow-y: auto; max-height: calc(85vh - 140px);">
                <!-- Win Type Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 12px;">What type of win?</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="selectWinType('workout_complete')" id="win-type-workout" class="win-type-btn" style="padding: 16px; background: #dcfce7; border: 2px solid var(--primary); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.8rem; margin-bottom: 6px;">💪</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Workout Done</div>
                        </button>
                        <button onclick="selectWinType('personal_best')" id="win-type-pb" class="win-type-btn" style="padding: 16px; background: #f1f5f9; border: 2px solid transparent; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.8rem; margin-bottom: 6px;">🏆</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Personal Best</div>
                        </button>
                        <button onclick="selectWinType('milestone')" id="win-type-milestone" class="win-type-btn" style="padding: 16px; background: #f1f5f9; border: 2px solid transparent; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.8rem; margin-bottom: 6px;">🌟</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Milestone</div>
                        </button>
                        <button onclick="selectWinType('custom')" id="win-type-custom" class="win-type-btn" style="padding: 16px; background: #f1f5f9; border: 2px solid transparent; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.8rem; margin-bottom: 6px;">✨</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Other Win</div>
                        </button>
                    </div>
                </div>

                <!-- Workout Details (shown for workout_complete and personal_best) -->
                <div id="win-workout-details" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px;">Details (optional)</label>
                    <input type="text" id="win-workout-name" placeholder="e.g., Upper Body Strength" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; box-sizing: border-box; margin-bottom: 10px;">
                    <input type="text" id="win-improvement" placeholder="e.g., +5kg on bench press" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; box-sizing: border-box;">
                </div>

                <!-- Message -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px;">Your Message</label>
                    <textarea id="win-message-input" placeholder="Tell the group about your win!" rows="3" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; box-sizing: border-box; resize: none; font-family: inherit;"></textarea>
                </div>

                <!-- Quick Messages -->
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <button onclick="setWinMessage('Just crushed my workout! 💪')" style="padding: 8px 12px; background: #f1f5f9; border: none; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); cursor: pointer;">Just crushed it! 💪</button>
                    <button onclick="setWinMessage('New personal best! 🏆')" style="padding: 8px 12px; background: #f1f5f9; border: none; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); cursor: pointer;">New PB! 🏆</button>
                    <button onclick="setWinMessage('Feeling stronger! 🌟')" style="padding: 8px 12px; background: #f1f5f9; border: none; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); cursor: pointer;">Feeling strong! 🌟</button>
                </div>
            </div>
            <!-- Footer -->
            <div style="padding: 15px 20px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <button onclick="closeShareWinModal()" style="flex: 1; padding: 12px; background: #f1f5f9; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); cursor: pointer;">Cancel</button>
                <button onclick="sendWinToChat()" id="submit-win-btn" style="flex: 2; padding: 12px; background: linear-gradient(135deg, #f59e0b, #eab308); border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>Share to Group</span>
                    <span style="font-size: 1.1rem;">🎉</span>
                </button>
                <button onclick="shareWinExternally()" id="external-win-share-btn" title="Share card externally" style="width: 50px; padding: 12px; background: #0084FF; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: white;"><path d="M12 2C6.477 2 2 6.145 2 11.258c0 2.908 1.462 5.501 3.753 7.216V22l3.363-1.846c.854.237 1.762.365 2.701.365 5.523 0 10-4.145 10-9.258C22 6.145 17.523 2 12 2zm1.066 11.968l-2.585-2.754-5.044 2.754 5.548-5.89 2.663 2.754 4.965-2.754-5.547 5.89z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- PROGRESS / ANALYTICS VIEW -->
    <div id="view-progress" class="app-view" style="display:none; min-height: 100vh; height: auto; background: #f8fafc; z-index: 100000; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; overflow-y: auto; overflow-x: hidden;">
        <!-- Header with back button -->
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <div style="width: 40px;"></div>
            <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Your Progress</div>
            <div style="width: 40px;"></div>
        </div>

        <!-- Progress Content Container -->
        <div id="progress-content" style="padding: 0;">
            <!-- Loading State -->
            <div id="progress-loading" style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 2rem; margin-bottom: 10px;">📊</div>
                <div style="color: var(--text-muted);">Loading your progress...</div>
            </div>

            <!-- Main Content (Hidden Initially) -->
            <div id="progress-main-content" style="display: none;">

                <!-- Exercise Progress Selection Top -->
                <div style="padding: 20px 20px 10px 20px;">
                    <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: var(--card-shadow); border: 1px solid var(--accent-green); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -10px; right: -10px; font-size: 4rem; opacity: 0.05; transform: rotate(15deg);">📊</div>
                        <h3 style="font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 12px 0;">Track Progress</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="flex: 1; position: relative;">
                                <select id="exercise-selection-dropdown" onchange="if(this.value) showExerciseDetailChart(this.value, window.currentUser.id)" style="width: 100%; padding: 14px 16px; border-radius: 12px; border: 1.5px solid #e2e8f0; font-size: 0.95rem; font-family: inherit; appearance: none; background: white; cursor: pointer; color: var(--text-main);">
                                    <option value="">Select an exercise...</option>
                                    <!-- Populated by JS -->
                                </select>
                                <div style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted);">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.75rem; color: var(--text-muted);">Select any exercise to view your strength history</div>
                    </div>
                </div>

                <!-- Personal Bests Section -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">
                        <span style="color: #f59e0b;">🏆</span> Personal Bests
                    </h3>
                    <div id="personal-bests-container">
                        <!-- Recent PBs will appear here -->
                        <div id="recent-pbs-list" style="display: none; margin-bottom: 15px;">
                            <!-- Populated by JS - shows recent PB achievements -->
                        </div>
                        <!-- All-time PBs grid -->
                        <div id="personal-bests-list" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <!-- Populated by JS -->
                            <div style="grid-column: span 2; text-align: center; padding: 30px 20px; color: var(--text-muted);">
                                <div style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;">🏋️</div>
                                <div style="font-size: 0.9rem;">Complete workouts with weights to track your personal bests!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Body Weight Graph -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">
                        <span style="color: #7BA883;">&#9878;</span> Body Weight
                    </h3>
                    <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow);">
                        <div id="bodyweight-graph">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Progress Photos Timeline -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">
                        <span style="color: #ec4899;">📸</span> Progress Photos
                    </h3>
                    <div id="progress-photos-container" style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow);">
                        <!-- Populated by JS -->
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- EXERCISE CHART MODAL -->
    <div id="exercise-chart-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="padding: 20px 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; border-radius: 20px 20px 0 0; z-index: 1;">
                <h3 id="exercise-chart-title" style="margin: 0; font-family: 'Playfair Display'; color: var(--primary); font-size: 1.3rem;">Exercise Progress</h3>
                <button onclick="closeExerciseChartModal()" style="background: transparent; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 5px; line-height: 1;">&times;</button>
            </div>

            <!-- Modal Content -->
            <div id="exercise-chart-content">
                <!-- Chart will be rendered here -->
            </div>
        </div>
    </div>

    <!-- LEARNING / EDUCATION VIEW -->
    <div id="view-learning" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc;">
        <!-- Header -->
        <div style="padding: 20px 25px; background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
            <div>
                <h2 style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.5rem;">Learn</h2>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="coin-header-widget" onclick="openCoinShop()">
                    <span class="coin-emoji">🪙</span>
                    <span class="coin-amount coin-balance-sync">0</span>
                    <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
                </div>
                <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
            </div>
        </div>

        <!-- Learning Content Container -->
        <div id="learning-content" style="padding: 0;">
            <!-- Content rendered by learning.js -->
            <div style="text-align: center; padding: 60px 20px;">
                <div class="learning-spinner"></div>
                <div style="color: var(--text-muted); margin-top: 15px;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- CALENDAR / CYCLE VIEW -->
    <!-- CYCLE / HORMONE HUB VIEW -->
    <div id="view-cycle" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc;">
        <!-- Header -->
        <div style="padding: 20px 25px; background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
            <div>
                <h2 style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.5rem;">Hormone Hub</h2>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="coin-header-widget" onclick="openCoinShop()">
                    <span class="coin-emoji">🪙</span>
                    <span class="coin-amount coin-balance-sync">0</span>
                    <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
                </div>
                <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
            </div>
        </div>

        <!-- Cycle Wheel / Hero Card -->
        <div style="padding: 25px;">
            <div id="cycle-hero-card" class="card" style="background: linear-gradient(135deg, var(--bg) 0%, var(--accent-green) 100%); border: 1px solid var(--secondary); box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1); overflow: visible;">
                <div class="card-body active" style="opacity:1; max-height:none; padding: 30px 25px; text-align: center;">

                    <!-- Phase Indicator Ring (CSS Only) -->
                    <div style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--secondary); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; position: relative; background: white; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);">
                         <!-- Dynamic progress border would go here -->
                         <div style="font-size: 2.5rem;">🌸</div>
                         <div style="position: absolute; bottom: -10px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">Day <span id="cycle-day-display">--</span></div>
                    </div>

                    <h2 id="cycle-phase-name" style="color: var(--primary); margin: 0 0 10px 0; font-family: 'Playfair Display'; font-size: 1.8rem;">Loading...</h2>
                    <p id="cycle-phase-desc" style="color: var(--text-main); font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px;">Tracking your cycle helps predict your energy.</p>

                    <!-- Phase Tags -->
                    <div id="cycle-phase-tags" style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Cycle Sync Check-in Button -->
            <div id="check-in-prompt-card" onclick="openCheckInModal()" style="margin-top: 20px; background: white; border: 1px solid var(--primary); color: var(--primary); padding: 20px; border-radius: 16px; font-weight: 600; text-align: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div style="font-size: 1.5rem;">✨</div>
                <div style="text-align: left;">
                    <div style="font-size: 1.05rem; color: var(--primary);">Daily Check-in</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 400;">Unlock your daily cycle sync</div>
                </div>
                <div style="margin-left: auto; background: var(--primary); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">→</div>
            </div>
            
            <!-- Check-in Completed State (Hidden by default) -->
            <div id="check-in-completed-card" style="display: none; margin-top: 20px; background: #F0FDF4; border: 1px solid #BBF7D0; color: #166534; padding: 20px; border-radius: 16px; text-align: center;">
                <div style="font-size: 1.5rem; margin-bottom: 5px;">✅</div>
                <div style="font-weight: 700;">Cycle Sync Active!</div>
                <div style="font-size: 0.85rem; margin-top: 5px;">Your dashboard has been updated.</div>
            </div>

        </div>

        <!-- Weekly/Monthly Calendar -->
        <div style="padding: 0 25px 25px 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--primary); margin: 0; font-size: 1.1rem;">Your Predictions</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="calendar-view-toggle" id="calendar-view-toggle">
                        <button class="toggle-btn active" data-view="weekly" onclick="switchCalendarView('weekly')">Week</button>
                        <button class="toggle-btn" data-view="monthly" onclick="switchCalendarView('monthly')">Month</button>
                    </div>
                    <span onclick="switchAppTab('profile')" style="font-size: 0.8rem; color: var(--secondary); cursor: pointer; font-weight: 600;">Edit Dates</span>
                </div>
            </div>

            <div id="weekly-calendar" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Calendar rows inserted via JS -->
            </div>

            <div id="monthly-calendar" style="display: none;">
                <!-- Monthly calendar grid inserted via JS -->
            </div>
        </div>
    </div>

    <style>
        .mood-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mood-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .calendar-day-row {
            display: flex;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid #eee;
        }
        .calendar-day-row.is-today {
            border: 2px solid var(--secondary);
            background: #fffbf0;
        }
        .cal-date-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 45px;
            border-right: 1px solid #eee;
            padding-right: 15px;
        }
        .cal-day-name { font-size: 0.75em; color: #888; text-transform: uppercase; font-weight: 700; }
        .cal-day-num { font-weight: 700; font-size: 1.25em; color: var(--primary); }
        
        .cal-context {
            flex: 1;
        }
        .cal-workout-tag {
            background: var(--surface);
            color: var(--primary);
            font-size: 0.85em;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
            border: 1px solid #eee;
        }
        .cal-phase-dot {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px;
        }
        
        .cycle-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .cycle-settings input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
        }

        /* Calendar View Toggle */
        .calendar-view-toggle {
            display: flex;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 3px;
        }
        .calendar-view-toggle .toggle-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            font-size: 0.8rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .calendar-view-toggle .toggle-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Monthly Calendar Grid */
        .monthly-calendar-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #eee;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .monthly-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-bottom: 1px solid #eee;
        }
        .monthly-calendar-header .month-nav-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
            color: var(--primary);
            border-radius: 6px;
            transition: background 0.2s;
        }
        .monthly-calendar-header .month-nav-btn:hover {
            background: #eee;
        }
        .monthly-calendar-header .month-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
        }
        .monthly-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #fafafa;
            border-bottom: 1px solid #eee;
        }
        .monthly-calendar-weekdays span {
            padding: 10px 5px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
        }
        .monthly-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #f1f5f9;
        }
        .monthly-day-cell {
            background: white;
            min-height: 65px;
            padding: 6px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        .monthly-day-cell:hover {
            background: #fefce8;
        }
        .monthly-day-cell.other-month {
            background: #fafafa;
            color: #cbd5e1;
        }
        .monthly-day-cell.other-month:hover {
            background: #f5f5f5;
        }
        .monthly-day-cell.is-today {
            background: #fffbeb;
            border: 2px solid var(--secondary);
        }
        .monthly-day-num {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 4px;
        }
        .monthly-day-cell.other-month .monthly-day-num {
            color: #cbd5e1;
        }
        .monthly-phase-indicator {
            position: absolute;
            bottom: 4px;
            left: 4px;
            right: 4px;
            height: 4px;
            border-radius: 2px;
        }
        .monthly-workout-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary);
            display: inline-block;
            margin-top: 2px;
        }
        .monthly-day-workout {
            font-size: 0.6rem;
            color: #64748b;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 2px;
        }
    </style>

    <!-- PROFILE VIEW -->
    <div id="view-profile" class="app-view" style="display:none; padding-bottom: 80px;">
        <div class="app-header">
            <div class="app-logo">Your Profile</div>
            <div style="width:35px;"></div> <!-- Spacer -->
        </div>

        <div class="profile-header">
            <!-- Robust Profile Photo: Text S is background, IMG overlays it -->
            <div class="profile-photo-container" style="display:flex; align-items:center; justify-content:center; background:var(--accent-green); overflow:hidden;">
                <span id="profile-default-initial" style="font-size:3rem; font-weight:700; color:var(--primary);">S</span>
                <img src="" class="profile-photo" id="profile-photo-img" style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:50%; object-fit:cover;" onerror="this.style.opacity=0" onload="this.style.opacity=1">
                
                <label for="profile-photo-input" class="photo-edit-btn">
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:white;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </label>
                <input type="file" id="profile-photo-input" accept="image/*" style="display:none;" onchange="handlePhotoUpload(this)">
            </div>
            <h2 class="profile-name-large" id="profile-name-display">Shannon</h2>
            <div class="profile-email" id="profile-email-display">Loading...</div>
        </div>

        <!-- Basic Stats Row -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; padding: 0 25px; margin-bottom: 25px;">
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Age</div>
                <div id="profile-age-display" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">34</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Weight</div>
                <div id="profile-weight-display" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">68 kg</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Goal</div>
                <div id="profile-goal-display" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Fat Loss</div>
            </div>
        </div>

        <!-- Professional Protocol Settings -->
        <div class="settings-card" style="margin: 0 25px 25px 25px; background: white; border-radius: 16px; border: 1px solid #f1f5f9; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
            <div style="background: #f8fafc; padding: 15px 20px; border-bottom: 1px solid #e2e8f0;">
                <h3 style="margin:0; font-size: 0.95rem; color: var(--text-main); display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <span>🧬</span> Metabolic Protocol
                </h3>
            </div>
            <div style="padding: 0;">
                <!-- Energy Level - Read Only -->
                <div class="setting-row" style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div id="profile-type-label" style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Energy Level</div>
                        <div id="profile-type-desc" style="font-size: 0.8rem; color: var(--text-muted);">From your onboarding quiz</div>
                    </div>
                    <div id="profile-type-display" style="font-weight: 700; color: var(--primary);"></div>
                </div>

                <!-- Equipment - Read Only, updated via daily check-in -->
                <div class="setting-row" style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                     <div>
                        <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Equipment Access</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Updated via daily check-in</div>
                    </div>
                    <div id="profile-equipment-display" style="font-weight: 700; color: var(--primary);">No Equipment</div>
                </div>

                <!-- Dietary Preference -->
                <div class="setting-row" style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                     <div>
                        <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Dietary Preference</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">From your onboarding setup</div>
                    </div>
                    <div id="profile-diet-display" style="font-weight: 700; color: var(--primary);">Not set</div>
                </div>

                <!-- Symptoms -->
                <div class="setting-row" style="padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                     <div>
                        <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Active Symptoms</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">From your latest check-in</div>
                    </div>
                    <div id="profile-symptoms-display" style="font-weight: 700; color: var(--primary); max-width: 50%; text-align: right; font-size: 0.9rem;">None</div>
                </div>
            </div>
        </div>

        <!-- Hidden inputs for cycle tracking (used by existing JavaScript) -->
        <input type="date" id="last-period-input-profile" style="display:none;">
        <input type="number" id="cycle-length-input-profile" value="28" style="display:none;">
        <input type="checkbox" id="no-period-toggle-profile" style="display:none;">

        <div style="text-align:center; margin-top:20px;">
            <button id="btn-edit-profile" onclick="toggleProfileEditMode()" style="background:#f1f5f9; color:var(--text-main); border:none; padding:10px 24px; border-radius:30px; font-weight:600; font-size:0.9rem; cursor:pointer; display:inline-flex; align-items:center; gap:8px;">
                <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:currentColor;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                Edit Profile
            </button>
            <button id="btn-save-profile" onclick="saveProfileChanges()" style="background:var(--primary); color:white; border:none; padding:10px 24px; border-radius:30px; font-weight:600; font-size:0.9rem; cursor:pointer; display:none; align-items:center; gap:8px;">
                Save Changes
            </button>
        </div>

        <!-- Manual Quiz/Check-in Triggers -->
        <div style="margin-top:30px; padding:20px; background:#f8fafc; border-radius:12px;">
            <h3 style="margin:0 0 15px 0; font-size:1rem; color:var(--text-main);">Health Tools</h3>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button onclick="initOnboardingWizard()" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>🌸</span> Restart Onboarding Setup
                </button>
                <button onclick="recalculateCalories()" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>🔄</span> Recalculate My Calories
                </button>
                <button onclick="checkDailyWellness(true)" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>☀️</span> Daily Wellness Check-in
                </button>
                <button onclick="openCycleTrackingModal()" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>🌸</span> Cycle Tracking
                </button>
                <button id="settings-allocate-stats-btn" onclick="showStatAllocationModal()" style="display:none; background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; align-items:center; justify-content:center; gap:8px;">
                    <span>⚔️</span> Allocate Battle Stats
                </button>
            </div>
        </div>

        <!-- APP SETTINGS -->
        <h3 style="padding: 0 25px; margin-bottom: 20px; display:flex; align-items:center; gap:10px;">
            <!-- Regular Settings Gear Icon -->
            <svg id="settings-icon-gear" class="settings-icon-gear" viewBox="0 0 24 24" style="width:24px; height:24px; fill:var(--text-main);"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.73,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            <!-- Dragon Ball Icon (for DBZ themes) -->
            <img id="settings-icon-dragonball" class="settings-icon-dragonball" src="assets/dragon-ball.svg" alt="Dragon Ball" style="width:24px; height:24px; vertical-align:middle;" />
            <!-- Sailor Moon Icon (for Sailor Moon themes) -->
            <img id="settings-icon-sailormoon" class="settings-icon-sailormoon" src="assets/sailor-moon.svg" alt="Sailor Moon" style="width:24px; height:24px; vertical-align:middle;" />
            Settings
        </h3>
        <div style="padding: 0 25px; margin-bottom: 30px;">
            <div style="background:white; border-radius:12px; border:1px solid #f1f5f9; overflow:hidden;">
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>Color Theme</div>
                     <select id="theme-selector" onchange="applyAppTheme(this.value)" style="border:1px solid #e2e8f0; padding:5px 10px; border-radius:8px; color:var(--primary); font-weight:600; outline:none; background:transparent; font-family: 'Inter', sans-serif; cursor: pointer;">
                         <option value="default">Forest (Original)</option>
                         <option value="antigravity-light">Antigravity Light</option>
                         <option value="ocean">Ocean Calm</option>
                         <option value="sunset">Sunset Glow</option>
                         <option value="cycle-pink" class="female-only-theme">Cycle Harmony</option>
                         <option value="flower-garden" class="female-only-theme">Flower Garden</option>
                         <option value="sailor-moon" class="female-only-theme">Moon Princess</option>
                         <option value="sailor-venus" class="female-only-theme">Goddess of Love</option>
                         <option value="monochrome">Monochrome</option>
                         <option value="dbz-warrior" class="male-only-theme">Super Saiyan</option>
                         <option value="dbz-vegeta" class="male-only-theme">Saiyan Prince</option>
                     </select>
                     <script>
                         // Initialize theme selector with saved value immediately
                         (function() {
                             var savedTheme = localStorage.getItem('userThemePreference') || 'default';
                             var selector = document.getElementById('theme-selector');
                             if (selector) selector.value = savedTheme;
                         })();
                     </script>
                 </div>
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>Units</div>
                     <div style="font-size:0.9rem; font-weight:700; color:var(--primary); cursor:pointer;" onclick="alert('Units toggled (Simulation)')">Metric (kg)</div>
                 </div>
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>
                         <div>Notifications</div>
                         <div style="font-size:0.75rem; color:var(--text-muted);">Coach message alerts</div>
                     </div>
                     <label class="toggle-switch" style="display:inline-block; width:40px; height:24px; position:relative;">
                         <input type="checkbox" id="user-notifications-toggle" checked onchange="toggleUserNotifications(this.checked)">
                         <span style="position:absolute; inset:0; background:#ccc; border-radius:24px; transition:0.3s;" class="slider"></span>
                         <span style="position:absolute; top:2px; left:2px; width:20px; height:20px; background:white; border-radius:50%; transition:0.3s;" class="knob"></span>
                     </label>
                     <style> input:checked + .slider { background: var(--primary) !important; } input:checked + .slider + .knob { transform: translateX(16px); } </style>
                 </div>
                 <!-- Meal Reminders Settings -->
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9;">
                     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                         <div>
                             <div>Meal Reminders</div>
                             <div style="font-size:0.75rem; color:var(--text-muted);">Get reminded to log your meals</div>
                         </div>
                         <label class="toggle-switch" style="display:inline-block; width:40px; height:24px; position:relative;">
                             <input type="checkbox" id="meal-reminders-toggle" onchange="toggleMealReminders(this.checked)">
                             <span style="position:absolute; inset:0; background:#ccc; border-radius:24px; transition:0.3s;" class="slider"></span>
                             <span style="position:absolute; top:2px; left:2px; width:20px; height:20px; background:white; border-radius:50%; transition:0.3s;" class="knob"></span>
                         </label>
                     </div>
                     <!-- Reminder Time Settings (shown when reminders enabled) -->
                     <div id="meal-reminder-times" style="display:none; margin-top:12px; padding:12px; background:#f8f9fa; border-radius:10px;">
                         <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                             <label style="font-size:0.9rem; display:flex; align-items:center; gap:8px;">
                                 <input type="checkbox" id="breakfast-reminder-check" checked onchange="saveMealReminderSettings()">
                                 <span>Breakfast</span>
                             </label>
                             <input type="time" id="breakfast-reminder-time" value="08:00" onchange="saveMealReminderSettings()" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px; font-size:0.85rem;">
                         </div>
                         <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                             <label style="font-size:0.9rem; display:flex; align-items:center; gap:8px;">
                                 <input type="checkbox" id="lunch-reminder-check" checked onchange="saveMealReminderSettings()">
                                 <span>Lunch</span>
                             </label>
                             <input type="time" id="lunch-reminder-time" value="12:30" onchange="saveMealReminderSettings()" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px; font-size:0.85rem;">
                         </div>
                         <div style="display:flex; align-items:center; justify-content:space-between;">
                             <label style="font-size:0.9rem; display:flex; align-items:center; gap:8px;">
                                 <input type="checkbox" id="dinner-reminder-check" checked onchange="saveMealReminderSettings()">
                                 <span>Dinner</span>
                             </label>
                             <input type="time" id="dinner-reminder-time" value="18:30" onchange="saveMealReminderSettings()" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px; font-size:0.85rem;">
                         </div>
                         <p style="margin:12px 0 0 0; font-size:0.75rem; color:var(--text-muted);">Reminders sent ~1 hour after meal time if not logged</p>
                     </div>
                 </div>
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>
                         <div>Add Friend</div>
                         <div style="font-size:0.75rem; color:var(--text-muted);">Search and connect with friends</div>
                     </div>
                     <button onclick="openAddFriendModal()" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px;">
                         <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:white;"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                         Add
                     </button>
                 </div>
                 <div style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>
                         <div>Invite a Friend</div>
                         <div style="font-size:0.75rem; color:var(--text-muted);">You both get 1 week double XP</div>
                     </div>
                     <button onclick="openShareReferralModal()" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px;">
                         <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:white;"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                         Share
                     </button>
                 </div>
                <!-- Fitbit Connection -->
                <div id="settings-fitbit-connect" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:#00B0B9;"><circle cx="12" cy="4" r="2.5"/><circle cx="12" cy="9.5" r="2.5"/><circle cx="12" cy="15" r="2"/><circle cx="12" cy="19.5" r="1.5"/><circle cx="7" cy="9.5" r="1.5"/><circle cx="17" cy="9.5" r="1.5"/></svg>
                            Fitbit
                        </div>
                        <div id="fitbit-status-text" style="font-size:0.75rem; color:var(--text-muted);">Sync steps, sleep & heart rate</div>
                    </div>
                    <button id="fitbit-connect-btn" onclick="toggleFitbitConnection()" style="padding:8px 16px; border-radius:8px; border:none; background:#00B0B9; color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Connect
                    </button>
                </div>
                <!-- WHOOP Connection -->
                <div id="settings-whoop-connect" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:#1a1a1a;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            WHOOP
                        </div>
                        <div id="whoop-status-text" style="font-size:0.75rem; color:var(--text-muted);">Sync recovery, strain & sleep</div>
                    </div>
                    <button id="whoop-connect-btn" onclick="toggleWhoopConnection()" style="padding:8px 16px; border-radius:8px; border:none; background:#1a1a1a; color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Connect
                    </button>
                </div>
                <!-- Oura Ring Connection -->
                <div id="settings-oura-connect" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:#c4a862;"><circle cx="12" cy="12" r="9" stroke="#c4a862" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="5" stroke="#c4a862" stroke-width="1.5" fill="none"/></svg>
                            Oura Ring
                        </div>
                        <div id="oura-status-text" style="font-size:0.75rem; color:var(--text-muted);">Sync readiness, sleep & activity</div>
                    </div>
                    <button id="oura-connect-btn" onclick="toggleOuraConnection()" style="padding:8px 16px; border-radius:8px; border:none; background:#c4a862; color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Connect
                    </button>
                </div>
                <!-- Strava Connection -->
                <div id="settings-strava-connect" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:#FC4C02;"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                            Strava
                        </div>
                        <div id="strava-status-text" style="font-size:0.75rem; color:var(--text-muted);">Sync workouts, runs & rides</div>
                    </div>
                    <button id="strava-connect-btn" onclick="toggleStravaConnection()" style="padding:8px 16px; border-radius:8px; border:none; background:#FC4C02; color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Connect
                    </button>
                </div>
                <!-- Download App (hidden if already installed as PWA) -->
                <div id="settings-download-app" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div>Download App</div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">Install for the best experience</div>
                    </div>
                    <button class="pwa-install-btn" onclick="installPWA(this)" data-original-text="Install" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Install
                    </button>
                </div>
                <!-- Admin Notifications (only visible to admins) -->
                <div id="admin-notifications-setting" style="padding:15px; border-top:1px solid #f1f5f9; display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div>Coach Notifications</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">Get notified when users message</div>
                        </div>
                        <button id="admin-notif-btn" onclick="toggleAdminNotifications()" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer;">
                            Enable
                        </button>
                    </div>
                </div>
                <!-- Admin Board (only visible to admins) -->
                <div id="admin-board-setting" style="padding:15px; border-top:1px solid #f1f5f9; display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div>Admin Board</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">Manage users and view analytics</div>
                        </div>
                        <button onclick="window.location.href='/admin-dashboard.html'" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer;">
                            Open
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Download App Button (above logout) -->
        <div id="profile-download-app-btn" style="padding: 0 25px; margin-top: 30px;">
            <button class="pwa-install-btn" onclick="installPWA(this)" data-original-text="DOWNLOAD APP" style="width:100%; padding:15px; border-radius:12px; font-weight:700; background:linear-gradient(135deg, #046A38, #06a94d); color:white; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s, box-shadow 0.2s; box-shadow:0 4px 15px rgba(4,106,56,0.25);" onmouseover="this.style.transform='scale(1.01)'; this.style.boxShadow='0 6px 20px rgba(4,106,56,0.35)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(4,106,56,0.25)'">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                DOWNLOAD APP
            </button>
        </div>

        <!-- Logout Button -->
        <div style="padding: 0 25px; margin-top: 12px; margin-bottom: 40px;">
            <button onclick="handleLogout()" style="width:100%; padding:15px; border-radius:12px; font-weight:700; background:#ef4444; color:white; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                LOG OUT
            </button>
        </div>

        </div>

    <!-- EDIT PROFILE MODAL -->

    <script>
    function toggleProfileEditMode() {
        const isEditing = document.getElementById('btn-save-profile').style.display === 'inline-flex';

        // SYMPTOMS_LIST removed - symptoms can only be updated via daily check-in

        const editMap = [
             { id: 'profile-name-display', type: 'text' },
             { id: 'profile-email-display', type: 'text' },
             { id: 'profile-age-display', type: 'text' },
             { id: 'profile-weight-display', type: 'text' },
             { id: 'profile-goal-display', type: 'text' }
             // Energy Level, Equipment, and Symptoms removed - can only be updated via daily check-in
        ];
        
        if (!isEditing) {
            // Enter Edit Mode
            editMap.forEach(f => {
                const el = document.getElementById(f.id);
                if(!el) return;

                let currentVal = el.innerText;
                if(f.id === 'profile-weight-display') currentVal = currentVal.replace(' kg', '');
                // Use dataset raw for mapped values if available
                if(el.dataset.raw) currentVal = el.dataset.raw; 

                el.dataset.original = currentVal;
                
                // Parse current array if multiselect
                let currentArray = [];
                if (f.type === 'multiselect') {
                    // Start with dataset raw (array or comma string)
                     const raw = el.dataset.raw || currentVal; 
                     if (Array.isArray(raw)) currentArray = raw;
                     else if (typeof raw === 'string') currentArray = raw.split(',').map(s=>s.trim().toLowerCase());
                     else currentArray = [];
                     
                     // Handle "None" text case
                     if(currentArray.length === 1 && currentArray[0] === 'none') currentArray = [];
                }

                if (f.type === 'text') {
                     const align = f.id.includes('symptoms') ? 'right' : 'center';
                     el.innerHTML = `<input type="text" value="${currentVal}" style="width:100%; border:1px solid var(--primary); padding:4px 8px; border-radius:6px; font-family:inherit; font-size:inherit; text-align:${align}; background:white;">`;
                } else if (f.type === 'select') {
                    let opts = '';
                    f.options.forEach(opt => {
                        const val = Array.isArray(opt) ? opt[0] : opt;
                        const label = Array.isArray(opt) ? opt[1] : opt;
                        const selected = (String(val).toLowerCase() === String(currentVal).toLowerCase()) ? 'selected' : '';
                        opts += `<option value="${val}" ${selected}>${label}</option>`;
                    });
                    el.innerHTML = `<select style="width:100%; border:1px solid var(--primary); padding:4px; border-radius:6px; font-family:inherit; font-size:inherit; background:white;">${opts}</select>`;
                } else if (f.type === 'multiselect') {
                    let checks = '';
                    f.options.forEach(opt => {
                        const isChecked = currentArray.some(s => s.includes(opt.val) || s === opt.label.toLowerCase()); // Loose match
                        checks += `
                            <label style="display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid #f1f5f9; cursor:pointer;">
                                <input type="checkbox" value="${opt.val}" ${isChecked ? 'checked' : ''} style="width:18px; height:18px; accent-color:var(--primary);">
                                <span style="font-size:0.9rem; color:var(--text-main);">${opt.label}</span>
                            </label>
                        `;
                    });
                    el.innerHTML = `
                        <div class="multiselect-container" style="border:1px solid var(--primary); background:white; border-radius:8px; padding:8px 12px; max-height:200px; overflow-y:auto; text-align:left;">
                            ${checks}
                        </div>
                    `;
                }
            });
            document.getElementById('btn-save-profile').style.display = 'inline-flex';
            document.getElementById('btn-edit-profile').style.display = 'none';
        }
    }
    
    function saveProfileChanges() {
        const fields = [
            { id: 'profile-name-display', key: 'name' },
            { id: 'profile-email-display', key: 'email' },
            { id: 'profile-age-display', key: 'age' },
            { id: 'profile-weight-display', key: 'weight' },
            { id: 'profile-goal-display', key: 'goal_weight' }
            // Energy Level, Equipment, and Symptoms removed - can only be updated via daily check-in
        ];
        
        let quizData = {};
        try { quizData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e){}
        
        fields.forEach(f => {
            const el = document.getElementById(f.id);
            if(!el) return;

            // NOTE: Energy Level, Equipment, and Symptoms removed - can only be updated via daily check-in

            const input = el.querySelector('input, select');
            if(input) {
                let val = input.value;
                quizData[f.key] = val;
                // Update UI Display properly
                el.innerText = val + (f.key === 'weight' ? ' kg' : '');
            }
        });
        
        // Save to Supabase (Split Logic)
        if (window.currentUser) {
            const userColumns = ['name', 'email'];
            const coreData = {};
            const factsData = {};

            Object.keys(quizData).forEach(k => {
                if (userColumns.includes(k)) coreData[k] = quizData[k];
                else factsData[k] = quizData[k];
            });

            // 1. Core
            if (Object.keys(coreData).length > 0) {
                 dbHelpers.users.update(window.currentUser.id, coreData).catch(console.error);
            }

            // 2. Facts
            if (Object.keys(factsData).length > 0) {
                (async () => {
                    let existingFacts = {};
                    try { existingFacts = await dbHelpers.userFacts.get(window.currentUser.id); } catch(e){}
                    const currentDetails = existingFacts?.personal_details || {};

                    await dbHelpers.userFacts.upsert(window.currentUser.id, {
                        personal_details: { ...currentDetails, ...factsData }
                    });
                    // Note: equipment_access is now only updated via daily check-in
                })();
            }
            
            window.userProfile = { ...window.userProfile, ...quizData }; // Update cache

            // IMPORTANT: Also update localStorage so workout schedules pick up the change
            try {
                const stored = JSON.parse(localStorage.getItem('userProfile') || '{}');
                Object.assign(stored, quizData);
                localStorage.setItem('userProfile', JSON.stringify(stored));
            } catch(e) { console.error('Failed to update localStorage:', e); }

            // Update sessionStorage as well (merge with existing to preserve data)
            try {
                const sessionStored = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
                Object.assign(sessionStored, quizData);
                sessionStorage.setItem('userProfile', JSON.stringify(sessionStored));
            } catch(e) { sessionStorage.setItem('userProfile', JSON.stringify(quizData)); }

            // Clear cached profile to force reload with new values
            // This ensures renderMovementView and other functions get fresh data
            if (window.userProfile) {
                window.userProfile = { ...window.userProfile, ...quizData };
            }

            // Refresh ALL views to reflect new equipment settings
            if(typeof renderMovementView === 'function') setTimeout(renderMovementView, 100);
            if(typeof renderWeeklyCalendar === 'function') setTimeout(renderWeeklyCalendar, 150); // Refresh calendar
            if(typeof loadProfileData === 'function') loadProfileData(); // Refresh profile display logic
        }

        document.getElementById('btn-save-profile').style.display = 'none';
        document.getElementById('btn-edit-profile').style.display = 'inline-flex';
    }

    /**
     * Recalculate calories - opens wizard to allow user to update their profile data
     */
    function recalculateCalories() {
        console.log('recalculateCalories called');
        // Check if user is logged in
        if (!window.currentUser?.id) {
            alert('Please log in to recalculate your calories.');
            return;
        }

        // Open the recalculate calories wizard
        openRecalculateWizard().catch(err => {
            console.error('Error opening recalculate wizard:', err);
            alert('Error opening wizard. Please try again.');
        });
    }

    // Recalculate Wizard State
    let recalcWizardStep = 1;
    const totalRecalcSteps = 3;
    let recalcWizardData = {};

    /**
     * Open the recalculate calories wizard and pre-fill with current data
     */
    async function openRecalculateWizard() {
        console.log('openRecalculateWizard called');

        // Reset wizard state
        recalcWizardStep = 1;
        recalcWizardData = {};

        // Fetch current profile data to pre-fill the form
        let profileData = {};
        try {
            if (typeof dbHelpers !== 'undefined' && window.currentUser?.id) {
                const quizData = await dbHelpers.quizResults.getLatest(window.currentUser.id);
                if (quizData) profileData = quizData;
            }
        } catch (e) {
            console.log('Could not fetch quiz data:', e);
        }

        // Also check localStorage for backup data
        let localProfile = {};
        try { localProfile = JSON.parse(localStorage.getItem('userProfile') || '{}'); } catch(e) {}
        let sessionProfile = {};
        try { sessionProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        profileData = { ...localProfile, ...sessionProfile, ...profileData };

        try {
            // Pre-fill form fields with current data (using optional chaining to avoid null crashes)
            if (profileData.sex) {
                const genderEl = document.getElementById('recalc-wizard-gender');
                if (genderEl) genderEl.value = profileData.sex;
                selectRecalcGender(profileData.sex, true); // true = don't auto-advance
            }
            if (profileData.age) {
                const ageEl = document.getElementById('recalc-wizard-age');
                if (ageEl) ageEl.value = profileData.age;
            }
            if (profileData.height) {
                const heightEl = document.getElementById('recalc-wizard-height');
                if (heightEl) heightEl.value = profileData.height;
            }
            if (profileData.weight) {
                const weightEl = document.getElementById('recalc-wizard-weight');
                if (weightEl) weightEl.value = profileData.weight;
            }
            if (profileData.goal_weight) {
                const goalWeightEl = document.getElementById('recalc-wizard-goal-weight');
                if (goalWeightEl) goalWeightEl.value = profileData.goal_weight;
            }
            if (profileData.activity_level) {
                const activityEl = document.getElementById('recalc-wizard-activity-level');
                if (activityEl) activityEl.value = profileData.activity_level;
            }

            // Handle goal body type
            const goalType = profileData.goalBodyType || profileData.goal_body_type || '';
            if (goalType) {
                const goalTypeEl = document.getElementById('recalc-wizard-goal-type');
                if (goalTypeEl) goalTypeEl.value = goalType;
            }

            // Reset slides to initial state
            document.querySelectorAll('.recalc-wizard-slide').forEach(slide => {
                slide.style.display = 'none';
                slide.classList.remove('active');
            });
            const slide1 = document.getElementById('recalc-slide-1');
            if (slide1) {
                slide1.style.display = 'block';
                slide1.classList.add('active');
            }

            // Update progress dots
            updateRecalcProgress(1);

            // Update buttons
            const btnBack = document.getElementById('recalc-btn-back');
            if (btnBack) btnBack.style.display = 'none';
            const btnNext = document.getElementById('recalc-btn-next');
            if (btnNext) btnNext.textContent = 'Next';

            // Show the wizard
            console.log('Showing recalculate wizard modal');
            const wizardModal = document.getElementById('recalculate-calories-wizard');
            wizardModal.classList.add('active');
            wizardModal.style.display = 'flex';
            wizardModal.style.opacity = '1';
        } catch (domError) {
            console.error('Error setting up wizard DOM:', domError);
            throw domError;
        }
    }

    /**
     * Close the recalculate wizard
     */
    function closeRecalculateWizard() {
        const wizardModal = document.getElementById('recalculate-calories-wizard');
        wizardModal.classList.remove('active');
        wizardModal.style.display = 'none';
        wizardModal.style.opacity = '0';
        recalcWizardStep = 1;
        recalcWizardData = {};
    }

    /**
     * Select gender in recalculate wizard
     */
    function selectRecalcGender(gender, noAdvance = false) {
        document.getElementById('recalc-wizard-gender').value = gender;
        recalcWizardData.sex = gender;

        // Update button styles
        const femaleBtn = document.getElementById('recalc-gender-btn-female');
        const maleBtn = document.getElementById('recalc-gender-btn-male');

        femaleBtn.style.border = gender === 'female' ? '2px solid var(--primary)' : '2px solid #e2e8f0';
        femaleBtn.style.background = gender === 'female' ? 'rgba(72,134,75,0.1)' : 'white';
        maleBtn.style.border = gender === 'male' ? '2px solid var(--primary)' : '2px solid #e2e8f0';
        maleBtn.style.background = gender === 'male' ? 'rgba(72,134,75,0.1)' : 'white';

        // Auto-advance to next step if not pre-filling
        if (!noAdvance) {
            setTimeout(() => recalcWizardNext(), 300);
        }
    }

    /**
     * Update progress dots for recalculate wizard
     */
    function updateRecalcProgress(step) {
        const dots = document.querySelectorAll('.recalc-wizard-progress .dot');
        dots.forEach((dot, index) => {
            dot.classList.toggle('active', index < step);
        });
    }

    /**
     * Navigate to next step in recalculate wizard
     */
    async function recalcWizardNext() {
        // Validate current step
        if (recalcWizardStep === 1) {
            const gender = document.getElementById('recalc-wizard-gender').value;
            if (!gender) {
                alert('Please select your program.');
                return;
            }
            recalcWizardData.sex = gender;
        } else if (recalcWizardStep === 2) {
            // Validate step 2 fields
            const age = document.getElementById('recalc-wizard-age').value;
            const height = document.getElementById('recalc-wizard-height').value;
            const weight = document.getElementById('recalc-wizard-weight').value;
            const goalWeight = document.getElementById('recalc-wizard-goal-weight').value;
            const activityLevel = document.getElementById('recalc-wizard-activity-level').value;
            const goalType = document.getElementById('recalc-wizard-goal-type').value;

            if (!age || !height || !weight || !goalWeight || !activityLevel || !goalType) {
                alert('Please fill in all fields.');
                return;
            }

            recalcWizardData.age = parseInt(age);
            recalcWizardData.height = parseFloat(height);
            recalcWizardData.weight = parseFloat(weight);
            recalcWizardData.goal_weight = parseFloat(goalWeight);
            recalcWizardData.activity_level = activityLevel;
            recalcWizardData.goalBodyType = goalType;

            // Calculate nutrition goals and show results
            const nutritionGoals = calculateNutritionGoals({
                age: recalcWizardData.age,
                height: recalcWizardData.height,
                weight: recalcWizardData.weight,
                goal_weight: recalcWizardData.goal_weight,
                sex: recalcWizardData.sex,
                activity_level: recalcWizardData.activity_level,
                goalBodyType: recalcWizardData.goalBodyType
            });

            if (!nutritionGoals) {
                alert('Failed to calculate nutrition goals. Please check your data.');
                return;
            }

            recalcWizardData.nutritionGoals = nutritionGoals;

            // Update results display
            document.getElementById('recalc-result-calories').textContent = nutritionGoals.calorie_goal + ' kcal';
            document.getElementById('recalc-result-protein').textContent = nutritionGoals.protein_goal_g + 'g';
            document.getElementById('recalc-result-carbs').textContent = nutritionGoals.carbs_goal_g + 'g';
            document.getElementById('recalc-result-fat').textContent = nutritionGoals.fat_goal_g + 'g';

            // Update summary text
            let summaryText = '';
            if (recalcWizardData.weight > recalcWizardData.goal_weight) {
                summaryText = `We've set a calorie deficit to help you lose ${(recalcWizardData.weight - recalcWizardData.goal_weight).toFixed(1)}kg.`;
            } else if (recalcWizardData.weight < recalcWizardData.goal_weight) {
                summaryText = `We've set a calorie surplus to help you gain ${(recalcWizardData.goal_weight - recalcWizardData.weight).toFixed(1)}kg.`;
            } else {
                summaryText = `Your goals are set to maintain your current weight.`;
            }
            document.getElementById('recalc-summary-text').textContent = summaryText;
        } else if (recalcWizardStep === 3) {
            // Save and close
            await saveRecalculateWizardData();
            return;
        }

        // Move to next step
        recalcWizardStep++;
        showRecalcSlide(recalcWizardStep);
    }

    /**
     * Navigate to previous step in recalculate wizard
     */
    function recalcWizardBack() {
        if (recalcWizardStep > 1) {
            recalcWizardStep--;
            showRecalcSlide(recalcWizardStep);
        }
    }

    /**
     * Show specific slide in recalculate wizard
     */
    function showRecalcSlide(step) {
        // Hide all slides
        document.querySelectorAll('.recalc-wizard-slide').forEach(slide => {
            slide.style.display = 'none';
            slide.classList.remove('active');
        });

        // Show target slide
        const targetSlide = document.getElementById(`recalc-slide-${step}`);
        if (targetSlide) {
            targetSlide.style.display = 'block';
            targetSlide.classList.add('active');
        }

        // Update progress
        updateRecalcProgress(step);

        // Update buttons
        const backBtn = document.getElementById('recalc-btn-back');
        const nextBtn = document.getElementById('recalc-btn-next');

        backBtn.style.display = step > 1 ? 'block' : 'none';

        if (step === totalRecalcSteps) {
            nextBtn.textContent = 'Save & Update';
        } else {
            nextBtn.textContent = 'Next';
        }

        // Update title
        const titles = ['Update Your Goals', 'Your Details', 'Your New Goals'];
        document.getElementById('recalc-wizard-title').textContent = titles[step - 1] || 'Update Your Goals';
    }

    /**
     * Save recalculate wizard data to database
     */
    async function saveRecalculateWizardData() {
        const nextBtn = document.getElementById('recalc-btn-next');
        nextBtn.textContent = 'Saving...';
        nextBtn.disabled = true;

        try {
            const nutritionGoals = recalcWizardData.nutritionGoals;

            // Update quiz_results in database
            if (window.supabaseClient && window.currentUser?.id) {
                const { error } = await window.supabaseClient.from('quiz_results')
                    .update({
                        age: recalcWizardData.age,
                        height: recalcWizardData.height,
                        weight: recalcWizardData.weight,
                        goal_weight: recalcWizardData.goal_weight,
                        sex: recalcWizardData.sex,
                        activity_level: recalcWizardData.activity_level,
                        goal_body_type: recalcWizardData.goalBodyType,
                        bmr: nutritionGoals.bmr,
                        tdee: nutritionGoals.tdee,
                        calorie_goal: nutritionGoals.calorie_goal,
                        protein_goal_g: nutritionGoals.protein_goal_g,
                        carbs_goal_g: nutritionGoals.carbs_goal_g,
                        fat_goal_g: nutritionGoals.fat_goal_g
                    })
                    .eq('user_id', window.currentUser.id);

                if (error) {
                    console.error('Failed to save new goals:', error);
                    alert('Failed to save your new goals. Please try again.');
                    nextBtn.textContent = 'Save & Update';
                    nextBtn.disabled = false;
                    return;
                }

                // Also update users table with sex if changed
                await window.supabaseClient.from('users')
                    .update({ sex: recalcWizardData.sex })
                    .eq('id', window.currentUser.id);
            }

            // Update localStorage and sessionStorage
            const updatedData = {
                age: recalcWizardData.age,
                height: recalcWizardData.height,
                weight: recalcWizardData.weight,
                goal_weight: recalcWizardData.goal_weight,
                sex: recalcWizardData.sex,
                activity_level: recalcWizardData.activity_level,
                goalBodyType: recalcWizardData.goalBodyType,
                bmr: nutritionGoals.bmr,
                tdee: nutritionGoals.tdee,
                calorie_goal: nutritionGoals.calorie_goal,
                protein_goal_g: nutritionGoals.protein_goal_g,
                carbs_goal_g: nutritionGoals.carbs_goal_g,
                fat_goal_g: nutritionGoals.fat_goal_g
            };

            let storedLocal = {};
            try { storedLocal = JSON.parse(localStorage.getItem('userProfile') || '{}'); } catch(e) {}
            Object.assign(storedLocal, updatedData);
            localStorage.setItem('userProfile', JSON.stringify(storedLocal));

            let storedSession = {};
            try { storedSession = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
            Object.assign(storedSession, updatedData);
            sessionStorage.setItem('userProfile', JSON.stringify(storedSession));

            // Update window.userProfile cache
            if (window.userProfile) {
                Object.assign(window.userProfile, updatedData);
            }

            // Update today's daily_nutrition record with new goals
            const today = new Date().toISOString().split('T')[0];
            if (window.supabaseClient && window.currentUser?.id) {
                await window.supabaseClient.from('daily_nutrition')
                    .upsert({
                        user_id: window.currentUser.id,
                        nutrition_date: today,
                        calorie_goal: nutritionGoals.calorie_goal,
                        protein_goal_g: nutritionGoals.protein_goal_g,
                        carbs_goal_g: nutritionGoals.carbs_goal_g,
                        fat_goal_g: nutritionGoals.fat_goal_g
                    }, { onConflict: 'user_id,nutrition_date' });
            }

            // Refresh UI widgets
            if (typeof refreshNutritionWidgets === 'function') {
                refreshNutritionWidgets();
            }
            if (typeof loadNutritionData === 'function') {
                loadNutritionData();
            }

            console.log('✅ New nutrition goals saved:', nutritionGoals);

            // Close wizard and show success
            closeRecalculateWizard();
            alert(`Your goals have been updated!\n\nNew Daily Goals:\n• Calories: ${nutritionGoals.calorie_goal} kcal\n• Protein: ${nutritionGoals.protein_goal_g}g\n• Carbs: ${nutritionGoals.carbs_goal_g}g\n• Fat: ${nutritionGoals.fat_goal_g}g`);

        } catch (error) {
            console.error('Error saving recalculate wizard data:', error);
            alert('An error occurred while saving your goals. Please try again.');
            nextBtn.textContent = 'Save & Update';
            nextBtn.disabled = false;
        }
    }
    </script>

    </div> 
</div> <!-- End Main Container (Moved) -->

<script>
// Initialize Stripe for in-app purchases
window.stripe = Stripe('pk_live_51GmycUCGCyRUsOfK9lOtnZNvinxCcjf7rZnpC0ter8eShFPATzVKB7ypy2BPQbMRkuWT67mf04tjzvu18jQvmlZX00BvlGLyds');

// PWA & Navigation Logic
document.addEventListener('DOMContentLoaded', () => {
    // Handle Coin Pack purchase return
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('coin_purchase') === 'success') {
        const packName = urlParams.get('pack') || 'coins';
        window.history.replaceState({}, document.title, window.location.pathname);
        setTimeout(() => {
            alert('Coins added to your balance! Time to compete.');
            if (typeof loadCoinBalance === 'function') loadCoinBalance();
        }, 500);
    }

    // Handle tab deep-link (e.g., returning from workout-duel page)
    const deepLinkTab = urlParams.get('tab');
    if (deepLinkTab) {
        window.history.replaceState({}, document.title, window.location.pathname);
        setTimeout(() => {
            if (typeof switchAppTab === 'function') {
                switchAppTab(deepLinkTab);
            }
        }, 300);
    }

    // Handle legacy challenge pass/buyin returns
    if (urlParams.get('challenge_pass') === 'success' || urlParams.get('challenge_buyin') === 'success') {
        window.history.replaceState({}, document.title, window.location.pathname);
        setTimeout(() => {
            const pendingId = urlParams.get('challenge_id') || sessionStorage.getItem('pending_challenge_id');
            sessionStorage.removeItem('pending_challenge_id');
            if (pendingId && typeof doAcceptChallenge === 'function') {
                doAcceptChallenge(pendingId);
            }
        }, 500);
    }

    // 0. Chat History now loaded in consolidated auth-aware block

    // 1. Move Sections out of Meals Container
    // We want Movement and Support to be top-level app views, not sub-views of Meals
    const moveIds = ['movement-tab', 'group', 'sleep', 'view-active-workout', 'view-workout-success', 'view-profile'];
    const container = document.querySelector('.container');
    const bottomNav = document.querySelector('.bottom-nav');
    
    moveIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('active');
            el.classList.add('app-view'); // Treat as top level view
            el.style.display = 'none'; // Hide initially
            // Move to main container
            container.appendChild(el);
        }
    });

    // Move fixed overlay views to body level to avoid z-index stacking context issues
    const overlayIds = ['view-your-workouts', 'view-workout-library', 'view-workout-subcategories', 'view-workout-list', 'view-workout-overview'];
    overlayIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            document.body.appendChild(el);
        }
    });

    // 2. Initialize (Now handled by the consolidated listener above)
    // initProgramDate(); 
    // switchAppTab('dashboard', document.querySelector('.nav-item')); // Default to Home
});

// --- DAILY CONTENT LOGIC ---
async function initProgramDate() {
    let startDate = null;
    try {
        const profile = await window.getUserProfile();
        startDate = profile?.program_start_date;
    } catch(e) {}

    if (!startDate) {
        startDate = localStorage.getItem('pbb_start_date');
    }

    if (!startDate) {
        startDate = new Date().toISOString();
    }

    // Always ensure localStorage is synced with the current start date
    localStorage.setItem('pbb_start_date', startDate);

    const start = new Date(startDate);
    const now = new Date();
    const diffTime = Math.abs(now - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    let currentDay = diffDays;
    if (currentDay < 1) currentDay = 1;

    updateDailyContent(currentDay);
}

function updateDailyContent(day) {
    const counterEl = document.getElementById('daily-progress-counter');
    if (counterEl) {
        counterEl.innerText = `Day ${day} of 28`;
        if (day > 28) counterEl.innerText = `Day ${day} (Maintenance)`;
    }

    // Update Movement Tab Header
    const moveDate = document.getElementById('movement-today-date');
    if (moveDate) {
        moveDate.innerText = `Day ${day}`;
    }

    // --- NEW: Render Today's Meals Logic ---
    const todayContainer = document.getElementById('today-meals-content');
    if (todayContainer) {
        const weekNum = Math.ceil(day / 7);
        const dayIndex = (day - 1) % 7;
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const dayName = days[dayIndex];
        const sourceId = `week${weekNum}-${dayName}`;
        
        const sourceCard = document.getElementById(sourceId);
        
        if (sourceCard) {
            // Clone content but keep it generic/clean
            todayContainer.innerHTML = ''; // Clear loading
            const clone = sourceCard.cloneNode(true);
            
            // Adjust styling for 'Today' view if needed, or just append
            // We want it open by default
            clone.classList.add('open');
            clone.style.marginBottom = '20px';
            
            // Remove the ID to avoid duplicates in DOM
            clone.removeAttribute('id');
            
            // Fix onclick to toggle THIS clone, not the original ID
            const header = clone.querySelector('.card-header');
            if(header) header.setAttribute('onclick', 'toggleCard(this.parentElement)');
            
            todayContainer.appendChild(clone);
        } else {
            // Fallback if content not found
            todayContainer.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-muted);">
                    <p>Meals for Day ${day} (${dayName}, Week ${weekNum}) are loading...</p>
                    <button onclick="switchWeek('week${weekNum}', this)" style="margin-top:10px; padding:10px 20px; border-radius:30px; border:1px solid var(--primary); background:transparent; color:var(--primary); cursor:pointer;">View Week ${weekNum} Plan</button>
                    <!-- Debug: Looked for #${sourceId} -->
                </div>
            `;
        }
    }
}

// Real syncQuizDataToDb implementation - replaces the early stub
async function _syncQuizDataToDbRealImpl() {
    const user = window.currentUser;
    if (!user) return;

    try {
        const quizJson = sessionStorage.getItem('userProfile');
        const hormoneType = sessionStorage.getItem('userResult');

        let quizData = {};
        if (quizJson) {
             try { quizData = JSON.parse(quizJson); } catch(e) {}
        }

        // Add hormone type if present
        if (hormoneType) {
            quizData.profile = hormoneType;
        }

        // Map 'sex' to 'user_gender' for quiz users
        // Quiz collects 'sex' field, but we need 'user_gender' for UI/localStorage
        if (quizData.sex && !quizData.user_gender) {
            quizData.user_gender = quizData.sex;
            localStorage.setItem('userGender', quizData.sex);
        }

        // NOTE: Symptom derivation from quiz REMOVED
        // Symptoms can ONLY be set via daily wellness check-in to prevent persistent stale data
        // This ensures equipment selection is respected and symptoms stay current

        if (Object.keys(quizData).length > 0) {
            console.log("Syncing quiz data to DB...", quizData);

            // SPLIT DATA: Users table vs User Facts (personal_details)
            // sex is a core user attribute stored in users table
            // equipment_access is stored in quiz_results table (not users table)
            const userColumns = ['name', 'email', 'profile_photo', 'program_start_date', 'theme_preference', 'location', 'sex'];
            const coreData = {};
            const factsData = {};

            Object.keys(quizData).forEach(k => {
                if (userColumns.includes(k)) coreData[k] = quizData[k];
                else factsData[k] = quizData[k];
            });

            // 1. Update Core User Data (user row already exists from signup)
            if (Object.keys(coreData).length > 0) {
                await dbHelpers.users.update(user.id, coreData);
            }

            // 2. Update Extension Data (User Facts)
            if (Object.keys(factsData).length > 0) {
                // Get existing facts first to merge
                let existingFacts = {};
                try { existingFacts = await dbHelpers.userFacts.get(user.id); } catch(e){}

                const currentDetails = existingFacts?.personal_details || {};

                await dbHelpers.userFacts.upsert(user.id, {
                    personal_details: { ...currentDetails, ...factsData }
                });
            }

            // 3. Calculate and Save Nutrition Goals if we have the required data
            // Check if nutrition goals were already pre-calculated by the onboarding wizard
            const hasPreCalculatedGoals = quizData.bmr && quizData.tdee && quizData.calorie_goal &&
                                          quizData.protein_goal_g && quizData.carbs_goal_g && quizData.fat_goal_g;

            // Default goalBodyType to 'Athletic' if not provided (balanced middle-ground for non-quiz users)
            const effectiveGoalBodyType = quizData.goalBodyType || 'Athletic';

            // Required fields: age, height, weight, goal_weight, activity_level, sex
            // goalBodyType is now optional (defaults to 'Athletic')
            const hasRequiredFields = quizData.age && quizData.height && quizData.weight &&
                                      quizData.goal_weight && quizData.activity_level && quizData.sex;

            if (hasPreCalculatedGoals || hasRequiredFields) {
                try {
                    let nutritionGoals;
                    let metricData;

                    if (hasPreCalculatedGoals) {
                        // Use pre-calculated values from onboarding wizard
                        console.log("Using pre-calculated nutrition goals from wizard");
                        nutritionGoals = {
                            bmr: quizData.bmr,
                            tdee: quizData.tdee,
                            calorie_goal: quizData.calorie_goal,
                            protein_goal_g: quizData.protein_goal_g,
                            carbs_goal_g: quizData.carbs_goal_g,
                            fat_goal_g: quizData.fat_goal_g
                        };
                        // For metric data, use direct values (wizard already uses metric)
                        metricData = {
                            age: quizData.age,
                            height: quizData.height,
                            weight: quizData.weight,
                            goal_weight: quizData.goal_weight,
                            sex: quizData.sex,
                            activity_level: quizData.activity_level,
                            goalBodyType: effectiveGoalBodyType
                        };
                    } else {
                        // Convert quiz data to metric units and calculate
                        const dataWithBodyType = { ...quizData, goalBodyType: effectiveGoalBodyType };
                        metricData = convertQuizDataToMetric(dataWithBodyType);
                        nutritionGoals = calculateNutritionGoals(metricData);
                    }

                    if (nutritionGoals) {
                        console.log("Calculated nutrition goals:", nutritionGoals);

                        // Save to quiz_results table
                        const quizResultData = {
                            menopause_status: quizData.menopause_status,
                            cycle_description: quizData.cycle_desc,
                            activity_level: quizData.activity_level,
                            weight_storage_location: quizData.weight_gain_location,
                            goal_body_type: effectiveGoalBodyType,
                            sleep_hours: quizData.sleep_hours,
                            sleep_quality: quizData.wake_feel,
                            energy_level: quizData.energy_level || quizData.energy_status, // Support both field names
                            energy_crashes: quizData.midday_crash,
                            caffeine_relationship: quizData.caffeine,
                            hormone_profile: hormoneType,
                            equipment_access: quizData.equipment_access || 'none',
                            age: metricData.age,
                            height: metricData.height,
                            weight: metricData.weight,
                            goal_weight: metricData.goal_weight,
                            sex: metricData.sex,
                            bmr: nutritionGoals.bmr,
                            tdee: nutritionGoals.tdee,
                            calorie_goal: nutritionGoals.calorie_goal,
                            protein_goal_g: nutritionGoals.protein_goal_g,
                            carbs_goal_g: nutritionGoals.carbs_goal_g,
                            fat_goal_g: nutritionGoals.fat_goal_g
                        };

                        await dbHelpers.quizResults.create(user.id, quizResultData);
                        console.log("Quiz results with nutrition goals saved to database");

                        // Update daily_nutrition goals for ALL existing entries
                        // This ensures that when onboarding is redone, all historical entries
                        // reflect the new calorie/macro goals instead of keeping stale values
                        const goalsToUpdate = {
                            calorie_goal: nutritionGoals.calorie_goal,
                            protein_goal_g: nutritionGoals.protein_goal_g,
                            carbs_goal_g: nutritionGoals.carbs_goal_g,
                            fat_goal_g: nutritionGoals.fat_goal_g
                        };

                        // First update all existing entries
                        await dbHelpers.nutrition.updateAllGoals(user.id, goalsToUpdate);
                        console.log("All daily nutrition goals updated");

                        // Also ensure today has an entry (updateAllGoals only updates existing rows)
                        const today = new Date().toISOString().split('T')[0];
                        await dbHelpers.nutrition.updateGoals(user.id, today, goalsToUpdate);
                        console.log("Today's nutrition goals ensured");

                        // CRITICAL FIX: Save sex to users table so it persists on page reload
                        // This fixes the bug where gender resets to female on refresh
                        await dbHelpers.users.update(user.id, {
                            sex: metricData.sex
                        });
                        console.log("User sex field saved to users table:", metricData.sex);
                    }
                } catch (nutritionError) {
                    console.error("Failed to calculate/save nutrition goals:", nutritionError);
                }
            }

            // Update local cache
            window.userProfile = { ...window.userProfile, ...quizData };
            console.log("Quiz data synced successfully");
        }
    } catch (e) {
        console.error("Failed to sync quiz data:", e);
    }
}
// Register real implementation
_syncQuizDataToDbReal = _syncQuizDataToDbRealImpl;
syncQuizDataToDb = _syncQuizDataToDbRealImpl;

async function handleLogout() {
    if (confirm('Are you sure you want to log out?')) {
        try {
            await authHelpers.signOut();
            // Clear any cached data
            sessionStorage.clear();

            // Clear all user-specific localStorage items to prevent data leak between accounts
            const userSpecificKeys = [
                'userProfile',
                'userGender',
                'onboardingComplete',
                'characterColors',
                'userThemePreference',
                'userCycleData',
                'profile_photo',
                'selected_meal_plan',
                'user_food_preferences',
                'meal_reminder_settings',
                'lastWellnessCheck',
                'lastWeighInPromptDate',
                'equipmentUpdatedAt',
                'gym_split_start_date',
                'calendarViewPreference',
                'referral_banner_dismissed',
                'pwa_banner_dismissed_v2',
                'user_notifications_enabled',
                'pbb_biometric_credential',
                'pbb_biometric_email',
                'pbb_biometric_user_id'
            ];

            userSpecificKeys.forEach(key => localStorage.removeItem(key));

            window.location.href = '/login.html';
        } catch (error) {
            console.error('Logout failed:', error);
            alert('Failed to log out. Please try again.');
        }
    }
}

// Real loadProfileData implementation - replaces the early stub
async function _loadProfileDataRealImpl() {
    let profile = null;
    let quizResult = null;

    try {
        profile = await window.getUserProfile();
    } catch (e) {
        console.warn("Profile fetching error", e);
    }

    // Also fetch quiz results for equipment_access and energy_level
    try {
        if (window.currentUser?.id && typeof dbHelpers !== 'undefined') {
            quizResult = await dbHelpers.quizResults.getLatest(window.currentUser.id);
        }
    } catch (e) {
        console.warn("Quiz results fetching error", e);
    }

    // Merge quiz results into profile for easy access
    if (quizResult) {
        profile = { ...profile, ...quizResult };

        // Sync important quiz fields from database to localStorage
        try {
            const localProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            let needsSave = false;

            // CRITICAL FIX: Sync equipment_access to localStorage so calendar/movement views have correct data
            if (quizResult.equipment_access && localProfile.equipment_access !== quizResult.equipment_access) {
                localProfile.equipment_access = quizResult.equipment_access;
                needsSave = true;
                console.log('✅ Equipment access synced from DB to localStorage:', quizResult.equipment_access);
            }

            // Sync cycle sync preferences
            if (quizResult.cycle_sync_preference && localProfile.cycle_sync_preference !== quizResult.cycle_sync_preference) {
                localProfile.cycle_sync_preference = quizResult.cycle_sync_preference;
                needsSave = true;
            }
            if (quizResult.period_energy_response && localProfile.period_energy_response !== quizResult.period_energy_response) {
                localProfile.period_energy_response = quizResult.period_energy_response;
                needsSave = true;
            }

            // Sync dietary preference
            if (quizResult.dietary_preference && localProfile.dietary_preference !== quizResult.dietary_preference) {
                localProfile.dietary_preference = quizResult.dietary_preference;
                localStorage.setItem('dietaryPreference', quizResult.dietary_preference);
                needsSave = true;
                console.log('Dietary preference synced from DB:', quizResult.dietary_preference);
            }

            if (needsSave) {
                localStorage.setItem('userProfile', JSON.stringify(localProfile));
                console.log('✅ Profile preferences synced from database');
            }
        } catch (e) {
            console.warn('Error syncing profile to localStorage:', e);
        }
    }

    // Sync water goal settings from DB to localStorage (for cross-device persistence)
    if (profile?.water_goal_ml && !localStorage.getItem('pbb_water_goal_ml')) {
        localStorage.setItem('pbb_water_goal_ml', profile.water_goal_ml.toString());
        localStorage.setItem('pbb_water_glass_size', (profile.water_glass_size || 250).toString());
        localStorage.setItem('pbb_water_total_glasses', (profile.water_total_glasses || Math.ceil(profile.water_goal_ml / (profile.water_glass_size || 250))).toString());
        console.log('Restored water goal from DB:', profile.water_goal_ml, 'ml');
    }

    // Fallback if DB fetch fail
    if (!profile) {
        try {
            profile = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
        } catch(e) {}
    }

    const context = {
        name: profile?.name || window.currentUser?.user_metadata?.full_name || "Shannon",
        email: profile?.email || window.currentUser?.email || "shannon@example.com",
        age: profile?.age || "34",
        weight: profile?.weight || "68 kg",
        goal: profile?.goal_weight || profile?.goal || "Fat Loss",
        profile: profile?.profile || (sessionStorage.getItem('userResult') || 'Cortisol').toUpperCase(),
        energy_level: profile?.energy_level || 'normal'
    };

    // Store energy_level globally for gender-specific UI
    window.userEnergyLevel = context.energy_level;

    // NOTE: Symptoms are NO LONGER loaded from profile
    // Symptoms now ONLY come from daily check-ins to prevent stale data from affecting recommendations

    if(document.getElementById('profile-name-display')) document.getElementById('profile-name-display').innerText = context.name;
    if(document.getElementById('profile-email-display')) document.getElementById('profile-email-display').innerText = context.email;
    if(document.getElementById('profile-age-display')) document.getElementById('profile-age-display').innerText = context.age;
    
    const wStr = String(context.weight).toLowerCase();
    const weightDisplay = wStr.includes('k') || wStr.includes('l') 
        ? context.weight 
        : context.weight + " kg";

    if(document.getElementById('profile-weight-display')) document.getElementById('profile-weight-display').innerText = weightDisplay;
    if(document.getElementById('profile-goal-display')) document.getElementById('profile-goal-display').innerText = context.goal;
    
    // Updated Protocol Fields
    if(document.getElementById('profile-type-display')) document.getElementById('profile-type-display').innerText = context.profile;
    
    const equipment = profile?.equipment_access || 'none';
    const eqMap = {
        'gym': 'Full Gym Access',
        'dumbbells': 'Home / Dumbbells',
        'home': 'Home / Dumbbells',  // Legacy value support
        'bands': 'Resistance Bands',
        'yoga_only': 'Yoga / Stretching Only',
        'none': 'No Equipment',
        'bodyweight': 'No Equipment'  // Legacy value support
    };
    const eqDisplay = document.getElementById('profile-equipment-display');
    if(eqDisplay) {
        eqDisplay.innerText = eqMap[equipment] || 'No Equipment';
        eqDisplay.dataset.raw = equipment; // Store raw value for edit mode mapping
    }

    // Display dietary preference
    const dietPref = profile?.dietary_preference || localStorage.getItem('dietaryPreference') || '';
    const dietDisplay = document.getElementById('profile-diet-display');
    if (dietDisplay) {
        const dietLabels = { omnivore: 'Omnivore', pescatarian: 'Pescatarian', vegetarian: 'Vegetarian', vegan: 'Vegan', flexitarian: 'Flexitarian' };
        dietDisplay.textContent = dietLabels[dietPref] || 'Not set';
    }

    // Display symptoms from latest check-in (NOT from profile)
    // Symptoms can only be updated via daily wellness check-in
    let symptomsText = 'None';

    // Look for most recent check-in with symptoms
    if (userCycleData.logs && Object.keys(userCycleData.logs).length > 0) {
        // Get all dates sorted descending (most recent first)
        const dates = Object.keys(userCycleData.logs).sort().reverse();

        // Find the most recent check-in that has symptoms
        for (const date of dates) {
            const log = userCycleData.logs[date];
            if (log.symptoms && Array.isArray(log.symptoms) && log.symptoms.length > 0) {
                symptomsText = log.symptoms.map(s =>
                    s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
                ).join(', ');
                break;
            }
        }
    }

    if(document.getElementById('profile-symptoms-display')) {
        document.getElementById('profile-symptoms-display').innerText = symptomsText;
    }

    // Load saved avatar if exists
    const savedPhoto = localStorage.getItem('profile_photo');
    if(savedPhoto) {
        const mainImg = document.getElementById('profile-photo-img');
        if(mainImg) mainImg.src = savedPhoto;
        document.querySelectorAll('.profile-icon').forEach(el => {
            el.innerHTML = `<img src="${savedPhoto}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
            el.style.background = 'transparent';
        });
    }

    // CRITICAL: Always sync gender from database to localStorage
    // Database is the source of truth - always overwrite localStorage
    // This fixes the bug where localStorage has wrong gender value
    // Check both user_gender (from users table) and sex (from quiz_results table)
    const genderFromDb = profile?.user_gender || profile?.sex;
    if (genderFromDb) {
        const currentLocalGender = localStorage.getItem('userGender');
        if (currentLocalGender !== genderFromDb) {
            console.log("Gender mismatch detected - DB:", genderFromDb, "localStorage:", currentLocalGender);
        }
        localStorage.setItem('userGender', genderFromDb);
        console.log("Synced gender from DB to localStorage:", genderFromDb);
    }

    // CRITICAL: Restore theme preference from database to localStorage
    // This ensures theme persists even when cache is cleared
    if (profile?.theme_preference && !localStorage.getItem('userThemePreference')) {
        localStorage.setItem('userThemePreference', profile.theme_preference);
        console.log("Restored theme preference from DB to localStorage:", profile.theme_preference);
    }

    // CRITICAL FIX: Restore sex field to sessionStorage for nutrition calculations
    // This fixes the bug where gender resets to female on page refresh
    if (profile?.sex) {
        let currentProfile = {};
        try { currentProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        currentProfile.sex = profile.sex;
        sessionStorage.setItem('userProfile', JSON.stringify(currentProfile));
        console.log("Restored sex from DB to sessionStorage:", profile.sex);
    }

    // ALWAYS apply gender-specific UI after profile loads
    // This uses localStorage (which may have been set during onboarding or restored from DB above)
    if (typeof applyGenderTheme === 'function') {
        applyGenderTheme();
    }
    if (typeof applyGenderSpecificUI === 'function') {
        applyGenderSpecificUI();
    }
    // Update settings icon to show Dragon Ball for DBZ themes
    if (typeof updateSettingsIcon === 'function') {
        updateSettingsIcon();
    }
    // Re-render cycle status with correct gender
    if (typeof renderCycleStatus === 'function') {
        renderCycleStatus();
    }

    // Load today's check-in from Supabase to sync localStorage
    if (window.currentUser && typeof dbHelpers !== 'undefined') {
        try {
            const today = new Date().toISOString().split('T')[0];
            const todayCheckin = await dbHelpers.checkins.get(window.currentUser.id, today);
            if (todayCheckin) {
                // User has already checked in today - mark localStorage
                localStorage.setItem('lastWellnessCheck', new Date().toDateString());
                console.log('✅ Today\'s check-in found in DB');

                // Update symptoms display from check-in data
                const additionalData = todayCheckin.additional_data || {};
                const checkInSymptoms = additionalData.symptoms || [];
                if (checkInSymptoms.length > 0) {
                    const symptomsEl = document.getElementById('profile-symptoms-display');
                    if (symptomsEl) {
                        const formattedSymptoms = checkInSymptoms.map(s =>
                            s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
                        ).join(', ');
                        symptomsEl.textContent = formattedSymptoms;
                    }
                }
            }
        } catch (e) {
            console.warn('Could not check today\'s check-in status:', e);
        }
    }
}
// Register real implementation
_loadProfileDataReal = _loadProfileDataRealImpl;
loadProfileData = _loadProfileDataRealImpl;

function handlePhotoUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            input.value = '';
            return;
        }

        // Show loading state
        const mainImg = document.getElementById('profile-photo-img');
        if (mainImg) mainImg.style.opacity = '0.5';

        // Resize image to prevent localStorage overflow (max 500KB)
        resizeImageFile(file, 400, 0.8).then(photoData => {
            // Update main profile photo
            if (mainImg) {
                mainImg.src = photoData;
                mainImg.style.opacity = '1';
            }

            // Save to localStorage
            try {
                localStorage.setItem('profile_photo', photoData);
            } catch (e) {
                console.error('Failed to save photo to localStorage:', e);
            }

            // Update all small icons
            document.querySelectorAll('.profile-icon').forEach(el => {
                el.innerHTML = `<img src="${photoData}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                el.style.background = 'transparent';
            });

            // Reset input to allow re-selecting the same file
            input.value = '';
        }).catch(err => {
            console.error('Failed to process image:', err);
            alert('Failed to process image. Please try a different photo.');
            if (mainImg) mainImg.style.opacity = '1';
            input.value = '';
        });
    }
}

// Helper function to resize image before storing
function resizeImageFile(file, maxSize, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Scale down if larger than maxSize
                if (width > height && width > maxSize) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                } else if (height > maxSize) {
                    width = (width * maxSize) / height;
                    height = maxSize;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = function() {
                reject(new Error('Failed to load image'));
            };
            img.src = e.target.result;
        };
        reader.onerror = function() {
            reject(new Error('Failed to read file'));
        };
        reader.readAsDataURL(file);
    });
}

// Handle profile photo upload during onboarding wizard
function handleWizardProfilePhoto(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            input.value = '';
            return;
        }

        const container = document.getElementById('wizard-profile-photo-container');
        const placeholder = document.getElementById('wizard-profile-photo-placeholder');
        const img = document.getElementById('wizard-profile-photo-img');

        if (container) container.style.opacity = '0.5';

        resizeImageFile(file, 400, 0.8).then(photoData => {
            // Show the image, hide placeholder
            if (img) {
                img.src = photoData;
                img.style.display = 'block';
            }
            if (placeholder) placeholder.style.display = 'none';
            if (container) container.style.opacity = '1';

            // Save to localStorage (same key as main profile photo)
            try {
                localStorage.setItem('profile_photo', photoData);
            } catch (e) {
                console.error('Failed to save wizard profile photo:', e);
            }

            // Also update main profile photo elements if they exist
            const mainImg = document.getElementById('profile-photo-img');
            if (mainImg) mainImg.src = photoData;
            document.querySelectorAll('.profile-icon').forEach(el => {
                el.innerHTML = `<img src="${photoData}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                el.style.background = 'transparent';
            });

            input.value = '';
        }).catch(err => {
            console.error('Failed to process wizard profile photo:', err);
            alert('Failed to process image. Please try a different photo.');
            if (container) container.style.opacity = '1';
            input.value = '';
        });
    }
}

function connectApp(appName) {
    const btn = event.target;
    btn.innerText = "Connecting...";
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerText = "Connected";
        btn.classList.add('connected');
        alert(`${appName} connected successfully! (Simulation)`);
    }, 1500);
}




// Real switchAppTab implementation - replaces the early stub
function _switchAppTabReal(tabName, btn) {
    // Track current active tab for level-up animation visibility
    if (typeof currentActiveTab !== 'undefined') {
        currentActiveTab = tabName;
    }

    // 1. Update Bottom Nav UI
    document.querySelectorAll('.bottom-nav .nav-item').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    else {
        // simple fallback
    }

    // 1.5. Restore bottom navigation visibility for normal tabs
    document.querySelector('.bottom-nav').style.display = 'flex';

    // 1.6. Clear Android navigation stack when switching to main tabs
    if (typeof clearNavigationStack === 'function') {
        clearNavigationStack();
    }

    // 2. Clear All Views
    hideAllAppViews();

    // 3. Show Target View
    if (tabName === 'dashboard') {
        document.getElementById('view-dashboard').style.display = 'block';

        // Show pending level-up celebration if user leveled up while on another screen
        // (This is a fallback - the new celebration system auto-navigates, so this rarely triggers)
        if (typeof pendingLevelUp !== 'undefined' && pendingLevelUp) {
            setTimeout(() => {
                triggerLevelUpCelebration(
                    pendingLevelUp.level,
                    pendingLevelUp.title,
                    pendingLevelUp.previousLevel,
                    pendingLevelUp.lifetimePoints,
                    pendingLevelUp.currentStreak || 0,
                    pendingLevelUp.previousProgress || 0
                );
                pendingLevelUp = null;
            }, 500);
        }

        // Check for celebration that was interrupted by page reload
        if (typeof checkPendingLevelUpCelebration === 'function') {
            setTimeout(() => checkPendingLevelUpCelebration(), 1500);
        }

        // Hide Today's Priority section if user doesn't have meal plan access
        const todaysPrioritySection = document.getElementById('todays-priority-section');
        if (todaysPrioritySection) {
            const access = typeof checkMealPlanAccess === 'function' ? checkMealPlanAccess() : { hasAccess: true };
            todaysPrioritySection.style.display = access.hasAccess ? '' : 'none';
        }

        // Load live challenges on home screen
        if (typeof loadHomeChallenges === 'function') {
            loadHomeChallenges();
        }

        // Render featured monthly rare card
        if (typeof renderFeaturedRareCard === 'function') {
            renderFeaturedRareCard();
        }

        // Check for expired challenges that need completing (grants rare rewards)
        if (typeof checkAndCompleteExpiredChallenges === 'function') {
            checkAndCompleteExpiredChallenges();
        }

        // Load coin balance
        if (typeof loadCoinBalance === 'function') {
            loadCoinBalance();
        }

        // Refresh weigh-in card and modal visibility on dashboard visit
        if (typeof checkAndShowWeighInModal === 'function') {
            checkAndShowWeighInModal();
        }
        if (typeof checkAndShowWeighInCard === 'function') {
            checkAndShowWeighInCard();
        }
        if (typeof checkAndShowDailyQuizCard === 'function') {
            checkAndShowDailyQuizCard();
        }
        if (typeof checkAndShowMealTipCard === 'function') {
            checkAndShowMealTipCard();
        }
        if (typeof checkAndShowProgressPhotoCard === 'function') {
            checkAndShowProgressPhotoCard();
        }
        if (typeof checkAndShowWorkoutTrendCard === 'function') {
            checkAndShowWorkoutTrendCard();
        }
    } else if (tabName === 'meals') {
        document.getElementById('view-meals').style.display = 'block';

        // Initialize meal plan view (handles quiz vs non-quiz users)
        if (typeof initializeMealPlanView === 'function') {
            initializeMealPlanView();
        }

        if (!document.querySelector('#meals-content-container .view-section.active')) {
            // Default to calorie tracker for all users
            switchWeek('calorie-tracker');
        } else if (document.getElementById('today').classList.contains('active')) {
            renderTodayMeals(); // Refresh today view if active
        }
    } else if (tabName === 'movement-tab') {
        const el = document.getElementById('movement-tab');
        if(el) {
            el.classList.add('active');
            el.style.display='block';
            renderMovementView();

            // Load workout trend card in Movement tab
            if (typeof loadMovementTrendCard === 'function') {
                loadMovementTrendCard();
            }

            // Auto-Check-in Logic (Once per day)
            const todayStr = new Date().toDateString();
            const lastAuto = localStorage.getItem('last_auto_checkin_date');

            // Auto check-in disabled per user request
            // if (lastAuto !== todayStr) { ... }
        }
    } else if (tabName === 'support') {
        // Support view removed - open coach chat modal instead
        openCoachChatModal();
    } else if (tabName === 'profile') {
        const el = document.getElementById('view-profile');
        if(el) {
            el.classList.add('active');
            el.style.display='block';
            // Decouple data loading so errors don't stop view from showing
            setTimeout(loadProfileData, 10);
            // Update settings icon when profile view is shown
            if (typeof updateSettingsIcon === 'function') {
                setTimeout(updateSettingsIcon, 100);
            }
            // Show/hide allocate battle stats button based on unallocated points
            setTimeout(() => {
                const allocBtn = document.getElementById('settings-allocate-stats-btn');
                if (allocBtn && typeof getUnallocatedPoints === 'function') {
                    const pts = getUnallocatedPoints();
                    allocBtn.style.display = pts > 0 ? 'flex' : 'none';
                }
            }, 200);
        }
    } else if (tabName === 'progress') {
        // Progress is now inside Movement tab - redirect there and open progress view
        const movEl = document.getElementById('movement-tab');
        if(movEl) {
            movEl.classList.add('active');
            movEl.style.display='block';
            renderMovementView();
        }
        // Auto-open progress view from movement
        setTimeout(() => { if(typeof openProgressFromMovement === 'function') openProgressFromMovement(); }, 100);
    } else if (tabName === 'learning') {
        const el = document.getElementById('view-learning');
        if(el) {
            el.style.display = 'block';
            if(typeof initLearning === 'function') initLearning();
        }
    } else if (tabName === 'cycle') {
        const el = document.getElementById('view-cycle');
        if(el) {
            el.style.display = 'block';
            if(typeof initCycleView === 'function') initCycleView();
        }
    } else if (tabName === 'friends') {
        const el = document.getElementById('view-friends');
        if(el) {
            el.style.display = 'block';
            if(typeof initFriendsView === 'function') initFriendsView();
        }
    }

    // Trigger Cycle Sync Check if entering Dashboard
    if(tabName === 'dashboard' && typeof checkAndRenderCycleSync === 'function') {
        checkAndRenderCycleSync();
    }

    // Update friends pill count on home page
    if(tabName === 'dashboard' && typeof updateHomeFriendsPillCount === 'function') {
        updateHomeFriendsPillCount();
    }

    window.scrollTo(0,0);
}

// Mark real implementation as ready and process any queued calls
_switchAppTabReady = true;
switchAppTab = _switchAppTabReal;
if (_switchAppTabQueue && _switchAppTabQueue.length > 0) {
    console.log('Processing ' + _switchAppTabQueue.length + ' queued switchAppTab calls');
    _switchAppTabQueue.forEach(function(call) {
        _switchAppTabReal(call.tabName, call.btn);
    });
    _switchAppTabQueue = [];
}

// --- CALENDAR & CYCLE LOGIC ---
const PHASE_INFO = {
    menstrual: { name: 'Menstrual Phase', color: '#E57373', css: 'phase-menstrual', rec: 'Rest, Walking, Yin Yoga', icon: '🩸' },
    follicular: { name: 'Follicular Phase', color: '#F06292', css: 'phase-follicular', rec: 'HIIT, Strength, Cardio', icon: '⚡' },
    ovulation: { name: 'Ovulation Phase', color: '#BA68C8', css: 'phase-ovulation', rec: 'Max Effort, PB Attempts', icon: '🥚' },
    luteal: { name: 'Luteal Phase', color: '#FFB74D', css: 'phase-luteal', rec: 'Strength (Mod), Pilates', icon: '🌙' },
    wellness: { name: 'Wellness Cycle', color: '#4DB6AC', css: 'phase-follicular', rec: 'Balanced Activity / Strength', icon: '🌿' },
    performance: { name: 'Performance Mode', color: '#3b82f6', css: 'phase-performance', rec: 'Strength, HIIT, Progressive Overload', icon: '💪' }
};

// Update userCycleData (already declared early to prevent undefined errors)
userCycleData = {
    lastPeriod: null,
    cycleLength: 28,
    mood: null, // 'strong' or 'tired'
    noPeriodMode: false,
    symptoms: [],
    logs: {}, // { "YYYY-MM-DD": { flow, symptoms:[], mood, energy } }
    dailyCheckIn: null // { date: "YYYY-MM-DD", status: "completed" }
};

function setCycleMood(mood, btn) {
    userCycleData.mood = mood;
    // UI Update
    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // Re-render suggestions
    renderCycleStatus();
    renderWeeklyCalendar();
}

function toggleNoPeriodMode() {
    const isChecked = document.getElementById('no-period-toggle-profile').checked;
    userCycleData.noPeriodMode = isChecked;

    const inputContainer = document.getElementById('last-period-input-profile');
    if(inputContainer) inputContainer.disabled = isChecked;

    updateCycleData();
}

async function initCalendarView() {
    // 1. Try to load from localStorage first (works for non-logged-in users)
    try {
        const savedCycleData = localStorage.getItem('userCycleData');
        if (savedCycleData) {
            const parsed = JSON.parse(savedCycleData);
            if (parsed.lastPeriod) {
                userCycleData.lastPeriod = parsed.lastPeriod;
                const lastPeriodInput = document.getElementById('last-period-input-profile');
                if (lastPeriodInput) lastPeriodInput.value = userCycleData.lastPeriod;
            }
            if (parsed.cycleLength) {
                userCycleData.cycleLength = parseInt(parsed.cycleLength);
                const cycleLengthInput = document.getElementById('cycle-length-input-profile');
                if (cycleLengthInput) cycleLengthInput.value = userCycleData.cycleLength;
            }
            if (parsed.noPeriodMode) {
                userCycleData.noPeriodMode = true;
                const noPeriodToggle = document.getElementById('no-period-toggle-profile');
                if (noPeriodToggle) noPeriodToggle.checked = true;
                const lastPeriodInput = document.getElementById('last-period-input-profile');
                if (lastPeriodInput) lastPeriodInput.disabled = true;
            }
            // Load logs for Cycle Sync
            if (parsed.logs) {
                userCycleData.logs = parsed.logs;
            }
        }
    } catch (e) {
        console.log("Error loading cycle data from localStorage", e);
    }

    // 2. Fetch Cycle Data from DB (user_facts) - overrides localStorage if logged in
    if (window.currentUser) {
        try {
            const userId = window.currentUser.id || window.currentUser.user_id;
            const facts = await dbHelpers.userFacts.get(userId);
            console.log('📊 Loaded user_facts from DB:', facts);
            console.log('📊 additional_data:', facts?.additional_data);
            if (facts && facts.additional_data) {
                if (facts.additional_data.last_period_start) {
                    userCycleData.lastPeriod = facts.additional_data.last_period_start;
                    const lastPeriodInput = document.getElementById('last-period-input-profile');
                    if (lastPeriodInput) lastPeriodInput.value = userCycleData.lastPeriod;
                    console.log('✅ Loaded lastPeriod from DB:', userCycleData.lastPeriod);
                }
                if (facts.additional_data.cycle_length) {
                    userCycleData.cycleLength = parseInt(facts.additional_data.cycle_length);
                    const cycleLengthInput = document.getElementById('cycle-length-input-profile');
                    if (cycleLengthInput) cycleLengthInput.value = userCycleData.cycleLength;
                    console.log('✅ Loaded cycleLength from DB:', userCycleData.cycleLength);
                }
                if (facts.additional_data.no_period_mode) {
                    userCycleData.noPeriodMode = true;
                    const noPeriodToggle = document.getElementById('no-period-toggle-profile');
                    if (noPeriodToggle) noPeriodToggle.checked = true;
                    const lastPeriodInput = document.getElementById('last-period-input-profile');
                    if (lastPeriodInput) lastPeriodInput.disabled = true;
                    console.log('✅ Loaded noPeriodMode from DB:', userCycleData.noPeriodMode);
                }
            } else {
                console.warn('⚠️ No additional_data found in user_facts');
            }
        } catch (e) {
            console.log("❌ No existing cycle data found or error fetching", e);
        }
    }

    renderCycleStatus();
    renderWeeklyCalendar();

    // Restore saved calendar view preference (weekly/monthly)
    const savedViewPref = localStorage.getItem('calendarViewPreference');
    if (savedViewPref === 'monthly') {
        switchCalendarView('monthly');
    }
}

async function updateCycleData() {
    const startInput = document.getElementById('last-period-input-profile').value;
    const lengthInput = document.getElementById('cycle-length-input-profile').value;
    const noPeriod = document.getElementById('no-period-toggle-profile').checked;

    userCycleData.noPeriodMode = noPeriod;

    if (!noPeriod && !startInput) return; // Wait for input if not in wellness mode

    userCycleData.lastPeriod = startInput;
    userCycleData.cycleLength = parseInt(lengthInput);

    // Always save to localStorage first (works for all users)
    localStorage.setItem('userCycleData', JSON.stringify(userCycleData));

    // Also save to DB if logged in (background, non-blocking)
    if (window.currentUser) {
        (async () => {
            try {
                const userId = window.currentUser.id || window.currentUser.user_id;
                let existingFacts = {};
                try {
                    existingFacts = await dbHelpers.userFacts.get(userId);
                } catch(err) { /* ignore not found */ }
                
                const currentAdditional = existingFacts?.additional_data || {};
                
                await dbHelpers.userFacts.upsert(userId, {
                    additional_data: {
                        ...currentAdditional,
                        last_period_start: userCycleData.lastPeriod,
                        cycle_length: userCycleData.cycleLength,
                        no_period_mode: userCycleData.noPeriodMode
                    }
                });
            } catch (e) {
                // DB save failed but localStorage worked, user data is safe
                console.warn("Cycle data saved locally. Cloud sync pending.", e.message);
            }
        })();
    }

    renderCycleStatus();
    renderWeeklyCalendar();

    // Also update monthly calendar if visible
    const monthlyCalendar = document.getElementById('monthly-calendar');
    if (monthlyCalendar && monthlyCalendar.style.display !== 'none') {
        renderMonthlyCalendar();
    }
}

function getCyclePhase(dayOfCycle, cycleLen) {
    // For male users, always return 'performance' (no cycle tracking)
    if (typeof isMaleUser === 'function' && isMaleUser()) {
        return 'performance';
    }

    // Basic Algo
    // Day 1-5: Menstrual
    // Day 6-13: Follicular
    // Day 14: Ovulation (approx mid-cycle)
    // Day 15-End: Luteal

    // Adjust for cycle length:
    // Menstrual is usually fixed ~5
    // Luteal is usually fixed ~14 days before end.
    // Follicular varies.

    const ovulationDay = cycleLen - 14;

    if (dayOfCycle <= 5) return 'menstrual';
    if (dayOfCycle < ovulationDay) return 'follicular';
    if (dayOfCycle === ovulationDay) return 'ovulation';
    return 'luteal';
}

function renderCycleStatus() {
    // For male users, show Performance Mode (no cycle tracking)
    if (typeof isMaleUser === 'function' && isMaleUser()) {
        const phase = PHASE_INFO['performance'];
        const phaseName = document.getElementById('cycle-phase-name');
        const phaseDesc = document.getElementById('cycle-phase-desc');
        const cycleDayDisplay = document.getElementById('cycle-day-display');

        if (phaseName) {
            phaseName.innerText = phase.name;
            phaseName.style.color = phase.color;
        }
        if (cycleDayDisplay && cycleDayDisplay.parentElement) {
            cycleDayDisplay.parentElement.style.display = 'none'; // Hide day counter for males
        }
        if (phaseDesc) {
            phaseDesc.innerText = "Train based on energy and recovery. Push hard, recover smart.";
        }

        // Update recommendation
        let suggestion = phase.rec;
        const recText = document.getElementById('rec-text');
        if (recText) recText.innerText = suggestion;

        const recCard = document.getElementById('today-workout-rec');
        if (recCard) recCard.style.background = phase.color;

        return;
    }

    if (userCycleData.noPeriodMode) {
        // Wellness Mode View
        const phase = PHASE_INFO['wellness'];
        document.getElementById('cycle-phase-name').innerText = phase.name;
        document.getElementById('cycle-phase-name').style.color = phase.color;
        document.getElementById('cycle-day-display').innerText = "General Wellness";
        document.getElementById('cycle-phase-desc').innerText = "Focus on a balanced routine of Strength, Cardio, and Rest.";
        
        const iconContainer = document.getElementById('cycle-phase-icon');
        if(iconContainer) {
            iconContainer.style.background = phase.color + '40';
            iconContainer.style.color = phase.color;
            iconContainer.innerHTML = phase.icon;
        }

        let suggestion = phase.rec;
        if (userCycleData.mood === 'tired') suggestion = "Rest / Light Walking";
        else if (userCycleData.mood === 'strong') suggestion = "Strength / HIIT";

        document.getElementById('rec-text').innerText = suggestion;
        const recCard = document.getElementById('today-workout-rec');
        if(recCard) recCard.style.background = phase.color;
        
        return;
    }

    if (!userCycleData.lastPeriod) {
        document.getElementById('cycle-phase-name').innerText = "Setup Required";
        document.getElementById('cycle-day-display').innerText = "Complete onboarding";
        document.getElementById('cycle-phase-desc').innerText = "Go to Settings > Edit Profile to complete your onboarding and see your cycle insights.";
        return;
    }

    const start = new Date(userCycleData.lastPeriod);
    const today = new Date();
    const msPerDay = 24 * 60 * 60 * 1000;
    const daysSinceStart = Math.floor((today - start) / msPerDay);
    
    // Handle cycle looping
    let currentDayRaw = (daysSinceStart % userCycleData.cycleLength) + 1;
    if (currentDayRaw < 1) currentDayRaw = 1; // Basic safety

    const phaseKey = getCyclePhase(currentDayRaw, userCycleData.cycleLength);
    const phase = PHASE_INFO[phaseKey];

    document.getElementById('cycle-phase-name').innerText = phase.name;
    document.getElementById('cycle-phase-name').style.color = phase.color;
    document.getElementById('cycle-day-display').innerText = `Day ${currentDayRaw} of ${userCycleData.cycleLength}`;
    
    // Icon
    const iconContainer = document.getElementById('cycle-phase-icon');
    if(iconContainer) {
        iconContainer.style.background = phase.color + '40'; // Low opacity bg
        iconContainer.style.color = phase.color;
        iconContainer.innerHTML = phase.icon;
    }

    // Description & Suggestion based on Mood
    let suggestion = phase.rec;
    if (userCycleData.mood === 'tired') {
        suggestion = "Restorative Yoga / Stretching (Listen to body)";
        if (phaseKey === 'follicular') suggestion = "Light Cardio / Walk";
    } else if (userCycleData.mood === 'strong' && phaseKey === 'menstrual') {
        suggestion = "Light Resistance / Pilates";
    }

    document.getElementById('cycle-phase-desc').innerText = `You are in ${phase.name}. Usual focus: ${phase.rec}.`;
    
    // Update Today's Rec Card (if it exists)
    const recText = document.getElementById('rec-text');
    if(recText) recText.innerText = suggestion;
    
    const recCard = document.getElementById('today-workout-rec');
    if(recCard) recCard.style.background = phase.color;
    
}

// --- CYCLE & CALENDAR ACTIONS ---

window.logPeriodStart = function() {
    const today = new Date();
    // Format YYYY-MM-DD local
    const offset = today.getTimezoneOffset();
    const local = new Date(today.getTime() - (offset*60*1000));
    const dateStr = local.toISOString().split('T')[0];
    
    userCycleData.lastPeriod = dateStr;
    localStorage.setItem('userCycleData', JSON.stringify(userCycleData));

    // Update Input if exists
    const input = document.getElementById('last-period-input-profile');
    if(input) input.value = dateStr;
    
    // Refresh Logic
    // If renderCycleStatus exists, call it.
    if(typeof renderCycleStatus === 'function') renderCycleStatus();
    renderWeeklyCalendar();
    
    // Visual Confirmation
    const btn = document.querySelector('button[onclick="logPeriodStart()"]');
    if(btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span style="color:#22c55e;">✓</span> Logged!';
        setTimeout(() => { btn.innerHTML = originalText; }, 2000);
    }
    
    // Also simulate selecting "Menstrual" mood? Or just let the cycle logic handle it.
    // Ideally we might assume they are "Tired" or "Cramps" but let's not assume.
};

function renderWeeklyCalendar() {
    const grid = document.getElementById('weekly-calendar');
    if(!grid) return;
    grid.innerHTML = '';

    // Self-healing: If variable is empty but input has value, sync it.
    const inputVal = document.getElementById('last-period-input-profile')?.value;
    if (!userCycleData.lastPeriod && inputVal) {
        userCycleData.lastPeriod = inputVal;
    }

    // Determine if we are in "Baseline" mode (no period data)
    // If no period is set, and we haven't explicitly set "noPeriodMode", we still want to show the calendar
    const isBaseline = !userCycleData.lastPeriod;

    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 is Sun, 1 is Mon
    // Calculate Monday of this week.
    const distToMon = (dayOfWeek + 6) % 7;
    const monday = new Date(today);
    monday.setDate(today.getDate() - distToMon);

    const msPerDay = 24 * 60 * 60 * 1000;
    
    // Start date for cycle calc
    const start = userCycleData.lastPeriod ? new Date(userCycleData.lastPeriod) : new Date();

    // Check if user qualifies for Gym Split (Male or Female)
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());

    // Check High Cortisol Profile (females only)
    const profileType = (sessionStorage.getItem('userResult') || '').toUpperCase();
    const isHighCortisol = !isMale && (profileType.includes('CORTISOL') || profileType.includes('ADRENAL'));

    // Load userProfile from localStorage, fallback to sessionStorage if needed
    let userProfile = {};
    try { userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}'); } catch(e) {}

    // BUGFIX: If equipment_access is missing in localStorage, check sessionStorage (from quiz)
    if (!userProfile.equipment_access) {
        let sessionProfile = {};
        try { sessionProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        if (sessionProfile.equipment_access) {
            userProfile.equipment_access = sessionProfile.equipment_access;
            // Save to localStorage for future use
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
        }
    }

    // NEW: Smart equipment override - most recent selection wins (check-in vs onboarding)
    const todayDateStr = new Date().toISOString().split('T')[0];
    const todayCheckIn = userCycleData.logs?.[todayDateStr];
    const checkInTimestamp = todayCheckIn?.timestamp;
    const onboardingTimestamp = localStorage.getItem('onboardingCompletedAt');

    if (todayCheckIn?.equipment) {
        // Both timestamps exist - compare them
        if (checkInTimestamp && onboardingTimestamp) {
            const checkInTime = new Date(checkInTimestamp).getTime();
            const onboardingTime = new Date(onboardingTimestamp).getTime();

            if (checkInTime > onboardingTime) {
                // Check-in is more recent - use check-in equipment
                userProfile.equipment_access = todayCheckIn.equipment;
                console.log('📅 Calendar using today\'s check-in equipment (more recent):', userProfile.equipment_access);
            } else {
                // Onboarding is more recent - keep profile equipment
                console.log('📅 Calendar using onboarding equipment (more recent):', userProfile.equipment_access);
            }
        } else {
            // No onboarding timestamp - use check-in equipment (backward compatibility)
            userProfile.equipment_access = todayCheckIn.equipment;
            console.log('📅 Calendar using today\'s check-in equipment:', userProfile.equipment_access);
        }
    } else if (!todayCheckIn && userCycleData.logs) {
        // No check-in today - use last check-in data (don't reset to defaults)
        const dates = Object.keys(userCycleData.logs).sort().reverse();
        const lastCheckIn = dates.find(date => userCycleData.logs[date]?.equipment);
        if (lastCheckIn) {
            userProfile.equipment_access = userCycleData.logs[lastCheckIn].equipment;
            console.log('📅 Calendar using last check-in equipment from', lastCheckIn, ':', userProfile.equipment_access);
        }
    }

    // equipment_access is the source of truth; gym_access is legacy fallback only if equipment_access is undefined
    const hasGymAccess = userProfile.equipment_access === 'gym' || (userProfile.equipment_access === undefined && userProfile.gym_access === true);
    const hasHighEnergy = userProfile.energy_status === 'high';
    // Male and female gym splits now have IDENTICAL requirements: gym access only
    // Females can opt-in to cycle sync for automatic adjustments during menstrual phase
    const useMaleGymSplit = isMale && hasGymAccess;
    const useFemaleGymSplit = !isMale && hasGymAccess;

    // Determine equipment access - simplified direct checks (like gym split)
    const hasDumbbells = userProfile.equipment_access === 'dumbbells' || userProfile.equipment_access === 'home';
    const hasBands = userProfile.equipment_access === 'bands';
    const hasYogaOnly = userProfile.equipment_access === 'yoga_only';

    // SIMPLIFIED: Direct equipment checks (same pattern as gym split - no defaultStrengthProgram complexity)
    const useYogaOnly = hasYogaOnly;
    const useHome = hasDumbbells && !hasGymAccess;
    const useBands = hasBands && !hasDumbbells && !hasGymAccess;

    // Calculate which week we're in for 12 different 4-week programs (48 weeks total)
    function getGymSplitWeekNumber() {
        if (!useMaleGymSplit && !useFemaleGymSplit) return 1;

        let startDate = localStorage.getItem('gym_split_start_date');
        if (!startDate) {
            // First time using gym split - set start date to this week's Monday
            const today = new Date();
            const dayOfWeek = today.getDay();
            const distToMon = (dayOfWeek + 6) % 7;
            const monday = new Date(today);
            monday.setDate(today.getDate() - distToMon);
            monday.setHours(0, 0, 0, 0);
            startDate = monday.toISOString().split('T')[0];
            localStorage.setItem('gym_split_start_date', startDate);
        }

        // Calculate weeks elapsed since start
        const start = new Date(startDate);
        const now = new Date();
        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
        const weeksElapsed = Math.floor((now - start) / msPerWeek);

        // Return week number 1-48 (12 programs × 4 weeks each)
        return (weeksElapsed % 48) + 1;
    }

    const currentWeek = getGymSplitWeekNumber();

    // Helper to get the workout index based on which 4-week program we're in
    function getWorkoutIndexForWeek(numWorkouts) {
        // Calculate which 4-week program (0-11)
        // Week 1-4 = Program 0 (uses workout 1)
        // Week 5-8 = Program 1 (uses workout 2)
        // Week 9-12 = Program 2 (uses workout 3)
        // etc.
        const programNumber = Math.floor((currentWeek - 1) / 4);
        return programNumber % numWorkouts; // Cycles through available workouts
    }

    // Weekly Schedule Template - maps to WORKOUT_DB programs
    // Each day references a program and the day index within that program's schedule
    let WEEKLY_SCHEDULE;
    let usingCustomProgram = false;
    let customProgramInfo = null;

    // Check for active custom program first
    const activeCustomProgram = window.activeCustomProgramCache;
    if (activeCustomProgram && activeCustomProgram.is_active && activeCustomProgram.start_date) {
        // Check if program is still within its duration
        const startDate = new Date(activeCustomProgram.start_date);
        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
        const weeksElapsed = Math.floor((today - startDate) / msPerWeek);
        const currentWeek = weeksElapsed + 1;

        if (currentWeek <= activeCustomProgram.duration_weeks) {
            // Use custom program schedule
            const schedule = activeCustomProgram.weekly_schedule || [];
            WEEKLY_SCHEDULE = schedule.map((item, idx) => {
                if (!item.workout || item.workout.type === 'rest') {
                    return { day: item.day, program: 'rest', dayIndex: idx, isRest: true };
                }
                return {
                    day: item.day,
                    program: item.workout.category || 'custom',
                    dayIndex: idx,
                    subcategory: item.workout.subcategory || '',
                    muscleGroup: item.workout.subcategory || '',
                    customWorkout: item.workout
                };
            });
            usingCustomProgram = true;
            customProgramInfo = {
                name: activeCustomProgram.program_name,
                currentWeek: currentWeek,
                totalWeeks: activeCustomProgram.duration_weeks
            };
            console.log('📅 Calendar using custom program:', activeCustomProgram.program_name, `Week ${currentWeek}/${activeCustomProgram.duration_weeks}`);
        }
    }

    // Fall back to equipment-based schedule if no custom program
    if (!usingCustomProgram && useMaleGymSplit) {
        // Male Gym Split: Chest, Legs, Back, Shoulders, Arms+Core, Deep Fascia Release (Sat/Sun)
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'gym_split', dayIndex: 0, muscleGroup: 'chest' }, // Chest
            { day: 'Tue', program: 'gym_split', dayIndex: 1, muscleGroup: 'legs' }, // Legs
            { day: 'Wed', program: 'gym_split', dayIndex: 2, muscleGroup: 'back' }, // Back
            { day: 'Thu', program: 'gym_split', dayIndex: 3, muscleGroup: 'shoulders' }, // Shoulders
            { day: 'Fri', program: 'gym_split', dayIndex: 4, muscleGroup: 'armscore' }, // Arms & Core
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'yin' }, // Deep Fascia Release
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }  // Deep Fascia Release
        ];
    } else if (!usingCustomProgram && useFemaleGymSplit) {
        // Female Gym Split: Legs, Push, Arms+Core, Legs, Pull, Active Recovery (Yoga), Rest (Yoga)
        // Same as males: yoga on weekends for active recovery
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'female_gym_split', dayIndex: 0, muscleGroup: 'legs' }, // Legs
            { day: 'Tue', program: 'female_gym_split', dayIndex: 1, muscleGroup: 'push' }, // Push
            { day: 'Wed', program: 'female_gym_split', dayIndex: 2, muscleGroup: 'armscore' }, // Arms & Core
            { day: 'Thu', program: 'female_gym_split', dayIndex: 3, muscleGroup: 'legs' }, // Legs
            { day: 'Fri', program: 'female_gym_split', dayIndex: 4, muscleGroup: 'pull' }, // Pull
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power' }, // Active Recovery
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }  // Rest
        ];
    } else if (!usingCustomProgram && useYogaOnly) {
        // Yoga Only - direct check like gym split
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'yoga', dayIndex: 0, subcategory: 'power' },
            { day: 'Tue', program: 'yoga', dayIndex: 1, subcategory: 'restorative' },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'yin' },
            { day: 'Thu', program: 'yoga', dayIndex: 3, subcategory: 'restorative' },
            { day: 'Fri', program: 'yoga', dayIndex: 4, subcategory: 'power' },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power' },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }
        ];
    } else if (!usingCustomProgram && useHome) {
        // Home/Dumbbell Split - direct check like gym split
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'home', dayIndex: 0, subcategory: 'lowerbody' },
            { day: 'Tue', program: 'home', dayIndex: 1, subcategory: 'push' },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'restorative' },
            { day: 'Thu', program: 'home', dayIndex: 3, subcategory: 'pull' },
            { day: 'Fri', program: 'home', dayIndex: 4, subcategory: 'lowerbody' },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power' },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }
        ];
    } else if (!usingCustomProgram && useBands) {
        // Resistance Bands Split - direct check like gym split
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'bands', dayIndex: 0 },
            { day: 'Tue', program: 'bands', dayIndex: 1 },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'restorative' },
            { day: 'Thu', program: 'bands', dayIndex: 3 },
            { day: 'Fri', program: 'bands', dayIndex: 4 },
            { day: 'Sat', program: 'bands', dayIndex: 5 },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }
        ];
    } else if (!usingCustomProgram) {
        // Bodyweight Split (fallback - no equipment)
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'bodyweight', dayIndex: 0, subcategory: 'lowerbody' },
            { day: 'Tue', program: 'bodyweight', dayIndex: 1, subcategory: 'upperbody' },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'restorative' },
            { day: 'Thu', program: 'bodyweight', dayIndex: 3, subcategory: 'core' },
            { day: 'Fri', program: 'bodyweight', dayIndex: 4, subcategory: 'lowerbody' },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power' },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }
        ];
    }

    // Helper to get workout from WORKOUT_DB or WORKOUT_LIBRARY (for gym split rotation)
    function getWorkoutForDay(dayIdx, checkDateStr) {
        // Check if there's equipment selection for this specific day
        let dayEquipment = null;
        if (checkDateStr && userCycleData.logs && userCycleData.logs[checkDateStr] && userCycleData.logs[checkDateStr].equipment) {
            dayEquipment = userCycleData.logs[checkDateStr].equipment;
        }

        let scheduleItem = WEEKLY_SCHEDULE[dayIdx];

        // Override program based on equipment selection for this day
        if (dayEquipment) {
            if (dayEquipment === 'gym' && (useMaleGymSplit || useFemaleGymSplit)) {
                // Keep gym split
                // scheduleItem stays the same
            } else if (dayEquipment === 'gym') {
                // User selected gym but doesn't qualify for split - use gym program
                scheduleItem = { ...scheduleItem, program: 'gym', dayIndex: dayIdx };
            } else if (dayEquipment === 'dumbbells') {
                scheduleItem = { ...scheduleItem, program: 'home', dayIndex: dayIdx };
            } else if (dayEquipment === 'bands') {
                scheduleItem = { ...scheduleItem, program: 'bands', dayIndex: dayIdx };
            } else if (dayEquipment === 'none') {
                scheduleItem = { ...scheduleItem, program: 'bodyweight', dayIndex: dayIdx };
            } else if (dayEquipment === 'yoga_only') {
                scheduleItem = { ...scheduleItem, program: 'yoga', dayIndex: dayIdx, subcategory: 'power' };
            }
        }

        // For gym split with muscle group, pull from WORKOUT_LIBRARY with 48-week rotation
        if ((scheduleItem.program === 'gym_split' || scheduleItem.program === 'female_gym_split') && scheduleItem.muscleGroup && typeof WORKOUT_LIBRARY !== 'undefined') {
            const muscleGroup = scheduleItem.muscleGroup;
            const gymCategory = WORKOUT_LIBRARY['gym'];

            if (gymCategory && gymCategory.subcategories && gymCategory.subcategories[muscleGroup]) {
                const workouts = gymCategory.subcategories[muscleGroup].workouts;

                // Get workout index based on current week in 48-week cycle
                const workoutIndex = getWorkoutIndexForWeek(workouts.length);
                const workout = workouts[workoutIndex];

                // Calculate which 4-week program we're in (1-12)
                const programNumber = Math.floor((currentWeek - 1) / 4) + 1;
                const weekInProgram = ((currentWeek - 1) % 4) + 1;

                if (workout) {
                    return {
                        title: workout.name,
                        programName: `Gym - Program ${programNumber}, Week ${weekInProgram}`,
                        programId: 'gym_library',
                        libraryWorkout: { category: 'gym', subcategory: muscleGroup, workoutId: workout.id },
                        exercises: workout.exercises
                    };
                }
            }
        }

        // For yoga/bodyweight/home with subcategories, pull from WORKOUT_LIBRARY with rotation
        if (scheduleItem.subcategory && typeof WORKOUT_LIBRARY !== 'undefined') {
            const category = WORKOUT_LIBRARY[scheduleItem.program];

            if (category && category.subcategories && category.subcategories[scheduleItem.subcategory]) {
                const workouts = category.subcategories[scheduleItem.subcategory].workouts;

                // Get workout index based on current week
                const workoutIndex = getWorkoutIndexForWeek(workouts.length);
                const workout = workouts[workoutIndex];

                if (workout) {
                    // For 48-week programs (10+ workouts), show program/week info
                    let programName = category.name;
                    if (workouts.length >= 10) {
                        const programNumber = Math.floor((currentWeek - 1) / 4) + 1;
                        const weekInProgram = ((currentWeek - 1) % 4) + 1;
                        programName = `${category.name} - Program ${programNumber}, Week ${weekInProgram}`;
                    }

                    return {
                        title: workout.name,
                        programName: programName,
                        programId: scheduleItem.program + '_library',
                        libraryWorkout: { category: scheduleItem.program, subcategory: scheduleItem.subcategory, workoutId: workout.id },
                        exercises: workout.exercises
                    };
                }
            }
        }

        // Default: use WORKOUT_DB
        const program = window.WORKOUT_DB?.[scheduleItem.program];
        if (program && program.schedule && program.schedule[scheduleItem.dayIndex]) {
            const workout = program.schedule[scheduleItem.dayIndex];
            return {
                title: workout.title,
                programName: program.name,
                programId: scheduleItem.program,
                exercises: workout.exercises
            };
        }
        // Fallback
        return { title: scheduleItem.day + ' Workout', programName: 'General', programId: 'bodyweight', exercises: [] };
    }

    for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        
        const isToday = d.toDateString() === today.toDateString();
        
        let headerColor = '';
        let phaseDotHtml = '';
        const dayDateStr = d.toISOString().split('T')[0];
        const dayWorkout = getWorkoutForDay(i, dayDateStr);
        let workoutName = dayWorkout.title;
        let phase = PHASE_INFO.wellness; // Default
        let phaseKey = 'wellness';
        let currentDayLoop = 0;

        if (isBaseline) {
            // Baseline Mode: Just show standard workout, no phase info
            if(isToday) headerColor = PHASE_INFO.wellness.color;

        } else {
            // Cycle Mode
            const daysSinceStart = Math.floor((d - start) / msPerDay);
            // Handle negative modulo correctly
            let mod = daysSinceStart % userCycleData.cycleLength;
            if (mod < 0) mod += userCycleData.cycleLength;
            currentDayLoop = mod + 1;
            
            phaseKey = getCyclePhase(currentDayLoop, userCycleData.cycleLength);
            phase = PHASE_INFO[phaseKey];

            if(isToday) headerColor = phase.color;
        }

        // Apply Modifiers
        const isMaleCalendar = (typeof isMaleUser === 'function' && isMaleUser());

        // Check if user selected equipment in today's check-in
        let userSelectedEquipmentForThisDay = false;
        if (userCycleData.logs && userCycleData.logs[dayDateStr] && userCycleData.logs[dayDateStr].equipment) {
            userSelectedEquipmentForThisDay = true;
        }

        if (!isBaseline) {
            // 1. Phase Modifiers - swap to yoga on menstrual phase if doing strength (females only)
            // BUT respect equipment selection from check-in
            if (!isMaleCalendar && phaseKey === 'menstrual' && (dayWorkout.programId === 'bodyweight' || dayWorkout.programId === 'gym_library') && !userSelectedEquipmentForThisDay) {
                // Swap to gentle yoga ONLY if user didn't explicitly select equipment
                const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative Recovery
                if (yogaWorkout) workoutName = yogaWorkout.title;
            }
        }

        // 2. High Cortisol Safety Override - encourage yoga over HIIT (but not for gym split users)
        if (isHighCortisol && !useMaleGymSplit && !useFemaleGymSplit && (dayWorkout.programId === 'bodyweight' || dayWorkout.programId === 'gym_library')) {
            const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[0]; // Somatic Hormone Reset
            if (yogaWorkout) workoutName = yogaWorkout.title;
        }

        // 3. Daily Mood/Symptoms only apply to TODAY
        if (isToday) {
            // Swap to yoga if user reports being tired (applies to all users including males)
            if (userCycleData.mood === 'tired') {
                const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative Recovery
                if (yogaWorkout) workoutName = yogaWorkout.title;
            }
            if (userCycleData.symptoms && userCycleData.symptoms.length > 0) {
                // Hot flash and dizziness are female-specific
                if (!isMaleCalendar && (userCycleData.symptoms.includes('hot_flash') || userCycleData.symptoms.includes('dizziness'))) {
                    const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative
                    if (yogaWorkout) workoutName = yogaWorkout.title;
                } else if (userCycleData.symptoms.includes('fatigue') || userCycleData.symptoms.includes('anxiety')) {
                    // Fatigue/anxiety triggers yoga for everyone (males & females)
                    const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[6]; // Yin & Meditation
                    if (yogaWorkout) workoutName = yogaWorkout.title;
                }
            }
        }

        const row = document.createElement('div');
        row.className = `calendar-day-row ${isToday ? 'is-today' : ''}`;
        
        // Construct Phase Dot HTML
        if (isBaseline) {
             // In baseline, maybe just show "Schedule" or nothing
             phaseDotHtml = `<span class="cal-phase-dot" style="background:#cbd5e1"></span> <span style="font-size:0.8rem; color:#94a3b8;">Standard</span>`;
        } else {
             if (!userCycleData.noPeriodMode) {
                 phaseDotHtml = `<span class="cal-phase-dot" style="background:${phase.color}"></span>
                                 <span style="opacity:0.8; font-size:0.8rem;">${phase.name} (Day ${currentDayLoop})</span>`;
             } else {
                 phaseDotHtml = `<span class="cal-phase-dot" style="background:${PHASE_INFO.wellness.color}"></span> <span style="font-size:0.8rem">Balanced</span>`;
             }
        }

        // Check for active replacement for this day
        const replacement = getReplacementForDay ? getReplacementForDay(i) : null;
        let displayWorkoutName = workoutName;
        let hasReplacement = false;

        if (replacement && replacement.replacement_workout) {
            displayWorkoutName = replacement.replacement_workout.name || workoutName;
            hasReplacement = true;
        }

        row.innerHTML = `
            <div class="cal-date-box">
                <span class="cal-day-name">${WEEKLY_SCHEDULE[i].day}</span>
                <span class="cal-day-num" style="color:${isToday ? (isBaseline ? '#046A38' : headerColor) : ''}">${d.getDate()}</span>
            </div>
            <div class="cal-context" onclick="openCalendarActionModal(${i}, '${displayWorkoutName.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                <div style="font-size: 0.9em; margin-bottom: 2px;">
                    ${phaseDotHtml}
                </div>
                <div class="cal-workout-tag">${displayWorkoutName}${hasReplacement ? ' <span style="font-size: 0.7rem; color: #f59e0b;" title="Replacement active">🔄</span>' : ''}</div>
            </div>
        `;
        grid.appendChild(row);
    }
}

// --- MONTHLY CALENDAR VIEW ---

// Track current displayed month for monthly calendar
let monthlyCalendarDate = new Date();

// Switch between weekly and monthly calendar views
window.switchCalendarView = function(view) {
    const weeklyCalendar = document.getElementById('weekly-calendar');
    const monthlyCalendar = document.getElementById('monthly-calendar');
    const toggleBtns = document.querySelectorAll('#calendar-view-toggle .toggle-btn');

    if (!weeklyCalendar || !monthlyCalendar) return;

    toggleBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
    });

    if (view === 'weekly') {
        weeklyCalendar.style.display = 'flex';
        monthlyCalendar.style.display = 'none';
    } else {
        weeklyCalendar.style.display = 'none';
        monthlyCalendar.style.display = 'block';
        monthlyCalendarDate = new Date(); // Reset to current month when switching
        renderMonthlyCalendar();
    }

    // Save preference
    localStorage.setItem('calendarViewPreference', view);
};

// Navigate months in monthly calendar
window.navigateMonth = function(direction) {
    monthlyCalendarDate.setMonth(monthlyCalendarDate.getMonth() + direction);
    renderMonthlyCalendar();
};

function renderMonthlyCalendar() {
    const container = document.getElementById('monthly-calendar');
    if (!container) return;

    const today = new Date();
    const year = monthlyCalendarDate.getFullYear();
    const month = monthlyCalendarDate.getMonth();

    // First day of the month
    const firstDay = new Date(year, month, 1);
    // Last day of the month
    const lastDay = new Date(year, month + 1, 0);

    // Get day of week for first day (0 = Sunday, adjust for Monday start)
    let startDay = firstDay.getDay();
    startDay = startDay === 0 ? 6 : startDay - 1; // Convert to Monday = 0

    // Month name
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];

    // Start date for cycle calc
    const start = userCycleData.lastPeriod ? new Date(userCycleData.lastPeriod) : null;
    const cycleLen = userCycleData.cycleLength || 28;
    const msPerDay = 24 * 60 * 60 * 1000;
    const isBaseline = !userCycleData.lastPeriod;
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());

    // Build HTML
    let html = `
        <div class="monthly-calendar-container">
            <div class="monthly-calendar-header">
                <button class="month-nav-btn" onclick="navigateMonth(-1)">‹</button>
                <span class="month-title">${monthNames[month]} ${year}</span>
                <button class="month-nav-btn" onclick="navigateMonth(1)">›</button>
            </div>
            <div class="monthly-calendar-weekdays">
                <span>Mon</span>
                <span>Tue</span>
                <span>Wed</span>
                <span>Thu</span>
                <span>Fri</span>
                <span>Sat</span>
                <span>Sun</span>
            </div>
            <div class="monthly-calendar-grid">
    `;

    // Days from previous month
    const prevMonth = new Date(year, month, 0);
    for (let i = startDay - 1; i >= 0; i--) {
        const dayNum = prevMonth.getDate() - i;
        const date = new Date(year, month - 1, dayNum);
        html += renderMonthlyDayCell(date, today, start, cycleLen, msPerDay, isBaseline, isMale, true);
    }

    // Days of current month
    for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(year, month, d);
        html += renderMonthlyDayCell(date, today, start, cycleLen, msPerDay, isBaseline, isMale, false);
    }

    // Days from next month to fill the grid (6 rows = 42 cells)
    const totalCells = startDay + lastDay.getDate();
    const remainingCells = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
    for (let d = 1; d <= remainingCells; d++) {
        const date = new Date(year, month + 1, d);
        html += renderMonthlyDayCell(date, today, start, cycleLen, msPerDay, isBaseline, isMale, true);
    }

    html += `
            </div>
        </div>
    `;

    // Add legend (only for females with cycle tracking)
    if (!isMale) {
        html += `
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                <div style="display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: #64748b;">
                    <span style="width: 12px; height: 4px; background: ${PHASE_INFO.menstrual.color}; border-radius: 2px;"></span>
                    Menstrual
                </div>
                <div style="display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: #64748b;">
                    <span style="width: 12px; height: 4px; background: ${PHASE_INFO.follicular.color}; border-radius: 2px;"></span>
                    Follicular
                </div>
                <div style="display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: #64748b;">
                    <span style="width: 12px; height: 4px; background: ${PHASE_INFO.ovulation.color}; border-radius: 2px;"></span>
                    Ovulation
                </div>
                <div style="display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: #64748b;">
                    <span style="width: 12px; height: 4px; background: ${PHASE_INFO.luteal.color}; border-radius: 2px;"></span>
                    Luteal
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

// Helper to get workout label for monthly calendar view
function getMonthlyWorkoutLabel(dayIndex, isMale) {
    // Load user profile to determine schedule type
    let userProfile = {};
    try { userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}'); } catch(e) {}
    if (!userProfile.equipment_access) {
        let sessionProfile = {};
        try { sessionProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        if (sessionProfile.equipment_access) {
            userProfile.equipment_access = sessionProfile.equipment_access;
        }
    }

    const equipment = userProfile.equipment_access || 'none';
    const hasGymAccess = equipment === 'gym';
    const goals = (userProfile.fitness_goals || []).map(g => (g || '').toLowerCase());
    const wantsStrength = goals.includes('build muscle') || goals.includes('increase strength');
    const useGymSplit = hasGymAccess && wantsStrength;
    const useYogaOnly = equipment === 'yoga_only';
    const useHome = equipment === 'dumbbells';
    const useBands = equipment === 'bands';

    // Define schedule labels based on equipment/goals
    if (useGymSplit && isMale) {
        // Male gym split: Chest, Legs, Back, Shoulders, Arms, Yoga, Yoga
        const labels = ['Chest', 'Legs', 'Back', 'Shoulders', 'Arms', 'Yoga', 'Yoga'];
        return labels[dayIndex];
    } else if (useGymSplit && !isMale) {
        // Female gym split: Legs, Push, Arms, Legs, Pull, Yoga, Yoga
        const labels = ['Legs', 'Push', 'Arms', 'Legs', 'Pull', 'Yoga', 'Yoga'];
        return labels[dayIndex];
    } else if (useYogaOnly) {
        return 'Yoga';
    } else if (useHome) {
        // Home: Lower, Push, Yoga, Pull, Lower, Yoga, Yoga
        const labels = ['Lower', 'Push', 'Yoga', 'Pull', 'Lower', 'Yoga', 'Yoga'];
        return labels[dayIndex];
    } else if (useBands) {
        // Bands: 5 strength days + 1 yoga + 1 yoga
        const labels = ['Bands', 'Bands', 'Yoga', 'Bands', 'Bands', 'Bands', 'Yoga'];
        return labels[dayIndex];
    } else {
        // Bodyweight: Lower, Upper, Yoga, Core, Lower, Yoga, Yoga
        const labels = ['Lower', 'Upper', 'Yoga', 'Core', 'Lower', 'Yoga', 'Yoga'];
        return labels[dayIndex];
    }
}

function renderMonthlyDayCell(date, today, cycleStart, cycleLen, msPerDay, isBaseline, isMale, isOtherMonth) {
    const isToday = date.toDateString() === today.toDateString();
    const dayNum = date.getDate();
    const dayOfWeek = date.getDay();
    const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday = 0

    let phaseColor = '#e2e8f0'; // Default gray
    let showPhaseIndicator = !isMale; // Don't show phase indicator for males

    if (!isMale) {
        if (!isBaseline && cycleStart) {
            const daysSinceStart = Math.floor((date - cycleStart) / msPerDay);
            let mod = daysSinceStart % cycleLen;
            if (mod < 0) mod += cycleLen;
            const currentDayLoop = mod + 1;

            const phaseKey = getCyclePhase(currentDayLoop, cycleLen);
            phaseColor = PHASE_INFO[phaseKey]?.color || '#e2e8f0';
        } else if (userCycleData.noPeriodMode) {
            phaseColor = PHASE_INFO.wellness.color;
        }
    }

    const dateStr = date.toISOString().split('T')[0];

    // Get workout label for this day based on user's schedule
    let workoutLabel = getMonthlyWorkoutLabel(dayIndex, isMale);

    // Check for active replacement for this day
    const replacement = getReplacementForDay ? getReplacementForDay(dayIndex) : null;
    let hasReplacement = false;

    if (replacement && replacement.replacement_workout) {
        // Check if the date is within the replacement period
        const startDate = new Date(replacement.start_date);
        const endDate = new Date(replacement.end_date);
        if (date >= startDate && date <= endDate) {
            // Show shortened version of replacement name
            const replacementName = replacement.replacement_workout.name || '';
            workoutLabel = replacementName.length > 8 ? replacementName.substring(0, 7) + '...' : replacementName;
            hasReplacement = true;
        }
    }

    // Phase indicator HTML - only for females
    const phaseIndicatorHtml = showPhaseIndicator
        ? `<div class="monthly-phase-indicator" style="background: ${isOtherMonth ? '#e2e8f0' : phaseColor}"></div>`
        : '';

    return `
        <div class="monthly-day-cell ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'is-today' : ''}${hasReplacement ? ' has-replacement' : ''}"
             onclick="openMonthlyDayDetail('${dateStr}')"
             style="${hasReplacement && !isOtherMonth ? 'border: 1px solid #f59e0b;' : ''}">
            <div class="monthly-day-num">${dayNum}</div>
            <div class="monthly-day-workout">${workoutLabel}</div>
            ${phaseIndicatorHtml}
        </div>
    `;
}

// Open detail for a specific day from monthly calendar
window.openMonthlyDayDetail = function(dateStr) {
    const date = new Date(dateStr);
    const today = new Date();

    // Calculate day index from Monday of that week
    const dayOfWeek = date.getDay();
    const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday = 0

    // For now, if it's the current week, use the action modal
    const todayDayOfWeek = today.getDay();
    const distToMon = (todayDayOfWeek + 6) % 7;
    const monday = new Date(today);
    monday.setDate(today.getDate() - distToMon);
    monday.setHours(0, 0, 0, 0);

    const targetMonday = new Date(date);
    targetMonday.setDate(date.getDate() - dayIndex);
    targetMonday.setHours(0, 0, 0, 0);

    if (monday.getTime() === targetMonday.getTime()) {
        // Same week - get workout name and open action modal
        const isMale = (typeof isMaleUser === 'function' && isMaleUser());
        let workoutLabel = getMonthlyWorkoutLabel(dayIndex, isMale);

        // Check for replacement
        const replacement = getReplacementForDay ? getReplacementForDay(dayIndex) : null;
        if (replacement && replacement.replacement_workout) {
            workoutLabel = replacement.replacement_workout.name || workoutLabel;
        }

        openCalendarActionModal(dayIndex, workoutLabel);
    } else {
        // Different week - show info toast
        const options = { weekday: 'long', month: 'long', day: 'numeric' };
        const dateDisplay = date.toLocaleDateString('en-US', options);
        showToast(`${dateDisplay} - Tap days in current week to see workout details`);
    }
};

window.openCalendarWorkout = async function(dayIndexFromMonday) {
    // Check for active replacement for this day
    const replacement = getReplacementForDay ? getReplacementForDay(dayIndexFromMonday) : null;

    if (replacement && replacement.replacement_workout) {
        const rWorkout = replacement.replacement_workout;

        // Handle different replacement types
        if (rWorkout.type === 'rest') {
            showToast('Today is a rest day. Enjoy your recovery!');
            return;
        }

        if (rWorkout.type === 'custom' && rWorkout.customWorkoutId) {
            // Load and start custom workout
            try {
                const user = window.currentUser;
                if (user && dbHelpers?.workouts?.getCustomWorkouts) {
                    const customWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
                    const customWorkout = customWorkouts.find(w => w.id === rWorkout.customWorkoutId);
                    if (customWorkout && typeof startCustomWorkout === 'function') {
                        startCustomWorkout(customWorkout);
                        return;
                    } else if (customWorkout) {
                        // Fallback - set as current workout and navigate
                        window.currentWorkout = {
                            name: customWorkout.template_name,
                            category: 'custom',
                            exercises: customWorkout.template_data?.exercises || []
                        };
                        if (typeof showWorkoutPlayer === 'function') {
                            showWorkoutPlayer();
                        }
                        return;
                    }
                }
            } catch (err) {
                console.error('Failed to load custom workout:', err);
            }
        }

        if (rWorkout.type === 'library' && rWorkout.category && rWorkout.subcategory) {
            // Start library workout - get first workout from subcategory
            if (typeof WORKOUT_LIBRARY !== 'undefined') {
                const category = WORKOUT_LIBRARY[rWorkout.category];
                if (category && category.subcategories && category.subcategories[rWorkout.subcategory]) {
                    const workouts = category.subcategories[rWorkout.subcategory].workouts;
                    if (workouts && workouts.length > 0 && typeof startLibraryWorkout === 'function') {
                        startLibraryWorkout(rWorkout.category, rWorkout.subcategory, workouts[0].id);
                        return;
                    }
                }
            }
        }
    }

    // 1. Check if user qualifies for Gym Split (Male or Female)
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());

    // Load userProfile from localStorage, fallback to sessionStorage if needed
    let userProfile = {};
    try { userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}'); } catch(e) {}

    // BUGFIX: If equipment_access is missing in localStorage, check sessionStorage (from quiz)
    if (!userProfile.equipment_access) {
        let sessionProfile = {};
        try { sessionProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        if (sessionProfile.equipment_access) {
            userProfile.equipment_access = sessionProfile.equipment_access;
            // Save to localStorage for future use
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
        }
    }

    // equipment_access is the source of truth; gym_access is legacy fallback only if equipment_access is undefined
    const hasGymAccess = userProfile.equipment_access === 'gym' || (userProfile.equipment_access === undefined && userProfile.gym_access === true);
    const hasHighEnergy = userProfile.energy_status === 'high';
    // Male and female gym splits now have IDENTICAL requirements: gym access only
    // Females can opt-in to cycle sync for automatic adjustments during menstrual phase
    const useMaleGymSplit = isMale && hasGymAccess;
    const useFemaleGymSplit = !isMale && hasGymAccess;

    // SIMPLIFIED: Direct equipment checks (same pattern as gym split)
    const hasDumbbells = userProfile.equipment_access === 'dumbbells' || userProfile.equipment_access === 'home';
    const hasBands = userProfile.equipment_access === 'bands';
    const hasYogaOnly = userProfile.equipment_access === 'yoga_only';
    const useYogaOnly = hasYogaOnly;
    const useHome = hasDumbbells && !hasGymAccess;
    const useBands = hasBands && !hasDumbbells && !hasGymAccess;

    // 2. Schedule Definition (Same as in renderWeeklyCalendar)
    let WEEKLY_SCHEDULE;

    if (useMaleGymSplit) {
        // Male Gym Split: Chest, Legs, Back, Shoulders, Arms+Core, Deep Fascia Release (Sat/Sun)
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'gym_split', dayIndex: 0, muscleGroup: 'chest' },
            { day: 'Tue', program: 'gym_split', dayIndex: 1, muscleGroup: 'legs' },
            { day: 'Wed', program: 'gym_split', dayIndex: 2, muscleGroup: 'back' },
            { day: 'Thu', program: 'gym_split', dayIndex: 3, muscleGroup: 'shoulders' },
            { day: 'Fri', program: 'gym_split', dayIndex: 4, muscleGroup: 'armscore' },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'yin' }, // Deep Fascia Release
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }  // Deep Fascia Release
        ];
    } else if (useFemaleGymSplit) {
        // Female Gym Split: Legs, Push, Arms+Core, Legs, Pull, Active Recovery, Rest
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'female_gym_split', dayIndex: 0, muscleGroup: 'legs' },
            { day: 'Tue', program: 'female_gym_split', dayIndex: 1, muscleGroup: 'push' },
            { day: 'Wed', program: 'female_gym_split', dayIndex: 2, muscleGroup: 'armscore' },
            { day: 'Thu', program: 'female_gym_split', dayIndex: 3, muscleGroup: 'legs' },
            { day: 'Fri', program: 'female_gym_split', dayIndex: 4, muscleGroup: 'pull' },
            { day: 'Sat', program: 'female_gym_split', dayIndex: 5 },
            { day: 'Sun', program: 'female_gym_split', dayIndex: 6 }
        ];
    } else if (useYogaOnly) {
        // Yoga Only - direct check like gym split
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'yoga', dayIndex: 0, subcategory: 'power' },
            { day: 'Tue', program: 'yoga', dayIndex: 1, subcategory: 'restorative' },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'yin' },
            { day: 'Thu', program: 'yoga', dayIndex: 3, subcategory: 'restorative' },
            { day: 'Fri', program: 'yoga', dayIndex: 4, subcategory: 'power' },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power' },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }
        ];
    } else if (useHome) {
        // Home/Dumbbell Split - direct check like gym split
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'home', dayIndex: 0, subcategory: 'lowerbody' },
            { day: 'Tue', program: 'home', dayIndex: 1, subcategory: 'push' },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'restorative' },
            { day: 'Thu', program: 'home', dayIndex: 3, subcategory: 'pull' },
            { day: 'Fri', program: 'home', dayIndex: 4, subcategory: 'lowerbody' },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power' },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }
        ];
    } else if (useBands) {
        // Resistance Bands Split - direct check like gym split
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'bands', dayIndex: 0 },
            { day: 'Tue', program: 'bands', dayIndex: 1 },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'restorative' },
            { day: 'Thu', program: 'bands', dayIndex: 3 },
            { day: 'Fri', program: 'bands', dayIndex: 4 },
            { day: 'Sat', program: 'bands', dayIndex: 5 },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }
        ];
    } else {
        // Bodyweight Split (fallback - no equipment)
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'bodyweight', dayIndex: 0, subcategory: 'lowerbody' },
            { day: 'Tue', program: 'bodyweight', dayIndex: 1, subcategory: 'upperbody' },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'restorative' },
            { day: 'Thu', program: 'bodyweight', dayIndex: 3, subcategory: 'core' },
            { day: 'Fri', program: 'bodyweight', dayIndex: 4, subcategory: 'lowerbody' },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power' },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin' }
        ];
    }

    if (dayIndexFromMonday < 0 || dayIndexFromMonday >= WEEKLY_SCHEDULE.length) return;

    // 2. Logic Setup
    const today = new Date();
    const dayOfWeek = today.getDay(); 
    const distToMon = (dayOfWeek + 6) % 7;
    const monday = new Date(today);
    monday.setDate(today.getDate() - distToMon);
    
    const targetDate = new Date(monday);
    targetDate.setDate(monday.getDate() + dayIndexFromMonday);
    
    const scheduleItem = WEEKLY_SCHEDULE[dayIndexFromMonday];
    
    // Default Workout Selection
    let programId = scheduleItem.program;
    let dayIndex = scheduleItem.dayIndex;
    
    // 3. Apply Modifiers (Cycle, Cortisol, etc.)
    const isBaseline = !userCycleData.lastPeriod;
    const isMaleWorkout = (typeof isMaleUser === 'function' && isMaleUser());

    // Check High Cortisol Profile (females only)
    const profileType = (sessionStorage.getItem('userResult') || '').toUpperCase();
    const isHighCortisol = !isMaleWorkout && (profileType.includes('CORTISOL') || profileType.includes('ADRENAL'));

    let phaseKey = 'wellness';

    // Skip cycle phase modifiers for males
    if (!isMaleWorkout && !isBaseline && !userCycleData.noPeriodMode) {
        const start = new Date(userCycleData.lastPeriod);
        const msPerDay = 24 * 60 * 60 * 1000;
        const daysSinceStart = Math.floor((targetDate - start) / msPerDay);
        let mod = daysSinceStart % userCycleData.cycleLength;
        if (mod < 0) mod += userCycleData.cycleLength;
        const currentCycleDay = mod + 1;

        if (typeof getCyclePhase === 'function') {
            phaseKey = getCyclePhase(currentCycleDay, userCycleData.cycleLength);
        }

        // Modifier: Menstrual -> Yoga (females only)
        if (phaseKey === 'menstrual' && programId === 'bodyweight') {
            programId = 'yoga';
            dayIndex = 3; // Restorative Recovery
        }
    }

    // Modifier: High Cortisol -> Yoga (overrides HIIT/Bodyweight, but not gym split)
    if (isHighCortisol && !useMaleGymSplit && !useFemaleGymSplit && programId === 'bodyweight') {
        programId = 'yoga';
        dayIndex = 0; // Somatic Hormone Reset
    }

    // Modifier: Mood/Symptoms (Only applies if targetDate is TODAY)
    if (targetDate.toDateString() === today.toDateString()) {
         // Swap to yoga if user reports being tired (applies to all users including males)
         if (userCycleData.mood === 'tired') {
             programId = 'yoga';
             dayIndex = 3; // Restorative Recovery
         }
         if (userCycleData.symptoms && userCycleData.symptoms.length > 0) {
             // Hot flash and dizziness are female-specific symptoms
             if (!isMaleWorkout && (userCycleData.symptoms.includes('hot_flash') || userCycleData.symptoms.includes('dizziness'))) {
                 programId = 'yoga';
                 dayIndex = 3; // Restorative
             } else if (userCycleData.symptoms.includes('fatigue') || userCycleData.symptoms.includes('anxiety')) {
                 // Fatigue/anxiety triggers yoga for everyone (males & females)
                 programId = 'yoga';
                 dayIndex = 6; // Yin & Meditation
             }
         }
    }

    // 4. Fetch Exercises & Launch Player
    // For gym_split with muscle groups, use WORKOUT_LIBRARY with rotation
    if ((programId === 'gym_split' || programId === 'female_gym_split') && scheduleItem.muscleGroup && typeof WORKOUT_LIBRARY !== 'undefined') {
        const muscleGroup = scheduleItem.muscleGroup;
        const gymCategory = WORKOUT_LIBRARY['gym'];

        if (gymCategory && gymCategory.subcategories && gymCategory.subcategories[muscleGroup]) {
            // Calculate which week in 48-week cycle (12 programs × 4 weeks)
            let startDate = localStorage.getItem('gym_split_start_date');
            if (!startDate) {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const distToMon = (dayOfWeek + 6) % 7;
                const monday = new Date(today);
                monday.setDate(today.getDate() - distToMon);
                monday.setHours(0, 0, 0, 0);
                startDate = monday.toISOString().split('T')[0];
                localStorage.setItem('gym_split_start_date', startDate);
            }
            const start = new Date(startDate);
            const now = new Date();
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeksElapsed = Math.floor((now - start) / msPerWeek);
            const currentWeek = (weeksElapsed % 48) + 1;

            const workouts = gymCategory.subcategories[muscleGroup].workouts;
            // Calculate which 4-week program (same workout for 4 weeks)
            const programNumber = Math.floor((currentWeek - 1) / 4);
            const workoutIndex = programNumber % workouts.length;
            const workout = workouts[workoutIndex];

            if (workout && typeof startLibraryWorkout === 'function') {
                startLibraryWorkout('gym', muscleGroup, workout.id);
            } else {
                console.error("Library workout not found or player function missing");
            }
        }
    }
    // For yoga/bodyweight/home with subcategories, use WORKOUT_LIBRARY with rotation
    else if (scheduleItem.subcategory && typeof WORKOUT_LIBRARY !== 'undefined') {
        const category = WORKOUT_LIBRARY[programId];

        if (category && category.subcategories && category.subcategories[scheduleItem.subcategory]) {
            // Calculate which week in rotation cycle
            let startDate = localStorage.getItem('program_start_date');
            if (!startDate) {
                const profile = await window.getUserProfile();
                startDate = profile?.program_start_date;
                if (!startDate) {
                    const today = new Date();
                    const dayOfWeek = today.getDay();
                    const distToMon = (dayOfWeek + 6) % 7;
                    const monday = new Date(today);
                    monday.setDate(today.getDate() - distToMon);
                    monday.setHours(0, 0, 0, 0);
                    startDate = monday.toISOString().split('T')[0];
                }
            }
            const start = new Date(startDate);
            const now = new Date();
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeksElapsed = Math.floor((now - start) / msPerWeek);
            const currentWeek = (weeksElapsed % 48) + 1;

            const workouts = category.subcategories[scheduleItem.subcategory].workouts;
            // Calculate which 4-week program (same workout for 4 weeks)
            const programNumber = Math.floor((currentWeek - 1) / 4);
            const workoutIndex = programNumber % workouts.length;
            const workout = workouts[workoutIndex];

            if (workout && typeof startLibraryWorkout === 'function') {
                startLibraryWorkout(programId, scheduleItem.subcategory, workout.id);
            } else {
                console.error("Library workout not found or player function missing");
            }
        }
    } else {
        // Default: use WORKOUT_DB
        const program = window.WORKOUT_DB?.[programId];
        if (program && program.schedule && program.schedule[dayIndex]) {
            if (typeof startActiveWorkout === 'function') {
                startActiveWorkout(programId, dayIndex);
            } else {
                console.error("Workout player function not found");
            }
        } else {
            console.log("Workout data not found for program:", programId);
        }
    }
};

// --- SHARED WORKOUT LOGIC ---
// Returns today's recommended workout based on Calendar logic (same as renderWeeklyCalendar)
function getTodaysWorkout() {
    // Check for today's workout override (e.g., low energy yoga recommendation or cycle sync)
    try {
        const override = JSON.parse(localStorage.getItem('todayWorkoutOverride') || 'null');
        if (override && override.date === new Date().toISOString().split('T')[0]) {
            // Return yoga workout for override
            if (override.program === 'yoga') {
                const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative Recovery
                const today = new Date();
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

                // Determine reason-based messaging
                let overrideReason;
                if (override.reason === 'cycle_sync_automatic') {
                    overrideReason = '✨ Cycle Sync: Automatic yoga during menstrual phase';
                } else if (override.reason === 'low_energy') {
                    overrideReason = '💤 Recovery: Yoga for low energy';
                } else {
                    overrideReason = '🧘‍♀️ Personalized yoga session';
                }

                return {
                    name: yogaWorkout?.title || 'Restorative Yoga',
                    icon: '🧘‍♀️',
                    program: 'yoga',
                    dayIndex: 3,
                    dayName: dayNames[today.getDay()],
                    isOverride: true,
                    overrideReason: overrideReason
                };
            }
        }
    } catch (e) { /* ignore parse errors */ }

    // Check if user qualifies for Gym Split (Male or Female)
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());

    // Load userProfile from localStorage, fallback to sessionStorage if needed
    let userProfile = {};
    try { userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}'); } catch(e) {}

    // BUGFIX: If equipment_access is missing in localStorage, check sessionStorage (from quiz)
    if (!userProfile.equipment_access) {
        let sessionProfile = {};
        try { sessionProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        if (sessionProfile.equipment_access) {
            userProfile.equipment_access = sessionProfile.equipment_access;
            // Save to localStorage for future use
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
        }
    }

    // NEW: Smart equipment override - most recent selection wins (check-in vs onboarding)
    const todayDateStr = new Date().toISOString().split('T')[0];
    const todayCheckIn = userCycleData.logs?.[todayDateStr];
    const checkInTimestamp = todayCheckIn?.timestamp;
    const onboardingTimestamp = localStorage.getItem('onboardingCompletedAt');

    if (todayCheckIn?.equipment) {
        // Both timestamps exist - compare them
        if (checkInTimestamp && onboardingTimestamp) {
            const checkInTime = new Date(checkInTimestamp).getTime();
            const onboardingTime = new Date(onboardingTimestamp).getTime();

            if (checkInTime > onboardingTime) {
                // Check-in is more recent - use check-in equipment
                userProfile.equipment_access = todayCheckIn.equipment;
            }
            // else: Onboarding is more recent - keep profile equipment
        } else {
            // No onboarding timestamp - use check-in equipment (backward compatibility)
            userProfile.equipment_access = todayCheckIn.equipment;
        }
    } else if (!todayCheckIn && userCycleData.logs) {
        // No check-in today - use last check-in data (don't reset to defaults)
        const dates = Object.keys(userCycleData.logs).sort().reverse();
        const lastCheckIn = dates.find(date => userCycleData.logs[date]?.equipment);
        if (lastCheckIn) {
            userProfile.equipment_access = userCycleData.logs[lastCheckIn].equipment;
        }
    }

    // equipment_access is the source of truth; gym_access is legacy fallback only if equipment_access is undefined
    const hasGymAccess = userProfile.equipment_access === 'gym' || (userProfile.equipment_access === undefined && userProfile.gym_access === true);
    const hasHighEnergy = userProfile.energy_status === 'high';
    // Male and female gym splits now have IDENTICAL requirements: gym access only
    // Females can opt-in to cycle sync for automatic adjustments during menstrual phase
    const useMaleGymSplit = isMale && hasGymAccess;
    const useFemaleGymSplit = !isMale && hasGymAccess;

    // Weekly Schedule Template - maps to WORKOUT_DB programs (same as calendar)
    let WEEKLY_SCHEDULE;

    if (useMaleGymSplit) {
        // Male Gym Split
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'gym_split', dayIndex: 0, icon: '💪', muscleGroup: 'chest' }, // Chest
            { day: 'Tue', program: 'gym_split', dayIndex: 1, icon: '🦵', muscleGroup: 'legs' }, // Legs
            { day: 'Wed', program: 'gym_split', dayIndex: 2, icon: '💪', muscleGroup: 'back' }, // Back
            { day: 'Thu', program: 'gym_split', dayIndex: 3, icon: '💪', muscleGroup: 'shoulders' }, // Shoulders
            { day: 'Fri', program: 'gym_split', dayIndex: 4, icon: '💪', muscleGroup: 'armscore' }, // Arms & Core
            { day: 'Sat', program: 'yoga', dayIndex: 5, icon: '🧘‍♂️', subcategory: 'yin' }, // Deep Fascia Release
            { day: 'Sun', program: 'yoga', dayIndex: 6, icon: '🧘‍♂️', subcategory: 'yin' }  // Deep Fascia Release
        ];
    } else if (useFemaleGymSplit) {
        // Female Gym Split (same as males: yoga on weekends for active recovery)
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'female_gym_split', dayIndex: 0, icon: '🦵', muscleGroup: 'legs' },
            { day: 'Tue', program: 'female_gym_split', dayIndex: 1, icon: '💪', muscleGroup: 'push' },
            { day: 'Wed', program: 'female_gym_split', dayIndex: 2, icon: '💪', muscleGroup: 'armscore' },
            { day: 'Thu', program: 'female_gym_split', dayIndex: 3, icon: '🦵', muscleGroup: 'legs' },
            { day: 'Fri', program: 'female_gym_split', dayIndex: 4, icon: '💪', muscleGroup: 'pull' },
            { day: 'Sat', program: 'yoga', dayIndex: 5, icon: '🧘‍♀️', subcategory: 'power' },
            { day: 'Sun', program: 'yoga', dayIndex: 6, icon: '💤', subcategory: 'yin' }
        ];
    } else {
        // SIMPLIFIED: Direct equipment checks (same pattern as gym split)
        const hasDumbbells = userProfile.equipment_access === 'dumbbells' || userProfile.equipment_access === 'home';
        const hasBands = userProfile.equipment_access === 'bands';
        const hasYogaOnly = userProfile.equipment_access === 'yoga_only';

        const useYogaOnly = hasYogaOnly;
        const useHome = hasDumbbells && !hasGymAccess;
        const useBands = hasBands && !hasDumbbells && !hasGymAccess;

        // DEBUG: Log homepage equipment check
        console.log('🏠 Homepage equipment check:', {
            equipment_access: userProfile?.equipment_access,
            hasYogaOnly,
            useYogaOnly,
            hasDumbbells,
            useHome,
            hasBands,
            useBands,
            hasGymAccess,
            useMaleGymSplit,
            useFemaleGymSplit
        });

        if (useYogaOnly) {
            // Yoga Only - direct check like gym
            WEEKLY_SCHEDULE = [
                { day: 'Mon', program: 'yoga', dayIndex: 0, icon: '🧘‍♀️', subcategory: 'power' },
                { day: 'Tue', program: 'yoga', dayIndex: 1, icon: '🧘‍♀️', subcategory: 'restorative' },
                { day: 'Wed', program: 'yoga', dayIndex: 2, icon: '🧘‍♀️', subcategory: 'yin' },
                { day: 'Thu', program: 'yoga', dayIndex: 3, icon: '🧘‍♀️', subcategory: 'restorative' },
                { day: 'Fri', program: 'yoga', dayIndex: 4, icon: '🧘‍♀️', subcategory: 'power' },
                { day: 'Sat', program: 'yoga', dayIndex: 5, icon: '🧘‍♀️', subcategory: 'power' },
                { day: 'Sun', program: 'yoga', dayIndex: 6, icon: '💤', subcategory: 'yin' }
            ];
        } else if (useHome) {
            // Home/Dumbbell Split - direct check like gym
            WEEKLY_SCHEDULE = [
                { day: 'Mon', program: 'home', dayIndex: 0, icon: '🦵', subcategory: 'lowerbody' },
                { day: 'Tue', program: 'home', dayIndex: 1, icon: '💪', subcategory: 'push' },
                { day: 'Wed', program: 'yoga', dayIndex: 2, icon: '🧘‍♀️', subcategory: 'restorative' },
                { day: 'Thu', program: 'home', dayIndex: 3, icon: '💪', subcategory: 'pull' },
                { day: 'Fri', program: 'home', dayIndex: 4, icon: '🦵', subcategory: 'lowerbody' },
                { day: 'Sat', program: 'yoga', dayIndex: 5, icon: '🧘‍♀️', subcategory: 'power' },
                { day: 'Sun', program: 'yoga', dayIndex: 6, icon: '💤', subcategory: 'yin' }
            ];
        } else if (useBands) {
            // Resistance Bands Split - direct check like gym
            WEEKLY_SCHEDULE = [
                { day: 'Mon', program: 'bands', dayIndex: 0, icon: '🦵' },
                { day: 'Tue', program: 'bands', dayIndex: 1, icon: '💪' },
                { day: 'Wed', program: 'yoga', dayIndex: 2, icon: '🧘‍♀️', subcategory: 'restorative' },
                { day: 'Thu', program: 'bands', dayIndex: 3, icon: '💪' },
                { day: 'Fri', program: 'bands', dayIndex: 4, icon: '🍑' },
                { day: 'Sat', program: 'bands', dayIndex: 5, icon: '💪' },
                { day: 'Sun', program: 'yoga', dayIndex: 6, icon: '💤', subcategory: 'yin' }
            ];
        } else {
            // Bodyweight Split (fallback - no equipment)
            WEEKLY_SCHEDULE = [
                { day: 'Mon', program: 'bodyweight', dayIndex: 0, icon: '🦵', subcategory: 'lowerbody' },
                { day: 'Tue', program: 'bodyweight', dayIndex: 1, icon: '💪', subcategory: 'upperbody' },
                { day: 'Wed', program: 'yoga', dayIndex: 2, icon: '🧘‍♀️', subcategory: 'restorative' },
                { day: 'Thu', program: 'bodyweight', dayIndex: 3, icon: '🔥', subcategory: 'core' },
                { day: 'Fri', program: 'bodyweight', dayIndex: 4, icon: '🦵', subcategory: 'lowerbody' },
                { day: 'Sat', program: 'yoga', dayIndex: 5, icon: '🧘‍♀️', subcategory: 'power' },
                { day: 'Sun', program: 'yoga', dayIndex: 6, icon: '💤', subcategory: 'yin' }
            ];
        }
    }

    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 is Sun, 6 is Sat
    // Convert to Mon=0 index
    const dayIndex = (dayOfWeek + 6) % 7;
    const scheduleItem = WEEKLY_SCHEDULE[dayIndex];

    let workoutName, workoutIcon;

    // For gym_split with muscle groups, pull from WORKOUT_LIBRARY with rotation
    if ((scheduleItem.program === 'gym_split' || scheduleItem.program === 'female_gym_split') && scheduleItem.muscleGroup && typeof WORKOUT_LIBRARY !== 'undefined') {
        const muscleGroup = scheduleItem.muscleGroup;
        const gymCategory = WORKOUT_LIBRARY['gym'];

        if (gymCategory && gymCategory.subcategories && gymCategory.subcategories[muscleGroup]) {
            // Calculate which week in 48-week cycle (12 programs × 4 weeks)
            let startDate = localStorage.getItem('gym_split_start_date');
            if (!startDate) {
                const dayOfWeek = today.getDay();
                const distToMon = (dayOfWeek + 6) % 7;
                const monday = new Date(today);
                monday.setDate(today.getDate() - distToMon);
                monday.setHours(0, 0, 0, 0);
                startDate = monday.toISOString().split('T')[0];
                localStorage.setItem('gym_split_start_date', startDate);
            }
            const start = new Date(startDate);
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeksElapsed = Math.floor((today - start) / msPerWeek);
            const currentWeek = (weeksElapsed % 48) + 1;

            const workouts = gymCategory.subcategories[muscleGroup].workouts;
            // Calculate which 4-week program (same workout for 4 weeks)
            const programNumber = Math.floor((currentWeek - 1) / 4);
            const workoutIndex = programNumber % workouts.length;
            const workout = workouts[workoutIndex];

            workoutName = workout ? workout.name : scheduleItem.day + ' Workout';
            workoutIcon = scheduleItem.icon;
        } else {
            workoutName = scheduleItem.day + ' Workout';
            workoutIcon = scheduleItem.icon;
        }
    } else if (scheduleItem.subcategory && typeof WORKOUT_LIBRARY !== 'undefined') {
        // For yoga/bodyweight/home with subcategories, use WORKOUT_LIBRARY with rotation
        const category = WORKOUT_LIBRARY[scheduleItem.program];

        if (category && category.subcategories && category.subcategories[scheduleItem.subcategory]) {
            // Calculate which week in rotation cycle
            let startDate = localStorage.getItem('program_start_date');
            if (!startDate) {
                const dayOfWeek = today.getDay();
                const distToMon = (dayOfWeek + 6) % 7;
                const monday = new Date(today);
                monday.setDate(today.getDate() - distToMon);
                monday.setHours(0, 0, 0, 0);
                startDate = monday.toISOString().split('T')[0];
            }
            const start = new Date(startDate);
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeksElapsed = Math.floor((today - start) / msPerWeek);
            const currentWeek = (weeksElapsed % 48) + 1;

            const workouts = category.subcategories[scheduleItem.subcategory].workouts;
            // Calculate which 4-week program (same workout for 4 weeks)
            const programNumber = Math.floor((currentWeek - 1) / 4);
            const workoutIndex = programNumber % workouts.length;
            const workout = workouts[workoutIndex];

            workoutName = workout ? workout.name : scheduleItem.day + ' Workout';
            workoutIcon = scheduleItem.icon;
        } else {
            // Fallback to WORKOUT_DB
            const program = window.WORKOUT_DB?.[scheduleItem.program];
            const workout = program?.schedule?.[scheduleItem.dayIndex];
            workoutName = workout?.title || scheduleItem.day + ' Workout';
            workoutIcon = scheduleItem.icon;
        }
    } else {
        // Default: get from WORKOUT_DB
        const program = window.WORKOUT_DB?.[scheduleItem.program];
        const workout = program?.schedule?.[scheduleItem.dayIndex];
        workoutName = workout?.title || scheduleItem.day + ' Workout';
        workoutIcon = scheduleItem.icon;
    }
    let programId = scheduleItem.program;
    let phaseInfo = null;
    let currentCycleDay = 0;
    let phaseKey = 'wellness';
    
    const isBaseline = !userCycleData.lastPeriod;
    const isMaleHero = (typeof isMaleUser === 'function' && isMaleUser());

    // Check High Cortisol Profile (females only)
    const profileType = (sessionStorage.getItem('userResult') || '').toUpperCase();
    const isHighCortisol = !isMaleHero && (profileType.includes('CORTISOL') || profileType.includes('ADRENAL'));

    // Calculate phase if we have period data (skip for males)
    if (!isMaleHero && !isBaseline && !userCycleData.noPeriodMode) {
        const start = new Date(userCycleData.lastPeriod);
        const msPerDay = 24 * 60 * 60 * 1000;
        const daysSinceStart = Math.floor((today - start) / msPerDay);
        let mod = daysSinceStart % userCycleData.cycleLength;
        if (mod < 0) mod += userCycleData.cycleLength;
        currentCycleDay = mod + 1;

        phaseKey = getCyclePhase(currentCycleDay, userCycleData.cycleLength);
        phaseInfo = PHASE_INFO[phaseKey];

        // REMOVED: Automatic cycle phase override - now respects user preferences set in onboarding
        // Users can opt in to cycle-based recommendations via onboarding questions
    }

    // For males, set performance mode
    if (isMaleHero) {
        phaseKey = 'performance';
        phaseInfo = PHASE_INFO['performance'];
    }

    // REMOVED: Hormone profile automatic overrides
    // Workout selection is now based ONLY on:
    // 1. Daily check-in data (equipment, energy, symptoms, recovery status)
    // 2. Onboarding preferences (equipment access, cycle sync settings)
    // Hormone profiles (cortisol/estrogen) no longer automatically override workouts

    // Apply daily check-in modifiers (read from TODAY's log, not stale global state)
    const todayStr = new Date().toISOString().split('T')[0];
    const todayLog = userCycleData.logs?.[todayStr];

    // Only apply if user hasn't already made a choice (declined yoga)
    if (todayLog && todayLog.workoutOverride !== 'declined') {
        // Check energy level from today's check-in
        if (todayLog.energy === 'low') {
            const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative Recovery
            if (yogaWorkout) {
                workoutName = yogaWorkout.title;
                workoutIcon = '💤';
            }
        }

        // High energy upgrade - for yoga-only users, upgrade to power yoga
        // Use WORKOUT_LIBRARY for consistency with Movement tab and Calendar
        const isYogaOnlyUser = userProfile.equipment_access === 'yoga_only';
        if (todayLog.energy === 'high' && isYogaOnlyUser) {
            const yogaCategory = typeof WORKOUT_LIBRARY !== 'undefined' ? WORKOUT_LIBRARY['yoga'] : null;
            const powerSubcategory = yogaCategory?.subcategories?.['power'];
            if (powerSubcategory && powerSubcategory.workouts && powerSubcategory.workouts.length > 0) {
                workoutName = powerSubcategory.workouts[0].name; // "Full Body Power Flow"
                workoutIcon = '🔥';
            }
        }

        // High energy upgrade - for yoga-only males with fresh recovery
        if (isMaleHero && todayLog.recovery === 'fresh' && isYogaOnlyUser) {
            const yogaCategory = typeof WORKOUT_LIBRARY !== 'undefined' ? WORKOUT_LIBRARY['yoga'] : null;
            const powerSubcategory = yogaCategory?.subcategories?.['power'];
            if (powerSubcategory && powerSubcategory.workouts && powerSubcategory.workouts.length > 0) {
                workoutName = powerSubcategory.workouts[0].name; // "Full Body Power Flow"
                workoutIcon = '🔥';
            }
        }

        // Check recovery status (males)
        if (isMaleHero && todayLog.recovery === 'tired') {
            const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative Recovery
            if (yogaWorkout) {
                workoutName = yogaWorkout.title;
                workoutIcon = '💤';
            }
        }

        // Check symptoms from today's log
        const todaySymptoms = todayLog.symptoms || [];
        if (todaySymptoms.length > 0) {
            // Hot flash and dizziness are female-specific symptoms
            if (!isMaleHero && (todaySymptoms.includes('hot_flash') || todaySymptoms.includes('dizziness'))) {
                const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[3]; // Restorative
                if (yogaWorkout) {
                    workoutName = yogaWorkout.title;
                    workoutIcon = '🧘‍♀️';
                }
            } else if (todaySymptoms.includes('fatigue') || todaySymptoms.includes('anxiety')) {
                // Fatigue/anxiety triggers yoga for everyone (males & females, gym & bodyweight)
                const yogaWorkout = window.WORKOUT_DB?.['yoga']?.schedule?.[6]; // Yin & Meditation
                if (yogaWorkout) {
                    workoutName = yogaWorkout.title;
                    workoutIcon = '🧘‍♀️';
                }
            }
        }
    }
    
    // DEBUG: Log final workout selection for homepage
    console.log('🏠 Homepage workout result:', {
        workoutName,
        programId,
        dayIndex,
        scheduleItem: WEEKLY_SCHEDULE[dayIndex]
    });

    return {
        name: workoutName,
        icon: workoutIcon,
        phaseKey: phaseKey,
        phaseInfo: phaseInfo,
        cycleDay: currentCycleDay,
        dayName: WEEKLY_SCHEDULE[dayIndex].day,
        programId: programId
    };
}

// ============================================================
// AVATAR COMPANION SYSTEM - DISABLED FOR NOW
// ============================================================
// To re-enable: uncomment the code below and the script tags at the top

/*
// Global avatar instance
window.dashboardAvatar = null;

// Use 3D avatar by default (set to false to use 2D SVG version)
window.use3DAvatar = true;

// Initialize the avatar on dashboard load
async function initializeAvatar() {
    try {
        const user = window.currentUser;
        if (!user) return;

        // Determine which avatar system to use
        const AvatarClass = window.use3DAvatar && typeof Avatar3D !== 'undefined' ? Avatar3D : Avatar;

        // Check if Avatar class is available
        if (typeof AvatarClass === 'undefined') {
            console.log('Avatar system not loaded yet');
            return;
        }

        // Create avatar instance (3D or 2D)
        window.dashboardAvatar = new AvatarClass('dashboard-avatar', {
            width: 180,
            height: 240,
            showRoom: true,
            interactive: true
        });

        // Load avatar data from database
        await window.dashboardAvatar.load(user.id);

        // Render the avatar (for 2D version, 3D auto-renders)
        if (window.dashboardAvatar.render) {
            window.dashboardAvatar.render();
        }

        // Update message based on avatar state
        updateAvatarMessage();

        // If avatar hasn't been customized, show a prompt
        if (!window.dashboardAvatar.state.isCustomized) {
            const widget = document.getElementById('avatar-widget');
            if (widget) {
                widget.classList.add('avatar-needs-setup');
            }
        }

        console.log(`Avatar initialized successfully (${window.use3DAvatar ? '3D' : '2D'} mode)`);
    } catch (err) {
        console.error('Error initializing avatar:', err);
    }
}

// Open the avatar customization modal
function openAvatarCustomizer() {
    const user = window.currentUser;
    if (!user) {
        alert('Please log in to customize your avatar');
        return;
    }

    // Determine which avatar system to use
    const AvatarClass = window.use3DAvatar && typeof Avatar3D !== 'undefined' ? Avatar3D : Avatar;

    if (!window.dashboardAvatar) {
        // Create avatar if it doesn't exist yet
        window.dashboardAvatar = new AvatarClass('dashboard-avatar', {
            width: 180,
            height: 240,
            showRoom: true
        });
    }

    // Create customizer (works with both 2D and 3D avatars - same state API)
    createAvatarCustomizer(window.dashboardAvatar, user.id, (newState) => {
        // After saving, re-render/update the dashboard avatar
        if (window.dashboardAvatar.render) {
            window.dashboardAvatar.render();
        }
        updateAvatarMessage();

        // Remove setup prompt if it exists
        const widget = document.getElementById('avatar-widget');
        if (widget) {
            widget.classList.remove('avatar-needs-setup');
        }
    });
}
*/

// Stub functions to prevent errors
function initializeAvatar() { return Promise.resolve(); }
function openAvatarCustomizer() { console.log('Avatar system disabled'); }
function updateAvatarMessage() { }


// --- DAILY WELLNESS CHECK-IN LOGIC ---
function checkDailyWellness(forceShow = false) {
    // Don't show if onboarding isn't complete
    const onboardingComplete = localStorage.getItem('onboardingComplete');
    if (onboardingComplete !== 'true' && !forceShow) {
        console.log("Skipping daily wellness - onboarding not complete");
        return;
    }

    // Don't show if the onboarding wizard is currently visible
    const wizardModal = document.getElementById('onboarding-wizard');
    if (wizardModal && wizardModal.style.display !== 'none') {
        console.log("Skipping daily wellness - onboarding wizard is open");
        return;
    }

    const lastCheck = localStorage.getItem('lastWellnessCheck');
    const today = new Date().toDateString();

    // Show if manually triggered (forceShow=true) OR if it hasn't been shown today
    if (forceShow || lastCheck !== today) {
        // Apply gender-specific UI before showing modal
        if (typeof applyGenderSpecificUI === 'function') {
            applyGenderSpecificUI();
        }
        // Open the detailed check-in modal
        const modal = document.getElementById('check-in-modal');
        if(modal) modal.style.display = 'flex';
    }
}

function showPersonalizationMessage() {
    // Create a temporary banner message
    const existing = document.getElementById('personalization-banner');
    if (existing) existing.remove();

    const banner = document.createElement('div');
    banner.id = 'personalization-banner';
    banner.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        z-index: 9999;
        font-weight: 600;
        font-size: 0.95rem;
        text-align: center;
        animation: slideDown 0.5s ease-out, fadeOut 0.5s ease-out 3.5s;
    `;
    banner.innerHTML = '✨ We\'ve personalized your workout and meals for today!';

    document.body.appendChild(banner);

    // Auto-remove after 4 seconds
    setTimeout(() => {
        banner.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => banner.remove(), 500);
    }, 3500);
}

// Trigger Onboarding OR Daily Check on Load
// TEMPORARILY DISABLED: These modals were causing the homepage to freeze
// Re-enable when modal functionality is fixed and ready for production
/*
document.addEventListener('DOMContentLoaded', () => {
    // Only proceed if we have a user context (simulation or real)
    const finishedOnboarding = localStorage.getItem('onboardingComplete');

    if (!finishedOnboarding) {
        // Show Wizard First
        setTimeout(initOnboardingWizard, 1000);
    } else {
        // Standard Daily Check
        setTimeout(checkDailyWellness, 1500);
    }
});
*/


function switchWeek(id, btn) {
    // Hide all internal meal sections (reset both class and inline styles)
    document.querySelectorAll('#meals-content-container .view-section').forEach(el => {
        el.classList.remove('active');
        el.style.display = '';  // Reset inline display style to let CSS take over
    });

    // Show target
    const target = document.getElementById(id);
    if(target) {
        target.classList.add('active');
        if (id === 'today') {
            renderTodayMeals();
        } else if (id === 'calorie-tracker') {
            // Recalculate and load nutrition data + enhanced features
            (async () => {
                await recalculateDailyNutrition();
                loadTodayNutrition();
                loadEnhancedNutritionFeatures();
            })();
        } else if (id === 'meal-plan-store') {
            // Load the AI meal plan view
            loadExistingAiMealPlan();
        } else {
            // For week views, add cycle sync indicators
            markCycleSyncMeals();
        }
    }

    // Update Pills
    if(btn) {
        document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    } else if (id === 'today') {
        // Find today pill if no btn passed
        const pills = document.querySelectorAll('.pill-btn');
        pills.forEach(p => {
            if (p.textContent.toLowerCase() === 'today') {
                pills.forEach(b => b.classList.remove('active'));
                p.classList.add('active');
            }
        });
    }
}

// ============================================================
// MEAL PLAN STORE LOGIC
// ============================================================

/**
 * Check if user has access to meal plans (quiz onboarding or purchase)
 * Returns: { hasAccess: boolean, source: 'quiz'|'purchase'|'subscription'|null, planSlug: string|null }
 */
function checkMealPlanAccess() {
    // Check for quiz onboarding (hormone profile assigned)
    const hormoneProfile = sessionStorage.getItem('userResult');
    const programStartDate = localStorage.getItem('pbb_start_date');
    const onboardingComplete = localStorage.getItem('onboardingComplete');

    // Check subscription status (would be set by Stripe webhook)
    const subscriptionStatus = localStorage.getItem('subscription_status');

    // Check for purchased meal plans (would be set after Stripe purchase)
    let purchasedPlans = [];
    try { purchasedPlans = JSON.parse(localStorage.getItem('purchased_meal_plans') || '[]'); } catch(e) {}

    // Quiz onboarders no longer auto-get hormone plan - they see calorie tracker + browse plans
    // Meal plan access is now only via subscription or purchase

    // Subscribers get all plans
    if (subscriptionStatus === 'active') {
        return { hasAccess: true, source: 'subscription', planSlug: null };
    }

    // Check individual purchases
    if (purchasedPlans.length > 0) {
        return { hasAccess: true, source: 'purchase', planSlug: purchasedPlans[0] };
    }

    // No access - show store
    return { hasAccess: false, source: null, planSlug: null };
}

/**
 * Initialize meal plan view based on user access
 * - No meal plan: Show Calorie Tracker + Your Meal Plan tab
 * - Has meal plan: Show Today + Calorie Tracker + Week 1-4 + Your Meal Plan (tailored)
 */
function initializeMealPlanView() {
    const access = checkMealPlanAccess();
    const navPills = document.getElementById('meals-nav-pills');
    const storeSection = document.getElementById('meal-plan-store');
    const todaySection = document.getElementById('today');

    // Get Today's Priority section on dashboard (only shown with meal plan)
    const todaysPrioritySection = document.getElementById('todays-priority-section');

    // Always add "Your Meal Plan" pill
    if (navPills && !document.getElementById('browse-plans-pill')) {
        const mealPlanPill = document.createElement('button');
        mealPlanPill.id = 'browse-plans-pill';
        mealPlanPill.className = 'pill-btn';
        mealPlanPill.innerHTML = '🍽️ Your Meal Plan';
        mealPlanPill.onclick = function() { switchWeek('meal-plan-store', this); };
        // Insert after Calorie Tracker pill
        const calorieTrackerPill = Array.from(navPills.querySelectorAll('.pill-btn')).find(p => p.textContent.toLowerCase().includes('calorie'));
        if (calorieTrackerPill && calorieTrackerPill.nextSibling) {
            navPills.insertBefore(mealPlanPill, calorieTrackerPill.nextSibling);
        } else {
            navPills.appendChild(mealPlanPill);
        }
    }

    if (!access.hasAccess) {
        // User needs a plan - hide Today's Priority section on dashboard
        if (todaysPrioritySection) {
            todaysPrioritySection.style.display = 'none';
        }

        // Show only Calorie Tracker and Your Meal Plan
        if (navPills) {
            const allPills = navPills.querySelectorAll('.pill-btn');
            allPills.forEach(pill => {
                const text = pill.textContent.toLowerCase();
                if (text.includes('calorie')) {
                    pill.style.display = '';
                    pill.classList.add('active');
                } else if (pill.id !== 'browse-plans-pill') {
                    pill.style.display = 'none';
                }
            });
        }

        // Default to calorie tracker
        document.querySelectorAll('#meals-content-container .view-section').forEach(el => {
            el.classList.remove('active');
            el.style.display = '';
        });
    } else {
        // User has meal plan access - show full navigation
        if (navPills) {
            const allPills = navPills.querySelectorAll('.pill-btn');
            allPills.forEach(pill => {
                const text = pill.textContent.toLowerCase();
                if (text.includes('week') || text === 'dining out' || text.includes('shopping') || text === 'today' || text.includes('calorie')) {
                    pill.style.display = '';
                }
            });
        }

        // Hide store section (it's now "Your Meal Plan" and shown via pill)
        if (storeSection) {
            storeSection.style.display = 'none';
            storeSection.classList.remove('active');
        }

        // Ensure today section can be shown
        if (todaySection) {
            todaySection.style.display = '';
        }

        // Show Today's Priority section on dashboard
        if (todaysPrioritySection) {
            todaysPrioritySection.style.display = '';
        }
    }

    // Always try to load existing AI meal plan
    loadExistingAiMealPlan();
}

/**
 * Render the meal plan store grid
 */
function renderMealPlanStore() {
    const grid = document.getElementById('meal-plan-grid');
    if (!grid) return;

    // Meal plan data (would come from meal_plan_library.js in production)
    const mealPlans = [
        {
            slug: 'summer-shred',
            name: 'Summer Shred',
            icon: '☀️',
            tagline: 'Lean out with delicious, high-protein meals',
            tags: ['Weight Loss', 'High Protein'],
            price: 9.99,
            featured: true,
            variants: ['Vegan', 'Vegetarian', 'Pescatarian', 'Omnivore']
        },
        {
            slug: 'clean-bulk',
            name: 'Clean Bulk Protocol',
            icon: '💪',
            tagline: 'Build muscle with clean, whole-food nutrition',
            tags: ['Muscle Gain', 'Strength'],
            price: 9.99,
            featured: true,
            variants: ['Vegan', 'Vegetarian', 'Pescatarian', 'Omnivore']
        },
        {
            slug: 'quick-easy',
            name: 'Quick & Easy Meals',
            icon: '⏱️',
            tagline: 'Healthy eating made simple - all meals under 20 mins',
            tags: ['Time-Saving', 'Beginner'],
            price: 9.99,
            featured: true,
            variants: ['Vegan', 'Vegetarian', 'Pescatarian', 'Omnivore']
        },
        {
            slug: 'energy-boost',
            name: 'Energy Boost',
            icon: '⚡',
            tagline: 'All-day energy through balanced, energizing meals',
            tags: ['Energy', 'Focus'],
            price: 9.99,
            featured: false,
            variants: ['Vegan', 'Vegetarian', 'Pescatarian', 'Omnivore']
        },
        {
            slug: 'gut-reset',
            name: 'Gut Reset Protocol',
            icon: '🌱',
            tagline: 'Heal your gut with nourishing, easy-to-digest meals',
            tags: ['Gut Health', 'Healing'],
            price: 9.99,
            featured: false,
            variants: ['Vegan', 'Vegetarian', 'Gluten-Free']
        }
    ];

    grid.innerHTML = mealPlans.map(plan => `
        <div class="meal-plan-card ${plan.featured ? 'featured' : ''}" onclick="openMealPlanPreview('${plan.slug}')">
            ${plan.featured ? '<div class="featured-badge">Popular</div>' : ''}
            <div class="meal-plan-thumbnail">
                <span class="plan-icon">${plan.icon}</span>
            </div>
            <div class="meal-plan-info">
                <h3>${plan.name}</h3>
                <p class="tagline">${plan.tagline}</p>
                <div class="meal-plan-tags">
                    ${plan.tags.map(tag => `<span class="meal-plan-tag">${tag}</span>`).join('')}
                </div>
                <div class="diet-variants">
                    ${plan.variants.slice(0, 3).map(v => `<span class="diet-variant-pill">${v}</span>`).join('')}
                    ${plan.variants.length > 3 ? `<span class="diet-variant-pill">+${plan.variants.length - 3}</span>` : ''}
                </div>
                <div class="meal-plan-footer">
                    <div class="meal-plan-price">$${plan.price.toFixed(2)} <span>AUD</span></div>
                    <button class="meal-plan-cta" onclick="event.stopPropagation(); startMealPlanPurchase('${plan.slug}')">Get Plan</button>
                </div>
            </div>
        </div>
    `).join('');
}

/**
 * Open meal plan preview modal
 */
function openMealPlanPreview(planSlug) {
    // TODO: Implement preview modal with sample meals
    console.log('Preview plan:', planSlug);
    alert(`Preview coming soon for ${planSlug}! Click "Get Plan" to purchase.`);
}

/**
 * Start the meal plan purchase flow
 */
function startMealPlanPurchase(planSlug) {
    console.log('Starting purchase flow for:', planSlug);
    // Open the preference wizard modal (defined in script block at bottom)
    if (typeof openPreferenceWizard === 'function') {
        openPreferenceWizard(planSlug);
    } else {
        console.error('Preference wizard not loaded');
        alert('Something went wrong. Please refresh and try again.');
    }
}

// ============================================================
// AI-GENERATED MEAL PLAN SYSTEM
// ============================================================

// In-memory cache of the current AI meal plan
let _aiMealPlanCache = null;
let _aiMealPlanCurrentWeek = 1;
let _aiMealPlanCurrentDay = 0;

/**
 * Load existing AI meal plan from Supabase
 */
async function loadExistingAiMealPlan() {
    const user = window.currentUser;
    if (!user) return;

    // Check cache first
    if (_aiMealPlanCache) {
        showAiPlanLoaded(_aiMealPlanCache);
        return;
    }

    try {
        // Fetch the latest active AI meal plan for this user
        const { data: plan, error } = await window.supabaseClient
            .from('ai_generated_meal_plans')
            .select('*')
            .eq('user_id', user.id)
            .eq('status', 'active')
            .order('created_at', { ascending: false })
            .limit(1)
            .maybeSingle();

        if (error) {
            console.warn('Error loading AI meal plan:', error);
            showAiPlanEmpty();
            return;
        }

        if (!plan) {
            // Also check localStorage for offline/demo plans
            const localPlan = localStorage.getItem('ai_meal_plan');
            if (localPlan) {
                try {
                    _aiMealPlanCache = JSON.parse(localPlan);
                    showAiPlanLoaded(_aiMealPlanCache);
                    return;
                } catch (e) {}
            }
            showAiPlanEmpty();
            return;
        }

        // Fetch meals and week themes
        const [mealsResult, weeksResult] = await Promise.allSettled([
            window.supabaseClient
                .from('ai_generated_meals')
                .select('*')
                .eq('plan_id', plan.id)
                .order('week_number', { ascending: true })
                .order('day_of_week', { ascending: true })
                .order('meal_slot', { ascending: true }),
            window.supabaseClient
                .from('ai_meal_plan_weeks')
                .select('*')
                .eq('plan_id', plan.id)
                .order('week_number', { ascending: true })
        ]);

        const meals = mealsResult.status === 'fulfilled' ? mealsResult.value.data || [] : [];
        const weekThemes = weeksResult.status === 'fulfilled' ? weeksResult.value.data || [] : [];

        // Reconstruct the plan structure
        const fullPlan = {
            id: plan.id,
            plan_name: plan.plan_name,
            plan_description: plan.plan_description,
            weeks: [1, 2, 3, 4].map(wn => {
                const weekTheme = weekThemes.find(w => w.week_number === wn) || {};
                const weekMeals = meals.filter(m => m.week_number === wn);
                return {
                    week_number: wn,
                    theme: weekTheme.theme || `Week ${wn}`,
                    theme_description: weekTheme.theme_description || '',
                    days: [0, 1, 2, 3, 4, 5, 6].map(d => {
                        const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                        const dayMeals = weekMeals.filter(m => m.day_of_week === d);
                        return {
                            day_of_week: d,
                            day_name: dayNames[d],
                            meals: dayMeals.map(m => ({
                                meal_slot: m.meal_slot,
                                meal_time: m.meal_time,
                                name: m.name,
                                description: m.description,
                                calories: m.calories,
                                protein_g: m.protein_g,
                                carbs_g: m.carbs_g,
                                fat_g: m.fat_g,
                                fiber_g: m.fiber_g,
                                ingredients: m.ingredients || [],
                                preparation: m.preparation,
                                prep_time_mins: m.prep_time_mins,
                                cook_time_mins: m.cook_time_mins,
                                tags: m.tags || [],
                                cuisine: m.cuisine,
                                image_url: m.image_url
                            }))
                        };
                    })
                };
            })
        };

        _aiMealPlanCache = fullPlan;
        showAiPlanLoaded(fullPlan);
    } catch (err) {
        console.error('Error loading AI meal plan:', err);
        showAiPlanEmpty();
    }
}

/**
 * Show the empty state (no plan yet)
 */
function showAiPlanEmpty() {
    const empty = document.getElementById('ai-plan-empty');
    const generating = document.getElementById('ai-plan-generating');
    const loaded = document.getElementById('ai-plan-loaded');
    if (empty) empty.style.display = 'block';
    if (generating) generating.style.display = 'none';
    if (loaded) loaded.style.display = 'none';
}

/**
 * Show the generating state
 */
function showAiPlanGenerating() {
    const empty = document.getElementById('ai-plan-empty');
    const generating = document.getElementById('ai-plan-generating');
    const loaded = document.getElementById('ai-plan-loaded');
    if (empty) empty.style.display = 'none';
    if (generating) generating.style.display = 'block';
    if (loaded) loaded.style.display = 'none';
}

/**
 * Show the loaded plan
 */
function showAiPlanLoaded(plan) {
    const empty = document.getElementById('ai-plan-empty');
    const generating = document.getElementById('ai-plan-generating');
    const loaded = document.getElementById('ai-plan-loaded');
    if (empty) empty.style.display = 'none';
    if (generating) generating.style.display = 'none';
    if (loaded) loaded.style.display = 'block';

    // Set plan header
    const nameEl = document.getElementById('ai-plan-name');
    const descEl = document.getElementById('ai-plan-desc');
    if (nameEl) nameEl.textContent = plan.plan_name || 'Your Tailored Meal Plan';
    if (descEl) descEl.textContent = plan.plan_description || 'Tailored to your goals';

    // Render week tabs dynamically
    renderAiPlanWeekTabs(plan);

    // Default to the first available week
    const firstWeek = plan.weeks?.[0]?.week_number || 1;
    _aiMealPlanCurrentWeek = firstWeek;

    // Render current week/day
    renderAiPlanWeek(_aiMealPlanCurrentWeek);
    renderAiPlanDay(_aiMealPlanCurrentDay);
}

/**
 * Render week tabs dynamically based on how many weeks exist in the plan.
 * Also shows a "+ Generate Next Week" button if fewer than 4 weeks exist.
 */
function renderAiPlanWeekTabs(plan) {
    const container = document.getElementById('ai-plan-week-tabs');
    if (!container) return;

    const weekCount = plan.weeks?.length || 0;
    let html = '';

    for (let i = 0; i < weekCount; i++) {
        const w = plan.weeks[i];
        const isActive = w.week_number === _aiMealPlanCurrentWeek;
        html += `<button class="pill-btn ${isActive ? 'active' : ''}" onclick="switchAiPlanWeek(${w.week_number}, this)">Week ${w.week_number}</button>`;
    }

    // Show "+ Next Week" button if under 4 weeks
    if (weekCount < 4) {
        html += `<button class="pill-btn" onclick="generateNextWeek()" style="background: linear-gradient(135deg, var(--primary), #10b981); color: white; border: none; font-size: 0.8rem;">+ Next Week</button>`;
    }

    container.innerHTML = html;
}

/**
 * Switch AI plan week tab
 */
function switchAiPlanWeek(weekNum, btn) {
    _aiMealPlanCurrentWeek = weekNum;
    _aiMealPlanCurrentDay = 0;

    // Update week pills
    if (btn) {
        document.querySelectorAll('#ai-plan-week-tabs .pill-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // Update day pills - reset to Monday
    document.querySelectorAll('#ai-plan-day-tabs .sub-btn').forEach((b, i) => {
        b.classList.toggle('active', i === 0);
    });

    renderAiPlanWeek(weekNum);
    renderAiPlanDay(0);
}

/**
 * Switch AI plan day tab
 */
function switchAiPlanDay(dayNum, btn) {
    _aiMealPlanCurrentDay = dayNum;

    if (btn) {
        document.querySelectorAll('#ai-plan-day-tabs .sub-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    renderAiPlanDay(dayNum);
}

/**
 * Render the week theme banner
 */
function renderAiPlanWeek(weekNum) {
    if (!_aiMealPlanCache || !_aiMealPlanCache.weeks) return;

    const week = _aiMealPlanCache.weeks.find(w => w.week_number === weekNum);
    if (!week) return;

    const labelEl = document.getElementById('ai-week-label');
    const titleEl = document.getElementById('ai-week-theme-title');
    const descEl = document.getElementById('ai-week-theme-desc');

    if (labelEl) labelEl.textContent = `Week ${weekNum}`;
    if (titleEl) titleEl.textContent = week.theme || `Week ${weekNum}`;
    if (descEl) descEl.textContent = week.theme_description || '';
}

/**
 * Render the meals for a specific day
 */
function renderAiPlanDay(dayNum) {
    if (!_aiMealPlanCache || !_aiMealPlanCache.weeks) return;

    const week = _aiMealPlanCache.weeks.find(w => w.week_number === _aiMealPlanCurrentWeek);
    if (!week || !week.days) return;

    const day = week.days.find(d => d.day_of_week === dayNum);
    if (!day || !day.meals) return;

    // Calculate daily totals
    let totalCal = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
    day.meals.forEach(m => {
        totalCal += m.calories || 0;
        totalProtein += parseFloat(m.protein_g) || 0;
        totalCarbs += parseFloat(m.carbs_g) || 0;
        totalFat += parseFloat(m.fat_g) || 0;
    });

    // Update nutrition summary pills
    const calEl = document.getElementById('ai-day-cal');
    const proteinEl = document.getElementById('ai-day-protein');
    const carbsEl = document.getElementById('ai-day-carbs');
    const fatEl = document.getElementById('ai-day-fat');
    if (calEl) calEl.textContent = `${Math.round(totalCal)} cal`;
    if (proteinEl) proteinEl.textContent = `${Math.round(totalProtein)}g protein`;
    if (carbsEl) carbsEl.textContent = `${Math.round(totalCarbs)}g carbs`;
    if (fatEl) fatEl.textContent = `${Math.round(totalFat)}g fat`;

    // Render meal cards
    const mealSlotOrder = ['breakfast', 'am_snack', 'lunch', 'pm_snack', 'dinner'];
    const mealSlotLabels = {
        breakfast: 'Breakfast',
        am_snack: 'AM Snack',
        lunch: 'Lunch',
        pm_snack: 'PM Snack',
        dinner: 'Dinner'
    };
    const mealSlotIcons = {
        breakfast: '🌅',
        am_snack: '🍎',
        lunch: '🥗',
        pm_snack: '🥜',
        dinner: '🍽️'
    };

    const sortedMeals = [...day.meals].sort((a, b) =>
        mealSlotOrder.indexOf(a.meal_slot) - mealSlotOrder.indexOf(b.meal_slot)
    );

    const container = document.getElementById('ai-plan-meals-list');
    if (!container) return;

    container.innerHTML = sortedMeals.map((meal, idx) => {
        const slotLabel = mealSlotLabels[meal.meal_slot] || meal.meal_slot;
        const slotIcon = mealSlotIcons[meal.meal_slot] || '🍽️';
        const time = meal.meal_time || '';
        const hasImage = meal.image_url && meal.image_url.length > 10;

        // Build ingredients list
        const ingredientsList = (meal.ingredients || []).map(ing => {
            if (typeof ing === 'string') return `<li>${ing}</li>`;
            return `<li>${ing.name}${ing.amount ? ' ' + ing.amount : ''}</li>`;
        }).join('');

        // Build tags
        const tagsHtml = (meal.tags || []).map(tag =>
            `<span style="display: inline-block; background: rgba(123,168,131,0.12); color: var(--primary); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500;">${tag}</span>`
        ).join(' ');

        return `
        <div class="card" style="margin-bottom: 10px;">
            <div class="card-header" onclick="toggleCard(this)">
                <div style="display: flex; align-items: center;">
                    <div class="meal-icon">${slotIcon}</div>
                    <div>
                        <div class="meta">${slotLabel}${time ? '  ' + time : ''}</div>
                        <div class="meal-title">${meal.name}</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="text-align: right;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-main);">${meal.calories || '?'} cal</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">P: ${Math.round(meal.protein_g || 0)}g</div>
                    </div>
                    <div class="expand-icon">+</div>
                </div>
            </div>
            <div class="card-body">
                ${hasImage ? `<img alt="${meal.name}" src="${meal.image_url}" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:15px;" onerror="this.style.display='none'"/>` : ''}
                ${meal.description ? `<p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px; font-style: italic;">${meal.description}</p>` : ''}
                ${tagsHtml ? `<div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 15px;">${tagsHtml}</div>` : ''}
                <div style="display: flex; gap: 12px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; text-align: center; min-width: 60px;">
                        <div style="font-weight: 700; color: var(--text-main);">${meal.calories || '?'}</div>
                        <div style="color: var(--text-muted); font-size: 0.7rem;">cal</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.08); padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; text-align: center; min-width: 60px;">
                        <div style="font-weight: 700; color: #3b82f6;">${Math.round(meal.protein_g || 0)}g</div>
                        <div style="color: var(--text-muted); font-size: 0.7rem;">protein</div>
                    </div>
                    <div style="background: rgba(245,158,11,0.08); padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; text-align: center; min-width: 60px;">
                        <div style="font-weight: 700; color: #f59e0b;">${Math.round(meal.carbs_g || 0)}g</div>
                        <div style="color: var(--text-muted); font-size: 0.7rem;">carbs</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.08); padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; text-align: center; min-width: 60px;">
                        <div style="font-weight: 700; color: #ef4444;">${Math.round(meal.fat_g || 0)}g</div>
                        <div style="color: var(--text-muted); font-size: 0.7rem;">fat</div>
                    </div>
                    ${meal.fiber_g ? `<div style="background: rgba(34,197,94,0.08); padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; text-align: center; min-width: 60px;">
                        <div style="font-weight: 700; color: #22c55e;">${Math.round(meal.fiber_g)}g</div>
                        <div style="color: var(--text-muted); font-size: 0.7rem;">fiber</div>
                    </div>` : ''}
                </div>
                ${ingredientsList ? `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"><h4 style="margin: 0; border: none; padding: 0;">Ingredients</h4></div><ul>${ingredientsList}</ul>` : ''}
                ${meal.preparation ? `<h4>Preparation</h4><p>${meal.preparation}</p>` : ''}
                ${meal.prep_time_mins || meal.cook_time_mins ? `<div style="display: flex; gap: 15px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f1f5f9; color: var(--text-muted); font-size: 0.8rem;">
                    ${meal.prep_time_mins ? `<span>Prep: ${meal.prep_time_mins} min</span>` : ''}
                    ${meal.cook_time_mins ? `<span>Cook: ${meal.cook_time_mins} min</span>` : ''}
                </div>` : ''}
            </div>
        </div>`;
    }).join('');
}

/**
 * Request AI meal plan generation (called from the CTA button)
 */
async function requestAiMealPlan() {
    showAiPlanGenerating();

    // Navigate to the meal plan store tab if not already there
    const storeSection = document.getElementById('meal-plan-store');
    if (storeSection && !storeSection.classList.contains('active')) {
        switchWeek('meal-plan-store', document.getElementById('browse-plans-pill'));
    }

    await generateAiMealPlan();
}

/**
 * Regenerate the meal plan
 */
async function regenerateAiMealPlan() {
    if (!confirm('Generate a new meal plan? This will replace your current one.')) return;

    _aiMealPlanCache = null;

    // Archive existing plan in Supabase
    const user = window.currentUser;
    if (user) {
        try {
            await window.supabaseClient
                .from('ai_generated_meal_plans')
                .update({ status: 'archived' })
                .eq('user_id', user.id)
                .eq('status', 'active');
        } catch (e) {
            console.warn('Could not archive old plan:', e);
        }
    }

    showAiPlanGenerating();
    await generateAiMealPlan();
}

/**
 * Core meal plan generation function
 * Calls the edge function, saves to Supabase, renders the result
 */
async function generateAiMealPlan() {
    const statusEl = document.getElementById('ai-plan-gen-status');
    const progressEl = document.getElementById('ai-plan-gen-progress');
    const user = window.currentUser;
    if (!user) {
        alert('Please log in to generate a meal plan.');
        showAiPlanEmpty();
        return;
    }

    try {
        // Update progress UI
        if (statusEl) statusEl.textContent = 'Gathering your profile data...';
        if (progressEl) progressEl.style.width = '5%';

        // Gather user data
        const db = window.dbHelpers;
        const [quizResult, factsResult, prefsResult] = await Promise.allSettled([
            db.quizResults.getLatest(user.id),
            db.userFacts.get(user.id),
            (async () => {
                try {
                    const { data } = await window.supabaseClient
                        .from('user_food_preferences')
                        .select('*')
                        .eq('user_id', user.id)
                        .maybeSingle();
                    if (data) return data;
                } catch (e) {}
                try {
                    return JSON.parse(localStorage.getItem('user_food_preferences') || '{}');
                } catch (e) { return {}; }
            })()
        ]);

        const quizResults = quizResult.status === 'fulfilled' ? (quizResult.value || {}) : {};
        const facts = factsResult.status === 'fulfilled' ? (factsResult.value || {}) : {};
        const foodPreferences = prefsResult.status === 'fulfilled' ? (prefsResult.value || {}) : {};

        const userPayload = {
            profile: { name: user.user_metadata?.name || user.email?.split('@')[0] || 'User' },
            quizResults,
            facts,
            foodPreferences
        };

        // Generate Week 1 (users can add more weeks later with "+ Next Week")
        if (statusEl) statusEl.textContent = 'Tailoring Day 1 — Monday...';
        if (progressEl) progressEl.style.width = '10%';

        // Animated day-by-day progress while waiting for the API
        const dayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const cookingVerbs = ['Tailoring', 'Cooking up', 'Preparing', 'Crafting', 'Plating', 'Seasoning', 'Finishing'];
        let _progressDay = 0;
        const _progressInterval = setInterval(() => {
            _progressDay++;
            if (_progressDay >= 7) {
                clearInterval(_progressInterval);
                if (statusEl) statusEl.textContent = 'Finalizing your meal plan...';
                if (progressEl) progressEl.style.width = '65%';
                return;
            }
            const pct = 10 + Math.round((_progressDay / 7) * 55);
            if (statusEl) statusEl.textContent = `Day ${_progressDay} complete ✓ ${cookingVerbs[_progressDay]} Day ${_progressDay + 1} — ${dayLabels[_progressDay]}...`;
            if (progressEl) progressEl.style.width = `${pct}%`;
        }, 3000);

        const response = await fetch('/.netlify/functions/generate-meal-plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userData: userPayload,
                weekNumber: 1,
                previousWeeks: []
            })
        });

        clearInterval(_progressInterval);

        if (!response.ok) {
            const errText = await response.text();
            console.error('Week 1 generation failed:', response.status, errText);
            throw new Error('Failed to generate meal plan');
        }

        if (statusEl) statusEl.textContent = 'All 7 days ready! Saving your plan...';
        if (progressEl) progressEl.style.width = '75%';

        const data = await response.json();
        if (!data.success || !data.week) {
            throw new Error(data.error || 'Invalid response from AI');
        }

        // Assemble the plan with just Week 1
        const mealPlan = {
            plan_name: `Your Tailored Meal Plan`,
            plan_description: 'Tailored weekly meal plan designed for your goals',
            weeks: [data.week]
        };

        if (statusEl) statusEl.textContent = 'Plating up — saving your meal plan...';
        if (progressEl) progressEl.style.width = '85%';

        // Save to Supabase
        let planId = null;
        try {
            // Archive any existing active plans
            await window.supabaseClient
                .from('ai_generated_meal_plans')
                .update({ status: 'archived' })
                .eq('user_id', user.id)
                .eq('status', 'active');

            const { data: planRow, error: planError } = await window.supabaseClient
                .from('ai_generated_meal_plans')
                .insert({
                    user_id: user.id,
                    plan_name: mealPlan.plan_name,
                    plan_description: mealPlan.plan_description,
                    status: 'active',
                    calorie_goal: quizResults.calorie_goal,
                    protein_goal_g: quizResults.protein_goal_g,
                    carbs_goal_g: quizResults.carbs_goal_g,
                    fat_goal_g: quizResults.fat_goal_g,
                    diet_type: foodPreferences.diet_type || 'vegan',
                    total_meals: 35,
                    current_week: 1
                })
                .select()
                .single();

            if (planError) {
                console.warn('Could not save plan to Supabase:', planError);
            } else if (planRow) {
                planId = planRow.id;
                mealPlan.id = planRow.id;

                // Insert week themes
                const weekThemes = mealPlan.weeks.map(w => ({
                    plan_id: planRow.id,
                    week_number: w.week_number,
                    theme: w.theme || `Week ${w.week_number}`,
                    theme_description: w.theme_description || ''
                }));
                if (weekThemes.length > 0) {
                    await window.supabaseClient
                        .from('ai_meal_plan_weeks')
                        .insert(weekThemes);
                }

                // Insert all meals and collect IDs for image generation
                const allMeals = [];
                mealPlan.weeks.forEach(week => {
                    (week.days || []).forEach(day => {
                        (day.meals || []).forEach(meal => {
                            allMeals.push({
                                plan_id: planRow.id,
                                week_number: week.week_number,
                                day_of_week: day.day_of_week,
                                day_name: day.day_name || ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'][day.day_of_week],
                                meal_slot: meal.meal_slot,
                                meal_time: meal.meal_time,
                                name: meal.name,
                                description: meal.description,
                                calories: meal.calories,
                                protein_g: meal.protein_g,
                                carbs_g: meal.carbs_g,
                                fat_g: meal.fat_g,
                                fiber_g: meal.fiber_g,
                                ingredients: meal.ingredients || [],
                                preparation: meal.preparation,
                                prep_time_mins: meal.prep_time_mins,
                                cook_time_mins: meal.cook_time_mins,
                                tags: meal.tags || [],
                                cuisine: meal.cuisine,
                                image_url: null
                            });
                        });
                    });
                });

                // Insert in batches of 50
                const insertedMealIds = [];
                for (let i = 0; i < allMeals.length; i += 50) {
                    const batch = allMeals.slice(i, i + 50);
                    const { data: inserted } = await window.supabaseClient
                        .from('ai_generated_meals')
                        .insert(batch)
                        .select('id, name, description, meal_slot, week_number, day_of_week');
                    if (inserted) insertedMealIds.push(...inserted);
                }

                // Store inserted meal IDs for background image generation
                mealPlan._insertedMeals = insertedMealIds;
            }
        } catch (saveErr) {
            console.warn('Could not save to Supabase, storing locally:', saveErr);
        }

        // Save to localStorage as backup
        localStorage.setItem('ai_meal_plan', JSON.stringify(mealPlan));

        if (progressEl) progressEl.style.width = '100%';
        if (statusEl) statusEl.textContent = 'Your tailored meal plan is ready! 🎉';

        // Cache and display immediately (images will load in background)
        _aiMealPlanCache = mealPlan;
        _aiMealPlanCurrentWeek = 1;
        _aiMealPlanCurrentDay = 0;

        setTimeout(() => {
            showAiPlanLoaded(mealPlan);
        }, 500);

        // Generate images in the background (non-blocking)
        // One image per day's main meal = 28 images, generated slowly to not overwhelm
        if (planId && mealPlan._insertedMeals) {
            generateMealImagesInBackground(planId, mealPlan._insertedMeals, user.id);
        }

    } catch (err) {
        console.error('Meal plan generation error:', err);
        if (statusEl) statusEl.textContent = 'Something went wrong. Please try again.';
        if (progressEl) progressEl.style.width = '0%';

        setTimeout(() => {
            showAiPlanEmpty();
        }, 2000);
    }
}

/**
 * Generate meal images in the background after plan is created.
 * Generates one image at a time for the dinner/lunch of each day (28 images).
 * Each image is uploaded to B2 and the URL is saved to Supabase.
 */
async function generateMealImagesInBackground(planId, insertedMeals, userId) {
    // Pick one main meal per day (dinner or lunch) = 28 images
    const mealsToImage = [];
    const seen = new Set();
    for (const meal of insertedMeals) {
        const dayKey = `${meal.week_number}_${meal.day_of_week}`;
        if (seen.has(dayKey)) continue;
        if (meal.meal_slot === 'dinner' || meal.meal_slot === 'lunch') {
            mealsToImage.push(meal);
            seen.add(dayKey);
        }
    }
    // Fill gaps - if a day didn't have dinner/lunch, grab any meal
    for (const meal of insertedMeals) {
        const dayKey = `${meal.week_number}_${meal.day_of_week}`;
        if (!seen.has(dayKey)) {
            mealsToImage.push(meal);
            seen.add(dayKey);
        }
    }

    console.log(`Starting background image generation for ${mealsToImage.length} meals...`);

    for (let i = 0; i < mealsToImage.length; i++) {
        const meal = mealsToImage[i];

        // Skip if this meal already has an image URL (from a previous run or B2 storage)
        if (meal.image_url && meal.image_url.length > 10 && !meal.image_url.startsWith('data:')) {
            console.log(`Skipping image for "${meal.name}" - already has permanent URL`);
            continue;
        }

        try {
            const response = await fetch('/.netlify/functions/generate-meal-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mealName: meal.name,
                    mealDescription: meal.description || '',
                    userId: userId,
                    planId: planId,
                    mealId: meal.id
                })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.imageUrl) {
                    // Update the meal in Supabase with the permanent image URL
                    await window.supabaseClient
                        .from('ai_generated_meals')
                        .update({ image_url: data.imageUrl })
                        .eq('id', meal.id);

                    // Update the in-memory cache too
                    if (_aiMealPlanCache && _aiMealPlanCache.weeks) {
                        const week = _aiMealPlanCache.weeks.find(w => w.week_number === meal.week_number);
                        if (week) {
                            const day = week.days?.find(d => d.day_of_week === meal.day_of_week);
                            if (day) {
                                const cachedMeal = day.meals?.find(m => m.name === meal.name);
                                if (cachedMeal) {
                                    cachedMeal.image_url = data.imageUrl;
                                }
                            }
                        }
                    }

                    // Update localStorage backup
                    try {
                        localStorage.setItem('ai_meal_plan', JSON.stringify(_aiMealPlanCache));
                    } catch (e) { /* storage quota */ }

                    console.log(`Image ${i + 1}/${mealsToImage.length} generated for "${meal.name}"`);
                }
            }
        } catch (err) {
            console.warn(`Image generation failed for "${meal.name}":`, err);
        }

        // Small delay between requests to avoid rate limiting
        if (i < mealsToImage.length - 1) {
            await new Promise(r => setTimeout(r, 1500));
        }
    }

    console.log('Background image generation complete!');
}

/**
 * Generate the next week of the meal plan.
 * Appends a new week to the existing plan.
 */
async function generateNextWeek() {
    const user = window.currentUser;
    if (!user || !_aiMealPlanCache) return;

    const currentWeeks = _aiMealPlanCache.weeks || [];
    const nextWeekNum = currentWeeks.length + 1;
    if (nextWeekNum > 4) {
        alert('You already have 4 weeks generated!');
        return;
    }

    showAiPlanGenerating();
    const statusEl = document.getElementById('ai-plan-gen-status');
    const progressEl = document.getElementById('ai-plan-gen-progress');

    try {
        if (statusEl) statusEl.textContent = `Week ${nextWeekNum} — Tailoring Day 1 — Monday...`;
        if (progressEl) progressEl.style.width = '10%';

        // Gather user data
        const db = window.dbHelpers;
        const [quizResult, factsResult, prefsResult] = await Promise.allSettled([
            db.quizResults.getLatest(user.id),
            db.userFacts.get(user.id),
            (async () => {
                try {
                    const { data } = await window.supabaseClient
                        .from('user_food_preferences').select('*').eq('user_id', user.id).maybeSingle();
                    if (data) return data;
                } catch (e) {}
                try { return JSON.parse(localStorage.getItem('user_food_preferences') || '{}'); } catch (e) { return {}; }
            })()
        ]);

        // Build previous weeks context
        const previousWeeks = currentWeeks.map(w => {
            const mealNames = [];
            (w.days || []).forEach(d => (d.meals || []).forEach(m => mealNames.push(m.name)));
            return { weekNumber: w.week_number, theme: w.theme, mealNames };
        });

        // Animated day-by-day progress for next week generation
        const nwDayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const nwVerbs = ['Tailoring', 'Cooking up', 'Preparing', 'Crafting', 'Plating', 'Seasoning', 'Finishing'];
        let _nwDay = 0;
        const _nwInterval = setInterval(() => {
            _nwDay++;
            if (_nwDay >= 7) {
                clearInterval(_nwInterval);
                if (statusEl) statusEl.textContent = `Finalizing Week ${nextWeekNum}...`;
                if (progressEl) progressEl.style.width = '65%';
                return;
            }
            const pct = 10 + Math.round((_nwDay / 7) * 55);
            if (statusEl) statusEl.textContent = `Week ${nextWeekNum} — Day ${_nwDay} complete ✓ ${nwVerbs[_nwDay]} Day ${_nwDay + 1} — ${nwDayLabels[_nwDay]}...`;
            if (progressEl) progressEl.style.width = `${pct}%`;
        }, 3000);

        const response = await fetch('/.netlify/functions/generate-meal-plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userData: {
                    profile: { name: user.user_metadata?.name || user.email?.split('@')[0] || 'User' },
                    quizResults: quizResult.status === 'fulfilled' ? (quizResult.value || {}) : {},
                    facts: factsResult.status === 'fulfilled' ? (factsResult.value || {}) : {},
                    foodPreferences: prefsResult.status === 'fulfilled' ? (prefsResult.value || {}) : {}
                },
                weekNumber: nextWeekNum,
                previousWeeks
            })
        });

        clearInterval(_nwInterval);

        if (!response.ok) throw new Error('Failed to generate week ' + nextWeekNum);

        if (statusEl) statusEl.textContent = `Week ${nextWeekNum} — All 7 days ready!`;
        if (progressEl) progressEl.style.width = '75%';

        const data = await response.json();
        if (!data.success || !data.week) throw new Error(data.error || 'Invalid response');

        // Add the new week to the cache
        _aiMealPlanCache.weeks.push(data.week);

        // Save to Supabase
        const planId = _aiMealPlanCache.id;
        if (planId) {
            try {
                // Insert week theme
                await window.supabaseClient.from('ai_meal_plan_weeks').insert({
                    plan_id: planId,
                    week_number: data.week.week_number,
                    theme: data.week.theme || `Week ${nextWeekNum}`,
                    theme_description: data.week.theme_description || ''
                });

                // Insert meals
                const newMeals = [];
                (data.week.days || []).forEach(day => {
                    (day.meals || []).forEach(meal => {
                        newMeals.push({
                            plan_id: planId,
                            week_number: data.week.week_number,
                            day_of_week: day.day_of_week,
                            day_name: day.day_name || ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'][day.day_of_week],
                            meal_slot: meal.meal_slot, meal_time: meal.meal_time,
                            name: meal.name, description: meal.description,
                            calories: meal.calories, protein_g: meal.protein_g,
                            carbs_g: meal.carbs_g, fat_g: meal.fat_g, fiber_g: meal.fiber_g,
                            ingredients: meal.ingredients || [], preparation: meal.preparation,
                            prep_time_mins: meal.prep_time_mins, cook_time_mins: meal.cook_time_mins,
                            tags: meal.tags || [], cuisine: meal.cuisine, image_url: null
                        });
                    });
                });

                const { data: inserted } = await window.supabaseClient
                    .from('ai_generated_meals').insert(newMeals)
                    .select('id, name, description, meal_slot, week_number, day_of_week');

                // Background image generation for the new week
                if (inserted) {
                    generateMealImagesInBackground(planId, inserted, user.id);
                }
            } catch (e) {
                console.warn('Could not save new week to Supabase:', e);
            }
        }

        // Update localStorage
        localStorage.setItem('ai_meal_plan', JSON.stringify(_aiMealPlanCache));

        if (progressEl) progressEl.style.width = '100%';
        if (statusEl) statusEl.textContent = `Week ${nextWeekNum} is ready!`;

        // Switch to the new week
        _aiMealPlanCurrentWeek = nextWeekNum;
        _aiMealPlanCurrentDay = 0;
        setTimeout(() => showAiPlanLoaded(_aiMealPlanCache), 500);

    } catch (err) {
        console.error('Next week generation error:', err);
        if (statusEl) statusEl.textContent = 'Something went wrong. Please try again.';
        setTimeout(() => showAiPlanLoaded(_aiMealPlanCache), 2000);
    }
}

// Initialize meal plan view when meals tab is opened
// This is called from switchAppTab when 'meals' is selected

// Add stars to cycle sync meals in static week views
function markCycleSyncMeals() {
    if (!window.cycleSyncMealTitle) return;

    // Find all meal titles in the currently active week view
    const activeSection = document.querySelector('#meals-content-container .view-section.active');
    if (!activeSection) return;

    // Skip Today view (it handles stars in renderTodayMeals)
    if (activeSection.id === 'today' || activeSection.id === 'calorie-tracker') return;

    const mealTitles = activeSection.querySelectorAll('.meal-title');
    mealTitles.forEach(titleEl => {
        const originalText = titleEl.textContent.replace('⭐ ', '').trim();
        if (originalText === window.cycleSyncMealTitle && !titleEl.textContent.startsWith('⭐')) {
            titleEl.textContent = '⭐ ' + originalText;
        }
    });
}

async function renderTodayMeals() {
    const container = document.getElementById('today-meals-content');
    if (!container) return;

    // 1. Calculate Day
    let startDate = localStorage.getItem('pbb_start_date');
    if (!startDate) {
        // Initialize program date if not set
        await initProgramDate();
        startDate = localStorage.getItem('pbb_start_date');
        if (!startDate) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">
                <p>Unable to determine your program start date. Please try refreshing the page.</p>
            </div>`;
            return;
        }
    }

    const start = new Date(startDate);
    const now = new Date();
    const diffTime = Math.abs(now - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    let currentDayNum = diffDays || 1;
    if (currentDayNum > 28) currentDayNum = 28; // Cap at 28

    const weekNum = Math.ceil(currentDayNum / 7);
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const dayIndex = (currentDayNum - 1) % 7; // Calculate which day in the program cycle (0-6)
    const dayName = days[dayIndex];
    
    const targetDayId = `week${weekNum}-${dayName}`;
    const sourceSection = document.getElementById(targetDayId);

    if (!sourceSection) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">
            <p>Your meal plan for ${dayName} (Week ${weekNum}) couldn't be found. Please check the full plan.</p>
        </div>`;
        return;
    }

    // 2. Clone and Clean Cards
    container.innerHTML = ''; // Clear loading state
    
    // Add Header
    const header = document.createElement('div');
    header.className = 'today-menu-header';
    header.innerHTML = `<h2>Today's Menu</h2>
                       <p>DAY ${currentDayNum}</p>`;
    container.appendChild(header);

    // 1.5 Personalized Meal Recommendation Banner REMOVED per user request
    // The green bar was appearing empty or unwanted.

    const cards = sourceSection.querySelectorAll('.card');

    cards.forEach(card => {
        if (card.classList.contains('reflection-card')) return;

        const clone = card.cloneNode(true);

        // Check if this meal matches the Cycle Sync meal
        if (window.cycleSyncMealTitle) {
            const mealTitleElement = clone.querySelector('.meal-title');
            if (mealTitleElement && mealTitleElement.textContent.trim() === window.cycleSyncMealTitle) {
                mealTitleElement.textContent = '⭐ ' + mealTitleElement.textContent;
            }
        }

        // Ensure images open the modal
        clone.querySelectorAll('img').forEach(img => {
            img.onclick = function() {
                // Check if openImageModal or similar exists
                if (typeof openImageModal === 'function') {
                    openImageModal(this.src);
                } else {
                    // Fallback to simple alert or nothing if not found
                    console.log("Image modal function not found");
                }
            };
        });
        container.appendChild(clone);
    });

    // 3. Add Reflection at the bottom
    const reflection = sourceSection.querySelector('.reflection-card');
    if (reflection) {
        const rfClone = reflection.cloneNode(true);
        const textarea = rfClone.querySelector('textarea');
        if (textarea) {
            const originalId = textarea.id; // e.g., ref-week1-Monday
            
            // Ensure the clone's save button works correctly
            const btn = rfClone.querySelector('button');
            const idParts = originalId.split('-');
            if (idParts.length >= 3) {
                const weekDayId = idParts[1] + '-' + idParts[2];
                if (btn) {
                    btn.onclick = function() {
                        saveDayReflection(weekDayId);
                    };
                }
            }
            
            // Mirror textarea value
            textarea.id = 'today-' + originalId;
            textarea.oninput = function() {
                const originalTextarea = document.getElementById(originalId);
                if (originalTextarea) originalTextarea.value = this.value;
            };
        }

        container.appendChild(rfClone);
    }
}

function switchDay(weekId, dayId) {
    const context = document.getElementById(weekId);
    if(!context) return;
    
    context.querySelectorAll('.day-view').forEach(el => el.classList.remove('active'));
    context.querySelectorAll('.sub-nav .sub-btn').forEach(el => el.classList.remove('active'));
    
    // Activating
    const targetId = weekId + '-' + dayId;
    const targetEl = document.getElementById(targetId);
    if(targetEl) targetEl.classList.add('active');
    
    // Highlight sub btn
    const btns = context.querySelectorAll('.sub-nav .sub-btn');
    for(let b of btns) {
        const btnText = b.innerText.toLowerCase();
        const dId = dayId.toLowerCase();
        
        if (btnText === dId || 
           (dId === 'overview' && btnText === 'overview') || 
           (dId !== 'overview' && btnText.startsWith(dId.substring(0,3)))) {
            b.classList.add('active');
        }
    }
    
    // Re-apply badges if available
    if (window.applyMealBadges) window.applyMealBadges();
}

// Backward compatibility if internal links use switchView
function switchView(id) {
    switchWeek(id);
}

// --- ONBOARDING WIZARD LOGIC ---
let currentWizardStep = 1;
const totalWizardSteps = 21;

// Wizard-specific validation message (renders above the z-index:12000 wizard overlay)
function wizardAlert(message) {
    const existing = document.getElementById('wizard-validation-toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.id = 'wizard-validation-toast';
    toast.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:12px 24px; background:#ef4444; color:white; border-radius:12px; font-weight:600; font-size:0.9rem; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:13000; text-align:center; max-width:90vw; animation:fadeInUp 0.3s ease-out;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            setTimeout(() => toast.remove(), 300);
        }
    }, 3000);
}

// Workout Calendar State
let wizardTrainingFrequency = 0;
let wizardSelectedDays = new Set();
let wizardSplitPreference = '';
let wizardWorkoutCalendar = {};
let selectedGender = localStorage.getItem('userGender') || null; // Track gender selection

async function checkAndTriggerOnboarding() {
    // Check if user has completed onboarding before (localStorage)
    const onboardingComplete = localStorage.getItem('onboardingComplete');

    // SELF-HEALING: Even if localStorage says complete, verify cycle data exists for females
    if (onboardingComplete === 'true') {
        const userGender = localStorage.getItem('userGender');
        if (userGender === 'female') {
            // Check if cycle data exists in localStorage
            try {
                const cycleData = JSON.parse(localStorage.getItem('userCycleData') || '{}');
                if (!cycleData.lastPeriod && !cycleData.noPeriodMode) {
                    console.warn('⚠️ Onboarding marked complete but no cycle data in localStorage - allowing re-onboarding');
                    // Don't return - continue to check database and possibly show wizard
                } else {
                    // Data exists in localStorage (either has period date or is in no-period/wellness mode) - skip wizard
                    return;
                }
            } catch (e) {
                console.warn('Error checking localStorage cycle data:', e);
                // If we can't check, allow wizard to show
            }
        } else {
            // Male user or gender not set - respect onboarding flag
            return;
        }
    }

    // If user is logged in, check the database for onboarding_complete flag
    // This ensures onboarding is skipped even if localStorage was cleared or user is on a new device
    if (window.currentUser) {
        try {
            const userData = await dbHelpers.users.get(window.currentUser.id);
            if (userData && userData.onboarding_complete) {
                // SELF-HEALING: Check if cycle data actually exists for female users
                // If onboarding is marked complete but data is missing, allow re-onboarding
                const userGender = localStorage.getItem('userGender') || userData.sex;
                if (userGender === 'female') {
                    try {
                        const facts = await dbHelpers.userFacts.get(window.currentUser.id);
                        const hasCycleData = facts?.additional_data?.last_period_start || facts?.additional_data?.no_period_mode;

                        if (!hasCycleData) {
                            console.warn('⚠️ Onboarding marked complete but cycle data missing - allowing re-onboarding');
                            // Don't return - allow wizard to show
                        } else {
                            // Data exists - skip wizard
                            localStorage.setItem('onboardingComplete', 'true');
                            console.log("Onboarding already completed (from database), skipping wizard");
                            return;
                        }
                    } catch (e) {
                        console.warn("Error checking cycle data:", e);
                        // If we can't check, allow wizard to show to be safe
                    }
                } else {
                    // Male user - just check onboarding flag
                    localStorage.setItem('onboardingComplete', 'true');
                    console.log("Onboarding already completed (from database), skipping wizard");
                    return;
                }
            }
        } catch(e) {
            console.warn("Error checking onboarding status from database:", e);
        }
    }

    // Check if essential quiz data exists in sessionStorage
    const quizJson = sessionStorage.getItem('userProfile');
    let hasEssentialData = false;

    if (quizJson) {
        try {
            const quizData = JSON.parse(quizJson);
            // Check for essential fields
            hasEssentialData = quizData.age && quizData.weight && quizData.height &&
                             quizData.sex && quizData.equipment_access &&
                             quizData.activity_level && quizData.energy_level;
        } catch(e) {
            console.warn("Error parsing quiz data:", e);
        }
    }

    // If no essential data, check the database
    if (!hasEssentialData && window.currentUser) {
        try {
            const quizResults = await dbHelpers.quizResults.getLatest(window.currentUser.id);
            if (quizResults && quizResults.age && quizResults.weight && quizResults.height) {
                hasEssentialData = true;
            }
        } catch(e) {
            console.warn("Error fetching quiz results:", e);
        }
    }

    // Check if gender is selected (required for proper UI)
    const hasGender = localStorage.getItem('userGender');

    // If missing essential data OR missing gender selection, trigger onboarding wizard
    if (!hasEssentialData || !hasGender) {
        console.log("Essential quiz data or gender missing, triggering onboarding wizard...");
        window._onboardingWizardPending = true;
        setTimeout(initOnboardingWizard, 500);
    } else {
        // User has essential data AND gender but hasn't marked onboarding complete
        // Mark as complete and show the gender-specific check-in
        console.log("User has essential data and gender, marking onboarding complete...");
        localStorage.setItem('onboardingComplete', 'true');

        // Apply gender-specific UI and show check-in
        if (typeof applyGenderSpecificUI === 'function') {
            applyGenderSpecificUI();
        }

    }
}

function initOnboardingWizard() {
    // Guard against multiple simultaneous triggers
    const modal = document.getElementById('onboarding-wizard');
    if (!modal) return;
    if (modal.style.display === 'flex') return; // Already showing

    currentWizardStep = 1; // Reset to first step
    modal.classList.add('active');
    modal.style.display = 'flex';
    modal.style.opacity = '1';
    updateWizardUI();
}

function updateWizardUI() {
    // 1. Slides — use class-based transitions for smooth animation
    for(let i=1; i<=totalWizardSteps; i++) {
        const slide = document.getElementById('slide-' + i);
        if (!slide) continue;
        if (i === currentWizardStep) {
            // Show the target slide with entrance animation
            slide.classList.remove('slide-exit');
            slide.style.display = 'block';
            // Force a reflow so the transition from opacity:0 → 1 actually animates
            slide.offsetHeight;
            slide.classList.add('slide-active');
        } else {
            slide.classList.remove('slide-active', 'slide-exit');
            slide.style.display = 'none';
        }
    }

    // 2. Dots
    const dots = document.querySelectorAll('.wizard-progress .dot');
    dots.forEach((d, i) => {
        if(i < currentWizardStep) d.classList.add('active');
        else d.classList.remove('active');
    });

    // 2c. Lazy-load 3D models one slide before they appear (preload while user reads current slide)
    if (currentWizardStep >= 6) {
        const mv = document.getElementById('wizard-fitgotchi-preview');
        if (mv && !mv.getAttribute('src') && mv.dataset.lazySrc) mv.setAttribute('src', mv.dataset.lazySrc);
    }
    if (currentWizardStep >= 13) {
        const mv = document.getElementById('wizard-arny-preview');
        if (mv && !mv.getAttribute('src') && mv.dataset.lazySrc) mv.setAttribute('src', mv.dataset.lazySrc);
    }
    if (currentWizardStep >= 16) {
        const mv = document.getElementById('wizard-preview-model');
        if (mv && !mv.getAttribute('src') && mv.dataset.lazySrc) mv.setAttribute('src', mv.dataset.lazySrc);
    }

    // 3. Initialize character customization on slide 17
    if(currentWizardStep === 17) {
        initializeCharacterCustomization();
    }

    // 3b. Load referral code on slide 19
    if(currentWizardStep === 19) {
        loadWizardReferralCode();
    }

    // 3c. Calculate and display water goal on slide 9
    if(currentWizardStep === 9) {
        calculateAndDisplayWaterGoal();
    }

    // 4. Update final slide goal text
    if(currentWizardStep === 21) {
        const goalDiv = document.getElementById('wizard-hormone-goal');
        if(goalDiv) {
            goalDiv.innerHTML = 'Goal: Get Stronger & Level Up Your FitGotchi 💪';
        }
    }

    // 4. Buttons
    const prevBtn = document.getElementById('wizard-back');
    const nextBtn = document.getElementById('wizard-next');

    if(prevBtn) prevBtn.style.visibility = (currentWizardStep > 1) ? 'visible' : 'hidden';

    if(nextBtn) {
        if(currentWizardStep === totalWizardSteps) {
            nextBtn.innerHTML = "Let's Go! 🚀";
            nextBtn.onclick = finishOnboarding;
        } else {
            nextBtn.innerHTML = "Next &rarr;";
            nextBtn.onclick = wizardNext;
        }
    }
}

function calculateNutritionGoals(data) {
    // Calculate BMR using Mifflin-St Jeor Equation
    // BMR (kcal/day) = 10 × weight (kg) + 6.25 × height (cm) − 5 × age (y) + s
    // where s = +5 for males and −161 for females

    const weight = data.weight;
    const height = data.height;
    const age = data.age;
    const sex = data.sex;
    const goalBodyType = data.goalBodyType || 'Athletic'; // Default to Athletic if not specified

    let bmr;
    if (sex === 'male') {
        bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
    } else { // female
        bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
    }

    // Calculate TDEE (Total Daily Energy Expenditure) based on activity level
    let activityMultiplier;
    switch(data.activity_level) {
        case 'sedentary':
            activityMultiplier = 1.2;
            break;
        case 'light':
            activityMultiplier = 1.375;
            break;
        case 'moderate':
            activityMultiplier = 1.55;
            break;
        case 'very':
            activityMultiplier = 1.725;
            break;
        default:
            activityMultiplier = 1.375;
    }

    const tdee = bmr * activityMultiplier;

    // Calculate calorie goal based on weight goals
    let calorieGoal = tdee;
    if (data.goal_weight < data.weight) {
        // Weight loss: 250-500 cal deficit based on how much to lose
        const deficit = Math.min(500, Math.max(250, (data.weight - data.goal_weight) * 50));
        calorieGoal = tdee - deficit;
    } else if (data.goal_weight > data.weight) {
        // Weight gain: 300 cal surplus
        calorieGoal = tdee + 300;
    }

    // Adjust for body type goals
    if (goalBodyType === 'Body Builder') {
        // Higher calories for muscle building
        calorieGoal += 200;
    } else if (goalBodyType === 'Flat') {
        // Slight additional deficit for lean body
        calorieGoal -= 100;
    }

    // Ensure minimum safe calorie intake
    calorieGoal = Math.max(1200, calorieGoal);

    // Calculate Macronutrient Goals based on goal body type
    let proteinPercentage, carbPercentage, fatPercentage;

    if (goalBodyType === 'Body Builder') {
        // High protein for muscle building: 30% protein, 40% carbs, 30% fat
        proteinPercentage = 0.30;
        carbPercentage = 0.40;
        fatPercentage = 0.30;
    } else if (goalBodyType === 'Athletic') {
        // Balanced for athletic performance: 25% protein, 45% carbs, 30% fat
        proteinPercentage = 0.25;
        carbPercentage = 0.45;
        fatPercentage = 0.30;
    } else {
        // Flat & Toned (weight loss): 20% protein, 45% carbs, 35% fat
        proteinPercentage = 0.20;
        carbPercentage = 0.45;
        fatPercentage = 0.35;
    }

    // Calculate grams from calories (Protein: 4 cal/g, Carbs: 4 cal/g, Fat: 9 cal/g)
    const proteinCalories = calorieGoal * proteinPercentage;
    const carbCalories = calorieGoal * carbPercentage;
    const fatCalories = calorieGoal * fatPercentage;

    let proteinGrams = proteinCalories / 4;
    const carbGrams = carbCalories / 4;
    const fatGrams = fatCalories / 9;

    // Ensure minimum protein for plant-based diet (at least 1g per kg body weight)
    const minProtein = weight * 1.0;
    proteinGrams = Math.max(proteinGrams, minProtein);

    return {
        bmr: Math.round(bmr),
        tdee: Math.round(tdee),
        calorie_goal: Math.round(calorieGoal),
        protein_goal_g: Math.round(proteinGrams),
        carbs_goal_g: Math.round(carbGrams),
        fat_goal_g: Math.round(fatGrams)
    };
}

// Gender selection function
function selectGender(gender) {
    selectedGender = gender;
    document.getElementById('wizard-gender').value = gender;
    localStorage.setItem('userGender', gender);

    // Apply theme based on gender
    if (gender === 'male') {
        document.body.classList.add('male-theme');
        document.body.classList.remove('female-theme');
    } else {
        document.body.classList.add('female-theme');
        document.body.classList.remove('male-theme');
    }

    // Update button styles
    const femaleBtn = document.getElementById('gender-btn-female');
    const maleBtn = document.getElementById('gender-btn-male');

    if (gender === 'female') {
        femaleBtn.style.border = '2px solid var(--primary)';
        femaleBtn.style.background = '#f0fdf4';
        maleBtn.style.border = '2px solid #e2e8f0';
        maleBtn.style.background = 'white';
    } else {
        maleBtn.style.border = '2px solid #3b82f6';
        maleBtn.style.background = '#eff6ff';
        femaleBtn.style.border = '2px solid #e2e8f0';
        femaleBtn.style.background = 'white';
    }

    // Auto-advance to next slide after selection
    setTimeout(() => {
        currentWizardStep++;
        updateWizardUI();
    }, 300);
}

// Helper function to check if user is male
function isMaleUser() {
    return localStorage.getItem('userGender') === 'male';
}

// Apply gender theme on page load if already set
function applyGenderTheme() {
    const savedGender = localStorage.getItem('userGender');
    if (savedGender === 'male') {
        document.body.classList.add('male-theme');
        document.body.classList.remove('female-theme');
        selectedGender = 'male';
    } else if (savedGender === 'female') {
        document.body.classList.add('female-theme');
        document.body.classList.remove('male-theme');
        selectedGender = 'female';

        // Reset DBZ theme if female user has it selected (male-only themes)
        const currentTheme = localStorage.getItem('userThemePreference');
        if (currentTheme && currentTheme.startsWith('dbz-')) {
            localStorage.setItem('userThemePreference', 'default');
            if (typeof applyAppTheme === 'function') {
                applyAppTheme('default');
            }
        }
    }

    // Apply gender-specific UI changes
    applyGenderSpecificUI();
}

// Hide/show UI elements based on gender
function applyGenderSpecificUI() {
    const isMale = isMaleUser();

    // Elements to hide for males (by ID)
    const femaleOnlyElements = [
        'check-in-period-section',     // Period flow check-in
        'check-in-cervical-section',   // Cervical fluid check-in
        'cycle-hero-card',             // Performance Mode hero card (hidden for males)
        'check-in-prompt-card',        // Daily Check-in prompt card (hidden for males)
        'check-in-completed-card',     // Check-in completed card (hidden for males)
    ];

    // Elements to show only for males (by ID)
    const maleOnlyElements = [
        'check-in-recovery-section',   // Recovery status check-in
    ];

    femaleOnlyElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = isMale ? 'none' : '';
    });

    maleOnlyElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = isMale ? '' : 'none';
    });

    // Handle female-only and male-only chips (by class)
    document.querySelectorAll('.female-only-chip').forEach(el => {
        el.style.display = isMale ? 'none' : '';
    });

    document.querySelectorAll('.male-only-chip').forEach(el => {
        el.style.display = isMale ? '' : 'none';
    });

    // Handle gender-specific theme options
    // Use disabled attribute instead of display:none for <option> elements (browser compatibility)
    document.querySelectorAll('.female-only-theme').forEach(el => {
        if (isMale) {
            el.disabled = true;
            el.style.display = 'none'; // Hide in browsers that support it
        } else {
            el.disabled = false;
            el.style.display = '';
        }
    });

    document.querySelectorAll('.male-only-theme').forEach(el => {
        if (!isMale) {
            el.disabled = true;
            el.style.display = 'none'; // Hide in browsers that support it
        } else {
            el.disabled = false;
            el.style.display = '';
        }
    });

    // Show/hide DBZ character decorations based on theme and gender
    const dbzDecorations = document.getElementById('dbz-decorations');
    if (dbzDecorations) {
        const currentTheme = localStorage.getItem('userThemePreference') || 'default';
        const isDbzTheme = currentTheme.startsWith('dbz-');
        dbzDecorations.style.display = (isMale && isDbzTheme) ? 'block' : 'none';
    }

    // Show/hide Sailor Moon character decorations based on theme and gender
    const sailorDecorations = document.getElementById('sailor-decorations');
    if (sailorDecorations) {
        const currentTheme = localStorage.getItem('userThemePreference') || 'default';
        const isSailorMoonTheme = currentTheme.startsWith('sailor-');
        sailorDecorations.style.display = (!isMale && isSailorMoonTheme) ? 'block' : 'none';
    }

    // Update Hormone Hub for males
    if (isMale) {
        // Update cycle phase display for males
        const phaseName = document.getElementById('cycle-phase-name');
        const phaseDesc = document.getElementById('cycle-phase-desc');
        const phaseIcon = document.querySelector('#view-cycle .card-body div[style*="font-size: 2.5rem"]');

        if (phaseName) phaseName.textContent = 'Performance Mode';
        if (phaseDesc) phaseDesc.textContent = 'Optimized training based on your recovery and energy levels.';
        if (phaseIcon) phaseIcon.textContent = '💪';

        // Hide cycle day badge parent
        const cycleDayBadge = document.getElementById('cycle-day-display');
        if (cycleDayBadge && cycleDayBadge.parentElement) {
            cycleDayBadge.parentElement.style.display = 'none';
        }

        // Hide cycle phase tags
        const phaseTags = document.getElementById('cycle-phase-tags');
        if (phaseTags) phaseTags.style.display = 'none';

        // Update Hormone Hub title and subtitle
        const hormoneHubHeader = document.querySelector('#view-cycle div[style*="sticky"]');
        if (hormoneHubHeader) {
            const title = hormoneHubHeader.querySelector('h2');
            const subtitle = hormoneHubHeader.querySelector('div[style*="0.8rem"]');
            if (title) title.textContent = 'Performance Hub';
            if (subtitle) subtitle.remove();
        }

        // Hide Daily Sync feature for male users
        const checkInPrompt = document.getElementById('check-in-prompt-card');
        if (checkInPrompt) {
            checkInPrompt.style.display = 'none';
        }

        const completedCard = document.getElementById('check-in-completed-card');
        if (completedCard) {
            completedCard.style.display = 'none';
        }

        // Update bottom navigation "Cycle" tab to "Calendar"
        const navCycleLabel = document.getElementById('nav-cycle-label');
        if (navCycleLabel) navCycleLabel.textContent = 'Calendar';

        // Swap Progress and Calendar tab positions for males
        const bottomNav = document.querySelector('.bottom-nav');
        const progressBtn = bottomNav.querySelector('button[onclick*="progress"]');
        const cycleBtn = document.getElementById('nav-cycle-btn');
        if (bottomNav && progressBtn && cycleBtn) {
            // Insert cycle/calendar button before progress button
            bottomNav.insertBefore(cycleBtn, progressBtn);
        }

        // Update nav icon to calendar for males
        const navCycleIcon = document.getElementById('nav-cycle-icon');
        if (navCycleIcon) {
            navCycleIcon.innerHTML = '<path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>';
        }

        // Hide Cycle Tracking button for male users (not applicable)
        const cycleTrackingBtn = document.querySelector('button[onclick="openCycleTrackingModal()"]');
        if (cycleTrackingBtn) {
            cycleTrackingBtn.style.display = 'none';
        }

        // Update meal card descriptions for males
        const flaxDesc = document.getElementById('flax-description');
        if (flaxDesc) {
            flaxDesc.textContent = '1-2 tbsp daily. Rich in omega-3s and fiber for recovery and gut health.';
        }

        // Update any estrogen-related text visible to users
        document.querySelectorAll('p, span, div').forEach(el => {
            if (el.id) return; // Skip elements we handle specifically
            if (el.textContent.includes('balance estrogen') && !el.textContent.includes('Rich in omega-3s')) {
                el.textContent = el.textContent.replace('balance estrogen', 'support recovery');
            }
            if (el.textContent.includes('estrogen detox')) {
                el.textContent = el.textContent.replace('estrogen detox', 'metabolic optimization');
            }
        });
    }

    // Update Metabolic Protocol section based on gender
    const typeLabel = document.getElementById('profile-type-label');
    const typeDesc = document.getElementById('profile-type-desc');
    const typeDisplay = document.getElementById('profile-type-display');

    if (isMale) {
        // Males: Show Energy Level instead of Hormone Type
        if (typeLabel) typeLabel.textContent = 'Energy Level';
        if (typeDesc) typeDesc.textContent = 'Affects workout intensity';
        if (typeDisplay) {
            const energyLevel = window.userEnergyLevel || 'normal';
            const energyMap = {
                'low': 'Low Energy',
                'normal': 'Normal',
                'high': 'High Energy'
            };
            typeDisplay.textContent = energyMap[energyLevel] || 'Normal';
        }
    } else {
        // Females: Show Hormone Type (default)
        if (typeLabel) typeLabel.textContent = 'Hormone Type';
        if (typeDesc) typeDesc.textContent = 'Determines your nutrition plan';
        // typeDisplay keeps its hormone profile value (set in loadProfileData)
    }
}

async function wizardNext() {
    // Validation for Step 1: Gender Selection
    if(currentWizardStep === 1) {
        if (!selectedGender) {
            wizardAlert("Please select your program (For Her or For Him).");
            return;
        }
        // Gender already saved in selectGender function
        console.log("Step 1 gender selected:", selectedGender);
    }

    // Validation for Step 2: Essential Data Collection
    if(currentWizardStep === 2) {
        const name = document.getElementById('wizard-name').value.trim();
        const age = document.getElementById('wizard-age').value;
        const height = document.getElementById('wizard-height').value;
        const weight = document.getElementById('wizard-weight').value;
        const goalWeight = document.getElementById('wizard-goal-weight').value;
        const goalType = document.getElementById('wizard-goal-type').value;
        const equipment = document.getElementById('wizard-equipment').value;
        const activityLevel = document.getElementById('wizard-activity-level').value;
        const energyLevel = document.getElementById('wizard-energy-level').value;

        // Validate all required fields
        if (!name) {
            wizardAlert("Please enter your name.");
            return;
        }
        if (!age || age < 18 || age > 100) {
            wizardAlert("Please enter a valid age (18-100).");
            return;
        }
        if (!height || height < 100 || height > 250) {
            wizardAlert("Please enter a valid height in cm (100-250).");
            return;
        }
        if (!weight || weight < 30 || weight > 300) {
            wizardAlert("Please enter a valid weight in kg (30-300).");
            return;
        }
        if (!goalWeight || goalWeight < 30 || goalWeight > 300) {
            wizardAlert("Please enter a valid goal weight in kg (30-300).");
            return;
        }
        if (!goalType) {
            wizardAlert("Please select your primary goal.");
            return;
        }
        if (!equipment) {
            wizardAlert("Please select your equipment access.");
            return;
        }
        if (!activityLevel) {
            wizardAlert("Please select your activity level.");
            return;
        }
        if (!energyLevel) {
            wizardAlert("Please select your energy status.");
            return;
        }

        const dietaryPreference = document.getElementById('wizard-dietary-preference').value;
        if (!dietaryPreference) {
            wizardAlert("Please select your dietary preference.");
            return;
        }

        // Save dietary preference to localStorage for quick access
        localStorage.setItem('dietaryPreference', dietaryPreference);

        // Save to sessionStorage for later processing
        const quizData = {
            name: name,
            age: parseInt(age),
            dietary_preference: dietaryPreference,
            sex: selectedGender, // Use gender from "For Her/For Him" selection
            height: parseFloat(height),
            weight: parseFloat(weight),
            goal_weight: parseFloat(goalWeight),
            goalBodyType: goalType, // Maps to: 'Flat' (weight loss), 'Athletic' (toned), 'Body Builder' (muscle gain)
            equipment_access: equipment,
            activity_level: activityLevel,
            energy_level: energyLevel,
            user_gender: selectedGender // Also store gender preference
        };

        // Calculate BMR, TDEE, and Macros
        const calculatedData = calculateNutritionGoals(quizData);
        Object.assign(quizData, calculatedData);

        // Store in sessionStorage
        sessionStorage.setItem('userProfile', JSON.stringify(quizData));

        console.log("Step 2 data collected:", quizData);

        // If male, skip cycle tracking (step 3) and go directly to step 4
        if (selectedGender === 'male') {
            // Set default values for males (no cycle tracking, no hormone profile)
            let existingData = {};
            try { existingData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
            existingData.menopause_status = 'not_applicable';
            existingData.last_period = null;
            existingData.profile = null; // Males don't have hormone profiles
            sessionStorage.setItem('userProfile', JSON.stringify(existingData));
            sessionStorage.removeItem('userResult'); // Remove any existing hormone profile

            // Skip to step 4 (nutrition logic)
            currentWizardStep = 4;
            updateWizardUI();
            return;
        }
    }

    // Validation for Step 3: Cycle Setup (females only)
    if(currentWizardStep === 3) {
        const dateInput = document.getElementById('wizard-period-date');
        const wellnessToggle = document.getElementById('wizard-wellness-toggle');

        if (!wellnessToggle.checked && !dateInput.value) {
            wizardAlert("Please enter your last period date so we can sync your plan.");
            return;
        }

        // NEW: Validate cycle sync questions
        const cycleSyncPref = document.querySelector('input[name="wizard-cycle-sync"]:checked')?.value;
        if (!cycleSyncPref) {
            wizardAlert("Please select whether you want to sync your workouts with your cycle.");
            return;
        }

        // If cycle sync is enabled, validate period energy question
        if (cycleSyncPref === 'yes') {
            const periodEnergy = document.querySelector('input[name="wizard-period-energy"]:checked')?.value;
            if (!periodEnergy) {
                wizardAlert("Please select how your body responds during your period.");
                return;
            }
        }

        // Save Data
        if (wellnessToggle.checked) {
            userCycleData.noPeriodMode = true;
            toggleNoPeriodMode(); // Apply logic
        } else {
            userCycleData.noPeriodMode = false;
            userCycleData.lastPeriod = dateInput.value;
            // Also update the Settings input in profile
            const settingsInput = document.getElementById('last-period-input-profile');
            if(settingsInput) settingsInput.value = dateInput.value;

            updateCycleData(); // Trigger calculations
        }

        // CRITICAL: Save userCycleData to localStorage AND database
        localStorage.setItem('userCycleData', JSON.stringify(userCycleData));

        // Save to database for cross-device persistence (non-blocking — localStorage is already saved above)
        if (window.currentUser) {
            (async () => {
                try {
                    const userId = window.currentUser.id || window.currentUser.user_id;
                    let existingFacts = {};
                    try {
                        existingFacts = await dbHelpers.userFacts.get(userId);
                    } catch(err) { /* ignore not found */ }

                    const currentAdditional = existingFacts?.additional_data || {};
                    const userProfile = JSON.parse(sessionStorage.getItem('userProfile') || localStorage.getItem('userProfile') || '{}');

                    const dataToSave = {
                        additional_data: {
                            ...currentAdditional,
                            last_period_start: userCycleData.lastPeriod,
                            cycle_length: userCycleData.cycleLength,
                            no_period_mode: userCycleData.noPeriodMode,
                            cycle_sync_preference: userProfile.cycle_sync_preference,
                            period_energy_response: userProfile.period_energy_response
                        }
                    };

                    console.log('💾 Saving cycle data to database:', dataToSave);
                    await dbHelpers.userFacts.upsert(userId, dataToSave);
                    console.log('✅ Cycle data saved to database successfully');
                } catch (e) {
                    console.error('❌ Failed to save cycle data to database:', e);
                }
            })();
        }

        // Add menopause status to quizData
        let existingData = {};
        try { existingData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        const age = existingData.age || 0;

        // Determine menopause status based on wellness toggle and age
        let menopause_status = 'cycling';
        if (wellnessToggle.checked || age > 45) {
            menopause_status = 'menopause';
        }

        existingData.menopause_status = menopause_status;
        existingData.last_period = wellnessToggle.checked ? null : dateInput.value;

        // NEW: Save cycle sync preferences
        existingData.cycle_sync_preference = cycleSyncPref;
        existingData.period_energy_response = document.querySelector('input[name="wizard-period-energy"]:checked')?.value || 'high';

        // Calculate hormone profile (CORTISOL vs ESTROGEN)
        if (menopause_status === 'menopause' || age > 45) {
            existingData.profile = 'ESTROGEN';
        } else {
            existingData.profile = 'CORTISOL';
        }

        sessionStorage.setItem('userProfile', JSON.stringify(existingData));
        sessionStorage.setItem('userResult', existingData.profile);

        // NEW: Also save to localStorage for immediate use
        localStorage.setItem('userProfile', JSON.stringify(existingData));

        // NEW: Add timestamp for when onboarding was completed (for equipment override priority)
        existingData.onboarding_completed_at = new Date().toISOString();
        localStorage.setItem('onboardingCompletedAt', existingData.onboarding_completed_at);

        // NOTE: Cycle sync preferences are now saved to user_facts.additional_data (via the cycle data save above)
        // This is more reliable as user_facts uses upsert and doesn't require an existing quiz_results row
        console.log('✅ Cycle sync preferences included in cycle data save');

        console.log("Step 3 data collected, hormone profile:", existingData.profile, "cycle sync:", existingData.cycle_sync_preference, "period energy:", existingData.period_energy_response);
    }

    // Validation for Step 4: Training Frequency & Days
    if(currentWizardStep === 4) {
        if (!wizardTrainingFrequency || wizardTrainingFrequency < 2) {
            wizardAlert("Please select how many days you want to train.");
            return;
        }
        if (wizardSelectedDays.size !== wizardTrainingFrequency) {
            wizardAlert(`Please select exactly ${wizardTrainingFrequency} training days.`);
            return;
        }

        // Save to sessionStorage
        let existingData = {};
        try { existingData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        existingData.training_frequency = wizardTrainingFrequency;
        existingData.training_days = Array.from(wizardSelectedDays).join(',');
        existingData.recovery_on_rest_days = document.getElementById('wizard-recovery-days')?.checked;
        sessionStorage.setItem('userProfile', JSON.stringify(existingData));

        // Check if user has gym equipment - if not, skip split preference (step 5)
        const equipment = existingData.equipment_access;
        if (equipment !== 'gym') {
            // Generate calendar and skip to preview (step 6)
            generateWizardCalendar();
            currentWizardStep = 6;
            updateWizardUI();
            return;
        }
    }

    // Validation for Step 5: Split Preference
    if(currentWizardStep === 5) {
        if (!wizardSplitPreference) {
            wizardAlert("Please select your training split preference.");
            return;
        }

        // Save to sessionStorage
        let existingData = {};
        try { existingData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        existingData.split_preference = wizardSplitPreference;
        sessionStorage.setItem('userProfile', JSON.stringify(existingData));

        // Generate the calendar preview
        generateWizardCalendar();
    }

    // Step 6: Calendar Preview - render the preview
    if(currentWizardStep === 6) {
        // Save workout calendar to sessionStorage
        let existingData = {};
        try { existingData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        existingData.workout_calendar = JSON.stringify(wizardWorkoutCalendar);
        sessionStorage.setItem('userProfile', JSON.stringify(existingData));
        localStorage.setItem('workoutCalendar', JSON.stringify(wizardWorkoutCalendar));
    }

    // Step 9: Water Goal - save hydration settings
    if(currentWizardStep === 9) {
        const waterGoal = parseInt(document.getElementById('wizard-water-goal-ml')?.value) || wizardWaterGoalMl;
        const glassSize = parseInt(document.getElementById('wizard-glass-size')?.value) || wizardGlassSize;
        const totalGlasses = Math.ceil(waterGoal / glassSize);

        // Save to localStorage for the hydration tracker
        localStorage.setItem('pbb_water_goal_ml', waterGoal.toString());
        localStorage.setItem('pbb_water_glass_size', glassSize.toString());
        localStorage.setItem('pbb_water_total_glasses', totalGlasses.toString());

        // Also save to sessionStorage userProfile for DB sync
        let existingData = {};
        try { existingData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        existingData.water_goal_ml = waterGoal;
        existingData.water_glass_size = glassSize;
        existingData.water_total_glasses = totalGlasses;
        sessionStorage.setItem('userProfile', JSON.stringify(existingData));

        console.log("Step 9 water goal saved:", waterGoal, "ml, glass size:", glassSize, "ml, total glasses:", totalGlasses);
    }

    if(currentWizardStep < totalWizardSteps) {
        currentWizardStep++;
        updateWizardUI();

        // Render calendar preview when entering step 6
        if(currentWizardStep === 6) {
            renderWizardCalendarPreview();
        }
    }
}

function wizardPrev() {
    if(currentWizardStep > 1) {
        // Handle skip logic for backward navigation
        if (selectedGender === 'male' && currentWizardStep === 4) {
            // Males skip cycle tracking (step 3)
            currentWizardStep = 2;
        } else if (currentWizardStep === 6) {
            // Check if we should skip split preference (non-gym users)
            let userData = {};
            try { userData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
            if (userData.equipment_access !== 'gym') {
                currentWizardStep = 4; // Skip back to frequency/days
            } else {
                currentWizardStep--;
            }
        } else {
            currentWizardStep--;
        }
        updateWizardUI();
    }
}

// ========== CHARACTER CUSTOMIZATION FUNCTIONS ==========

// Temporary storage for wizard character colors
let wizardCharacterColors = null;
let wizardCharacterInitialized = false;

let _charCustomRetries = 0;
function initializeCharacterCustomization() {
    // Only initialize once
    if (wizardCharacterInitialized) {
        return;
    }

    // Wait for CHARACTER_COLOR_OPTIONS to be available (max 2 seconds / 10 retries)
    if (!window.CHARACTER_COLOR_OPTIONS) {
        if (_charCustomRetries < 10) {
            _charCustomRetries++;
            setTimeout(initializeCharacterCustomization, 200);
        } else {
            console.warn('CHARACTER_COLOR_OPTIONS not available after 2s, using defaults');
        }
        return;
    }

    wizardCharacterInitialized = true;

    // Get saved colors or defaults
    wizardCharacterColors = window.getCharacterColors ? window.getCharacterColors() : {
        hair: '#4a3728',
        shirt: '#7BA883',
        pants: '#2C3E50',
        shoes: '#1a202c',
        skin: '#DEB887'
    };

    const colorOptions = window.CHARACTER_COLOR_OPTIONS;

    // Render color buttons for each category (hair, pants, skin only - shirt/shoes use defaults)
    renderColorButtons('hair', colorOptions.hair, 'wizard-hair-colors');
    renderColorButtons('pants', colorOptions.pants, 'wizard-pants-colors');
    renderColorButtons('skin', colorOptions.skin, 'wizard-skin-colors');

    // Initialize the preview model with current colors and correct gender model
    const previewModel = document.getElementById('wizard-preview-model');
    if (previewModel) {
        // Baby model is unisex - same for all genders in onboarding
        const babySrc = 'https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb';
        if (previewModel.getAttribute('src') !== babySrc) {
            previewModel.setAttribute('src', babySrc);
        }
        previewModel.addEventListener('load', function onLoad() {
            applyWizardCharacterColors();
            previewModel.removeEventListener('load', onLoad);
        }, { once: true });

        // If model is already loaded, apply colors immediately
        if (previewModel.model) {
            applyWizardCharacterColors();
        }
    }
}

function renderColorButtons(category, colors, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';

    colors.forEach(color => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'color-btn';
        btn.dataset.category = category;
        btn.dataset.color = color.hex;
        btn.title = color.name;
        btn.style.cssText = `
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid ${wizardCharacterColors[category] === color.hex ? 'var(--primary)' : '#e2e8f0'};
            background: ${color.hex};
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: ${wizardCharacterColors[category] === color.hex ? '0 0 0 2px var(--primary)' : 'none'};
        `;

        btn.addEventListener('click', () => selectWizardColor(category, color.hex));
        btn.addEventListener('mouseenter', () => {
            btn.style.transform = 'scale(1.1)';
        });
        btn.addEventListener('mouseleave', () => {
            btn.style.transform = 'scale(1)';
        });

        container.appendChild(btn);
    });
}

function selectWizardColor(category, hex) {
    wizardCharacterColors[category] = hex;

    // Update button styles
    const container = document.getElementById(`wizard-${category}-colors`);
    if (container) {
        container.querySelectorAll('.color-btn').forEach(btn => {
            const isSelected = btn.dataset.color === hex;
            btn.style.border = `3px solid ${isSelected ? 'var(--primary)' : '#e2e8f0'}`;
            btn.style.boxShadow = isSelected ? '0 0 0 2px var(--primary)' : 'none';
        });
    }

    // Apply colors to preview model
    applyWizardCharacterColors();
}

async function applyWizardCharacterColors() {
    const previewModel = document.getElementById('wizard-preview-model');
    if (!previewModel || !previewModel.model) return;

    const model = previewModel.model;
    if (!model.materials) return;

    const colors = wizardCharacterColors;
    const src = (previewModel.getAttribute('src') || '').toLowerCase();

    const hexToRgb01 = (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? { r: parseInt(result[1], 16)/255, g: parseInt(result[2], 16)/255, b: parseInt(result[3], 16)/255 } : null;
    };

    Object.keys(colors).forEach(cat => {
        const hex = colors[cat];
        if (!hex) return;
        const rgb = hexToRgb01(hex);
        if (!rgb) return;

        let targets = [];

        // Use same per-model material mappings as the main applyCharacterColors override
        if (src.includes('baby')) {
            if(cat==='skin') targets=['tripo_part_new_0.001']; if(cat==='hair') targets=['tripo_part_0.001']; if(cat==='pants') targets=['tripo_part_8.001']; if(cat==='shoes') targets=['tripo_part_3.001'];
        }
        else if (src.includes('level_1_female')) {
            if(cat==='skin') targets=['part_new']; if(cat==='hair') targets=['part_2']; if(cat==='shirt') targets=['part_8']; if(cat==='pants') targets=['part_4']; if(cat==='shoes') targets=['part_11'];
        }
        else if (src.includes('level_1_good') || src.includes('shazylvl1')) {
            if(cat==='skin') targets=['part_10_material']; if(cat==='hair') targets=['part_7_material']; if(cat==='shirt') targets=['part_5_material']; if(cat==='pants') targets=['part_6_material']; if(cat==='shoes') targets=['part_9_material'];
        }

        // Fallback to keyword matching
        if (targets.length === 0) {
            if(cat==='skin') targets=['skin', 'body', 'face', 'arm', 'hand'];
            if(cat==='hair') targets=['hair', 'head'];
            if(cat==='shirt') targets=['shirt', 'top', 'vest'];
            if(cat==='pants') targets=['pants', 'shorts', 'leg'];
            if(cat==='shoes') targets=['shoes', 'boot', 'feet'];
        }

        model.materials.forEach(mat => {
            const matName = (mat.name || '').toLowerCase();
            const matched = targets.some(t => matName.includes(t));
            if (matched) {
                const pbr = mat.pbrMetallicRoughness;
                if (pbr) {
                    pbr.baseColorTexture = null;
                    pbr.setBaseColorFactor([rgb.r, rgb.g, rgb.b, 1]);
                    if (cat === 'skin' || cat === 'hair') {
                        pbr.setRoughnessFactor(0.9);
                        pbr.setMetallicFactor(0.0);
                    }
                }
            }
        });
    });
}

function hexToRgbWizard(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function saveWizardCharacterColors() {
    if (wizardCharacterColors && window.saveCharacterColors) {
        window.saveCharacterColors(wizardCharacterColors);
        console.log('Character colors saved from wizard:', wizardCharacterColors);
    }
}

// ========== WIZARD REFERRAL FUNCTIONS ==========

async function loadWizardReferralCode() {
    const codeDisplay = document.getElementById('wizard-referral-code');
    if (!codeDisplay) return;

    if (currentReferralCode) {
        codeDisplay.textContent = currentReferralCode;
        return;
    }

    if (window.currentUser) {
        try {
            const stats = await window.dbHelpers.referrals.getStats(window.currentUser.id);
            if (stats.referralCode) {
                currentReferralCode = stats.referralCode;
                codeDisplay.textContent = stats.referralCode;
            } else {
                codeDisplay.textContent = 'Sign up to get your code!';
                codeDisplay.style.fontSize = '1rem';
            }
        } catch (e) {
            codeDisplay.textContent = 'Available after setup!';
            codeDisplay.style.fontSize = '1rem';
        }
    } else {
        codeDisplay.textContent = 'Available after setup!';
        codeDisplay.style.fontSize = '1rem';
    }
}

function wizardShareWhatsApp() {
    const code = currentReferralCode;
    if (!code) {
        showToast('Your referral code will be available after you finish setup!', 'info');
        return;
    }
    const link = `${window.location.origin}/login.html?ref=${code}`;
    const message = `Hey! Join me on FITGotchi. Gamify your fitness - I'm really loving it! We BOTH get 1 week double XP! Use my code ${code} or click here: ${link}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
}

function wizardShareSMS() {
    const code = currentReferralCode;
    if (!code) {
        showToast('Your referral code will be available after you finish setup!', 'info');
        return;
    }
    const link = `${window.location.origin}/login.html?ref=${code}`;
    const message = `Hey! Join me on FITGotchi. Gamify your fitness - I'm really loving it! We BOTH get 1 week double XP! Use code ${code} or click: ${link}`;
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
        window.location.href = `sms:?&body=${encodeURIComponent(message)}`;
    } else {
        navigator.clipboard.writeText(message).then(() => {
            showToast('Message copied! Paste it into your SMS app.', 'success');
        });
    }
}

function wizardCopyLink() {
    const code = currentReferralCode;
    if (!code) {
        showToast('Your referral code will be available after you finish setup!', 'info');
        return;
    }
    const link = `${window.location.origin}/login.html?ref=${code}`;
    navigator.clipboard.writeText(link).then(() => {
        showToast('Referral link copied!', 'success');
        const btn = event.target.closest('button');
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>Copied!</span>';
            setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        }
    });
}

// ========== WORKOUT CALENDAR FUNCTIONS ==========

function selectTrainingFrequency(num) {
    wizardTrainingFrequency = num;
    document.getElementById('wizard-training-frequency').value = num;

    // Update button styles
    document.querySelectorAll('.freq-btn').forEach(btn => {
        if (parseInt(btn.dataset.freq) === num) {
            btn.style.background = '#48864B';
            btn.style.color = '#fff';
            btn.style.transform = 'scale(1.1)';
        } else {
            btn.style.background = '#fff';
            btn.style.color = '#1a4d2e';
            btn.style.transform = 'scale(1)';
        }
    });

    // Update tip text
    const tips = {
        2: 'Perfect for beginners or busy schedules',
        3: 'Great balance of training and recovery',
        4: 'Ideal for building strength with good recovery',
        5: 'Dedicated training with rest built in',
        6: 'Serious training - we\'ll ensure proper recovery',
        7: 'Every day! We\'ll include active recovery days'
    };
    document.getElementById('freq-tip').textContent = tips[num] || '';

    // Reset day selection if frequency changed
    if (wizardSelectedDays.size > num) {
        wizardSelectedDays.clear();
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.style.background = '#fff';
            btn.style.color = '#1a4d2e';
        });
    }
    updateDaysCounter();
}

function toggleTrainingDay(day) {
    if (!wizardTrainingFrequency) {
        wizardAlert('Please select how many days you want to train first.');
        return;
    }

    const btn = document.querySelector(`.day-btn[data-day="${day}"]`);

    if (wizardSelectedDays.has(day)) {
        wizardSelectedDays.delete(day);
        btn.style.background = '#fff';
        btn.style.color = '#1a4d2e';
    } else {
        if (wizardSelectedDays.size >= wizardTrainingFrequency) {
            wizardAlert(`You can only select ${wizardTrainingFrequency} days. Deselect one first.`);
            return;
        }
        wizardSelectedDays.add(day);
        btn.style.background = '#48864B';
        btn.style.color = '#fff';
    }

    document.getElementById('wizard-training-days').value = Array.from(wizardSelectedDays).join(',');
    updateDaysCounter();
}

function updateDaysCounter() {
    const counter = document.getElementById('days-counter');
    if (counter) {
        if (wizardTrainingFrequency) {
            counter.textContent = `${wizardSelectedDays.size} of ${wizardTrainingFrequency} days selected`;
        } else {
            counter.textContent = 'Select your training days';
        }
    }
}

function selectSplitPreference(split) {
    wizardSplitPreference = split;
    document.getElementById('wizard-split-preference').value = split;

    // Check for mismatch warnings
    const freq = wizardTrainingFrequency;
    let warning = null;

    if (split === 'bro_split' && freq < 5) {
        warning = `Bro Split works best with 5-6 days. You selected ${freq} days. Continue anyway?`;
    } else if (split === 'full_body' && freq > 4) {
        warning = `Full Body is typically done 2-3 days/week for recovery. You selected ${freq} days. Continue anyway?`;
    }

    if (warning && !confirm(warning)) {
        return;
    }

    // Update button styles
    document.querySelectorAll('.split-btn').forEach(btn => {
        if (btn.dataset.split === split) {
            btn.style.borderColor = '#48864B';
            btn.style.background = 'rgba(72, 134, 75, 0.05)';
        } else {
            btn.style.borderColor = '#e2e8f0';
            btn.style.background = '#fff';
        }
    });

    // Auto-advance after selection
    setTimeout(() => {
        generateWizardCalendar();
        currentWizardStep++;
        updateWizardUI();
        renderWizardCalendarPreview();
    }, 300);
}

function generateWizardCalendar() {
    let userData = {};
    try { userData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
    const trainingDays = Array.from(wizardSelectedDays);
    const equipment = userData.equipment_access || 'none';
    const split = wizardSplitPreference || 'full_body';
    const recoveryOnRestDays = document.getElementById('wizard-recovery-days')?.checked;
    const allDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    // Reset calendar
    wizardWorkoutCalendar = {};

    // Determine workout sequence based on split and equipment
    let workoutSequence = [];

    if (equipment === 'gym') {
        if (split === 'ppl') {
            workoutSequence = ['gym-push', 'gym-pull', 'gym-legs'];
        } else if (split === 'upper_lower') {
            workoutSequence = ['gym-upper', 'gym-lower'];
        } else if (split === 'bro_split') {
            workoutSequence = ['gym-chest', 'gym-back', 'gym-shoulders', 'gym-legs', 'gym-arms'];
        } else {
            workoutSequence = ['gym-fullbody'];
        }
    } else if (equipment === 'dumbbells') {
        workoutSequence = ['home-upper', 'home-lower', 'home-fullbody'];
    } else if (equipment === 'bands') {
        workoutSequence = ['bands-upper', 'bands-lower', 'bands-fullbody'];
    } else if (equipment === 'none' || equipment === 'bodyweight') {
        workoutSequence = ['bw-upper', 'bw-lower', 'bw-core', 'bw-fullbody'];
    } else if (equipment === 'yoga_only') {
        workoutSequence = ['yoga-flow', 'yoga-restorative', 'yoga-mobility'];
    }

    // Assign workouts to training days
    let workoutIndex = 0;
    allDays.forEach(day => {
        if (trainingDays.includes(day)) {
            wizardWorkoutCalendar[day] = workoutSequence[workoutIndex % workoutSequence.length];
            workoutIndex++;
        } else {
            wizardWorkoutCalendar[day] = recoveryOnRestDays ? 'yoga-restorative' : 'rest';
        }
    });
}

function renderWizardCalendarPreview() {
    const container = document.getElementById('wizard-calendar-preview');
    if (!container) return;

    const allDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const dayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    // IDs match workout_library.js
    const workoutInfo = {
        // GYM workouts
        'gym-push': { icon: '🏋️', name: 'Push', desc: 'Chest, Shoulders, Triceps' },
        'gym-pull': { icon: '🏋️', name: 'Pull', desc: 'Back, Biceps' },
        'gym-legs': { icon: '🏋️', name: 'Legs', desc: 'Quads, Hamstrings, Glutes' },
        'gym-chest': { icon: '🏋️', name: 'Chest', desc: '' },
        'gym-back': { icon: '🏋️', name: 'Back', desc: '' },
        'gym-shoulders': { icon: '🏋️', name: 'Shoulders', desc: '' },
        'gym-arms': { icon: '🏋️', name: 'Arms', desc: '' },
        'gym-core': { icon: '🏋️', name: 'Core', desc: '' },
        'gym-upper': { icon: '🏋️', name: 'Upper Body', desc: '' },
        'gym-lower': { icon: '🏋️', name: 'Lower Body', desc: '' },
        'gym-fullbody': { icon: '🏋️', name: 'Full Body', desc: '' },
        // HOME WEIGHTS workouts
        'home-upper': { icon: '🏠', name: 'Upper Body', desc: '' },
        'home-lower': { icon: '🏠', name: 'Lower Body', desc: '' },
        'home-fullbody': { icon: '🏠', name: 'Full Body', desc: '' },
        'home-arms': { icon: '🏠', name: 'Arms', desc: '' },
        'home-shoulders': { icon: '🏠', name: 'Shoulders', desc: '' },
        // BANDS workouts
        'bands-upper': { icon: '🔗', name: 'Upper Body', desc: '' },
        'bands-lower': { icon: '🔗', name: 'Lower Body', desc: '' },
        'bands-fullbody': { icon: '🔗', name: 'Full Body', desc: '' },
        // BODYWEIGHT workouts
        'bw-upper': { icon: '🤸', name: 'Upper Body', desc: '' },
        'bw-lower': { icon: '🤸', name: 'Lower Body', desc: '' },
        'bw-core': { icon: '🤸', name: 'Core', desc: '' },
        'bw-fullbody': { icon: '🤸', name: 'Full Body', desc: '' },
        // YOGA workouts
        'yoga-flow': { icon: '🧘', name: 'Power Yoga', desc: 'Active Recovery' },
        'yoga-restorative': { icon: '🧘', name: 'Restorative Yoga', desc: 'Recovery' },
        'yoga-mobility': { icon: '🧘', name: 'Mobility Yoga', desc: '' },
        // RECOVERY workouts
        'recovery-stretch': { icon: '🔄', name: 'Stretching', desc: '' },
        'recovery-foam': { icon: '🔄', name: 'Foam Rolling', desc: '' },
        'rest': { icon: '⏸️', name: 'Rest Day', desc: '' }
    };

    // Build all DOM in a DocumentFragment (single reflow instead of 35+ individual insertions)
    const frag = document.createDocumentFragment();

    // Add instruction text
    const instruction = document.createElement('p');
    instruction.style.cssText = 'text-align:center; font-size:13px; color:#666; margin-bottom:12px;';
    instruction.textContent = 'Tap any day to change the workout';
    frag.appendChild(instruction);

    // Create day rows
    allDays.forEach((day, idx) => {
        const workout = wizardWorkoutCalendar[day] || 'rest';
        const info = workoutInfo[workout] || { icon: '?', name: 'Unknown', desc: '' };

        const row = document.createElement('div');
        row.style.cssText = `display:flex; align-items:center; padding:12px 0; cursor:pointer; transition:background 0.2s;${idx < 6 ? ' border-bottom:1px solid #f0f0f0;' : ''}`;
        row.onmouseenter = () => { row.style.background = 'rgba(72, 134, 75, 0.05)'; };
        row.onmouseleave = () => { row.style.background = 'transparent'; };

        const dayCol = document.createElement('div');
        dayCol.style.cssText = 'width:90px; font-weight:600; color:#1a4d2e; font-size:13px;';
        dayCol.textContent = dayLabels[idx];

        const workoutCol = document.createElement('div');
        workoutCol.style.cssText = 'flex:1; display:flex; align-items:center; gap:10px;';

        const icon = document.createElement('span');
        icon.style.fontSize = '18px';
        icon.textContent = info.icon;

        const workoutText = document.createElement('div');
        workoutText.innerHTML = `<div style="font-weight:500; color:#333; font-size:13px;">${info.name}</div>${info.desc ? `<div style="font-size:11px; color:#888;">${info.desc}</div>` : ''}`;

        const editIcon = document.createElement('span');
        editIcon.style.cssText = 'margin-left:auto; color:#48864B; font-size:14px;';
        editIcon.innerHTML = '&#9662;';

        workoutCol.append(icon, workoutText, editIcon);
        row.append(dayCol, workoutCol);
        row.onclick = () => { showWizardWorkoutDropdown(day, dayLabels[idx], renderWizardCalendarPreview); };
        frag.appendChild(row);
    });

    // Add summary
    const trainingCount = Object.values(wizardWorkoutCalendar).filter(w =>
        w && !['rest', 'yoga-restorative', 'yoga-flow', 'yoga-mobility', 'recovery-stretch', 'recovery-foam'].includes(w)
    ).length;
    const yogaCount = Object.values(wizardWorkoutCalendar).filter(w =>
        ['yoga-restorative', 'yoga-flow', 'yoga-mobility'].includes(w)
    ).length;
    const restCount = Object.values(wizardWorkoutCalendar).filter(w =>
        w === 'rest' || ['recovery-stretch', 'recovery-foam'].includes(w)
    ).length;

    const summary = document.createElement('div');
    summary.style.cssText = 'text-align:center; margin-top:12px; padding:10px; background:rgba(72,134,75,0.1); border-radius:8px; font-size:13px; color:#1a4d2e;';
    summary.innerHTML = `<strong>${trainingCount} training</strong> · <strong>${yogaCount} yoga</strong> · <strong>${restCount} rest</strong>`;
    frag.appendChild(summary);

    // Single DOM write — replaces all previous content
    container.innerHTML = '';
    container.appendChild(frag);
}

function openCalendarEditor() {
    // For now, just go back to step 4 to re-select days
    currentWizardStep = 4;
    updateWizardUI();
}

// Get workout options based on wizard equipment selection
function getWizardWorkoutOptions() {
    const equipment = document.getElementById('wizard-equipment')?.value || 'none';
    const options = [];

    // Base options available to everyone
    options.push({ category: 'YOGA', items: [
        { id: 'yoga-flow', name: 'Power Yoga', icon: '🧘' },
        { id: 'yoga-restorative', name: 'Restorative Yoga', icon: '🧘' },
        { id: 'yoga-mobility', name: 'Mobility Yoga', icon: '🧘' }
    ]});

    options.push({ category: 'RECOVERY', items: [
        { id: 'recovery-stretch', name: 'Stretching', icon: '🔄' },
        { id: 'recovery-foam', name: 'Foam Rolling', icon: '🔄' }
    ]});

    options.push({ category: 'REST', items: [
        { id: 'rest', name: 'Rest Day', icon: '⏸️' }
    ]});

    // Equipment-specific options
    if (equipment === 'gym') {
        options.unshift({ category: 'GYM', items: [
            { id: 'gym-push', name: 'Push (Chest, Shoulders, Triceps)', icon: '🏋️' },
            { id: 'gym-pull', name: 'Pull (Back, Biceps)', icon: '🏋️' },
            { id: 'gym-legs', name: 'Legs', icon: '🏋️' },
            { id: 'gym-chest', name: 'Chest', icon: '🏋️' },
            { id: 'gym-back', name: 'Back', icon: '🏋️' },
            { id: 'gym-shoulders', name: 'Shoulders', icon: '🏋️' },
            { id: 'gym-arms', name: 'Arms', icon: '🏋️' },
            { id: 'gym-core', name: 'Core', icon: '🏋️' },
            { id: 'gym-upper', name: 'Upper Body', icon: '🏋️' },
            { id: 'gym-lower', name: 'Lower Body', icon: '🏋️' },
            { id: 'gym-fullbody', name: 'Full Body', icon: '🏋️' }
        ]});
    } else if (equipment === 'dumbbells') {
        options.unshift({ category: 'HOME WEIGHTS', items: [
            { id: 'home-upper', name: 'Upper Body', icon: '🏠' },
            { id: 'home-lower', name: 'Lower Body', icon: '🏠' },
            { id: 'home-fullbody', name: 'Full Body', icon: '🏠' },
            { id: 'home-arms', name: 'Arms', icon: '🏠' },
            { id: 'home-shoulders', name: 'Shoulders', icon: '🏠' }
        ]});
    } else if (equipment === 'bands') {
        options.unshift({ category: 'BANDS', items: [
            { id: 'bands-upper', name: 'Upper Body', icon: '🔗' },
            { id: 'bands-lower', name: 'Lower Body', icon: '🔗' },
            { id: 'bands-fullbody', name: 'Full Body', icon: '🔗' }
        ]});
    } else if (equipment === 'none' || equipment === 'bodyweight') {
        options.unshift({ category: 'BODYWEIGHT', items: [
            { id: 'bw-upper', name: 'Upper Body', icon: '🤸' },
            { id: 'bw-lower', name: 'Lower Body', icon: '🤸' },
            { id: 'bw-core', name: 'Core', icon: '🤸' },
            { id: 'bw-fullbody', name: 'Full Body', icon: '🤸' }
        ]});
    }

    return options;
}

// Show workout dropdown for selecting a workout for a specific day
function showWizardWorkoutDropdown(day, dayLabel, updateCallback) {
    // Remove any existing dropdown
    const existingDropdown = document.getElementById('wizard-workout-dropdown-overlay');
    if (existingDropdown) existingDropdown.remove();

    const workoutOptions = getWizardWorkoutOptions();

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'wizard-workout-dropdown-overlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.right = '0';
    overlay.style.bottom = '0';
    overlay.style.background = 'rgba(0,0,0,0.3)';
    overlay.style.zIndex = '13000';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';

    // Create dropdown container
    const dropdown = document.createElement('div');
    dropdown.style.background = '#fff';
    dropdown.style.borderRadius = '16px';
    dropdown.style.padding = '20px';
    dropdown.style.width = '90%';
    dropdown.style.maxWidth = '350px';
    dropdown.style.maxHeight = '70vh';
    dropdown.style.overflowY = 'auto';
    dropdown.style.boxShadow = '0 10px 40px rgba(0,0,0,0.2)';

    // Header
    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.style.alignItems = 'center';
    header.style.marginBottom = '15px';
    header.style.paddingBottom = '10px';
    header.style.borderBottom = '1px solid #eee';

    const headerTitle = document.createElement('h3');
    headerTitle.style.margin = '0';
    headerTitle.style.color = '#1a4d2e';
    headerTitle.style.fontSize = '18px';
    headerTitle.textContent = dayLabel;

    const closeBtn = document.createElement('span');
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.fontSize = '24px';
    closeBtn.style.color = '#999';
    closeBtn.innerHTML = '&times;';
    closeBtn.onclick = () => overlay.remove();

    header.appendChild(headerTitle);
    header.appendChild(closeBtn);
    dropdown.appendChild(header);

    // Workout options grouped by category
    workoutOptions.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.style.marginBottom = '15px';

        const categoryLabel = document.createElement('div');
        categoryLabel.style.fontSize = '11px';
        categoryLabel.style.fontWeight = '600';
        categoryLabel.style.color = '#999';
        categoryLabel.style.textTransform = 'uppercase';
        categoryLabel.style.marginBottom = '8px';
        categoryLabel.style.letterSpacing = '0.5px';
        categoryLabel.textContent = category.category;
        categoryDiv.appendChild(categoryLabel);

        category.items.forEach(item => {
            const option = document.createElement('div');
            option.style.display = 'flex';
            option.style.alignItems = 'center';
            option.style.padding = '10px 12px';
            option.style.marginBottom = '4px';
            option.style.borderRadius = '8px';
            option.style.cursor = 'pointer';
            option.style.transition = 'background 0.2s';

            // Highlight current selection
            if (wizardWorkoutCalendar[day] === item.id) {
                option.style.background = 'rgba(72, 134, 75, 0.15)';
                option.style.border = '2px solid #48864B';
            } else {
                option.style.background = '#f8f8f8';
                option.style.border = '2px solid transparent';
            }

            option.onmouseenter = () => {
                if (wizardWorkoutCalendar[day] !== item.id) {
                    option.style.background = 'rgba(72, 134, 75, 0.1)';
                }
            };
            option.onmouseleave = () => {
                if (wizardWorkoutCalendar[day] !== item.id) {
                    option.style.background = '#f8f8f8';
                }
            };

            const optIcon = document.createElement('span');
            optIcon.style.fontSize = '18px';
            optIcon.style.marginRight = '10px';
            optIcon.textContent = item.icon;

            const optName = document.createElement('span');
            optName.style.fontWeight = '500';
            optName.style.color = '#333';
            optName.textContent = item.name;

            option.appendChild(optIcon);
            option.appendChild(optName);

            // Checkmark for selected
            if (wizardWorkoutCalendar[day] === item.id) {
                const checkmark = document.createElement('span');
                checkmark.style.marginLeft = 'auto';
                checkmark.style.color = '#48864B';
                checkmark.style.fontWeight = 'bold';
                checkmark.innerHTML = '&#10003;';
                option.appendChild(checkmark);
            }

            option.onclick = () => {
                // Update calendar
                wizardWorkoutCalendar[day] = item.id;

                // Re-render the calendar preview
                if (updateCallback) updateCallback();

                // Close dropdown
                overlay.remove();
            };

            categoryDiv.appendChild(option);
        });

        dropdown.appendChild(categoryDiv);
    });

    overlay.appendChild(dropdown);

    // Close on overlay click
    overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
    };

    document.body.appendChild(overlay);
}

// ========== END WORKOUT CALENDAR FUNCTIONS ==========

async function finishOnboarding() {
    localStorage.setItem('onboardingComplete', 'true');
    localStorage.setItem('plantbased_onboarding_complete', 'true'); // Also set alternate key for consistency
    window._onboardingWizardPending = false;
    const wizardEl = document.getElementById('onboarding-wizard');
    if (wizardEl) {
        wizardEl.style.display = 'none';
        wizardEl.style.opacity = '';
        wizardEl.classList.remove('active');
    }

    // Skip weigh-in prompts on first day - user already entered weight in wizard step 2
    localStorage.setItem('lastWeighInPromptDate', new Date().toDateString());
    const weighInCard = document.getElementById('daily-weigh-in-card');
    if (weighInCard) weighInCard.style.display = 'none';

    // Grant 1200 starting coins to new accounts
    if (window.currentUser) {
        try {
            const userId = window.currentUser.id || window.currentUser.user_id;
            await supabase.rpc('credit_coins', {
                p_user_id: userId,
                p_amount: 1200,
                p_reason: 'Welcome bonus - starting coins'
            });
            console.log('✅ Granted 1200 starting coins');
            if (typeof showToast === 'function') {
                showToast('Welcome! You received 1,200 coins! 🪙', 'success');
            }
        } catch (e) {
            console.error('Failed to grant starting coins:', e);
        }
    }

    // Save character customization colors
    if (typeof saveWizardCharacterColors === 'function') {
        saveWizardCharacterColors();
    }

    // Apply character colors to the main dashboard model
    const mainModel = document.getElementById('tamagotchi-model');
    if (mainModel && window.applyCharacterColors) {
        setTimeout(() => {
            window.applyCharacterColors(mainModel, mainModel.getAttribute('src'));
        }, 500);
    }

    // Apply gender-specific UI changes NOW that gender is selected
    if (typeof applyGenderSpecificUI === 'function') {
        applyGenderSpecificUI();
    }

    // Re-render cycle status with correct gender
    if (typeof renderCycleStatus === 'function') {
        renderCycleStatus();
    }

    // Update daily content with gender-appropriate tips
    if (typeof initProgramDate === 'function') {
        initProgramDate();
    }

    // CRITICAL: Ensure cycle data is saved to database before completing onboarding
    // This fixes the issue where cycle data disappears after page refresh
    if (window.currentUser && userCycleData) {
        try {
            const userId = window.currentUser.id || window.currentUser.user_id;
            let existingFacts = {};
            try {
                existingFacts = await dbHelpers.userFacts.get(userId);
            } catch(err) { /* ignore not found */ }

            const currentAdditional = existingFacts?.additional_data || {};

            // Only save cycle data if we have valid data (lastPeriod or noPeriodMode)
            if (userCycleData.lastPeriod || userCycleData.noPeriodMode) {
                // Get cycle sync preferences from sessionStorage/localStorage
                const userProfile = JSON.parse(sessionStorage.getItem('userProfile') || localStorage.getItem('userProfile') || '{}');

                const dataToSave = {
                    additional_data: {
                        ...currentAdditional,
                        last_period_start: userCycleData.lastPeriod,
                        cycle_length: userCycleData.cycleLength || 28,
                        no_period_mode: userCycleData.noPeriodMode || false,
                        // Also save cycle sync preferences here
                        cycle_sync_preference: userProfile.cycle_sync_preference,
                        period_energy_response: userProfile.period_energy_response
                    }
                };

                console.log('💾 finishOnboarding: Ensuring cycle data is saved to database:', dataToSave);
                await dbHelpers.userFacts.upsert(userId, dataToSave);
                console.log('✅ finishOnboarding: Cycle data saved to database successfully');

                // Also ensure localStorage is in sync
                localStorage.setItem('userCycleData', JSON.stringify(userCycleData));
            }
        } catch (e) {
            console.error('❌ finishOnboarding: Failed to save cycle data to database:', e);
        }
    }

    // Sync quiz data to database
    await syncQuizDataToDb();

    // Mark onboarding complete in the database so it persists across browsers/sessions
    if (window.currentUser) {
        try {
            await dbHelpers.users.update(window.currentUser.id, { onboarding_complete: true });
            console.log("Onboarding marked complete in database");
        } catch (e) {
            console.warn("Failed to mark onboarding complete in database:", e);
        }
    }

    // Auto-add Coach Shannon as a friend for all new users
    if (window.currentUser) {
        const coachEmails = ['shannon@plantbased-balance.org', 'shannonbirch@cocospersonaltraining.com'];
        const userId = window.currentUser.id || window.currentUser.user_id;

        for (const coachEmail of coachEmails) {
            try {
                // Look up coach user by email
                const { data: coachUser } = await supabase
                    .from('users')
                    .select('id')
                    .eq('email', coachEmail)
                    .maybeSingle();

                if (coachUser && coachUser.id !== userId) {
                    // Check if already friends (avoid duplicate insert)
                    const { data: existing } = await supabase
                        .from('friendships')
                        .select('id')
                        .or(`and(user_id.eq.${coachUser.id},friend_id.eq.${userId}),and(user_id.eq.${userId},friend_id.eq.${coachUser.id})`)
                        .maybeSingle();

                    if (!existing) {
                        await supabase
                            .from('friendships')
                            .insert([{
                                user_id: coachUser.id,
                                friend_id: userId,
                                status: 'accepted'
                            }]);
                        console.log('Auto-added Coach Shannon (' + coachEmail + ') as friend!');
                    }
                }
            } catch (e) {
                console.warn('Could not auto-add coach (' + coachEmail + ') as friend:', e);
            }
        }

        // Send welcome message from coach to new user
        try {
            const profile = await window.getUserProfile();
            const userName = profile?.name || '';
            await fetch('/.netlify/functions/send-welcome-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    newUserId: userId,
                    userName: userName
                })
            });
            console.log('Welcome message sent to new user');
        } catch (e) {
            console.warn('Could not send welcome message:', e);
        }
    }

}

async function closeWizardManually() {
     window._onboardingWizardPending = false;
     const wizardEl = document.getElementById('onboarding-wizard');
     if (wizardEl) {
         wizardEl.style.display = 'none';
         wizardEl.style.opacity = '';
         wizardEl.classList.remove('active');
     }
     localStorage.setItem('onboardingComplete', 'true');
     localStorage.setItem('plantbased_onboarding_complete', 'true'); // Also set alternate key for consistency

     // Sync any collected data (including gender) to database before closing
     await syncQuizDataToDb();

     // Still apply gender-specific UI if they selected a gender
     if (typeof applyGenderSpecificUI === 'function') {
         applyGenderSpecificUI();
     }

}

function toggleWizardPeriodInput() {
    const toggle = document.getElementById('wizard-wellness-toggle');
    const input = document.getElementById('wizard-period-date');
    if(toggle.checked) {
        input.disabled = true;
        input.style.opacity = '0.5';
        input.value = '';
    } else {
        input.disabled = false;
        input.style.opacity = '1';
    }
}

function togglePeriodEnergyQuestion() {
    const cycleSyncValue = document.querySelector('input[name="wizard-cycle-sync"]:checked')?.value;
    const periodEnergySection = document.getElementById('period-energy-section');

    if (cycleSyncValue === 'yes') {
        periodEnergySection.style.display = 'block';
    } else {
        periodEnergySection.style.display = 'none';
        // Clear selection if hiding
        document.querySelectorAll('input[name="wizard-period-energy"]').forEach(input => input.checked = false);
    }
}

function toggleCard(header) {
    // Toggle card expansion
    const card = header.parentElement;
    card.classList.toggle('open');
}

// --- TRAINERIZE WORKOUT LOGIC ---
// --- TRAINERIZE WORKOUT LOGIC ---
window.WORKOUT_DB = {
    'yoga': {
        name: 'Somatic Yoga',
        id: 'yoga',
        description: 'Release the Psoas (fight/flight muscle) and switch the nervous system from "Sympathetic" (Stress) to "Parasympathetic" (Rest).',
        estimatedTime: '25',
        equipment: ['Body Weight', 'Mat'],
        schedule: [
             // DAY 1: Cortisol & Psoas Release
             {
                title: 'Somatic Hormone Reset',
                exercises: [
                    { name: 'Adductor Stretch with Thoracic Twist', sets: 1, reps: '3 min', desc: 'Signals safety to the pelvic floor' },
                    { name: 'Cat to Cow', sets: 1, reps: '1 min', desc: 'Regulates the nervous system' },
                    { name: 'Yoga - Lizard Pose (Utthan Pristhasana)', sets: 2, reps: '90 sec/side', desc: 'Releases the Psoas (fight/flight muscle)' },
                    { name: 'Yoga - Happy Baby Pose (Ananda Balasana)', sets: 1, reps: '2 min', desc: 'True somatic reset' },
                    { name: 'Yoga - Supine Twist (Jathara Parivartanasana)', sets: 2, reps: '1 min/side', desc: 'Wrings tension from adrenals' },
                    { name: 'Corpse Pose', sets: 1, reps: '5 min', desc: 'Lowers cortisol' }
                ]
            },
            // DAY 2: Hip Opening & Grounding
            {
                title: 'Deep Hip Opening Flow',
                exercises: [
                    { name: "Child's Pose", sets: 1, reps: '2 min', desc: 'Grounding and centering' },
                    { name: 'Cat to Cow', sets: 1, reps: '1 min', desc: 'Spinal warm-up' },
                    { name: 'Yoga - Pigeon Pose (Eka Pada Rajakapotasana)', sets: 2, reps: '2 min/side', desc: 'Deep hip flexor release' },
                    { name: 'Yoga - Fire Log Pose (Agnistambhasana)', sets: 2, reps: '90 sec/side', desc: 'Hip opener' },
                    { name: 'Yoga - Reclined Bound Angle (Supta Baddha Konasana)', sets: 1, reps: '3 min', desc: 'Pelvic floor relaxation' },
                    { name: 'Yoga - Legs Up the Wall (Viparita Karani)', sets: 1, reps: '5 min', desc: 'Calms nervous system' }
                ]
            },
            // DAY 3: Spinal Flow & Twists
            {
                title: 'Spinal Mobility & Detox',
                exercises: [
                    { name: 'Cat to Cow', sets: 1, reps: '2 min', desc: 'Spinal lubrication' },
                    { name: 'Yoga - Thread the Needle', sets: 2, reps: '90 sec/side', desc: 'Shoulder and upper back release' },
                    { name: 'Yoga - Seated Spinal Twist (Ardha Matsyendrasana)', sets: 2, reps: '1 min/side', desc: 'Digestive massage' },
                    { name: 'Yoga - Supine Twist (Jathara Parivartanasana)', sets: 2, reps: '2 min/side', desc: 'Spinal detox' },
                    { name: 'Yoga - Child Pose with Side Stretch', sets: 2, reps: '1 min/side', desc: 'Lateral body opening' },
                    { name: 'Corpse Pose', sets: 1, reps: '5 min', desc: 'Integration' }
                ]
            },
            // DAY 4: Restorative & Gentle
            {
                title: 'Restorative Recovery',
                exercises: [
                    { name: 'Yoga - Supported Fish Pose (Matsyasana)', sets: 1, reps: '3 min', desc: 'Heart opener' },
                    { name: 'Yoga - Puppy Pose (Anahatasana)', sets: 1, reps: '2 min', desc: 'Calms heart rate' },
                    { name: "Child's Pose", sets: 1, reps: '3 min', desc: 'Deep rest' },
                    { name: 'Yoga - Reclined Bound Angle (Supta Baddha Konasana)', sets: 1, reps: '4 min', desc: 'Pelvic relaxation' },
                    { name: 'Yoga - Legs Up the Wall (Viparita Karani)', sets: 1, reps: '5 min', desc: 'Lymphatic drainage' },
                    { name: 'Corpse Pose', sets: 1, reps: '8 min', desc: 'Deep relaxation' }
                ]
            },
            // DAY 5: Gentle Strength & Balance
            {
                title: 'Balance & Core Flow',
                exercises: [
                    { name: 'Yoga - Sun Salutation A (Surya Namaskar A)', sets: 3, reps: '1 round', desc: 'Full body warm-up' },
                    { name: 'Yoga - Warrior II (Virabhadrasana II)', sets: 2, reps: '1 min/side', desc: 'Leg strength' },
                    { name: 'Yoga - Triangle Pose (Trikonasana)', sets: 2, reps: '1 min/side', desc: 'Stability' },
                    { name: 'Yoga - Tree Pose (Vrksasana)', sets: 2, reps: '1 min/side', desc: 'Balance practice' },
                    { name: 'Yoga - Boat Pose (Navasana)', sets: 3, reps: '30 sec', desc: 'Core activation' },
                    { name: 'Yoga - Seated Forward Fold (Paschimottanasana)', sets: 1, reps: '3 min', desc: 'Hamstring stretch' },
                    { name: 'Corpse Pose', sets: 1, reps: '5 min', desc: 'Rest' }
                ]
            },
            // DAY 6: Full Vinyasa Flow
            {
                title: 'Dynamic Flow Integration',
                exercises: [
                    { name: 'Cat to Cow', sets: 1, reps: '2 min', desc: 'Warm-up' },
                    { name: 'Yoga - Sun Salutation A (Surya Namaskar A)', sets: 3, reps: '1 round', desc: 'Energy building' },
                    { name: 'Yoga - Sun Salutation B (Surya Namaskar B)', sets: 3, reps: '1 round', desc: 'Full body activation' },
                    { name: 'Yoga - Warrior I (Virabhadrasana I)', sets: 2, reps: '1 min/side', desc: 'Power pose' },
                    { name: 'Yoga - Extended Side Angle Pose (Utthita Parsvakonasana)', sets: 2, reps: '1 min/side', desc: 'Side body strength' },
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '2 min', desc: 'Full body stretch' },
                    { name: 'Yoga - Pigeon Pose (Eka Pada Rajakapotasana)', sets: 2, reps: '2 min/side', desc: 'Hip release' },
                    { name: 'Corpse Pose', sets: 1, reps: '7 min', desc: 'Deep rest' }
                ]
            },
            // DAY 7: Deep Rest & Meditation
            {
                title: 'Yin & Meditation',
                exercises: [
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Surrender and release' },
                    { name: 'Yoga - Reclined Bound Angle (Supta Baddha Konasana)', sets: 1, reps: '5 min', desc: 'Hip opening' },
                    { name: 'Yoga - Supine Twist (Jathara Parivartanasana)', sets: 2, reps: '3 min/side', desc: 'Spinal release' },
                    { name: 'Yoga - Legs Up the Wall (Viparita Karani)', sets: 1, reps: '7 min', desc: 'Restorative inversion' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Complete relaxation and meditation' }
                ]
            }
        ]
    },
    'bodyweight': {
        name: 'Bodyweight Sculpt',
        id: 'bodyweight',
        description: 'Build strength and tone without any equipment. Perfect for home workouts.',
        estimatedTime: '35',
        equipment: ['None'],
        schedule: [
            // DAY 1: Lower Body Push & Squat Patterns
            {
                title: 'Lower Body Power',
                exercises: [
                    { name: 'Body Weight Squat', sets: 4, reps: '15-20', desc: 'Quad and glute activation' },
                    { name: 'Body Weight Reverse Lunge', sets: 3, reps: '12/leg', desc: 'Single leg strength' },
                    { name: 'Glute Bridge', sets: 4, reps: '20', desc: 'Glute isolation' },
                    { name: 'Body Weight Single Leg Deadlift', sets: 3, reps: '10/leg', desc: 'Hamstring and balance' },
                    { name: 'Body Weight Sumo Squat', sets: 3, reps: '15', desc: 'Inner thigh and glutes' },
                    { name: 'Wall Sit', sets: 3, reps: '45 sec', desc: 'Quad endurance' }
                ]
            },
            // DAY 2: Upper Body Push
            {
                title: 'Upper Body Strength',
                exercises: [
                    { name: 'Push Up', sets: 4, reps: '10-15', desc: 'Chest, shoulders, triceps' },
                    { name: 'Pike Push Up', sets: 3, reps: '8-12', desc: 'Shoulder focus' },
                    { name: 'Tricep Dip', sets: 3, reps: '12-15', desc: 'Tricep isolation' },
                    { name: 'Plank to Down Dog', sets: 3, reps: '10', desc: 'Dynamic upper body' },
                    { name: 'Diamond Push Up', sets: 3, reps: '8-10', desc: 'Tricep emphasis' },
                    { name: 'Plank Hold', sets: 3, reps: '45 sec', desc: 'Core stability' }
                ]
            },
            // DAY 3: Core & Conditioning
            {
                title: 'Core & Cardio Blast',
                exercises: [
                    { name: 'Mountain Climber', sets: 4, reps: '30 sec', desc: 'Cardio and core' },
                    { name: 'Bicycle Crunch', sets: 3, reps: '20', desc: 'Obliques' },
                    { name: 'Burpee', sets: 3, reps: '10-15', desc: 'Full body conditioning' },
                    { name: 'Plank Hip Twist', sets: 3, reps: '15/side', desc: 'Rotational core' },
                    { name: 'High Knees', sets: 4, reps: '30 sec', desc: 'Cardio burst' },
                    { name: 'Dead Bug', sets: 3, reps: '12/side', desc: 'Core control' }
                ]
            },
            // DAY 4: Full Body Power
            {
                title: 'Total Body Strength',
                exercises: [
                    { name: 'Body Weight Squat Jump', sets: 3, reps: '12', desc: 'Explosive lower body' },
                    { name: 'Push Up', sets: 3, reps: '12-15', desc: 'Upper body push' },
                    { name: 'Body Weight Reverse Lunge', sets: 3, reps: '12/leg', desc: 'Lower body unilateral' },
                    { name: 'Superman', sets: 3, reps: '15', desc: 'Posterior chain' },
                    { name: 'Plank Alternating Arm & Leg Lift', sets: 3, reps: '10/side', desc: 'Anti-rotation' },
                    { name: 'Glute Bridge', sets: 3, reps: '20', desc: 'Glute activation' }
                ]
            },
            // DAY 5: Glutes & Legs Focus
            {
                title: 'Glute Sculpt',
                exercises: [
                    { name: 'Single Leg Glute Bridge', sets: 3, reps: '15/leg', desc: 'Glute isolation' },
                    { name: 'Body Weight Side Lunge', sets: 3, reps: '12/side', desc: 'Lateral movement' },
                    { name: 'Fire Hydrant', sets: 3, reps: '15/side', desc: 'Glute medius' },
                    { name: 'Donkey Kick', sets: 3, reps: '15/leg', desc: 'Glute max activation' },
                    { name: 'Body Weight Sumo Squat', sets: 4, reps: '20', desc: 'Inner thigh and glutes' },
                    { name: 'Calf Raise', sets: 3, reps: '20', desc: 'Calf definition' }
                ]
            },
            // DAY 6: Active Recovery & Mobility
            {
                title: 'Mobility & Flow',
                exercises: [
                    { name: 'Downward Dog', sets: 1, reps: '2 min', desc: 'Full body stretch' },
                    { name: 'Cat to Cow', sets: 1, reps: '2 min', desc: 'Spinal mobility' },
                    { name: 'World Greatest Stretch', sets: 2, reps: '5/side', desc: 'Full body mobility' },
                    { name: 'Bird Dog', sets: 3, reps: '12/side', desc: 'Core stability' },
                    { name: "Child's Pose", sets: 1, reps: '3 min', desc: 'Recovery' },
                    { name: 'Body Weight Squat', sets: 2, reps: '15', desc: 'Active recovery' }
                ]
            },
            // DAY 7: Rest or Gentle Movement
            {
                title: 'Rest Day',
                exercises: [
                    { name: 'Downward Dog', sets: 1, reps: '3 min', desc: 'Gentle stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Rest and restore' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Complete relaxation' }
                ]
            }
        ]
    },
    'home': {
        name: 'Dumbbell Strength',
        id: 'home',
        description: 'Build lean muscle mass at home with dumbbells. Progressive strength training.',
        estimatedTime: '45',
        equipment: ['Dumbbells', 'Mat'],
        schedule: [
            // DAY 1: Lower Body (Quads & Hamstrings)
            {
                title: 'Lower Body Strength',
                exercises: [
                    { name: 'Dumbbell Goblet Squat', sets: 4, reps: '12-15', desc: 'Quad dominant compound' },
                    { name: 'Dumbbell Romanian Deadlift', sets: 4, reps: '12', desc: 'Hamstring and glutes' },
                    { name: 'Dumbbell Stationary Lunge', sets: 3, reps: '12/leg', desc: 'Unilateral strength' },
                    { name: 'Dumbbell Single Leg Deadlift', sets: 3, reps: '10/leg', desc: 'Hamstring and balance' },
                    { name: 'Dumbbell Goblet Lateral Lunge', sets: 3, reps: '10/side', desc: 'Adductors and glutes' },
                    { name: 'Dumbbell Calf Raise', sets: 3, reps: '15-20', desc: 'Calf development' }
                ]
            },
            // DAY 2: Upper Body Push (Chest, Shoulders, Triceps)
            {
                title: 'Push Day',
                exercises: [
                    { name: 'Dumbbell Bench Press', sets: 4, reps: '10-12', desc: 'Chest compound' },
                    { name: 'Dumbbell Standing Shoulder Press', sets: 4, reps: '10-12', desc: 'Shoulder strength' },
                    { name: 'Dumbbell Incline Chest Press', sets: 3, reps: '12', desc: 'Upper chest' },
                    { name: 'Dumbbell Lateral Raise', sets: 3, reps: '12-15', desc: 'Shoulder width' },
                    { name: 'Dumbbell Overhead Tricep Extension', sets: 3, reps: '12-15', desc: 'Tricep mass' },
                    { name: 'Dumbbell Front Raise', sets: 3, reps: '12', desc: 'Anterior deltoid' }
                ]
            },
            // DAY 3: Core & Conditioning
            {
                title: 'Core Power',
                exercises: [
                    { name: 'Dumbbell Russian Twist', sets: 3, reps: '20 total', desc: 'Obliques' },
                    { name: 'Dumbbell Woodchop', sets: 3, reps: '12/side', desc: 'Rotational power' },
                    { name: 'Plank Hold', sets: 3, reps: '60 sec', desc: 'Core stability' },
                    { name: 'Dumbbell Side Bend', sets: 3, reps: '15/side', desc: 'Oblique strength' },
                    { name: 'Mountain Climber', sets: 3, reps: '30 sec', desc: 'Conditioning' },
                    { name: 'Dead Bug', sets: 3, reps: '12/side', desc: 'Anti-extension core' }
                ]
            },
            // DAY 4: Full Body Compound
            {
                title: 'Total Body Power',
                exercises: [
                    { name: 'Dumbbell Squat to Press', sets: 4, reps: '12', desc: 'Full body compound' },
                    { name: 'Dumbbell Deadlift', sets: 4, reps: '12', desc: 'Posterior chain' },
                    { name: 'Dumbbell Bent Over Row', sets: 3, reps: '12', desc: 'Back thickness' },
                    { name: 'Dumbbell Walking Lunge', sets: 3, reps: '10/leg', desc: 'Dynamic lower body' },
                    { name: 'Dumbbell Push Press', sets: 3, reps: '10-12', desc: 'Explosive shoulder' },
                    { name: 'Dumbbell Renegade Row', sets: 3, reps: '10/side', desc: 'Core and back' }
                ]
            },
            // DAY 5: Lower Body (Glutes & Hamstrings)
            {
                title: 'Glute & Hamstring Focus',
                exercises: [
                    { name: 'Dumbbell Sumo Deadlift', sets: 4, reps: '12', desc: 'Glute and inner thigh' },
                    { name: 'Dumbbell Bulgarian Split Squat', sets: 3, reps: '12/leg', desc: 'Glute dominant lunge' },
                    { name: 'Dumbbell Single Leg Deadlift', sets: 3, reps: '12/leg', desc: 'Hamstring and glutes' },
                    { name: 'Dumbbell Hip Thrust', sets: 4, reps: '15', desc: 'Glute isolation' },
                    { name: 'Dumbbell Goblet Sumo Squat', sets: 3, reps: '15', desc: 'Wide stance glutes' },
                    { name: 'Dumbbell Stiff Leg Deadlift', sets: 3, reps: '12', desc: 'Hamstring stretch-load' }
                ]
            },
            // DAY 6: Upper Body Pull (Back, Biceps, Rear Delts)
            {
                title: 'Pull Day',
                exercises: [
                    { name: 'Dumbbell Bent Over Row', sets: 4, reps: '12', desc: 'Back width and thickness' },
                    { name: 'Dumbbell Single Arm Bent Over Row', sets: 3, reps: '12/side', desc: 'Unilateral back' },
                    { name: 'Dumbbell Reverse Fly', sets: 3, reps: '12-15', desc: 'Rear deltoid' },
                    { name: 'Dumbbell Bicep Curl', sets: 3, reps: '12-15', desc: 'Bicep mass' },
                    { name: 'Dumbbell Hammer Curl', sets: 3, reps: '12-15', desc: 'Brachialis and forearms' },
                    { name: 'Dumbbell Shrug', sets: 3, reps: '15-20', desc: 'Trap development' }
                ]
            },
            // DAY 7: Active Recovery or Rest
            {
                title: 'Active Recovery',
                exercises: [
                    { name: 'Dumbbell Goblet Squat', sets: 2, reps: '15', desc: 'Light movement' },
                    { name: 'Dumbbell Romanian Deadlift', sets: 2, reps: '12', desc: 'Hamstring stretch' },
                    { name: 'Downward Dog', sets: 1, reps: '3 min', desc: 'Full body stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Rest' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Recovery' }
                ]
            }
        ]
    },
    'gym': {
        name: 'Full Gym Protocol',
        id: 'gym',
        description: 'Maximize strength and hormonal balance with full gym access. Traditional bodybuilding split.',
        estimatedTime: '60',
        equipment: ['Full Gym'],
        schedule: [
            // DAY 1: Legs (Quads Focus)
            {
                title: 'Leg Day - Quads',
                exercises: [
                    { name: 'Barbell Back Squat', sets: 4, reps: '8-10', desc: 'King of lower body' },
                    { name: 'Angled Machine Leg Press', sets: 4, reps: '12-15', desc: 'Quad mass' },
                    { name: 'Machine Seated Leg Extension', sets: 3, reps: '15', desc: 'Quad isolation' },
                    { name: 'Walking Barbell Lunge', sets: 3, reps: '12/leg', desc: 'Functional strength' },
                    { name: 'Machine Hack Squat', sets: 3, reps: '12', desc: 'Quad emphasis' },
                    { name: 'Seated Calf Raise Machine', sets: 4, reps: '15-20', desc: 'Calf development' }
                ]
            },
            // DAY 2: Chest & Triceps
            {
                title: 'Chest & Triceps',
                exercises: [
                    { name: 'Barbell Bench Press', sets: 4, reps: '8-10', desc: 'Chest compound' },
                    { name: 'Incline Dumbbell Bench Press', sets: 4, reps: '10-12', desc: 'Upper chest' },
                    { name: 'Machine Seated Parallel Grip Chest Press', sets: 3, reps: '12', desc: 'Chest isolation' },
                    { name: 'Cable Standing High To Low Fly', sets: 3, reps: '12-15', desc: 'Chest definition' },
                    { name: 'Cable Rope Tricep Extension', sets: 3, reps: '12-15', desc: 'Tricep mass' },
                    { name: 'Cable Standing Overhead Tricep Extension', sets: 3, reps: '12-15', desc: 'Long head tricep' },
                    { name: 'Tricep Dip', sets: 3, reps: '10-12', desc: 'Compound tricep' }
                ]
            },
            // DAY 3: Back & Biceps
            {
                title: 'Back & Biceps',
                exercises: [
                    { name: 'Barbell Bent Over Row', sets: 4, reps: '8-10', desc: 'Back thickness' },
                    { name: 'Wide Grip Lat Pulldown', sets: 4, reps: '10-12', desc: 'Lat width' },
                    { name: 'Cable Seated Row', sets: 3, reps: '12', desc: 'Mid-back' },
                    { name: 'Cable Single Arm Lateral Pulldown', sets: 3, reps: '12/side', desc: 'Unilateral lats' },
                    { name: 'Machine Back Extension', sets: 3, reps: '15', desc: 'Lower back' },
                    { name: 'Barbell Bicep Curl', sets: 3, reps: '10-12', desc: 'Bicep mass' },
                    { name: 'Cable Single Arm Bicep Curl', sets: 3, reps: '12/side', desc: 'Bicep peak' },
                    { name: 'Cable Hammer Curl', sets: 3, reps: '12-15', desc: 'Brachialis' }
                ]
            },
            // DAY 4: Legs (Glutes & Hamstrings)
            {
                title: 'Leg Day - Glutes & Hamstrings',
                exercises: [
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '10-12', desc: 'Hamstring and glutes' },
                    { name: 'Barbell Hip Thrust', sets: 4, reps: '12-15', desc: 'Glute isolation' },
                    { name: 'Machine Seated Leg Curl', sets: 4, reps: '12-15', desc: 'Hamstring isolation' },
                    { name: 'Cable Pull-Through', sets: 3, reps: '15', desc: 'Glute activation' },
                    { name: 'Machine Seated Hip Adduction', sets: 3, reps: '15', desc: 'Inner thigh' },
                    { name: 'Standing Calf Raise Machine', sets: 4, reps: '15-20', desc: 'Calf mass' }
                ]
            },
            // DAY 5: Shoulders & Abs
            {
                title: 'Shoulders & Core',
                exercises: [
                    { name: 'Barbell Overhead Shoulder Press', sets: 4, reps: '8-10', desc: 'Shoulder compound' },
                    { name: 'Machine Seated Parallel Grip Shoulder Press', sets: 3, reps: '12', desc: 'Shoulder mass' },
                    { name: 'Dumbbell Lateral Raise', sets: 4, reps: '12-15', desc: 'Lateral deltoid' },
                    { name: 'Cable Single Arm Lateral Raise', sets: 3, reps: '12/side', desc: 'Shoulder width' },
                    { name: 'Dumbbell Reverse Fly', sets: 3, reps: '12-15', desc: 'Rear deltoid' },
                    { name: 'Cable Rope Face Pull', sets: 3, reps: '15', desc: 'Rear delt and traps' },
                    { name: 'Cable Crunch', sets: 3, reps: '15-20', desc: 'Abs' },
                    { name: 'Cable Side Bend', sets: 3, reps: '15/side', desc: 'Obliques' }
                ]
            },
            // DAY 6: Full Body or Active Recovery
            {
                title: 'Full Body Metabolic',
                exercises: [
                    { name: 'Barbell Deadlift', sets: 3, reps: '8', desc: 'Full posterior chain' },
                    { name: 'Barbell Front Squat', sets: 3, reps: '10', desc: 'Quad emphasis' },
                    { name: 'Dumbbell Bench Press', sets: 3, reps: '12', desc: 'Chest' },
                    { name: 'Wide Grip Lat Pulldown', sets: 3, reps: '12', desc: 'Back width' },
                    { name: 'Cable Standing High To Low Fly', sets: 2, reps: '15', desc: 'Chest pump' },
                    { name: 'Cable Seated Row', sets: 2, reps: '15', desc: 'Back pump' }
                ]
            },
            // DAY 7: Rest
            {
                title: 'Rest & Recovery',
                exercises: [
                    { name: 'Downward Dog', sets: 1, reps: '5 min', desc: 'Full body stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Recovery' },
                    { name: 'Corpse Pose', sets: 1, reps: '15 min', desc: 'Complete rest' }
                ]
            }
        ]
    },
    'gym_split': {
        name: 'Male Gym Split',
        id: 'gym_split',
        description: 'Classic bodybuilding split for men with full gym access. Build strength and muscle with dedicated muscle group focus each day.',
        estimatedTime: '45',
        equipment: ['Barbell', 'Dumbbells', 'Cable', 'Machine'],
        schedule: [
            // DAY 1: CHEST
            {
                title: 'Chest Day',
                exercises: [
                    { name: 'Barbell Bench Press', sets: 4, reps: '8-10', desc: 'Chest compound' },
                    { name: 'Dumbbell Incline Bench Press', sets: 4, reps: '10-12', desc: 'Upper chest' },
                    { name: 'Dumbbell Flat Bench Fly', sets: 4, reps: '10-12', desc: 'Chest stretch' },
                    { name: 'Cable Standing High To Low Fly', sets: 4, reps: '12-15', desc: 'Lower chest' },
                    { name: 'Cable Rope Tricep Extension', sets: 4, reps: '12-15', desc: 'Tricep finisher' }
                ]
            },
            // DAY 2: LEGS
            {
                title: 'Leg Day',
                exercises: [
                    { name: 'Barbell Back Squat', sets: 4, reps: '8-10', desc: 'Quad compound' },
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '10-12', desc: 'Hamstrings' },
                    { name: 'Dumbbell Walking Lunge', sets: 4, reps: '10-12 each', desc: 'Unilateral' },
                    { name: 'Machine Seated Leg Curl', sets: 4, reps: '12-15', desc: 'Hamstring isolation' },
                    { name: 'Smith Machine Calf Raise', sets: 4, reps: '15-20', desc: 'Calf work' }
                ]
            },
            // DAY 3: BACK
            {
                title: 'Back Day',
                exercises: [
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '8-10', desc: 'Posterior chain' },
                    { name: 'Wide Grip Pull Up', sets: 4, reps: '8-10', desc: 'Lat width' },
                    { name: 'Cable Seated Rotational Row', sets: 4, reps: '10-12', desc: 'Mid-back' },
                    { name: 'Cable Rope Face Pull', sets: 4, reps: '12-15', desc: 'Rear delts' },
                    { name: 'Dumbbell Shrug', sets: 4, reps: '12-15', desc: 'Trap work' }
                ]
            },
            // DAY 4: SHOULDERS
            {
                title: 'Shoulder Day',
                exercises: [
                    { name: 'Barbell Overhead Press', sets: 4, reps: '8-10', desc: 'Shoulder compound' },
                    { name: 'Dumbbell Lateral Raise', sets: 4, reps: '12-15', desc: 'Side delts' },
                    { name: 'Cable Rope Face Pull', sets: 4, reps: '12-15', desc: 'Rear delts' },
                    { name: 'Dumbbell Front Raise', sets: 4, reps: '12-15', desc: 'Front delts' },
                    { name: 'Dumbbell Shrug', sets: 4, reps: '12-15', desc: 'Traps' }
                ]
            },
            // DAY 5: ARMS & CORE
            {
                title: 'Arms & Core',
                exercises: [
                    { name: 'Barbell Close Grip Bench Press', sets: 4, reps: '8-10', desc: 'Tricep compound' },
                    { name: 'Barbell Bicep Curl', sets: 4, reps: '10-12', desc: 'Bicep mass' },
                    { name: 'Cable Rope Tricep Extension', sets: 4, reps: '12-15', desc: 'Tricep isolation' },
                    { name: 'Cable Kneeling Crunch', sets: 4, reps: '12-15', desc: 'Abs' },
                    { name: 'Hanging Leg Raise', sets: 4, reps: '10-12', desc: 'Lower abs' }
                ]
            },
            // DAY 6: ACTIVE RECOVERY
            {
                title: 'Active Recovery',
                exercises: [
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '5 min', desc: 'Full body stretch' },
                    { name: 'Yoga - Pigeon Pose (Eka Pada Rajakapotasana)', sets: 2, reps: '2 min/side', desc: 'Hip mobility' },
                    { name: "Child's Pose", sets: 1, reps: '3 min', desc: 'Recovery' },
                    { name: 'Cat to Cow', sets: 1, reps: '3 min', desc: 'Spinal mobility' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Deep rest' }
                ]
            },
            // DAY 7: REST
            {
                title: 'Rest & Recovery',
                exercises: [
                    { name: 'Light Walk or Bike', sets: 1, reps: '20-30 min', desc: 'Active recovery cardio' },
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '5 min', desc: 'Stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Recovery' },
                    { name: 'Corpse Pose', sets: 1, reps: '15 min', desc: 'Complete rest' }
                ]
            }
        ]
    },
    'female_gym_split': {
        name: 'Female Gym Split',
        id: 'female_gym_split',
        description: 'Balanced training split for women with full gym access. Build strength with legs twice weekly, push/pull movements, and core focus.',
        estimatedTime: '45',
        equipment: ['Barbell', 'Dumbbells', 'Cable', 'Machine'],
        schedule: [
            // DAY 1: LEGS
            {
                title: 'Leg Day',
                exercises: [
                    { name: 'Barbell Back Squat', sets: 4, reps: '8-10', desc: 'Quad compound' },
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '10-12', desc: 'Hamstrings' },
                    { name: 'Dumbbell Walking Lunge', sets: 4, reps: '10-12 each', desc: 'Unilateral' },
                    { name: 'Machine Seated Leg Curl', sets: 4, reps: '12-15', desc: 'Hamstring isolation' },
                    { name: 'Smith Machine Calf Raise', sets: 4, reps: '15-20', desc: 'Calf work' }
                ]
            },
            // DAY 2: PUSH
            {
                title: 'Push Day',
                exercises: [
                    { name: 'Barbell Bench Press', sets: 4, reps: '8-10', desc: 'Chest compound' },
                    { name: 'Dumbbell Seated Shoulder Press', sets: 4, reps: '10-12', desc: 'Shoulder press' },
                    { name: 'Dumbbell Incline Bench Press', sets: 4, reps: '10-12', desc: 'Upper chest' },
                    { name: 'Dumbbell Lateral Raise', sets: 4, reps: '12-15', desc: 'Side delts' },
                    { name: 'Cable Rope Tricep Extension', sets: 4, reps: '12-15', desc: 'Tricep isolation' }
                ]
            },
            // DAY 3: ARMS & CORE
            {
                title: 'Arms & Core',
                exercises: [
                    { name: 'Barbell Close Grip Bench Press', sets: 4, reps: '8-10', desc: 'Tricep compound' },
                    { name: 'Barbell Bicep Curl', sets: 4, reps: '10-12', desc: 'Bicep mass' },
                    { name: 'Cable Rope Tricep Extension', sets: 4, reps: '12-15', desc: 'Tricep isolation' },
                    { name: 'Cable Kneeling Crunch', sets: 4, reps: '12-15', desc: 'Abs' },
                    { name: 'Hanging Leg Raise', sets: 4, reps: '10-12', desc: 'Lower abs' }
                ]
            },
            // DAY 4: LEGS
            {
                title: 'Leg Day',
                exercises: [
                    { name: 'Barbell Back Squat', sets: 4, reps: '8-10', desc: 'Quad compound' },
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '10-12', desc: 'Hamstrings' },
                    { name: 'Dumbbell Walking Lunge', sets: 4, reps: '10-12 each', desc: 'Unilateral' },
                    { name: 'Machine Seated Leg Curl', sets: 4, reps: '12-15', desc: 'Hamstring isolation' },
                    { name: 'Smith Machine Calf Raise', sets: 4, reps: '15-20', desc: 'Calf work' }
                ]
            },
            // DAY 5: PULL
            {
                title: 'Pull Day',
                exercises: [
                    { name: 'Barbell Romanian Deadlift', sets: 4, reps: '8-10', desc: 'Posterior chain' },
                    { name: 'Wide Grip Pull Up', sets: 4, reps: '8-10', desc: 'Lat width' },
                    { name: 'Cable Seated Rotational Row', sets: 4, reps: '10-12', desc: 'Back thickness' },
                    { name: 'Cable Rope Face Pull', sets: 4, reps: '12-15', desc: 'Rear delts' },
                    { name: 'Dumbbell Bicep Curl', sets: 4, reps: '12-15', desc: 'Bicep isolation' }
                ]
            },
            // DAY 6: ACTIVE RECOVERY
            {
                title: 'Active Recovery',
                exercises: [
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '5 min', desc: 'Full body stretch' },
                    { name: 'Yoga - Pigeon Pose (Eka Pada Rajakapotasana)', sets: 2, reps: '2 min/side', desc: 'Hip mobility' },
                    { name: "Child's Pose", sets: 1, reps: '3 min', desc: 'Recovery' },
                    { name: 'Cat to Cow', sets: 1, reps: '3 min', desc: 'Spinal mobility' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Deep rest' }
                ]
            },
            // DAY 7: REST
            {
                title: 'Rest & Recovery',
                exercises: [
                    { name: 'Light Walk or Bike', sets: 1, reps: '20-30 min', desc: 'Active recovery cardio' },
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '5 min', desc: 'Stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Recovery' },
                    { name: 'Corpse Pose', sets: 1, reps: '15 min', desc: 'Complete rest' }
                ]
            }
        ]
    },
    'bands': {
        name: 'Band Strength',
        id: 'bands',
        description: 'Build lean muscle and improve mobility using resistance bands. Perfect for home or travel.',
        estimatedTime: '35',
        equipment: ['Resistance Bands', 'Mat'],
        schedule: [
            // DAY 1: Lower Body
            {
                title: 'Lower Body Band Work',
                exercises: [
                    { name: 'Banded Squat', sets: 4, reps: '15-20', desc: 'Quad and glute activation with constant tension' },
                    { name: 'Banded Romanian Deadlift', sets: 4, reps: '12-15', desc: 'Hamstring and glute focus' },
                    { name: 'Banded Lateral Walk', sets: 3, reps: '15/side', desc: 'Glute medius activation' },
                    { name: 'Banded Glute Bridge', sets: 4, reps: '20', desc: 'Glute isolation with resistance' },
                    { name: 'Banded Clamshell', sets: 3, reps: '15/side', desc: 'Hip stability and glute activation' },
                    { name: 'Banded Standing Kickback', sets: 3, reps: '12/leg', desc: 'Glute max isolation' }
                ]
            },
            // DAY 2: Upper Body Push
            {
                title: 'Push & Press',
                exercises: [
                    { name: 'Banded Push Up', sets: 4, reps: '12-15', desc: 'Chest with added resistance' },
                    { name: 'Banded Overhead Press', sets: 4, reps: '12-15', desc: 'Shoulder strength' },
                    { name: 'Banded Chest Press', sets: 3, reps: '15', desc: 'Horizontal push' },
                    { name: 'Banded Lateral Raise', sets: 3, reps: '15', desc: 'Shoulder width' },
                    { name: 'Banded Tricep Extension', sets: 3, reps: '15', desc: 'Tricep isolation' },
                    { name: 'Banded Front Raise', sets: 3, reps: '12', desc: 'Anterior deltoid' }
                ]
            },
            // DAY 3: Core & Conditioning
            {
                title: 'Core & Cardio',
                exercises: [
                    { name: 'Banded Woodchop', sets: 3, reps: '12/side', desc: 'Rotational power' },
                    { name: 'Banded Dead Bug', sets: 3, reps: '10/side', desc: 'Core stability with resistance' },
                    { name: 'Banded Mountain Climber', sets: 3, reps: '30 sec', desc: 'Cardio and core' },
                    { name: 'Banded Pallof Press', sets: 3, reps: '12/side', desc: 'Anti-rotation core' },
                    { name: 'Plank with Band Row', sets: 3, reps: '10/side', desc: 'Core and back combo' },
                    { name: 'Banded Bicycle Crunch', sets: 3, reps: '20', desc: 'Obliques with resistance' }
                ]
            },
            // DAY 4: Full Body
            {
                title: 'Total Body Burn',
                exercises: [
                    { name: 'Banded Squat to Press', sets: 4, reps: '12', desc: 'Full body compound' },
                    { name: 'Banded Good Morning', sets: 3, reps: '12', desc: 'Posterior chain' },
                    { name: 'Banded Row', sets: 4, reps: '12-15', desc: 'Back thickness' },
                    { name: 'Banded Reverse Lunge', sets: 3, reps: '10/leg', desc: 'Single leg strength' },
                    { name: 'Banded Face Pull', sets: 3, reps: '15', desc: 'Rear delts and posture' },
                    { name: 'Banded Glute Bridge March', sets: 3, reps: '10/leg', desc: 'Glute and core' }
                ]
            },
            // DAY 5: Lower Body Glute Focus
            {
                title: 'Glute Sculpt',
                exercises: [
                    { name: 'Banded Sumo Squat', sets: 4, reps: '15', desc: 'Inner thigh and glutes' },
                    { name: 'Banded Hip Thrust', sets: 4, reps: '20', desc: 'Glute max builder' },
                    { name: 'Banded Fire Hydrant', sets: 3, reps: '15/side', desc: 'Glute medius' },
                    { name: 'Banded Donkey Kick', sets: 3, reps: '15/leg', desc: 'Glute isolation' },
                    { name: 'Banded Standing Abduction', sets: 3, reps: '15/side', desc: 'Outer glute' },
                    { name: 'Banded Frog Pump', sets: 3, reps: '20', desc: 'Glute activation finisher' }
                ]
            },
            // DAY 6: Upper Body Pull
            {
                title: 'Pull & Biceps',
                exercises: [
                    { name: 'Banded Bent Over Row', sets: 4, reps: '12-15', desc: 'Back compound' },
                    { name: 'Banded Single Arm Row', sets: 3, reps: '12/side', desc: 'Unilateral back' },
                    { name: 'Banded Face Pull', sets: 3, reps: '15', desc: 'Rear delts' },
                    { name: 'Banded Bicep Curl', sets: 3, reps: '15', desc: 'Bicep mass' },
                    { name: 'Banded Hammer Curl', sets: 3, reps: '12', desc: 'Brachialis' },
                    { name: 'Banded Reverse Fly', sets: 3, reps: '12-15', desc: 'Upper back and posture' }
                ]
            },
            // DAY 7: Active Recovery
            {
                title: 'Mobility & Stretch',
                exercises: [
                    { name: 'Banded Shoulder Dislocate', sets: 2, reps: '10', desc: 'Shoulder mobility' },
                    { name: 'Banded Pull Apart', sets: 2, reps: '15', desc: 'Upper back activation' },
                    { name: 'Yoga - Downward Dog', sets: 1, reps: '3 min', desc: 'Full body stretch' },
                    { name: "Child's Pose", sets: 1, reps: '5 min', desc: 'Recovery' },
                    { name: 'Corpse Pose', sets: 1, reps: '10 min', desc: 'Deep rest' }
                ]
            }
        ]
    }
};

// Check-in State
let selectedEnergy = null;
let selectedEquipment = null;

function openCheckInModal() {
    // Use the new check-in modal (with hyphen) instead of old one
    if (typeof applyGenderSpecificUI === 'function') {
        applyGenderSpecificUI();
    }
    document.getElementById('check-in-modal').style.display = 'flex';
}

function selectEnergy(level) {
    selectedEnergy = level;
    document.querySelectorAll('[id^="btn-energy-"]').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('btn-energy-' + level).classList.add('selected');
}

function selectEquipment(type) {
    selectedEquipment = type;
    document.querySelectorAll('[id^="btn-eq-"]').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('btn-eq-' + type).classList.add('selected');
}

async function submitCheckIn() {
    // DEPRECATED: This is the old check-in function - redirect to new submitDailyCycleSync
    if(!selectedEnergy || !selectedEquipment) {
        alert("Please select both energy level and equipment access.");
        return;
    }

    // Populate new checkInProgress object with old modal values
    if (typeof window.checkInProgress === 'undefined') {
        window.checkInProgress = { flow: null, symptoms: [], mood: null, energy: null, fluid: null, equipment: null, recovery: null };
    }
    window.checkInProgress.energy = selectedEnergy;
    window.checkInProgress.equipment = selectedEquipment;

    // Close old modal
    const oldModal = document.getElementById('checkin-modal');
    if (oldModal) oldModal.style.display = 'none';

    // Call new submit function which handles all persistence
    if (typeof submitDailyCycleSync === 'function') {
        await submitDailyCycleSync();
    } else {
        // Fallback if new function not available
        try {
            const user = window.currentUser;
            if (user) {
                const dateStr = new Date().toISOString().split('T')[0];
                await dbHelpers.checkins.upsert(user.id, dateStr, {
                    energy: selectedEnergy,
                    equipment: selectedEquipment
                });
                console.log('✅ Check-in saved to DB (legacy)');
            }
        } catch (e) {
            console.error('Failed to save check-in:', e);
            alert('Failed to save check-in. Please try again.');
            return;
        }
        renderMovementView();
    }
}

// Cycle Tracking Modal Functions
function openCycleTrackingModal() {
    // Populate modal with current data
    const modal = document.getElementById('cycle-tracking-modal');
    const periodDateInput = document.getElementById('cycle-modal-period-date');
    const cycleLengthInput = document.getElementById('cycle-modal-cycle-length');
    const wellnessToggle = document.getElementById('cycle-modal-wellness-toggle');

    // Load from userCycleData or hidden inputs
    if (userCycleData.lastPeriod) {
        periodDateInput.value = userCycleData.lastPeriod;
    }
    cycleLengthInput.value = userCycleData.cycleLength || 28;
    wellnessToggle.checked = userCycleData.noPeriodMode || false;

    // Show/hide period date input based on wellness mode
    const updatePeriodVisibility = () => {
        const periodContainer = periodDateInput.parentElement;
        periodContainer.style.display = wellnessToggle.checked ? 'none' : 'block';
    };

    wellnessToggle.onchange = updatePeriodVisibility;
    updatePeriodVisibility();

    // Show modal with proper animation (match onboarding wizard pattern)
    if(modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
        modal.style.opacity = '1';
    }
}

function closeCycleTrackingModal() {
    const modal = document.getElementById('cycle-tracking-modal');
    if(modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
        modal.style.opacity = '0';
    }
}

function saveCycleTrackingData() {
    const periodDateInput = document.getElementById('cycle-modal-period-date');
    const cycleLengthInput = document.getElementById('cycle-modal-cycle-length');
    const wellnessToggle = document.getElementById('cycle-modal-wellness-toggle');

    // Validate input
    if (!wellnessToggle.checked && !periodDateInput.value) {
        alert("Please enter your last period date or enable Wellness Mode.");
        return;
    }

    // Update userCycleData
    userCycleData.noPeriodMode = wellnessToggle.checked;
    userCycleData.lastPeriod = wellnessToggle.checked ? null : periodDateInput.value;
    userCycleData.cycleLength = parseInt(cycleLengthInput.value) || 28;

    // Sync to hidden inputs (for backward compatibility)
    document.getElementById('last-period-input-profile').value = periodDateInput.value || '';
    document.getElementById('cycle-length-input-profile').value = cycleLengthInput.value;
    document.getElementById('no-period-toggle-profile').checked = wellnessToggle.checked;

    // Save to storage using existing function
    updateCycleData();

    // Close modal
    closeCycleTrackingModal();

    // Show success message
    alert('Cycle tracking settings saved successfully!');
}

function getExerciseVideoUrl(name) {
    return EXERCISE_VIDEOS[name] || '';
}

async function renderMovementView() {
    const user = window.currentUser;
    if (!user) return;

    // Load active custom program (for calendar and movement integration)
    try {
        if (typeof dbHelpers !== 'undefined' && dbHelpers.customPrograms) {
            const activeProgram = await dbHelpers.customPrograms.getActive(user.id);
            window.activeCustomProgramCache = activeProgram;
            if (activeProgram) {
                console.log('🏋️ Active custom program loaded:', activeProgram.program_name);
            }
        }
    } catch (err) {
        console.error('Failed to load active custom program:', err);
        window.activeCustomProgramCache = null;
    }

    // 1. Get Date Index & Profile
    let dbProfile = await window.getUserProfile();

    // CRITICAL FIX: Also fetch quiz results for equipment_access (stored in quiz_results table, not users)
    // This mirrors the logic in renderDashboard() which correctly loads equipment_access
    try {
        if (window.currentUser?.id && typeof dbHelpers !== 'undefined') {
            const quizResult = await dbHelpers.quizResults.getLatest(window.currentUser.id);
            if (quizResult) {
                dbProfile = { ...dbProfile, ...quizResult };

                // Sync equipment_access to localStorage so it persists across page loads
                if (quizResult.equipment_access) {
                    const localProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                    if (!localProfile.equipment_access || localProfile.equipment_access !== quizResult.equipment_access) {
                        localProfile.equipment_access = quizResult.equipment_access;
                        localStorage.setItem('userProfile', JSON.stringify(localProfile));
                        console.log('✅ Equipment access synced from DB to localStorage:', quizResult.equipment_access);
                    }
                }
            }
        }
    } catch (e) {
        console.warn("Quiz results fetching error in loadMovementView:", e);
    }

    const startDate = dbProfile?.program_start_date;

    let dayIndex = 0;
    if (startDate) {
        const start = new Date(startDate);
        const now = new Date();
        const diffTime = Math.abs(now - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const currentDay = diffDays || 1;
        dayIndex = (currentDay - 1) % 7;

        // Update header date
        const dateEl = document.getElementById('movement-today-date');
        if(dateEl) dateEl.innerText = `Day ${currentDay}`;
    }

    // 2. Get Check-in
    const dateStr = new Date().toISOString().split('T')[0];
    const checkin = await dbHelpers.checkins.get(user.id, dateStr);

    // 3. Calculate Cycle Phase
    let phaseKey = 'wellness';
    let cyclePhaseInfo = null;
    let currentCycleDay = 0;

    if (userCycleData.lastPeriod && !userCycleData.noPeriodMode) {
        const start = new Date(userCycleData.lastPeriod);
        const now = new Date();
        const msPerDay = 24 * 60 * 60 * 1000;
        const daysSinceStart = Math.floor((now - start) / msPerDay);
        currentCycleDay = (daysSinceStart % userCycleData.cycleLength) + 1;
        if (currentCycleDay < 1) currentCycleDay = 1;

        phaseKey = getCyclePhase(currentCycleDay, userCycleData.cycleLength);
        cyclePhaseInfo = PHASE_INFO[phaseKey];
    }

    // === PRIORITY-BASED WORKOUT SELECTION ===
    // Priority 1: Quiz/Profile Equipment (highest) - What equipment do they have access to?
    // Priority 2: WORKOUT_DB Schedules - Use actual pre-built workouts
    // Priority 3: Daily Check-in - Energy, mood, symptoms
    // Priority 4: Cycle Phase (lowest) - Adjust based on menstrual phase

    // BUGFIX: Load profile from localStorage (same as calendar), fallback to sessionStorage
    // This ensures consistency with renderWeeklyCalendar which correctly shows gym split workouts
    let profile = {};
    try { profile = JSON.parse(localStorage.getItem('userProfile') || '{}'); } catch(e) {}

    // If equipment_access is missing in localStorage, check sessionStorage (from quiz)
    if (!profile.equipment_access) {
        let sessionProfile = {};
        try { sessionProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}
        if (sessionProfile.equipment_access) {
            profile.equipment_access = sessionProfile.equipment_access;
            // Save to localStorage for future use
            localStorage.setItem('userProfile', JSON.stringify(profile));
        }
    }

    // Merge with database profile for other fields like program_start_date
    profile = { ...dbProfile, ...profile };

    // PRIORITY 0.5: Smart equipment override - most recent selection wins (check-in vs onboarding)
    const todayDateStr = new Date().toISOString().split('T')[0];
    const todayCheckIn = userCycleData.logs?.[todayDateStr];
    const checkInTimestamp = todayCheckIn?.timestamp;
    const onboardingTimestamp = localStorage.getItem('onboardingCompletedAt');

    if (todayCheckIn?.equipment) {
        // Both timestamps exist - compare them
        if (checkInTimestamp && onboardingTimestamp) {
            const checkInTime = new Date(checkInTimestamp).getTime();
            const onboardingTime = new Date(onboardingTimestamp).getTime();

            if (checkInTime > onboardingTime) {
                // Check-in is more recent - use check-in equipment
                profile.equipment_access = todayCheckIn.equipment;
                console.log('📱 Movement view using today\'s check-in equipment (more recent):', profile.equipment_access);
            } else {
                // Onboarding is more recent - keep profile equipment
                console.log('📱 Movement view using onboarding equipment (more recent):', profile.equipment_access);
            }
        } else {
            // No onboarding timestamp - use check-in equipment (backward compatibility)
            profile.equipment_access = todayCheckIn.equipment;
            console.log('📱 Movement view using today\'s check-in equipment:', profile.equipment_access);
        }
    } else if (!todayCheckIn && userCycleData.logs) {
        // No check-in today - use last check-in data (don't reset to defaults)
        const dates = Object.keys(userCycleData.logs).sort().reverse();
        const lastCheckIn = dates.find(date => userCycleData.logs[date]?.equipment);
        if (lastCheckIn) {
            profile.equipment_access = userCycleData.logs[lastCheckIn].equipment;
            console.log('📱 Movement view using last check-in equipment from', lastCheckIn, ':', profile.equipment_access);
        }
    }

    // PRIORITY 1: Determine available programs based on quiz/profile equipment
    // Check if user has gym access from their profile
    // equipment_access is the source of truth; gym_access is legacy fallback only if equipment_access is undefined
    const hasGymAccess = profile?.equipment_access === 'gym' || (profile?.equipment_access === undefined && profile?.gym_access === true);
    // Support both 'dumbbells' (new) and 'home' (legacy) values for backward compatibility
    const hasDumbbells = profile?.equipment_access === 'dumbbells' || profile?.equipment_access === 'home' || hasGymAccess;
    // Check for resistance bands only
    const hasBands = profile?.equipment_access === 'bands';
    // Check for yoga only preference
    const hasYogaOnly = profile?.equipment_access === 'yoga_only';

    // Default available programs based on equipment
    // IMPORTANT: Users should only get workouts matching their equipment
    // yoga_only: only yoga, bands: yoga + bands, dumbbells+: includes bodyweight as fallback
    let availablePrograms = ['yoga']; // Yoga always available
    if (hasYogaOnly) {
        // Yoga only - no other programs
    } else if (hasBands && !hasDumbbells && !hasGymAccess) {
        // Bands only - add bands but NOT bodyweight
        availablePrograms.push('bands');
    } else {
        // Has dumbbells or gym - bodyweight is acceptable fallback
        availablePrograms.push('bodyweight');
        if (hasDumbbells) availablePrograms.push('home');
        if (hasGymAccess) availablePrograms.push('gym');
    }

    // PRIORITY 2: Weekly Schedule using WORKOUT_DB
    const today = new Date();
    const dayOfWeek = today.getDay();
    const calDayIndex = (dayOfWeek + 6) % 7; // Mon=0 index

    // Check if user qualifies for Gym Split (same logic as calendar for consistency)
    // Note: isMale must be defined here before the gym_split checks
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    const hasHighEnergy = profile.energy_status === 'high';
    // Male and female gym splits now have IDENTICAL requirements: gym access only
    // Females can opt-in to cycle sync for automatic adjustments during menstrual phase
    const useMaleGymSplit = isMale && hasGymAccess;
    const useFemaleGymSplit = !isMale && hasGymAccess;

    // SIMPLIFIED: Direct equipment checks (same pattern as gym split - no defaultStrengthProgram complexity)
    const useYogaOnly = hasYogaOnly;
    const useHome = hasDumbbells && !hasGymAccess; // Has dumbbells but not full gym
    const useBands = hasBands && !hasDumbbells && !hasGymAccess; // Has bands only

    // DEBUG: Log equipment selection values
    console.log('🔍 Movement equipment check:', {
        equipment_access: profile?.equipment_access,
        hasYogaOnly,
        useYogaOnly,
        hasDumbbells,
        useHome,
        hasBands,
        useBands,
        hasGymAccess,
        useMaleGymSplit,
        useFemaleGymSplit
    });

    // Add gym_split programs to available programs if user qualifies
    if (useMaleGymSplit) availablePrograms.push('gym_split');
    if (useFemaleGymSplit) availablePrograms.push('female_gym_split');

    // Weekly Schedule - maps each day to a program and workout
    // Uses equipment settings from onboarding to set appropriate workouts
    // IMPORTANT: For hero personalization, subcategories are used to pull from WORKOUT_LIBRARY
    let WEEKLY_SCHEDULE;
    let usingCustomProgram = false;
    let customProgramInfo = null;

    // Check for active custom program first
    const activeCustomProgram = window.activeCustomProgramCache;
    if (activeCustomProgram && activeCustomProgram.is_active && activeCustomProgram.start_date) {
        // Check if program is still within its duration
        const today = new Date();
        const startDate = new Date(activeCustomProgram.start_date);
        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
        const weeksElapsed = Math.floor((today - startDate) / msPerWeek);
        const currentWeek = weeksElapsed + 1;

        if (currentWeek <= activeCustomProgram.duration_weeks) {
            // Use custom program schedule
            const schedule = activeCustomProgram.weekly_schedule || [];
            WEEKLY_SCHEDULE = schedule.map((item, idx) => {
                if (!item.workout || item.workout.type === 'rest') {
                    return { day: item.day, program: 'rest', dayIndex: idx, isRest: true, fallback: 'yoga', fallbackIdx: idx };
                }
                return {
                    day: item.day,
                    program: item.workout.category || 'custom',
                    dayIndex: idx,
                    subcategory: item.workout.subcategory || '',
                    muscleGroup: item.workout.subcategory || '',
                    customWorkout: item.workout,
                    fallback: 'yoga',
                    fallbackIdx: idx
                };
            });
            usingCustomProgram = true;
            customProgramInfo = {
                name: activeCustomProgram.program_name,
                currentWeek: currentWeek,
                totalWeeks: activeCustomProgram.duration_weeks
            };
            console.log('🏋️ Movement using custom program:', activeCustomProgram.program_name, `Week ${currentWeek}/${activeCustomProgram.duration_weeks}`);
        }
    }

    // Fall back to equipment-based schedule if no custom program
    if (!usingCustomProgram && useMaleGymSplit) {
        // Male Gym Split: Same as calendar - Chest, Back, Legs, Shoulders, Arms+Core, Active Recovery, Rest
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'gym_split', dayIndex: 0, muscleGroup: 'chest', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Tue', program: 'gym_split', dayIndex: 1, muscleGroup: 'legs', fallback: 'yoga', fallbackIdx: 2 },
            { day: 'Wed', program: 'gym_split', dayIndex: 2, muscleGroup: 'back', fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Thu', program: 'gym_split', dayIndex: 3, muscleGroup: 'shoulders', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Fri', program: 'gym_split', dayIndex: 4, muscleGroup: 'armscore', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'yin', fallback: 'yoga', fallbackIdx: 6 },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin', fallback: 'yoga', fallbackIdx: 6 }
        ];
    } else if (!usingCustomProgram && useFemaleGymSplit) {
        // Female Gym Split: Same as calendar - Legs, Push, Arms+Core, Legs, Pull, Active Recovery, Rest
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'female_gym_split', dayIndex: 0, muscleGroup: 'legs', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Tue', program: 'female_gym_split', dayIndex: 1, muscleGroup: 'push', fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Wed', program: 'female_gym_split', dayIndex: 2, muscleGroup: 'armscore', fallback: 'yoga', fallbackIdx: 2 },
            { day: 'Thu', program: 'female_gym_split', dayIndex: 3, muscleGroup: 'legs', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Fri', program: 'female_gym_split', dayIndex: 4, muscleGroup: 'pull', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power', fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin', fallback: 'yoga', fallbackIdx: 6 }
        ];
    } else if (!usingCustomProgram && useYogaOnly) {
        // Yoga Only - direct check like gym
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'yoga', dayIndex: 0, subcategory: 'power', fallback: 'yoga', fallbackIdx: 0 },
            { day: 'Tue', program: 'yoga', dayIndex: 1, subcategory: 'restorative', fallback: 'yoga', fallbackIdx: 1 },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'yin', fallback: 'yoga', fallbackIdx: 2 },
            { day: 'Thu', program: 'yoga', dayIndex: 3, subcategory: 'restorative', fallback: 'yoga', fallbackIdx: 3 },
            { day: 'Fri', program: 'yoga', dayIndex: 4, subcategory: 'power', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power', fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin', fallback: 'yoga', fallbackIdx: 6 }
        ];
    } else if (!usingCustomProgram && useHome) {
        // Home/Dumbbell Split - direct check like gym
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'home', dayIndex: 0, subcategory: 'lowerbody', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Tue', program: 'home', dayIndex: 1, subcategory: 'push', fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'restorative', fallback: 'yoga', fallbackIdx: 2 },
            { day: 'Thu', program: 'home', dayIndex: 3, subcategory: 'pull', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Fri', program: 'home', dayIndex: 4, subcategory: 'lowerbody', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power', fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin', fallback: 'yoga', fallbackIdx: 6 }
        ];
    } else if (!usingCustomProgram && useBands) {
        // Resistance Bands Split - direct check like gym
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'bands', dayIndex: 0, fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Tue', program: 'bands', dayIndex: 1, fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'restorative', fallback: 'yoga', fallbackIdx: 2 },
            { day: 'Thu', program: 'bands', dayIndex: 3, fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Fri', program: 'bands', dayIndex: 4, fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Sat', program: 'bands', dayIndex: 5, fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin', fallback: 'yoga', fallbackIdx: 6 }
        ];
    } else if (!usingCustomProgram) {
        // Bodyweight Split (fallback - no equipment)
        WEEKLY_SCHEDULE = [
            { day: 'Mon', program: 'bodyweight', dayIndex: 0, subcategory: 'lowerbody', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Tue', program: 'bodyweight', dayIndex: 1, subcategory: 'upperbody', fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Wed', program: 'yoga', dayIndex: 2, subcategory: 'restorative', fallback: 'yoga', fallbackIdx: 2 },
            { day: 'Thu', program: 'bodyweight', dayIndex: 3, subcategory: 'core', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Fri', program: 'bodyweight', dayIndex: 4, subcategory: 'lowerbody', fallback: 'yoga', fallbackIdx: 4 },
            { day: 'Sat', program: 'yoga', dayIndex: 5, subcategory: 'power', fallback: 'yoga', fallbackIdx: 5 },
            { day: 'Sun', program: 'yoga', dayIndex: 6, subcategory: 'yin', fallback: 'yoga', fallbackIdx: 6 }
        ];
    }

    const scheduleItem = WEEKLY_SCHEDULE[calDayIndex];
    let suggestedProgram = scheduleItem.program;
    let workoutDayIndex = scheduleItem.dayIndex;
    let personalizationReason = '';
    let hasWorkoutOverride = false;
    let overrideSubcategory = null; // Used to override scheduleItem.subcategory for energy-based upgrades

    // PRIORITY 0: Check for today's workout override (e.g., user accepted yoga recommendation or cycle sync)
    try {
        const override = JSON.parse(localStorage.getItem('todayWorkoutOverride') || 'null');
        if (override && override.date === dateStr && override.program) {
            suggestedProgram = override.program;
            workoutDayIndex = 3; // Restorative Recovery for yoga

            // Differentiate messaging based on override reason
            if (override.reason === 'cycle_sync_automatic') {
                personalizationReason = '✨ Cycle Sync: Automatic yoga during menstrual phase';
            } else if (override.reason === 'low_energy') {
                personalizationReason = isMale ? '💪 Daily Sync: Recovery session for low energy' : '✨ Cycle Sync: Restorative practice for low energy';
            } else {
                personalizationReason = isMale ? '💪 Daily Sync: Custom workout adjustment' : '✨ Cycle Sync: Custom workout adjustment';
            }

            hasWorkoutOverride = true;
        }
    } catch (e) { /* ignore parse errors */ }

    // PRIORITY 3: Daily Check-in adjustments (skip if override is active)
    // --- DAILY SYNC OVERRIDE (Local Log) ---
    // Use gender-appropriate messaging (isMale defined earlier for gym_split check)
    const syncLabel = isMale ? '💪 Daily Sync' : '✨ Cycle Sync';

    // Track if user explicitly selected equipment in today's check-in
    let userSelectedEquipmentToday = false;

    if (userCycleData.logs && userCycleData.logs[dateStr] && !hasWorkoutOverride) {
        const log = userCycleData.logs[dateStr];

        // Map Energy - only auto-apply if user hasn't already made a choice via popup
        if (log.energy === 'low' && !log.workoutOverride) {
             // Low energy is now handled by popup - this is fallback for older check-ins
             suggestedProgram = 'yoga';
             workoutDayIndex = 3;
             personalizationReason = isMale ? '💪 Daily Sync: Active recovery for low energy.' : '✨ Cycle Sync: Gentle flow for low energy.';
        }

        // Map Symptoms (Cramps/Back Pain -> Yin) - Skip cramps for males
        if (log.symptoms && !isMale && (log.symptoms.includes('cramps') || log.symptoms.includes('back_pain'))) {
             suggestedProgram = 'yoga';
             workoutDayIndex = 6; // Yin
             personalizationReason = '✨ Cycle Sync: Relief for your body.';
        }

        // Map muscle soreness for males
        if (log.symptoms && isMale && log.symptoms.includes('muscle_soreness')) {
             suggestedProgram = 'yoga';
             workoutDayIndex = 3; // Restorative
             personalizationReason = '💪 Daily Sync: Recovery session for sore muscles.';
        }

        // Map Mood
        if (log.mood === 'anxious' || log.mood === 'sad') {
             suggestedProgram = 'yoga';
             workoutDayIndex = 6;
             personalizationReason = `${syncLabel}: Calming practice for your mind.`;
        }

        // High Energy Bonus - check for menstrual only if female
        const skipMenstrualCheck = isMale || !cyclePhaseInfo?.name.includes('Menstrual');
        if (log.energy === 'high' && suggestedProgram === 'yoga' && skipMenstrualCheck) {
             // For yoga-only users, upgrade to power yoga instead of bodyweight
             if (useYogaOnly) {
                 suggestedProgram = 'yoga';
                 workoutDayIndex = 0; // Power Yoga (Full Body Power Flow)
                 overrideSubcategory = 'power'; // Override subcategory for WORKOUT_LIBRARY
                 personalizationReason = isMale ? '💪 Daily Sync: Power yoga for high energy!' : '✨ Cycle Sync: Power flow for high energy!';
             } else if (useBands) {
                 // For bands users, upgrade from yoga to bands (if they were on yoga day)
                 suggestedProgram = 'bands';
                 workoutDayIndex = 0;
                 personalizationReason = isMale ? '💪 Daily Sync: High energy - bands workout!' : '✨ Cycle Sync: Matching your high energy with bands!';
             } else {
                 suggestedProgram = 'bodyweight'; // Upgrade from Yoga
                 workoutDayIndex = 1; // Dynamic Flow
                 personalizationReason = isMale ? '💪 Daily Sync: Let\'s crush it with high energy!' : '✨ Cycle Sync: Matching your high energy!';
             }
        }

        // Recovery status for males
        if (isMale && log.recovery) {
            if (log.recovery === 'fresh') {
                // For yoga-only users, upgrade to power yoga instead of bodyweight
                if (useYogaOnly) {
                    suggestedProgram = 'yoga';
                    workoutDayIndex = 0; // Power Yoga
                    overrideSubcategory = 'power'; // Override subcategory for WORKOUT_LIBRARY
                    personalizationReason = '💪 Daily Sync: Power yoga - fully recovered!';
                } else if (useBands) {
                    // For bands users, keep their bands workout - don't override to bodyweight
                    // No change to suggestedProgram, just add motivation message
                    personalizationReason = '💪 Daily Sync: Fully recovered - let\'s crush this bands workout!';
                } else {
                    suggestedProgram = 'bodyweight';
                    workoutDayIndex = 1;
                    personalizationReason = '💪 Daily Sync: Fully recovered - time to push hard!';
                }
            } else if (log.recovery === 'tired') {
                suggestedProgram = 'yoga';
                workoutDayIndex = 3;
                personalizationReason = '💪 Daily Sync: Rest day for optimal recovery.';
            }
        }
    }
    // --- END SUPERBOOST ---

    // Get today's check-in symptoms (time-aware - only from recent check-ins)
    let todaySymptoms = [];
    if (checkin && checkin.additional_data && checkin.additional_data.symptoms) {
        todaySymptoms = checkin.additional_data.symptoms;
    } else if (userCycleData.logs && userCycleData.logs[dateStr] && userCycleData.logs[dateStr].symptoms) {
        todaySymptoms = userCycleData.logs[dateStr].symptoms;
    }

    // Symptoms override - BUT only if user hasn't explicitly selected equipment
    // EXCEPTION: If mood is 'strong' (High Energy), we ignore 'fatigue' and 'anxiety' overrides to allow rigorous exercise
    const isHighEnergy = userCycleData.mood === 'strong';

    if (todaySymptoms && todaySymptoms.length > 0) {
        // Hot flash is female-specific, skip for males
        if (!isMale && (todaySymptoms.includes('hot_flash') || todaySymptoms.includes('dizziness'))) {
            suggestedProgram = 'yoga';
            workoutDayIndex = 3; // Restorative Recovery
            personalizationReason = '✨ Cycle Sync: Gentle recovery for your symptoms today';
        } else if ((todaySymptoms.includes('fatigue') || todaySymptoms.includes('anxiety')) && !isHighEnergy) {
            suggestedProgram = 'yoga';
            workoutDayIndex = 6; // Yin & Meditation
            personalizationReason = `${syncLabel}: Restorative practice for how you feel today`;
        }
    } else if (userCycleData.mood === 'tired') {
        suggestedProgram = 'yoga';
        workoutDayIndex = 3; // Restorative Recovery
        personalizationReason = `${syncLabel}: Recovery & restoration for low energy`;
    }

    // HIGHEST PRIORITY: Explicit equipment selection from today's check-in overrides symptoms
    // Check both database checkin AND localStorage logs for equipment selection
    let equipmentFromCheckin = null;

    // First, try to get equipment from database check-in
    if (checkin && checkin.equipment) {
        equipmentFromCheckin = checkin.equipment;
    }
    // Fallback: check localStorage if database doesn't have it
    else if (userCycleData.logs && userCycleData.logs[dateStr] && userCycleData.logs[dateStr].equipment) {
        equipmentFromCheckin = userCycleData.logs[dateStr].equipment;
    }

    if (checkin || equipmentFromCheckin) {
        // If low energy, always suggest yoga (even overrides equipment choice)
        if (checkin && checkin.energy === 'low') {
            suggestedProgram = 'yoga';
            workoutDayIndex = 3; // Restorative Recovery
            personalizationReason = isMale ? '💪 Daily Sync: Active recovery for low energy' : '✨ Cycle Sync: Gentle movement for low energy today';
        }
        // Equipment override based on TODAY's explicit check-in choice
        // BUGFIX: Respect gym_split programs when user selects gym equipment in check-in
        else if (equipmentFromCheckin === 'gym' && (availablePrograms.includes('gym') || availablePrograms.includes('gym_split') || availablePrograms.includes('female_gym_split'))) {
            // Male users qualifying for gym_split should stay on gym_split schedule
            if (useMaleGymSplit && availablePrograms.includes('gym_split')) {
                suggestedProgram = 'gym_split';
                // Keep the original dayIndex from the gym_split schedule item
                workoutDayIndex = scheduleItem.dayIndex;
            }
            // Female users qualifying for female_gym_split should stay on female_gym_split schedule
            else if (useFemaleGymSplit && availablePrograms.includes('female_gym_split')) {
                suggestedProgram = 'female_gym_split';
                workoutDayIndex = scheduleItem.dayIndex;
            }
            // Fallback to regular gym program
            else {
                suggestedProgram = 'gym';
                workoutDayIndex = calDayIndex % 7;
            }
            userSelectedEquipmentToday = true;
            // Clear symptom-based personalization if user explicitly chose equipment
            if (personalizationReason.includes('symptoms') || personalizationReason.includes('Restorative')) {
                personalizationReason = '';
            }
        } else if (equipmentFromCheckin === 'dumbbells' && availablePrograms.includes('home')) {
            suggestedProgram = 'home';
            workoutDayIndex = calDayIndex % 7;
            userSelectedEquipmentToday = true;
            // Clear symptom-based personalization if user explicitly chose equipment
            if (personalizationReason.includes('symptoms') || personalizationReason.includes('Restorative')) {
                personalizationReason = '';
            }
        } else if (equipmentFromCheckin === 'bands' && availablePrograms.includes('bands')) {
            suggestedProgram = 'bands';
            workoutDayIndex = calDayIndex % 7;
            userSelectedEquipmentToday = true;
            // Clear symptom-based personalization if user explicitly chose equipment
            if (personalizationReason.includes('symptoms') || personalizationReason.includes('Restorative')) {
                personalizationReason = '';
            }
        } else if (equipmentFromCheckin === 'yoga_only' || equipmentFromCheckin === 'none') {
            suggestedProgram = 'yoga';
            // Use schedule-based yoga index if available, otherwise default to restorative
            workoutDayIndex = scheduleItem?.subcategory ? scheduleItem.dayIndex : 3;
            userSelectedEquipmentToday = true;
            // Don't clear personalization for yoga - it's a valid symptom response too
        }
    }

    // PRIORITY 4: Cycle Phase adjustments (automatic override handled at check-in)
    // This provides fallback messaging if user navigates directly to Movement tab
    if (!isMale && !personalizationReason && !userSelectedEquipmentToday && !hasWorkoutOverride && profile && cyclePhaseInfo && phaseKey !== 'wellness' && phaseKey !== 'performance') {
        const cycleSyncEnabled = profile.cycle_sync_preference === 'yes';
        const periodEnergyLow = profile.period_energy_response === 'low';

        // Only apply cycle-based recommendations if user opted in
        if (cycleSyncEnabled && periodEnergyLow) {
            // User opted in AND has low energy during period
            if (phaseKey === 'menstrual' && suggestedProgram !== 'yoga') {
                // Automatic cycle sync: switch to yoga AND show user it's synced to their cycle
                suggestedProgram = 'yoga';
                workoutDayIndex = 6; // Yin yoga - gentle for menstrual phase
                personalizationReason = `✨ Cycle Sync: Automatic yoga during menstrual phase`;
            }
        }
        // If user opted out or has high energy, we don't add cycle-based messaging at all
    }

    // For males, show performance-based recommendation if no other reason
    if (isMale && !personalizationReason) {
        personalizationReason = '💪 Daily Sync: Strength, HIIT, Progressive Overload';
    }
    
    // Ensure program is available based on equipment
    if (!availablePrograms.includes(suggestedProgram)) {
        suggestedProgram = scheduleItem.fallback;
        workoutDayIndex = scheduleItem.fallbackIdx;
    }

    // DEBUG: Log final program before hero rendering
    console.log('🎯 Movement final program:', {
        suggestedProgram,
        workoutDayIndex,
        availablePrograms,
        scheduleItem,
        overrideSubcategory
    });

    // Muscle group specific images for gym splits (male users)
    let isDbzTheme = false;
    try {
        const currentTheme = localStorage.getItem('userThemePreference') || localStorage.getItem('app_theme') || localStorage.getItem('theme') || 'default';
        isDbzTheme = currentTheme && currentTheme.startsWith('dbz-');
    } catch (e) { console.error('Error checking theme', e); }

    let muscleGroupImages = {
        'back': isDbzTheme ? '/assets/dbz_back_day.png' : '/assets/back.jpg',
        'chest': isDbzTheme ? '/assets/dbz_chest_day.png' : '/assets/chest.jpg',
        'legs': isDbzTheme ? '/assets/dbz_legs_day.png' : '/assets/legs.png',
        'arms': isDbzTheme ? '/assets/dbz_arms_day.png' : '/assets/arms.jpg',
        'shoulders': isDbzTheme ? '/assets/dbz_shoulders_day.png' : '/assets/shoulders.png',
        'core': isDbzTheme ? '/assets/dbz_core_day.png' : '/assets/core.jpg',
        'armscore': isDbzTheme ? '/assets/dbz_core_day.png' : '/assets/core.jpg',    // Arms & Core uses core image
        'push': isDbzTheme ? '/assets/dbz_chest_day.png' : '/assets/chest.jpg',      // Push uses chest image
        'pull': isDbzTheme ? '/assets/dbz_back_day.png' : '/assets/back.jpg',        // Pull uses back image
        'upper': isDbzTheme ? '/assets/dbz_arms_day.png' : '/assets/arms.jpg',       // Upper body uses arms
        'lower': isDbzTheme ? '/assets/dbz_legs_day.png' : '/assets/legs.png',       // Lower body uses legs
        'fullbody': isDbzTheme ? '/assets/dbz_core_day.png' : '/assets/core.jpg'     // Full body uses core
    };

    const assets = {
        'yoga': { img: '/assets/somatic_yoga_hero.png', sub: 'Recovery', color: '#F59E0B' },
        'bodyweight': { img: '/assets/bodyweight_sculpt_hero.png', sub: 'No Equipment', color: '#ec4899' },
        'bands': { img: '/assets/band_strength_hero.png', sub: 'Resistance Bands', color: '#06b6d4' },
        'home': { img: '/assets/dumbbell_strength_hero.png', sub: 'Dumbbells', color: '#8b5cf6' },
        'gym': { img: '/assets/full_gym_hero.png', sub: 'Gym Access', color: '#10b981' },
        'gym_split': { img: '/assets/full_gym_hero.png', sub: 'Gym Access', color: '#10b981' },
        'female_gym_split': { img: '/assets/full_gym_hero.png', sub: 'Gym Access', color: '#10b981' }
    };

    // Handle gym_split programs - pull from WORKOUT_LIBRARY with 48-week rotation (same as calendar)
    let heroProg, heroMeta, heroSched;
    let heroLibraryInfo = null; // Track library workout info for onclick handler
    const wasOverriddenToYoga = suggestedProgram === 'yoga' && scheduleItem.program !== 'yoga';

    if ((suggestedProgram === 'gym_split' || suggestedProgram === 'female_gym_split') && scheduleItem.muscleGroup && typeof WORKOUT_LIBRARY !== 'undefined') {
        // Get workout from WORKOUT_LIBRARY with same 48-week rotation as calendar
        const muscleGroup = scheduleItem.muscleGroup;
        const gymCategory = WORKOUT_LIBRARY['gym'];

        if (gymCategory && gymCategory.subcategories && gymCategory.subcategories[muscleGroup]) {
            // Calculate which week in 48-week cycle (same logic as calendar)
            let startDate = localStorage.getItem('gym_split_start_date');
            if (!startDate) {
                const dayOfWeek = today.getDay();
                const distToMon = (dayOfWeek + 6) % 7;
                const monday = new Date(today);
                monday.setDate(today.getDate() - distToMon);
                monday.setHours(0, 0, 0, 0);
                startDate = monday.toISOString().split('T')[0];
                localStorage.setItem('gym_split_start_date', startDate);
            }
            const start = new Date(startDate);
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeksElapsed = Math.floor((today - start) / msPerWeek);
            const currentWeek = (weeksElapsed % 48) + 1;

            const workouts = gymCategory.subcategories[muscleGroup].workouts;
            const programNumber = Math.floor((currentWeek - 1) / 4);
            const workoutIndex = programNumber % workouts.length;
            const workout = workouts[workoutIndex];

            // Create a pseudo-program object for rendering
            heroProg = {
                name: 'Gym Split',
                estimatedTime: workout?.estimatedTime || 45
            };
            // Use muscle-specific image for male users only (these are male photos)
            const muscleImg = isMale ? muscleGroupImages[muscleGroup] : null;
            heroMeta = {
                ...assets[suggestedProgram],
                img: muscleImg || assets[suggestedProgram].img
            };
            heroSched = {
                title: workout?.name || `${muscleGroup.charAt(0).toUpperCase() + muscleGroup.slice(1)} Day`,
                exercises: workout?.exercises || []
            };
        } else {
            // Fallback to gym program if muscle group not found
            heroProg = window.WORKOUT_DB['gym'];
            heroMeta = assets['gym'];
            heroSched = heroProg.schedule[workoutDayIndex % heroProg.schedule.length];
        }
    } else if ((scheduleItem.subcategory || overrideSubcategory) && !wasOverriddenToYoga && typeof WORKOUT_LIBRARY !== 'undefined') {
        // For yoga/bodyweight/home with subcategories, use WORKOUT_LIBRARY with rotation
        // Use overrideSubcategory if set (e.g., high energy upgrade to power yoga)
        const effectiveSubcategory = overrideSubcategory || scheduleItem.subcategory;
        const category = WORKOUT_LIBRARY[suggestedProgram];
        const subcategory = category?.subcategories?.[effectiveSubcategory];

        if (subcategory && subcategory.workouts && subcategory.workouts.length > 0) {
            // Calculate which week in rotation cycle
            let startDate = localStorage.getItem('program_start_date');
            if (!startDate) {
                const dayOfWeek = today.getDay();
                const distToMon = (dayOfWeek + 6) % 7;
                const monday = new Date(today);
                monday.setDate(today.getDate() - distToMon);
                monday.setHours(0, 0, 0, 0);
                startDate = monday.toISOString().split('T')[0];
            }
            const start = new Date(startDate);
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeksElapsed = Math.floor((today - start) / msPerWeek);
            const currentWeek = (weeksElapsed % 48) + 1;

            const workouts = subcategory.workouts;
            const programNumber = Math.floor((currentWeek - 1) / 4);
            const workoutIndex = programNumber % workouts.length;
            const workout = workouts[workoutIndex];

            // Create a pseudo-program object for rendering
            heroProg = {
                name: category.name,
                estimatedTime: workout?.duration?.replace(' min', '') || 25
            };
            heroMeta = assets[suggestedProgram];
            heroSched = {
                title: workout?.name || scheduleItem.day + ' Workout',
                exercises: workout?.exercises || []
            };
            // Store library info for onclick
            heroLibraryInfo = {
                category: suggestedProgram,
                subcategory: effectiveSubcategory,
                workoutId: workout?.id
            };
        } else {
            // Fallback to WORKOUT_DB
            heroProg = window.WORKOUT_DB[suggestedProgram];
            heroMeta = assets[suggestedProgram];
            heroSched = heroProg.schedule[workoutDayIndex % heroProg.schedule.length];
        }
    } else {
        // Standard program from WORKOUT_DB
        heroProg = window.WORKOUT_DB[suggestedProgram];
        heroMeta = assets[suggestedProgram];
        heroSched = heroProg.schedule[workoutDayIndex % heroProg.schedule.length];
    }

    // Check if this is a Cycle Sync personalization
    const isCycleSync = personalizationReason && personalizationReason.startsWith('✨ Cycle Sync:');
    const isDailySync = personalizationReason && personalizationReason.startsWith('💪 Daily Sync:');
    const badgeText = isCycleSync ? '⭐ Cycle Sync' : (isDailySync ? '💪 Daily Sync' : (personalizationReason ? '✨ Personalized' : 'Best for Today'));

    // Create onclick handler based on whether we're using library workout
    const heroOnclick = heroLibraryInfo
        ? `startLibraryWorkout('${heroLibraryInfo.category}', '${heroLibraryInfo.subcategory}', '${heroLibraryInfo.workoutId}')`
        : `startActiveWorkout('${suggestedProgram}', ${workoutDayIndex})`;

    // Hero card removed - Today's Workout will be added to the grid instead
    
    // Preload saved workouts cache for the Your Workouts view
    try {
        const savedWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
        window.savedWorkoutsCache = savedWorkouts;
    } catch(err) {
        console.error('Failed to preload saved workouts:', err);
    }

    const gridContainer = document.getElementById('movement-grid-container');
    gridContainer.innerHTML = '';

    // Add 'Workout Duel' Card - challenge a friend (top of grid, purple)
    const duelDiv = document.createElement('div');
    duelDiv.onclick = () => { window.location.href = '/workout-duel.html'; };
    duelDiv.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); background: linear-gradient(135deg, #7c3aed 0%, #6366f1 100%); grid-column: span 2;";
    duelDiv.innerHTML = `
        <div style="position: absolute; inset:0; background: linear-gradient(to bottom right, rgba(0,0,0,0.1), transparent);"></div>
        <div style="position: absolute; bottom: 15px; left: 15px; color: white; z-index: 1;">
            <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 5px;">Challenge Friends</div>
            <div style="font-size: 1.2rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px;">Workout Duel</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">Same workout, head-to-head, with video proof</div>
        </div>
        <div style="position: absolute; top: 15px; right: 15px; color: white; opacity: 0.4; font-size: 3rem;">⚔️</div>
        <div id="duel-badge" style="display:none; position:absolute; top:12px; left:12px; background:#ef4444; color:white; font-size:0.7rem; font-weight:800; padding:4px 10px; border-radius:12px; z-index:2;"></div>
    `;
    gridContainer.appendChild(duelDiv);

    // Load pending duel count badge asynchronously
    (async () => {
        try {
            const { data, error } = await window.supabaseClient.rpc('get_user_workout_duels', { p_user_id: user.id });
            if (!error && data) {
                const activeDuels = data.filter(d => ['pending', 'accepted', 'live', 'in_progress', 'proof_phase'].includes(d.status));
                const pendingInvites = data.filter(d => d.status === 'pending' && !d.is_challenger);
                const badge = document.getElementById('duel-badge');
                if (badge && activeDuels.length > 0) {
                    badge.textContent = pendingInvites.length > 0 ? `${pendingInvites.length} invite${pendingInvites.length > 1 ? 's' : ''}` : `${activeDuels.length} active`;
                    badge.style.display = 'block';
                    if (pendingInvites.length > 0) {
                        badge.style.animation = 'pulse 2s infinite';
                    }
                }
            }
        } catch(e) { /* silent - badge is enhancement only */ }
    })();

    // Add 'Today's Workout' Card as first item (red background)
    const todayDiv = document.createElement('div');
    todayDiv.onclick = () => { eval(heroOnclick); };
    todayDiv.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);";
    todayDiv.innerHTML = `
        <div style="position: absolute; inset:0; background: linear-gradient(to bottom right, rgba(0,0,0,0.1), transparent);"></div>
        <div style="position: absolute; bottom: 15px; left: 15px; color: white; z-index: 1;">
            <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 5px;">Today's Workout</div>
            <div style="font-size: 1.2rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px;">${heroSched.title}</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">${heroProg.estimatedTime} mins · ${heroSched.exercises.length} exercises</div>
        </div>
        <div style="position: absolute; top: 15px; right: 15px; color: white; opacity: 0.4; font-size: 3rem;">🏋️</div>
    `;
    gridContainer.appendChild(todayDiv);

    // Add 'Log Activity' Card (cardio, classes, sports)
    const logActivityDiv = document.createElement('div');
    logActivityDiv.onclick = () => openLogActivityForm();
    logActivityDiv.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);";
    logActivityDiv.innerHTML = `
        <div style="position: absolute; inset:0; background: linear-gradient(to bottom right, rgba(0,0,0,0.1), transparent);"></div>
        <div style="position: absolute; bottom: 15px; left: 15px; color: white; z-index: 1;">
            <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 5px;">Track</div>
            <div style="font-size: 1.2rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px;">Log Activity</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">Classes, sports & cardio</div>
        </div>
        <div style="position: absolute; top: 15px; right: 15px; color: white; opacity: 0.4; font-size: 3rem;">🏃</div>
    `;
    gridContainer.appendChild(logActivityDiv);

    // Add 'Build Custom' Card
    const buildDiv = document.createElement('div');
    buildDiv.onclick = () => openWorkoutBuilder();
    buildDiv.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); background: #f1f5f9; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; border: 2px dashed #cbd5e1;";
    buildDiv.innerHTML = `
        <div style="width:50px; height:50px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05);">
            <svg viewBox="0 0 24 24" style="width:24px; height:24px; fill:var(--primary);"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </div>
        <div style="font-weight:800; color:var(--text-main); font-size:1.1rem;">Build Custom</div>
        <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">Create your own flow</div>
    `;
    gridContainer.appendChild(buildDiv);

    // Add 'Browse Workout Library' Card as second item
    const libraryDiv = document.createElement('div');
    libraryDiv.onclick = () => openWorkoutLibrary();
    libraryDiv.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);";
    libraryDiv.innerHTML = `
        <div style="position: absolute; inset:0; background: linear-gradient(to bottom right, rgba(0,0,0,0.2), transparent);"></div>
        <div style="position: absolute; bottom: 15px; left: 15px; color: white; z-index: 1;">
            <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 5px;">Explore All</div>
            <div style="font-size: 1.2rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px;">Workout Library</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">100+ workouts to choose from</div>
        </div>
        <div style="position: absolute; top: 15px; right: 15px; color: white; opacity: 0.4; font-size: 3rem;">📚</div>
    `;
    gridContainer.appendChild(libraryDiv);

    // Add 'Your Workouts' Card - shows saved custom workouts
    const yourWorkoutsDiv = document.createElement('div');
    yourWorkoutsDiv.onclick = () => openYourWorkouts();
    const savedCount = window.savedWorkoutsCache?.length || 0;
    yourWorkoutsDiv.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); background: linear-gradient(135deg, var(--primary) 0%, #22c55e 100%);";
    yourWorkoutsDiv.innerHTML = `
        <div style="position: absolute; inset:0; background: linear-gradient(to bottom right, rgba(0,0,0,0.1), transparent);"></div>
        <div style="position: absolute; bottom: 15px; left: 15px; color: white; z-index: 1;">
            <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 5px;">Your Collection</div>
            <div style="font-size: 1.2rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px;">Your Workouts</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">${savedCount} saved workout${savedCount !== 1 ? 's' : ''}</div>
        </div>
        <div style="position: absolute; top: 15px; right: 15px; color: white; opacity: 0.4; font-size: 3rem;">💪</div>
    `;
    gridContainer.appendChild(yourWorkoutsDiv);

    // Add 'Your Progress' Card - links to progress tracking view
    const progressDiv = document.createElement('div');
    progressDiv.onclick = () => openProgressFromMovement();
    progressDiv.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%); grid-column: span 2;";
    progressDiv.innerHTML = `
        <div style="position: absolute; inset:0; background: linear-gradient(to bottom right, rgba(0,0,0,0.1), transparent);"></div>
        <div style="position: absolute; bottom: 15px; left: 15px; color: white; z-index: 1;">
            <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 5px;">Track Journey</div>
            <div style="font-size: 1.2rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px;">Your Progress</div>
            <div style="font-size: 0.75rem; opacity: 0.9;">PBs, history & achievements</div>
        </div>
        <div style="position: absolute; top: 15px; right: 15px; color: white; opacity: 0.4; font-size: 3rem;">📈</div>
    `;
    gridContainer.appendChild(progressDiv);

    // Load workout rating insights
    loadWorkoutInsights();

    // Removed - Workout Duel card moved to top of grid

    // Removed other workout cards - users now browse via Workout Library
    // Object.keys(WORKOUT_DB).forEach(key => {
    //     if (key === suggestedProgram) return;
    //     const prog = WORKOUT_DB[key];
    //     const meta = assets[key];
    //     const sched = prog.schedule[dayIndex % prog.schedule.length];

    //     const div = document.createElement('div');
    //     div.onclick = () => startActiveWorkout(key);
    //     div.style.cssText = "cursor:pointer; position:relative; height:180px; border-radius:24px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1);";
    //     div.innerHTML = `
    //         <img src="${meta.img}" style="width:100%; height:100%; object-fit: cover; position:absolute; inset:0;" onerror="this.src='https://placehold.co/300x200?text=${key}';">
    //         <div style="position: absolute; inset:0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);"></div>
    //         <div style="position: absolute; bottom: 15px; left: 15px; color: white;">
    //             <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.8;">${prog.name}</div>
    //             <div style="font-size: 1.2rem; font-weight: 800; line-height: 1.1;">${sched.title}</div>
    //         </div>
    //     `;
    //     gridContainer.appendChild(div);
    // });
}

function showWorkoutOverview(id) {
    const program = WORKOUT_DB[id];
    const startDate = localStorage.getItem('pbb_start_date');
    let dayIndex = 0;
    if (startDate) {
        const start = new Date(startDate);
        const dayDiff = Math.ceil(Math.abs(new Date() - start) / (1000 * 60 * 60 * 24));
        dayIndex = (dayDiff || 1) - 1;
    }
    const workout = program.schedule[dayIndex % program.schedule.length];

    document.getElementById('overview-title').innerText = workout.title;
    document.getElementById('overview-header-title').innerText = program.name;
    document.getElementById('overview-meta').innerText = `${program.estimatedTime} mins  ${workout.exercises.length} Exercises`;
    document.getElementById('overview-instructions').innerText = program.description || '';
    
    // Equipment
    const eqCont = document.getElementById('overview-equipment');
    eqCont.innerHTML = '';
    program.equipment.forEach(e => {
        eqCont.innerHTML += `<span style="background:#f1f5f9; padding:8px 15px; border-radius:50px; font-size:0.85rem; font-weight:600; color:var(--text-main);">${e}</span>`;
    });

    // Exercises
    const exList = document.getElementById('overview-exercise-list');
    exList.innerHTML = '';
    workout.exercises.forEach(ex => {
        exList.innerHTML += `
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                <div style="width:70px; height:70px; border-radius:12px; background:#f1f5f9; flex-shrink:0; overflow:hidden;">
                    <img src="https://placehold.co/100x100/png?text=Preview" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <div style="flex:1;">
                    <div style="font-weight:700; font-size:1.05rem;">${ex.name}</div>
                    <div style="color:var(--text-muted); font-size:0.85rem;">${ex.sets} sets x ${ex.reps}</div>
                </div>
            </div>
        `;
    });

    document.getElementById('btn-start-now').onclick = () => startActiveWorkout(id);

    // Show View
    hideAllAppViews();
    document.getElementById('view-workout-overview').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-overview', () => switchAppTab('movement-tab'));
}

function hideAllAppViews() {
    const views = ['view-dashboard', 'view-meals', 'movement-tab', 'group', 'view-friends', 'sleep', 'view-workout-success', 'view-profile', 'view-workout-overview', 'view-active-workout', 'view-coach-dashboard', 'view-workout-builder', 'view-program-builder', 'view-calendar', 'view-cycle', 'view-workout-list', 'view-workout-library', 'view-workout-subcategories', 'view-prebuilt-programs', 'view-progress', 'view-your-workouts', 'view-learning', 'view-log-activity', 'view-activity-success', 'view-user-profile'];
    views.forEach(v => {
        const el = document.getElementById(v);
        if(el) {
            el.style.display = 'none';
            el.classList.remove('active');
        }
    });
}

async function startActiveWorkout(id, forcedDayIndex = null) {
    const program = WORKOUT_DB[id];

    // Clear custom workout tracking (this is a program workout, not custom)
    window.currentCustomWorkoutId = null;

    // Get correct day schedule & Preload History
    const user = window.currentUser;
    let dayIndex = 0;
    let customizations = null;

    if (forcedDayIndex !== null) {
        dayIndex = forcedDayIndex;
    } else if (user) {
        // Preload history
        try {
            const rawHistory = await dbHelpers.workouts.getHistory(user.id);
            window.workoutHistoryCache = normalizeHistoryCache(rawHistory);
        } catch(e) { console.error("Failed to load history", e); }

        const profile = await window.getUserProfile();
        const startDate = profile?.program_start_date;
        if (startDate) {
            const start = new Date(startDate);
            const dayDiff = Math.ceil(Math.abs(new Date() - start) / (1000 * 60 * 60 * 24));
            dayIndex = (dayDiff || 1) - 1;
        }
    }

    const actualDayIndex = dayIndex % program.schedule.length;
    const workout = program.schedule[actualDayIndex];

    // Store current workout key for customizations
    window.currentWorkoutKey = `${id}/${actualDayIndex}`;

    // Load workout customizations if user is logged in
    if (user) {
        try {
            customizations = await dbHelpers.workoutCustomizations.get(user.id, window.currentWorkoutKey);
            window.currentWorkoutCustomizations = customizations;
        } catch(e) {
            console.error("Failed to load customizations", e);
        }
    }

    // Build exercise list with customizations applied
    let exercises = workout.exercises.map(ex => ({...ex}));

    if (customizations) {
        // Filter out removed exercises
        const removedExercises = customizations.removed_exercises || [];
        exercises = exercises.filter(ex => !removedExercises.includes(ex.name));

        // Add user-added exercises at the end
        const addedExercises = customizations.added_exercises || [];
        exercises = exercises.concat(addedExercises.map(ex => ({
            ...ex,
            isUserAdded: true
        })));
    }

    // Preload personal bests for all exercises in this workout
    if (user) {
        try {
            const exerciseNames = exercises.map(ex => ex.name);
            window.personalBestsCache = await dbHelpers.personalBests.getForExercises(user.id, exerciseNames);
        } catch(e) { console.error("Failed to load personal bests", e); window.personalBestsCache = {}; }
    }

    document.getElementById('workout-player-title').innerText = workout.title;
    window.currentWorkoutName = workout.title;
    const exerciseCount = exercises.length;
    document.getElementById('workout-player-goal').innerText = `${program.description} · ${exerciseCount} Exercise${exerciseCount !== 1 ? 's' : ''}`;

    const list = document.getElementById('workout-exercises-list');
    list.innerHTML = '';

    exercises.forEach((ex, idx) => {
        const card = document.createElement('div');
        card.className = 'exercise-logger-card';
        card.setAttribute('data-exercise-name', ex.name);
        card.setAttribute('data-is-user-added', ex.isUserAdded || false);
        card.style.cssText = "background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9;";

        const isTimeBased = ex.reps && (ex.reps.toLowerCase().includes('min') || ex.reps.toLowerCase().includes('s'));
        const previousSummary = getPreviousWorkoutSummary(ex.name);
        // Use previous session's set count if available, otherwise use prescribed sets
        const prescribedSets = ex.sets || 3;
        const numSets = previousSummary && previousSummary.setCount > 0 ? previousSummary.setCount : prescribedSets;
        let setsHtml = '';
        for(let s=1; s<=numSets; s++) {
            // Get prefill data from previous session for this set number
            const prevSet = previousSummary && previousSummary.sets[s - 1] ? previousSummary.sets[s - 1] : null;
            setsHtml += getSetRowHtml(ex.name, s, isTimeBased, prevSet);
        }

        const videoUrl = findVideoMatch(ex.name);
        const previousSummaryHtml = formatPreviousWorkoutSummary(ex.name);
        const isUserAdded = ex.isUserAdded || false;
        const escapedName = ex.name.replace(/'/g, "\\'");

        card.innerHTML = `
            <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <h3 style="margin:0; font-size:1.05rem; font-weight:700; color:var(--text-main); line-height:1.2;">${ex.name}</h3>
                            ${isUserAdded ? '<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">ADDED</span>' : ''}
                        </div>
                        <p style="margin:0; font-size:0.85rem; color:var(--text-muted); line-height:1.3;">${ex.desc || ''}</p>
                        ${previousSummaryHtml}
                    </div>
                    <button onclick="deleteExerciseFromWorkout('${escapedName}', ${isUserAdded})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; font-size: 0.8rem; font-weight: 600;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>

            ${videoUrl ? `
            <div data-video-container style="position:relative; width:100%; padding-top:56.25%; background:black; cursor:pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:60px; height:60px; background:rgba(255,255,255,0.9); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width:30px; height:30px; fill:var(--primary); margin-left:3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            <!-- Volume Tracker -->
            <div class="volume-display" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-bottom: 1px solid #fef08a;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #ca8a04;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    <span style="font-size: 0.75rem; font-weight: 700; color: #a16207; text-transform: uppercase;">Volume</span>
                </div>
                <div style="text-align: right;">
                    <div class="volume-value" style="font-size: 1rem; font-weight: 800; color: #854d0e;">0 kg</div>
                    <div class="volume-comparison" style="font-size: 0.7rem; font-weight: 600;">${previousSummary && previousSummary.totalVolume > 0 ? `<span style="color: #94a3b8;">Last: ${previousSummary.totalVolume.toLocaleString()} kg — beat it!</span>` : '<span style="color: #94a3b8;">Enter weight & reps</span>'}</div>
                </div>
                <div class="volume-progress-container" style="display: ${previousSummary && previousSummary.totalVolume > 0 ? 'block' : 'none'}; margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span class="volume-target-label" style="font-size: 0.65rem; font-weight: 600; color: #a16207;">Target: ${previousSummary && previousSummary.totalVolume > 0 ? previousSummary.totalVolume.toLocaleString() + ' kg' : '—'}</span>
                        <span class="volume-percentage" style="font-size: 0.65rem; font-weight: 700; color: #a16207;">0%</span>
                    </div>
                    <div style="height: 6px; background: #fef08a; border-radius: 3px; overflow: hidden;">
                        <div class="volume-progress-bar" style="height: 100%; width: 0%; background: #ca8a04; border-radius: 3px; transition: width 0.3s ease, background 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr 32px 32px; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div><div></div><div></div>
            </div>

            <div class="sets-list-container">
                ${setsHtml}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${escapedName}', ${isTimeBased})" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>
        `;
        list.appendChild(card);

        // Setup volume tracking for this card
        setupVolumeTracking(card);
    });

    hideAllAppViews();
    document.getElementById('view-active-workout').style.display = 'block';
    startWorkoutTimer();

    // Push navigation state for Android back button
    pushNavigationState('view-active-workout', () => quitWorkout());

    // Show total volume popup and tracker
    showLastVolumePopup();
}

// Normalize history records from DB format to local format
// DB returns: exercise_name, workout_date, weight_kg, set_number, time_duration
// Local code expects: exercise, date, kg, set, time, reps
function normalizeHistoryCache(historyData) {
    if (!historyData || !Array.isArray(historyData)) return [];
    return historyData.map(h => {
        // If already in local format, return as-is
        if (h.exercise) return h;
        // Map DB column names to local format
        return {
            exercise: h.exercise_name || '',
            date: h.workout_date || '',
            kg: h.weight_kg || '',
            set: h.set_number || 0,
            time: h.time_duration || '',
            reps: h.reps || '',
            isDropSet: h.is_drop_set || false,
            dropSetWeights: h.drop_set_weights || '',
            dropSetReps: h.drop_set_reps || '',
            // Keep original fields too for compatibility
            exercise_name: h.exercise_name,
            workout_date: h.workout_date,
            weight_kg: h.weight_kg,
            set_number: h.set_number,
            time_duration: h.time_duration
        };
    });
}

function getPreviousStats(name, set) {
    // Use cached history from DB
    const history = window.workoutHistoryCache || [];

    // Filter history for this specific exercise
    const exerciseHistory = history.filter(h => h.exercise === name);

    if (exerciseHistory.length === 0) return 'New';

    // Reverse iterate to find most recent
    for (let i = exerciseHistory.length - 1; i >= 0; i--) {
        const h = exerciseHistory[i];
        if (h.set == set) {
             const val = h.reps || h.time;
             if (h.kg && h.kg !== '0' && h.kg !== '') return `${h.kg}kg x ${val}`;
             return `${val}`;
        }
    }
    return '-';
}

function findPreviousSetData(name) {
    // Use cached history from DB to find most recent data for this exercise
    const history = window.workoutHistoryCache || [];
    const exerciseHistory = history.filter(h => h.exercise === name);

    if (exerciseHistory.length === 0) return null;

    // Get most recent entry
    const recent = exerciseHistory[exerciseHistory.length - 1];
    const val = recent.reps || recent.time;
    if (recent.kg && recent.kg !== '0' && recent.kg !== '') {
        return `${recent.kg}kg x ${val}`;
    }
    return val ? `${val}` : null;
}

// Get full previous workout summary for an exercise (all sets from last session)
function getPreviousWorkoutSummary(exerciseName) {
    const history = window.workoutHistoryCache || [];
    const exerciseHistory = history.filter(h => h.exercise === exerciseName);

    if (exerciseHistory.length === 0) return null;

    // Group by date to find the most recent workout date for this exercise
    const dateGroups = {};
    exerciseHistory.forEach(h => {
        const date = h.date || h.workout_date;
        if (!dateGroups[date]) dateGroups[date] = [];
        dateGroups[date].push(h);
    });

    // Get the most recent date
    const dates = Object.keys(dateGroups).sort((a, b) => new Date(b) - new Date(a));
    if (dates.length === 0) return null;

    const lastDate = dates[0];
    const lastWorkoutSets = dateGroups[lastDate].sort((a, b) => (a.set || 0) - (b.set || 0));

    // Deduplicate by set number - keep only one entry per set
    const seenSets = {};
    const uniqueSets = lastWorkoutSets.filter(s => {
        const setNum = s.set || 0;
        if (seenSets[setNum]) return false;
        seenSets[setNum] = true;
        return true;
    });

    // Calculate total volume from last workout
    let totalVolume = 0;
    const sets = uniqueSets.map(s => {
        const weight = parseFloat(s.kg) || 0;
        const reps = parseFloat(s.reps) || 0;
        const setVolume = weight * reps;
        totalVolume += setVolume;
        return {
            set: s.set,
            reps: s.reps,
            kg: s.kg,
            time: s.time,
            volume: setVolume
        };
    });

    return {
        date: lastDate,
        sets: sets,
        totalVolume: totalVolume,
        setCount: sets.length
    };
}

// Get all-time max weight for an exercise
// Prefers personal_bests table (via cache), falls back to history cache
function getExerciseMaxWeight(exerciseName) {
    // Check personal bests cache first (authoritative source)
    const pbCache = window.personalBestsCache || {};
    const pb = pbCache[exerciseName];
    if (pb && pb.best_weight_kg > 0) {
        return {
            weight: parseFloat(pb.best_weight_kg),
            reps: parseInt(pb.best_weight_reps) || 0,
            date: pb.best_weight_date,
            bestReps: parseInt(pb.best_reps) || 0,
            bestRepsWeight: parseFloat(pb.best_reps_weight_kg) || 0,
            bestRepsDate: pb.best_reps_date
        };
    }

    // Fallback to history cache
    const history = window.workoutHistoryCache || [];
    const exerciseHistory = history.filter(h => h.exercise === exerciseName);

    if (exerciseHistory.length === 0) return null;

    let maxWeight = 0;
    let maxWeightReps = 0;
    let maxWeightDate = null;

    exerciseHistory.forEach(h => {
        const weight = parseFloat(h.kg) || 0;
        if (weight > maxWeight) {
            maxWeight = weight;
            maxWeightReps = parseInt(h.reps) || 0;
            maxWeightDate = h.date || h.workout_date;
        }
    });

    if (maxWeight === 0) return null;

    return {
        weight: maxWeight,
        reps: maxWeightReps,
        date: maxWeightDate
    };
}

// Calculate total volume for an exercise card
function calculateExerciseVolume(card) {
    if (!card) return 0;

    const setWrappers = card.querySelectorAll('.set-wrapper');
    let totalVolume = 0;

    setWrappers.forEach(wrapper => {
        // Skip prefilled rows the user hasn't touched yet
        if (wrapper.getAttribute('data-prefilled') === 'true') return;

        const kgInput = wrapper.querySelector('.input-kg');
        const repsInput = wrapper.querySelector('.input-reps');

        const kg = parseFloat(kgInput?.value) || 0;
        const reps = parseFloat(repsInput?.value) || 0;

        totalVolume += kg * reps;

        // Also count drop sets
        const dropContainer = wrapper.querySelector('.drop-set-container');
        if (dropContainer && dropContainer.classList.contains('visible')) {
            const dropRows = dropContainer.querySelectorAll('.drop-set-row');
            dropRows.forEach(row => {
                const dropKg = parseFloat(row.querySelector('.drop-kg')?.value) || 0;
                const dropReps = parseFloat(row.querySelector('.drop-reps')?.value) || 0;
                totalVolume += dropKg * dropReps;
            });
        }
    });

    return totalVolume;
}

// Update volume display for an exercise card
function updateVolumeDisplay(card) {
    if (!card) return;

    const volumeDisplay = card.querySelector('.volume-display');
    if (!volumeDisplay) return;

    const totalVolume = calculateExerciseVolume(card);
    const volumeValue = volumeDisplay.querySelector('.volume-value');
    const volumeComparison = volumeDisplay.querySelector('.volume-comparison');
    const progressContainer = volumeDisplay.querySelector('.volume-progress-container');
    const progressBar = volumeDisplay.querySelector('.volume-progress-bar');
    const targetLabel = volumeDisplay.querySelector('.volume-target-label');
    const percentageLabel = volumeDisplay.querySelector('.volume-percentage');

    if (volumeValue) {
        volumeValue.textContent = totalVolume.toLocaleString() + ' kg';
    }

    // Compare to previous workout if available
    const exerciseName = card.getAttribute('data-exercise-name');
    const previousSummary = getPreviousWorkoutSummary(exerciseName);

    if (previousSummary && previousSummary.totalVolume > 0) {
        const targetVolume = previousSummary.totalVolume;
        const diff = totalVolume - targetVolume;
        const pct = totalVolume > 0 ? ((totalVolume / targetVolume) * 100).toFixed(0) : 0;

        // Update progress bar
        if (progressContainer) {
            progressContainer.style.display = 'block';
            if (targetLabel) targetLabel.textContent = 'Target: ' + targetVolume.toLocaleString() + ' kg';
            if (percentageLabel) {
                percentageLabel.textContent = totalVolume > 0 ? pct + '%' : '0%';
                percentageLabel.style.color = totalVolume >= targetVolume ? '#16a34a' : '#a16207';
            }
            if (progressBar) {
                const barWidth = Math.min(pct, 100);
                progressBar.style.width = barWidth + '%';
                progressBar.style.background = totalVolume >= targetVolume ? '#22c55e' : '#ca8a04';
            }
        }

        if (volumeComparison) {
            if (totalVolume === 0) {
                volumeComparison.innerHTML = '<span style="color: #94a3b8;">Last: ' + targetVolume.toLocaleString() + ' kg — beat it!</span>';
            } else if (diff > 0) {
                volumeComparison.innerHTML = '<span style="color: #22c55e; font-weight: 700;">+' + diff.toLocaleString() + ' kg — NEW VOLUME PR!</span>';
            } else if (diff < 0) {
                const remaining = Math.abs(diff);
                volumeComparison.innerHTML = '<span style="color: #f59e0b;">' + remaining.toLocaleString() + ' kg to beat last session</span>';
            } else {
                volumeComparison.innerHTML = '<span style="color: #22c55e;">Matched last session!</span>';
            }
        }
    } else if (volumeComparison) {
        volumeComparison.innerHTML = totalVolume > 0 ? '<span style="color: #94a3b8;">First time — setting your benchmark!</span>' : '<span style="color: #94a3b8;">Enter weight & reps</span>';
        if (progressContainer) progressContainer.style.display = 'none';
    }
}

// Setup volume tracking event listeners for a card
function setupVolumeTracking(card) {
    if (!card) return;

    const inputs = card.querySelectorAll('.input-kg, .input-reps, .drop-kg, .drop-reps');
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            // Mark this set row as user-touched (no longer prefilled)
            const wrapper = input.closest('.set-wrapper');
            if (wrapper && wrapper.getAttribute('data-prefilled') === 'true') {
                wrapper.removeAttribute('data-prefilled');
            }
            updateVolumeDisplay(card);
            updateTotalWorkoutVolume();
        });
    });

    // Initial display update (will show 0 for prefilled rows)
    updateVolumeDisplay(card);
}

// Calculate total workout volume across ALL exercises
function calculateTotalWorkoutVolume() {
    let total = 0;
    const cards = document.querySelectorAll('#workout-exercises-list .exercise-logger-card');
    cards.forEach(card => {
        total += calculateExerciseVolume(card);
    });
    return total;
}

// Calculate total previous workout volume across all exercises
function calculateLastWorkoutTotalVolume() {
    let total = 0;
    const cards = document.querySelectorAll('#workout-exercises-list .exercise-logger-card');
    cards.forEach(card => {
        const name = card.getAttribute('data-exercise-name');
        if (name) {
            const prev = getPreviousWorkoutSummary(name);
            if (prev && prev.totalVolume > 0) {
                total += prev.totalVolume;
            }
        }
    });
    return total;
}

// Update the total workout volume bar display
function updateTotalWorkoutVolume() {
    const bar = document.getElementById('total-volume-bar');
    if (!bar) return;

    const currentTotal = calculateTotalWorkoutVolume();
    const lastTotal = window._lastWorkoutTotalVolume || 0;

    // Show the bar and dynamically position below header
    bar.style.display = 'block';
    const workoutView = document.getElementById('view-active-workout');
    if (workoutView) {
        const header = workoutView.firstElementChild;
        if (header && header.style.position === 'sticky') {
            bar.style.top = header.offsetHeight + 'px';
        }
    }

    // Update current volume value
    const valueEl = document.getElementById('total-volume-value');
    if (valueEl) valueEl.textContent = currentTotal.toLocaleString() + ' kg';

    // Update progress if we have a target
    const progressWrap = document.getElementById('total-volume-progress-wrap');
    const progressBar = document.getElementById('total-volume-progress-bar');
    const targetLabel = document.getElementById('total-volume-target-label');
    const diffEl = document.getElementById('total-volume-diff');

    if (lastTotal > 0) {
        if (progressWrap) progressWrap.style.display = 'block';
        if (targetLabel) targetLabel.textContent = 'Last: ' + lastTotal.toLocaleString() + ' kg';

        const pct = currentTotal > 0 ? ((currentTotal / lastTotal) * 100).toFixed(0) : 0;
        const barWidth = Math.min(pct, 100);

        if (progressBar) {
            progressBar.style.width = barWidth + '%';
            progressBar.style.background = currentTotal >= lastTotal ? '#22c55e' : '#facc15';
        }

        if (diffEl) {
            const diff = currentTotal - lastTotal;
            if (currentTotal === 0) {
                diffEl.textContent = '';
            } else if (diff > 0) {
                diffEl.textContent = '+' + diff.toLocaleString() + ' kg';
                diffEl.style.color = '#22c55e';
            } else if (diff < 0) {
                diffEl.textContent = Math.abs(diff).toLocaleString() + ' kg to go';
                diffEl.style.color = '#fbbf24';
            } else {
                diffEl.textContent = 'Matched!';
                diffEl.style.color = '#22c55e';
            }
        }
    } else {
        if (progressWrap) progressWrap.style.display = 'none';
    }
}

// Show the "last workout volume" popup
function showLastVolumePopup() {
    // Small delay to let DOM render first
    setTimeout(() => {
        const lastTotal = calculateLastWorkoutTotalVolume();
        window._lastWorkoutTotalVolume = lastTotal;

        // Always show the total volume bar
        updateTotalWorkoutVolume();

        // Only show popup if there was a previous workout with volume
        if (lastTotal > 0) {
            const popup = document.getElementById('last-volume-popup');
            const volumeEl = document.getElementById('popup-last-volume');
            if (popup && volumeEl) {
                volumeEl.textContent = lastTotal.toLocaleString() + ' kg';
                popup.style.display = 'flex';
                // Auto-dismiss after 4 seconds
                window._volumePopupTimer = setTimeout(dismissVolumePopup, 4000);
            }
        }
    }, 300);
}

// Dismiss the popup
function dismissVolumePopup() {
    const popup = document.getElementById('last-volume-popup');
    if (popup) popup.style.display = 'none';
    if (window._volumePopupTimer) {
        clearTimeout(window._volumePopupTimer);
        window._volumePopupTimer = null;
    }
}

// Format previous workout summary as HTML - Personal Best banner only
function formatPreviousWorkoutSummary(exerciseName) {
    const maxWeight = getExerciseMaxWeight(exerciseName);

    if (!maxWeight) return '';

    const prDateStr = maxWeight.date ? new Date(maxWeight.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';

    let html = '<div class="exercise-history-panel" style="margin-top: 10px;">';
    // Full-width Personal Best banner
    html += '<div style="width: 100%; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 10px 14px; border: 1px solid #fbbf24; display: flex; align-items: center; gap: 10px;">';
    // Crown icon
    html += '<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #d97706; flex-shrink: 0;"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/></svg>';
    // PR text
    html += '<div style="flex: 1; display: flex; align-items: baseline; gap: 6px; flex-wrap: wrap;">';
    html += '<span style="font-size: 0.7rem; font-weight: 800; color: #92400e; text-transform: uppercase; letter-spacing: 0.5px;">Personal Best</span>';
    html += '<span style="font-size: 1rem; font-weight: 900; color: #78350f;">' + maxWeight.weight + ' kg x ' + maxWeight.reps + ' reps</span>';
    if (maxWeight.bestReps && maxWeight.bestReps > maxWeight.reps) {
        html += '<span style="font-size: 0.7rem; color: #a16207; font-weight: 600;">(Most reps: ' + maxWeight.bestReps + ' @ ' + maxWeight.bestRepsWeight + 'kg)</span>';
    }
    html += '</div>';
    if (prDateStr) {
        html += '<span style="font-size: 0.65rem; color: #b45309; font-weight: 600; flex-shrink: 0;">' + prDateStr + '</span>';
    }
    html += '</div>';
    html += '</div>';
    return html;
}

// Generate volume display HTML with progress bar for an exercise
function getVolumeDisplayHtml(exerciseName) {
    const previousSummary = getPreviousWorkoutSummary(exerciseName);
    const targetVolume = previousSummary ? previousSummary.totalVolume : 0;
    const targetText = targetVolume > 0 ?
        '<span style="color: #94a3b8;">Last: ' + targetVolume.toLocaleString() + ' kg — beat it!</span>' :
        '<span style="color: #94a3b8;">Enter weight & reps</span>';

    let html = '<div class="volume-display" style="padding: 12px 15px; background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-bottom: 1px solid #fef08a;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
    html += '<div style="display: flex; align-items: center; gap: 8px;">';
    html += '<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #ca8a04;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>';
    html += '<span style="font-size: 0.75rem; font-weight: 700; color: #a16207; text-transform: uppercase;">Volume</span>';
    html += '</div>';
    html += '<div style="text-align: right;">';
    html += '<div class="volume-value" style="font-size: 1rem; font-weight: 800; color: #854d0e;">0 kg</div>';
    html += '<div class="volume-comparison" style="font-size: 0.7rem; font-weight: 600;">' + targetText + '</div>';
    html += '</div></div>';

    // Progress bar
    html += '<div class="volume-progress-container" style="display: ' + (targetVolume > 0 ? 'block' : 'none') + '; margin-top: 8px;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">';
    html += '<span class="volume-target-label" style="font-size: 0.65rem; font-weight: 600; color: #a16207;">Target: ' + (targetVolume > 0 ? targetVolume.toLocaleString() + ' kg' : '—') + '</span>';
    html += '<span class="volume-percentage" style="font-size: 0.65rem; font-weight: 700; color: #a16207;">0%</span>';
    html += '</div>';
    html += '<div style="height: 6px; background: #fef08a; border-radius: 3px; overflow: hidden;">';
    html += '<div class="volume-progress-bar" style="height: 100%; width: 0%; background: #ca8a04; border-radius: 3px; transition: width 0.3s ease, background 0.3s ease;"></div>';
    html += '</div></div></div>';

    return html;
}

function getSetRowHtml(exName, setNum, isTimeBased, prefillData) {
    // prefillData: optional {kg, reps, time} from previous session
    const prefillKg = prefillData && prefillData.kg && prefillData.kg !== '0' && prefillData.kg !== '' ? prefillData.kg : '';
    const prefillReps = prefillData && prefillData.reps ? prefillData.reps : '';
    const prefillTime = prefillData && prefillData.time ? prefillData.time : '';
    const hasPrefill = prefillKg || prefillReps || prefillTime;
    return `
        <div class="set-wrapper"${hasPrefill ? ' data-prefilled="true"' : ''}>
            <div class="workout-set-row" style="display:grid; grid-template-columns:40px 1fr 1fr 1fr 32px 32px; gap:8px; align-items:center; padding:10px 15px; border-top:1px solid #f8fafc;">
                <div class="set-number" style="font-weight:800; color:#94a3b8; font-size:0.85rem; text-align:center;">${setNum}</div>
                <div style="position:relative;">
                    <input type="text" class="input-time" placeholder="-" value="${prefillTime}" style="width:100%; border:none; background:#f8fafc; border-radius:8px; padding:10px 5px; text-align:center; font-weight:700; color:var(--text-main); font-size:0.9rem;">
                    ${isTimeBased ? '<svg viewBox="0 0 24 24" style="position:absolute; left:4px; top:50%; transform:translateY(-50%); width:12px; height:12px; fill:#94a3b8;"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>' : ''}
                </div>
                <input type="text" class="input-reps" placeholder="Reps" value="${prefillReps}" style="width:100%; border:none; background:#f8fafc; border-radius:8px; padding:10px 5px; text-align:center; font-weight:700; color:var(--text-main); font-size:0.9rem;">
                <input type="text" class="input-kg" placeholder="Kg" value="${prefillKg}" style="width:100%; border:none; background:#f8fafc; border-radius:8px; padding:10px 5px; text-align:center; font-weight:700; color:var(--text-main); font-size:0.9rem;">
                <button class="drop-set-toggle" onclick="toggleDropSet(this)" title="Toggle Drop Set">DS</button>
                <button class="delete-set-btn" onclick="deleteSetRow(this)" title="Delete Set" style="width:32px; height:32px; border:none; background:transparent; color:#ef4444; cursor:pointer; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;">
                    <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:currentColor;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
            </div>
            <div class="drop-set-container">
                <div class="drop-set-inputs">
                    <div class="drop-set-row">
                        <div class="drop-indicator">↓1</div>
                        <input type="text" class="drop-reps" placeholder="Reps">
                        <input type="text" class="drop-kg" placeholder="Kg">
                        <button class="drop-add-btn" onclick="addDropRow(this)">+</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function addWorkoutSet(btn, exName, isTimeBased) {
    // Navigate up to the card container
    // Structure: Button -> Div (padding wrapper) -> Card
    const card = btn.closest('.exercise-logger-card');

    if (!card) {
        console.error("Could not find .exercise-logger-card");
        return;
    }

    // Find the sets container within this card
    const container = card.querySelector('.sets-list-container');

    if (!container) {
        console.error("Could not find .sets-list-container");
        return;
    }

    const setNum = container.children.length + 1;

    // Create new div wrapper (since getSetRowHtml returns a string)
    const div = document.createElement('div');
    div.innerHTML = getSetRowHtml(exName, setNum, isTimeBased).trim();

    // Optional: Add simple animation
    const newRow = div.firstElementChild;
    newRow.style.opacity = '0';
    newRow.style.transform = 'translateY(-10px)';
    newRow.style.transition = 'all 0.3s ease';

    container.appendChild(newRow);

    // Add volume tracking for the new inputs
    const inputs = newRow.querySelectorAll('.input-kg, .input-reps, .drop-kg, .drop-reps');
    inputs.forEach(input => {
        input.addEventListener('input', () => { const w = input.closest('.set-wrapper'); if (w) w.removeAttribute('data-prefilled'); updateVolumeDisplay(card); updateTotalWorkoutVolume(); });
    });

    // Trigger reflow for animation
    requestAnimationFrame(() => {
        newRow.style.opacity = '1';
        newRow.style.transform = 'translateY(0)';
    });
}

function deleteSetRow(btn) {
    const wrapper = btn.closest('.set-wrapper');
    const container = wrapper.closest('.sets-list-container');
    const card = wrapper.closest('.exercise-logger-card');

    if (!container) {
        console.error("Could not find .sets-list-container");
        return;
    }

    // Don't allow deleting if only one set remains
    const allSets = container.querySelectorAll('.set-wrapper');
    if (allSets.length <= 1) {
        return;
    }

    // Animate out
    wrapper.style.opacity = '0';
    wrapper.style.transform = 'translateY(-10px)';
    wrapper.style.transition = 'all 0.2s ease';

    setTimeout(() => {
        wrapper.remove();

        // Renumber remaining sets
        const remainingSets = container.querySelectorAll('.set-wrapper');
        remainingSets.forEach((setWrapper, idx) => {
            const setNumEl = setWrapper.querySelector('.set-number');
            if (setNumEl) {
                setNumEl.textContent = idx + 1;
            }
        });

        // Recalculate volume after set deletion
        if (card) {
            updateVolumeDisplay(card);
            updateTotalWorkoutVolume();
        }
    }, 200);
}

// Drop Set Functions
function toggleDropSet(btn) {
    const wrapper = btn.closest('.set-wrapper');
    const container = wrapper.querySelector('.drop-set-container');
    const card = wrapper.closest('.exercise-logger-card');

    btn.classList.toggle('active');
    container.classList.toggle('visible');

    // Focus on first input when opening
    if (container.classList.contains('visible')) {
        const firstInput = container.querySelector('.drop-reps');
        if (firstInput) firstInput.focus();

        // Setup volume tracking for drop set inputs
        const dropInputs = container.querySelectorAll('.drop-kg, .drop-reps');
        dropInputs.forEach(input => {
            if (!input.hasAttribute('data-volume-tracked')) {
                input.setAttribute('data-volume-tracked', 'true');
                input.addEventListener('input', () => { const w = input.closest('.set-wrapper'); if (w) w.removeAttribute('data-prefilled'); updateVolumeDisplay(card); updateTotalWorkoutVolume(); });
            }
        });
    }

    // Recalculate volume when drop sets are toggled
    if (card) {
        updateVolumeDisplay(card);
    }
}

function addDropRow(btn) {
    const inputsContainer = btn.closest('.drop-set-inputs');
    const currentRows = inputsContainer.querySelectorAll('.drop-set-row');
    const dropNum = currentRows.length + 1;
    const card = btn.closest('.exercise-logger-card');

    // Change current row's + button to - button
    btn.className = 'drop-remove-btn';
    btn.textContent = '-';
    btn.onclick = function() { removeDropRow(this); };

    // Add new row
    const newRow = document.createElement('div');
    newRow.className = 'drop-set-row';
    newRow.innerHTML = `
        <div class="drop-indicator">↓${dropNum}</div>
        <input type="text" class="drop-reps" placeholder="Reps">
        <input type="text" class="drop-kg" placeholder="Kg">
        <button class="drop-add-btn" onclick="addDropRow(this)">+</button>
    `;
    newRow.style.opacity = '0';
    newRow.style.transform = 'translateY(-5px)';
    newRow.style.transition = 'all 0.2s ease';

    inputsContainer.appendChild(newRow);

    // Add volume tracking for new inputs
    const dropInputs = newRow.querySelectorAll('.drop-kg, .drop-reps');
    dropInputs.forEach(input => {
        input.setAttribute('data-volume-tracked', 'true');
        input.addEventListener('input', () => { const w = input.closest('.set-wrapper'); if (w) w.removeAttribute('data-prefilled'); updateVolumeDisplay(card); updateTotalWorkoutVolume(); });
    });

    // Animate in
    requestAnimationFrame(() => {
        newRow.style.opacity = '1';
        newRow.style.transform = 'translateY(0)';
    });

    // Focus new input
    newRow.querySelector('.drop-reps').focus();
}

function removeDropRow(btn) {
    const row = btn.closest('.drop-set-row');
    const inputsContainer = row.parentElement;
    const card = btn.closest('.exercise-logger-card');

    // Animate out
    row.style.opacity = '0';
    row.style.transform = 'translateY(-5px)';

    setTimeout(() => {
        row.remove();

        // Renumber remaining drop indicators
        const rows = inputsContainer.querySelectorAll('.drop-set-row');
        rows.forEach((r, idx) => {
            r.querySelector('.drop-indicator').textContent = `↓${idx + 1}`;
        });

        // If last row, change its button back to +
        if (rows.length > 0) {
            const lastRow = rows[rows.length - 1];
            const lastBtn = lastRow.querySelector('.drop-remove-btn, .drop-add-btn');
            if (lastBtn && lastBtn.classList.contains('drop-remove-btn')) {
                lastBtn.className = 'drop-add-btn';
                lastBtn.textContent = '+';
                lastBtn.onclick = function() { addDropRow(this); };
            }
        }

        // Recalculate volume after drop row removal
        if (card) {
            updateVolumeDisplay(card);
        }
    }, 200);
}

let workoutTimerInterval;
let workoutStartTime = null; // Store actual start timestamp for accurate timing

function startWorkoutTimer() {
    workoutStartTime = Date.now(); // Record when workout actually started
    const display = document.getElementById('workout-timer');
    clearInterval(workoutTimerInterval);

    function updateTimer() {
        if (!workoutStartTime) return;
        // Calculate actual elapsed time from start timestamp
        const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toString().padStart(2, '0');
        display.innerText = `${m}:${s}`;
    }

    // Update immediately, then every second
    updateTimer();
    workoutTimerInterval = setInterval(updateTimer, 1000);

    // Start auto-save system to prevent data loss
    startWorkoutAutoSave();
    setupWorkoutInputListeners();
}

// Update timer when app becomes visible again (handles background/screen-off throttling)
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible' && workoutStartTime) {
        // Force update the timer display when returning from background
        const display = document.getElementById('workout-timer');
        if (display) {
            const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
            const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            display.innerText = `${m}:${s}`;
        }
    }
});

// ===========================================
// WORKOUT BACKUP & RECOVERY SYSTEM
// Prevents data loss when save fails
// ===========================================

const WORKOUT_BACKUP_KEY = 'pbb_workout_backup';
let workoutAutoSaveInterval = null;

// Collect all workout data from the DOM
function collectWorkoutData() {
    const activeWorkout = document.getElementById('workout-exercises-list');
    if (!activeWorkout) return null;

    const date = new Date().toISOString().split('T')[0];
    const setsData = [];

    Array.from(activeWorkout.children).forEach(card => {
        let name = card.getAttribute('data-exercise-name');
        if (!name) {
            const nameEl = card.querySelector('h3') || card.querySelector('div[style*="font-weight: 700"]');
            if (!nameEl) return;
            name = nameEl.innerText;
        }
        if (!name) return;

        const container = card.querySelector('.sets-list-container');
        if (!container) return;

        const setWrappers = container.querySelectorAll('.set-wrapper');
        const setElements = setWrappers.length > 0
            ? Array.from(setWrappers)
            : Array.from(container.querySelectorAll('.workout-set-row'));

        setElements.forEach((element, rIdx) => {
            const isWrapper = element.classList.contains('set-wrapper');
            const row = isWrapper ? element.querySelector('.workout-set-row') : element;
            if (!row) return;

            const time = row.querySelector('.input-time')?.value || '';
            const reps = row.querySelector('.input-reps')?.value || '';
            const kg = row.querySelector('.input-kg')?.value || '';

            const dropSetToggle = row.querySelector('.drop-set-toggle');
            const isDropSet = dropSetToggle && dropSetToggle.classList.contains('active');

            let dropSetWeights = '';
            let dropSetReps = '';

            if (isDropSet && isWrapper) {
                const dropContainer = element.querySelector('.drop-set-container');
                if (dropContainer) {
                    const dropRows = dropContainer.querySelectorAll('.drop-set-row');
                    const weights = [];
                    const repsArr = [];

                    dropRows.forEach(dropRow => {
                        const dropKg = dropRow.querySelector('.drop-kg')?.value || '';
                        const dropRep = dropRow.querySelector('.drop-reps')?.value || '';
                        if (dropKg || dropRep) {
                            weights.push(dropKg);
                            repsArr.push(dropRep);
                        }
                    });

                    if (weights.length > 0) {
                        dropSetWeights = weights.join(',');
                        dropSetReps = repsArr.join(',');
                    }
                }
            }

            if (time || reps || kg || dropSetWeights) {
                setsData.push({
                    date,
                    exercise: name,
                    set: rIdx + 1,
                    reps,
                    time,
                    kg,
                    isDropSet,
                    dropSetWeights,
                    dropSetReps
                });
            }
        });
    });

    return setsData;
}

// Save workout data to localStorage
function backupWorkoutData() {
    if (!workoutStartTime) return; // No active workout

    const setsData = collectWorkoutData();
    if (!setsData || setsData.length === 0) return;

    const backup = {
        timestamp: Date.now(),
        workoutStartTime: workoutStartTime,
        workoutName: window.currentWorkoutName || 'Workout',
        customWorkoutId: window.currentCustomWorkoutId || null,
        duration: document.getElementById('workout-timer')?.innerText || '00:00',
        sets: setsData
    };

    try {
        localStorage.setItem(WORKOUT_BACKUP_KEY, JSON.stringify(backup));
        console.log('💾 Workout auto-saved:', setsData.length, 'sets');
    } catch (e) {
        console.error('Failed to backup workout:', e);
    }
}

// Clear backup after successful save
function clearWorkoutBackup() {
    try {
        localStorage.removeItem(WORKOUT_BACKUP_KEY);
        console.log('🗑️ Workout backup cleared');
    } catch (e) {
        console.error('Failed to clear workout backup:', e);
    }
}

// Get any stored backup
function getWorkoutBackup() {
    try {
        const backup = localStorage.getItem(WORKOUT_BACKUP_KEY);
        if (!backup) return null;
        return JSON.parse(backup);
    } catch (e) {
        console.error('Failed to read workout backup:', e);
        return null;
    }
}

// Start auto-save interval when workout begins
function startWorkoutAutoSave() {
    // Clear any existing interval
    if (workoutAutoSaveInterval) {
        clearInterval(workoutAutoSaveInterval);
    }

    // Auto-save every 30 seconds
    workoutAutoSaveInterval = setInterval(() => {
        backupWorkoutData();
    }, 30000);

    // Also save immediately when workout starts
    setTimeout(backupWorkoutData, 1000);

    console.log('📝 Workout auto-save enabled');
}

// Stop auto-save when workout ends
function stopWorkoutAutoSave() {
    if (workoutAutoSaveInterval) {
        clearInterval(workoutAutoSaveInterval);
        workoutAutoSaveInterval = null;
    }
}

// Add event listeners to save on input change (with debounce)
let saveDebounceTimer = null;
function setupWorkoutInputListeners() {
    const container = document.getElementById('workout-exercises-list');
    if (!container) return;

    // Use event delegation for all inputs
    container.addEventListener('input', function(e) {
        if (e.target.matches('.input-time, .input-reps, .input-kg, .drop-kg, .drop-reps')) {
            // Debounce saves to avoid excessive writes
            clearTimeout(saveDebounceTimer);
            saveDebounceTimer = setTimeout(backupWorkoutData, 2000);
        }
    });
}

// Retry save with exponential backoff
async function saveWorkoutWithRetry(setsToSave, userId, maxRetries = 3) {
    let lastError = null;

    for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
            await Promise.all(setsToSave.map(s => dbHelpers.workouts.createHistory(userId, s)));
            return true; // Success
        } catch (e) {
            lastError = e;
            console.error(`Save attempt ${attempt + 1} failed:`, e);

            if (attempt < maxRetries) {
                // Exponential backoff: 1s, 2s, 4s
                const delay = Math.pow(2, attempt) * 1000;
                console.log(`Retrying in ${delay/1000}s...`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    throw lastError; // All retries failed
}

// Check for unsaved workout on page load
function checkForUnsavedWorkout() {
    const backup = getWorkoutBackup();
    if (!backup || !backup.sets || backup.sets.length === 0) return;

    // Check if backup is less than 24 hours old
    const hoursSinceBackup = (Date.now() - backup.timestamp) / (1000 * 60 * 60);
    if (hoursSinceBackup > 24) {
        clearWorkoutBackup();
        return;
    }

    // Show recovery dialog
    const minutesAgo = Math.floor((Date.now() - backup.timestamp) / (1000 * 60));
    const timeAgo = minutesAgo < 60
        ? `${minutesAgo} minute${minutesAgo !== 1 ? 's' : ''} ago`
        : `${Math.floor(minutesAgo / 60)} hour${Math.floor(minutesAgo / 60) !== 1 ? 's' : ''} ago`;

    showWorkoutRecoveryDialog(backup, timeAgo);
}

// Show recovery dialog to user
function showWorkoutRecoveryDialog(backup, timeAgo) {
    const exerciseCount = new Set(backup.sets.map(s => s.exercise)).size;
    const setCount = backup.sets.length;

    const dialog = document.createElement('div');
    dialog.id = 'workout-recovery-dialog';
    dialog.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); z-index: 999999;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
    `;

    dialog.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 25px; max-width: 340px; width: 100%; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 15px;">💪</div>
            <h3 style="margin: 0 0 10px 0; color: var(--text-main); font-size: 1.2rem;">Unsaved Workout Found</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
                You have an unsaved workout from ${timeAgo}<br>
                <strong>${exerciseCount} exercise${exerciseCount !== 1 ? 's' : ''}, ${setCount} set${setCount !== 1 ? 's' : ''}</strong>
            </p>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button onclick="recoverWorkout()" style="background: var(--primary); color: white; border: none; padding: 14px 20px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer;">
                    Recover & Save Workout
                </button>
                <button onclick="dismissWorkoutRecovery()" style="background: #f1f5f9; color: var(--text-muted); border: none; padding: 12px 20px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer;">
                    Discard
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(dialog);
}

// Recover and save the backed-up workout
async function recoverWorkout() {
    const dialog = document.getElementById('workout-recovery-dialog');
    if (dialog) dialog.remove();

    const backup = getWorkoutBackup();
    if (!backup || !backup.sets || backup.sets.length === 0) {
        alert('No workout data to recover.');
        return;
    }

    const user = window.currentUser;
    if (!user) {
        alert('Please log in to save your workout.');
        return;
    }

    // Show saving indicator
    const savingDialog = document.createElement('div');
    savingDialog.id = 'workout-saving-dialog';
    savingDialog.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); z-index: 999999;
        display: flex; align-items: center; justify-content: center;
    `;
    savingDialog.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 30px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">💾</div>
            <p style="margin: 0; color: var(--text-main); font-weight: 600;">Saving workout...</p>
        </div>
    `;
    document.body.appendChild(savingDialog);

    try {
        await saveWorkoutWithRetry(backup.sets, user.id);
        console.log('✅ Recovered workout saved successfully');

        // Also check for personal bests and milestones
        try {
            const [milestones, newPBs] = await Promise.all([
                dbHelpers.milestones.checkAndRecordMilestones(user.id),
                dbHelpers.personalBests.checkAndUpdatePBs(user.id, backup.sets)
            ]);

            // Award points for any PBs
            if (newPBs && newPBs.length > 0) {
                for (const pb of newPBs) {
                    const pbRefId = `pb_${pb.exercise}_${pb.type}_${Date.now()}`;
                    await awardPointsForPersonalBest(pbRefId, pb);
                }
            }
        } catch (progressError) {
            console.error('Error checking progress for recovered workout:', progressError);
        }

        clearWorkoutBackup();
        savingDialog.remove();
        alert('Workout recovered and saved successfully! 🎉');
    } catch (e) {
        console.error('Failed to save recovered workout:', e);
        savingDialog.remove();
        alert('Failed to save workout. Your data is still backed up - please try again later or check your connection.');
    }
}

// Dismiss recovery dialog and clear backup
function dismissWorkoutRecovery() {
    const dialog = document.getElementById('workout-recovery-dialog');
    if (dialog) dialog.remove();
    clearWorkoutBackup();
}

// Initialize recovery check when user is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for user to be loaded
    setTimeout(() => {
        if (window.currentUser) {
            checkForUnsavedWorkout();
        }
    }, 2000);
});

// Backup workout data when page goes to background or before unload
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden' && workoutStartTime) {
        backupWorkoutData();
        console.log('📱 Workout backed up (app went to background)');
    }
});

window.addEventListener('beforeunload', function() {
    if (workoutStartTime) {
        backupWorkoutData();
        console.log('📱 Workout backed up (page unloading)');
    }
});

// Also backup when page loses focus (user might close browser)
window.addEventListener('pagehide', function() {
    if (workoutStartTime) {
        backupWorkoutData();
    }
});

// ===========================================
// END WORKOUT BACKUP & RECOVERY SYSTEM
// ===========================================

async function finishWorkout() {
    clearInterval(workoutTimerInterval);
    clearAllYogaTimers(); // Clear any running yoga timers
    stopWorkoutAutoSave(); // Stop auto-save interval

    const timerEl = document.getElementById('workout-timer');
    const duration = timerEl ? timerEl.innerText : '0:00';
    const successDurationEl = document.getElementById('success-duration');
    if (successDurationEl) successDurationEl.innerText = duration;

    // Backup workout data before attempting save (in case of failure)
    backupWorkoutData();

    // Save logic
    const activeWorkout = document.getElementById('workout-exercises-list');
    const date = new Date().toISOString().split('T')[0];
    const setsToSave = [];

    if(activeWorkout) {
        Array.from(activeWorkout.children).forEach(card => {
            // Get exercise name from data attribute first, fallback to h3 or first styled div
            let name = card.getAttribute('data-exercise-name');
            if (!name) {
                const nameEl = card.querySelector('h3') || card.querySelector('div[style*="font-weight: 700"]');
                if(!nameEl) return;
                name = nameEl.innerText;
            }
            if (!name) return;

            const container = card.querySelector('.sets-list-container');
            if(!container) return;

            // Query set wrappers (new style with drop set support) or fall back to workout-set-row (old style)
            const setWrappers = container.querySelectorAll('.set-wrapper');
            const setElements = setWrappers.length > 0
                ? Array.from(setWrappers)
                : Array.from(container.querySelectorAll('.workout-set-row'));

            setElements.forEach((element, rIdx) => {
                // Handle both wrapper-style and direct row-style
                const isWrapper = element.classList.contains('set-wrapper');
                const row = isWrapper ? element.querySelector('.workout-set-row') : element;
                if (!row) return;

                const time = row.querySelector('.input-time')?.value || '';
                const reps = row.querySelector('.input-reps')?.value || '';
                const kg = row.querySelector('.input-kg')?.value || '';

                // Check if this is a drop set (only possible with wrapper style)
                const dropSetToggle = row.querySelector('.drop-set-toggle');
                const isDropSet = dropSetToggle && dropSetToggle.classList.contains('active');

                // Collect drop set data if active
                let dropSetWeights = '';
                let dropSetReps = '';

                if (isDropSet && isWrapper) {
                    const dropContainer = element.querySelector('.drop-set-container');
                    if (dropContainer) {
                        const dropRows = dropContainer.querySelectorAll('.drop-set-row');
                        const weights = [];
                        const repsArr = [];

                        dropRows.forEach(dropRow => {
                            const dropKg = dropRow.querySelector('.drop-kg')?.value || '';
                            const dropRep = dropRow.querySelector('.drop-reps')?.value || '';
                            if (dropKg || dropRep) {
                                weights.push(dropKg);
                                repsArr.push(dropRep);
                            }
                        });

                        if (weights.length > 0) {
                            dropSetWeights = weights.join(',');
                            dropSetReps = repsArr.join(',');
                        }
                    }
                }

                // Only save if at least one field is filled
                if (time || reps || kg || dropSetWeights) {
                    setsToSave.push({
                        date,
                        exercise: name,
                        set: rIdx + 1,
                        reps: reps,
                        time: time,
                        kg: kg,
                        isDropSet: isDropSet,
                        dropSetWeights: dropSetWeights,
                        dropSetReps: dropSetReps
                    });
                }
            });
        });
    }

    try {
        const user = window.currentUser;
        if(user && setsToSave.length > 0) {
             // Save workout data with retry logic to handle network issues
             await saveWorkoutWithRetry(setsToSave, user.id);
             console.log("✅ Workout saved to DB");

             // Clear backup after successful save
             clearWorkoutBackup();
             workoutStartTime = null; // Reset start time

             // Update custom workout template with any added exercises
             if (window.currentCustomWorkoutId) {
                 try {
                     // Collect all exercise names from the DOM (includes added exercises)
                     const allExercises = [];
                     const exerciseCards = document.querySelectorAll('#workout-exercises-list .exercise-logger-card');
                     exerciseCards.forEach(card => {
                         const name = card.getAttribute('data-exercise-name');
                         if (name && !allExercises.includes(name)) {
                             allExercises.push(name);
                         }
                     });

                     // Update the custom workout template with all exercises
                     if (allExercises.length > 0) {
                         await dbHelpers.workouts.updateCustomWorkout(window.currentCustomWorkoutId, {
                             exercises: allExercises,
                             date: new Date().toISOString(),
                             lastUsed: new Date().toISOString()
                         });
                         console.log("✅ Custom workout template updated with exercises:", allExercises);

                         // Refresh the cache
                         const savedWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
                         window.savedWorkoutsCache = savedWorkouts;
                     }
                 } catch (updateError) {
                     console.error("Error updating custom workout template:", updateError);
                 }
             }

             // Update cache if it exists
             if (window.workoutHistoryCache) {
                 window.workoutHistoryCache.push(...setsToSave);
             }

             // Check for improvements, milestones, and personal bests
             try {
                 const [improvements, milestones, newPBs] = await Promise.all([
                     dbHelpers.workouts.getWorkoutImprovements(user.id, setsToSave),
                     dbHelpers.milestones.checkAndRecordMilestones(user.id),
                     dbHelpers.personalBests.checkAndUpdatePBs(user.id, setsToSave)
                 ]);

                 // Log any new personal bests and award points
                 if (newPBs && newPBs.length > 0) {
                     console.log("🏆 New Personal Bests:", newPBs);

                     // Award 1 point per personal best
                     try {
                         for (const pb of newPBs) {
                             const pbRefId = `pb_${pb.exercise}_${pb.type}_${Date.now()}`;
                             await awardPointsForPersonalBest(pbRefId, pb);
                         }
                     } catch (pbPointsError) {
                         console.error("Error awarding PB points:", pbPointsError);
                     }
                 }

                 // Check for total workout volume PR and award XP
                 try {
                     const lastTotalVolume = window._lastWorkoutTotalVolume || 0;
                     if (lastTotalVolume > 0) {
                         // Calculate current total workout volume from saved sets
                         let currentTotalVolume = 0;
                         setsToSave.forEach(s => {
                             const kg = parseFloat(s.weight_kg) || 0;
                             const reps = parseFloat(s.reps) || 0;
                             currentTotalVolume += kg * reps;
                         });

                         if (currentTotalVolume > lastTotalVolume) {
                             const volumeImprovement = currentTotalVolume - lastTotalVolume;
                             const workoutName = window.currentWorkoutName || 'Workout';
                             const volRefId = `pb_volume_${workoutName.replace(/\s+/g, '_')}_${Date.now()}`;
                             await awardPointsForPersonalBest(volRefId, {
                                 exercise: workoutName,
                                 type: 'volume',
                                 value: Math.round(currentTotalVolume),
                                 improvement: Math.round(volumeImprovement)
                             });
                             console.log(`🏆 Volume PR! ${Math.round(currentTotalVolume)} kg (was ${Math.round(lastTotalVolume)} kg, +${Math.round(volumeImprovement)} kg)`);
                         }
                     }
                 } catch (volPbError) {
                     console.error("Error checking volume PR:", volPbError);
                 }

                 // Additional points can be earned by sharing workout (story or group chat)

                 // Update avatar fitness state after workout
                 try {
                     if (window.dashboardAvatar) {
                         await window.dashboardAvatar.updateFitness(user.id, true);
                         console.log("Avatar fitness updated after workout");
                     }
                 } catch(avatarError) {
                     console.error("Error updating avatar (workout still saved):", avatarError);
                 }

                 // Check badges after workout
                 try {
                     if (typeof checkWorkoutBadges === 'function') checkWorkoutBadges();
                     if (newPBs && newPBs.length > 0 && typeof checkPBBadges === 'function') checkPBBadges();
                     const sEl = document.getElementById('tamagotchi-streak');
                     if (sEl && typeof checkStreakBadges === 'function') checkStreakBadges(parseInt(sEl.textContent) || 0);
                 } catch(badgeErr) { console.error('Badge check error:', badgeErr); }

                 // Display success screen with progress data (include newPBs)
                 await showWorkoutSuccessScreen(duration, improvements, milestones, setsToSave, newPBs);
             } catch(progressError) {
                 console.error("Error calculating progress:", progressError);
                 // Still show success screen, just without progress data
                 await showWorkoutSuccessScreen(duration, [], [], setsToSave);
             }
        } else {
            // Still set workout data for sharing even with no sets
            completedWorkoutDataForShare = {
                duration: duration,
                improvements: [],
                milestones: [],
                newPBs: [],
                workoutName: window.currentWorkoutName || 'Workout',
                sets: []
            };
            hideAllAppViews();
            document.getElementById('view-workout-success').style.display = 'flex';
            // Push navigation state for Android back button
            pushNavigationState('view-workout-success', () => closeSuccessScreen());
        }
    } catch(e) {
        console.error("Failed to save workout to DB:", e);
        // Show user-friendly error dialog with retry option
        const setCount = setsToSave.length;
        const exerciseCount = new Set(setsToSave.map(s => s.exercise)).size;
        showWorkoutSaveErrorDialog(exerciseCount, setCount);
        return;
    }
}

// Show error dialog with retry option when workout save fails
function showWorkoutSaveErrorDialog(exerciseCount, setCount) {
    const dialog = document.createElement('div');
    dialog.id = 'workout-save-error-dialog';
    dialog.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); z-index: 999999;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
    `;

    dialog.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 25px; max-width: 340px; width: 100%; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 15px;">⚠️</div>
            <h3 style="margin: 0 0 10px 0; color: var(--text-main); font-size: 1.2rem;">Save Failed</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">
                Couldn't save your workout after multiple attempts.
            </p>
            <p style="color: var(--primary); font-size: 0.85rem; margin-bottom: 20px; font-weight: 600;">
                Don't worry - your data is backed up!<br>
                (${exerciseCount} exercise${exerciseCount !== 1 ? 's' : ''}, ${setCount} set${setCount !== 1 ? 's' : ''})
            </p>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button onclick="retryWorkoutSave()" style="background: var(--primary); color: white; border: none; padding: 14px 20px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer;">
                    Try Again
                </button>
                <button onclick="closeWorkoutSaveErrorDialog()" style="background: #f1f5f9; color: var(--text-muted); border: none; padding: 12px 20px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer;">
                    Keep Workout Open
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(dialog);
}

// Close the error dialog and stay on workout screen
function closeWorkoutSaveErrorDialog() {
    const dialog = document.getElementById('workout-save-error-dialog');
    if (dialog) dialog.remove();

    // Restart auto-save since workout is still active
    workoutStartTime = Date.now(); // Reset start time to continue workout
    startWorkoutAutoSave();
}

// Retry saving the workout
async function retryWorkoutSave() {
    const dialog = document.getElementById('workout-save-error-dialog');
    if (dialog) dialog.remove();

    // Call finishWorkout again to retry
    await finishWorkout();
}

// ============================================
// POST-WORKOUT RATING SYSTEM
// ============================================
let workoutRatingState = {
    feeling: null,
    difficulty: null,
    energy: null,
    soreness: null,
    tightness: null,
    intensityPref: null,
    workoutName: null,
    sourceType: 'workout',
    sourceId: null
};

function selectRating(group, value) {
    workoutRatingState[group] = value;

    // Update button styles for this group
    const buttons = document.querySelectorAll(`.rating-btn[data-group="${group}"]`);
    buttons.forEach(btn => {
        const val = parseInt(btn.getAttribute('data-val'));
        if (val === value) {
            btn.style.borderColor = 'var(--primary)';
            btn.style.background = 'rgba(34,197,94,0.1)';
        } else {
            btn.style.borderColor = '#e2e8f0';
            btn.style.background = 'white';
        }
    });

    // Enable save button if required fields are filled
    checkRatingFormValid();
}

function selectIntensityPref(pref) {
    workoutRatingState.intensityPref = pref;

    document.querySelectorAll('.intensity-pref-btn').forEach(btn => {
        if (btn.getAttribute('data-val') === pref) {
            btn.style.borderColor = 'var(--primary)';
            btn.style.background = 'rgba(34,197,94,0.1)';
        } else {
            btn.style.borderColor = '#e2e8f0';
            btn.style.background = 'white';
        }
    });

    checkRatingFormValid();
}

function checkRatingFormValid() {
    const valid = workoutRatingState.feeling && workoutRatingState.difficulty && workoutRatingState.energy;
    const btn = document.getElementById('save-rating-btn');
    if (btn) {
        btn.disabled = !valid;
        btn.style.opacity = valid ? '1' : '0.5';
    }
}

function openWorkoutRatingModal(workoutName, sourceType, sourceId) {
    // Reset state
    workoutRatingState = {
        feeling: null,
        difficulty: null,
        energy: null,
        soreness: null,
        tightness: null,
        intensityPref: null,
        workoutName: workoutName || 'Workout',
        sourceType: sourceType || 'workout',
        sourceId: sourceId || null
    };

    // Reset all button styles
    document.querySelectorAll('#workout-rating-modal .rating-btn').forEach(btn => {
        btn.style.borderColor = '#e2e8f0';
        btn.style.background = 'white';
    });
    document.querySelectorAll('.intensity-pref-btn').forEach(btn => {
        btn.style.borderColor = '#e2e8f0';
        btn.style.background = 'white';
    });

    // Reset notes
    const notesInput = document.getElementById('rating-notes-input');
    if (notesInput) notesInput.value = '';

    // Reset save button
    const saveBtn = document.getElementById('save-rating-btn');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.style.opacity = '0.5';
        saveBtn.textContent = 'Save Rating';
    }

    // Set workout name in header
    const nameEl = document.getElementById('rating-workout-name');
    if (nameEl) nameEl.textContent = workoutName || 'Rate your workout';

    // Show modal
    document.getElementById('workout-rating-modal').style.display = 'block';
}

async function saveWorkoutRating() {
    const saveBtn = document.getElementById('save-rating-btn');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
    }

    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) {
            showToast('Please log in to save rating', 'error');
            return;
        }

        const notes = document.getElementById('rating-notes-input')?.value?.trim() || null;

        await window.dbHelpers?.workoutRatings?.create(session.user.id, {
            workout_date: new Date().toISOString().split('T')[0],
            workout_name: workoutRatingState.workoutName,
            source_type: workoutRatingState.sourceType,
            source_id: workoutRatingState.sourceId,
            overall_feeling: workoutRatingState.feeling,
            difficulty: workoutRatingState.difficulty,
            energy_level: workoutRatingState.energy,
            muscle_soreness: workoutRatingState.soreness,
            tightness: workoutRatingState.tightness,
            intensity_preference: workoutRatingState.intensityPref || 'perfect',
            notes: notes
        });

        showToast('Workout rated!', 'success');
        document.getElementById('workout-rating-modal').style.display = 'none';
    } catch (err) {
        console.error('Error saving workout rating:', err);
        showToast('Failed to save rating', 'error');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Rating';
        }
    }
}

function skipWorkoutRating() {
    document.getElementById('workout-rating-modal').style.display = 'none';
}

// Load workout rating insights for the movement tab
async function loadWorkoutInsights() {
    try {
        const user = window.currentUser;
        if (!user) return;

        const averages = await window.dbHelpers?.workoutRatings?.getAverages(user.id, 30);
        const card = document.getElementById('workout-insights-card');
        if (!card) return;

        if (!averages || averages.count === 0) {
            card.style.display = 'none';
            return;
        }

        card.style.display = 'block';

        const feelingEmojis = { 1: '😫', 2: '😕', 3: '😐', 4: '😊', 5: '🤩' };
        const difficultyEmojis = { 1: '🥱', 2: '👌', 3: '💪', 4: '😤', 5: '🤯' };
        const energyEmojis = { 1: '🪫', 2: '😮‍💨', 3: '🔋', 4: '⚡', 5: '🔥' };

        // Set averages
        document.getElementById('insight-avg-feeling').textContent = averages.avgFeeling;
        document.getElementById('insight-avg-feeling-emoji').textContent = feelingEmojis[Math.round(averages.avgFeeling)] || '😐';
        document.getElementById('insight-avg-difficulty').textContent = averages.avgDifficulty;
        document.getElementById('insight-avg-difficulty-emoji').textContent = difficultyEmojis[Math.round(averages.avgDifficulty)] || '💪';
        document.getElementById('insight-avg-energy').textContent = averages.avgEnergy;
        document.getElementById('insight-avg-energy-emoji').textContent = energyEmojis[Math.round(averages.avgEnergy)] || '🔋';

        // Intensity preference bar
        const total = averages.intensityBreakdown.lighter + averages.intensityBreakdown.perfect + averages.intensityBreakdown.harder;
        if (total > 0) {
            const lighterPct = Math.round((averages.intensityBreakdown.lighter / total) * 100);
            const perfectPct = Math.round((averages.intensityBreakdown.perfect / total) * 100);
            const harderPct = 100 - lighterPct - perfectPct;
            document.getElementById('insight-bar-lighter').style.width = lighterPct + '%';
            document.getElementById('insight-bar-perfect').style.width = perfectPct + '%';
            document.getElementById('insight-bar-harder').style.width = harderPct + '%';
            document.getElementById('insight-lighter-pct').textContent = lighterPct > 0 ? `Lighter ${lighterPct}%` : '';
            document.getElementById('insight-perfect-pct').textContent = perfectPct > 0 ? `Same ${perfectPct}%` : '';
            document.getElementById('insight-harder-pct').textContent = harderPct > 0 ? `Harder ${harderPct}%` : '';
        }

        // Overtraining alert
        const alertEl = document.getElementById('insights-alert');
        const alertText = document.getElementById('insights-alert-text');
        if (averages.avgDifficulty >= 4 && averages.avgEnergy <= 2) {
            alertEl.style.display = 'block';
            alertText.textContent = '⚠️ You\'ve been pushing hard and running low on energy. Consider a deload or lighter session next.';
        } else if (averages.avgTightness && averages.avgTightness >= 4) {
            alertEl.style.display = 'block';
            alertText.textContent = '🧘 High tightness detected. Add stretching or a mobility session to help recovery.';
        } else if (averages.intensityBreakdown.lighter > averages.intensityBreakdown.perfect + averages.intensityBreakdown.harder) {
            alertEl.style.display = 'block';
            alertEl.style.background = '#dbeafe';
            alertEl.style.borderColor = '#60a5fa';
            alertText.style.color = '#1e40af';
            alertText.textContent = '💡 Most sessions felt too intense. Try scaling back weight or volume.';
        } else {
            alertEl.style.display = 'none';
        }

        // Recent ratings list (last 5)
        const recentContainer = document.getElementById('insights-recent');
        const recent = averages.ratings.slice(0, 5);
        if (recent.length > 0) {
            recentContainer.innerHTML = `
                <div style="font-size:0.75rem; color:var(--text-muted); font-weight:600; margin-bottom:8px;">Recent Ratings</div>
                ${recent.map(r => {
                    const d = new Date(r.workout_date);
                    const dateStr = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                    return `
                        <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f1f5f9;">
                            <div style="flex:1;">
                                <div style="font-size:0.85rem; font-weight:600; color:var(--text-main);">${r.workout_name || 'Workout'}</div>
                                <div style="font-size:0.7rem; color:var(--text-muted);">${dateStr}</div>
                            </div>
                            <div style="display:flex; gap:6px; font-size:1rem;">
                                <span title="Feeling">${feelingEmojis[r.overall_feeling] || ''}</span>
                                <span title="Difficulty">${difficultyEmojis[r.difficulty] || ''}</span>
                                <span title="Energy">${energyEmojis[r.energy_level] || ''}</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

    } catch (err) {
        console.error('Error loading workout insights:', err);
    }
}

// Store completed workout data for sharing
let completedWorkoutDataForShare = null;
let selectedLiftToShare = null; // Store the selected lift (legacy, kept for compatibility)

// New flexible share selection state
let shareSelection = {
    mode: 'best', // 'best', 'entire_workout', 'exercise_all', 'multi_select'
    selectedExercise: null, // For 'exercise_all' mode - which exercise to share all sets
    selectedSetIndices: [] // For 'multi_select' mode - array of set indices
};

async function showWorkoutSuccessScreen(duration, improvements, milestones, workoutData, newPBs = []) {
    hideAllAppViews();

    // Store workout data for potential sharing (including all sets)
    completedWorkoutDataForShare = {
        duration: duration,
        improvements: improvements,
        milestones: milestones,
        newPBs: newPBs,
        workoutName: window.currentWorkoutName || 'Workout',
        sets: workoutData || [] // Store all the sets from the workout
    };
    selectedLiftToShare = null; // Reset selected lift
    shareSelection = { mode: 'best', selectedExercise: null, selectedSetIndices: [] }; // Reset flexible selection

    // Update duration
    const successDurEl = document.getElementById('success-duration');
    if (successDurEl) successDurEl.innerText = duration;

    // Show milestones if any - compact display
    const milestonesContainer = document.getElementById('success-milestones');
    if (milestones && milestones.length > 0) {
        milestonesContainer.style.display = 'block';
        milestonesContainer.innerHTML = milestones.map(m => `
            <div style="background: rgba(255,255,255,0.15); padding: 12px 15px; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 2rem;">${m.milestone_value === 1 ? '🎉' : m.milestone_value >= 100 ? '👑' : m.milestone_value >= 50 ? '🏆' : m.milestone_value >= 25 ? '🌟' : m.milestone_value >= 10 ? '🔥' : '💪'}</div>
                <div style="text-align: left;">
                    <div style="font-size: 0.95rem; font-weight: 700;">Milestone!</div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">${m.message}</div>
                </div>
            </div>
        `).join('');
    } else {
        milestonesContainer.style.display = 'none';
    }

    // Show Personal Bests if any - compact display right under header
    const improvementsContainer = document.getElementById('success-improvements');
    if (newPBs && newPBs.length > 0) {
        improvementsContainer.style.display = 'block';
        improvementsContainer.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                <span style="font-size: 1.5rem;">🏆</span>
                <span style="font-size: 1rem; font-weight: 700; color: #fbbf24;">NEW PERSONAL BEST${newPBs.length > 1 ? 'S' : ''}!</span>
            </div>
            ${newPBs.map((pb, idx) => {
                let pbText = '';
                let improvement = '';
                if (pb.type === 'weight') {
                    pbText = `${pb.value}kg x ${pb.reps}`;
                    if (pb.improvement) improvement = `+${pb.improvement}kg`;
                } else {
                    pbText = `${pb.value} reps @ ${pb.weight}kg`;
                    if (pb.improvement) improvement = `+${pb.improvement}`;
                }
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: rgba(251,191,36,0.15); border-radius: 10px; margin-bottom: 6px; border-left: 3px solid #f59e0b;">
                        <div style="flex:1;">
                            <div style="font-weight: 600; font-size: 0.9rem; color: white;">${pb.exercise}</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">${pbText}</div>
                        </div>
                        ${improvement ? `<div style="color: #4ade80; font-weight: 700; font-size: 0.9rem; margin-right:8px;">${improvement}</div>` : ''}
                        <button id="share-pb-btn-${idx}" onclick="sharePBCardToFeed(completedWorkoutDataForShare.newPBs[${idx}]); this.textContent='Shared!'; this.disabled=true; this.style.opacity='0.6';" style="background:rgba(251,191,36,0.3); border:1px solid rgba(251,191,36,0.5); color:#fbbf24; padding:4px 10px; border-radius:8px; font-size:0.7rem; font-weight:700; cursor:pointer; white-space:nowrap;">Share</button>
                    </div>
                `;
            }).join('')}
        `;
    } else if (improvements && improvements.length > 0) {
        // Fallback to showing regular improvements
        improvementsContainer.style.display = 'block';
        improvementsContainer.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                <span style="font-size: 1.3rem;">💪</span>
                <span style="font-size: 0.95rem; font-weight: 700;">Progress Made!</span>
            </div>
            ${improvements.slice(0, 3).map(imp => {
                let improvementText = '';
                if (imp.weightIncrease > 0) improvementText = `+${imp.weightIncrease}kg`;
                else if (imp.repsIncrease > 0) improvementText = `+${imp.repsIncrease} reps`;

                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 5px;">
                        <span style="font-size: 0.85rem;">${imp.exercise}</span>
                        <span style="color: #4ade80; font-weight: 600; font-size: 0.85rem;">${improvementText}</span>
                    </div>
                `;
            }).join('')}
        `;
    } else {
        improvementsContainer.style.display = 'none';
    }

    // Get workout count for display
    try {
        const workoutCount = await dbHelpers.workouts.getWorkoutCount(window.currentUser.id);
        document.getElementById('success-workout-count').innerText = workoutCount;
        document.getElementById('success-workout-count-container').style.display = 'flex';
    } catch(e) {
        document.getElementById('success-workout-count-container').style.display = 'none';
    }

    document.getElementById('view-workout-success').style.display = 'flex';

    // Hide earn-points card if previously dismissed
    if (localStorage.getItem('share_section_dismissed') === 'true') {
        const shareCard = document.getElementById('share-section-combined');
        if (shareCard) shareCard.style.display = 'none';
    }

    // Push navigation state for Android back button
    pushNavigationState('view-workout-success', () => closeSuccessScreen());
}

function quitWorkout() {
    if(confirm('Quit workout? Your progress won\'t be saved.')) {
        console.log("Quitting workout...");
        clearInterval(workoutTimerInterval);
        workoutStartTime = null; // Reset start time
        window.currentCustomWorkoutId = null; // Reset custom workout tracking
        clearAllYogaTimers(); // Clear any running yoga timers
        document.getElementById('view-active-workout').style.display = 'none'; // Force hide
        closeSuccessScreen(true); // Skip rating on quit
    }
}

function closeSuccessScreen(skipRating) {
    // Grab workout name before clearing data
    const workoutName = completedWorkoutDataForShare?.workoutName || window.currentWorkoutName || 'Workout';

    hideAllAppViews();
    document.getElementById('movement-tab').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'flex';
    renderMovementView();
    // Clear the stored workout data
    completedWorkoutDataForShare = null;

    // Reset custom workout tracking for next workout
    window.currentCustomWorkoutId = null;

    // Reset workout points tracking for next workout
    if (typeof workoutPointsEarnedThisSession !== 'undefined') {
        workoutPointsEarnedThisSession = { story: false, groupchat: false };
    }

    // Hide the points awarded confirmation
    const pointsAwarded = document.getElementById('workout-points-awarded');
    if (pointsAwarded) pointsAwarded.style.display = 'none';

    // Refresh challenges to show any updated points
    if (typeof loadHomeChallenges === 'function') {
        loadHomeChallenges();
    }

    // Show post-workout rating modal (unless explicitly skipped)
    if (!skipRating) {
        openWorkoutRatingModal(workoutName, 'workout', null);
    }
}

// Go to group chats to share workout
function goToGroupChatsToShare() {
    closeSuccessScreen();
    switchAppTab('friends');
    // Store data for when user opens a chat
    if (completedWorkoutDataForShare) {
        const { improvements, milestones, workoutName } = completedWorkoutDataForShare;
        let message = `Just finished ${workoutName}! 💪`;
        let improvementText = '';

        if (improvements && improvements.length > 0) {
            const imp = improvements[0];
            if (imp.weightIncrease > 0 || imp.repsIncrease > 0) {
                const parts = [];
                if (imp.weightIncrease > 0) parts.push(`+${imp.weightIncrease}kg`);
                if (imp.repsIncrease > 0) parts.push(`+${imp.repsIncrease} reps`);
                improvementText = parts.join(' and ');
                message = `Hit a PR on ${imp.exercise}! ${improvementText} 🏆`;
            }
        }

        if (milestones && milestones.length > 0) {
            message = `${milestones[0].message} 🌟`;
        }

        // Store prefill data for when user opens share win modal
        window.pendingWinShare = {
            type: improvements?.length > 0 ? 'personal_best' : milestones?.length > 0 ? 'milestone' : 'workout_complete',
            workoutName: workoutName,
            message: message,
            improvement: improvementText
        };
    }
    showToast('Open a group chat to share your win! 💬', 'success');
}

// Quick Share Modal Functions
async function openQuickShareModal() {
    const modal = document.getElementById('quick-share-modal');
    const chatsList = document.getElementById('quick-share-chats-list');
    const noChats = document.getElementById('quick-share-no-chats');
    const liftSection = document.getElementById('lift-selection-section');
    const liftList = document.getElementById('lift-selection-list');
    const multiSelectHint = document.getElementById('multi-select-hint');

    // Reset selection state
    selectedLiftToShare = null;
    shareSelection = { mode: 'best', selectedExercise: null, selectedSetIndices: [] };

    // Populate the win preview with default (best achievement or workout complete)
    updateSharePreview();

    // Populate lift selection if we have sets data
    if (completedWorkoutDataForShare && completedWorkoutDataForShare.sets && completedWorkoutDataForShare.sets.length > 0) {
        liftSection.style.display = 'block';
        if (multiSelectHint) multiSelectHint.style.display = 'none';

        // Group sets by exercise and get best set for each
        const exerciseSets = {};
        completedWorkoutDataForShare.sets.forEach(set => {
            const name = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
            if (!exerciseSets[name]) {
                exerciseSets[name] = [];
            }
            exerciseSets[name].push(set);
        });

        // Build lift selection HTML with flexible options
        let liftHtml = '';
        const exerciseNames = Object.keys(exerciseSets);
        const totalSets = completedWorkoutDataForShare.sets.length;
        const hasMultipleExercises = exerciseNames.length > 1;
        const hasMultipleSets = totalSets > 1;

        // Add "Share Entire Workout" option at the top if there are multiple exercises or sets
        if (hasMultipleSets) {
            liftHtml += `
                <div onclick="selectShareMode('entire_workout')" id="share-option-workout" style="background: linear-gradient(135deg, #7ba883, #4ade80); color: white; padding: 14px 16px; border-radius: 14px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; box-shadow: 0 4px 12px rgba(123, 168, 131, 0.3);" class="share-mode-option">
                    <span style="font-size: 1.4rem;">📋</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; font-size: 1rem;">Share Entire Workout</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">${exerciseNames.length} exercise${exerciseNames.length > 1 ? 's' : ''} • ${totalSets} set${totalSets > 1 ? 's' : ''}</div>
                    </div>
                    <span class="select-chip" style="font-size: 0.8rem; opacity: 0.9;">SELECT</span>
                </div>
            `;
        }

        // Add "Best Achievement" option if there are improvements
        if (completedWorkoutDataForShare.improvements && completedWorkoutDataForShare.improvements.length > 0) {
            const isDefault = shareSelection.mode === 'best';
            liftHtml += `
                <div onclick="selectShareMode('best')" id="share-option-best" style="background: ${isDefault ? 'var(--primary)' : 'white'}; color: ${isDefault ? 'white' : 'var(--text-main)'}; padding: 14px 16px; border-radius: 14px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid ${isDefault ? 'var(--primary)' : '#edf2f7'};" class="share-mode-option">
                    <span style="font-size: 1.4rem;">🏆</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; font-size: 1rem;">Best Achievement (PR)</div>
                        <div style="font-size: 0.8rem; ${isDefault ? 'opacity: 0.9;' : 'color: var(--text-muted);'}">${completedWorkoutDataForShare.improvements[0].exercise}</div>
                    </div>
                    <span class="select-chip" style="font-size: 0.8rem;">${isDefault ? '✓' : 'SELECT'}</span>
                </div>
            `;
        }

        // Add divider if we have exercises to show
        if (exerciseNames.length > 0) {
            liftHtml += `
                <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0 12px 0;">
                    <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                    <span style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Or choose specific lifts</span>
                    <div style="flex: 1; height: 1px; background: #e2e8f0;"></div>
                </div>
            `;
        }

        // Add each exercise as expandable dropdown with all sets
        let exerciseIndex = 0;
        Object.entries(exerciseSets).forEach(([exerciseName, sets]) => {
            const exerciseId = `exercise-dropdown-${exerciseIndex}`;
            const setCount = sets.length;

            // Find best set for summary display
            const bestSet = sets.reduce((best, current) => {
                const currentWeight = current.kg || current.weight_kg || 0;
                const bestWeight = best.kg || best.weight_kg || 0;
                if (currentWeight > bestWeight) return current;
                if (currentWeight === bestWeight) {
                    const currentReps = current.reps || 0;
                    const bestReps = best.reps || 0;
                    return currentReps > bestReps ? current : best;
                }
                return best;
            }, sets[0]);
            const bestWeight = bestSet.kg || bestSet.weight_kg || 0;
            const bestReps = bestSet.reps || 0;

            // Exercise header (clickable to expand)
            liftHtml += `
                <div style="border: 1px solid #edf2f7; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02);" class="exercise-group" data-exercise="${escapeHtml(exerciseName)}">
                    <div onclick="toggleExerciseDropdown('${exerciseId}')" style="background: white; padding: 15px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s;" class="exercise-header">
                        <div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">💪</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">${escapeHtml(exerciseName)}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); font-weight: 500;">${setCount} set${setCount > 1 ? 's' : ''} • Best: ${bestWeight}kg × ${bestReps} reps</div>
                        </div>
                        <div id="${exerciseId}-arrow" style="color: var(--text-muted); transition: transform 0.2s; font-size: 1.2rem;">▼</div>
                    </div>
                    <div id="${exerciseId}" style="display: none; background: #f8fafc; border-top: 1px solid #edf2f7;">
            `;

            // Add "Share All Sets" option for this exercise if multiple sets
            if (setCount > 1) {
                liftHtml += `
                        <div onclick="event.stopPropagation(); selectExerciseAllSets('${escapeHtml(exerciseName)}')" id="share-all-${exerciseIndex}" style="background: #f0fdf4; margin: 8px; padding: 12px 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; border: 1px dashed #86efac;" class="share-all-option">
                            <div style="width: 32px; height: 32px; background: #dcfce7; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem;">📊</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #166534; font-size: 0.95rem;">Share All ${setCount} Sets</div>
                                <div style="font-size: 0.8rem; color: #15803d; font-weight: 500;">Include every set from this exercise</div>
                            </div>
                            <div class="select-chip" style="font-size: 0.7rem; font-weight: 700; color: #16a34a; border: 1.5px solid #16a34a; padding: 3px 8px; border-radius: 15px;">SELECT</div>
                        </div>
                `;
            }

            // Individual sets (multi-selectable)
            sets.forEach((set, idx) => {
                const setIndex = completedWorkoutDataForShare.sets.indexOf(set);
                const weight = set.kg || set.weight_kg || 0;
                const reps = set.reps || 0;
                const setNumber = set.set || (idx + 1);

                liftHtml += `
                        <div onclick="event.stopPropagation(); toggleSetSelection(${setIndex})" id="lift-option-${setIndex}" style="background: white; margin: 8px; padding: 12px 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; border: 1px solid #edf2f7;" class="lift-option" data-set-index="${setIndex}">
                            <div style="width: 32px; height: 32px; background: #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; color: var(--text-muted);" class="lift-icon">${setNumber}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">Set ${setNumber}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 500;">${weight}kg × ${reps} reps</div>
                            </div>
                            <div class="select-chip" style="font-size: 0.7rem; font-weight: 700; color: var(--primary); border: 1.5px solid var(--primary); padding: 3px 8px; border-radius: 15px;">SELECT</div>
                        </div>
                `;
            });

            liftHtml += `
                    </div>
                </div>
            `;
            exerciseIndex++;
        });

        liftList.innerHTML = liftHtml;
    } else {
        liftSection.style.display = 'none';
    }

    // Show modal
    modal.style.display = 'block';

    // Load group chats
    chatsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading chats...</div>';
    noChats.style.display = 'none';

    try {
        const { data: chats, error } = await window.supabaseClient.rpc('get_user_group_chats', {
            user_uuid: window.currentUser.id
        });

        if (error) throw error;

        if (!chats || chats.length === 0) {
            chatsList.innerHTML = '';
            noChats.style.display = 'block';
        } else {
            noChats.style.display = 'none';
            chatsList.innerHTML = chats.map(chat => `
                <div onclick="quickShareToChat('${chat.chat_id}', '${escapeHtml(chat.chat_name)}')" style="background: #f8fafc; padding: 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f8fafc'">
                    <div style="width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), #4ade80); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem;">
                        ${chat.chat_name.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-main);">${escapeHtml(chat.chat_name)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${chat.member_count} members</div>
                    </div>
                    <div style="color: var(--primary); font-weight: 600;">Share →</div>
                </div>
            `).join('');
        }
    } catch(e) {
        console.error('Error loading group chats for quick share:', e);
        chatsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Failed to load chats. Try again.</div>';
    }
}

function closeQuickShareModal() {
    document.getElementById('quick-share-modal').style.display = 'none';
    selectedLiftToShare = null;
    shareSelection = { mode: 'best', selectedExercise: null, selectedSetIndices: [] };
}

// Toggle exercise dropdown to show/hide individual sets
function toggleExerciseDropdown(exerciseId) {
    const dropdown = document.getElementById(exerciseId);
    const arrow = document.getElementById(exerciseId + '-arrow');

    if (!dropdown) return;

    const isExpanded = dropdown.style.display !== 'none';

    if (isExpanded) {
        dropdown.style.display = 'none';
        if (arrow) arrow.style.transform = 'rotate(0deg)';
    } else {
        dropdown.style.display = 'block';
        if (arrow) arrow.style.transform = 'rotate(180deg)';
    }
}

// Select share mode (entire_workout, best, etc.)
function selectShareMode(mode) {
    shareSelection.mode = mode;
    shareSelection.selectedExercise = null;
    shareSelection.selectedSetIndices = [];
    selectedLiftToShare = null;

    updateShareSelectionUI();
    updateSharePreview();
}

// Select all sets from a specific exercise
function selectExerciseAllSets(exerciseName) {
    shareSelection.mode = 'exercise_all';
    shareSelection.selectedExercise = exerciseName;
    shareSelection.selectedSetIndices = [];
    selectedLiftToShare = null;

    // Get all set indices for this exercise
    if (completedWorkoutDataForShare && completedWorkoutDataForShare.sets) {
        completedWorkoutDataForShare.sets.forEach((set, index) => {
            const setExercise = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
            if (setExercise === exerciseName) {
                shareSelection.selectedSetIndices.push(index);
            }
        });
    }

    updateShareSelectionUI();
    updateSharePreview();
}

// Toggle selection of individual sets (multi-select)
function toggleSetSelection(setIndex) {
    const idx = shareSelection.selectedSetIndices.indexOf(setIndex);

    if (idx === -1) {
        // Add to selection
        shareSelection.selectedSetIndices.push(setIndex);
    } else {
        // Remove from selection
        shareSelection.selectedSetIndices.splice(idx, 1);
    }

    // Update mode based on selection
    if (shareSelection.selectedSetIndices.length === 0) {
        shareSelection.mode = 'best';
    } else if (shareSelection.selectedSetIndices.length === 1) {
        shareSelection.mode = 'multi_select';
        selectedLiftToShare = shareSelection.selectedSetIndices[0]; // Keep legacy compatibility
    } else {
        shareSelection.mode = 'multi_select';
        selectedLiftToShare = null;
    }

    shareSelection.selectedExercise = null;

    updateShareSelectionUI();
    updateSharePreview();

    // Show multi-select hint when user has selected something
    const hint = document.getElementById('multi-select-hint');
    if (hint && shareSelection.selectedSetIndices.length > 0 && shareSelection.selectedSetIndices.length < 3) {
        hint.style.display = 'block';
    } else if (hint) {
        hint.style.display = 'none';
    }
}

// Update the visual state of all selection options
function updateShareSelectionUI() {
    const liftList = document.getElementById('lift-selection-list');
    if (!liftList) return;

    // Reset all share mode options
    const modeOptions = liftList.querySelectorAll('.share-mode-option');
    modeOptions.forEach(opt => {
        const isSelected = (shareSelection.mode === 'entire_workout' && opt.id === 'share-option-workout') ||
                          (shareSelection.mode === 'best' && opt.id === 'share-option-best');

        if (opt.id === 'share-option-workout') {
            // Entire workout option
            if (isSelected) {
                opt.style.background = 'linear-gradient(135deg, #166534, #22c55e)';
                opt.style.boxShadow = '0 4px 12px rgba(22, 101, 52, 0.4)';
            } else {
                opt.style.background = 'linear-gradient(135deg, #7ba883, #4ade80)';
                opt.style.boxShadow = '0 4px 12px rgba(123, 168, 131, 0.3)';
            }
            const chip = opt.querySelector('.select-chip');
            if (chip) chip.innerText = isSelected ? '✓ SELECTED' : 'SELECT';
        } else if (opt.id === 'share-option-best') {
            // Best achievement option
            opt.style.background = isSelected ? 'var(--primary)' : 'white';
            opt.style.color = isSelected ? 'white' : 'var(--text-main)';
            opt.style.borderColor = isSelected ? 'var(--primary)' : '#edf2f7';
            const chip = opt.querySelector('.select-chip');
            if (chip) chip.innerText = isSelected ? '✓' : 'SELECT';
            // Update text colors
            const subtextDiv = opt.querySelector('div > div:last-child');
            if (subtextDiv) {
                subtextDiv.style.opacity = isSelected ? '0.9' : '1';
                subtextDiv.style.color = isSelected ? '' : 'var(--text-muted)';
            }
        }
    });

    // Reset all share-all options for exercises
    const shareAllOptions = liftList.querySelectorAll('.share-all-option');
    shareAllOptions.forEach(opt => {
        const exerciseGroup = opt.closest('.exercise-group');
        const exerciseName = exerciseGroup ? exerciseGroup.dataset.exercise : null;
        const isSelected = shareSelection.mode === 'exercise_all' && shareSelection.selectedExercise === exerciseName;

        if (isSelected) {
            opt.style.background = '#16a34a';
            opt.style.borderColor = '#16a34a';
            opt.style.borderStyle = 'solid';
            opt.querySelectorAll('div').forEach(div => {
                div.style.color = 'white';
            });
            const chip = opt.querySelector('.select-chip');
            if (chip) {
                chip.style.color = 'white';
                chip.style.borderColor = 'white';
                chip.innerText = '✓ SELECTED';
            }
        } else {
            opt.style.background = '#f0fdf4';
            opt.style.borderColor = '#86efac';
            opt.style.borderStyle = 'dashed';
            const iconDiv = opt.querySelector('div:first-child');
            if (iconDiv) iconDiv.style.color = '';
            const textDivs = opt.querySelectorAll('div > div');
            textDivs.forEach((div, i) => {
                div.style.color = i === 0 ? '#166534' : '#15803d';
            });
            const chip = opt.querySelector('.select-chip');
            if (chip) {
                chip.style.color = '#16a34a';
                chip.style.borderColor = '#16a34a';
                chip.innerText = 'SELECT';
            }
        }
    });

    // Update individual lift options for multi-select
    const liftOptions = liftList.querySelectorAll('.lift-option');
    liftOptions.forEach(opt => {
        const setIndex = parseInt(opt.dataset.setIndex);
        if (isNaN(setIndex)) return;

        const isSelected = shareSelection.selectedSetIndices.includes(setIndex);

        if (isSelected) {
            opt.style.background = 'var(--primary)';
            opt.style.borderColor = 'var(--primary)';
            opt.style.color = 'white';
            const icon = opt.querySelector('.lift-icon');
            if (icon) {
                icon.style.background = 'rgba(255,255,255,0.2)';
                icon.style.color = 'white';
            }
            const chip = opt.querySelector('.select-chip');
            if (chip) {
                chip.style.color = 'white';
                chip.style.borderColor = 'white';
                chip.innerText = '✓';
            }
            // Update text colors
            opt.querySelectorAll('div').forEach(div => {
                if (div.style.fontWeight === '600' || div.style.fontWeight === '700') {
                    div.style.color = 'white';
                } else if (div.style.fontSize && div.style.fontSize.includes('0.8')) {
                    div.style.color = 'rgba(255,255,255,0.8)';
                }
            });
        } else {
            opt.style.background = 'white';
            opt.style.borderColor = '#edf2f7';
            opt.style.color = '';
            const icon = opt.querySelector('.lift-icon');
            if (icon) {
                icon.style.background = '#e2e8f0';
                icon.style.color = 'var(--text-muted)';
            }
            const chip = opt.querySelector('.select-chip');
            if (chip) {
                chip.style.color = 'var(--primary)';
                chip.style.borderColor = 'var(--primary)';
                chip.innerText = 'SELECT';
            }
            // Reset text colors
            opt.querySelectorAll('div').forEach(div => {
                if (div.style.fontWeight === '600' || div.style.fontWeight === '700') {
                    div.style.color = 'var(--text-main)';
                } else if (div.style.fontSize && div.style.fontSize.includes('0.8')) {
                    div.style.color = 'var(--text-muted)';
                }
            });
        }
    });
}

// Update the share preview based on selected lift
function updateSharePreview() {
    const badge = document.getElementById('quick-share-badge');
    const message = document.getElementById('quick-share-message');
    const detail = document.getElementById('quick-share-detail');

    if (!completedWorkoutDataForShare) {
        badge.innerText = '💪';
        message.innerText = 'Workout completed!';
        detail.innerText = '';
        return;
    }

    const { improvements, milestones, workoutName, sets } = completedWorkoutDataForShare;

    // Handle different share modes
    switch (shareSelection.mode) {
        case 'entire_workout': {
            // Group sets by exercise for summary
            const exerciseSets = {};
            (sets || []).forEach(set => {
                const name = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
                if (!exerciseSets[name]) exerciseSets[name] = [];
                exerciseSets[name].push(set);
            });
            const exerciseCount = Object.keys(exerciseSets).length;
            const totalSets = (sets || []).length;

            badge.innerText = '📋';
            message.innerText = `Complete ${workoutName} Workout`;
            detail.innerText = `${exerciseCount} exercise${exerciseCount > 1 ? 's' : ''} • ${totalSets} set${totalSets > 1 ? 's' : ''} total`;
            return;
        }

        case 'exercise_all': {
            // Sharing all sets of one exercise
            const exerciseName = shareSelection.selectedExercise;
            const exerciseSets = (sets || []).filter(s => (s.exercise || s.exercise_name || s.exerciseName) === exerciseName);
            const setCount = exerciseSets.length;

            // Build summary of sets
            let setsSummary = exerciseSets.map(s => {
                const w = s.kg || s.weight_kg || 0;
                const r = s.reps || 0;
                return `${w}kg×${r}`;
            }).join(', ');

            badge.innerText = '📊';
            message.innerText = `${exerciseName} - All ${setCount} Sets`;
            detail.innerText = setsSummary;
            return;
        }

        case 'multi_select': {
            // Multiple sets selected
            const selectedSets = shareSelection.selectedSetIndices.map(i => sets[i]).filter(Boolean);
            const count = selectedSets.length;

            if (count === 1) {
                // Single set selected
                const set = selectedSets[0];
                const exerciseName = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
                const weight = set.kg || set.weight_kg || 0;
                const reps = set.reps || 0;

                badge.innerText = '💪';
                message.innerText = `${exerciseName}`;
                detail.innerText = `${weight}kg × ${reps} reps`;
            } else {
                // Multiple sets selected - group by exercise
                const byExercise = {};
                selectedSets.forEach(set => {
                    const name = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
                    if (!byExercise[name]) byExercise[name] = [];
                    byExercise[name].push(set);
                });

                const exerciseNames = Object.keys(byExercise);
                if (exerciseNames.length === 1) {
                    // All from same exercise
                    const name = exerciseNames[0];
                    const setsSummary = byExercise[name].map(s => {
                        const w = s.kg || s.weight_kg || 0;
                        const r = s.reps || 0;
                        return `${w}kg×${r}`;
                    }).join(', ');

                    badge.innerText = '💪';
                    message.innerText = `${name} - ${count} Sets`;
                    detail.innerText = setsSummary;
                } else {
                    // Multiple exercises
                    const summary = exerciseNames.map(name => {
                        return `${name} (${byExercise[name].length})`;
                    }).join(', ');

                    badge.innerText = '🏋️';
                    message.innerText = `${count} Sets from ${exerciseNames.length} Exercises`;
                    detail.innerText = summary;
                }
            }
            return;
        }

        case 'best':
        default: {
            // Legacy: single lift selected via old method
            if (selectedLiftToShare !== null && sets && sets[selectedLiftToShare]) {
                const set = sets[selectedLiftToShare];
                const exerciseName = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
                const weight = set.kg || set.weight_kg || 0;
                const reps = set.reps || 0;

                badge.innerText = '💪';
                message.innerText = `${exerciseName}`;
                detail.innerText = `${weight}kg × ${reps} reps`;
                return;
            }

            // Default: show best achievement or workout complete
            if (improvements && improvements.length > 0) {
                const imp = improvements[0];
                let improvementText = '';
                if (imp.weightIncrease > 0 && imp.repsIncrease > 0) {
                    improvementText = `+${imp.weightIncrease}kg and +${imp.repsIncrease} reps`;
                } else if (imp.weightIncrease > 0) {
                    improvementText = `+${imp.weightIncrease}kg`;
                } else if (imp.repsIncrease > 0) {
                    improvementText = `+${imp.repsIncrease} reps`;
                }
                badge.innerText = '🏆';
                message.innerText = `Hit a PR on ${imp.exercise}!`;
                detail.innerText = `${improvementText} (${imp.previousWeight || 0}kg x ${imp.previousReps || 0} → ${imp.currentWeight || 0}kg x ${imp.currentReps || 0})`;
            } else if (milestones && milestones.length > 0) {
                const m = milestones[0];
                const emoji = m.milestone_value === 1 ? '🎉' : m.milestone_value >= 100 ? '👑' : m.milestone_value >= 50 ? '🏆' : m.milestone_value >= 25 ? '🌟' : m.milestone_value >= 10 ? '🔥' : '💪';
                badge.innerText = emoji;
                message.innerText = m.message;
                detail.innerText = '';
            } else {
                badge.innerText = '💪';
                message.innerText = `Just finished ${workoutName}!`;
                detail.innerText = 'Workout completed';
            }
        }
    }
}

// Select a specific lift to share (legacy function - now uses the new flexible selection system)
function selectLiftToShare(setIndex) {
    if (setIndex === null) {
        // Select "best achievement" mode
        selectShareMode('best');
    } else {
        // Use toggle to select/deselect specific set
        // First clear any other selections to behave like the old single-select
        shareSelection.selectedSetIndices = [setIndex];
        shareSelection.mode = 'multi_select';
        shareSelection.selectedExercise = null;
        selectedLiftToShare = setIndex;
        updateShareSelectionUI();
        updateSharePreview();
    }
}

// Get the current share data based on selection
function getShareData() {
    if (!completedWorkoutDataForShare) {
        return { message: 'Just crushed a workout! 💪', type: 'workout_complete', details: {} };
    }

    const { improvements, milestones, workoutName, sets, duration } = completedWorkoutDataForShare;

    // Handle different share modes
    switch (shareSelection.mode) {
        case 'entire_workout': {
            // Share entire workout with all exercises and sets
            const exerciseSets = {};
            (sets || []).forEach(set => {
                const name = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
                if (!exerciseSets[name]) exerciseSets[name] = [];
                exerciseSets[name].push(set);
            });

            const exerciseCount = Object.keys(exerciseSets).length;
            const totalSets = (sets || []).length;

            // Build detailed workout summary
            let workoutSummary = Object.entries(exerciseSets).map(([exercise, exSets]) => {
                const setsInfo = exSets.map(s => {
                    const w = s.kg || s.weight_kg || 0;
                    const r = s.reps || 0;
                    return `${w}kg×${r}`;
                }).join(', ');
                return `${exercise}: ${setsInfo}`;
            }).join('\n');

            return {
                message: `Completed ${workoutName}! 📋\n${exerciseCount} exercises, ${totalSets} sets total`,
                type: 'entire_workout',
                details: {
                    workoutName,
                    duration,
                    exerciseCount,
                    totalSets,
                    exercises: exerciseSets,
                    summary: workoutSummary
                }
            };
        }

        case 'exercise_all': {
            // Share all sets from a specific exercise
            const exerciseName = shareSelection.selectedExercise;
            const exerciseSets = (sets || []).filter(s => (s.exercise || s.exercise_name || s.exerciseName) === exerciseName);
            const setCount = exerciseSets.length;

            const setsInfo = exerciseSets.map((s, i) => {
                const w = s.kg || s.weight_kg || 0;
                const r = s.reps || 0;
                return `Set ${i + 1}: ${w}kg × ${r} reps`;
            }).join(', ');

            return {
                message: `Crushed ${exerciseName}! 📊\n${setCount} sets: ${setsInfo}`,
                type: 'exercise_all_sets',
                details: {
                    workoutName,
                    exercise: exerciseName,
                    setCount,
                    sets: exerciseSets.map(s => ({
                        weight: s.kg || s.weight_kg || 0,
                        reps: s.reps || 0
                    }))
                }
            };
        }

        case 'multi_select': {
            // Share multiple selected sets
            const selectedSets = shareSelection.selectedSetIndices.map(i => sets[i]).filter(Boolean);
            const count = selectedSets.length;

            if (count === 1) {
                // Single set
                const set = selectedSets[0];
                const exerciseName = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
                const weight = set.kg || set.weight_kg || 0;
                const reps = set.reps || 0;

                return {
                    message: `Crushed ${exerciseName}: ${weight}kg × ${reps} reps! 💪`,
                    type: 'specific_lift',
                    details: { workoutName, exercise: exerciseName, weight, reps }
                };
            }

            // Multiple sets - group by exercise
            const byExercise = {};
            selectedSets.forEach(set => {
                const name = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
                if (!byExercise[name]) byExercise[name] = [];
                byExercise[name].push(set);
            });

            const exerciseNames = Object.keys(byExercise);
            let messageText;
            if (exerciseNames.length === 1) {
                const name = exerciseNames[0];
                const setsInfo = byExercise[name].map(s => {
                    const w = s.kg || s.weight_kg || 0;
                    const r = s.reps || 0;
                    return `${w}kg×${r}`;
                }).join(', ');
                messageText = `Crushed ${name}! 💪\n${count} sets: ${setsInfo}`;
            } else {
                const summaryParts = exerciseNames.map(name => {
                    const exSets = byExercise[name];
                    const setsInfo = exSets.map(s => {
                        const w = s.kg || s.weight_kg || 0;
                        const r = s.reps || 0;
                        return `${w}kg×${r}`;
                    }).join(', ');
                    return `${name}: ${setsInfo}`;
                });
                messageText = `Crushed ${count} sets! 🏋️\n${summaryParts.join('\n')}`;
            }

            return {
                message: messageText,
                type: 'multi_sets',
                details: {
                    workoutName,
                    setCount: count,
                    exerciseCount: exerciseNames.length,
                    exercises: byExercise
                }
            };
        }

        case 'best':
        default: {
            // Legacy: single lift selected via old method
            if (selectedLiftToShare !== null && sets && sets[selectedLiftToShare]) {
                const set = sets[selectedLiftToShare];
                const exerciseName = set.exercise || set.exercise_name || set.exerciseName || 'Exercise';
                const weight = set.kg || set.weight_kg || 0;
                const reps = set.reps || 0;

                return {
                    message: `Crushed ${exerciseName}: ${weight}kg × ${reps} reps! 💪`,
                    type: 'specific_lift',
                    details: { workoutName, exercise: exerciseName, weight, reps }
                };
            }

            // Default: best achievement
            if (improvements && improvements.length > 0) {
                const imp = improvements[0];
                let improvementText = '';
                if (imp.weightIncrease > 0 && imp.repsIncrease > 0) {
                    improvementText = `+${imp.weightIncrease}kg and +${imp.repsIncrease} reps`;
                } else if (imp.weightIncrease > 0) {
                    improvementText = `+${imp.weightIncrease}kg`;
                } else if (imp.repsIncrease > 0) {
                    improvementText = `+${imp.repsIncrease} reps`;
                }
                return {
                    message: `Hit a PR on ${imp.exercise}! ${improvementText} 🏆`,
                    type: 'personal_best',
                    details: {
                        workoutName,
                        exercise: imp.exercise,
                        improvement: improvementText,
                        previousWeight: imp.previousWeight,
                        previousReps: imp.previousReps,
                        currentWeight: imp.currentWeight,
                        currentReps: imp.currentReps
                    }
                };
            }

            if (milestones && milestones.length > 0) {
                const m = milestones[0];
                return {
                    message: `${m.message} 🌟`,
                    type: 'milestone',
                    details: { workoutName, milestone: m.message, value: m.milestone_value }
                };
            }

            return {
                message: `Just finished ${workoutName}! 💪`,
                type: 'workout_complete',
                details: { workoutName, duration }
            };
        }
    }
}

async function quickShareToChat(chatId, chatName) {
    if (!completedWorkoutDataForShare) {
        showToast('No workout data to share', 'error');
        return;
    }

    // Get share data based on current selection
    const shareData = getShareData();

    try {
        const { error } = await window.supabaseClient
            .from('group_chat_messages')
            .insert({
                group_chat_id: chatId,
                user_id: window.currentUser.id,
                message: shareData.message,
                is_win_share: true,
                win_type: shareData.type,
                win_details: shareData.details
            });

        if (error) throw error;

        closeQuickShareModal();
        showToast(`Shared to ${chatName}! 🎉`, 'success');
    } catch(e) {
        console.error('Error sharing to group chat:', e);
        showToast('Failed to share. Try again.', 'error');
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Build share message for external sharing (uses selected lift if any)
function buildWinShareMessage() {
    const shareData = getShareData();

    // Add branding for external shares based on share type
    switch (shareData.type) {
        case 'entire_workout':
            return `📋 ${shareData.message}\n\nTraining with Balance 🌱`;
        case 'exercise_all_sets':
            return `📊 ${shareData.message}\n\nTraining with Balance 🌱`;
        case 'multi_sets':
            return `🏋️ ${shareData.message}\n\nTraining with Balance 🌱`;
        case 'specific_lift':
            return `${shareData.message} Training with Balance 🌱`;
        case 'personal_best':
            return `🏆 ${shareData.message} Training with Balance 🌱`;
        case 'milestone':
            return `🌟 ${shareData.message} Training with Balance 🌱`;
        default:
            return `${shareData.message} Training with Balance 🌱`;
    }
}

// Share win to Facebook Messenger
function shareWinToMessenger() {
    const message = buildWinShareMessage();
    const appLink = window.location.origin;

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
        // Messenger deep link with text
        const messengerUrl = `fb-messenger://share?link=${encodeURIComponent(appLink)}&quote=${encodeURIComponent(message)}`;
        window.location.href = messengerUrl;
    } else {
        // Desktop FB Sharer fallback
        const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(appLink)}&quote=${encodeURIComponent(message)}`;
        window.open(fbUrl, '_blank', 'width=600,height=400');
    }

    // Close modal after short delay
    setTimeout(() => {
        closeQuickShareModal();
        showToast('Opening Share Dialog...', 'success');
    }, 300);
}

// Share win to WhatsApp
function shareWinToWhatsApp() {
    const message = buildWinShareMessage();

    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');

    closeQuickShareModal();
    showToast('Opening WhatsApp...', 'success');
}

// Copy win message to clipboard
async function copyWinMessage() {
    const message = buildWinShareMessage();

    try {
        await navigator.clipboard.writeText(message);
        closeQuickShareModal();
        showToast('Copied to clipboard! 📋', 'success');
    } catch(e) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = message;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        closeQuickShareModal();
        showToast('Copied to clipboard! 📋', 'success');
    }
}

// ===========================
// SWIPE BACK NAVIGATION SYSTEM
// ===========================

// Platform detection for adaptive navigation
function getPlatform() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;

    // iOS detection
    if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        return 'ios';
    }

    // Android detection
    if (/android/i.test(userAgent)) {
        return 'android';
    }

    // Default to iOS-style for other platforms (web browsers, etc.)
    return 'ios';
}

// Store platform once at startup for consistent behavior
const devicePlatform = getPlatform();

function enableSwipeBackNavigation(viewId, backHandler) {
    const view = document.getElementById(viewId);
    if (!view) return;

    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isDragging = false;
    let overlayEl = null;

    const screenWidth = window.innerWidth;
    const isAndroid = devicePlatform === 'android';

    // Edge zone: 50px from the appropriate edge
    const edgeThreshold = 50;

    const handleTouchStart = (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isDragging = false;
    };

    const handleTouchMove = (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = Math.abs(e.changedTouches[0].screenY - touchStartY);

        // Platform-adaptive edge detection:
        // iOS: Swipe from LEFT edge, moving RIGHT (deltaX > 0)
        // Android: Swipe from RIGHT edge, moving LEFT (deltaX < 0)
        const isFromCorrectEdge = isAndroid
            ? (touchStartX > screenWidth - edgeThreshold && deltaX < -30)  // Right edge, swipe left
            : (touchStartX < edgeThreshold && deltaX > 30);                 // Left edge, swipe right

        const absDeltaX = Math.abs(deltaX);

        if (isFromCorrectEdge && deltaY < 100) {
            isDragging = true;

            // Create visual feedback overlay
            if (!overlayEl) {
                overlayEl = document.createElement('div');
                overlayEl.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.1);
                    pointer-events: none;
                    z-index: 9998;
                    opacity: 0;
                    transition: opacity 0.1s;
                `;
                document.body.appendChild(overlayEl);
            }

            // Transform the view based on swipe distance
            // iOS: slide right (positive), Android: slide left (negative)
            const progress = Math.min(absDeltaX / 200, 1);
            const translateX = isAndroid ? deltaX : deltaX;
            view.style.transform = `translateX(${translateX}px)`;
            view.style.transition = 'none';
            overlayEl.style.opacity = progress * 0.3;
        }
    };

    const handleTouchEnd = (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = Math.abs(touchEndY - touchStartY);
        const absDeltaX = Math.abs(deltaX);

        // Platform-adaptive completion check
        const isValidSwipe = isAndroid
            ? (touchStartX > screenWidth - edgeThreshold && deltaX < -100)  // Right edge, swiped left enough
            : (touchStartX < edgeThreshold && deltaX > 100);                 // Left edge, swiped right enough

        if (isValidSwipe && deltaY < 100 && isDragging) {
            // Animate out in the appropriate direction
            const exitDirection = isAndroid ? '-100%' : '100%';
            view.style.transition = 'transform 0.3s ease-out';
            view.style.transform = `translateX(${exitDirection})`;

            // Call back handler after animation
            setTimeout(() => {
                backHandler();
                view.style.transform = '';
                view.style.transition = '';
                if (overlayEl) {
                    overlayEl.remove();
                    overlayEl = null;
                }
            }, 300);
        } else if (isDragging) {
            // Reset position if swipe wasn't far enough
            view.style.transition = 'transform 0.3s ease-out';
            view.style.transform = '';
            setTimeout(() => {
                view.style.transition = '';
                if (overlayEl) {
                    overlayEl.remove();
                    overlayEl = null;
                }
            }, 300);
        }

        isDragging = false;
    };

    // Remove existing listeners to avoid duplicates
    view.removeEventListener('touchstart', handleTouchStart);
    view.removeEventListener('touchmove', handleTouchMove);
    view.removeEventListener('touchend', handleTouchEnd);

    // Add touch listeners
    view.addEventListener('touchstart', handleTouchStart, { passive: true });
    view.addEventListener('touchmove', handleTouchMove, { passive: true });
    view.addEventListener('touchend', handleTouchEnd, { passive: true });
}

// Initialize swipe-back navigation for all movement views
function initializeMovementSwipeNavigation() {
    // Main movement views
    enableSwipeBackNavigation('view-workout-library', () => {
        switchAppTab('movement-tab');
    });

    enableSwipeBackNavigation('view-prebuilt-programs', () => {
        switchAppTab('movement-tab');
    });

    enableSwipeBackNavigation('view-workout-subcategories', () => {
        closeWorkoutSubcategories();
    });

    enableSwipeBackNavigation('view-workout-list', () => {
        closeWorkoutList();
    });

    enableSwipeBackNavigation('view-workout-overview', () => {
        switchAppTab('movement-tab');
    });

    enableSwipeBackNavigation('view-active-workout', () => {
        quitWorkout();
    });

    enableSwipeBackNavigation('view-workout-success', () => {
        closeSuccessScreen();
    });

    // Log activity view
    enableSwipeBackNavigation('view-log-activity', () => {
        closeLogActivity();
    });

    // Your Workouts view
    enableSwipeBackNavigation('view-your-workouts', () => {
        closeYourWorkouts();
    });

    // Progress view
    enableSwipeBackNavigation('view-progress', () => {
        closeProgressView();
    });

    // Activity success view
    enableSwipeBackNavigation('view-activity-success', () => {
        closeActivitySuccess();
    });

    // Workout builder view
    enableSwipeBackNavigation('view-workout-builder', () => {
        switchAppTab('movement-tab');
    });

    // Program builder view
    enableSwipeBackNavigation('view-program-builder', () => {
        closeProgramBuilder();
    });

    // Challenge views
    enableSwipeBackNavigation('challenge-leaderboard-modal', () => {
        closeChallengeLeaderboard();
    });
}

// Initialize swipe-back for Weekly Trends page (one-time setup)
function initializeWeeklyTrendsSwipeNavigation() {
    enableSwipeBackNavigation('weekly-trends-page', () => {
        const page = document.getElementById('weekly-trends-page');
        if (page) {
            // Immediately hide (display:none) so gesture cleanup doesn't flash
            page.classList.remove('active');
            page.style.transform = '';
            page.style.transition = '';
        }
        // Return to Nutrition tab
        const mealsBtn = document.querySelector('.bottom-nav .nav-item[onclick*="meals"]');
        if (mealsBtn) {
            switchAppTab('meals', mealsBtn);
        }
    });
}

function initializeMovementWeeklyTrendsSwipeNavigation() {
    enableSwipeBackNavigation('movement-weekly-trends-page', () => {
        const page = document.getElementById('movement-weekly-trends-page');
        if (page) {
            page.classList.remove('active');
            page.style.transform = '';
            page.style.transition = '';
        }
        // Return to Movement tab
        const movementBtn = document.querySelector('.bottom-nav .nav-item[onclick*="movement"]');
        if (movementBtn) {
            switchAppTab('movement-tab', movementBtn);
        }
    });
}

// Dynamic swipe-back for views that swap content in a single container (e.g. Learning tab)
function enableDynamicSwipeBackNavigation(viewId, getBackHandler) {
    const view = document.getElementById(viewId);
    if (!view) return;

    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isDragging = false;
    let overlayEl = null;
    let currentBackHandler = null;

    const screenWidth = window.innerWidth;
    const isAndroid = devicePlatform === 'android';
    const edgeThreshold = 50;

    const handleTouchStart = (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isDragging = false;
        currentBackHandler = getBackHandler();
    };

    const handleTouchMove = (e) => {
        if (!currentBackHandler) return;

        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = Math.abs(e.changedTouches[0].screenY - touchStartY);

        const isFromCorrectEdge = isAndroid
            ? (touchStartX > screenWidth - edgeThreshold && deltaX < -30)
            : (touchStartX < edgeThreshold && deltaX > 30);

        const absDeltaX = Math.abs(deltaX);

        if (isFromCorrectEdge && deltaY < 100) {
            isDragging = true;

            if (!overlayEl) {
                overlayEl = document.createElement('div');
                overlayEl.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.1); pointer-events: none;
                    z-index: 9998; opacity: 0; transition: opacity 0.1s;
                `;
                document.body.appendChild(overlayEl);
            }

            const progress = Math.min(absDeltaX / 200, 1);
            view.style.transform = `translateX(${deltaX}px)`;
            view.style.transition = 'none';
            overlayEl.style.opacity = progress * 0.3;
        }
    };

    const handleTouchEnd = (e) => {
        if (!currentBackHandler) return;

        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = Math.abs(touchEndY - touchStartY);

        const isValidSwipe = isAndroid
            ? (touchStartX > screenWidth - edgeThreshold && deltaX < -100)
            : (touchStartX < edgeThreshold && deltaX > 100);

        if (isValidSwipe && deltaY < 100 && isDragging) {
            const exitDirection = isAndroid ? '-100%' : '100%';
            view.style.transition = 'transform 0.3s ease-out';
            view.style.transform = `translateX(${exitDirection})`;

            setTimeout(() => {
                currentBackHandler();
                view.style.transform = '';
                view.style.transition = '';
                if (overlayEl) {
                    overlayEl.remove();
                    overlayEl = null;
                }
            }, 300);
        } else if (isDragging) {
            view.style.transition = 'transform 0.3s ease-out';
            view.style.transform = '';
            setTimeout(() => {
                view.style.transition = '';
                if (overlayEl) {
                    overlayEl.remove();
                    overlayEl = null;
                }
            }, 300);
        }

        isDragging = false;
    };

    view.addEventListener('touchstart', handleTouchStart, { passive: true });
    view.addEventListener('touchmove', handleTouchMove, { passive: true });
    view.addEventListener('touchend', handleTouchEnd, { passive: true });
}

// Initialize swipe-back for Learning tab with dynamic back handler
function initializeLearningSwipeNavigation() {
    enableDynamicSwipeBackNavigation('view-learning', () => {
        if (typeof window.getLearningBackAction === 'function') {
            const backAction = window.getLearningBackAction();
            if (backAction) {
                // Wrap the back action to also pop the browser history state,
                // keeping the custom swipe handler in sync with history.pushState
                // entries pushed by the learning navigation functions.
                return () => {
                    // Prevent the back action from pushing new history states
                    if (typeof window._setLearningNavigatingBack === 'function') {
                        window._setLearningNavigatingBack(true);
                    }
                    backAction();
                    if (typeof window._setLearningNavigatingBack === 'function') {
                        window._setLearningNavigatingBack(false);
                    }
                    // Pop the corresponding history entry
                    if (typeof window._popLearningHistoryState === 'function') {
                        window._learningSwipeHandledBack = true;
                        window._popLearningHistoryState();
                        history.back();
                    }
                };
            }
        }
        return null;
    });
}

// Initialize swipe-back for the user (friend) profile page
function initializeUserProfileSwipeNavigation() {
    enableSwipeBackNavigation('view-user-profile', () => {
        closeUserProfile();
    });
}

// Initialize swipe navigation when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    initializeMovementSwipeNavigation();
    initializeWeeklyTrendsSwipeNavigation();
    initializeMovementWeeklyTrendsSwipeNavigation();
    initializeLearningSwipeNavigation();
    initializeUserProfileSwipeNavigation();
    initializeAndroidBackNavigation();
});

// ===========================
// ANDROID HARDWARE BACK BUTTON SUPPORT
// ===========================

// Navigation stack for Android back button
const navigationStack = [];

function pushNavigationState(viewId, backHandler) {
    // Only use history-based navigation on Android
    if (devicePlatform !== 'android') return;

    const state = { viewId, timestamp: Date.now() };
    navigationStack.push({ viewId, backHandler });
    history.pushState(state, '', window.location.href);
}

function popNavigationState() {
    return navigationStack.pop();
}

function clearNavigationStack() {
    navigationStack.length = 0;
}

function initializeAndroidBackNavigation() {
    // Only set up on Android
    if (devicePlatform !== 'android') return;

    // Handle browser/hardware back button via popstate
    window.addEventListener('popstate', (event) => {
        const navItem = popNavigationState();
        if (navItem && navItem.backHandler) {
            // Execute the back handler
            navItem.backHandler();
        }
    });
}

// Helper to navigate to a view with back support (Android)
function navigateToView(viewId, backHandler) {
    pushNavigationState(viewId, backHandler);
}

// ===========================
// WORKOUT LIBRARY FUNCTIONS
// ===========================

function openWorkoutLibrary() {
    renderWorkoutLibraryCategories();
    hideAllAppViews();
    document.getElementById('view-workout-library').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-library', () => switchAppTab('movement-tab'));
}

function renderWorkoutLibraryCategories() {
    const grid = document.getElementById('library-categories-grid');
    grid.innerHTML = '';

    Object.keys(WORKOUT_LIBRARY).forEach(categoryKey => {
        const category = WORKOUT_LIBRARY[categoryKey];

        grid.innerHTML += `
            <div class="library-category-card" onclick="openWorkoutSubcategories('${categoryKey}')">
                <div class="library-category-icon">${category.icon}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${category.name}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;">${category.description}</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--text-muted);">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        `;
    });
}

function openWorkoutSubcategories(categoryKey) {
    const category = WORKOUT_LIBRARY[categoryKey] || (typeof WORKOUT_LIBRARY_EXTENDED !== 'undefined' && WORKOUT_LIBRARY_EXTENDED[categoryKey]);

    // Set header
    document.getElementById('subcategory-header-title').textContent = category.name;
    document.getElementById('subcategory-description').textContent = category.description;

    // Render subcategories
    const grid = document.getElementById('subcategories-grid');
    grid.innerHTML = '';

    Object.keys(category.subcategories).forEach(subKey => {
        const subcategory = category.subcategories[subKey];
        const workoutCount = subcategory.workouts.length;

        grid.innerHTML += `
            <div class="library-category-card" onclick="openWorkoutList('${categoryKey}', '${subKey}')">
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${subcategory.name}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;">${subcategory.description}</div>
                    <div style="color: var(--primary); font-size: 0.8rem; font-weight: 600; margin-top: 8px;">${workoutCount} workout${workoutCount > 1 ? 's' : ''}</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--text-muted);">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        `;
    });

    // Show view
    document.getElementById('view-workout-subcategories').style.display = 'block';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-subcategories', () => closeWorkoutSubcategories());
}

function closeWorkoutSubcategories() {
    document.getElementById('view-workout-subcategories').style.display = 'none';
}

function openWorkoutList(categoryKey, subcategoryKey) {
    const category = WORKOUT_LIBRARY[categoryKey] || (typeof WORKOUT_LIBRARY_EXTENDED !== 'undefined' && WORKOUT_LIBRARY_EXTENDED[categoryKey]);
    const subcategory = category.subcategories[subcategoryKey];

    // Set header
    document.getElementById('workout-list-header-title').textContent = subcategory.name;
    document.getElementById('workout-list-description').textContent = subcategory.description;

    // Render workouts
    const list = document.getElementById('workouts-list');
    list.innerHTML = '';

    subcategory.workouts.forEach(workout => {
        const difficultyClass = `difficulty-${workout.difficulty.toLowerCase()}`;

        // Create card element
        const card = document.createElement('div');
        card.className = 'workout-card';
        card.style.cssText = 'cursor: pointer; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: rgba(4, 106, 56, 0.1);';

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 8px 0; font-size: 1.1rem;">${workout.name}</h3>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <span class="workout-difficulty-badge ${difficultyClass}">${workout.difficulty}</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">⏱ ${workout.duration}</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">📝 ${workout.exercises.length} exercises</span>
                    </div>
                </div>
            </div>
            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 10px;">
                <strong>Equipment:</strong> ${workout.equipment.join(', ')}
            </div>
        `;

        // Add click handler - directly start the workout (touch-action: manipulation already handles mobile responsiveness)
        card.addEventListener('click', () => {
            startLibraryWorkout(categoryKey, subcategoryKey, workout.id);
        });

        // Append to list
        list.appendChild(card);
    });

    // Show view
    document.getElementById('view-workout-list').style.display = 'block';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-list', () => closeWorkoutList());
}

function closeWorkoutList() {
    document.getElementById('view-workout-list').style.display = 'none';
}

// ===========================
// PRE-BUILT PROGRAMS FUNCTIONS
// ===========================

function openPrebuiltPrograms() {
    renderPrebuiltPrograms();
    hideAllAppViews();
    document.getElementById('view-prebuilt-programs').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-prebuilt-programs', () => switchAppTab('movement-tab'));
}

function renderPrebuiltPrograms() {
    const grid = document.getElementById('prebuilt-programs-grid');
    grid.innerHTML = '';

    // Define all available workout programs with their metadata
    const programs = [
        {
            key: 'gym',
            name: 'Full Gym Access',
            icon: '💪',
            description: 'Complete strength training with full gym equipment',
            gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            equipment: ['Barbell', 'Dumbbells', 'Cable Machines', 'Bench']
        },
        {
            key: 'gym_split',
            name: 'Male Gym Split',
            icon: '🏋️',
            description: '7-day gym program: Chest, Legs, Back, Shoulders, Arms+Core, Recovery',
            gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            equipment: ['Gym Access Required']
        },
        {
            key: 'female_gym_split',
            name: 'Female Gym Split',
            icon: '💫',
            description: 'Hormone-optimized 7-day split: Legs, Push, Pull, Arms, Active Recovery',
            gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            equipment: ['Gym Access Required']
        },
        {
            key: 'home_weights',
            name: 'At Home with Weights',
            icon: '🏠',
            description: 'Effective home workouts with dumbbells',
            gradient: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            equipment: ['Dumbbells', 'Bench (optional)']
        },
        {
            key: 'bodyweight',
            name: 'At Home Bodyweight',
            icon: '🤸',
            description: 'No equipment needed - train anywhere, anytime',
            gradient: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
            equipment: ['No Equipment']
        },
        {
            key: 'yoga',
            name: 'Yoga & Mindful Movement',
            icon: '🧘',
            description: 'Restorative, power, yin, and vinyasa flows',
            gradient: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
            equipment: ['Yoga Mat', 'Optional: Blocks']
        },
        {
            key: 'recovery',
            name: 'Recovery & Mobility',
            icon: '🌿',
            description: 'Stretching, mobility work, and active recovery',
            gradient: 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
            equipment: ['No Equipment']
        },
        {
            key: 'bands',
            name: 'Resistance Bands',
            icon: '🔗',
            description: 'Full body training with resistance bands',
            gradient: 'linear-gradient(135deg, #fddb92 0%, #d1fdff 100%)',
            equipment: ['Resistance Bands']
        }
    ];

    programs.forEach(program => {
        const programDiv = document.createElement('div');
        programDiv.onclick = () => openProgramDetails(program.key);
        programDiv.style.cssText = `
            cursor:pointer;
            position:relative;
            min-height:200px;
            border-radius:20px;
            overflow:hidden;
            box-shadow:0 10px 30px rgba(0,0,0,0.15);
            background: ${program.gradient};
            transition: transform 0.2s, box-shadow 0.2s;
        `;

        programDiv.onmouseenter = function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 15px 40px rgba(0,0,0,0.2)';
        };

        programDiv.onmouseleave = function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 10px 30px rgba(0,0,0,0.15)';
        };

        programDiv.innerHTML = `
            <div style="position: absolute; inset:0; background: linear-gradient(to bottom right, rgba(0,0,0,0.3), transparent);"></div>
            <div style="position: absolute; top: 20px; right: 20px; font-size: 3rem; opacity: 0.4;">${program.icon}</div>
            <div style="position: relative; padding: 25px; color: white; z-index: 1; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                <div>
                    <div style="font-size: 0.75rem; font-weight: 800; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 8px;">Program</div>
                    <div style="font-size: 1.3rem; font-weight: 800; line-height: 1.2; margin-bottom: 12px;">${program.name}</div>
                    <div style="font-size: 0.9rem; opacity: 0.95; line-height: 1.4; margin-bottom: 15px;">${program.description}</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 5px;">Equipment:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${program.equipment.map(eq => `
                            <span style="background: rgba(255,255,255,0.25); padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                ${eq}
                            </span>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        grid.appendChild(programDiv);
    });
}

function openProgramDetails(programKey) {
    // Check if program exists in WORKOUT_LIBRARY or WORKOUT_LIBRARY_EXTENDED
    let category = WORKOUT_LIBRARY[programKey] || (typeof WORKOUT_LIBRARY_EXTENDED !== 'undefined' && WORKOUT_LIBRARY_EXTENDED[programKey]);

    if (category) {
        // Open the program's subcategories view
        openWorkoutSubcategories(programKey);
    } else {
        // For gym_split and female_gym_split, show info modal
        showProgramInfoModal(programKey);
    }
}

function showProgramInfoModal(programKey) {
    const programInfo = {
        'gym_split': {
            name: 'Male Gym Split',
            schedule: [
                { day: 'Monday', workout: 'Chest Day', focus: 'Chest & Triceps' },
                { day: 'Tuesday', workout: 'Leg Day', focus: 'Quads, Hamstrings, Glutes' },
                { day: 'Wednesday', workout: 'Back Day', focus: 'Back & Biceps' },
                { day: 'Thursday', workout: 'Shoulder Day', focus: 'Shoulders & Traps' },
                { day: 'Friday', workout: 'Arms & Core', focus: 'Arms, Abs, Core' },
                { day: 'Saturday', workout: 'Active Recovery', focus: 'Yin Yoga' },
                { day: 'Sunday', workout: 'Rest', focus: 'Complete Rest' }
            ]
        },
        'female_gym_split': {
            name: 'Female Gym Split',
            schedule: [
                { day: 'Monday', workout: 'Leg Day', focus: 'Lower Body Strength' },
                { day: 'Tuesday', workout: 'Push Day', focus: 'Chest, Shoulders, Triceps' },
                { day: 'Wednesday', workout: 'Arms & Core', focus: 'Upper Body & Abs' },
                { day: 'Thursday', workout: 'Leg Day', focus: 'Lower Body Power' },
                { day: 'Friday', workout: 'Pull Day', focus: 'Back & Biceps' },
                { day: 'Saturday', workout: 'Active Recovery', focus: 'Power Yoga' },
                { day: 'Sunday', workout: 'Rest', focus: 'Yin Yoga or Rest' }
            ]
        }
    };

    const info = programInfo[programKey];
    if (!info) return;

    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;';

    modal.innerHTML = `
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: var(--text-main);">${info.name}</h2>
                <div onclick="this.parentElement.parentElement.parentElement.remove()" style="cursor: pointer; font-size: 1.5rem; color: var(--text-muted);">&times;</div>
            </div>

            <p style="color: var(--text-muted); margin-bottom: 25px;">This program is automatically assigned based on your profile. View your weekly schedule in the Movement tab.</p>

            <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 1rem; color: var(--text-main);">Weekly Schedule</h3>
                ${info.schedule.map((item, idx) => `
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: ${idx < info.schedule.length - 1 ? '1px solid #e2e8f0' : 'none'};">
                        <div>
                            <div style="font-weight: 700; color: var(--text-main);">${item.day}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 2px;">${item.focus}</div>
                        </div>
                        <div style="font-weight: 600; color: var(--primary); text-align: right;">
                            ${item.workout}
                        </div>
                    </div>
                `).join('')}
            </div>

            <button onclick="this.parentElement.parentElement.remove(); switchAppTab('movement-tab');"
                    style="width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer;">
                View Today's Workout
            </button>
        </div>
    `;

    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };

    document.body.appendChild(modal);
}

function openLibraryWorkoutOverview(categoryKey, subcategoryKey, workoutId) {
    const category = WORKOUT_LIBRARY[categoryKey];
    const subcategory = category.subcategories[subcategoryKey];
    const workout = subcategory.workouts.find(w => w.id === workoutId);

    if (!workout) {
        console.error('Workout not found:', workoutId);
        return;
    }

    // Set header
    document.getElementById('overview-header-title').textContent = 'Workout Overview';

    // Set title and meta
    document.getElementById('overview-title').textContent = workout.name;
    document.getElementById('overview-meta').textContent = `${workout.duration} · ${workout.exercises.length} Exercises`;

    // Set equipment
    const equipmentContainer = document.getElementById('overview-equipment');
    equipmentContainer.innerHTML = '';
    workout.equipment.forEach(item => {
        equipmentContainer.innerHTML += `
            <span style="background: #f1f5f9; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; color: var(--text-main);">
                ${item}
            </span>
        `;
    });

    // Set instructions - different for yoga
    const isYogaWorkout = categoryKey === 'yoga';
    const instructionsText = isYogaWorkout
        ? `This is a ${workout.difficulty.toLowerCase()} level ${subcategory.name.toLowerCase()} practice. Hold each pose for the specified time, breathing deeply and moving mindfully.`
        : `This is a ${workout.difficulty.toLowerCase()} level ${subcategory.name.toLowerCase()} workout. Complete all exercises in order, resting as needed between sets.`;
    document.getElementById('overview-instructions').textContent = instructionsText;

    // Set exercise list
    const exList = document.getElementById('overview-exercise-list');
    exList.innerHTML = '';
    workout.exercises.forEach(ex => {
        // For yoga, show time icon and duration. For others, show sets x reps
        const exerciseMetaHtml = isYogaWorkout
            ? `<div style="color:var(--text-muted); font-size:0.85rem; display:flex; align-items:center; gap:5px;">
                <svg viewBox="0 0 24 24" style="width:14px; height:14px; fill:currentColor;"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                ${ex.reps}
               </div>`
            : `<div style="color:var(--text-muted); font-size:0.85rem;">${ex.sets} sets x ${ex.reps}</div>`;

        exList.innerHTML += `
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                <div style="width:70px; height:70px; border-radius:12px; background:#f1f5f9; flex-shrink:0; overflow:hidden;">
                    <img src="https://placehold.co/100x100/png?text=Ex" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <div style="flex:1;">
                    <div style="font-weight:700; font-size:1.05rem;">${ex.name}</div>
                    ${exerciseMetaHtml}
                    <div style="color:var(--text-muted); font-size:0.8rem; margin-top:3px;">${ex.desc}</div>
                </div>
            </div>
        `;
    });

    // Set start button to launch library workout
    document.getElementById('btn-start-now').onclick = () => startLibraryWorkout(categoryKey, subcategoryKey, workoutId);

    // Show view
    hideAllAppViews();
    document.getElementById('view-workout-overview').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-workout-overview', () => switchAppTab('movement-tab'));
}

// Store current workout key globally for customizations
window.currentWorkoutKey = null;
window.currentWorkoutCustomizations = null;

async function startLibraryWorkout(categoryKey, subcategoryKey, workoutId) {
    const category = WORKOUT_LIBRARY[categoryKey];
    const subcategory = category.subcategories[subcategoryKey];
    const workout = subcategory.workouts.find(w => w.id === workoutId);

    if (!workout) {
        console.error('Workout not found:', workoutId);
        return;
    }

    // Clear custom workout tracking (this is a library workout, not custom)
    window.currentCustomWorkoutId = null;

    // Store current workout key for customizations
    window.currentWorkoutKey = `${categoryKey}/${subcategoryKey}/${workoutId}`;

    // Preload history if user is logged in
    const user = window.currentUser;
    let customizations = null;
    if (user) {
        try {
            const rawHistory2 = await dbHelpers.workouts.getHistory(user.id);
            window.workoutHistoryCache = normalizeHistoryCache(rawHistory2);
            // Load workout customizations
            customizations = await dbHelpers.workoutCustomizations.get(user.id, window.currentWorkoutKey);
            window.currentWorkoutCustomizations = customizations;
        } catch(e) {
            console.error("Failed to load history/customizations", e);
        }
    }

    // Build exercise list with customizations applied
    let exercises = [...workout.exercises];

    // Apply customizations if they exist
    if (customizations) {
        // Filter out removed exercises
        const removedExercises = customizations.removed_exercises || [];
        exercises = exercises.filter(ex => !removedExercises.includes(ex.name));

        // Add user-added exercises at the end
        const addedExercises = customizations.added_exercises || [];
        exercises = exercises.concat(addedExercises.map(ex => ({
            ...ex,
            isUserAdded: true
        })));
    }

    // Preload personal bests for all exercises in this workout
    if (user) {
        try {
            const exerciseNames = exercises.map(ex => ex.name);
            window.personalBestsCache = await dbHelpers.personalBests.getForExercises(user.id, exerciseNames);
        } catch(e) { console.error("Failed to load personal bests", e); window.personalBestsCache = {}; }
    }

    // Set workout title and goal
    document.getElementById('workout-player-title').textContent = workout.name;
    window.currentWorkoutName = workout.name;
    const exerciseCount = exercises.length;
    document.getElementById('workout-player-goal').textContent = `${workout.difficulty} · ${workout.duration} · ${exerciseCount} Exercise${exerciseCount !== 1 ? 's' : ''}`;

    // Start timer
    window.workoutStartTime = Date.now();
    window.workoutTimer = setInterval(() => {
        const elapsed = Date.now() - window.workoutStartTime;
        const mins = Math.floor(elapsed / 60000);
        const secs = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('workout-timer').textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    }, 1000);

    // Render exercises - use yoga-specific renderer for yoga workouts
    const isYogaWorkout = categoryKey === 'yoga';
    if (isYogaWorkout) {
        clearAllYogaTimers();
        renderYogaExercises(exercises);
    } else {
        renderWorkoutExercises(exercises);
    }

    // Show workout player
    hideAllAppViews();
    document.getElementById('view-active-workout').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-active-workout', () => quitWorkout());

    // Show total volume popup and tracker
    showLastVolumePopup();
}

// Render workout exercises with delete buttons, history summary, and volume tracking
function renderWorkoutExercises(exercises) {
    const container = document.getElementById('workout-exercises-list');
    container.innerHTML = '';

    exercises.forEach((ex, idx) => {
        const card = document.createElement('div');
        card.className = 'exercise-logger-card';
        card.setAttribute('data-exercise-name', ex.name);
        card.setAttribute('data-is-user-added', ex.isUserAdded || false);
        card.style.cssText = 'background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9;';

        const videoUrl = findVideoMatch(ex.name);
        const previousSummaryHtml = formatPreviousWorkoutSummary(ex.name);
        const previousSummary = getPreviousWorkoutSummary(ex.name);
        const isUserAdded = ex.isUserAdded || false;
        const escapedName = ex.name.replace(/'/g, "\\'");

        const prescribedSets = ex.sets || 3;
        const numSets = previousSummary && previousSummary.setCount > 0 ? previousSummary.setCount : prescribedSets;
        const setsHtml = Array.from({length: numSets}, (_, setIdx) => {
            const prevSet = previousSummary && previousSummary.sets[setIdx] ? previousSummary.sets[setIdx] : null;
            return getSetRowHtml(ex.name, setIdx + 1, false, prevSet);
        }).join('');

        card.innerHTML = `
            <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <span style="font-weight: 700; font-size: 1.05rem;">${ex.name}</span>
                            ${isUserAdded ? '<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">ADDED</span>' : ''}
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">${ex.desc || ''}</div>
                        ${previousSummaryHtml}
                    </div>
                    <button onclick="deleteExerciseFromWorkout('${escapedName}', ${isUserAdded})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; font-size: 0.8rem; font-weight: 600;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>

            ${videoUrl ? `
            <div data-video-container style="position: relative; width: 100%; padding-top: 56.25%; background: black; cursor: pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: var(--primary); margin-left: 3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            ${getVolumeDisplayHtml(ex.name)}

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr 32px 32px; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div><div></div><div></div>
            </div>

            <div class="sets-list-container">
                ${setsHtml}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${escapedName}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>
        `;
        container.appendChild(card);

        // Setup volume tracking for this card
        setupVolumeTracking(card);
    });
}

// Render yoga exercises with individual timers
function renderYogaExercises(exercises) {
    const container = document.getElementById('workout-exercises-list');
    container.innerHTML = '';

    exercises.forEach((ex, idx) => {
        const videoUrl = findVideoMatch(ex.name);
        const isUserAdded = ex.isUserAdded || false;
        const escapedName = ex.name.replace(/'/g, "\\'");

        // Parse the time from the reps field
        const timeSeconds = parseYogaTimeToSeconds(ex.reps);
        const timeDisplay = formatYogaTime(timeSeconds);
        const circumference = 2 * Math.PI * 54; // SVG circle radius 54

        // Initialize timer state
        window.yogaTimers[idx] = {
            total: timeSeconds,
            remaining: timeSeconds,
            isRunning: false,
            interval: null
        };

        // Check if "each" is mentioned (for bilateral poses)
        const isEachSide = ex.reps && ex.reps.toLowerCase().includes('each');

        container.innerHTML += `
            <div class="exercise-logger-card yoga-exercise-card" data-exercise-name="${ex.name}" data-is-user-added="${isUserAdded}" data-exercise-idx="${idx}">
                <div style="padding: 15px; background: linear-gradient(135deg, #f0fdf4 0%, #f8fafc 100%); border-bottom: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <span style="font-weight: 700; font-size: 1.05rem;">${ex.name.replace('Yoga - ', '')}</span>
                                ${isUserAdded ? '<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">ADDED</span>' : ''}
                            </div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">${ex.desc || ''}</div>
                            ${isEachSide ? '<div style="color: var(--primary); font-size: 0.75rem; margin-top: 4px; font-weight: 600;">⟳ Repeat on each side</div>' : ''}
                        </div>
                        <button onclick="deleteExerciseFromWorkout('${escapedName}', ${isUserAdded})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; font-size: 0.8rem; font-weight: 600;">
                            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                ${videoUrl ? `
                <div data-video-container style="position: relative; width: 100%; padding-top: 56.25%; background: black; cursor: pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                    <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline>
                        <source src="${videoUrl}" type="video/mp4">
                    </video>
                    <div class="inline-play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                        <svg viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: var(--primary); margin-left: 3px;">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                </div>` : ''}

                <!-- Yoga Timer Section -->
                <div class="yoga-timer-section" style="padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px;">
                    <!-- Circular Timer Display -->
                    <div style="position: relative; width: 130px; height: 130px;">
                        <svg viewBox="0 0 120 120" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                            <!-- Background circle -->
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#e2e8f0" stroke-width="8"/>
                            <!-- Progress circle -->
                            <circle id="yoga-timer-progress-${idx}" cx="60" cy="60" r="54" fill="none" stroke="var(--primary)" stroke-width="8"
                                stroke-linecap="round"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${circumference}"
                                style="transition: stroke-dashoffset 0.5s ease;"/>
                        </svg>
                        <!-- Timer text in center -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div id="yoga-timer-display-${idx}" style="font-size: 1.8rem; font-weight: 800; color: var(--text-main); font-family: monospace;">${timeDisplay}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">${ex.reps}</div>
                        </div>
                    </div>

                    <!-- Timer Controls -->
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button id="yoga-timer-start-${idx}" onclick="startYogaTimer(${idx})"
                            style="background: var(--primary); color: white; border: none; padding: 12px 28px; border-radius: 25px; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(34,197,94,0.3);">
                            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><path d="M8 5v14l11-7z"/></svg>
                            Start
                        </button>
                        <button id="yoga-timer-pause-${idx}" onclick="pauseYogaTimer(${idx})"
                            style="background: #f59e0b; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: none; align-items: center; gap: 6px;">
                            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            Pause
                        </button>
                        <button id="yoga-timer-reset-${idx}" onclick="resetYogaTimer(${idx})"
                            style="background: #e2e8f0; color: var(--text-main); border: none; padding: 12px 20px; border-radius: 25px; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: none; align-items: center; gap: 6px;">
                            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            Reset
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
}

// Delete exercise from workout
async function deleteExerciseFromWorkout(exerciseName, isUserAdded) {
    const user = window.currentUser;
    const workoutKey = window.currentWorkoutKey;

    if (!user || !workoutKey) {
        // Just remove from DOM if not logged in
        const card = document.querySelector(`.exercise-logger-card[data-exercise-name="${exerciseName}"]`);
        if (card && confirm('Remove this exercise from today\'s workout?')) {
            card.remove();
        }
        return;
    }

    // Ask user if they want to save this permanently
    const saveChoice = confirm(`Remove "${exerciseName}" from this workout?\n\nClick OK to remove it permanently (it won't show next time).\nClick Cancel to keep it.`);

    if (!saveChoice) return;

    try {
        // Remove from database
        await dbHelpers.workoutCustomizations.removeExercise(user.id, workoutKey, exerciseName);

        // Remove from DOM
        const card = document.querySelector(`.exercise-logger-card[data-exercise-name="${exerciseName}"]`);
        if (card) {
            card.remove();
        }

        // Update exercise count in header
        const remainingExercises = document.querySelectorAll('.exercise-logger-card').length;
        const goalEl = document.getElementById('workout-player-goal');
        if (goalEl) {
            const currentText = goalEl.textContent;
            goalEl.textContent = currentText.replace(/\d+ Exercise[s]?/, `${remainingExercises} Exercise${remainingExercises !== 1 ? 's' : ''}`);
        }

        console.log(`Exercise "${exerciseName}" removed from workout`);
    } catch (e) {
        console.error('Failed to remove exercise:', e);
        alert('Failed to remove exercise. Please try again.');
    }
}

// Open add exercise modal
function openAddExerciseModal() {
    document.getElementById('add-exercise-modal').style.display = 'block';
    document.getElementById('add-exercise-search').value = '';
    document.getElementById('add-exercise-results').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #94a3b8;">
            Type to search for exercises from your library
        </div>
    `;
    document.getElementById('add-exercise-search').focus();
}

// Close add exercise modal
function closeAddExerciseModal() {
    document.getElementById('add-exercise-modal').style.display = 'none';
}

// ========== BULK ENTRY FUNCTIONS ==========

function openBulkEntryModal() {
    document.getElementById('bulk-entry-modal').style.display = 'block';
    document.getElementById('bulk-entry-input').value = '';
    document.getElementById('bulk-entry-preview').style.display = 'none';

    // Check if this is first time using Quick Entry
    const hasSeenTutorial = localStorage.getItem('quickEntryTutorialSeen');
    if (!hasSeenTutorial) {
        showQuickEntryTutorial();
    } else {
        document.getElementById('bulk-entry-input').focus();
    }
}

function closeBulkEntryModal() {
    document.getElementById('bulk-entry-modal').style.display = 'none';
}

function showQuickEntryTutorial() {
    const modal = document.getElementById('quick-entry-tutorial-modal');
    modal.style.display = 'flex';
}

function closeQuickEntryTutorial() {
    const modal = document.getElementById('quick-entry-tutorial-modal');
    modal.style.display = 'none';
    localStorage.setItem('quickEntryTutorialSeen', 'true');
    document.getElementById('bulk-entry-input').focus();
}

// Parse bulk entry text into structured workout data
function parseBulkEntry(text) {
    if (!text || text.trim().length === 0) return null;

    const input = text.trim().toLowerCase();

    // Try to find the exercise name by matching against known exercises
    const allExercises = typeof EXERCISE_VIDEOS !== 'undefined' ? Object.keys(EXERCISE_VIDEOS) : [];
    let matchedExercise = null;
    let remainingText = input;

    // Sort exercises by length (longest first) to match most specific first
    const sortedExercises = allExercises.sort((a, b) => b.length - a.length);

    for (const exercise of sortedExercises) {
        const exerciseLower = exercise.toLowerCase();
        if (input.includes(exerciseLower)) {
            matchedExercise = exercise;
            remainingText = input.replace(exerciseLower, '').trim();
            break;
        }
    }

    // If no exact match, try to find by keywords
    if (!matchedExercise) {
        // Extract potential exercise name (words that aren't numbers or units)
        const words = input.split(/\s+/);
        const exerciseWords = [];
        const numberPattern = /^\d+(\.\d+)?(kg|lbs?|reps?|sets?|x)?$/i;
        const multiplierPattern = /^x\d+$/i;

        for (const word of words) {
            if (!numberPattern.test(word) && !multiplierPattern.test(word) &&
                !['sets', 'set', 'reps', 'rep', 'kg', 'lbs', 'x'].includes(word)) {
                exerciseWords.push(word);
            }
        }

        if (exerciseWords.length > 0) {
            const searchTerm = exerciseWords.join(' ');
            // Find best matching exercise
            for (const exercise of sortedExercises) {
                const exerciseLower = exercise.toLowerCase();
                if (exerciseWords.every(word => exerciseLower.includes(word))) {
                    matchedExercise = exercise;
                    break;
                }
            }
            remainingText = input;
            for (const word of exerciseWords) {
                remainingText = remainingText.replace(new RegExp('\\b' + word + '\\b', 'gi'), '').trim();
            }
        }
    }

    if (!matchedExercise) {
        return { error: 'Could not identify exercise. Try including the full exercise name.' };
    }

    // Parse the numbers and create sets
    const sets = [];

    // Pattern 1: "60x10 70x8 80x6" format (weight x reps)
    const weightXRepsPattern = /(\d+(?:\.\d+)?)\s*x\s*(\d+)/gi;
    let wxrMatches = [...remainingText.matchAll(weightXRepsPattern)];

    if (wxrMatches.length > 0) {
        for (const match of wxrMatches) {
            sets.push({ kg: match[1], reps: match[2] });
        }
        return { exercise: matchedExercise, sets };
    }

    // Pattern 2: "80kg 8 reps x3" or "80kg 8reps x3" format (same weight/reps repeated)
    const repeatPattern = /(\d+(?:\.\d+)?)\s*(?:kg)?\s*(\d+)\s*(?:reps?)?\s*x\s*(\d+)/i;
    const repeatMatch = remainingText.match(repeatPattern);

    if (repeatMatch) {
        const kg = repeatMatch[1];
        const reps = repeatMatch[2];
        const count = parseInt(repeatMatch[3]);
        for (let i = 0; i < count; i++) {
            sets.push({ kg, reps });
        }
        return { exercise: matchedExercise, sets };
    }

    // Pattern 3: Just numbers separated by spaces/commas (weights for each set)
    // e.g., "30 40 60" or "30, 40, 60" or "30kg 40kg 60kg"
    const numbersOnly = remainingText.replace(/[,]/g, ' ').replace(/kg|lbs?/gi, '');
    const numbers = numbersOnly.match(/\d+(?:\.\d+)?/g);

    if (numbers && numbers.length > 0) {
        // Check if numbers alternate (weight, reps, weight, reps)
        // If we have pairs and they look like weight/rep pairs
        if (numbers.length >= 2 && numbers.length % 2 === 0) {
            const couldBePairs = numbers.every((n, i) => {
                if (i % 2 === 0) return parseFloat(n) >= 10; // weights typically >= 10
                return parseFloat(n) <= 30; // reps typically <= 30
            });

            if (couldBePairs && numbers.length >= 4) {
                // Treat as weight/rep pairs
                for (let i = 0; i < numbers.length; i += 2) {
                    sets.push({ kg: numbers[i], reps: numbers[i + 1] });
                }
                return { exercise: matchedExercise, sets };
            }
        }

        // Otherwise treat all numbers as weights (default 8-12 reps)
        for (const num of numbers) {
            sets.push({ kg: num, reps: '' });
        }
        return { exercise: matchedExercise, sets };
    }

    // Fallback: just create the exercise with 3 empty sets
    return { exercise: matchedExercise, sets: [{ kg: '', reps: '' }, { kg: '', reps: '' }, { kg: '', reps: '' }] };
}

// Preview the bulk entry as user types
function previewBulkEntry() {
    const input = document.getElementById('bulk-entry-input').value;
    const previewContainer = document.getElementById('bulk-entry-preview');
    const previewContent = document.getElementById('bulk-entry-preview-content');

    if (!input || input.trim().length < 3) {
        previewContainer.style.display = 'none';
        return;
    }

    const result = parseBulkEntry(input);

    if (!result || result.error) {
        previewContainer.style.display = 'block';
        previewContent.innerHTML = `
            <div style="padding: 15px; color: #ef4444; text-align: center;">
                ${result?.error || 'Could not parse input. Try: "bench press 30 40 60"'}
            </div>
        `;
        return;
    }

    previewContainer.style.display = 'block';

    let setsHtml = result.sets.map((set, idx) => `
        <div style="display: grid; grid-template-columns: 40px 1fr 1fr; gap: 10px; padding: 10px 15px; border-top: 1px solid #f1f5f9; align-items: center;">
            <div style="font-weight: 700; color: #94a3b8; text-align: center;">${idx + 1}</div>
            <div style="text-align: center; font-weight: 600;">${set.kg || '-'} kg</div>
            <div style="text-align: center; font-weight: 600;">${set.reps || '-'} reps</div>
        </div>
    `).join('');

    previewContent.innerHTML = `
        <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
            <div style="font-weight: 700; color: var(--text-main);">${result.exercise}</div>
            <div style="font-size: 0.85rem; color: var(--primary); margin-top: 3px;">${result.sets.length} set${result.sets.length !== 1 ? 's' : ''}</div>
        </div>
        <div style="display: grid; grid-template-columns: 40px 1fr 1fr; gap: 10px; padding: 8px 15px; font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">
            <div style="text-align: center;">Set</div>
            <div style="text-align: center;">Weight</div>
            <div style="text-align: center;">Reps</div>
        </div>
        ${setsHtml}
    `;
}

// Process bulk entry and add to workout
function processBulkEntry() {
    const input = document.getElementById('bulk-entry-input').value;
    const result = parseBulkEntry(input);

    if (!result || result.error) {
        alert(result?.error || 'Could not parse input. Please check the format.');
        return;
    }

    // Add exercise to workout with pre-filled sets
    addExerciseWithSets(result.exercise, result.sets);
    closeBulkEntryModal();
}

// Add exercise with pre-filled set values
function addExerciseWithSets(exerciseName, sets) {
    const container = document.getElementById('workout-exercises-list');
    const videoUrl = findVideoMatch(exerciseName);
    const previousSummaryHtml = formatPreviousWorkoutSummary(exerciseName);
    const previousSummary = getPreviousWorkoutSummary(exerciseName);
    const escapedName = exerciseName.replace(/'/g, "\\'");

    const setsHtml = sets.map((set, idx) => {
        return `
            <div class="set-wrapper">
                <div class="workout-set-row" style="display: grid; grid-template-columns: 40px 1fr 1fr 1fr 32px 32px; gap: 8px; align-items: center; padding: 10px 15px; border-top: 1px solid #f8fafc;">
                    <div style="font-weight: 800; color: #94a3b8; font-size: 0.85rem; text-align: center;">${idx + 1}</div>
                    <input type="text" class="input-time" placeholder="-" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                    <input type="text" class="input-reps" placeholder="Reps" value="${set.reps || ''}" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                    <input type="text" class="input-kg" placeholder="Kg" value="${set.kg || ''}" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                    <button class="drop-set-toggle" onclick="toggleDropSet(this)" title="Toggle Drop Set">DS</button>
                    <button class="delete-set-btn" onclick="deleteSetRow(this)" title="Delete Set" style="width:32px; height:32px; border:none; background:transparent; color:#ef4444; cursor:pointer; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;"><svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:currentColor;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                </div>
                <div class="drop-set-container">
                    <div class="drop-set-inputs">
                        <div class="drop-set-row">
                            <div class="drop-indicator">↓1</div>
                            <input type="text" class="drop-reps" placeholder="Reps">
                            <input type="text" class="drop-kg" placeholder="Kg">
                            <button class="drop-add-btn" onclick="addDropRow(this)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    const exerciseHtml = `
        <div class="exercise-logger-card" data-exercise-name="${exerciseName}" data-is-user-added="true" style="background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9; animation: slideInUp 0.3s ease;">
            <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <span style="font-weight: 700; font-size: 1.05rem;">${exerciseName}</span>
                            <span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">QUICK</span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">Added via quick entry</div>
                        ${previousSummaryHtml}
                    </div>
                    <button onclick="deleteExerciseFromWorkout('${escapedName}', true)" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; font-size: 0.8rem; font-weight: 600;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>

            ${videoUrl ? `
            <div data-video-container style="position: relative; width: 100%; padding-top: 56.25%; background: black; cursor: pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: var(--primary); margin-left: 3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            <!-- Volume Tracker -->
            <div class="volume-display" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-bottom: 1px solid #fef08a;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #ca8a04;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    <span style="font-size: 0.75rem; font-weight: 700; color: #a16207; text-transform: uppercase;">Volume</span>
                </div>
                <div style="text-align: right;">
                    <div class="volume-value" style="font-size: 1rem; font-weight: 800; color: #854d0e;">0 kg</div>
                    <div class="volume-comparison" style="font-size: 0.7rem; font-weight: 600;">${previousSummary && previousSummary.totalVolume > 0 ? `<span style="color: #94a3b8;">Last: ${previousSummary.totalVolume.toLocaleString()} kg — beat it!</span>` : '<span style="color: #94a3b8;">Enter weight & reps</span>'}</div>
                </div>
                <div class="volume-progress-container" style="display: ${previousSummary && previousSummary.totalVolume > 0 ? 'block' : 'none'}; margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span class="volume-target-label" style="font-size: 0.65rem; font-weight: 600; color: #a16207;">Target: ${previousSummary && previousSummary.totalVolume > 0 ? previousSummary.totalVolume.toLocaleString() + ' kg' : '—'}</span>
                        <span class="volume-percentage" style="font-size: 0.65rem; font-weight: 700; color: #a16207;">0%</span>
                    </div>
                    <div style="height: 6px; background: #fef08a; border-radius: 3px; overflow: hidden;">
                        <div class="volume-progress-bar" style="height: 100%; width: 0%; background: #ca8a04; border-radius: 3px; transition: width 0.3s ease, background 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr 32px 32px; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div><div></div><div></div>
            </div>

            <div class="sets-list-container">
                ${setsHtml}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${escapedName}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', exerciseHtml);

    // Update exercise count in header
    const exerciseCount = document.querySelectorAll('.exercise-logger-card').length;
    const goalEl = document.getElementById('workout-player-goal');
    if (goalEl) {
        const currentText = goalEl.textContent;
        goalEl.textContent = currentText.replace(/\d+ Exercise[s]?/, `${exerciseCount} Exercise${exerciseCount !== 1 ? 's' : ''}`);
    }

    // Scroll to the new exercise and setup volume tracking
    const newCard = container.lastElementChild;
    if (newCard) {
        newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setupVolumeTracking(newCard);
        // Update volume with any pre-filled values
        updateVolumeDisplay(newCard);
    }
}

// ========== END BULK ENTRY FUNCTIONS ==========

// Popular/main exercises that should be prioritized in search results
const POPULAR_EXERCISES = new Set([
    // Barbell compound movements
    'Barbell Bench Press', 'Barbell Squat', 'Barbell Deadlift', 'Barbell Row',
    'Barbell Overhead Press', 'Barbell Front Squat', 'Barbell Romanian Deadlift',
    'Barbell Hip Thrust', 'Barbell Curl', 'Barbell Lunge',
    // Dumbbell essentials
    'Dumbbell Bench Press', 'Dumbbell Row', 'Dumbbell Curl', 'Dumbbell Shoulder Press',
    'Dumbbell Lateral Raise', 'Dumbbell Fly', 'Dumbbell Lunge', 'Dumbbell Romanian Deadlift',
    'Dumbbell Goblet Squat', 'Dumbbell Tricep Extension',
    // Bodyweight basics
    'Push Up', 'Pull Up', 'Chin Up', 'Dip', 'Plank', 'Squat', 'Lunge',
    'Burpee', 'Mountain Climber', 'Crunch', 'Sit Up', 'Leg Raise',
    // Cable movements
    'Cable Row', 'Cable Fly', 'Cable Curl', 'Cable Tricep Pushdown', 'Cable Face Pull',
    'Cable Lateral Raise', 'Cable Crossover',
    // Machine basics
    'Leg Press', 'Lat Pulldown', 'Leg Curl', 'Leg Extension', 'Chest Press Machine',
    'Shoulder Press Machine', 'Cable Row Machine'
]);

// Score an exercise based on how well it matches the search query
function scoreExerciseMatch(exerciseName, searchTerms, fullQuery) {
    const nameLower = exerciseName.toLowerCase();
    const queryLower = fullQuery.toLowerCase().trim();
    let score = 0;

    // Exact match gets highest priority (1000 points)
    if (nameLower === queryLower) {
        score += 1000;
    }
    // Starts with the full query (500 points)
    else if (nameLower.startsWith(queryLower)) {
        score += 500;
    }
    // Starts with first search term (200 points)
    else if (searchTerms.length > 0 && nameLower.startsWith(searchTerms[0])) {
        score += 200;
    }

    // Popular/main exercise bonus (100 points)
    if (POPULAR_EXERCISES.has(exerciseName)) {
        score += 100;
    }

    // Word boundary matches are better than substring matches
    // Check if search terms appear as complete words (50 points each)
    const words = nameLower.split(/\s+/);
    for (const term of searchTerms) {
        if (words.some(word => word === term)) {
            score += 50; // Exact word match
        } else if (words.some(word => word.startsWith(term))) {
            score += 25; // Word starts with term
        }
    }

    // Shorter names are often more "primary" exercises (slight bonus)
    // Max 20 points for names under 20 characters
    score += Math.max(0, 20 - exerciseName.length);

    return score;
}

// Search exercises for add modal
function searchExercisesForAdd(query) {
    const resultsContainer = document.getElementById('add-exercise-results');

    if (!query || query.length < 2) {
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                Type at least 2 characters to search
            </div>
        `;
        return;
    }

    // Search in EXERCISE_VIDEOS library
    if (typeof EXERCISE_VIDEOS === 'undefined') {
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                Exercise library not loaded
            </div>
        `;
        return;
    }

    const allExercises = Object.keys(EXERCISE_VIDEOS);
    const terms = query.toLowerCase().split(' ').filter(t => t);
    const filteredExercises = allExercises.filter(name => {
        const nameLower = name.toLowerCase();
        return terms.every(term => nameLower.includes(term));
    });

    if (filteredExercises.length === 0) {
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                No exercises found matching "${query}"
            </div>
        `;
        return;
    }

    // Sort by relevance score (highest first)
    filteredExercises.sort((a, b) => {
        const scoreA = scoreExerciseMatch(a, terms, query);
        const scoreB = scoreExerciseMatch(b, terms, query);
        return scoreB - scoreA;
    });

    // Limit to first 50 results
    const displayExercises = filteredExercises.slice(0, 50);

    resultsContainer.innerHTML = displayExercises.map(name => {
        const escapedName = name.replace(/'/g, "\\'");
        return `
            <div onclick="selectExerciseToAdd('${escapedName}')" style="padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                <div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8;">
                        <path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-main);">${name}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Tap to add to workout</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--primary);">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
            </div>
        `;
    }).join('');

    if (displayExercises.length < filteredExercises.length) {
        resultsContainer.innerHTML += `
            <div style="text-align: center; padding: 15px; color: #94a3b8; font-size: 0.85rem;">
                Showing ${displayExercises.length} of ${filteredExercises.length} results. Refine your search for more specific results.
            </div>
        `;
    }
}

// Select exercise to add
async function selectExerciseToAdd(exerciseName) {
    const user = window.currentUser;
    const workoutKey = window.currentWorkoutKey;

    // Create exercise object
    const newExercise = {
        name: exerciseName,
        sets: 3,
        reps: '8-12',
        desc: 'Custom exercise added by you',
        isUserAdded: true
    };

    // Ask user if they want to save permanently
    const saveChoice = confirm(`Add "${exerciseName}" to this workout?\n\nClick OK to save it permanently (it will appear every time you do this workout).\nClick Cancel to just add it for today.`);

    // Add to UI immediately
    addExerciseToUI(newExercise);
    closeAddExerciseModal();

    // Save to database if user confirmed and is logged in
    if (saveChoice && user && workoutKey) {
        try {
            await dbHelpers.workoutCustomizations.addExercise(user.id, workoutKey, {
                name: exerciseName,
                sets: 3,
                reps: '8-12',
                desc: 'Custom exercise added by you'
            });
            console.log(`Exercise "${exerciseName}" saved to workout permanently`);
        } catch (e) {
            console.error('Failed to save exercise to database:', e);
            // Exercise is already added to UI, just log the error
        }
    }
}

// Add exercise to UI
function addExerciseToUI(exercise) {
    const container = document.getElementById('workout-exercises-list');
    const videoUrl = findVideoMatch(exercise.name);
    const previousSummaryHtml = formatPreviousWorkoutSummary(exercise.name);
    const previousSummary = getPreviousWorkoutSummary(exercise.name);
    const escapedName = exercise.name.replace(/'/g, "\\'");

    const exerciseHtml = `
        <div class="exercise-logger-card" data-exercise-name="${exercise.name}" data-is-user-added="true" style="animation: slideInUp 0.3s ease;">
            <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <span style="font-weight: 700; font-size: 1.05rem;">${exercise.name}</span>
                            <span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">ADDED</span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">${exercise.desc || ''}</div>
                        ${previousSummaryHtml}
                    </div>
                    <button onclick="deleteExerciseFromWorkout('${escapedName}', true)" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 5px; font-size: 0.8rem; font-weight: 600;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>

            ${videoUrl ? `
            <div data-video-container style="position: relative; width: 100%; padding-top: 56.25%; background: black; cursor: pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: var(--primary); margin-left: 3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            <!-- Volume Tracker -->
            <div class="volume-display" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-bottom: 1px solid #fef08a;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #ca8a04;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    <span style="font-size: 0.75rem; font-weight: 700; color: #a16207; text-transform: uppercase;">Volume</span>
                </div>
                <div style="text-align: right;">
                    <div class="volume-value" style="font-size: 1rem; font-weight: 800; color: #854d0e;">0 kg</div>
                    <div class="volume-comparison" style="font-size: 0.7rem; font-weight: 600;">${previousSummary && previousSummary.totalVolume > 0 ? `<span style="color: #94a3b8;">Last: ${previousSummary.totalVolume.toLocaleString()} kg — beat it!</span>` : '<span style="color: #94a3b8;">Enter weight & reps</span>'}</div>
                </div>
                <div class="volume-progress-container" style="display: ${previousSummary && previousSummary.totalVolume > 0 ? 'block' : 'none'}; margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span class="volume-target-label" style="font-size: 0.65rem; font-weight: 600; color: #a16207;">Target: ${previousSummary && previousSummary.totalVolume > 0 ? previousSummary.totalVolume.toLocaleString() + ' kg' : '—'}</span>
                        <span class="volume-percentage" style="font-size: 0.65rem; font-weight: 700; color: #a16207;">0%</span>
                    </div>
                    <div style="height: 6px; background: #fef08a; border-radius: 3px; overflow: hidden;">
                        <div class="volume-progress-bar" style="height: 100%; width: 0%; background: #ca8a04; border-radius: 3px; transition: width 0.3s ease, background 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr 32px 32px; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div><div></div><div></div>
            </div>

            <div class="sets-list-container">
                ${(() => {
                    const numSets = previousSummary && previousSummary.setCount > 0 ? previousSummary.setCount : (exercise.sets || 3);
                    return Array.from({length: numSets}, (_, setIdx) => {
                        const prevSet = previousSummary && previousSummary.sets[setIdx] ? previousSummary.sets[setIdx] : null;
                        const prefillKg = prevSet && prevSet.kg && prevSet.kg !== '0' && prevSet.kg !== '' ? prevSet.kg : '';
                        const prefillReps = prevSet && prevSet.reps ? prevSet.reps : '';
                        const hasPrefill2 = prefillKg || prefillReps;
                        return `
                        <div class="set-wrapper"${hasPrefill2 ? ' data-prefilled="true"' : ''}>
                            <div class="workout-set-row" style="display: grid; grid-template-columns: 40px 1fr 1fr 1fr 32px 32px; gap: 8px; align-items: center; padding: 10px 15px; border-top: 1px solid #f8fafc;">
                                <div class="set-number" style="font-weight: 800; color: #94a3b8; font-size: 0.85rem; text-align: center;">${setIdx + 1}</div>
                                <input type="text" class="input-time" placeholder="-" data-exercise="${exercise.name}" data-set="${setIdx + 1}" data-field="time" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                                <input type="text" class="input-reps" placeholder="Reps" value="${prefillReps}" data-exercise="${exercise.name}" data-set="${setIdx + 1}" data-field="reps" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                                <input type="text" class="input-kg" placeholder="Kg" value="${prefillKg}" data-exercise="${exercise.name}" data-set="${setIdx + 1}" data-field="weight" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                                <button class="drop-set-toggle" onclick="toggleDropSet(this)" title="Toggle Drop Set">DS</button>
                                <button class="delete-set-btn" onclick="deleteSetRow(this)" title="Delete Set" style="width:32px; height:32px; border:none; background:transparent; color:#ef4444; cursor:pointer; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;"><svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:currentColor;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                            </div>
                            <div class="drop-set-container">
                                <div class="drop-set-inputs">
                                    <div class="drop-set-row">
                                        <div class="drop-indicator">↓1</div>
                                        <input type="text" class="drop-reps" placeholder="Reps">
                                        <input type="text" class="drop-kg" placeholder="Kg">
                                        <button class="drop-add-btn" onclick="addDropRow(this)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                })()}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${escapedName}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', exerciseHtml);

    // Update exercise count in header
    const exerciseCount = document.querySelectorAll('.exercise-logger-card').length;
    const goalEl = document.getElementById('workout-player-goal');
    if (goalEl) {
        const currentText = goalEl.textContent;
        goalEl.textContent = currentText.replace(/\d+ Exercise[s]?/, `${exerciseCount} Exercise${exerciseCount !== 1 ? 's' : ''}`);
    }

    // Scroll to the new exercise and setup volume tracking
    const newCard = container.lastElementChild;
    if (newCard) {
        newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setupVolumeTracking(newCard);
    }
}

// Update hideAllAppViews to include new views
const originalHideAllAppViews = hideAllAppViews;
hideAllAppViews = function() {
    originalHideAllAppViews();
    const libraryViews = ['view-workout-library', 'view-workout-subcategories', 'view-workout-list', 'view-prebuilt-programs'];
    libraryViews.forEach(v => {
        const el = document.getElementById(v);
        if(el) {
            el.style.display = 'none';
        }
    });
};

</script>
<!-- Image Modal HTML -->
<div class="image-modal-overlay" id="imageModal" onclick="closeImageModal()">
<div class="close-modal-btn"></div>
<img alt="Full size meal" class="image-modal-content" id="modalImage" onclick="event.stopPropagation()" src=""/>
</div>

<!-- Meal Detail Popup -->
<div class="meal-detail-popup" id="mealDetailPopup" onclick="closeMealDetailPopup()">
    <div class="meal-detail-container" onclick="event.stopPropagation()">
        <div id="mealDetailPhotoSection"></div>
        <div class="meal-detail-content">
            <div class="meal-detail-header">
                <div class="meal-detail-time" id="mealDetailTime"></div>
                <div class="meal-detail-foods" id="mealDetailFoods"></div>
            </div>
            <div class="meal-detail-calories">
                <div class="meal-detail-calories-value" id="mealDetailCalories"></div>
                <div class="meal-detail-calories-label">calories</div>
            </div>
            <div class="meal-detail-macros">
                <div class="meal-detail-macro protein">
                    <div class="meal-detail-macro-value" id="mealDetailProtein"></div>
                    <div class="meal-detail-macro-label">Protein</div>
                </div>
                <div class="meal-detail-macro carbs">
                    <div class="meal-detail-macro-value" id="mealDetailCarbs"></div>
                    <div class="meal-detail-macro-label">Carbs</div>
                </div>
                <div class="meal-detail-macro fat">
                    <div class="meal-detail-macro-value" id="mealDetailFat"></div>
                    <div class="meal-detail-macro-label">Fat</div>
                </div>
            </div>
            <div class="meal-detail-items" id="mealDetailItems"></div>
            <button class="meal-detail-edit-btn" id="mealDetailEditBtn" onclick="openEditItemsModal()">
                ✏️ Edit Items
            </button>
        </div>
    </div>
</div>

<!-- Food Items Modal (Edit or Add mode) -->
<div class="edit-items-modal" id="editItemsModal" onclick="closeFoodItemsModal()">
    <div class="edit-items-container" onclick="event.stopPropagation()">
        <div class="edit-items-header">
            <h3 id="foodItemsModalTitle">Edit Food</h3>
            <button class="edit-items-close" onclick="closeFoodItemsModal()">&times;</button>
        </div>
        <div class="edit-items-list" id="editItemsList"></div>
        <div class="edit-items-add">
            <input type="text" id="newItemInput" placeholder="Food item (e.g., 'oats' or 'chicken breast')" onkeypress="if(event.key==='Enter')addNewItem()">
            <input type="text" id="newItemPortionInput" placeholder="Amount (e.g., 200g)" onkeypress="if(event.key==='Enter')addNewItem()" style="max-width:120px;">
            <button onclick="addNewItem()">+ Add</button>
        </div>
        <div class="edit-items-actions">
            <button class="edit-items-cancel" onclick="closeFoodItemsModal()">Cancel</button>
            <button class="edit-items-recalculate" onclick="handleFoodItemsSubmit()" id="recalculateBtn">
                <span class="recalc-text" id="foodItemsSubmitText">🔄 Recalculate</span>
                <span class="recalc-loading" style="display:none;">Processing...</span>
            </button>
        </div>
    </div>
</div>

<script>
// Image Modal Logic
document.addEventListener('DOMContentLoaded', function() {
    const mealImages = document.querySelectorAll('.card-body img');
    mealImages.forEach(img => {
        img.addEventListener('click', function(e) {
            e.stopPropagation(); 
            openImageModal(this.src, this.alt);
        });
    });
});

function openImageModal(src, alt) {
    const modal = document.getElementById('imageModal');
    const img = document.getElementById('modalImage');
    img.src = src;
    img.alt = alt || 'Meal Image';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden'; 
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.classList.remove('active');
    document.body.style.overflow = ''; 
    setTimeout(() => {
        document.getElementById('modalImage').src = '';
    }, 300); 
}

// Close on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") {
        closeImageModal();
    }
});

function showSupportTab(tab, btn) {
    // 1. Toggle Buttons
    const container = btn.parentElement;
    container.querySelectorAll('button').forEach(b => {
        b.classList.remove('active');
        b.style.background = 'transparent';
        b.style.color = '#718096';
    });
    btn.classList.add('active');
    btn.style.background = 'white';
    btn.style.color = 'var(--primary)';

    // 2. Toggle Content
    const chat = document.getElementById('support-chat');
    const comm = document.getElementById('support-community');
    const refl = document.getElementById('support-reflections');

    if (tab === 'chat') {
        chat.style.display = 'flex';
        comm.style.display = 'none';
        refl.style.display = 'none';
        // Scroll to bottom of chat messages after a short delay to ensure content is rendered
        setTimeout(() => {
            const chatContainer = document.getElementById('chat-messages-container');
            if (chatContainer) {
                const rect = chatContainer.getBoundingClientRect();
                const absoluteBottom = rect.bottom + window.pageYOffset;
                window.scrollTo({
                    top: absoluteBottom - window.innerHeight + 100, // 100px buffer for input box
                    behavior: 'smooth'
                });
            }
        }, 100);
    } else if (tab === 'community') {
        chat.style.display = 'none';
        comm.style.display = 'flex';
        refl.style.display = 'none';
        loadCommunityFeed(); // Refresh feed when opening
    } else if (tab === 'reflections') {
        chat.style.display = 'none';
        comm.style.display = 'none';
        refl.style.display = 'flex';
        loadAllReflections(); // Load reflections when opening
    }
}

// Helper function to scroll to bottom of chat messages
function scrollToBottomOfChat() {
    const chatContainer = document.getElementById('chat-messages-container');
    if (chatContainer) {
        // Check if container is inside a modal (has overflow-y: auto)
        const modal = document.getElementById('coach-chat-modal');
        if (modal && modal.style.display === 'flex') {
            // Scroll the container within the modal
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } else {
            // Legacy full-page scroll
            const rect = chatContainer.getBoundingClientRect();
            const absoluteBottom = rect.bottom + window.pageYOffset;
            window.scrollTo({
                top: absoluteBottom - window.innerHeight + 100,
                behavior: 'smooth'
            });
        }
    }
}

// Consolidated Chat Logic (Old versions removed)


// Old chat logic removed.

// --- COMMUNITY CHAT LOGIC (HUMAN REFERRAL NETWORK ONLY) ---

function loadCommunityFeed() {
    let messages = [];
    try { messages = JSON.parse(localStorage.getItem('community_chat_history') || '[]'); } catch(e) {}
    if(messages.length === 0) {
        const sysMsg = {
            id: 'sys_' + Date.now(),
            isSystem: true,
            text: `Community group started`,
            timestamp: Date.now()
        };
        messages.push(sysMsg);
        localStorage.setItem('community_chat_history', JSON.stringify(messages));
    }
    renderChat(messages);
}

function renderChat(messages) {
    const container = document.getElementById('community-chat-stream');
    if(!container) return;

    // 1. Build a single massive string instead of touching the DOM repeatedly
    let fullHtml = '';

    messages.forEach((msg, msgIndex) => {
        const isMe = !msg.authorId || msg.authorId === 'current-user';

        // For other users, show their avatar and name
        let avatarHtml = '';
        let authorName = '';
        if(!isMe && msg.authorName) {
             // Use user's profile photo if available, otherwise use initials
             if (msg.authorAvatar) {
                 avatarHtml = `<img src="${msg.authorAvatar}" style="width:32px; height:32px; border-radius:50%; flex-shrink:0; align-self:flex-end; margin-bottom:5px; object-fit:cover;">`;
             } else {
                 const initials = msg.authorName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                 avatarHtml = `<div style="width:32px; height:32px; border-radius:50%; flex-shrink:0; align-self:flex-end; margin-bottom:5px; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:0.75rem; font-weight:600;">${initials}</div>`;
             }
             authorName = msg.authorName;
        }

        const bBg = isMe ? 'var(--chat-bg-user)' : 'var(--chat-bg-coach)';
        const bText = isMe ? 'var(--chat-text-user)' : 'var(--chat-text-coach)';
        const bRadius = isMe ? '18px 18px 0 18px' : '18px 18px 18px 0';
        const bBorder = isMe ? 'none' : '1px solid var(--chat-border-coach)';
        const alignStyle = isMe ? "justify-content: flex-end;" : "justify-content: flex-start;";

        // Emoji reactions (keeping for human interactions)
        let reactionsHtml = '';
        if (msg.reactions && msg.reactions.length > 0) {
            const reactionCounts = {};
            msg.reactions.forEach(r => {
                reactionCounts[r.emoji] = (reactionCounts[r.emoji] || 0) + 1;
            });
            reactionsHtml = '<div style="display:flex; gap:4px; margin-top:4px; margin-left:10px; flex-wrap:wrap;">';
            Object.entries(reactionCounts).forEach(([emoji, count]) => {
                reactionsHtml += `<span style="font-size:0.85rem; background:#f1f5f9; padding:2px 6px; border-radius:10px; border:1px solid #e2e8f0;">${emoji} ${count > 1 ? count : ''}</span>`;
            });
            reactionsHtml += '</div>';
        }

        let messageHtml = '';
        if (msg.isSystem) {
            messageHtml = `<div style="text-align:center; margin: 20px 0; color:#94a3b8; font-size:0.8rem; font-weight:600; text-transform:uppercase; letter-spacing:1px;">${msg.text}</div>`;
        } else {
            messageHtml = `
            <div style="display:flex; ${alignStyle} margin-bottom: 12px; gap: 8px;">
                ${(!isMe && authorName) ? avatarHtml : ''}
                <div style="display:flex; flex-direction:column; max-width:75%; ${isMe ? 'align-items:flex-end;' : 'align-items:flex-start;'}">
                    ${(!isMe && authorName) ? `<div style="font-size:0.7rem; color:var(--text-muted); margin-left:10px; margin-bottom:2px;">${authorName}</div>` : ''}
                    <div>
                        <div style="padding: 10px 15px; font-size: 0.95rem; line-height: 1.4; background: ${bBg}; color: ${bText}; border-radius: ${bRadius}; border: ${bBorder}; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                            ${msg.text}
                        </div>
                        ${reactionsHtml}
                    </div>
                </div>
            </div>`;
        }

        // Append to string, NOT DOM
        fullHtml += messageHtml;
    });

    // 2. Update DOM exactly once
    container.innerHTML = fullHtml;
    container.scrollTop = container.scrollHeight;
}

</script>

<!-- COACH DASHBOARD STYLES -->
<style>
    /* Coach Dashboard Specific Styles */
    #view-coach-dashboard {
        display: none; /* Hidden by default */
        position: fixed;
        inset: 0;
        background: #f8fafc;
        z-index: 10000;
        overflow-y: auto;
        font-family: 'Inter', sans-serif;
    }

    .coach-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        min-height: 100vh;
    }

    /* Sidebar */
    .coach-sidebar {
        background: #0f172a;
        color: white;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .coach-logo {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        margin-bottom: 40px;
        color: var(--secondary);
    }

    .coach-nav-item {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #94a3b8;
        transition: all 0.2s;
    }

    .coach-nav-item:hover, .coach-nav-item.active {
        background: rgba(255,255,255,0.1);
        color: white;
    }

    /* Main Content */
    .coach-main {
        padding: 30px;
        overflow-y: auto;
    }

    .coach-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .coach-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1e293b;
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
    }

    .d-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }

    .d-card h3 {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #334155;
        border-bottom: 1px solid #f1f5f9;
        padding-bottom: 10px;
    }

    /* Compliance Snapshots */
    .compliance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 10px;
    }
    
    .compliance-dot {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
        position: relative;
    }
    .status-warning { background: #F59E0B; }
    .status-danger { background: #EF4444; }
    .status-good { background: #10B981; }

    /* Activity Feed */
    .activity-item {
        display: flex;
        gap: 15px;
        padding: 12px 0;
        border-bottom: 1px solid #f1f5f9;
    }
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Mobile Responsive adjustment for Coach View */
    @media (max-width: 768px) {
        .coach-layout { grid-template-columns: 1fr; }
        .coach-sidebar { display: none; } /* Add a mobile toggler later if needed, assume desktop for "Command Center" initially */
        .dashboard-grid { grid-template-columns: 1fr; }
    }
</style>

<!-- COACH DASHBOARD HTML -->
<div id="view-coach-dashboard-REMOVED" style="display:none !important;">
    <div class="coach-layout">
        <!-- Sidebar -->
        <div class="coach-sidebar">
            <div class="coach-logo">Shannon (Coach)</div>
            <div class="coach-nav-item active" onclick="showCoachSection('overview')">
                <span>🏠</span> Overview
            </div>
            <div class="coach-nav-item" onclick="showCoachSection('clients')">
                <span>👥</span> Clients
            </div>
            <div class="coach-nav-item" onclick="showCoachSection('messages')">
                <span>💬</span> Messages <span class="badge" style="background:red; padding:2px 6px; border-radius:10px; font-size:0.7rem;">3</span>
            </div>
            <div class="coach-nav-item" onclick="showCoachSection('calendar')">
                <span>📅</span> User Calendar
            </div>
             <div style="margin-top:auto;">
                <div class="coach-nav-item" onclick="toggleCoachMode(false)">
                    <span>🚪</span> Exit Coach Mode
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="coach-main">
            <!-- SECTION: OVERVIEW -->
            <div id="coach-sec-overview">
                <div class="coach-header">
                    <div>
                        <div class="coach-title">Command Center</div>
                        <div style="color:#64748b;">Welcome back, Shannon. Here is what's happening today.</div>
                    </div>
                    <button class="app-btn" style="width: auto; padding: 10px 20px;">+ Quick Add</button>
                </div>

                <div class="dashboard-grid">
                    <!-- Left Col -->
                    <div>
                        <!-- Compliance -->
                        <div class="d-card">
                            <h3>Compliance Snapshots</h3>
                            <div class="compliance-grid" id="compliance-container">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="d-card">
                            <h3>Recent Activity</h3>
                            <div id="activity-feed-container">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Col -->
                    <div>
                        <!-- Pending Requests -->
                        <div class="d-card">
                            <h3>Pending Requests (3)</h3>
                            <div class="activity-item">
                                <div class="activity-icon" style="background:#FEF3C7; color:#D97706;">??</div>
                                <div>
                                    <div style="font-weight:600;">Consultation Form</div>
                                    <div style="font-size:0.85rem; color:#64748b;">New Client Application</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon" style="background:#DBEAFE; color:#2563EB;">??</div>
                                <div>
                                    <div style="font-weight:600;">Payment Failed</div>
                                    <div style="font-size:0.85rem; color:#64748b;">Sarah J. - Subscription</div>
                                </div>
                            </div>
                        </div>

                        <!-- Daily Schedule -->
                        <div class="d-card">
                            <h3>Daily Schedule</h3>
                            <div class="activity-item">
                                <div style="font-weight:bold; color:var(--primary); width:50px;">09:00</div>
                                <div>Check-in Review</div>
                            </div>
                            <div class="activity-item">
                                <div style="font-weight:bold; color:var(--primary); width:50px;">14:30</div>
                                <div>Call with Jessica</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: CLIENTS (Deep Dive) -->
            <div id="coach-sec-clients" style="display:none;">
                <div class="coach-header">
                    <div class="coach-title">Client Profiles</div>
                    <input type="text" placeholder="Search clients..." style="padding:10px; border-radius:8px; border:1px solid #ccc;">
                </div>
                <!-- Simple Client List for Selection -->
                <div class="d-card" id="client-list-view">
                    <h3>All Clients</h3>
                    <div id="coach-client-list"></div>
                </div>

                <!-- SINGLE CLIENT VIEW (Hidden by default) -->
                <div id="single-client-view" style="display:none;">
                    <button onclick="closeClientProfile()" style="margin-bottom:20px; background:none; border:none; color:#64748b; cursor:pointer;">? Back to List</button>
                    
                    <div class="d-card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; gap:20px; align-items:center;">
                            <div id="sc-avatar" style="width:60px; height:60px; background:var(--primary); border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-size:1.5rem;">SJ</div>
                            <div>
                                <h2 id="sc-name" style="margin:0; font-size:1.5rem;">Sarah Jenkins</h2>
                                <div id="sc-status" style="color:#64748b;">Active  Wk 3  Cortisol Reset</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="app-btn" style="width:auto; background:var(--secondary);" onclick="openAsClient()">Open App as Client</button>
                            <button class="app-btn" style="width:auto;">Message</button>
                        </div>
                    </div>

                    <!-- Client Tabs -->
                    <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #e2e8f0;">
                        <div class="coach-nav-item active" style="color:var(--primary); border-bottom:2px solid var(--primary); border-radius:0;">Dash</div>
                        <div class="coach-nav-item" style="color:#64748b;">Progress</div>
                        <div class="coach-nav-item" style="color:#64748b;">Training</div>
                        <div class="coach-nav-item" style="color:#64748b;">Nutrition</div>
                        <div class="coach-nav-item" style="color:#64748b;">Notes ??</div>
                    </div>

                    <div class="dashboard-grid">
                        <!-- Stats Tiles -->
                        <div style="grid-column: 1 / -1; display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:20px;">
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">WEIGHT</div>
                                <div style="font-size:1.5rem; font-weight:bold;">64.5kg</div>
                                <div style="color:green; font-size:0.8rem;">? 0.5kg</div>
                            </div>
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">BODY FAT</div>
                                <div style="font-size:1.5rem; font-weight:bold;">22%</div>
                                <div style="color:green; font-size:0.8rem;">? 1.2%</div>
                            </div>
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">RHR</div>
                                <div style="font-size:1.5rem; font-weight:bold;">58</div>
                                <div style="color:green; font-size:0.8rem;">? 4 bpm</div>
                            </div>
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">KCALS</div>
                                <div style="font-size:1.5rem; font-weight:bold;">1850</div>
                                <div style="color:orange; font-size:0.8rem;">Avg</div>
                            </div>
                        </div>

                        <!-- Left: Photos & Badges -->
                        <div class="d-card">
                            <h3>Progress Photos</h3>
                            <div style="display:flex; gap:10px;">
                                <div style="flex:1; background:#f1f5f9; aspect-ratio:3/4; display:flex; align-items:center; justify-content:center; border-radius:8px;">Front</div>
                                <div style="flex:1; background:#f1f5f9; aspect-ratio:3/4; display:flex; align-items:center; justify-content:center; border-radius:8px;">Side</div>
                            </div>
                        </div>

                        <!-- Right: Trainer Notes -->
                        <div class="d-card">
                            <h3>Trainer Notes ??</h3>
                            <textarea style="width:100%; height:150px; border:1px solid #e2e8f0; border-radius:8px; padding:10px;" placeholder="Private notes about this client..."></textarea>
                            <button class="app-btn" style="width:auto; margin-top:10px;">Save Note</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Other sections (Calendar, Messages) placeholders -->
            <div id="coach-sec-messages" style="display:none;">
                <div class="coach-header"><div class="coach-title">Messages</div></div>
                <div class="d-card">
                     <p>Message Center Implementation Pending...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// COACH MODE LOGIC

// Real clients loaded from Supabase
let REAL_CLIENTS = [];

// Primary toggleCoachMode defined below in AI section

async function initCoachDashboard() {
    console.log('🎛️ Initializing Coach Dashboard...');
    await loadRealClients();
    renderComplianceGrid();
    renderActivityFeed();
    renderClientList();
}

async function loadRealClients() {
    try {
        // Fetch all users from Supabase
        const users = await dbHelpers.users.getAll();
        
        REAL_CLIENTS = await Promise.all(users.map(async (user) => {
            // Get last check-in to determine status
            let status = 'good';
            let lastAct = 'No recent activity';
            
            try {
                // Get their most recent conversation
                const history = await dbHelpers.conversations.getHistory(user.id, 'coach', 1);
                if (history && history.length > 0) {
                    const lastMsg = history[history.length - 1];
                    const msgDate = new Date(lastMsg.timestamp);
                    const daysDiff = Math.floor((Date.now() - msgDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff === 0) lastAct = 'Messaged today';
                    else if (daysDiff === 1) lastAct = 'Messaged yesterday';
                    else if (daysDiff < 7) lastAct = `Messaged ${daysDiff} days ago`;
                    else lastAct = `Inactive ${daysDiff} days`;
                    
                    // Set status based on activity
                    if (daysDiff > 7) status = 'danger';
                    else if (daysDiff > 3) status = 'warning';
                }
            } catch (e) { console.warn('Could not get activity for user', user.id); }
            
            // Calculate program day
            let programDay = 0;
            if (user.program_start_date) {
                const start = new Date(user.program_start_date);
                programDay = Math.ceil((Date.now() - start) / (1000 * 60 * 60 * 24));
            }
            
            // Get initials for avatar
            const name = user.name || user.email?.split('@')[0] || 'User';
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            return {
                id: user.id,
                name: name,
                email: user.email,
                status: status,
                avatar: initials,
                lastAct: lastAct,
                programDay: programDay,
                startDate: user.program_start_date,
                profile: user.profile || 'Standard',
                lastLogin: user.last_login
            };
        }));
        
        console.log(`✅ Loaded ${REAL_CLIENTS.length} clients from database`);
    } catch (error) {
        console.error('Failed to load clients:', error);
        REAL_CLIENTS = [];
    }
}

function renderComplianceGrid() {
    const container = document.getElementById('compliance-container');
    if (REAL_CLIENTS.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-style:italic;">No clients found</div>';
        return;
    }
    container.innerHTML = REAL_CLIENTS.map(c => `
        <div class="compliance-dot status-${c.status}" onclick="openClientProfile('${c.id}')" title="${c.name} - ${c.lastAct}">
            ${c.avatar}
        </div>
    `).join('');
}

function renderActivityFeed() {
    const container = document.getElementById('activity-feed-container');
    
    // Build activity from real clients
    const activities = REAL_CLIENTS
        .filter(c => c.lastAct && c.lastAct !== 'No recent activity')
        .slice(0, 5)
        .map(c => ({
            name: c.name,
            action: c.lastAct,
            icon: c.status === 'good' ? '✅' : c.status === 'warning' ? '⚠️' : '🔴'
        }));
    
    if (activities.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-style:italic;">No recent activity</div>';
        return;
    }
    
    container.innerHTML = activities.map(a => `
        <div class="activity-item">
            <div class="activity-icon">${a.icon}</div>
            <div>
                <div style="font-weight:600;">${a.name}</div>
                <div style="font-size:0.85rem; color:#64748b;">${a.action}</div>
            </div>
        </div>
    `).join('');
}

function showCoachSection(secId) {
    // Hide all
    ['overview', 'clients', 'messages'].forEach(id => {
        const el = document.getElementById('coach-sec-' + id);
        if(el) el.style.display = 'none';
    });
    
    // Show selected
    document.getElementById('coach-sec-' + secId).style.display = 'block';
}

function renderClientList() {
    const container = document.getElementById('coach-client-list');
    
    if (REAL_CLIENTS.length === 0) {
        container.innerHTML = '<div style="padding:20px; color:#64748b; font-style:italic;">No clients registered yet.</div>';
        return;
    }
    
    container.innerHTML = REAL_CLIENTS.map(c => `
        <div class="activity-item" style="cursor:pointer;" onclick="openClientProfile('${c.id}')">
            <div class="activity-icon" style="background:${c.status === 'danger' ? '#FEE2E2' : c.status === 'warning' ? '#FEF3C7' : '#F1F5F9'}">${c.avatar}</div>
            <div style="flex:1;">
                <div style="font-weight:600;">${c.name}</div>
                <div style="font-size:0.85rem; color:#64748b;">${c.email || ''}</div>
                <div style="font-size:0.75rem; color:#94a3b8; margin-top:2px;">Day ${c.programDay || '?'} • ${c.lastAct}</div>
            </div>
            <div style="color:var(--primary);">→</div>
        </div>
    `).join('');
}

async function openClientProfile(clientId) {
    document.getElementById('client-list-view').style.display = 'none';
    document.getElementById('single-client-view').style.display = 'block';
    
    const client = REAL_CLIENTS.find(c => c.id === clientId);
    if (!client) {
        console.error('Client not found:', clientId);
        return;
    }
    
    // Update header
    document.getElementById('sc-name').innerText = client.name;
    document.getElementById('sc-avatar').innerText = client.avatar;
    document.getElementById('sc-status').innerHTML = `
        <span style="color:${client.status === 'good' ? 'green' : client.status === 'warning' ? 'orange' : 'red'};">●</span>
        Day ${client.programDay || '?'} • ${client.profile} • ${client.email}
    `;
    
    // Try to get more detailed stats
    try {
        // Get their full chat history
        const chatHistory = await dbHelpers.conversations.getHistory(clientId, 'coach', 50);
        
        // Update the stats grid
        const statsGrid = document.querySelector('#single-client-view .dashboard-grid > div:first-child');
        if (statsGrid) {
            statsGrid.innerHTML = `
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">PROGRAM DAY</div>
                    <div style="font-size:1.5rem; font-weight:bold;">${client.programDay || '-'}</div>
                    <div style="color:var(--primary); font-size:0.8rem;">of 28</div>
                </div>
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">MESSAGES</div>
                    <div style="font-size:1.5rem; font-weight:bold;">${chatHistory.length}</div>
                    <div style="color:#64748b; font-size:0.8rem;">Total</div>
                </div>
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">LAST ACTIVE</div>
                    <div style="font-size:1rem; font-weight:bold;">${client.lastAct}</div>
                </div>
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">PROFILE</div>
                    <div style="font-size:1rem; font-weight:bold;">${client.profile}</div>
                </div>
            `;
        }
        
        // Add chat history viewer
        renderClientChatHistory(chatHistory);
        
    } catch (error) {
        console.error('Failed to load client details:', error);
    }
}

function renderClientChatHistory(history) {
    // Find or create chat history container
    let container = document.getElementById('client-chat-history');
    if (!container) {
        // Create container if it doesn't exist
        const singleView = document.getElementById('single-client-view');
        const existingGrid = singleView.querySelector('.dashboard-grid');
        
        const chatCard = document.createElement('div');
        chatCard.className = 'd-card';
        chatCard.style.gridColumn = '1 / -1';
        chatCard.innerHTML = `
            <h3>💬 Conversation History</h3>
            <div id="client-chat-history" style="max-height:400px; overflow-y:auto; padding:10px; background:#f8fafc; border-radius:12px;"></div>
        `;
        existingGrid.appendChild(chatCard);
        container = document.getElementById('client-chat-history');
    }
    
    if (history.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-style:italic; padding:10px;">No messages yet.</div>';
        return;
    }
    
    container.innerHTML = history.map(msg => {
        const isUser = msg.role === 'user';
        const time = msg.brisbane_time || new Date(msg.timestamp).toLocaleString();
        return `
            <div style="display:flex; gap:10px; margin-bottom:12px; ${isUser ? 'justify-content:flex-end;' : ''}">
                ${!isUser ? '<div style="width:32px; height:32px; background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; flex-shrink:0;">🤖</div>' : ''}
                <div style="max-width:70%; ${isUser ? 'background:#064e3b; color:white;' : 'background:white; border:1px solid #e2e8f0;'} padding:10px 14px; border-radius:16px;">
                    <div style="font-size:0.9rem; white-space:pre-wrap;">${msg.message_text}</div>
                    <div style="font-size:0.7rem; ${isUser ? 'color:rgba(255,255,255,0.7);' : 'color:#94a3b8;'} margin-top:5px;">${time}</div>
                </div>
                ${isUser ? '<div style="width:32px; height:32px; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; flex-shrink:0;">👤</div>' : ''}
            </div>
        `;
    }).join('');
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function closeClientProfile() {
    document.getElementById('single-client-view').style.display = 'none';
    document.getElementById('client-list-view').style.display = 'block';
}

function openAsClient() {
    // Switch to normal dashboard view
    toggleCoachMode(false);
    // Ideally we would load the specific client's data into the view
    // For "Current User", it's already there.
    // For others, we'd need to mock swap the data, but for this task we'll just close the coach view
    // and show the "Current" view as a demo of the "Open" functionality.
}

</script>

<!-- CHECK-IN MODAL (Moved to root) -->
<div id="checkin-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10005; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
    <div style="background:white; width:90%; max-width:400px; border-radius:24px; padding:30px; position:relative; animation: slideUp 0.3s ease-out;">
        <h2 style="color:var(--primary); margin:0 0 10px 0; text-align:center;">Daily Check-in</h2>
        <p style="text-align:center; color:#64748b; margin-bottom:25px; font-size:0.95rem;">Let's customize your session for today.</p>

        <!-- Step 1: Energy -->
        <div style="margin-bottom:20px;">
            <label style="display:block; font-weight:600; margin-bottom:10px; color:var(--text-main);">How is your energy?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="selectEnergy('high')" id="btn-energy-high" class="checkin-btn" style="padding:15px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer; transition:all 0.2s;">
                    <div style="font-size:1.5rem;">⚡</div>
                    <div style="font-weight:600; margin-top:5px;">High</div>
                </button>
                <button onclick="selectEnergy('low')" id="btn-energy-low" class="checkin-btn" style="padding:15px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer; transition:all 0.2s;">
                    <div style="font-size:1.5rem;">🪫</div>
                    <div style="font-weight:600; margin-top:5px;">Low</div>
                </button>
            </div>
        </div>

        <!-- Step 2: Equipment -->
        <div style="margin-bottom:30px;">
            <label style="display:block; font-weight:600; margin-bottom:10px; color:var(--text-main);">Equipment Access?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <button onclick="selectEquipment('none')" id="btn-eq-none" class="checkin-btn" style="padding:10px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer;">
                    <span style="font-size:1.2rem;">🧘</span><br><span style="font-size:0.8rem; font-weight:600;">None</span>
                </button>
                <button onclick="selectEquipment('dumbbells')" id="btn-eq-dumbbells" class="checkin-btn" style="padding:10px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer;">
                    <span style="font-size:1.2rem;">🏋️</span><br><span style="font-size:0.8rem; font-weight:600;">Dumbbells</span>
                </button>
                <button onclick="selectEquipment('gym')" id="btn-eq-gym" class="checkin-btn" style="padding:10px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer;">
                    <span style="font-size:1.2rem;">🏢</span><br><span style="font-size:0.8rem; font-weight:600;">Gym</span>
                </button>
            </div>
        </div>

        <button onclick="submitCheckIn()" style="width:100%; background:var(--primary); color:white; border:none; padding:16px; border-radius:50px; font-weight:700; font-size:1rem; cursor:pointer;">Build My Workout</button>
    </div>
</div>


<!-- Cycle Tracking Modal -->
<div class="onboarding-overlay" id="cycle-tracking-modal" style="display:none; z-index:12000;">
    <div class="onboarding-modal" style="max-width: 450px; padding: 0; overflow: hidden;">

        <!-- HEADER -->
        <div style="padding: 25px 25px 0 25px; text-align: center; position:relative;">
            <div onclick="closeCycleTrackingModal()" style="position:absolute; top:15px; right:15px; width:30px; height:30px; line-height:30px; background:#f1f5f9; border-radius:50%; cursor:pointer; font-size:1.2rem; color:#64748b; font-weight:bold;">&times;</div>
            <h2 style="margin:0; color:var(--primary);">Cycle Tracking</h2>
        </div>

        <!-- CONTENT -->
        <div style="padding: 25px;">
            <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🌸</div>
            <h3 style="text-align:center; margin-bottom:10px;">Cycle Syncing</h3>
            <p style="text-align:center; color:#666; margin-bottom:25px;">We tailor your daily movement to match your hormonal phase.</p>

            <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">When was your last period?</label>
                <input type="date" id="cycle-modal-period-date" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
            </div>

            <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Cycle Length (Days)</label>
                <input type="number" id="cycle-modal-cycle-length" value="28" min="21" max="35" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
            </div>

            <div style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:20px;">
                <input type="checkbox" id="cycle-modal-wellness-toggle">
                <label for="cycle-modal-wellness-toggle" style="font-size:0.9rem; color:#64748b;">I don't have a period (Wellness Mode)</label>
            </div>

            <button onclick="saveCycleTrackingData()" style="width:100%; background:var(--primary); color:white; border:none; padding:16px; border-radius:50px; font-weight:700; font-size:1rem; cursor:pointer;">Save Changes</button>
        </div>
    </div>
</div>

<!-- Recalculate Calories Wizard Modal -->
<div class="onboarding-overlay" id="recalculate-calories-wizard" style="display:none; z-index:200000;">
    <div class="onboarding-modal wizard-container" style="max-width: 450px; max-height: 90vh; padding: 0; overflow: hidden; display: flex; flex-direction: column;">

        <!-- HEADER -->
        <div class="wizard-header" style="padding: 25px 25px 0 25px; text-align: center; position:relative; flex-shrink: 0;">
            <div onclick="closeRecalculateWizard()" style="position:absolute; top:15px; right:15px; width:30px; height:30px; line-height:30px; background:#f1f5f9; border-radius:50%; cursor:pointer; font-size:1.2rem; color:#64748b; font-weight:bold;">&times;</div>
            <div class="recalc-wizard-progress" style="display:flex; justify-content:center; gap:6px; margin-bottom:15px;">
                <div class="dot active"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <h2 id="recalc-wizard-title" style="margin:0; color:var(--primary);">Update Your Goals</h2>
        </div>

        <!-- CONTENT SLIDES -->
        <div class="wizard-content" style="flex: 1; padding: 25px; overflow-y: auto; min-height: 0;">

            <!-- SLIDE 1: SEX SELECTION -->
            <div class="recalc-wizard-slide active" id="recalc-slide-1">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🔄</div>
                <h3 style="text-align:center; margin-bottom:10px;">Let's Update Your Profile</h3>
                <p style="text-align:center; color:#666; margin-bottom:30px;">Select your program:</p>

                <div style="display:flex; flex-direction:column; gap:15px; max-width:300px; margin:0 auto;">
                    <button type="button" id="recalc-gender-btn-female" onclick="selectRecalcGender('female')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">🌸</span>
                        <span>For Her</span>
                    </button>

                    <button type="button" id="recalc-gender-btn-male" onclick="selectRecalcGender('male')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">💪</span>
                        <span>For Him</span>
                    </button>
                </div>

                <input type="hidden" id="recalc-wizard-gender" value="">
            </div>

            <!-- SLIDE 2: ESSENTIAL DATA -->
            <div class="recalc-wizard-slide" id="recalc-slide-2" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">📋</div>
                <h3 style="text-align:center; margin-bottom:10px;">Your Details</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">Update your information to recalculate your goals.</p>

                <!-- Age -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Age</label>
                    <input type="number" id="recalc-wizard-age" class="wizard-input" placeholder="25" min="18" max="100" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Height & Weight -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Height (cm)</label>
                        <input type="number" id="recalc-wizard-height" class="wizard-input" placeholder="170" min="100" max="250" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Weight (kg)</label>
                        <input type="number" id="recalc-wizard-weight" class="wizard-input" placeholder="70" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                </div>

                <!-- Goal Weight -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Goal Weight (kg)</label>
                    <input type="number" id="recalc-wizard-goal-weight" class="wizard-input" placeholder="65" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Activity Level -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Activity Level</label>
                    <select id="recalc-wizard-activity-level" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="sedentary">Sedentary (Little or no exercise)</option>
                        <option value="light">Lightly Active (Exercise 1-3 days/week)</option>
                        <option value="moderate">Moderately Active (Exercise 3-5 days/week)</option>
                        <option value="very">Very Active (Exercise 6-7 days/week)</option>
                    </select>
                </div>

                <!-- Primary Goal -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">What's your primary goal?</label>
                    <select id="recalc-wizard-goal-type" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select your goal</option>
                        <option value="Flat">Lose weight / Get lean</option>
                        <option value="Athletic">Get toned / Maintain fitness</option>
                        <option value="Body Builder">Build muscle / Gain strength</option>
                    </select>
                </div>
            </div>

            <!-- SLIDE 3: CONFIRMATION -->
            <div class="recalc-wizard-slide" id="recalc-slide-3" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">✨</div>
                <h3 style="text-align:center; margin-bottom:10px;">Your New Goals</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">Here are your updated daily targets:</p>

                <div id="recalc-results" style="background:#f0fdf4; border:1px solid #bbf7d0; padding:20px; border-radius:12px; margin-bottom:20px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                        <div style="text-align:center; padding:15px; background:white; border-radius:10px;">
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px;">Daily Calories</div>
                            <div id="recalc-result-calories" style="font-size:1.5rem; font-weight:700; color:var(--primary);">--</div>
                        </div>
                        <div style="text-align:center; padding:15px; background:white; border-radius:10px;">
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px;">Protein</div>
                            <div id="recalc-result-protein" style="font-size:1.5rem; font-weight:700; color:var(--primary);">--</div>
                        </div>
                        <div style="text-align:center; padding:15px; background:white; border-radius:10px;">
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px;">Carbs</div>
                            <div id="recalc-result-carbs" style="font-size:1.5rem; font-weight:700; color:var(--primary);">--</div>
                        </div>
                        <div style="text-align:center; padding:15px; background:white; border-radius:10px;">
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px;">Fat</div>
                            <div id="recalc-result-fat" style="font-size:1.5rem; font-weight:700; color:var(--primary);">--</div>
                        </div>
                    </div>
                </div>

                <div style="background:rgba(72,134,75,0.1); border-radius:10px; padding:12px; text-align:center;">
                    <p style="margin:0; font-size:0.85rem; color:#1a4d2e;">
                        <strong>📊 Based on your profile:</strong><br>
                        <span id="recalc-summary-text">Your goals have been personalized for your journey.</span>
                    </p>
                </div>
            </div>

        </div>

        <!-- FOOTER WITH BUTTONS -->
        <div class="wizard-footer" style="padding: 0 25px 25px 25px; flex-shrink: 0;">
            <div style="display:flex; gap:10px;">
                <button id="recalc-btn-back" onclick="recalcWizardBack()" style="flex:1; padding:14px; border-radius:50px; border:2px solid var(--primary); background:white; color:var(--primary); font-weight:700; cursor:pointer; display:none;">Back</button>
                <button id="recalc-btn-next" onclick="recalcWizardNext()" style="flex:2; padding:14px; border-radius:50px; border:none; background:var(--primary); color:white; font-weight:700; cursor:pointer;">Next</button>
            </div>
        </div>

    </div>
</div>

<!-- Onboarding Modal -->
<!-- ONBOARDING WIZARD -->
<div class="onboarding-overlay" id="onboarding-wizard" style="display:none; z-index:12000;">
    <div class="onboarding-modal wizard-container" style="max-width: 450px; max-height: 90vh; padding: 0; overflow: hidden; display: flex; flex-direction: column;">

        <!-- HEADER -->
        <div class="wizard-header" style="padding: 25px 25px 0 25px; text-align: center; position:relative; flex-shrink: 0;">
            <div onclick="closeWizardManually()" style="position:absolute; top:15px; right:15px; width:30px; height:30px; line-height:30px; background:#f1f5f9; border-radius:50%; cursor:pointer; font-size:1.2rem; color:#64748b; font-weight:bold;">&times;</div>
            <div class="wizard-progress" style="display:flex; justify-content:center; gap:6px; margin-bottom:15px;">
                <div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <h2 id="wizard-title" style="margin:0; color:var(--primary);">Let's Align Your Body</h2>
        </div>

        <!-- CONTENT SLIDES -->
        <div class="wizard-content" style="flex: 1; padding: 25px; overflow-y: auto; min-height: 0;">

            <!-- SLIDE 1: GENDER SELECTION -->
            <div class="wizard-slide slide-active" id="slide-1">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🌟</div>
                <h3 style="text-align:center; margin-bottom:10px;">Welcome to Your Journey</h3>
                <p style="text-align:center; color:#666; margin-bottom:30px;">Select your program to get started:</p>

                <div style="display:flex; flex-direction:column; gap:15px; max-width:300px; margin:0 auto;">
                    <button type="button" id="gender-btn-female" onclick="selectGender('female')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">🌸</span>
                        <span>For Her</span>
                    </button>

                    <button type="button" id="gender-btn-male" onclick="selectGender('male')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">💪</span>
                        <span>For Him</span>
                    </button>
                </div>

                <input type="hidden" id="wizard-gender" value="">
            </div>

            <!-- SLIDE 2: ESSENTIAL DATA COLLECTION -->
            <div class="wizard-slide" id="slide-2" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">📋</div>
                <h3 style="text-align:center; margin-bottom:10px;">Let's Get Started</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">We need a few details to personalize your program.</p>

                <!-- Name -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">What's your name?</label>
                    <input type="text" id="wizard-name" class="wizard-input" placeholder="Enter your name" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Age -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Age</label>
                    <input type="number" id="wizard-age" class="wizard-input" placeholder="25" min="18" max="100" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Height & Weight -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Height (cm)</label>
                        <input type="number" id="wizard-height" class="wizard-input" placeholder="170" min="100" max="250" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Weight (kg)</label>
                        <input type="number" id="wizard-weight" class="wizard-input" placeholder="70" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                </div>

                <!-- Goal Weight -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Goal Weight (kg)</label>
                    <input type="number" id="wizard-goal-weight" class="wizard-input" placeholder="65" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Primary Goal -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">What's your primary goal?</label>
                    <select id="wizard-goal-type" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select your goal</option>
                        <option value="Flat">Lose weight / Get lean</option>
                        <option value="Athletic">Get toned / Maintain fitness</option>
                        <option value="Body Builder">Build muscle / Gain strength</option>
                    </select>
                </div>

                <!-- Equipment Access -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Where do you train?</label>
                    <select id="wizard-equipment" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="gym">Full Gym Access</option>
                        <option value="dumbbells">Dumbbells (or Dumbbells + Bands)</option>
                        <option value="bands">Resistance Bands Only</option>
                        <option value="none">Just a Mat (No Equipment)</option>
                        <option value="yoga_only">Yoga / Stretching Only</option>
                    </select>
                </div>

                <!-- Activity Level -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Activity Level</label>
                    <select id="wizard-activity-level" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="sedentary">Sedentary (Little or no exercise)</option>
                        <option value="light">Lightly Active (Exercise 1-3 days/week)</option>
                        <option value="moderate">Moderately Active (Exercise 3-5 days/week)</option>
                        <option value="very">Very Active (Exercise 6-7 days/week)</option>
                    </select>
                </div>

                <!-- Energy Level -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Energy Status</label>
                    <select id="wizard-energy-level" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="low">Low Energy (Often tired)</option>
                        <option value="normal">Normal Energy</option>
                        <option value="high">High Energy</option>
                    </select>
                </div>

                <!-- Dietary Preference -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-top:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Dietary Preference</label>
                    <select id="wizard-dietary-preference" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select your diet</option>
                        <option value="omnivore">Omnivore (I eat everything)</option>
                        <option value="pescatarian">Pescatarian (Fish, no meat)</option>
                        <option value="vegetarian">Vegetarian (No meat or fish)</option>
                        <option value="vegan">Vegan (100% plant-based)</option>
                        <option value="flexitarian">Flexitarian (Mostly plant-based)</option>
                    </select>
                </div>
            </div>

            <!-- SLIDE 3: CYCLE SETUP (females only) -->
            <div class="wizard-slide" id="slide-3" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🌸</div>
                <h3 style="text-align:center; margin-bottom:10px;">Cycle Syncing</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">We tailor your daily movement to match your hormonal phase.</p>

                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">When was your last period?</label>
                    <input type="date" id="wizard-period-date" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <div class="wizard-option" style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:20px;">
                    <input type="checkbox" id="wizard-wellness-toggle" onchange="toggleWizardPeriodInput()">
                    <label for="wizard-wellness-toggle" style="font-size:0.9rem; color:#64748b;">I don't have a period (Wellness Mode)</label>
                </div>

                <!-- NEW QUESTION 1: Cycle Sync Preference -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:12px; font-size:0.9rem;">Do you want to sync your workouts with your cycle?</label>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:white; transition: all 0.2s ease;">
                            <input type="radio" name="wizard-cycle-sync" value="yes" onchange="togglePeriodEnergyQuestion()" style="margin:0;">
                            <span style="font-size:0.9rem;">Yes, sync my workouts</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:white; transition: all 0.2s ease;">
                            <input type="radio" name="wizard-cycle-sync" value="no" onchange="togglePeriodEnergyQuestion()" style="margin:0;">
                            <span style="font-size:0.9rem;">No, standard recommendations</span>
                        </label>
                    </div>
                </div>

                <!-- NEW QUESTION 2: Period Energy Response (Conditional) -->
                <div id="period-energy-section" class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; display:none;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">How does your body respond during your period?</label>
                    <p style="font-size:0.8rem; color:#64748b; margin-bottom:12px;">We'll automatically adjust your workouts during menstruation (days 1-5).</p>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:white; transition: all 0.2s ease;">
                            <input type="radio" name="wizard-period-energy" value="high" style="margin:0;">
                            <span style="font-size:0.9rem;">High Energy - I can push hard</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:white; transition: all 0.2s ease;">
                            <input type="radio" name="wizard-period-energy" value="low" style="margin:0;">
                            <span style="font-size:0.9rem;">Low Energy/Tired - I need gentler workouts</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- SLIDE 4: WORKOUT FREQUENCY & DAYS -->
            <div class="wizard-slide" id="slide-4" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🏋️</div>
                <h3 style="text-align:center; margin-bottom:10px;">Design Your Training Week</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">How many days per week do you want to train?</p>

                <!-- Frequency Selector -->
                <div style="display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-bottom:20px;">
                    <button type="button" onclick="selectTrainingFrequency(2)" class="freq-btn" data-freq="2" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">2</button>
                    <button type="button" onclick="selectTrainingFrequency(3)" class="freq-btn" data-freq="3" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">3</button>
                    <button type="button" onclick="selectTrainingFrequency(4)" class="freq-btn" data-freq="4" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">4</button>
                    <button type="button" onclick="selectTrainingFrequency(5)" class="freq-btn" data-freq="5" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">5</button>
                    <button type="button" onclick="selectTrainingFrequency(6)" class="freq-btn" data-freq="6" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">6</button>
                    <button type="button" onclick="selectTrainingFrequency(7)" class="freq-btn" data-freq="7" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">7</button>
                </div>
                <p id="freq-tip" style="text-align:center; color:#48864B; font-size:13px; min-height:35px; padding:8px; background:rgba(72,134,75,0.1); border-radius:8px; margin-bottom:20px;">Select how many days you want to train</p>

                <!-- Day Selector -->
                <p style="text-align:center; color:#666; margin-bottom:10px; font-weight:600;">Which days work for you?</p>
                <div style="display:flex; justify-content:center; gap:6px; flex-wrap:wrap; margin-bottom:15px;">
                    <button type="button" onclick="toggleTrainingDay('monday')" class="day-btn" data-day="monday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Mon</button>
                    <button type="button" onclick="toggleTrainingDay('tuesday')" class="day-btn" data-day="tuesday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Tue</button>
                    <button type="button" onclick="toggleTrainingDay('wednesday')" class="day-btn" data-day="wednesday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Wed</button>
                    <button type="button" onclick="toggleTrainingDay('thursday')" class="day-btn" data-day="thursday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Thu</button>
                    <button type="button" onclick="toggleTrainingDay('friday')" class="day-btn" data-day="friday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Fri</button>
                    <button type="button" onclick="toggleTrainingDay('saturday')" class="day-btn" data-day="saturday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Sat</button>
                    <button type="button" onclick="toggleTrainingDay('sunday')" class="day-btn" data-day="sunday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Sun</button>
                </div>
                <p id="days-counter" style="text-align:center; color:#64748b; font-size:12px;">Select your training days</p>

                <!-- Recovery Toggle -->
                <div style="margin-top:20px; background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="checkbox" id="wizard-recovery-days" checked style="width:18px; height:18px;">
                        <span style="font-size:0.9rem;">Add yoga & recovery on rest days</span>
                    </label>
                </div>

                <input type="hidden" id="wizard-training-frequency" value="">
                <input type="hidden" id="wizard-training-days" value="">
            </div>

            <!-- SLIDE 5: SPLIT PREFERENCE (gym users only) -->
            <div class="wizard-slide" id="slide-5" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">💪</div>
                <h3 style="text-align:center; margin-bottom:10px;">Choose Your Training Split</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">How do you want to structure your workouts?</p>

                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button type="button" onclick="selectSplitPreference('full_body')" class="split-btn" data-split="full_body" style="text-align:left; padding:15px; border-radius:12px; border:2px solid #e2e8f0; background:#fff; cursor:pointer;">
                        <div style="font-weight:700; color:#1a4d2e;">Full Body</div>
                        <div style="font-size:12px; color:#666;">Train all muscle groups each session</div>
                        <div style="font-size:11px; color:#48864B; margin-top:4px;">Best for: 2-3 days/week</div>
                    </button>
                    <button type="button" onclick="selectSplitPreference('ppl')" class="split-btn" data-split="ppl" style="text-align:left; padding:15px; border-radius:12px; border:2px solid #e2e8f0; background:#fff; cursor:pointer;">
                        <div style="font-weight:700; color:#1a4d2e;">Push / Pull / Legs</div>
                        <div style="font-size:12px; color:#666;">Split by movement patterns</div>
                        <div style="font-size:11px; color:#48864B; margin-top:4px;">Best for: 3-6 days/week</div>
                    </button>
                    <button type="button" onclick="selectSplitPreference('upper_lower')" class="split-btn" data-split="upper_lower" style="text-align:left; padding:15px; border-radius:12px; border:2px solid #e2e8f0; background:#fff; cursor:pointer;">
                        <div style="font-weight:700; color:#1a4d2e;">Upper / Lower</div>
                        <div style="font-size:12px; color:#666;">Alternate upper and lower body</div>
                        <div style="font-size:11px; color:#48864B; margin-top:4px;">Best for: 4 days/week</div>
                    </button>
                    <button type="button" onclick="selectSplitPreference('bro_split')" class="split-btn" data-split="bro_split" style="text-align:left; padding:15px; border-radius:12px; border:2px solid #e2e8f0; background:#fff; cursor:pointer;">
                        <div style="font-weight:700; color:#1a4d2e;">Bro Split</div>
                        <div style="font-size:12px; color:#666;">One muscle group per day</div>
                        <div style="font-size:11px; color:#48864B; margin-top:4px;">Best for: 5-6 days/week</div>
                    </button>
                </div>

                <input type="hidden" id="wizard-split-preference" value="">
            </div>

            <!-- SLIDE 6: CALENDAR PREVIEW -->
            <div class="wizard-slide" id="slide-6" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">📅</div>
                <h3 style="text-align:center; margin-bottom:10px;">Your Workout Week</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Here's your personalized schedule</p>

                <div id="wizard-calendar-preview" style="background:#fff; border-radius:12px; padding:15px; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                    <!-- Dynamically populated -->
                </div>

                <div style="background:rgba(72,134,75,0.1); border-radius:10px; padding:12px; margin-top:15px; text-align:center;">
                    <p style="margin:0; font-size:13px; color:#1a4d2e;">
                        <strong>📈 48-Week Program:</strong> Each workout evolves over time - you'll never do the same workout twice in a row!
                    </p>
                </div>
            </div>

            <!-- SLIDE 7: MEET YOUR FITGOTCHI -->
            <div class="wizard-slide" id="slide-7" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🐣</div>
                <h3 style="text-align:center; margin-bottom:10px;">Meet Your FitGotchi</h3>
                <p style="text-align:center; color:#666; margin-bottom:15px;">Your personal fitness companion that grows with you!</p>

                <!-- FitGotchi 3D Preview -->
                <div style="width: 100%; height: 320px; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); border-radius: 12px; overflow: hidden; margin-bottom: 15px; position: relative;">
                    <model-viewer
                        id="wizard-fitgotchi-preview"
                        data-lazy-src="https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb"
                        loading="lazy"
                        camera-controls
                        disable-zoom
                        disable-pan
                        auto-rotate
                        rotation-intensity="0.5"
                        shadow-intensity="1"
                        exposure="0.9"
                        camera-orbit="0deg 85deg 20m"
                        field-of-view="30deg"
                        style="width: 100%; height: 100%; --poster-color: transparent;"
                        interaction-prompt="none">
                    </model-viewer>
                </div>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:12px; border:1px solid #bbf7d0; border-radius:10px;">
                        <span style="font-size:1.3rem;">💪</span>
                        <div><strong>Levels up with you</strong><br><span style="font-size:0.8rem; color:#166534;">Earn XP and watch your character evolve through 99 levels</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #fef3c7, #fde68a); padding:12px; border:1px solid #fcd34d; border-radius:10px;">
                        <span style="font-size:1.3rem;">🎨</span>
                        <div><strong>Customize everything</strong><br><span style="font-size:0.8rem; color:#92400e;">Hair, outfit & skin tone - make it yours</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #e0e7ff, #c7d2fe); padding:12px; border:1px solid #a5b4fc; border-radius:10px;">
                        <span style="font-size:1.3rem;">✨</span>
                        <div><strong>Unlock rare skins</strong><br><span style="font-size:0.8rem; color:#4338ca;">Win legendary characters like Arny in challenges</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 8: EASY CALORIE TRACKING -->
            <div class="wizard-slide" id="slide-8" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">📸</div>
                <h3 style="text-align:center; margin-bottom:10px;">Easy Calorie Tracking</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">The easiest way to track your nutrition</p>

                <!-- Hero Feature -->
                <div style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:20px; border-radius:16px; border:1px solid #bbf7d0; text-align:center; margin-bottom:15px;">
                    <div style="font-size:3rem; margin-bottom:10px;">🤳</div>
                    <p style="margin:0; font-size:1rem; font-weight:700; color:#166534;">Snap a photo. AI does the rest.</p>
                    <p style="margin:5px 0 0; font-size:0.85rem; color:#166534;">Our AI recognizes your food and logs calories, protein, carbs & fat instantly.</p>
                </div>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:10px 12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📊</span>
                        <div><strong>Track macros</strong><br><span style="font-size:0.8rem; color:#666;">Personalized calorie & macro targets based on your goals</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:10px 12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🥗</span>
                        <div><strong>Meal plans & recipes</strong><br><span style="font-size:0.8rem; color:#666;">Browse meals, smoothies & snacks tailored to your diet</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 9: YOUR HYDRATION GOAL -->
            <div class="wizard-slide" id="slide-9" style="display:none;">
                <div style="text-align:center; margin-bottom:10px; font-size:3rem;">💧</div>
                <h3 style="text-align:center; margin-bottom:6px;">Your Hydration Goal</h3>
                <p style="text-align:center; color:#666; margin-bottom:18px; font-size:0.88rem;">We calculated your ideal daily water intake based on your body weight and activity level.</p>

                <!-- Recommended Goal Display -->
                <div style="background:linear-gradient(135deg, #e0f2fe, #bae6fd); padding:18px; border-radius:16px; border:1px solid #7dd3fc; text-align:center; margin-bottom:18px;">
                    <p style="margin:0 0 4px; font-size:0.8rem; color:#0369a1; font-weight:600;">Your Recommended Daily Intake</p>
                    <div id="wizard-water-recommended" style="font-size:1.6rem; font-weight:800; color:#0c4a6e;">2,100 ml</div>
                    <p id="wizard-water-formula-note" style="margin:4px 0 0; font-size:0.72rem; color:#0369a1;">Based on your weight &times; 33ml/kg + activity adjustment</p>
                </div>

                <!-- Adjustable Goal -->
                <div style="background:#f8fafc; padding:16px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:14px;">
                    <label style="display:block; font-weight:600; margin-bottom:10px; font-size:0.88rem; text-align:center;">Set Your Daily Goal</label>
                    <div style="display:flex; align-items:center; justify-content:center; gap:14px;">
                        <button type="button" onclick="adjustWaterGoal(-250)" style="width:40px; height:40px; border-radius:50%; border:2px solid #0284c7; background:white; color:#0284c7; font-size:1.3rem; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1;">−</button>
                        <div style="text-align:center; min-width:100px;">
                            <div id="wizard-water-goal" style="font-size:1.8rem; font-weight:800; color:#0c4a6e;">2,100</div>
                            <div style="font-size:0.75rem; color:#64748b; font-weight:600;">ml / day</div>
                        </div>
                        <button type="button" onclick="adjustWaterGoal(250)" style="width:40px; height:40px; border-radius:50%; border:2px solid #0284c7; background:white; color:#0284c7; font-size:1.3rem; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1;">+</button>
                    </div>
                    <input type="hidden" id="wizard-water-goal-ml" value="2100">
                </div>

                <!-- Glass Size Selection -->
                <div style="background:#f8fafc; padding:16px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:14px;">
                    <label style="display:block; font-weight:600; margin-bottom:10px; font-size:0.88rem; text-align:center;">What size is your cup/bottle?</label>
                    <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                        <button type="button" onclick="selectGlassSize(200)" class="glass-size-btn" data-size="200" style="padding:8px 14px; border-radius:10px; border:2px solid #e2e8f0; background:white; font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; color:#334155;">200ml</button>
                        <button type="button" onclick="selectGlassSize(250)" class="glass-size-btn active" data-size="250" style="padding:8px 14px; border-radius:10px; border:2px solid #0284c7; background:#e0f2fe; font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; color:#0c4a6e;">250ml</button>
                        <button type="button" onclick="selectGlassSize(350)" class="glass-size-btn" data-size="350" style="padding:8px 14px; border-radius:10px; border:2px solid #e2e8f0; background:white; font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; color:#334155;">350ml</button>
                        <button type="button" onclick="selectGlassSize(500)" class="glass-size-btn" data-size="500" style="padding:8px 14px; border-radius:10px; border:2px solid #e2e8f0; background:white; font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; color:#334155;">500ml</button>
                    </div>
                    <input type="hidden" id="wizard-glass-size" value="250">
                </div>

                <!-- Glass Count Preview -->
                <div style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:14px; border-radius:12px; border:1px solid #bbf7d0; text-align:center;">
                    <p style="margin:0; font-size:0.88rem; color:#166534; font-weight:600;">
                        That's <span id="wizard-glass-count" style="font-size:1.1rem; font-weight:800;">8</span> cups per day
                    </p>
                    <p style="margin:4px 0 0; font-size:0.75rem; color:#166534;">Tap the hydration circle in the Nutrition tab to log each cup</p>
                </div>
            </div>

            <!-- SLIDE 10: TRACK YOUR WORKOUTS -->
            <div class="wizard-slide" id="slide-10" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🏋️</div>
                <h3 style="text-align:center; margin-bottom:10px;">Track Your Workouts</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Every rep counts. We track it all.</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📝</span>
                        <div><strong>Log sets, reps & weight</strong><br><span style="font-size:0.8rem; color:#666;">Quick input during your workout with rest timers</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📈</span>
                        <div><strong>Volume & progress charts</strong><br><span style="font-size:0.8rem; color:#666;">See your total volume climb week over week</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🏅</span>
                        <div><strong>Personal bests</strong><br><span style="font-size:0.8rem; color:#666;">We automatically detect and celebrate your PBs</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📋</span>
                        <div><strong>Workout history</strong><br><span style="font-size:0.8rem; color:#666;">Full log of every session with max weights tracked</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 11: BUILD & BROWSE WORKOUTS -->
            <div class="wizard-slide" id="slide-11" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🔨</div>
                <h3 style="text-align:center; margin-bottom:10px;">Build & Browse Workouts</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Your gym, your rules.</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:12px; border:1px solid #bbf7d0; border-radius:10px;">
                        <span style="font-size:1.3rem;">🏗️</span>
                        <div><strong>Workout Builder</strong><br><span style="font-size:0.8rem; color:#166534;">Create custom workouts with any exercises you want</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #e0e7ff, #c7d2fe); padding:12px; border:1px solid #a5b4fc; border-radius:10px;">
                        <span style="font-size:1.3rem;">📚</span>
                        <div><strong>Program Library</strong><br><span style="font-size:0.8rem; color:#4338ca;">Hundreds of prebuilt programs for every level & goal</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #fef3c7, #fde68a); padding:12px; border:1px solid #fcd34d; border-radius:10px;">
                        <span style="font-size:1.3rem;">🔄</span>
                        <div><strong>48-week progressive programs</strong><br><span style="font-size:0.8rem; color:#92400e;">Workouts evolve over time - never do the same one twice</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 12: LEARN & LEVEL UP -->
            <div class="wizard-slide" id="slide-12" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🧠</div>
                <h3 style="text-align:center; margin-bottom:10px;">Learn & Level Up</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Duolingo-style fitness education</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📖</span>
                        <div><strong>Bite-sized lessons</strong><br><span style="font-size:0.8rem; color:#666;">Learn nutrition, training & recovery in fun modules</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🧩</span>
                        <div><strong>Interactive quizzes</strong><br><span style="font-size:0.8rem; color:#666;">Test your knowledge and earn XP for correct answers</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🏆</span>
                        <div><strong>Master modules</strong><br><span style="font-size:0.8rem; color:#666;">Complete all lessons to become a fitness expert</span></div>
                    </li>
                </ul>

                <div style="background:rgba(72,134,75,0.1); border-radius:10px; padding:10px; margin-top:12px; text-align:center;">
                    <p style="margin:0; font-size:0.8rem; color:#1a4d2e;"><strong>Tip:</strong> Quiz your friends in Quiz Battles and wager coins!</p>
                </div>
            </div>

            <!-- SLIDE 13: YOUR FEED -->
            <div class="wizard-slide" id="slide-13" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">📱</div>
                <h3 style="text-align:center; margin-bottom:10px;">Your Feed</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Share your wins and cheer on your friends</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:12px; border:1px solid #bbf7d0; border-radius:10px;">
                        <span style="font-size:1.3rem;">💪</span>
                        <div><strong>Share workouts to the feed</strong><br><span style="font-size:0.8rem; color:#166534;">Post your workout card with a gym selfie and earn <strong>2 XP</strong></span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">👀</span>
                        <div><strong>See what friends are up to</strong><br><span style="font-size:0.8rem; color:#666;">React to posts, leave comments, stay motivated together</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🔥</span>
                        <div><strong>Workout cards</strong><br><span style="font-size:0.8rem; color:#666;">Auto-generated cards showing your exercises, volume & PBs</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 14: CHALLENGE YOUR FRIENDS -->
            <div class="wizard-slide" id="slide-14" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">⚔️</div>
                <h3 style="text-align:center; margin-bottom:10px;">Challenge Your Friends</h3>
                <p style="text-align:center; color:#666; margin-bottom:15px;">Compete, battle & win rare rewards</p>

                <!-- Arny 3D Preview -->
                <div style="width: 100%; height: 240px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%); border-radius: 12px; overflow: hidden; margin-bottom: 12px; position: relative;">
                    <model-viewer
                        id="wizard-arny-preview"
                        data-lazy-src="https://f005.backblazeb2.com/file/shannonsvideos/arny.glb"
                        loading="lazy"
                        camera-controls
                        disable-zoom
                        disable-pan
                        auto-rotate
                        rotation-intensity="0.8"
                        shadow-intensity="1"
                        exposure="0.9"
                        camera-orbit="0deg 85deg 20m"
                        field-of-view="30deg"
                        style="width: 100%; height: 100%; --poster-color: transparent;"
                        interaction-prompt="none">
                    </model-viewer>
                    <div style="position:absolute; bottom:6px; left:10px; background:rgba(0,0,0,0.6); color:#fbbf24; padding:3px 10px; border-radius:8px; font-size:0.75rem; font-weight:700;">LEGENDARY: Arny</div>
                </div>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:8px;">
                    <li style="display:flex; align-items:center; gap:10px; background:white; padding:10px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.2rem;">🐲</span>
                        <div><strong>FitGotchi Battles</strong><br><span style="font-size:0.8rem; color:#666;">Battle friends' characters & wager coins</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:10px; background:white; padding:10px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.2rem;">⚡</span>
                        <div><strong>Quiz Battles</strong><br><span style="font-size:0.8rem; color:#666;">Live head-to-head fitness quizzes</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:10px; background:white; padding:10px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.2rem;">🎯</span>
                        <div><strong>30-Day Challenges</strong><br><span style="font-size:0.8rem; color:#666;">Compete on leaderboards & win rare skins</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:10px; background:white; padding:10px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.2rem;">✨</span>
                        <div><strong>Win rare characters</strong><br><span style="font-size:0.8rem; color:#666;">Arny, Goku, Optimus & more - 11 to collect!</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 15: COINS -->
            <div class="wizard-slide" id="slide-15" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🪙</div>
                <h3 style="text-align:center; margin-bottom:10px;">Coins</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Your in-app currency for battles, bets & rewards</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #fef3c7, #fde68a); padding:12px; border:1px solid #fcd34d; border-radius:10px;">
                        <span style="font-size:1.3rem;">💰</span>
                        <div><strong>Bet on battles</strong><br><span style="font-size:0.8rem; color:#92400e;">Wager coins on FitGotchi & Quiz Battles - winner takes all!</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🎯</span>
                        <div><strong>Enter challenges</strong><br><span style="font-size:0.8rem; color:#666;">Use coins to enter monthly challenges for rare rewards</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🛒</span>
                        <div><strong>Buy coin packs</strong><br><span style="font-size:0.8rem; color:#666;">Starter (500) to Ultimate (8,000) packs available</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🎭</span>
                        <div><strong>Unlock cosmetics</strong><br><span style="font-size:0.8rem; color:#666;">Spend coins on character customizations & backgrounds</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 16: ALL WAYS TO EARN XP -->
            <div class="wizard-slide" id="slide-16" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">⭐</div>
                <h3 style="text-align:center; margin-bottom:10px;">All Ways to Earn XP</h3>
                <p style="text-align:center; color:#666; margin-bottom:15px;">Every point levels up your FitGotchi!</p>

                <div style="display:flex; flex-direction:column; gap:8px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:10px 14px; border-radius:10px; border:1px solid #bbf7d0;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">📸</span> <span style="font-size:0.85rem; font-weight:600; color:#166534;">Log a meal photo</span></span>
                        <span style="font-weight:700; color:#166534; font-size:0.9rem;">+1 XP</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:10px 14px; border-radius:10px; border:1px solid #bbf7d0;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">💪</span> <span style="font-size:0.85rem; font-weight:600; color:#166534;">Complete a workout</span></span>
                        <span style="font-weight:700; color:#166534; font-size:0.9rem;">+1 XP</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #e0e7ff, #c7d2fe); padding:10px 14px; border-radius:10px; border:1px solid #a5b4fc;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">📱</span> <span style="font-size:0.85rem; font-weight:600; color:#4338ca;">Share to feed</span></span>
                        <span style="font-weight:700; color:#4338ca; font-size:0.9rem;">+2 XP</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #e0e7ff, #c7d2fe); padding:10px 14px; border-radius:10px; border:1px solid #a5b4fc;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">👥</span> <span style="font-size:0.85rem; font-weight:600; color:#4338ca;">Share to group chat</span></span>
                        <span style="font-weight:700; color:#4338ca; font-size:0.9rem;">+1 XP</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #fef3c7, #fde68a); padding:10px 14px; border-radius:10px; border:1px solid #fcd34d;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">🔥</span> <span style="font-size:0.85rem; font-weight:600; color:#92400e;">Streak bonuses</span></span>
                        <span style="font-weight:700; color:#92400e; font-size:0.9rem;">+bonus</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #fce7f3, #fbcfe8); padding:10px 14px; border-radius:10px; border:1px solid #f9a8d4;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">🤝</span> <span style="font-size:0.85rem; font-weight:600; color:#be185d;">Refer a friend</span></span>
                        <span style="font-weight:700; color:#be185d; font-size:0.9rem;">2x XP (7 days!)</span>
                    </div>
                </div>
            </div>

            <!-- SLIDE 17: DESIGN YOUR CHARACTER -->
            <div class="wizard-slide" id="slide-17" style="display:none;">
                <div style="text-align:center; margin-bottom:10px; font-size:3rem;">✨</div>
                <h3 style="text-align:center; margin-bottom:8px;">Design Your Character</h3>
                <p style="text-align:center; color:#666; margin-bottom:15px;">Make your FitGotchi your own!</p>

                <!-- Character Preview -->
                <div id="wizard-character-preview" style="width: 100%; height: 360px; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); border-radius: 12px; overflow: hidden; margin-bottom: 15px; position: relative;">
                    <model-viewer
                        id="wizard-preview-model"
                        data-lazy-src="https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb"
                        loading="lazy"
                        camera-controls
                        disable-zoom
                        disable-pan
                        auto-rotate
                        rotation-intensity="0.5"
                        shadow-intensity="1"
                        exposure="0.9"
                        camera-orbit="0deg 85deg 20m"
                        field-of-view="30deg"
                        style="width: 100%; height: 100%; --poster-color: transparent;"
                        interaction-prompt="none">
                    </model-viewer>
                </div>

                <!-- Color Options (hair, pants, skin ONLY) -->
                <div id="wizard-color-options" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
                    <!-- Hair Color -->
                    <div class="color-option-group" style="margin-bottom: 15px;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Hair Color</label>
                        <div id="wizard-hair-colors" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                    </div>

                    <!-- Shorts/Pants Color -->
                    <div class="color-option-group" style="margin-bottom: 15px;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Shorts Color</label>
                        <div id="wizard-pants-colors" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                    </div>

                    <!-- Skin Tone -->
                    <div class="color-option-group" style="margin-bottom: 10px;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Skin Tone</label>
                        <div id="wizard-skin-colors" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                    </div>
                </div>
            </div>

            <!-- SLIDE 17: SET YOUR PROFILE PICTURE -->
            <div class="wizard-slide" id="slide-18" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">📸</div>
                <h3 style="text-align:center; margin-bottom:10px;">Set Your Profile Picture</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">This is how your friends will see you in the feed & battles</p>

                <!-- Profile Photo Preview -->
                <div style="display:flex; flex-direction:column; align-items:center; gap:20px; margin-bottom:20px;">
                    <div id="wizard-profile-photo-container" style="width:150px; height:150px; border-radius:50%; background:linear-gradient(135deg, #e2e8f0, #cbd5e1); display:flex; align-items:center; justify-content:center; overflow:hidden; border:4px solid var(--primary); box-shadow:0 8px 24px rgba(4,106,56,0.2); cursor:pointer;" onclick="document.getElementById('wizard-profile-photo-input').click()">
                        <div id="wizard-profile-photo-placeholder" style="text-align:center;">
                            <div style="font-size:3rem; margin-bottom:4px;">👤</div>
                            <span style="font-size:0.75rem; color:#64748b; font-weight:600;">Tap to add</span>
                        </div>
                        <img id="wizard-profile-photo-img" style="width:100%; height:100%; object-fit:cover; display:none;" alt="Profile">
                    </div>
                    <input type="file" id="wizard-profile-photo-input" accept="image/*" style="display:none;" onchange="handleWizardProfilePhoto(this)">

                    <button type="button" onclick="document.getElementById('wizard-profile-photo-input').click()" style="padding:12px 28px; border-radius:25px; border:2px solid var(--primary); background:white; color:var(--primary); font-weight:700; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; gap:8px;">
                        <span>📷</span> Choose Photo
                    </button>
                </div>

                <p style="text-align:center; color:#94a3b8; font-size:0.8rem;">You can skip this and add one later from your profile</p>
            </div>

            <!-- SLIDE 19: INVITE YOUR FRIENDS -->
            <div class="wizard-slide" id="slide-19" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🤝</div>
                <h3 style="text-align:center; margin-bottom:10px;">Invite Your Friends</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Everything's better with friends! You BOTH get <strong style="color:var(--primary);">1 week double XP</strong></p>

                <!-- Referral Code Display -->
                <div style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:20px; border-radius:16px; border:1px solid #bbf7d0; text-align:center; margin-bottom:15px;">
                    <p style="margin:0 0 8px; font-size:0.85rem; color:#166534; font-weight:600;">Your Referral Code</p>
                    <div id="wizard-referral-code" style="font-size:1.8rem; font-weight:800; letter-spacing:4px; color:#1a4d2e; font-family:monospace; padding:8px; background:white; border-radius:10px; border:2px dashed #48864B;">
                        Loading...
                    </div>
                </div>

                <!-- Share Buttons -->
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button type="button" onclick="wizardShareWhatsApp()" style="flex:1; padding:12px; border-radius:12px; border:none; background:#25D366; color:white; font-weight:700; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                        <span>WhatsApp</span>
                    </button>
                    <button type="button" onclick="wizardShareSMS()" style="flex:1; padding:12px; border-radius:12px; border:none; background:#3b82f6; color:white; font-weight:700; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                        <span>SMS</span>
                    </button>
                    <button type="button" onclick="wizardCopyLink()" style="flex:1; padding:12px; border-radius:12px; border:none; background:#64748b; color:white; font-weight:700; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                        <span>Copy Link</span>
                    </button>
                </div>

                <p style="text-align:center; color:#64748b; font-size:0.8rem;">You can always share your code later from the Friends tab</p>
            </div>

            <!-- SLIDE 20: BUILT BY SHANNON -->
            <div class="wizard-slide" id="slide-20" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">💚</div>
                <h3 style="text-align:center; margin-bottom:10px;">Built by Shannon</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">This app was designed and built by your coach, Shannon. If you have any suggestions, feedback, or ideas to make it even better — I'd love to hear from you!</p>

                <div style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:20px; border-radius:16px; border:1px solid #bbf7d0; margin-bottom:20px;">
                    <p style="margin:0 0 12px; font-weight:700; color:#166534; font-size:1rem;">How to message your coach:</p>
                    <div style="display:flex; align-items:flex-start; gap:12px; margin-bottom:12px;">
                        <div style="width:28px; height:28px; min-width:28px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:0.85rem;">1</div>
                        <p style="margin:0; color:#334155; font-size:0.9rem; line-height:1.5;">Tap the <strong>Friends</strong> tab at the bottom of your screen</p>
                    </div>
                    <div style="display:flex; align-items:flex-start; gap:12px; margin-bottom:12px;">
                        <div style="width:28px; height:28px; min-width:28px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:0.85rem;">2</div>
                        <p style="margin:0; color:#334155; font-size:0.9rem; line-height:1.5;">Tap <strong>Coach Shannon</strong> at the top of your friends list</p>
                    </div>
                    <div style="display:flex; align-items:flex-start; gap:12px;">
                        <div style="width:28px; height:28px; min-width:28px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:0.85rem;">3</div>
                        <p style="margin:0; color:#334155; font-size:0.9rem; line-height:1.5;">Send me a message — I'll get back to you with guidance!</p>
                    </div>
                </div>

                <p style="text-align:center; color:#64748b; font-size:0.85rem;">Your feedback helps make this app better for everyone. Don't be shy!</p>
            </div>

            <!-- SLIDE 21: YOU'RE ALL SET! -->
            <div class="wizard-slide" id="slide-21" style="display:none; text-align:center;">
                <div style="font-size:4rem; margin-bottom:20px;">🚀</div>
                <h3 style="margin-bottom:10px;">You're All Set!</h3>
                <p style="color:#64748b; margin-bottom:20px;">Your personalized plan is ready.</p>

                <div id="wizard-hormone-goal" style="background:var(--secondary); color:white; padding:15px; border-radius:12px; display:inline-block; font-weight:600; margin-bottom:20px;">
                    Goal: Get Stronger & Level Up Your FitGotchi 💪
                </div>

                <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-top:10px;">
                    <p style="margin:0; font-size:0.9rem; color:#334155;">
                        <strong>What's next?</strong><br>
                        <span style="font-size:0.85rem; color:#64748b;">Start your first workout, snap a meal photo, and watch your FitGotchi grow!</span>
                    </p>
                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <div class="wizard-footer" style="padding: 25px; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; flex-shrink: 0;">
            <button class="wizard-btn secondary" id="wizard-back" onclick="wizardPrev()" style="background:transparent; border:none; color:#64748b; font-weight:600; cursor:pointer; visibility:hidden;">Back</button>
            <button class="wizard-btn primary" id="wizard-next" onclick="wizardNext()" style="background:var(--primary); color:white; border:none; padding:12px 30px; border-radius:25px; font-weight:700; cursor:pointer; box-shadow:0 4px 10px rgba(4,106,56,0.2);">Next &rarr;</button>
        </div>
    </div>
</div>

<style>
.wizard-progress .dot { width: 8px; height: 8px; background: #e2e8f0; border-radius: 50%; transition: all 0.3s; }
.wizard-progress .dot.active { background: var(--primary); width: 20px; border-radius: 10px; }
.wizard-slide {
    display: none;
    opacity: 0;
    transform: translateX(12px);
    transition: opacity 0.25s ease, transform 0.25s ease;
}
.wizard-slide.slide-active {
    display: block;
    opacity: 1;
    transform: translateX(0);
}
.wizard-slide.slide-exit {
    opacity: 0;
    transform: translateX(-12px);
}

/* Gender selection button styles */
.gender-select-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.gender-select-btn:active {
    transform: translateY(0);
}


/* DBZ Theme Decorations */
#dbz-decorations {
    display: none;
    pointer-events: none;
    z-index: 1;
}

.dbz-character-corner {
    position: fixed;
    bottom: 70px;
    right: 5px;
    width: 120px;
    height: auto;
    max-height: 200px;
    object-fit: contain;
    opacity: 0.95;
    z-index: 100;
    animation: dbzFloat 3s ease-in-out infinite;
    filter: drop-shadow(0 4px 15px rgba(0, 0, 0, 0.5));
    border-radius: 8px;
}

.dbz-lightning-left {
    position: fixed;
    top: 120px;
    left: 10px;
    width: 35px;
    height: 60px;
    opacity: 0.7;
    z-index: 100;
    animation: dbzLightning 2s ease-in-out infinite;
}

.dbz-lightning-right {
    position: fixed;
    top: 200px;
    right: 15px;
    width: 30px;
    height: 50px;
    opacity: 0.6;
    z-index: 100;
    animation: dbzLightning 2.5s ease-in-out infinite 0.5s;
}

@keyframes dbzFloat {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-10px) scale(1.05); }
}

@keyframes dbzLightning {
    0%, 100% { opacity: 0.4; transform: scaleY(1); }
    50% { opacity: 0.9; transform: scaleY(1.1); }
}

/* Flower Garden Decorations (Female users only) */
#flower-decorations {
    display: none;
    pointer-events: none;
    z-index: 1;
}

.flower-corner {
    position: fixed;
    width: 60px;
    height: 60px;
    object-fit: contain;
    opacity: 0.4;
    z-index: 100;
    filter: drop-shadow(0 2px 8px rgba(217, 139, 156, 0.3));
    animation: flowerFloat 4s ease-in-out infinite;
}

.flower-top-right {
    top: 80px;
    right: 15px;
    animation-delay: 0s;
}

.flower-bottom-left {
    bottom: 80px;
    left: 15px;
    transform: rotate(180deg);
    animation-delay: 1s;
}

.flower-top-left {
    top: 180px;
    left: 20px;
    animation-delay: 2s;
    width: 55px;
    height: 55px;
}

.flower-bottom-right {
    bottom: 180px;
    right: 20px;
    transform: rotate(-15deg);
    animation-delay: 3s;
    width: 50px;
    height: 50px;
}

@keyframes flowerFloat {
    0%, 100% {
        transform: translateY(0) rotate(0deg) scale(1);
    }
    25% {
        transform: translateY(-8px) rotate(5deg) scale(1.05);
    }
    50% {
        transform: translateY(-12px) rotate(-3deg) scale(1.08);
    }
    75% {
        transform: translateY(-6px) rotate(3deg) scale(1.03);
    }
}

/* Additional rotations for specific corners */
.flower-bottom-left {
    animation-name: flowerFloatRotated;
}

@keyframes flowerFloatRotated {
    0%, 100% {
        transform: translateY(0) rotate(180deg) scale(1);
    }
    25% {
        transform: translateY(-8px) rotate(185deg) scale(1.05);
    }
    50% {
        transform: translateY(-12px) rotate(177deg) scale(1.08);
    }
    75% {
        transform: translateY(-6px) rotate(183deg) scale(1.03);
    }
}

/* Flower Garden Theme - Falling Flower Animation */
@keyframes flowerFall {
    0% {
        transform: translateY(-100px) translateX(0) rotate(0deg);
        opacity: 0;
    }
    10% {
        opacity: 1;
    }
    25% {
        transform: translateY(25vh) translateX(20px) rotate(90deg);
    }
    50% {
        transform: translateY(50vh) translateX(-15px) rotate(180deg);
    }
    75% {
        transform: translateY(75vh) translateX(10px) rotate(270deg);
        opacity: 0.8;
    }
    90% {
        opacity: 0.5;
    }
    100% {
        transform: translateY(100vh) translateX(0) rotate(360deg);
        opacity: 0;
    }
}

.falling-flower {
    position: fixed;
    width: 40px;
    height: 40px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    pointer-events: none;
    z-index: 9999;
    will-change: transform, opacity;
}

/* Sailor Moon Character Decorations (Female users only) */
#sailor-decorations {
    display: none;
    pointer-events: none;
    z-index: 1;
}

.sailor-character-corner {
    position: fixed;
    bottom: 70px;
    right: 5px;
    width: 100px;
    height: auto;
    max-height: 180px;
    object-fit: contain;
    opacity: 0.95;
    z-index: 100;
    animation: sailorFloat 3.5s ease-in-out infinite;
    filter: drop-shadow(0 4px 15px rgba(255, 105, 180, 0.4));
    border-radius: 8px;
}

.sailor-star-left {
    position: fixed;
    top: 100px;
    left: 10px;
    width: 40px;
    height: 40px;
    opacity: 0.6;
    z-index: 100;
    animation: sailorSparkle 2s ease-in-out infinite;
}

.sailor-star-right {
    position: fixed;
    top: 180px;
    right: 15px;
    width: 35px;
    height: 35px;
    opacity: 0.5;
    z-index: 100;
    animation: sailorSparkle 2.5s ease-in-out infinite 0.5s;
}

.sailor-heart-float {
    position: fixed;
    top: 250px;
    left: 50%;
    transform: translateX(-50%);
    width: 30px;
    height: 30px;
    opacity: 0.4;
    z-index: 100;
    animation: sailorHeartFloat 3s ease-in-out infinite 1s;
}

@keyframes sailorFloat {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-12px) scale(1.05); }
}

@keyframes sailorSparkle {
    0%, 100% { opacity: 0.3; transform: scale(1) rotate(0deg); }
    50% { opacity: 0.9; transform: scale(1.2) rotate(15deg); }
}

@keyframes sailorHeartFloat {
    0%, 100% { opacity: 0.3; transform: translateX(-50%) translateY(0) scale(1); }
    50% { opacity: 0.7; transform: translateX(-50%) translateY(-15px) scale(1.15); }
}

/* Sailor Moon theme specific gradient for welcome section */
body.sailor-theme-active .dashboard-welcome {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--primary-light) 100%) !important;
    position: relative;
    overflow: hidden;
}

/* Sailor Moon theme - pink/gold gradient with character in welcome */
body.sailor-moon-theme .dashboard-welcome::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('assets/sailor-moon-character.svg');
    background-size: auto 90px;
    background-repeat: no-repeat;
    background-position: right -15px bottom -15px;
    opacity: 0.25;
    pointer-events: none;
    z-index: 0;
}

/* Sailor Venus theme - orange/gold gradient with character in welcome */
body.sailor-venus-theme .dashboard-welcome::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('assets/sailor-venus-character.svg');
    background-size: auto 85px;
    background-repeat: no-repeat;
    background-position: right -20px bottom -10px;
    opacity: 0.25;
    pointer-events: none;
    z-index: 0;
}

/* DBZ theme specific gradient for welcome section */
body.dbz-theme-active .dashboard-welcome {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--primary-light) 100%) !important;
    position: relative;
    overflow: hidden;
}

/* Goku theme (Super Saiyan) - orange/gold gradient with Goku in welcome */
body.dbz-goku-theme .dashboard-welcome::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('assets/goku-ssj.webp') no-repeat right -10px bottom -20px;
    background-size: 100px auto;
    opacity: 0.3;
    pointer-events: none;
}

/* Vegeta theme (Saiyan Prince) - blue/gold gradient with Vegeta in welcome */
body.dbz-vegeta-theme .dashboard-welcome::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('assets/vegeta-ssj.webp') no-repeat right -20px bottom -10px;
    background-size: auto 90px;
    opacity: 0.3;
    pointer-events: none;
}

/* Mobile responsive adjustments */
@media (max-width: 480px) {
    .dbz-character-corner {
        width: 90px;
        max-height: 150px;
        bottom: 65px;
        right: 3px;
    }
    .dbz-lightning-left,
    .dbz-lightning-right {
        display: none;
    }
}

/* Settings icon toggle for DBZ themes */
.settings-icon-dragonball {
    display: none !important;
}

body.dbz-theme-active .settings-icon-gear {
    display: none !important;
}

body.dbz-theme-active .settings-icon-dragonball {
    display: inline-block !important;
}

/* Settings icon toggle for Sailor Moon themes */
.settings-icon-sailormoon {
    display: none !important;
}

body.sailor-theme-active .settings-icon-gear {
    display: none !important;
}

body.sailor-theme-active .settings-icon-sailormoon {
    display: inline-block !important;
}

/* Profile icon Sailor Moon for Sailor Moon themes */
body.sailor-theme-active .profile-icon {
    background-image: url('assets/sailor-moon.svg');
    background-size: cover;
    background-position: center;
    color: transparent !important; /* Hide the "S" text */
}

/* Profile icon Dragon Ball for DBZ themes */
body.dbz-theme-active .profile-icon {
    background-image: url('assets/dragon-ball.svg');
    background-size: cover;
    background-position: center;
    color: transparent !important; /* Hide the "S" text */
    font-size: 0; /* Extra measure to hide text */
}
</style>

<script>
// --- COACH CHAT - DIRECT MESSAGING ---
const COACH_EMAILS = ['shannon@plantbased-balance.org', 'shannonbirch@cocospersonaltraining.com'];
window._coachUserId = null;

// Look up coach user ID by email
async function getCoachUserId() {
    if (window._coachUserId) return window._coachUserId;

    for (const email of COACH_EMAILS) {
        try {
            const { data } = await window.supabaseClient
                .from('users')
                .select('id')
                .eq('email', email)
                .maybeSingle();

            if (data && data.id) {
                window._coachUserId = data.id;
                return window._coachUserId;
            }
        } catch (e) {
            console.warn('Could not look up coach by email:', email, e);
        }
    }

    // Fallback: get first admin user
    try {
        const { data } = await window.supabaseClient
            .from('admin_users')
            .select('user_id')
            .limit(1)
            .maybeSingle();

        if (data && data.user_id) {
            window._coachUserId = data.user_id;
            return window._coachUserId;
        }
    } catch (e) {
        console.warn('Could not look up admin user:', e);
    }

    return null;
}

// Send a push notification to a user when they receive a DM
async function sendDMNotification(recipientId, messageText) {
    try {
        const profile = await window.getUserProfile();
        const senderName = profile?.name || 'Someone';

        await fetch('/.netlify/functions/send-dm-notification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                recipientId: recipientId,
                senderName: senderName,
                messageText: messageText
            })
        });
    } catch (error) {
        console.error('Error sending DM notification:', error);
    }
}

window.submitCoachMessage = async function() {
    const input = document.getElementById('coach-chat-input');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;

    input.value = '';

    // Render user message immediately
    const container = document.getElementById('chat-messages-container');
    if (container) {
        const rowDiv = document.createElement('div');
        rowDiv.style.cssText = "display: flex; justify-content: flex-end; align-items: flex-end; margin-bottom: 20px; animation: fadeIn 0.3s ease;";
        rowDiv.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: flex-end; max-width: 80%;">
                <div style="background: var(--chat-bg-user); color: var(--chat-text-user); padding: 12px 18px; border-radius: 18px 18px 0 18px; font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">${text}</div>
                <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-right: 5px;">You  Just now</span>
            </div>
            <img src="https://ui-avatars.com/api/?name=You&background=cbd5e1&color=fff" style="width: 36px; height: 36px; border-radius: 50%; margin-left: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        `;
        container.appendChild(rowDiv);
        scrollToBottomOfChat();
    }

    // Send as a direct message (nudge) to the coach
    const coachId = await getCoachUserId();
    if (!coachId) {
        console.error('Could not find coach user ID');
        return;
    }

    try {
        const { error } = await window.supabaseClient
            .from('nudges')
            .insert({
                sender_id: window.currentUser.id,
                receiver_id: coachId,
                message: text
            });

        if (error) throw error;

        // Send push notification to the coach
        sendDMNotification(coachId, text);
    } catch (error) {
        console.error('Error sending message to coach:', error);
    }
};
</script>


<script>
    // Onboarding is now fully handled by checkAndTriggerOnboarding() -> initOnboardingWizard()
    // which runs during the auth callback. No separate page-load trigger needed.

    // Run community feed initialization
    if(document.readyState === 'complete') {
        loadCommunityFeed();
    } else {
        window.addEventListener('load', () => {
            loadCommunityFeed();
        });
    }
</script>

<script>
// --- PWA INSTALL BANNER LOGIC ---
let deferredPrompt;
let installBannerDismissed = localStorage.getItem('pwa_banner_dismissed_v2') === 'true';

// Detect if running as installed PWA
const isInstalledPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    console.log("Install Prompt Captured");
    // Update any buttons that were showing "waiting" state
    document.querySelectorAll('.pwa-install-btn').forEach(btn => {
        btn.disabled = false;
        if (btn.dataset.originalText) {
            btn.innerHTML = btn.dataset.originalText;
        }
    });
});

window.addEventListener('load', () => {
    if (isInstalledPWA) {
        // App is already installed — show "already installed" state everywhere
        const banner = document.getElementById('pwa-install-banner');
        if (banner) banner.style.display = 'none';

        const settingsDownload = document.getElementById('settings-download-app');
        if (settingsDownload) {
            const btn = settingsDownload.querySelector('button');
            if (btn) {
                btn.onclick = null;
                btn.style.background = '#6b7280';
                btn.style.cursor = 'default';
                btn.innerHTML = '&#10003; Installed';
            }
            const subtitle = settingsDownload.querySelector('div > div:last-child');
            if (subtitle) subtitle.textContent = 'Already installed on your phone';
        }

        const profileDownload = document.getElementById('profile-download-app-btn');
        if (profileDownload) {
            const btn = profileDownload.querySelector('button');
            if (btn) {
                btn.onclick = null;
                btn.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
                btn.style.cursor = 'default';
                btn.style.boxShadow = 'none';
                btn.onmouseover = null;
                btn.onmouseout = null;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> ALREADY INSTALLED';
            }
        }
    } else if (!installBannerDismissed) {
        showPwaBanner();
    }

    // Make Coach Bubble Draggable
    initDraggableBubble();
});

function showPwaBanner() {
    const banner = document.getElementById('pwa-install-banner');
    if(banner) {
        banner.style.display = 'flex';
        document.body.style.transition = 'padding-top 0.3s ease';
        document.body.style.paddingTop = banner.offsetHeight + 'px';
    }
}

window.installPWA = async function(clickedBtn) {
    // If already installed, just show the message
    if (isInstalledPWA) {
        if (clickedBtn) {
            clickedBtn.innerHTML = '&#10003; Already Installed';
            clickedBtn.disabled = true;
        }
        return;
    }

    if (deferredPrompt) {
        // Show installing feedback immediately
        if (clickedBtn) {
            clickedBtn.dataset.originalText = clickedBtn.innerHTML;
            clickedBtn.innerHTML = 'Installing...';
            clickedBtn.disabled = true;
        }

        try {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                // Successfully accepted install
                if (clickedBtn) {
                    clickedBtn.innerHTML = '&#10003; Installed!';
                }
                dismissInstall();
                // Update all other install buttons
                document.querySelectorAll('.pwa-install-btn').forEach(btn => {
                    btn.innerHTML = '&#10003; Installed!';
                    btn.disabled = true;
                });
            } else {
                // User dismissed — restore button
                if (clickedBtn) {
                    clickedBtn.innerHTML = clickedBtn.dataset.originalText || 'Install';
                    clickedBtn.disabled = false;
                }
            }
        } catch(err) {
            console.error('Install error:', err);
            if (clickedBtn) {
                clickedBtn.innerHTML = clickedBtn.dataset.originalText || 'Install';
                clickedBtn.disabled = false;
            }
        }
        deferredPrompt = null;
    } else {
        // No deferred prompt available
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
            // Show iOS-specific instructions
            if (clickedBtn) {
                clickedBtn.innerHTML = 'Use Share → Add to Home Screen';
                clickedBtn.style.fontSize = '0.7rem';
                setTimeout(() => {
                    clickedBtn.innerHTML = clickedBtn.dataset.originalText || 'Install';
                    clickedBtn.style.fontSize = '';
                }, 4000);
            }
        } else {
            // Android/Desktop — prompt may not have fired yet, or browser doesn't support it
            if (clickedBtn) {
                clickedBtn.dataset.originalText = clickedBtn.dataset.originalText || clickedBtn.innerHTML;
                clickedBtn.innerHTML = 'Installing...';
                clickedBtn.disabled = true;
                // Wait a moment for the prompt to potentially arrive
                setTimeout(() => {
                    if (deferredPrompt) {
                        // Prompt arrived, retry
                        window.installPWA(clickedBtn);
                    } else {
                        clickedBtn.innerHTML = 'Use browser menu → Install';
                        clickedBtn.style.fontSize = '0.7rem';
                        setTimeout(() => {
                            clickedBtn.innerHTML = clickedBtn.dataset.originalText || 'Install';
                            clickedBtn.style.fontSize = '';
                            clickedBtn.disabled = false;
                        }, 4000);
                    }
                }, 1500);
            }
        }
    }
};

window.dismissInstall = function() {
    const banner = document.getElementById('pwa-install-banner');
    if(banner) {
        banner.style.display = 'none';
        document.body.style.paddingTop = '0';
    }
    localStorage.setItem('pwa_banner_dismissed_v2', 'true');
};

function initDraggableBubble() {
    const bubble = document.getElementById('coach-floating-btn');
    if(!bubble) return;
    
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;
    const moveThreshold = 5; // Pixels to satisfy 'drag'

    const handleStart = (e) => {
        if(e.target.closest('.notification-badge')) return; // Don't drag if clicking badge
        isDragging = false; // Assume click first
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        startX = clientX;
        startY = clientY;
        
        const rect = bubble.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;

        // Remove transition during drag
        bubble.style.transition = 'none';
    };

    const handleMove = (e) => {
        e.preventDefault(); // Prevent scrolling
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        const dx = clientX - startX;
        const dy = clientY - startY;

        if (Math.abs(dx) > moveThreshold || Math.abs(dy) > moveThreshold) {
            isDragging = true;
        }

        if (isDragging) {
             bubble.style.right = 'auto';
             bubble.style.bottom = 'auto';
             bubble.style.left = (initialLeft + dx) + 'px';
             bubble.style.top = (initialTop + dy) + 'px';
        }
    };

    const handleEnd = (e) => {
        bubble.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        // Snap to nearest edge logic could go here, but free floating is fine for now
    };

    bubble.addEventListener('mousedown', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', handleEnd);
    
    bubble.addEventListener('touchstart', handleStart, {passive: false});
    window.addEventListener('touchmove', handleMove, {passive: false});
    window.addEventListener('touchend', handleEnd);
}


window.installPWA = async function() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            dismissInstall();
        }
        deferredPrompt = null;
    } else {
        // User requested "No instructions, just download".
        // If we are here, the browser hasn't fired the event yet or doesn't support it (iOS).
        // specific check for iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
             alert("On iOS, please tap 'Share' then 'Add to Home Screen' manually."); 
        } else {
             console.log("Install prompt not ready yet.");
             // Try to force it? No API for that.
             alert("App installation is getting ready. Please try again in a moment.");
        }
    }
};

window.dismissInstall = function() {
    const banner = document.getElementById('pwa-install-banner');
    if(banner) {
        banner.style.display = 'none';
        document.body.style.paddingTop = '0';
    }
    localStorage.setItem('pwa_banner_dismissed_v2', 'true');
};
</script>

<script>
// --- AI COACH DRAFT MODE LOGIC & AUTHENTICATION ---
// Overrides and Extensions for the Coach Command Center

let isCoachMode = false;


function checkUserRole() {
    // DISABLED: Coach Mode is replaced by admin-dashboard.html
    // All users should see the normal dashboard.
    return;
}

window.toggleCoachMode = function(show) {
    isCoachMode = show;
    const dash = document.getElementById('view-coach-dashboard');
    if (show) {
        if(dash) dash.style.display = 'block';
        if(typeof initCoachDashboard === 'function') initCoachDashboard();
        const returnBtn = document.getElementById('return-to-coach-btn');
        if(returnBtn) returnBtn.remove();
    } else {
        if(dash) dash.style.display = 'none';
    }
};

// User fact tracking - remembers key details across sessions
// User fact tracking - remembers key details across sessions
async function getUserFacts() {
    const user = window.currentUser;
    if (!user) return {};
    
    try {
        const facts = await dbHelpers.userFacts.get(user.id);
        if (facts) return facts;
        return {
            location: '',
            struggles: [],
            preferences: [],
            health_notes: [],
            personal_details: [],
            goals: []
        };
    } catch (e) {
        console.error("Error fetching user facts", e);
        return {};
    }
}

async function saveUserFact(category, fact) {
    const user = window.currentUser;
    if (!user) return;

    try {
        const facts = await getUserFacts();
        if (category === 'location') {
            facts.location = fact;
        } else if (Array.isArray(facts[category])) {
            // Avoid duplicates
            if (!facts[category].includes(fact)) {
                facts[category].push(fact);
            }
        } else {
             // Create array if missing
             facts[category] = [fact];
        }
        await dbHelpers.userFacts.upsert(user.id, facts);
    } catch(e) {
        console.error("Error saving user fact", e);
    }
}

async function gatherContext() {
    let dayNum = 1;
    const profile = await window.getUserProfile();
    
    if(profile && profile.program_start_date) {
         const start = new Date(profile.program_start_date);
         if(!isNaN(start)) {
             const diff = new Date() - start;
             dayNum = Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
             if(dayNum < 1) dayNum = 1;
         }
    }
    
    // Get latest check-in for energy/sleep
    let energy = 'Unknown';
    let sleep = 'Unknown';
    try {
        const user = window.currentUser;
        if(user) {
            const today = new Date().toISOString().split('T')[0];
            const checkin = await dbHelpers.checkins.get(user.id, today);
            if(checkin) {
                energy = checkin.energy;
                sleep = checkin.sleep;
            }
        }
    } catch(e) {}

    const facts = await getUserFacts();

    return {
        name: profile?.name || "Friend",
        profile: (profile?.result || 'CORTISOL').toUpperCase(),
        sleep: sleep,
        energy: energy,
        challengeDay: dayNum,
        userFacts: facts
    };
}

// triggerCoachResponse removed - coach chat now uses direct messaging via nudges table

// ==========================================
// APPROVAL SYSTEM FUNCTIONS
// ==========================================

// VAPID Public Key for Web Push - Must match VAPID_PUBLIC_KEY in Netlify env vars
const VAPID_PUBLIC_KEY = 'BLYkAQao_i-6MnaGCpr3hST-GqSEjcAnA3JYOGEEOtVS8dn1LX3FkpFqAbIFNbjsafyPJRoHa6n-dRq6NvT1OBI';

/**
 * Subscribe to push notifications (for admin users)
 */
window.subscribeToAdminNotifications = async function() {
    try {
        // Check if user is admin
        const isAdmin = await db.pushSubscriptions.isAdmin();
        if (!isAdmin) {
            alert('Only admins can subscribe to approval notifications');
            return false;
        }

        // Request notification permission
        if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert('Notification permission denied. Please enable notifications in your browser settings.');
                return false;
            }
        } else {
            alert('This browser does not support notifications');
            return false;
        }

        // Get service worker registration
        const registration = await navigator.serviceWorker.ready;

        // Subscribe to push
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });

        // Convert subscription to JSON
        const subscriptionJson = subscription.toJSON();

        // Save to database
        await db.pushSubscriptions.subscribe({
            endpoint: subscriptionJson.endpoint,
            keys: {
                p256dh: subscriptionJson.keys.p256dh,
                auth: subscriptionJson.keys.auth
            }
        }, true); // isAdmin = true

        console.log('Subscribed to admin notifications!');
        alert('Push notifications enabled! You will now receive alerts on this device when messages need approval.');
        return true;

    } catch (error) {
        console.error('Failed to subscribe to notifications:', error);
        alert('Failed to enable notifications: ' + error.message);
        return false;
    }
};

/**
 * Unsubscribe from push notifications
 */
window.unsubscribeFromNotifications = async function() {
    try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();

        if (subscription) {
            await subscription.unsubscribe();
            await db.pushSubscriptions.unsubscribe(subscription.endpoint);
            alert('Notifications disabled.');
        }
    } catch (error) {
        console.error('Failed to unsubscribe:', error);
    }
};

/**
 * Check if admin is subscribed to notifications
 */
window.checkAdminNotificationStatus = async function() {
    try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        return !!subscription;
    } catch (error) {
        return false;
    }
};

/**
 * Toggle admin notifications (called from settings button)
 */
window.toggleAdminNotifications = async function() {
    const btn = document.getElementById('admin-notif-btn');
    const isSubscribed = await checkAdminNotificationStatus();

    if (isSubscribed) {
        // Unsubscribe
        await unsubscribeFromNotifications();
        btn.textContent = 'Enable';
        btn.style.background = 'var(--primary)';
    } else {
        // Subscribe
        btn.textContent = 'Enabling...';
        btn.disabled = true;
        const success = await subscribeToAdminNotifications();
        btn.disabled = false;
        if (success) {
            btn.textContent = 'Disable';
            btn.style.background = '#ef4444';
        } else {
            btn.textContent = 'Enable';
        }
    }
};

/**
 * Initialize admin settings on page load
 * Auto-subscribes admins to notifications if they have permission
 */
async function initAdminSettings() {
    try {
        const isAdmin = await db.pushSubscriptions.isAdmin();
        if (isAdmin) {
            // Show admin-only settings
            const setting = document.getElementById('admin-notifications-setting');
            if (setting) {
                setting.style.display = 'block';
            }
            const adminBoard = document.getElementById('admin-board-setting');
            if (adminBoard) {
                adminBoard.style.display = 'block';
            }

            // Check if already subscribed
            const isSubscribed = await checkAdminNotificationStatus();
            const btn = document.getElementById('admin-notif-btn');

            if (isSubscribed) {
                if (btn) {
                    btn.textContent = 'Disable';
                    btn.style.background = '#ef4444';
                }
            } else {
                // Auto-subscribe admin if notification permission is already granted
                if ('Notification' in window && Notification.permission === 'granted') {
                    console.log('Auto-subscribing admin to notifications...');
                    const success = await subscribeToAdminNotifications();
                    if (success && btn) {
                        btn.textContent = 'Disable';
                        btn.style.background = '#ef4444';
                    }
                } else if ('Notification' in window && Notification.permission === 'default') {
                    // Request permission and subscribe if granted
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        console.log('Permission granted, auto-subscribing admin...');
                        const success = await subscribeToAdminNotifications();
                        if (success && btn) {
                            btn.textContent = 'Disable';
                            btn.style.background = '#ef4444';
                        }
                    }
                }
            }
        }
    } catch (error) {
        console.log('Not admin or error checking:', error);
    }
}

// Call on page load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initAdminSettings, 1000); // Delay to ensure auth is ready
});

/**
 * Helper: Convert VAPID key to Uint8Array
 */
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

/**
 * Notify admin about pending coach response via server-side push
 */
async function notifyAdminOfPendingResponse(userId, responseText) {
    // Get user name for the notification
    const profile = await window.getUserProfile();
    const userName = profile?.name || 'A user';

    const notificationTitle = 'Coach Response Pending Approval';
    const notificationBody = `${userName}: ${responseText.substring(0, 100)}${responseText.length > 100 ? '...' : ''}`;

    // Send push notification via server (reaches admin even when not on site)
    try {
        const response = await fetch('/.netlify/functions/send-push-notification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: notificationTitle,
                body: notificationBody,
                data: {
                    type: 'pending_approval',
                    userId: userId,
                    url: '/dashboard.html'
                }
            })
        });

        const result = await response.json();
        console.log('Push notification result:', result);
    } catch (error) {
        console.error('Error sending push notification:', error);
    }

    // Also set app badge locally if we're on the app
    if ('setAppBadge' in navigator) {
        const pendingCount = await db.pendingResponses.getPendingCount();
        navigator.setAppBadge(pendingCount).catch(e => console.error(e));
    }
}

/**
 * Open approval modal for a pending response
 */
window.openApprovalModal = async function(pendingId = null) {
    let pendingResponse;

    if (pendingId) {
        // Load specific pending response
        pendingResponse = await db.pendingResponses.getById(pendingId);
    } else {
        // Load the most recent pending response
        const pending = await db.pendingResponses.getPending(1);
        if (pending && pending.length > 0) {
            pendingResponse = pending[0];
        }
    }

    if (!pendingResponse) {
        alert('No pending responses found.');
        return;
    }

    // Store current pending response ID
    window.currentPendingResponseId = pendingResponse.id;

    // Open the approval modal
    const modal = document.getElementById('approval-modal');
    if (modal) {
        // Populate modal with response data
        const userName = pendingResponse.users?.name || 'User';
        const userMessage = pendingResponse.user_message_text || '';
        const responseText = pendingResponse.message_text || '';

        document.getElementById('approval-user-name').textContent = userName;
        document.getElementById('approval-user-message').textContent = userMessage;
        document.getElementById('approval-response-text').value = responseText;

        modal.style.display = 'flex';
    }
};

/**
 * Close approval modal
 */
window.closeApprovalModal = function() {
    const modal = document.getElementById('approval-modal');
    if (modal) {
        modal.style.display = 'none';
    }
};

/**
 * Approve and send the response
 */
window.approveResponse = async function() {
    const responseId = window.currentPendingResponseId;
    if (!responseId) return;

    try {
        // Get the (possibly edited) response text
        const editedText = document.getElementById('approval-response-text').value;

        // Get current user (admin)
        const user = await window.supabaseClient.auth.getUser();
        const adminId = user?.data?.user?.id;

        // Get the pending response to find the original user_id
        const pendingResponse = await db.pendingResponses.getById(responseId);
        const originalUserId = pendingResponse.user_id;

        // Approve the response in pending_coach_responses table
        await db.pendingResponses.approve(responseId, adminId, editedText);

        // Save the approved message to the conversations table for the ORIGINAL USER
        // Split by ||| for multi-part messages
        const parts = editedText.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());

        for (const part of parts) {
            await db.conversations.create(
                originalUserId,  // The user who asked the question
                'coach',         // chat_type - must match what getChatHistory queries for
                'assistant',     // role
                part,           // message text
                'Coach Shannon'  // author name
            );
        }

        // Close the modal
        closeApprovalModal();

        // Clear app badge if no more pending
        const pendingCount = await db.pendingResponses.getPendingCount();
        if ('setAppBadge' in navigator) {
            if (pendingCount === 0) {
                navigator.clearAppBadge().catch(e => console.error(e));
            } else {
                navigator.setAppBadge(pendingCount).catch(e => console.error(e));
            }
        }

        // Show success message
        alert('Response approved and sent to user!');
    } catch (error) {
        console.error('Error approving response:', error);
        alert('Error approving response: ' + error.message);
    }
};

/**
 * Reject the response
 */
window.rejectResponse = async function() {
    const responseId = window.currentPendingResponseId;
    if (!responseId) return;

    const reason = prompt('Why are you rejecting this response? (optional)');

    try {
        await db.pendingResponses.reject(responseId, reason || 'No reason provided');

        // Close the modal
        closeApprovalModal();

        // Clear app badge if no more pending
        const pendingCount = await db.pendingResponses.getPendingCount();
        if ('setAppBadge' in navigator) {
            if (pendingCount === 0) {
                navigator.clearAppBadge().catch(e => console.error(e));
            } else {
                navigator.setAppBadge(pendingCount).catch(e => console.error(e));
            }
        }

        alert('Response rejected.');
    } catch (error) {
        console.error('Error rejecting response:', error);
        alert('Error rejecting response. Please try again.');
    }
};

// ==========================================
// COMMUNITY CHAT HELPER FUNCTIONS
// ==========================================

// Helper: Add typing indicator for community member
function addCommunityTypingIndicator(personaName) {
    const container = document.getElementById('community-messages-container');
    if (!container) return;

    const typingDiv = document.createElement('div');
    typingDiv.className = 'community-typing-indicator';
    typingDiv.dataset.persona = personaName;
    typingDiv.style.cssText = "display: flex; align-items: center; margin-bottom: 12px; margin-left:10px;";
    typingDiv.innerHTML = `
        <div style="font-size: 0.75rem; color: #94a3b8; margin-right: 8px;">${personaName} is typing</div>
        <div style="width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both;"></div>
        <div style="width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; margin: 0 3px; animation: bounce 1.4s infinite ease-in-out both 0.16s;"></div>
        <div style="width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both 0.32s;"></div>
    `;
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
}

// Helper: Remove all typing indicators (or specific one)
function removeCommunityTypingIndicators(personaName = null) {
    if (personaName) {
        const indicators = document.querySelectorAll(`.community-typing-indicator[data-persona="${personaName}"]`);
        indicators.forEach(ind => ind.remove());
    } else {
        const indicators = document.querySelectorAll('.community-typing-indicator');
        indicators.forEach(ind => ind.remove());
    }
}

// Helper: Add emoji reaction to a message
function addEmojiReaction(messageIndex, emoji, reactorId) {
    let messages = [];
    try { messages = JSON.parse(localStorage.getItem('community_chat_history') || '[]'); } catch(e) {}
    if (messageIndex >= 0 && messageIndex < messages.length) {
        if (!messages[messageIndex].reactions) {
            messages[messageIndex].reactions = [];
        }
        messages[messageIndex].reactions.push({ emoji, reactorId });
        localStorage.setItem('community_chat_history', JSON.stringify(messages));
        renderChat(messages);
    }
}

// Helper: Mark message as read by member
function markMessageAsRead(messageIndex, memberId) {
    let messages = [];
    try { messages = JSON.parse(localStorage.getItem('community_chat_history') || '[]'); } catch(e) {}
    if (messageIndex >= 0 && messageIndex < messages.length) {
        if (!messages[messageIndex].readBy) {
            messages[messageIndex].readBy = [];
        }
        if (!messages[messageIndex].readBy.includes(memberId)) {
            messages[messageIndex].readBy.push(memberId);
        }
        localStorage.setItem('community_chat_history', JSON.stringify(messages));
    }
}

// Helper: Get member online status based on time of day (Brisbane time)
function getMemberOnlineStatus() {
    const now = new Date();
    const bneTime = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Brisbane"}));
    const hour = bneTime.getHours();

    // Online status based on time of day
    // Peak activity: 7am-10am, 12pm-2pm, 2pm-6pm, 6pm-10pm
    // Low activity: 10pm-7am
    const onlineMembers = [];

    AI_MEMBERS.forEach(member => {
        let onlineChance = 0.3; // Base 30% chance

        if (hour >= 7 && hour < 10) onlineChance = 0.7; // Morning peak
        else if (hour >= 12 && hour < 14) onlineChance = 0.6; // Lunch peak
        else if (hour >= 14 && hour < 18) onlineChance = 0.5; // Afternoon moderate
        else if (hour >= 18 && hour < 22) onlineChance = 0.8; // Evening peak (highest)
        else if (hour >= 22 || hour < 7) onlineChance = 0.1; // Night/early morning

        if (Math.random() < onlineChance) {
            onlineMembers.push(member.id);
        }
    });

    return onlineMembers;
}

// Helper: Check if should respond to message and when
function shouldRespondToMessage() {
    const rand = Math.random();

    // 10% - No response (dead air)
    if (rand < 0.10) return { type: false };

    // 40% - Immediate response (2-10s)
    if (rand < 0.50) {
        const subRand = Math.random();
        if (subRand < 0.3) return { type: 'emoji', delay: 0 }; // 12% emoji immediate
        return { type: 'text', delay: 0 }; // 28% text immediate
    }

    // 25% - Quick delay (1-3 minutes)
    if (rand < 0.75) {
        const delay = 60000 + Math.random() * 120000; // 1-3 min
        return { type: 'text', delay: delay };
    }

    // 15% - Medium delay (5-15 minutes)
    if (rand < 0.90) {
        const delay = 300000 + Math.random() * 600000; // 5-15 min
        return { type: 'text', delay: delay };
    }

    // 10% - Long delay (30min-2 hours)
    const delay = 1800000 + Math.random() * 5400000; // 30min-2hrs
    return { type: 'text', delay: delay };
}

async function triggerAICommunityResponse(userMsg, chainCount = 0) {
    const lowMsg = userMsg.toLowerCase();
    let fullHistory = [];
    try { fullHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]'); } catch(e) {}

    // Check if there's been recent activity (conversation flow)
    const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
    const recentActivity = fullHistory.slice(-5).some(m =>
        m.timestamp > fiveMinutesAgo && m.authorId !== 'current-user'
    );
    const isActiveConversation = recentActivity || chainCount > 0;

    // Mark user's message as read by some members
    const lastMsgIndex = fullHistory.length - 1;
    if (lastMsgIndex >= 0 && fullHistory[lastMsgIndex].authorId === 'current-user') {
        const onlineMembers = getMemberOnlineStatus();
        const readersCount = Math.floor(Math.random() * Math.min(onlineMembers.length, 8)) + 2;
        for (let i = 0; i < readersCount; i++) {
            const randomMember = onlineMembers[Math.floor(Math.random() * onlineMembers.length)];
            markMessageAsRead(lastMsgIndex, randomMember);
        }
        renderChat(fullHistory);
    }

    // Check if should respond and when
    const response = shouldRespondToMessage();

    if (response.type === false) {
        // Dead air - no response
        return;
    }

    // Calculate total delay (base delay from shouldRespond + immediate response timing)
    const baseDelay = response.delay || 0;

    if (response.type === 'emoji') {
        // Just emoji reaction, no text
        const emojis = ['👍', '❤️', '🎉', '😂', '💪', '🙌', '✨', '🔥', '💯', '👏'];
        const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
        const onlineMembers = getMemberOnlineStatus();
        const randomReactor = AI_MEMBERS.find(m => onlineMembers.includes(m.id)) || AI_MEMBERS[0];

        // Delay before reaction - quicker than text but still realistic
        let emojiImmediateDelay;
        if (isActiveConversation) {
            emojiImmediateDelay = 5000 + Math.random() * 25000; // 5-30s during active chat
        } else {
            emojiImmediateDelay = 30000 + Math.random() * 90000; // 30s-2min cold start
        }
        const emojiDelay = baseDelay + emojiImmediateDelay;
        setTimeout(() => {
            addEmojiReaction(lastMsgIndex, randomEmoji, randomReactor.id);
        }, emojiDelay);
        return;
    }

    // TEXT RESPONSE - Full logic (can be immediate or delayed)

    // 1. Thread Persistence & Direct Address Logic
    let persona = null;
    const onlineMembers = getMemberOnlineStatus();

    // A) Check for direct address (highest priority)
    for (const m of AI_MEMBERS) {
        const firstName = m.name.split(' ')[0].toLowerCase();
        if (lowMsg.includes(firstName)) {
            persona = m;
            break;
        }
    }

    // B) Active participants tracking (like real group chats!)
    if (!persona && fullHistory.length > 0) {
        const fifteenMinsAgo = Date.now() - (15 * 60 * 1000);
        const recentMessages = fullHistory.slice(-10).filter(m => m.timestamp > fifteenMinsAgo);

        const activeParticipants = [];
        const participantCounts = {};

        recentMessages.forEach(msg => {
            if (msg.authorId && msg.authorId !== 'current-user') {
                if (!participantCounts[msg.authorId]) {
                    participantCounts[msg.authorId] = 0;
                    const member = AI_MEMBERS.find(m => m.id === msg.authorId);
                    if (member && onlineMembers.includes(member.id)) {
                        activeParticipants.push(member);
                    }
                }
                participantCounts[msg.authorId]++;
            }
        });

        if (activeParticipants.length > 0) {
            const pickFromActive = Math.random() < 0.7; // 70% chance

            if (pickFromActive) {
                const weighted = [];
                activeParticipants.forEach(p => {
                    const count = participantCounts[p.id] || 1;
                    for (let i = 0; i < count; i++) {
                        weighted.push(p);
                    }
                });
                persona = weighted[Math.floor(Math.random() * weighted.length)];
            }
        }
    }

    // C) Fallback: pick someone random who's online
    if (!persona) {
        const onlineAIMembers = AI_MEMBERS.filter(m => onlineMembers.includes(m.id));
        persona = onlineAIMembers.length > 0
            ? onlineAIMembers[Math.floor(Math.random() * onlineAIMembers.length)]
            : AI_MEMBERS[Math.floor(Math.random() * AI_MEMBERS.length)];
    }

    // Multiple people typing at once (30% chance)
    const multipleTyping = Math.random() < 0.3 && chainCount === 0;
    let secondTyper = null;
    if (multipleTyping) {
        const otherOnlineMembers = AI_MEMBERS.filter(m => onlineMembers.includes(m.id) && m.id !== persona.id);
        if (otherOnlineMembers.length > 0) {
            secondTyper = otherOnlineMembers[Math.floor(Math.random() * otherOnlineMembers.length)];
        }
    }

    // Variable response timing based on conversation flow
    // Plus any delay from shouldRespondToMessage (for delayed responses)
    let immediateDelay;
    if (isActiveConversation) {
        // Active conversation: 15 seconds to 2 minutes
        immediateDelay = 15000 + Math.random() * 105000; // 15s-2min
    } else {
        // Cold start: 2-5 minutes
        immediateDelay = 120000 + Math.random() * 180000; // 2-5min
    }
    const totalDelay = baseDelay + immediateDelay;

    setTimeout(async () => {
        // Show typing indicator(s)
        addCommunityTypingIndicator(persona.name.split(' ')[0]);
        if (secondTyper) {
            setTimeout(() => addCommunityTypingIndicator(secondTyper.name.split(' ')[0]), 500 + Math.random() * 1000);
        }

        try {
            const historyContext = fullHistory.slice(-20).map(m => ({
                role: m.authorId === 'current-user' ? 'user' : 'model',
                text: `${m.authorName || 'Member'}: ${m.text}`,
                timestamp: m.timestamp
            }));

            // Determine what to respond to (current message vs earlier message)
            let contextMessage = userMsg;
            if (fullHistory.length > 3 && Math.random() < 0.25) {
                // 25% chance to respond to an earlier message (2-4 messages back)
                const lookBack = Math.floor(Math.random() * 3) + 2;
                const earlierMsg = fullHistory[fullHistory.length - lookBack];
                if (earlierMsg) {
                    contextMessage = `(Responding to earlier: "${earlierMsg.text}") ${userMsg}`;
                }
            }

            const response = await fetch('/.netlify/functions/ai-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mode: 'community',
                    message: contextMessage,
                    memberPersona: persona,
                    chatHistory: historyContext,
                    currentDateTime: new Date().toLocaleString(),
                    allowShortAcknowledgments: true // New flag for AI
                })
            });
            const data = await response.json();

            // If second typer, remove their indicator after first person responds
            if (secondTyper) {
                setTimeout(() => removeCommunityTypingIndicators(secondTyper.name.split(' ')[0]), 1000 + Math.random() * 2000);
            }

            if (data.reply) {
                const parts = data.reply.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());
                let totalDelay = 0;

                parts.forEach((part, idx) => {
                    if (idx > 0) {
                        setTimeout(() => addCommunityTypingIndicator(persona.name.split(' ')[0]), totalDelay);
                        totalDelay += 800 + Math.random() * 400;
                    }

                    const partDelay = 1200 + (part.length * 20);
                    setTimeout(() => {
                        removeCommunityTypingIndicators(persona.name.split(' ')[0]);
                        saveCommunityMessage(persona, part);

                        // If secondTyper exists, have them respond too (cross-talk!)
                        if (idx === parts.length - 1 && secondTyper && Math.random() < 0.6) {
                            const crossTalkDelay = 1000 + Math.random() * 2000; // 1-3s
                            setTimeout(() => triggerCrossTalkResponse(userMsg, secondTyper), crossTalkDelay);
                        }

                        // If it's the last part, consider triggering a peer response or jump-in
                        if (idx === parts.length - 1 && !secondTyper) {
                            if (chainCount < 2 && Math.random() < 0.35) {
                                const availableOnline = AI_MEMBERS.filter(m => onlineMembers.includes(m.id) && m.id !== persona.id);
                                if (availableOnline.length > 0) {
                                    const peerPersona = availableOnline[Math.floor(Math.random() * availableOnline.length)];
                                    const peerDelay = Math.random() < 0.5
                                        ? 2000 + Math.random() * 2000  // Fast: 2-4s
                                        : 5000 + Math.random() * 3000; // Slower: 5-8s
                                    setTimeout(() => triggerJumpInResponse(part, peerPersona, chainCount + 1), peerDelay);
                                }
                            }
                        }
                    }, totalDelay);
                    totalDelay += partDelay;
                });
            } else {
                removeCommunityTypingIndicators();
            }
        } catch (e) {
            removeCommunityTypingIndicators();
            console.log("Comm skip", e);
        }
    }, totalDelay);
}

async function triggerJumpInResponse(prevContext, persona, chainCount) {
    try {
        // Show typing indicator first
        addCommunityTypingIndicator(persona.name.split(' ')[0]);

        const fullHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
        const historyContext = fullHistory.slice(-20).map(m => ({
            role: m.authorId === 'current-user' ? 'user' : 'model',
            text: `${m.authorName || 'Member'}: ${m.text}`,
            timestamp: m.timestamp
        }));

        const response = await fetch('/.netlify/functions/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mode: 'community',
                message: `(Respond to: "${prevContext}")`,
                memberPersona: persona,
                chatHistory: historyContext,
                currentDateTime: new Date().toLocaleString(),
                allowShortAcknowledgments: true
            })
        });
        const data = await response.json();

        if (data.reply) {
            const parts = data.reply.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());
            let totalDelay = 0;

            parts.forEach((part, idx) => {
                if (idx > 0) {
                    // Show typing indicator before subsequent messages
                    setTimeout(() => addCommunityTypingIndicator(persona.name.split(' ')[0]), totalDelay);
                    totalDelay += 800 + Math.random() * 400; // 0.8-1.2s typing indicator
                }

                const partDelay = 1200 + (part.length * 20);
                setTimeout(() => {
                    removeCommunityTypingIndicators(persona.name.split(' ')[0]);
                    saveCommunityMessage(persona, part);

                    // Chain limit check with variable timing (only for online members)
                    if (idx === parts.length - 1 && chainCount < 2 && Math.random() < 0.3) {
                        const onlineMembers = getMemberOnlineStatus();
                        const availableNext = AI_MEMBERS.filter(m => m.id !== persona.id && onlineMembers.includes(m.id));
                        if (availableNext.length > 0) {
                            const nextPersona = availableNext[Math.floor(Math.random() * availableNext.length)];
                            const nextDelay = Math.random() < 0.5
                                ? 2000 + Math.random() * 2000  // Fast: 2-4s
                                : 4000 + Math.random() * 4000; // Slower: 4-8s
                            setTimeout(() => triggerJumpInResponse(part, nextPersona, chainCount + 1), nextDelay);
                        }
                    }
                }, totalDelay);
                totalDelay += partDelay;
            });
        } else {
            removeCommunityTypingIndicators(persona.name.split(' ')[0]);
        }
    } catch (e) {
        removeCommunityTypingIndicators(persona.name.split(' ')[0]);
        console.log("JumpIn skip", e);
    }
}

// Cross-talk: Second person responds with their own take
async function triggerCrossTalkResponse(originalMsg, persona) {
    try {
        // Short delay, then show typing
        setTimeout(() => {
            addCommunityTypingIndicator(persona.name.split(' ')[0]);
        }, 200);

        const fullHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
        const historyContext = fullHistory.slice(-20).map(m => ({
            role: m.authorId === 'current-user' ? 'user' : 'model',
            text: `${m.authorName || 'Member'}: ${m.text}`,
            timestamp: m.timestamp
        }));

        // Cross-talk often responds with short acknowledgments or different perspectives
        const response = await fetch('/.netlify/functions/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mode: 'community',
                message: originalMsg,
                memberPersona: persona,
                chatHistory: historyContext,
                currentDateTime: new Date().toLocaleString(),
                allowShortAcknowledgments: true,
                crossTalk: true // Flag for potentially shorter, different-angle response
            })
        });
        const data = await response.json();

        if (data.reply) {
            const parts = data.reply.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());
            let totalDelay = 0;

            parts.forEach((part, idx) => {
                if (idx > 0) {
                    setTimeout(() => addCommunityTypingIndicator(persona.name.split(' ')[0]), totalDelay);
                    totalDelay += 800 + Math.random() * 400;
                }

                const partDelay = 1200 + (part.length * 20);
                setTimeout(() => {
                    removeCommunityTypingIndicators(persona.name.split(' ')[0]);
                    saveCommunityMessage(persona, part);
                }, totalDelay);
                totalDelay += partDelay;
            });
        } else {
            removeCommunityTypingIndicators(persona.name.split(' ')[0]);
        }
    } catch (e) {
        removeCommunityTypingIndicators(persona.name.split(' ')[0]);
        console.log("CrossTalk skip", e);
    }
}

// ========================================
// AUTONOMOUS COMMUNITY MESSAGING SYSTEM
// ========================================

// Autonomous message topics for random conversations
const AUTONOMOUS_TOPICS = [
    { type: 'workout', prompts: [
        'Just finished an amazing morning walk! The fresh air really helps clear my head. Anyone else moving today?',
        'Did a gentle yoga flow this morning and feeling so much better. How do you all prefer to move?',
        'Trying to stay consistent with strength training but some days are harder than others. Anyone else struggling with motivation this week?',
        'That new workout in the Build section was challenging! How did everyone else find it?',
        'Taking a rest day today and trying not to feel guilty about it. Self-compassion is hard sometimes!',
        'Swimming has been such a game-changer for my joint pain. What movement makes you feel best?'
    ]},
    { type: 'nutrition', prompts: [
        'Made the most delicious plant-based Buddha bowl for lunch! Feeling so nourished. What\'s everyone eating today?',
        'Anyone else notice their cravings change throughout their cycle? I\'m craving all the green things this week.',
        'Finally nailed a good protein smoothie recipe. The key is frozen banana and a pinch of cinnamon!',
        'Struggling with meal prep this week. Life got busy. Anyone have quick go-to meals?',
        'My hot flashes have been better since I cut back on spicy foods. Anyone else notice food triggers?',
        'Just meal prepped for the week and feeling so organized! How do you all stay on track?'
    ]},
    { type: 'wellness', prompts: [
        'Had the best sleep last night after doing that evening wind-down routine. Game changer!',
        'Brain fog is real today. Anyone else? How do you cope when you\'re feeling scattered?',
        'Trying to be more mindful about my stress levels. Noticed my shoulders are always tense!',
        'The guided meditation in the resources section has been so helpful. Anyone else trying meditation?',
        'Feeling really grateful for this community today. It helps knowing we\'re all in this together.',
        'Energy levels have been all over the place this week. Hormones are wild! How\'s everyone feeling?'
    ]},
    { type: 'progress', prompts: [
        'Finally feeling like my cortisol is balancing out. The changes are subtle but they\'re there!',
        'Tracking my symptoms has been so eye-opening. Highly recommend if you haven\'t started yet.',
        'Hit a milestone today - 30 days of consistent movement! Never thought I\'d get here.',
        'Some days feel like steps backward, but trying to trust the process. Anyone else feel this way?',
        'My mood has been so much more stable lately. Plant-based eating is really making a difference.',
        'Noticing improvements in my sleep quality. It\'s the small wins that keep me going!'
    ]},
    { type: 'support', prompts: [
        'Having a tough day today. Just needed to share that with people who understand.',
        'This journey isn\'t linear and that\'s okay. Being gentle with myself today.',
        'Anyone else find perimenopause harder than they expected? Some days I feel lost.',
        'The support in this group means everything. Thank you for being here.',
        'Reminder to drink water! I always forget and then wonder why I feel terrible.',
        'How is everyone\'s week going? Really curious to hear how you\'re all doing.'
    ]}
];

// Saturday morning check-in prompts (Coach Shannon initiates these)
const SATURDAY_CHECKIN_PROMPTS = [
    'Morning everyone! Check-in time. How\'d your week go? I want to hear the real stuff - wins, struggles, whatever\'s on your mind.',
    'Hey everyone, Saturday check-in. What happened this week that actually mattered to you? Big or small, I\'m curious.',
    'Happy Saturday! Let\'s take a moment to reflect. What was the most challenging thing you dealt with this week and how did you work through it?',
    'Morning! Weekly check-in time. What surprised you about yourself this week? I always find these reflections so revealing.',
    'Saturday vibes! How are you all really doing? Share what\'s going on - the good, the messy, all of it.',
    'Hey friends! Check-in time. What did you learn about your body or your patterns this week? Let\'s share.',
    'Morning everyone. What\'s one thing from this week that you\'re still thinking about? Could be a win, a struggle, or just something that stuck with you.',
    'Saturday check-in! How did you take care of yourself this week? And how did it actually feel doing it?',
    'Hey all! Time for our weekly reflection. What was different about this week compared to last? Even small shifts count.',
    'Morning! Let\'s hear your stories. What moment this week made you feel most like yourself?'
];

// Get a random item from array
function getRandomItem(array) {
    return array[Math.floor(Math.random() * array.length)];
}

// Get random autonomous message prompt
function getRandomAutonomousPrompt() {
    const topic = getRandomItem(AUTONOMOUS_TOPICS);
    return getRandomItem(topic.prompts);
}

// Determine number of responses based on probability
function getResponseCount() {
    const rand = Math.random() * 100;
    if (rand < 10) return 0;      // 10% - no replies
    if (rand < 40) return 1;      // 30% - one reply
    if (rand < 75) return 2;      // 35% - two replies
    if (rand < 90) return 3;      // 15% - three replies
    return 4;                     // 10% - four replies
}

// Initiate autonomous community conversation
async function initiateAutonomousConversation(isCheckIn = false) {
    try {
        const fullHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');

        // Select initiating member
        let initiator;
        if (isCheckIn) {
            // Coach Shannon always leads Saturday check-ins
            initiator = AI_MEMBERS.find(m => m.id === 'm0');
        } else {
            // For random messages, exclude Coach Shannon for more natural peer feel
            const nonCoachMembers = AI_MEMBERS.filter(m => m.id !== 'm0');
            initiator = getRandomItem(nonCoachMembers);
        }

        // Get message content
        const messageText = isCheckIn ? getRandomItem(SATURDAY_CHECKIN_PROMPTS) : getRandomAutonomousPrompt();

        // Add initiator message to chat
        saveCommunityMessage(initiator, messageText);

        // Determine number of responses
        const responseCount = isCheckIn ? Math.floor(Math.random() * 3) + 18 : getResponseCount(); // Check-ins get 18-20 responses

        if (responseCount === 0) {
            console.log('Autonomous message sent with no replies');
            return;
        }

        // Generate responses with varying delays
        const availableResponders = AI_MEMBERS.filter(m => m.id !== initiator.id);
        const responders = [];

        // Select unique responders
        for (let i = 0; i < responseCount && responders.length < availableResponders.length; i++) {
            let responder;
            do {
                responder = getRandomItem(availableResponders);
            } while (responders.find(r => r.id === responder.id));
            responders.push(responder);
        }

        // Schedule responses with realistic delays
        responders.forEach((responder, idx) => {
            let delay;
            if (isCheckIn) {
                // Spread check-ins over 3-5 hours (10,800,000 - 18,000,000 ms)
                const minDelay = 3 * 60 * 60 * 1000; // 3 hours in ms
                const maxDelay = 5 * 60 * 60 * 1000; // 5 hours in ms
                const timeRange = maxDelay - minDelay;
                // Distribute responders across the time range with some randomness
                const basePosition = (idx / responseCount) * timeRange;
                const randomJitter = (Math.random() - 0.5) * (timeRange / responseCount) * 2;
                delay = minDelay + basePosition + randomJitter;
            } else {
                // Regular messages have shorter delays
                const baseDelay = 8000;
                const randomDelay = baseDelay + (Math.random() * 15000);
                delay = (idx * 10000) + randomDelay;
            }

            setTimeout(async () => {
                try {
                    const currentHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
                    const historyContext = currentHistory.slice(-20).map(m => ({
                        role: m.authorId === 'current-user' ? 'user' : 'model',
                        text: `${m.authorName || 'Member'}: ${m.text}`,
                        timestamp: m.timestamp
                    }));

                    // Get previous check-in stories for this member to build continuity
                    let previousStories = '';
                    if (isCheckIn) {
                        const checkInHistory = JSON.parse(localStorage.getItem('saturday_checkin_stories') || '{}');
                        if (checkInHistory[responder.id] && checkInHistory[responder.id].length > 0) {
                            const recentStories = checkInHistory[responder.id].slice(-3); // Last 3 check-ins
                            previousStories = '\nYour previous check-in reflections: ' + recentStories.map(s => `"${s}"`).join(' | ');
                        }
                    }

                    // Enhanced prompt for check-ins
                    let promptMessage = messageText;
                    if (isCheckIn) {
                        promptMessage = `(This is your Saturday morning check-in. Shannon is asking the group to reflect on their week. Share an authentic, personal story from your week - something real and specific that happened to you. Talk about actual moments, feelings, struggles, or wins. Be vulnerable and detailed. Build on your journey over time.${previousStories} Respond to: "${messageText}")`;
                    }

                    // Call AI to generate response
                    const response = await fetch('/.netlify/functions/ai-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            mode: 'community',
                            message: promptMessage,
                            memberPersona: responder,
                            chatHistory: historyContext,
                            currentDateTime: new Date().toLocaleString(),
                            isAutonomous: true
                        })
                    });

                    const data = await response.json();
                    if (data.reply) {
                        const parts = data.reply.split(/\s*\|\|\|\s*/g).filter(s => s && s.trim());
                        let totalDelay = 0;

                        parts.forEach((part, partIdx) => {
                            const partDelay = 1200 + (part.length * 20);
                            setTimeout(() => {
                                const msgs = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
                                msgs.push({
                                    authorId: responder.id,
                                    authorName: responder.name,
                                    authorAvatar: responder.id.replace('m', ''),
                                    text: part,
                                    timestamp: Date.now()
                                });
                                localStorage.setItem('community_chat_history', JSON.stringify(msgs));
                                if (typeof renderChat === 'function') renderChat(msgs);

                                // Save check-in story for continuity (only on last part)
                                if (isCheckIn && partIdx === parts.length - 1) {
                                    const checkInHistory = JSON.parse(localStorage.getItem('saturday_checkin_stories') || '{}');
                                    if (!checkInHistory[responder.id]) {
                                        checkInHistory[responder.id] = [];
                                    }
                                    // Store the full response (all parts combined) for this member
                                    checkInHistory[responder.id].push(data.reply.replace(/\s*\|\|\|\s*/g, ' '));
                                    // Keep only last 5 check-ins per member
                                    if (checkInHistory[responder.id].length > 5) {
                                        checkInHistory[responder.id].shift();
                                    }
                                    localStorage.setItem('saturday_checkin_stories', JSON.stringify(checkInHistory));

                                    // 40% chance someone reacts to this check-in story
                                    if (Math.random() < 0.4) {
                                        // Pick someone who will respond or has already responded
                                        const potentialReactors = responders.filter(r => r.id !== responder.id);
                                        if (potentialReactors.length > 0) {
                                            const reactor = getRandomItem(potentialReactors);
                                            const reactionDelay = 5000 + Math.random() * 15000; // 5-20 seconds after story
                                            setTimeout(() => {
                                                triggerCheckInReaction(part, responder, reactor);
                                            }, reactionDelay);
                                        }
                                    }
                                }
                            }, totalDelay);
                            totalDelay += partDelay;
                        });
                    }
                } catch (e) {
                    console.log('Autonomous response skip', e);
                }
            }, delay);
        });

    } catch (e) {
        console.log('Autonomous conversation skip', e);
    }
}

// Trigger a reaction/comment to a check-in story
async function triggerCheckInReaction(storyText, originalAuthor, reactor) {
    try {
        const currentHistory = JSON.parse(localStorage.getItem('community_chat_history') || '[]');
        const historyContext = currentHistory.slice(-20).map(m => ({
            role: m.authorId === 'current-user' ? 'user' : 'model',
            text: `${m.authorName || 'Member'}: ${m.text}`,
            timestamp: m.timestamp
        }));

        // Generate a supportive reaction/comment
        const reactionPrompt = `(${originalAuthor.name} just shared their check-in story. React to it with a brief, supportive comment. Be empathetic, relate to their experience, offer encouragement, or share how you connect with what they said. Keep it short and genuine - 1-2 sentences max. You're commenting on: "${storyText}")`;

        const response = await fetch('/.netlify/functions/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mode: 'community',
                message: reactionPrompt,
                memberPersona: reactor,
                chatHistory: historyContext,
                currentDateTime: new Date().toLocaleString(),
                isAutonomous: true
            })
        });

        const data = await response.json();
        if (data.reply) {
            // Reactions should be quick and short, no multi-part needed
            const reactionText = data.reply.replace(/\s*\|\|\|\s*/g, ' ');
            saveCommunityMessage(reactor, reactionText);
            
            console.log(`💬 ${reactor.name} reacted to ${originalAuthor.name}'s story`);
        }
    } catch (e) {
        console.log('Check-in reaction skip', e);
    }
}

// Check if it's Saturday morning (7-9 AM Brisbane time)
function isSaturdayMorning() {
    const now = new Date();

    // Convert to Brisbane time (AEST/AEDT UTC+10/+11)
    const brisbaneTime = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Brisbane' }));
    const day = brisbaneTime.getDay();
    const hour = brisbaneTime.getHours();

    return day === 6 && hour >= 7 && hour < 9;
}

// Get last check-in date
function getLastCheckInDate() {
    const lastCheckIn = localStorage.getItem('last_saturday_checkin');
    return lastCheckIn ? new Date(lastCheckIn) : null;
}

// Check if check-in already happened this week
function checkInAlreadyDone() {
    const lastCheckIn = getLastCheckInDate();
    if (!lastCheckIn) return false;

    const now = new Date();
    const daysSinceLastCheckIn = (now - lastCheckIn) / (1000 * 60 * 60 * 24);

    // If less than 6 days since last check-in, it already happened this week
    return daysSinceLastCheckIn < 6;
}

// Trigger Saturday morning check-in
function triggerSaturdayCheckIn() {
    if (checkInAlreadyDone()) {
        console.log('Saturday check-in already done this week');
        return;
    }

    console.log('Initiating Saturday morning check-in...');
    localStorage.setItem('last_saturday_checkin', new Date().toISOString());
    initiateAutonomousConversation(true);
}

// Get last autonomous message time
function getLastAutonomousMessageTime() {
    const lastTime = localStorage.getItem('last_autonomous_message');
    return lastTime ? parseInt(lastTime) : 0;
}

// Check if it's time for autonomous message
function shouldTriggerAutonomousMessage() {
    const lastTime = getLastAutonomousMessageTime();
    const now = Date.now();
    const timeSinceLast = now - lastTime;

    // Random interval between 1-2 hours (3600000-7200000 ms)
    const minInterval = 60 * 60 * 1000; // 1 hour
    const maxInterval = 2 * 60 * 60 * 1000; // 2 hours
    const randomInterval = minInterval + Math.random() * (maxInterval - minInterval);

    return timeSinceLast > randomInterval;
}

// Trigger random autonomous message
function triggerAutonomousMessage() {
    console.log('Initiating autonomous community message...');
    localStorage.setItem('last_autonomous_message', Date.now().toString());
    initiateAutonomousConversation(false);
}

// Main autonomous system controller
function checkAutonomousActivity() {
    // Check for Saturday morning check-in first
    if (isSaturdayMorning()) {
        triggerSaturdayCheckIn();
        return; // Don't do random messages during check-in window
    }

    // Check for random autonomous messages
    if (shouldTriggerAutonomousMessage()) {
        triggerAutonomousMessage();
    }
}

// Initialize autonomous system
function initializeAutonomousSystem() {
    console.log('Autonomous community messaging system initialized');

    // Check immediately on load
    setTimeout(() => {
        checkAutonomousActivity();
    }, 5000); // Wait 5 seconds after page load

    // Check every 30 minutes
    setInterval(() => {
        checkAutonomousActivity();
    }, 30 * 60 * 1000);
}

// Start autonomous system when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAutonomousSystem);
} else {
    initializeAutonomousSystem();
}

// ========================================
// TESTING & DEBUG FUNCTIONS
// ========================================

// Manual triggers for testing (accessible via browser console)
window.testAutonomousMessage = function() {
    console.log('🧪 Testing autonomous message...');
    initiateAutonomousConversation(false);
};

window.testSaturdayCheckIn = function() {
    console.log('🧪 Testing Saturday check-in...');
    initiateAutonomousConversation(true);
};

window.resetAutonomousTimers = function() {
    console.log('🔄 Resetting autonomous timers...');
    localStorage.removeItem('last_autonomous_message');
    localStorage.removeItem('last_saturday_checkin');
    console.log('✅ Timers reset! Next check will trigger new messages.');
};

window.getAutonomousStatus = function() {
    const lastMsg = getLastAutonomousMessageTime();
    const lastCheckIn = getLastCheckInDate();
    const nextMsgIn = lastMsg ? Math.max(0, (60 * 60 * 1000) - (Date.now() - lastMsg)) : 0;

    console.log('📊 Autonomous System Status:');
    console.log('─────────────────────────────');
    console.log(`Last autonomous message: ${lastMsg ? new Date(lastMsg).toLocaleString() : 'Never'}`);
    console.log(`Next message in: ${Math.floor(nextMsgIn / 60000)} minutes (approximately)`);
    console.log(`Last Saturday check-in: ${lastCheckIn ? lastCheckIn.toLocaleString() : 'Never'}`);
    console.log(`Is Saturday morning now: ${isSaturdayMorning()}`);
    console.log(`Check-in already done this week: ${checkInAlreadyDone()}`);
    console.log('─────────────────────────────');
    console.log('💡 Try: testAutonomousMessage() or testSaturdayCheckIn()');
    console.log('💡 View stories: viewCheckInStories()');
};

window.viewCheckInStories = function(memberId) {
    let checkInHistory = {};
    try { checkInHistory = JSON.parse(localStorage.getItem('saturday_checkin_stories') || '{}'); } catch(e) {}

    if (memberId) {
        // Show specific member's stories
        const member = AI_MEMBERS.find(m => m.id === memberId);
        if (!member) {
            console.log(`❌ Member ${memberId} not found`);
            return;
        }
        console.log(`\n📖 Check-in Stories for ${member.name} (${memberId})`);
        console.log('═══════════════════════════════════════');
        if (checkInHistory[memberId] && checkInHistory[memberId].length > 0) {
            checkInHistory[memberId].forEach((story, idx) => {
                console.log(`\n[Week ${idx + 1}]:`);
                console.log(story);
                console.log('─────────────────────────────────────');
            });
        } else {
            console.log('No stories yet for this member.');
        }
    } else {
        // Show all members with stories
        console.log('\n📚 All Saturday Check-in Story History');
        console.log('═══════════════════════════════════════');
        const membersWithStories = Object.keys(checkInHistory);
        if (membersWithStories.length === 0) {
            console.log('No check-in stories recorded yet.');
            console.log('\n💡 Run testSaturdayCheckIn() to generate some stories!');
        } else {
            membersWithStories.forEach(id => {
                const member = AI_MEMBERS.find(m => m.id === id);
                const storyCount = checkInHistory[id].length;
                console.log(`\n${member ? member.name : id} (${id}): ${storyCount} check-in${storyCount > 1 ? 's' : ''}`);
                console.log(`💡 View details: viewCheckInStories('${id}')`);
            });
        }
    }
};

// ========================================
// END AUTONOMOUS COMMUNITY MESSAGING
// ========================================

window.openAsClient = function() {
    toggleCoachMode(false);
    if(typeof switchAppTab === 'function') switchAppTab('dashboard');
    const btn = document.createElement('div');
    btn.id = 'return-to-coach-btn';
    btn.innerHTML = '⏎ Return to Coach View';
    btn.style.cssText = 'position:fixed; bottom:90px; right:20px; background:#1e293b; color:white; padding:12px 20px; border-radius:50px; font-weight:bold; box-shadow:0 10px 25px rgba(0,0,0,0.3); z-index:10000; cursor:pointer; font-size:0.9rem;';
    btn.onclick = () => toggleCoachMode(true);
    document.body.appendChild(btn);
};

// Old submitCoachMessage removed as it is now defined earlier in the file.

// Load coach chat history from nudges table
window.loadChatHistory = async function() {
    const container = document.getElementById('chat-messages-container');
    if (!container || !window.currentUser) return;

    container.innerHTML = '';

    const coachId = await getCoachUserId();
    if (!coachId) {
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-muted);">Could not load messages.</div>`;
        return;
    }

    try {
        const { data: messages, error } = await window.supabaseClient
            .from('nudges')
            .select('*')
            .or(`and(sender_id.eq.${window.currentUser.id},receiver_id.eq.${coachId}),and(sender_id.eq.${coachId},receiver_id.eq.${window.currentUser.id})`)
            .order('created_at', { ascending: true })
            .limit(100);

        if (error) throw error;

        if (!messages || messages.length === 0) {
            const profile = await window.getUserProfile();
            const userName = profile?.name || '';
            const greeting = userName ? `Hey ${userName}!` : 'Hey!';
            container.innerHTML = `
                <div style="display: flex; justify-content: flex-start; align-items: flex-end; margin-bottom: 20px; animation: fadeIn 0.3s ease;">
                     <img src="assets/coach_shannon.jpg" style="width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); object-fit: cover;">
                     <div style="display: flex; flex-direction: column; align-items: flex-start; max-width: 80%;">
                         <div style="background: var(--chat-bg-coach); color: var(--chat-text-coach); padding: 12px 18px; border-radius: 18px 18px 18px 0; border: 1px solid var(--chat-border-coach); font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">
                             <p style="margin: 0; white-space: pre-wrap;">${greeting} Shannon here. Send me a message any time!</p>
                         </div>
                         <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-left: 5px;">Shannon</span>
                     </div>
                </div>`;
            return;
        }

        messages.forEach(msg => {
            const isUser = msg.sender_id === window.currentUser.id;
            const rowDiv = document.createElement('div');
            rowDiv.style.cssText = `display: flex; justify-content: ${isUser ? 'flex-end' : 'flex-start'}; align-items: flex-end; margin-bottom: 20px; animation: fadeIn 0.3s ease;`;

            const timeStr = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const msgText = msg.message || '';

            if (isUser) {
                rowDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: flex-end; max-width: 80%;">
                        <div style="background: var(--chat-bg-user); color: var(--chat-text-user); padding: 12px 18px; border-radius: 18px 18px 0 18px; font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">${msgText}</div>
                        <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-right: 5px;">You  ${timeStr}</span>
                    </div>
                    <img src="https://ui-avatars.com/api/?name=You&background=cbd5e1&color=fff" style="width: 36px; height: 36px; border-radius: 50%; margin-left: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                `;
            } else {
                rowDiv.innerHTML = `
                    <img src="assets/coach_shannon.jpg" style="width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); object-fit: cover;">
                    <div style="display: flex; flex-direction: column; align-items: flex-start; max-width: 80%;">
                        <div style="background: var(--chat-bg-coach); color: var(--chat-text-coach); padding: 12px 18px; border-radius: 18px 18px 18px 0; border: 1px solid var(--chat-border-coach); font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">
                            <p style="margin: 0; white-space: pre-wrap;">${msgText}</p>
                        </div>
                        <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-left: 5px;">Shannon  ${timeStr}</span>
                    </div>
                `;
            }
            container.appendChild(rowDiv);
        });
        scrollToBottomOfChat();

        // Mark coach messages as read
        await window.supabaseClient
            .from('nudges')
            .update({ read_at: new Date().toISOString() })
            .eq('receiver_id', window.currentUser.id)
            .eq('sender_id', coachId)
            .is('read_at', null);

    } catch (error) {
        console.error('Error loading coach chat history:', error);
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">Failed to load messages</div>`;
    }
};

// Append a new incoming message to the coach chat UI
window.appendCoachMessage = function(text) {
    const container = document.getElementById('chat-messages-container');
    if (!container) return;

    const rowDiv = document.createElement('div');
    rowDiv.style.cssText = "display: flex; justify-content: flex-start; align-items: flex-end; margin-bottom: 20px; animation: fadeIn 0.3s ease;";

    const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    rowDiv.innerHTML = `
        <img src="assets/coach_shannon.jpg" style="width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); object-fit: cover;">
        <div style="display: flex; flex-direction: column; align-items: flex-start; max-width: 80%;">
            <div style="background: var(--chat-bg-coach); color: var(--chat-text-coach); padding: 12px 18px; border-radius: 18px 18px 18px 0; border: 1px solid var(--chat-border-coach); font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">
                <p style="margin: 0; white-space: pre-wrap;">${text}</p>
            </div>
            <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-left: 5px;">Shannon  ${timeStr}</span>
        </div>
    `;

    container.appendChild(rowDiv);
    scrollToBottomOfChat();

    // Mark as unread
    localStorage.setItem('coach_unread_messages', 'true');

    // Notification Badge on App Icon
    if ('setAppBadge' in navigator && document.visibilityState === 'hidden') {
        navigator.setAppBadge(1).catch(e => console.error(e));
    }
};

/**
 * Subscribe to Supabase Realtime for new DMs (nudges) to this user
 * Messages appear instantly when coach (or anyone) sends a nudge
 */
window.subscribeToCoachMessages = function(userId) {
    if (!userId || !window.supabaseClient) return;

    // Track message IDs we've already shown to avoid duplicates
    window._shownMessageIds = window._shownMessageIds || new Set();

    const channel = window.supabaseClient
        .channel('dm-messages-' + userId)
        .on(
            'postgres_changes',
            {
                event: 'INSERT',
                schema: 'public',
                table: 'nudges',
                filter: `receiver_id=eq.${userId}`
            },
            async (payload) => {
                const newMessage = payload.new;

                // Avoid duplicates
                if (window._shownMessageIds.has(newMessage.id)) return;
                window._shownMessageIds.add(newMessage.id);

                // Check if the coach chat modal is open and message is from coach
                const coachId = await getCoachUserId();
                const modal = document.getElementById('coach-chat-modal');
                const isCoachChatOpen = modal && modal.style.display === 'flex';

                if (coachId && newMessage.sender_id === coachId && isCoachChatOpen) {
                    // Display the message in the coach chat
                    appendCoachMessage(newMessage.message);
                } else if (coachId && newMessage.sender_id === coachId) {
                    // Coach message but chat not open - mark as unread
                    localStorage.setItem('coach_unread_messages', 'true');
                    if ('setAppBadge' in navigator && document.visibilityState === 'hidden') {
                        navigator.setAppBadge(1).catch(e => console.error(e));
                    }
                }

                // Reload DM if the DM modal is open for this sender
                if (typeof currentDMRecipient !== 'undefined' && currentDMRecipient && currentDMRecipient.id === newMessage.sender_id) {
                    loadDirectMessages(currentDMRecipient.id);
                }

                console.log('Realtime: New DM received from', newMessage.sender_id);
            }
        )
        .subscribe((status) => {
            console.log('Realtime DM subscription status:', status);
        });

    // Store channel reference for cleanup
    window._coachMessagesChannel = channel;
};

window.openCoachChat = function() {
    openCoachChatModal();

    // Clear unread flag
    localStorage.removeItem('coach_unread_messages');

    // Clear Badge
    if ('clearAppBadge' in navigator) {
        navigator.clearAppBadge().catch(e => console.error(e));
    }
    if ('setAppBadge' in navigator) {
        navigator.setAppBadge(0).catch(e => console.error(e));
    }
};

// Helper to save AI community messages to DB and Local Cache
async function saveCommunityMessage(persona, text) {
    // 1. Save to DB (Fire and forget to avoid blocking UI too much, or await if needed)
    const user = window.currentUser;
    if(user) {
        // We do not await this to keep UI snappy for animations, or we catch errors
        dbHelpers.conversations.create(user.id, 'community', 'model', text, persona.name).catch(e => console.error("DB Save Error", e));
    }

    // 2. Update Local Cache (for immediate UI and autonomous logic)
    let msgs = [];
    try { msgs = JSON.parse(localStorage.getItem('community_chat_history') || '[]'); } catch(e) {}
    
    // SAFETY LIMIT: Only keep last 50 messages to prevent crash
    if (msgs.length > 50) {
        msgs = msgs.slice(msgs.length - 50); 
    }

    msgs.push({
        authorId: persona.id,
        authorName: persona.name,
        authorAvatar: (persona.id || 'm1').replace('m', ''),
        text: text,
        timestamp: Date.now()
    });
    
    try {
        localStorage.setItem('community_chat_history', JSON.stringify(msgs));
    } catch(e) {
        console.warn("Storage full, clearing old history");
        localStorage.removeItem('community_chat_history'); // Emergency clear
    }
    
    // 3. Render
    if(typeof renderChat === 'function') renderChat(msgs);
}

window.loadCommunityFeed = async function() {
    if(!window.currentUser) return;

    try {
        // Get user's referral network (people they invited + who invited them)
        const network = await dbHelpers.referrals.getReferralNetwork(window.currentUser.id);

        // Create a Set of allowed user IDs (network + current user)
        const allowedUserIds = new Set([window.currentUser.id]);
        if (network && network.length > 0) {
            network.forEach(n => allowedUserIds.add(n.network_user_id));
        }

        // Get all community messages for this user
        const dbMessages = await dbHelpers.conversations.getHistory(window.currentUser.id, 'community');

        // Filter to only show messages from referral network
        const filteredMessages = dbMessages.filter(m => allowedUserIds.has(m.user_id));

        // Map DB messages to UI format for human-only chat
        const messages = filteredMessages.map(m => {
            const isCurrentUser = m.user_id === window.currentUser.id;

            return {
                authorId: isCurrentUser ? 'current-user' : (m.user_id || 'other-user'),
                authorName: m.author_name || (isCurrentUser ? 'You' : 'Friend'),
                authorAvatar: m.author_avatar || '', // Will show initials if no avatar
                text: m.message_text || m.text,
                timestamp: m.timestamp || new Date(m.created_at).getTime(),
                reactions: m.reactions || []
            };
        });

        // Cache for UI (keep last 50 messages)
        const cachedMessages = messages.slice(-50);
        localStorage.setItem('community_chat_history', JSON.stringify(cachedMessages));

        if(typeof renderChat === 'function') renderChat(cachedMessages);
    } catch (error) {
        console.error('Error loading community feed:', error);
        // Show empty chat on error
        if(typeof renderChat === 'function') renderChat([]);
    }
};

async function sendCommunityMessage() {
    const input = document.getElementById('community-chat-input');
    const text = input.value?.trim();
    if(!text) return;
    
    input.value = '';
    
    // Optimistic UI Update
    const user = window.currentUser || {};
    const userName = (await window.getUserProfile())?.name || 'Friend';
    
    const tempMsg = { 
        authorId: 'current-user', 
        authorName: userName,
        text, 
        timestamp: Date.now() 
    };
    
    let messages = [];
    try { messages = JSON.parse(localStorage.getItem('community_chat_history') || '[]'); } catch(e) {}
    messages.push(tempMsg);
    renderChat(messages); // Render immediately

    // Save to DB
    await dbHelpers.conversations.create(user.id, 'community', 'user', text, userName);

    // No AI responses - this is human-only referral network chat
}

// --- REFERRAL SYSTEM ---

let currentReferralCode = null;

// Client-side fallback code generator (used if database function fails)
function generateReferralCodeFallback() {
    // Generate a random 8-character alphanumeric code
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    console.log('Generated fallback referral code:', code);
    return code;
}

// Check if referral code already exists in database
async function isReferralCodeUnique(code) {
    try {
        const existingUser = await window.dbHelpers.referrals.getUserByReferralCode(code);
        return !existingUser; // If no user found, code is unique
    } catch (error) {
        // If error is "not found", code is unique
        if (error.message && error.message.includes('not found')) {
            return true;
        }
        console.error('Error checking code uniqueness:', error);
        return true; // Assume unique if we can't check
    }
}

// Dismiss referral banner
function dismissReferralBanner() {
    const banner = document.getElementById('referral-invite-banner');
    if (banner) {
        banner.style.display = 'none';
        localStorage.setItem('referral_banner_dismissed', 'true');
    }
}

// Check if banner was dismissed and hide it
function checkReferralBannerDismissed() {
    const dismissed = localStorage.getItem('referral_banner_dismissed');
    if (dismissed === 'true') {
        const banner = document.getElementById('referral-invite-banner');
        if (banner) banner.style.display = 'none';
    }
}

// Load referral stats and update UI
async function loadReferralStats() {
    if (!window.currentUser) {
        const error = new Error('No current user found. Please ensure you are logged in.');
        console.error('loadReferralStats:', error.message);
        throw error;
    }

    // Check if banner was dismissed
    checkReferralBannerDismissed();

    try {
        console.log('Loading referral stats for user:', window.currentUser.id);
        const stats = await window.dbHelpers.referrals.getStats(window.currentUser.id);
        console.log('Referral stats loaded:', stats);

        // Check if user has a referral code, if not generate one using database function
        if (!stats.referralCode) {
            console.log('No referral code found, generating one...');

            let newCode = null;
            let usedFallback = false;

            try {
                // Try database function first
                console.log('Calling database generateReferralCode()...');
                newCode = await window.dbHelpers.referrals.generateReferralCode();
                console.log('Generated code via database:', newCode);

                if (!newCode) {
                    console.warn('Database function returned no code, using fallback generator');
                    usedFallback = true;
                    throw new Error('Database returned null');
                }
            } catch (dbError) {
                console.error('Database code generation failed:', dbError.message);
                console.log('Falling back to client-side code generation...');
                usedFallback = true;

                // Try client-side generation with uniqueness check
                let attempts = 0;
                const maxAttempts = 10;

                while (attempts < maxAttempts) {
                    newCode = generateReferralCodeFallback();
                    const isUnique = await isReferralCodeUnique(newCode);

                    if (isUnique) {
                        console.log('✓ Generated unique code (client-side):', newCode);
                        break;
                    }

                    attempts++;
                    console.log(`Code collision, retrying... (${attempts}/${maxAttempts})`);
                }

                if (attempts >= maxAttempts) {
                    throw new Error('Failed to generate unique referral code after multiple attempts');
                }
            }

            // Update user record with new referral code
            if (newCode) {
                try {
                    console.log('Updating user with new referral code...');
                    await window.dbHelpers.users.update(window.currentUser.id, {
                        referral_code: newCode
                    });
                    stats.referralCode = newCode;
                    console.log(`✓ Successfully saved referral code (${usedFallback ? 'fallback' : 'database'}):`, newCode);
                } catch (updateError) {
                    console.error('❌ Error saving referral code:', updateError);
                    throw new Error(`Failed to save referral code: ${updateError.message}`);
                }
            } else {
                throw new Error('No referral code generated');
            }
        }

        // Update stats in banner
        if (document.getElementById('referral-count')) {
            document.getElementById('referral-count').textContent = stats.totalReferrals || 0;
        }
        if (document.getElementById('free-days-count')) {
            document.getElementById('free-days-count').textContent = stats.freeDaysEarned || 0;
        }

        // Update network count in header (will be updated with friends count in updateFriendsCount)
        // Initial display from referrals, friends count will combine
        const referralCount = stats.totalReferrals || 0;
        if (document.getElementById('referral-network-count')) {
            // Try to get friends count too for a combined network number
            try {
                const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);
                const friendCount = friends.length;
                const totalNetwork = referralCount + friendCount;
                document.getElementById('referral-network-count').textContent =
                    totalNetwork === 0 ? 'Add your first friend' :
                    totalNetwork === 1 ? '1 connection in your network' :
                    `${totalNetwork} connections in your network`;
            } catch (friendError) {
                // If friends fetch fails, just show referral count
                document.getElementById('referral-network-count').textContent =
                    referralCount === 0 ? 'Invite your first friend' :
                    referralCount === 1 ? '1 friend in your network' :
                    `${referralCount} friends in your network`;
            }
        }

        // Store code for modal
        currentReferralCode = stats.referralCode;
        console.log('✓ Current referral code set to:', currentReferralCode);

    } catch (error) {
        console.error('❌ Error loading referral stats:', error);
        console.error('Error stack:', error.stack);
        // Re-throw to allow caller to handle
        throw error;
    }
}

// Open share modal
async function openShareReferralModal() {
    const modal = document.getElementById('share-referral-modal');
    if (!modal) {
        console.error('Share referral modal not found');
        return;
    }

    // Show modal with flex display
    modal.style.display = 'flex';

    const codeDisplay = document.getElementById('referral-code-display');
    if (!codeDisplay) {
        console.error('Referral code display element not found');
        return;
    }

    // Show loading state
    codeDisplay.textContent = 'Loading...';
    codeDisplay.style.color = 'var(--text-muted)';

    // Wait for authentication if not ready
    if (!window.currentUser) {
        console.log('Waiting for authentication...');
        let attempts = 0;
        const maxAttempts = 30; // 3 seconds max wait

        while (!window.currentUser && attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }

        if (!window.currentUser) {
            console.error('Authentication timeout - user not available');
            codeDisplay.textContent = 'Please log in first';
            codeDisplay.style.color = '#ef4444';

            setTimeout(() => {
                codeDisplay.textContent = 'Tap to retry';
                codeDisplay.style.cursor = 'pointer';
                codeDisplay.onclick = async () => {
                    codeDisplay.onclick = null;
                    codeDisplay.style.cursor = 'default';
                    codeDisplay.textContent = 'Loading...';
                    codeDisplay.style.color = 'var(--text-muted)';
                    await openShareReferralModal();
                };
            }, 2000);
            return;
        }
    }

    // If we don't have a referral code yet, try to load it
    if (!currentReferralCode) {
        try {
            console.log('Loading referral stats...');
            await loadReferralStats();
        } catch (error) {
            console.error('Failed to load referral stats:', error);
            codeDisplay.textContent = 'Failed to load code';
            codeDisplay.style.color = '#ef4444';

            // Show user-friendly error message with details
            const errorMsg = error.message || 'Unknown error';
            console.error('Error details:', errorMsg);

            setTimeout(() => {
                codeDisplay.textContent = 'Tap to retry';
                codeDisplay.style.cursor = 'pointer';
                codeDisplay.onclick = async () => {
                    codeDisplay.onclick = null;
                    codeDisplay.style.cursor = 'default';
                    codeDisplay.textContent = 'Loading...';
                    codeDisplay.style.color = 'var(--text-muted)';
                    await openShareReferralModal();
                };
            }, 2000);
            return;
        }
    }

    // Load and display referral code
    if (currentReferralCode) {
        codeDisplay.textContent = currentReferralCode;
        codeDisplay.style.color = 'var(--primary)';
        codeDisplay.style.cursor = 'default';
        codeDisplay.onclick = null;
        console.log('✓ Referral code displayed:', currentReferralCode);
    } else {
        // Fallback if still no code after successful load
        console.error('No referral code available after loading');
        codeDisplay.textContent = 'Tap to retry';
        codeDisplay.style.color = '#ef4444';
        codeDisplay.style.cursor = 'pointer';
        codeDisplay.onclick = async () => {
            codeDisplay.onclick = null;
            codeDisplay.style.cursor = 'default';
            codeDisplay.textContent = 'Loading...';
            codeDisplay.style.color = 'var(--text-muted)';
            await openShareReferralModal();
        };
    }
}

// Close share modal
function closeShareReferralModal() {
    const modal = document.getElementById('share-referral-modal');
    if (modal) modal.style.display = 'none';
}

// Copy referral code
function copyReferralCode() {
    const codeDisplay = document.getElementById('referral-code-display');
    const code = codeDisplay.textContent;

    navigator.clipboard.writeText(code).then(() => {
        // Show feedback
        const originalText = codeDisplay.textContent;
        codeDisplay.textContent = 'Copied!';
        codeDisplay.style.color = '#22c55e';

        setTimeout(() => {
            codeDisplay.textContent = originalText;
            codeDisplay.style.color = 'var(--primary)';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy code. Please copy manually.');
    });
}

// Share via WhatsApp
function shareViaWhatsApp() {
    const code = currentReferralCode;
    const link = `${window.location.origin}/login.html?ref=${code}`;
    const message = `Hey! Join me on FITGotchi. Gamify your fitness - I'm really loving it! We BOTH get 1 week double XP! Use my code ${code} or click here: ${link}`;

    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

// Share via Facebook
function shareViaFacebook() {
    const code = currentReferralCode;
    const link = `${window.location.origin}/login.html?ref=${code}`;
    const message = `Hey! Join me on FITGotchi. Gamify your fitness - I'm really loving it! We BOTH get 1 week double XP! Use my code ${code}`;

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
        // Try Messenger app on mobile
        window.location.href = `fb-messenger://share?link=${encodeURIComponent(link)}&app_id=`;
    } else {
        // Use standard Facebook Sharer on desktop (allows sharing to Feed, Groups, or Messenger)
        const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}&quote=${encodeURIComponent(message)}`;
        window.open(fbUrl, '_blank', 'width=600,height=400');
    }
}

// Share via SMS
function shareViaSMS() {
    const code = currentReferralCode;
    const link = `${window.location.origin}/login.html?ref=${code}`;
    const message = `Hey! Join me on FITGotchi. Gamify your fitness - I'm really loving it! We BOTH get 1 week double XP! Use code ${code} or click: ${link}`;

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
        const smsUrl = `sms:?&body=${encodeURIComponent(message)}`;
        window.location.href = smsUrl;
    } else {
        // Desktop fallback - copy to clipboard and notify
        navigator.clipboard.writeText(message).then(() => {
            showToast('Message copied to clipboard! Paste it into your SMS app.', 'info');
        });
    }
}

// ============================================================
// FRIENDS SYSTEM
// ============================================================

let friendSearchTimeout = null;

// Open Add Friend Modal
function openAddFriendModal() {
    const modal = document.getElementById('add-friend-modal');
    if (modal) {
        modal.style.display = 'flex';
        showFriendTab('search');
        loadPendingFriendRequests();
        loadFriendsList();
    }
}

// Close Add Friend Modal
function closeAddFriendModal() {
    const modal = document.getElementById('add-friend-modal');
    if (modal) modal.style.display = 'none';
}

// Show friend tab
function showFriendTab(tab) {
    // Update tab buttons
    const tabs = ['search', 'requests', 'friends'];
    tabs.forEach(t => {
        const btn = document.getElementById(`friend-tab-${t}`);
        const content = document.getElementById(t === 'search' ? 'friend-search-content' :
                                                  t === 'requests' ? 'friend-requests-content' :
                                                  'friend-list-content');
        if (btn) {
            btn.style.background = t === tab ? 'white' : 'transparent';
            btn.style.color = t === tab ? 'var(--primary)' : '#64748b';
        }
        if (content) {
            content.style.display = t === tab ? 'block' : 'none';
        }
    });
}

// Debounced search
function debouncedFriendSearch() {
    clearTimeout(friendSearchTimeout);
    friendSearchTimeout = setTimeout(() => {
        searchForFriends();
    }, 300);
}

// Search for friends
async function searchForFriends() {
    const input = document.getElementById('friend-search-input');
    const resultsContainer = document.getElementById('friend-search-results');
    const query = input.value.trim();

    if (query.length < 2) {
        resultsContainer.innerHTML = `
            <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                <p style="margin:0; font-size:0.95rem;">Enter at least 2 characters to search</p>
            </div>
        `;
        return;
    }

    resultsContainer.innerHTML = `
        <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
            <div style="width:32px; height:32px; border:3px solid #e2e8f0; border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 12px;"></div>
            <p style="margin:0; font-size:0.95rem;">Searching...</p>
        </div>
    `;

    try {
        const results = await window.dbHelpers.friends.searchUsers(query, window.currentUser.id);

        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <p style="margin:0; font-size:0.95rem;">No users found matching "${query}"</p>
                </div>
            `;
            return;
        }

        resultsContainer.innerHTML = results.map(user => {
            const initials = (user.user_name || user.user_email || '?').charAt(0).toUpperCase();
            const statusButton = getStatusButton(user.user_id, user.friendship_status);

            return `
                <div style="display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background:#f8fafc; margin-bottom:10px;">
                    <div style="width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg, var(--primary), #10b981); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:1.2rem; flex-shrink:0;">
                        ${user.user_photo ? `<img src="${user.user_photo}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : initials}
                    </div>
                    <div style="flex:1; min-width:0;">
                        <div style="font-weight:600; color:var(--text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${user.user_name || 'Unknown User'}</div>
                        <div style="font-size:0.85rem; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${user.user_email}</div>
                    </div>
                    ${statusButton}
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error searching for friends:', error);
        resultsContainer.innerHTML = `
            <div style="text-align:center; padding:40px 20px; color:#ef4444;">
                <p style="margin:0; font-size:0.95rem;">Error searching. Please try again.</p>
            </div>
        `;
    }
}

// Get status button HTML
function getStatusButton(userId, status) {
    switch(status) {
        case 'accepted':
            return `<div style="padding:8px 16px; background:#f0fdf4; color:#22c55e; border-radius:8px; font-weight:600; font-size:0.85rem;">Friends</div>`;
        case 'pending':
            return `<div style="padding:8px 16px; background:#fef3c7; color:#f59e0b; border-radius:8px; font-weight:600; font-size:0.85rem;">Pending</div>`;
        default:
            return `<button onclick="sendFriendRequest('${userId}')" style="padding:8px 16px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.85rem; transition:all 0.2s;">Add</button>`;
    }
}

// Send friend request
async function sendFriendRequest(friendId) {
    try {
        await window.dbHelpers.friends.sendRequest(window.currentUser.id, friendId);

        // Show success feedback
        showToast('Friend request sent!', 'success');

        // Refresh search results
        searchForFriends();
    } catch (error) {
        console.error('Error sending friend request:', error);
        if (error.message.includes('duplicate')) {
            showToast('Friend request already sent', 'warning');
        } else {
            showToast('Failed to send request. Please try again.', 'error');
        }
    }
}

// Load pending friend requests
async function loadPendingFriendRequests() {
    const container = document.getElementById('friend-requests-list');
    const badge = document.getElementById('friend-request-badge');

    try {
        const requests = await window.dbHelpers.friends.getPendingRequests(window.currentUser.id);

        // Update badge
        if (badge) {
            if (requests.length > 0) {
                badge.style.display = 'inline';
                badge.textContent = requests.length;
            } else {
                badge.style.display = 'none';
            }
        }

        if (requests.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                        <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <p style="margin:0; font-size:0.95rem;">No pending friend requests</p>
                </div>
            `;
            return;
        }

        container.innerHTML = requests.map(request => {
            const initials = (request.sender_name || request.sender_email || '?').charAt(0).toUpperCase();
            return `
                <div style="display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background:#f8fafc; margin-bottom:10px;">
                    <div style="width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg, var(--primary), #10b981); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:1.2rem; flex-shrink:0;">
                        ${request.sender_photo ? `<img src="${request.sender_photo}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : initials}
                    </div>
                    <div style="flex:1; min-width:0;">
                        <div style="font-weight:600; color:var(--text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${request.sender_name || 'Unknown User'}</div>
                        <div style="font-size:0.85rem; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${request.sender_email}</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button onclick="acceptFriendRequest('${request.request_id}')" style="padding:8px 14px; background:#22c55e; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.85rem; transition:all 0.2s;">Accept</button>
                        <button onclick="declineFriendRequest('${request.request_id}')" style="padding:8px 14px; background:#f1f5f9; color:#64748b; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.85rem; transition:all 0.2s;">Decline</button>
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading friend requests:', error);
        container.innerHTML = `
            <div style="text-align:center; padding:40px 20px; color:#ef4444;">
                <p style="margin:0; font-size:0.95rem;">Error loading requests. Please try again.</p>
            </div>
        `;
    }
}

// Accept friend request
async function acceptFriendRequest(requestId) {
    try {
        await window.dbHelpers.friends.acceptRequest(requestId);
        showToast('Friend request accepted!', 'success');
        loadPendingFriendRequests();
        loadFriendsList();
        updateFriendsCount();
    } catch (error) {
        console.error('Error accepting friend request:', error);
        showToast('Failed to accept request. Please try again.', 'error');
    }
}

// Decline friend request
async function declineFriendRequest(requestId) {
    try {
        await window.dbHelpers.friends.declineRequest(requestId);
        showToast('Friend request declined', 'info');
        loadPendingFriendRequests();
    } catch (error) {
        console.error('Error declining friend request:', error);
        showToast('Failed to decline request. Please try again.', 'error');
    }
}

// Load friends list
async function loadFriendsList() {
    const container = document.getElementById('friends-list');

    try {
        const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);

        if (friends.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                    <p style="margin:0; font-size:0.95rem;">No friends yet. Start by adding some!</p>
                </div>
            `;
            return;
        }

        container.innerHTML = friends.map(friend => {
            const initials = (friend.friend_name || friend.friend_email || '?').charAt(0).toUpperCase();
            return `
                <div style="display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background:#f8fafc; margin-bottom:10px;">
                    <div style="width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg, var(--primary), #10b981); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:1.2rem; flex-shrink:0;">
                        ${friend.friend_photo ? `<img src="${friend.friend_photo}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : initials}
                    </div>
                    <div style="flex:1; min-width:0;">
                        <div style="font-weight:600; color:var(--text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${friend.friend_name || 'Unknown User'}</div>
                        <div style="font-size:0.85rem; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${friend.friend_email}</div>
                    </div>
                    <button onclick="removeFriend('${friend.friend_id}')" style="padding:8px 14px; background:#fee2e2; color:#ef4444; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.85rem; transition:all 0.2s;">Remove</button>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading friends:', error);
        container.innerHTML = `
            <div style="text-align:center; padding:40px 20px; color:#ef4444;">
                <p style="margin:0; font-size:0.95rem;">Error loading friends. Please try again.</p>
            </div>
        `;
    }
}

// Remove friend
async function removeFriend(friendId) {
    if (!confirm('Are you sure you want to remove this friend?')) return;

    try {
        await window.dbHelpers.friends.removeFriend(window.currentUser.id, friendId);
        showToast('Friend removed', 'info');
        loadFriendsList();
        updateFriendsCount();
    } catch (error) {
        console.error('Error removing friend:', error);
        showToast('Failed to remove friend. Please try again.', 'error');
    }
}

// Update network count in header (friends + referrals)
async function updateFriendsCount() {
    try {
        const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);
        const referralStats = await window.dbHelpers.referrals.getStats(window.currentUser.id);
        const friendCount = friends.length;
        const referralCount = referralStats.totalReferrals || 0;
        const totalNetwork = friendCount + referralCount;

        const countEl = document.getElementById('referral-network-count');
        if (countEl) {
            countEl.textContent = totalNetwork === 0 ? 'Add your first friend' :
                                  totalNetwork === 1 ? '1 connection in your network' :
                                  `${totalNetwork} connections in your network`;
        }
    } catch (error) {
        console.error('Error updating network count:', error);
    }
}

// ============================================================
// FRIENDS VIEW FUNCTIONS
// ============================================================

// Initialize Friends View
async function initFriendsView() {
    console.log('Initializing Feed View...');
    // Hide dismissed promo cards
    if (localStorage.getItem('referral_banner_dismissed') === 'true') {
        const banner = document.getElementById('friends-referral-banner');
        if (banner) banner.style.display = 'none';
    }
    if (localStorage.getItem('feed_incentive_dismissed') === 'true') {
        const incentive = document.getElementById('feed-post-incentive');
        if (incentive) incentive.style.display = 'none';
    }
    // Load active games
    if (typeof loadActiveGames === 'function') {
        loadActiveGames();
    }
    // Load photo feed on feed page
    if (typeof loadPhotoFeed === 'function') {
        loadPhotoFeed('friends-photo-feed', 'friends-feed-empty');
    }
    // Load group chats and friends in background (for messages panel)
    await loadGroupChats();
    await loadFriendsCards();
}

// Load friend cards for the Instagram DM-style list
async function loadFriendsCards() {
    const container = document.getElementById('friends-cards-list');
    const countLabel = document.getElementById('friends-count-label');

    if (!container || !window.currentUser) return;

    try {
        // Use get_friends_with_status with fallback for resilience
        const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);

        // Update count label
        if (countLabel) {
            countLabel.textContent = friends.length === 0 ? '0 friends' :
                                     friends.length === 1 ? '1 friend' :
                                     `${friends.length} friends`;
        }

        if (friends.length === 0) {
            container.innerHTML = `
                <div style="padding: 30px 20px; text-align: center; background: #f8fafc;">
                    <div style="font-size: 2rem; margin-bottom: 8px;">👋</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Add friends to see them here!</div>
                    <button onclick="openAddFriendModal()" style="margin-top: 12px; background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">
                        Find Friends
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = friends.map((friend, index) => {
            const initials = (friend.friend_name || '?').charAt(0).toUpperCase();
            const hasActivity = friend.has_workout_today || friend.has_meal_today;
            const streakDisplay = friend.current_streak > 0 ? `🔥 ${friend.current_streak}` : '';
            const isLastItem = index === friends.length - 1;

            // Build status text based on activity
            let statusText = '';
            let statusColor = 'var(--text-muted)';

            if (friend.has_personal_best) {
                statusText = '🏆 New personal best!';
                statusColor = '#d97706';
            } else if (hasActivity) {
                statusText = 'Active today';
                statusColor = '#22c55e';
            } else if (friend.days_inactive > 0) {
                statusText = friend.days_inactive === 1 ? 'Not logged in yesterday' :
                             friend.days_inactive < 7 ? `Inactive ${friend.days_inactive} days` :
                             'Inactive 7+ days';
                statusColor = friend.days_inactive >= 3 ? '#ef4444' : 'var(--text-muted)';
            } else {
                statusText = 'No activity yet';
            }

            return `
                <div style="display: flex; align-items: center; padding: 12px 16px; cursor: pointer; background: white; ${!isLastItem ? 'border-bottom: 1px solid #f1f5f9;' : ''}" onclick="viewUserProfile('${friend.friend_id}', '${(friend.friend_name || '').replace(/'/g, "\\'")}', '${(friend.friend_photo || '').replace(/'/g, "\\'")}')">
                    <div style="position: relative; margin-right: 12px;">
                        <div style="width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.3rem; overflow: hidden;">
                            ${friend.friend_photo ? `<img src="${friend.friend_photo}" style="width: 100%; height: 100%; object-fit: cover;">` : initials}
                        </div>
                        ${hasActivity ? '<div style="position: absolute; bottom: 2px; right: 2px; width: 14px; height: 14px; background: #22c55e; border-radius: 50%; border: 2px solid white;"></div>' : ''}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                            <span style="font-weight: 600; color: var(--text-main); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${friend.friend_name || 'Friend'}</span>
                            ${streakDisplay ? `<span style="font-size: 0.75rem; color: #f97316;">${streakDisplay}</span>` : ''}
                        </div>
                        <div style="font-size: 0.8rem; color: ${statusColor}; display: flex; align-items: center; gap: 6px;">
                            ${statusText}
                        </div>
                        <div style="display: flex; gap: 6px; margin-top: 4px;">
                            ${friend.has_workout_today ? '<span style="background: #dcfce7; color: #16a34a; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500;">💪 Workout</span>' : ''}
                            ${friend.has_meal_today ? '<span style="background: #fef3c7; color: #d97706; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500;">🥗 Logged</span>' : ''}
                            ${friend.total_calories_today > 0 ? `<span style="background: #f0fdf4; color: #059669; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500;">🔥 ${friend.total_calories_today} cal</span>` : ''}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;" onclick="event.stopPropagation();">
                        ${!hasActivity && friend.can_nudge ? `
                            <button onclick="event.stopPropagation(); sendNudgeToFriend('${friend.friend_id}', '${friend.friend_name}')" style="width: 36px; height: 36px; background: #fef2f2; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Send nudge">
                                <span style="font-size: 1rem;">👋</span>
                            </button>
                        ` : ''}
                        <button onclick="event.stopPropagation(); openDirectMessage('${friend.friend_id}', '${friend.friend_name}', '${friend.friend_photo || ''}')" style="width: 36px; height: 36px; background: #f1f5f9; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Message">
                            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--text-muted);"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                        </button>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading friend cards:', error);
        container.innerHTML = `
            <div style="padding: 20px; text-align: center; background: #fef2f2;">
                <div style="color: #ef4444; font-size: 0.85rem;">Failed to load friends</div>
                <button onclick="loadFriendsCards()" style="margin-top: 10px; padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">Retry</button>
            </div>
        `;
    }
}

// Load activity feed
async function loadActivityFeed(filter = 'all') {
    const container = document.getElementById('activity-feed-container');

    if (!container || !window.currentUser) return;

    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="width: 30px; height: 30px; border: 3px solid #f1f5f9; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            <div style="margin-top: 10px; color: var(--text-muted); font-size: 0.85rem;">Loading activity...</div>
        </div>
    `;

    try {
        // Call the activity feed RPC function
        const { data: activities, error } = await window.supabaseClient
            .rpc('get_friend_activity_feed', { user_uuid: window.currentUser.id, days_back: 7 });

        if (error) throw error;

        // Filter if needed
        let filteredActivities = activities || [];
        if (filter !== 'all') {
            const typeMap = {
                'workouts': 'workout',
                'meals': 'meal',
                'stories': 'story',
                'achievements': 'achievement',
                'rewards': ['free_week', 'referral_reward']
            };
            const filterTypes = typeMap[filter];
            if (Array.isArray(filterTypes)) {
                filteredActivities = filteredActivities.filter(a => filterTypes.includes(a.activity_type));
            } else {
                filteredActivities = filteredActivities.filter(a => a.activity_type === filterTypes);
            }
        }

        if (filteredActivities.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                    <div style="font-size: 3rem; margin-bottom: 10px;">👥</div>
                    <div style="font-size: 0.95rem; margin-bottom: 5px;">No activity yet</div>
                    <div style="font-size: 0.8rem;">Add friends to see what they're up to!</div>
                </div>
            `;
            return;
        }

        container.innerHTML = filteredActivities.map(activity => {
            const initials = (activity.user_name || '?').charAt(0).toUpperCase();
            const timeAgo = getTimeAgo(new Date(activity.activity_time));

            // Different icons/colors based on activity type
            const typeConfig = {
                workout: { icon: '💪', bg: '#dcfce7', color: '#16a34a', label: 'completed' },
                meal: { icon: '🥗', bg: '#fef3c7', color: '#d97706', label: 'logged' },
                story: { icon: '📸', bg: '#e0e7ff', color: '#6366f1', label: 'shared' },
                achievement: { icon: '🏆', bg: '#fef2f2', color: '#ef4444', label: 'earned' },
                free_week: { icon: '🎉', bg: '#f0fdf4', color: '#22c55e', label: 'unlocked' },
                referral_reward: { icon: '🎁', bg: '#fdf4ff', color: '#c026d3', label: 'received' }
            };
            const config = typeConfig[activity.activity_type] || typeConfig.workout;

            return `
                <div style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #f1f5f9;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div onclick="viewUserProfile('${activity.user_id}', '${(activity.user_name || '').replace(/'/g, "\\'")}', '${(activity.user_photo || '').replace(/'/g, "\\'")}')" style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; flex-shrink: 0; overflow: hidden; cursor: pointer;">
                            ${activity.user_photo ? `<img src="${activity.user_photo}" style="width: 100%; height: 100%; object-fit: cover;">` : initials}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                                <div>
                                    <span onclick="viewUserProfile('${activity.user_id}', '${(activity.user_name || '').replace(/'/g, "\\'")}', '${(activity.user_photo || '').replace(/'/g, "\\'")}')" style="font-weight: 600; color: var(--text-main); cursor: pointer;">${activity.user_name}</span>
                                    <span style="color: var(--text-muted);"> ${config.label} </span>
                                    <span style="font-weight: 500; color: var(--text-main);">${activity.activity_title}</span>
                                </div>
                                <span style="font-size: 0.75rem; color: var(--text-muted); white-space: nowrap;">${timeAgo}</span>
                            </div>
                            ${activity.activity_details ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">${activity.activity_details}</div>` : ''}
                            <div style="margin-top: 10px; display: flex; gap: 8px;">
                                <button onclick="openDirectMessage('${activity.user_id}', '${activity.user_name}', '${activity.user_photo || ''}')" style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: #f1f5f9; border: none; border-radius: 8px; cursor: pointer; font-size: 0.8rem; color: var(--text-muted);">
                                    💬 Message
                                </button>
                                <button onclick="sendCheers('${activity.user_id}', '${activity.activity_type}')" style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: ${config.bg}; border: none; border-radius: 8px; cursor: pointer; font-size: 0.8rem; color: ${config.color};">
                                    ${config.icon} Cheers!
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading activity feed:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #ef4444;">
                <div style="font-size: 0.95rem;">Failed to load activity feed</div>
                <button onclick="loadActivityFeed()" style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
            </div>
        `;
    }
}

// Filter activity feed
function filterActivityFeed(filter) {
    loadActivityFeed(filter);
}

// ============================================================
// GROUP CHAT FUNCTIONS
// ============================================================

let currentGroupChatId = null;
let selectedWinType = 'workout_complete';
let selectedGroupMembers = [];

// Helper to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load group chats list
async function loadGroupChats() {
    const container = document.getElementById('group-chats-container');

    if (!container || !window.currentUser) return;

    // Show loading
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="width: 30px; height: 30px; border: 3px solid #f1f5f9; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            <div style="margin-top: 10px; color: var(--text-muted); font-size: 0.85rem;">Loading chats...</div>
        </div>
    `;

    try {
        const { data: chats, error } = await window.supabaseClient
            .rpc('get_user_group_chats', { user_uuid: window.currentUser.id });

        if (error) throw error;

        if (!chats || chats.length === 0) {
            container.innerHTML = `
                <div id="group-chats-empty" style="text-align: center; padding: 30px 20px; background: white; border-radius: 12px; border: 1px solid #f1f5f9;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">💬</div>
                    <div style="font-size: 0.95rem; color: var(--text-main); font-weight: 600; margin-bottom: 5px;">No group chats yet</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">Start a group chat to share wins with friends!</div>
                    <button onclick="openCreateGroupChatModal()" style="background: linear-gradient(135deg, var(--primary), #10b981); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">
                        Create Your First Group
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = chats.map(chat => {
            const timeAgo = chat.last_message_at ? getTimeAgo(new Date(chat.last_message_at)) : '';
            const preview = chat.last_message ? (chat.last_message.length > 40 ? chat.last_message.substring(0, 40) + '...' : chat.last_message) : 'No messages yet';

            return `
                <div onclick="openGroupChat('${chat.chat_id}', '${escapeHtml(chat.chat_name)}', '${escapeHtml(chat.member_names || '')}')" style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #f1f5f9; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.01)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; flex-shrink: 0;">
                            💬
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <div style="font-weight: 600; color: var(--text-main);">${escapeHtml(chat.chat_name)}</div>
                                ${timeAgo ? `<div style="font-size: 0.75rem; color: var(--text-muted);">${timeAgo}</div>` : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${chat.last_message_by ? `<span style="font-weight: 500;">${escapeHtml(chat.last_message_by)}:</span> ` : ''}${escapeHtml(preview)}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                ${chat.member_count} member${chat.member_count > 1 ? 's' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading group chats:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #ef4444;">
                <div style="font-size: 0.95rem;">Failed to load group chats</div>
                <button onclick="loadGroupChats()" style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
            </div>
        `;
    }
}

// Open group chat modal
async function openGroupChat(chatId, chatName, memberNames) {
    currentGroupChatId = chatId;
    document.getElementById('gc-chat-name').textContent = chatName;
    document.getElementById('gc-chat-members').textContent = memberNames || 'Loading...';
    document.getElementById('group-chat-modal').style.display = 'flex';
    document.getElementById('gc-message-input').value = '';

    await loadGroupChatMessages(chatId);
}

// Close group chat modal
function closeGroupChatModal() {
    document.getElementById('group-chat-modal').style.display = 'none';
    currentGroupChatId = null;
}

// Load messages for a group chat
async function loadGroupChatMessages(chatId) {
    const container = document.getElementById('gc-messages-container');
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="loading-spinner" style="width: 24px; height: 24px; border: 2px solid #f1f5f9; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
    `;

    try {
        const { data: messages, error } = await window.supabaseClient
            .rpc('get_group_chat_messages', { chat_uuid: chatId, messages_limit: 100 });

        if (error) throw error;

        if (!messages || messages.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div style="font-size: 2rem; margin-bottom: 10px;">💬</div>
                    <div style="font-size: 0.9rem;">No messages yet. Start the conversation!</div>
                </div>
            `;
            return;
        }

        container.innerHTML = messages.map(msg => {
            const isOwn = msg.sender_id === window.currentUser.id;
            const initials = (msg.sender_name || '?').charAt(0).toUpperCase();
            const time = new Date(msg.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            // Win share message
            if (msg.is_win_share) {
                const winDetails = msg.win_details || {};
                const typeConfig = {
                    'workout_complete': { icon: '💪', bg: '#dcfce7' },
                    'personal_best': { icon: '🏆', bg: '#fef3c7' },
                    'milestone': { icon: '🌟', bg: '#e0e7ff' },
                    'custom': { icon: '✨', bg: '#fdf4ff' }
                };
                const config = typeConfig[msg.win_type] || typeConfig.custom;

                return `
                    <div style="display: flex; flex-direction: column; align-items: ${isOwn ? 'flex-end' : 'flex-start'}; margin-bottom: 15px;">
                        ${!isOwn ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; margin-left: 4px;">${escapeHtml(msg.sender_name)}</div>` : ''}
                        <div id="win-card-${msg.message_id}" style="max-width: 85%; background: ${config.bg}; padding: 16px; border-radius: ${isOwn ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; border: 2px solid ${isOwn ? 'var(--primary)' : '#e2e8f0'}; position: relative;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <span style="font-size: 1.6rem;">${config.icon}</span>
                                <span style="font-weight: 700; color: var(--text-main); font-size: 1rem;">Shared a win!</span>
                            </div>
                            <div style="font-size: 1rem; color: var(--text-main); line-height: 1.5; font-weight: 500;">${escapeHtml(msg.message)}</div>
                            ${winDetails.workoutName ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">${escapeHtml(winDetails.workoutName)}</div>` : ''}
                            ${winDetails.improvement ? `<div style="font-size: 0.95rem; font-weight: 700; color: #16a34a; margin-top: 6px; background: rgba(22, 163, 74, 0.1); padding: 4px 10px; border-radius: 6px; display: inline-block;">${escapeHtml(winDetails.improvement)}</div>` : ''}
                            
                            <!-- Internal logo for share capture -->
                            <div class="share-only" style="display: none; margin-top: 15px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 10px; font-size: 0.7rem; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px;">
                                BALANCE
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                            <div style="font-size: 0.7rem; color: #94a3b8;">${time}</div>
                            <button onclick="shareWinCardAsImage('${msg.message_id}')" title="Share card externally" style="background: none; border: none; padding: 4px; cursor: pointer; color: #94a3b8; display: flex; align-items: center; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='#94a3b8'">
                                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor;"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92c0-1.61-1.31-2.92-2.92-2.92z"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }

            // Regular message
            return `
                <div style="display: flex; flex-direction: column; align-items: ${isOwn ? 'flex-end' : 'flex-start'}; margin-bottom: 15px;">
                    ${!isOwn ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; margin-left: 4px;">${escapeHtml(msg.sender_name)}</div>` : ''}
                    <div style="max-width: 85%; background: ${isOwn ? 'var(--primary)' : 'white'}; padding: 12px 16px; border-radius: ${isOwn ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; ${isOwn ? '' : 'border: 1px solid #e2e8f0;'} color: ${isOwn ? 'white' : 'var(--text-main)'};">
                        ${escapeHtml(msg.message)}
                    </div>
                    <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 4px;">${time}</div>
                </div>
            `;
        }).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

    } catch (error) {
        console.error('Error loading messages:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <div style="font-size: 0.9rem;">Failed to load messages</div>
            </div>
        `;
    }
}

// Send message to group chat
async function sendGroupChatMessage() {
    const input = document.getElementById('gc-message-input');
    const message = input.value.trim();

    if (!message || !currentGroupChatId) return;

    input.value = '';

    try {
        const { error } = await window.supabaseClient
            .from('group_chat_messages')
            .insert({
                group_chat_id: currentGroupChatId,
                user_id: window.currentUser.id,
                message: message
            });

        if (error) throw error;

        await loadGroupChatMessages(currentGroupChatId);

    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Failed to send message', 'error');
        input.value = message;
    }
}

// Open create group chat modal
async function openCreateGroupChatModal() {
    document.getElementById('create-group-chat-modal').style.display = 'flex';
    document.getElementById('new-group-name').value = '';
    selectedGroupMembers = [];
    document.getElementById('group-selected-count').textContent = '0';

    // Load friends list
    const container = document.getElementById('group-friends-list');
    container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading friends...</div>`;

    try {
        const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);

        if (!friends || friends.length === 0) {
            container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-muted);">No friends yet. Add friends first!</div>`;
            return;
        }

        container.innerHTML = friends.map(friend => {
            const initials = (friend.friend_name || '?').charAt(0).toUpperCase();
            return `
                <div onclick="toggleGroupMember('${friend.friend_id}', this)" style="display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: background 0.2s;" data-friend-id="${friend.friend_id}">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; overflow: hidden; flex-shrink: 0;">
                        ${friend.friend_photo ? `<img src="${friend.friend_photo}" style="width: 100%; height: 100%; object-fit: cover;">` : initials}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-main);">${escapeHtml(friend.friend_name || 'Friend')}</div>
                    </div>
                    <div class="friend-check" style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid #e2e8f0; display: flex; align-items: center; justify-content: center;">
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading friends:', error);
        container.innerHTML = `<div style="padding: 20px; text-align: center; color: #ef4444;">Failed to load friends</div>`;
    }
}

// Close create group chat modal
function closeCreateGroupChatModal() {
    document.getElementById('create-group-chat-modal').style.display = 'none';
}

// Toggle member selection
function toggleGroupMember(friendId, element) {
    const checkDiv = element.querySelector('.friend-check');
    const index = selectedGroupMembers.indexOf(friendId);

    if (index > -1) {
        selectedGroupMembers.splice(index, 1);
        element.style.background = 'white';
        checkDiv.innerHTML = '';
        checkDiv.style.border = '2px solid #e2e8f0';
    } else {
        selectedGroupMembers.push(friendId);
        element.style.background = '#dcfce7';
        checkDiv.innerHTML = '✓';
        checkDiv.style.border = '2px solid var(--primary)';
        checkDiv.style.color = 'var(--primary)';
        checkDiv.style.fontWeight = '700';
    }

    document.getElementById('group-selected-count').textContent = selectedGroupMembers.length;
}

// Create group chat
async function createGroupChat() {
    const name = document.getElementById('new-group-name').value.trim();

    if (!name) {
        showToast('Please enter a group name', 'error');
        return;
    }

    if (selectedGroupMembers.length === 0) {
        showToast('Please select at least one friend', 'error');
        return;
    }

    const btn = document.getElementById('create-group-btn');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        const { data: chatId, error } = await window.supabaseClient
            .rpc('create_group_chat', {
                creator_uuid: window.currentUser.id,
                chat_name: name,
                member_ids: selectedGroupMembers
            });

        if (error) throw error;

        showToast('Group chat created! 🎉', 'success');
        closeCreateGroupChatModal();
        await loadGroupChats();

        // Open the new chat
        if (chatId) {
            openGroupChat(chatId, name, '');
        }

    } catch (error) {
        console.error('Error creating group chat:', error);
        showToast('Failed to create group chat', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create Group';
    }
}

// Open share win modal (from within group chat)
function openShareWinInChat() {
    if (!currentGroupChatId) {
        showToast('Please open a group chat first', 'error');
        return;
    }
    // Check for pending win share data from workout completion
    if (window.pendingWinShare) {
        openShareWinModal(window.pendingWinShare);
        window.pendingWinShare = null;
    } else {
        openShareWinModal();
    }
}

// Open share win modal
function openShareWinModal(prefillData = null) {
    document.getElementById('share-win-modal').style.display = 'flex';

    // Reset form
    selectedWinType = 'workout_complete';
    document.getElementById('win-message-input').value = '';
    document.getElementById('win-workout-name').value = '';
    document.getElementById('win-improvement').value = '';

    // Reset type buttons
    document.querySelectorAll('.win-type-btn').forEach(btn => {
        btn.style.border = '2px solid transparent';
        btn.style.background = '#f1f5f9';
    });
    document.getElementById('win-type-workout').style.border = '2px solid var(--primary)';
    document.getElementById('win-type-workout').style.background = '#dcfce7';

    // Prefill data if provided
    if (prefillData) {
        selectedWinType = prefillData.type || 'workout_complete';
        selectWinType(selectedWinType);

        if (prefillData.workoutName) {
            document.getElementById('win-workout-name').value = prefillData.workoutName;
        }
        if (prefillData.message) {
            document.getElementById('win-message-input').value = prefillData.message;
        }
        if (prefillData.improvement) {
            document.getElementById('win-improvement').value = prefillData.improvement;
        }
    }
}

// Close share win modal
function closeShareWinModal() {
    document.getElementById('share-win-modal').style.display = 'none';
}

// Select win type
function selectWinType(type) {
    selectedWinType = type;

    document.querySelectorAll('.win-type-btn').forEach(btn => {
        btn.style.border = '2px solid transparent';
        btn.style.background = '#f1f5f9';
    });

    const buttonMap = {
        'workout_complete': 'win-type-workout',
        'personal_best': 'win-type-pb',
        'milestone': 'win-type-milestone',
        'custom': 'win-type-custom'
    };

    const selectedBtn = document.getElementById(buttonMap[type]);
    if (selectedBtn) {
        selectedBtn.style.border = '2px solid var(--primary)';
        selectedBtn.style.background = '#dcfce7';
    }
}

// Set quick message
function setWinMessage(message) {
    document.getElementById('win-message-input').value = message;
}

// Send win to chat
async function sendWinToChat() {
    const message = document.getElementById('win-message-input').value.trim();

    if (!message) {
        showToast('Please enter a message', 'error');
        return;
    }

    if (!currentGroupChatId) {
        showToast('Please open a group chat first', 'error');
        closeShareWinModal();
        return;
    }

    const submitBtn = document.getElementById('submit-win-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;"></span>';

    try {
        const winDetails = {
            workoutName: document.getElementById('win-workout-name').value.trim() || null,
            improvement: document.getElementById('win-improvement').value.trim() || null
        };

        const { error } = await window.supabaseClient
            .from('group_chat_messages')
            .insert({
                group_chat_id: currentGroupChatId,
                user_id: window.currentUser.id,
                message: message,
                is_win_share: true,
                win_type: selectedWinType,
                win_details: winDetails
            });

        if (error) throw error;

        showToast('Win shared! 🎉', 'success');
        closeShareWinModal();
        await loadGroupChatMessages(currentGroupChatId);

    } catch (error) {
        console.error('Error sharing win:', error);
        showToast('Failed to share win', 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>Share to Group</span><span style="font-size: 1.1rem;">🎉</span>';
    }
}

// Share win externally (from modal)
async function shareWinExternally() {
    const message = document.getElementById('win-message-input').value.trim();
    if (!message) {
        showToast('Please enter a message first', 'error');
        return;
    }

    const shareBtn = document.getElementById('external-win-share-btn');
    const originalContent = shareBtn.innerHTML;
    shareBtn.disabled = true;
    shareBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>';

    try {
        const winDetails = {
            workoutName: document.getElementById('win-workout-name').value.trim() || null,
            improvement: document.getElementById('win-improvement').value.trim() || null
        };

        const configMap = {
            'workout_complete': { icon: '💪', bg: '#dcfce7' },
            'personal_best': { icon: '🏆', bg: '#fef3c7' },
            'milestone': { icon: '🌟', bg: '#e0e7ff' },
            'custom': { icon: '✨', bg: '#fdf4ff' }
        };
        const config = configMap[selectedWinType] || configMap.custom;

        // Create a temporary element for the card capture
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'fixed';
        tempDiv.style.left = '-9999px';
        tempDiv.style.top = '0';
        tempDiv.innerHTML = `
            <div id="temp-share-card" style="width: 320px; background: ${config.bg}; padding: 24px; border-radius: 20px; border: 2px solid var(--primary); font-family: 'Inter', sans-serif;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                    <span style="font-size: 2rem;">${config.icon}</span>
                    <span style="font-weight: 800; color: #1a202c; font-size: 1.2rem; letter-spacing: -0.5px;">Shared a win!</span>
                </div>
                <div style="font-size: 1.1rem; color: #2d3748; line-height: 1.6; font-weight: 500; margin-bottom: 12px;">${escapeHtml(message)}</div>
                ${winDetails.workoutName ? `<div style="font-size: 0.9rem; color: #718096; margin-bottom: 8px;">${escapeHtml(winDetails.workoutName)}</div>` : ''}
                ${winDetails.improvement ? `<div style="font-size: 1rem; font-weight: 800; color: #16a34a; background: rgba(22, 163, 74, 0.1); padding: 6px 12px; border-radius: 8px; display: inline-block;">${escapeHtml(winDetails.improvement)}</div>` : ''}
                
                <div style="margin-top: 20px; border-top: 1px solid rgba(0,0,0,0.08); padding-top: 15px; display: flex; align-items: center; gap: 10px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.8rem;">
                        ${window.currentUser?.user_metadata?.name?.charAt(0) || 'U'}
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; font-weight: 700; color: #1a202c;">${window.currentUser?.user_metadata?.name || 'Power User'}</div>
                        <div style="font-size: 0.65rem; color: #a0aec0; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">BALANCE</div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(tempDiv);

        const card = document.getElementById('temp-share-card');
        const canvas = await html2canvas(card, {
            backgroundColor: null,
            scale: 3,
            logging: false,
            useCORS: true
        });

        const dataUrl = canvas.toDataURL('image/png');
        document.body.removeChild(tempDiv);

        // Share the image
        const blob = await (await fetch(dataUrl)).blob();
        const file = new File([blob], 'my-win-card.png', { type: 'image/png' });

        if (navigator.share) {
            await navigator.share({
                files: [file],
                title: 'My Win on Balance!',
                text: 'Check out my progress! 💪'
            });
        } else {
            // Fallback download
            const link = document.createElement('a');
            link.download = 'my-win-card.png';
            link.href = dataUrl;
            link.click();
            showToast('Card saved! You can now share it to Messenger.', 'success');
        }

    } catch (err) {
        console.error('Error sharing externally:', err);
        showToast('Failed to generate card visual', 'error');
    } finally {
        shareBtn.disabled = false;
        shareBtn.innerHTML = originalContent;
    }
}

// Share an existing card from chat
async function shareWinCardAsImage(messageId) {
    const cardElement = document.getElementById(`win-card-${messageId}`);
    if (!cardElement) return;

    // Temporarily show the logo tag for the capture
    const logoTag = cardElement.querySelector('.share-only');
    if (logoTag) logoTag.style.display = 'block';

    try {
        const canvas = await html2canvas(cardElement, {
            backgroundColor: null,
            scale: 3,
            logging: false,
            useCORS: true,
            onclone: (clonedDoc) => {
                // Ensure the logo tag is visible in the clone
                const clonedCard = clonedDoc.getElementById(`win-card-${messageId}`);
                const clonedLogo = clonedCard.querySelector('.share-only');
                if (clonedLogo) clonedLogo.style.display = 'block';
            }
        });

        const dataUrl = canvas.toDataURL('image/png');
        if (logoTag) logoTag.style.display = 'none';

        const blob = await (await fetch(dataUrl)).blob();
        const file = new File([blob], 'win-card.png', { type: 'image/png' });

        if (navigator.share) {
            await navigator.share({
                files: [file],
                title: 'Check out my win!',
                text: 'Shared from Balance 💪'
            });
        } else {
            const link = document.createElement('a');
            link.download = 'win-card.png';
            link.href = dataUrl;
            link.click();
            showToast('Card saved to your device!', 'success');
        }
    } catch (err) {
        console.error('Error sharing card:', err);
        showToast('Failed to capture card', 'error');
        if (logoTag) logoTag.style.display = 'none';
    }
}

// ============================================================
// CHALLENGES FUNCTIONS
// ============================================================

let currentChallengeId = null;
let challengeChart = null;

// Load user's challenges
// Load challenges for home screen (compact version)
async function loadHomeChallenges() {
    const container = document.getElementById('home-challenges-list');
    const emptyState = document.getElementById('home-challenges-empty');

    if (!container || !window.currentUser) return;

    try {
        const { data: challenges, error } = await window.supabaseClient
            .rpc('get_user_challenges', { user_uuid: window.currentUser.id });

        if (error) throw error;

        // Filter active challenges and pending invites
        const activeChallenges = (challenges || []).filter(c =>
            c.status === 'active' && c.user_status === 'accepted'
        );
        const pendingInvites = (challenges || []).filter(c => c.user_status === 'invited');

        if (activeChallenges.length === 0 && pendingInvites.length === 0) {
            if (emptyState) emptyState.style.display = 'block';
            container.innerHTML = '';
            return;
        }

        if (emptyState) emptyState.style.display = 'none';

        let html = '';

        // Show pending invites first — fetch extra details (entry_fee, rare_reward_id) per challenge
        if (pendingInvites.length > 0) {
            // Batch fetch challenge details for invite cards
            const challengeIds = pendingInvites.map(c => c.challenge_id);
            let challengeDetails = {};
            try {
                const { data: details } = await window.supabaseClient
                    .from('challenges')
                    .select('id, entry_fee, rare_reward_id')
                    .in('id', challengeIds);
                if (details) {
                    details.forEach(d => challengeDetails[d.id] = d);
                }
            } catch (e) { console.warn('Could not fetch challenge details for invites:', e); }

            html += pendingInvites.map(challenge => {
                const detail = challengeDetails[challenge.challenge_id] || {};
                const entryFee = detail.entry_fee || 1000;
                const rareId = detail.rare_reward_id;
                const rare = rareId && typeof RARE_COLLECTION !== 'undefined' ? RARE_COLLECTION.find(r => r.id === rareId) : null;
                const tierData = rare ? (RARE_TIERS[rare.tier] || RARE_TIERS.COMMON) : null;

                return `
                <div class="card" style="border-left: 5px solid #7c3aed; margin-bottom: 10px;">
                    <div class="card-body" style="max-height: none; padding: 16px; opacity: 1;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="background: linear-gradient(135deg, rgba(124,58,237,0.15), rgba(99,102,241,0.15)); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                ${rare ? rare.emoji : '🎯'}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                                    <span style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">${challenge.challenge_name}</span>
                                    <span style="background: rgba(124,58,237,0.1); color: #7c3aed; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 600;">INVITE</span>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">
                                    from ${challenge.creator_name} · 👥 ${challenge.participant_count} joined
                                </div>
                                <div style="font-size: 0.75rem; color: #7c3aed; font-weight: 600; margin-top: 2px;">
                                    🪙 ${entryFee.toLocaleString()} entry · 2x XP · ${rare ? rare.emoji + ' Win ' + rare.name : 'Win rare drops'}
                                </div>
                                ${tierData ? `<span style="display: inline-block; margin-top: 3px; padding: 1px 6px; border-radius: 3px; font-size: 0.55rem; font-weight: 800; background: ${tierData.gradient}; color: white;">${tierData.label}</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button onclick="acceptChallengeInvite('${challenge.challenge_id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #7c3aed, #6366f1); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">🪙 Join (${entryFee.toLocaleString()})</button>
                            <button onclick="declineChallengeInvite('${challenge.challenge_id}')" style="flex: 1; padding: 10px; background: #f1f5f9; color: var(--text-muted); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">Decline</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Show active challenges
        html += activeChallenges.slice(0, 3).map(challenge => `
            <div class="card" onclick="openChallengeLeaderboard('${challenge.challenge_id}')" style="cursor: pointer; border-left: 5px solid #7c3aed; margin-bottom: 10px;">
                <div class="card-body" style="max-height: none; padding: 16px; opacity: 1;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="background: linear-gradient(135deg, rgba(124,58,237,0.15), rgba(99,102,241,0.15)); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 700; color: #7c3aed;">
                            #${challenge.user_rank}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: var(--text-main); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${challenge.challenge_name}</div>
                            <div style="display: flex; gap: 12px; font-size: 0.8rem; color: var(--text-muted);">
                                <span>⏱️ ${challenge.days_remaining}d left</span>
                                <span>👥 ${challenge.participant_count}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: #7c3aed;">${challenge.user_points}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">pts</div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        container.innerHTML = html;

    } catch (error) {
        console.error('Error loading home challenges:', error);
    }
}

async function loadChallenges() {
    const container = document.getElementById('challenges-container');
    const emptyState = document.getElementById('challenges-empty');

    if (!container || !window.currentUser) return;

    try {
        const { data: challenges, error } = await window.supabaseClient
            .rpc('get_user_challenges', { user_uuid: window.currentUser.id });

        if (error) throw error;

        if (!challenges || challenges.length === 0) {
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        if (emptyState) emptyState.style.display = 'none';

        container.innerHTML = challenges.map(challenge => {
            const isInvited = challenge.user_status === 'invited';
            const statusBadge = isInvited
                ? '<span style="background: rgba(124,58,237,0.1); color: #7c3aed; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">INVITED</span>'
                : challenge.status === 'active'
                ? '<span style="background: rgba(124,58,237,0.1); color: #7c3aed; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">ACTIVE</span>'
                : '<span style="background: #e0e7ff; color: #4f46e5; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">PENDING</span>';

            return `
                <div style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #f1f5f9; border-left: 5px solid #7c3aed;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">${challenge.challenge_name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">by ${challenge.creator_name}</div>
                        </div>
                        ${statusBadge}
                    </div>
                    <div style="display: flex; gap: 15px; margin-bottom: 12px; font-size: 0.85rem; color: var(--text-muted);">
                        <div>👥 ${challenge.participant_count} participants</div>
                        <div>⏱️ ${challenge.days_remaining} days left</div>
                    </div>
                    ${!isInvited && challenge.status === 'active' ? `
                    <div style="background: #f8fafc; border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Your Position</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #7c3aed;">#${challenge.user_rank}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Your Points</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-main);">${challenge.user_points}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Leader</div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: #7c3aed;">${challenge.leader_name} (${challenge.leader_points})</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    <div style="display: flex; gap: 8px;">
                        ${isInvited ? `
                            <button onclick="acceptChallengeInvite('${challenge.challenge_id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #7c3aed, #6366f1); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">🪙 Join Challenge</button>
                            <button onclick="declineChallengeInvite('${challenge.challenge_id}')" style="flex: 1; padding: 10px; background: #f1f5f9; color: var(--text-muted); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Decline</button>
                        ` : `
                            <button onclick="openChallengeLeaderboard('${challenge.challenge_id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #7c3aed, #6366f1); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">View Leaderboard</button>
                        `}
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading challenges:', error);
    }
}

// Open create challenge modal (optionally with a featured rare)
function openCreateChallengeModal(featuredRareId = null) {
    const modal = document.getElementById('create-challenge-modal');
    if (!modal) return;

    // Store featured rare context
    window._challengeFeaturedRare = featuredRareId;

    const rarePreview = document.getElementById('challenge-rare-preview');
    const randomDropInfo = document.getElementById('challenge-random-drop-info');
    const headerTitle = modal.querySelector('h3');
    const wagerSection = document.getElementById('challenge-wager-section');
    const feeSection = document.getElementById('challenge-fee-section');

    if (featuredRareId) {
        // Featured rare challenge mode
        const rare = RARE_COLLECTION.find(r => r.id === featuredRareId);
        if (rare) {
            const tierData = RARE_TIERS[rare.tier];
            // Show 3D preview
            if (rarePreview) {
                rarePreview.style.display = 'block';
                const viewer = document.getElementById('challenge-rare-viewer');
                if (viewer) viewer.setAttribute('src', rare.model);
                const nameEl = document.getElementById('challenge-rare-name');
                if (nameEl) nameEl.textContent = rare.name;
                const badgeEl = document.getElementById('challenge-rare-tier-badge');
                if (badgeEl) {
                    badgeEl.textContent = tierData.label;
                    badgeEl.style.background = tierData.gradient;
                }
            }
            // Hide random drop info
            if (randomDropInfo) randomDropInfo.style.display = 'none';
            // Lock wager to tier buy-in
            if (wagerSection) wagerSection.style.display = 'none';
            createChallengeBetAmount = tierData.buyIn;
            // Update fee display
            const feeDisplay = document.getElementById('create-challenge-fee-display');
            if (feeDisplay) feeDisplay.textContent = tierData.buyIn.toLocaleString() + ' Coins entry fee';
            // Update header
            if (headerTitle) {
                headerTitle.innerHTML = `${rare.emoji} Featured Rare Challenge`;
                headerTitle.style.color = tierData.color;
            }
        }
    } else {
        // Generic challenge mode
        if (rarePreview) rarePreview.style.display = 'none';
        if (randomDropInfo) randomDropInfo.style.display = 'block';
        if (wagerSection) wagerSection.style.display = 'block';
        // Reset wager to default
        createChallengeBetAmount = 1000;
        const feeDisplay = document.getElementById('create-challenge-fee-display');
        if (feeDisplay) feeDisplay.textContent = '10,000 Coins entry fee';
        // Reset header
        if (headerTitle) {
            headerTitle.innerHTML = '🏆 Create Challenge';
            headerTitle.style.color = '#60a5fa';
        }
        // Reset wager buttons
        document.querySelectorAll('.create-challenge-bet-btn').forEach((b, i) => {
            if (i === 0) {
                b.style.background = 'rgba(255,255,255,0.15)';
                b.style.borderColor = 'rgba(255,255,255,0.3)';
                b.classList.add('active');
            } else {
                b.style.background = 'rgba(255,255,255,0.08)';
                b.style.borderColor = 'rgba(255,255,255,0.15)';
                b.classList.remove('active');
            }
        });
    }

    modal.style.display = 'flex';
    loadFriendsForChallenge();
    // Set default start date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('challenge-start-date').value = tomorrow.toISOString().split('T')[0];
}

// Close create challenge modal
function closeCreateChallengeModal() {
    const modal = document.getElementById('create-challenge-modal');
    if (modal) modal.style.display = 'none';
}

// Load friends for challenge selection
async function loadFriendsForChallenge() {
    const container = document.getElementById('challenge-friends-list');
    if (!container || !window.currentUser) return;

    try {
        const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);

        if (!friends || friends.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No friends yet. Add friends first!</div>';
            return;
        }

        container.innerHTML = friends.map(friend => {
            const initials = (friend.friend_name || '?').charAt(0).toUpperCase();
            return `
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.08); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='transparent'">
                    <input type="checkbox" class="challenge-friend-checkbox" value="${friend.friend_id}" style="width: 18px; height: 18px; accent-color: #60a5fa;">
                    <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, rgba(96,165,250,0.4), rgba(59,130,246,0.4)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem; overflow: hidden;">
                        ${friend.friend_photo ? `<img src="${friend.friend_photo}" style="width: 100%; height: 100%; object-fit: cover;">` : initials}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: white; font-size: 0.9rem;">${friend.friend_name}</div>
                        ${friend.current_streak > 0 ? `<div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">🔥 ${friend.current_streak}</div>` : ''}
                    </div>
                </label>
            `;
        }).join('');

        // Update selected count on change
        container.querySelectorAll('.challenge-friend-checkbox').forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });

    } catch (error) {
        console.error('Error loading friends for challenge:', error);
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Failed to load friends</div>';
    }
}

// Update selected friends count
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.challenge-friend-checkbox:checked');
    const countEl = document.getElementById('challenge-selected-count');
    if (countEl) countEl.textContent = checkboxes.length;
}

// Create challenge bet amount (for the create modal)
let createChallengeBetAmount = 1000;

window._setCreateChallengeBet = function(amount, btnEl) {
    if (amount < CHALLENGE_MIN_BET && amount !== 0) {
        amount = CHALLENGE_MIN_BET;
    }
    createChallengeBetAmount = Math.max(amount, CHALLENGE_MIN_BET);

    // Update active button styling (dark theme)
    if (btnEl) {
        document.querySelectorAll('.create-challenge-bet-btn').forEach(b => {
            b.style.background = 'rgba(255,255,255,0.08)';
            b.style.color = 'white';
            b.style.borderColor = 'rgba(255,255,255,0.15)';
            b.classList.remove('active');
        });
        btnEl.style.background = 'rgba(255,255,255,0.15)';
        btnEl.style.color = 'white';
        btnEl.style.borderColor = 'rgba(255,255,255,0.3)';
        btnEl.classList.add('active');
        // Clear custom input
        const customInput = document.getElementById('create-challenge-custom-bet');
        if (customInput) customInput.value = '';
    } else {
        // Custom input used - deactivate all preset buttons
        document.querySelectorAll('.create-challenge-bet-btn').forEach(b => {
            b.style.background = 'rgba(255,255,255,0.08)';
            b.style.color = 'white';
            b.style.borderColor = 'rgba(255,255,255,0.15)';
            b.classList.remove('active');
        });
    }

    // Update fee display
    const feeDisplay = document.getElementById('create-challenge-fee-display');
    if (feeDisplay) {
        feeDisplay.textContent = createChallengeBetAmount.toLocaleString() + ' Coins entry fee';
    }

    // Update create button
    const createBtn = document.getElementById('create-challenge-btn');
    if (createBtn && !createBtn.disabled) {
        createBtn.textContent = 'Create Challenge';
    }
};

// Create a new challenge (with coin buy-in for creator)
async function createChallenge() {
    const nameInput = document.getElementById('challenge-name-input');
    const durationSelect = document.getElementById('challenge-duration-select');
    const startDateInput = document.getElementById('challenge-start-date');
    const selectedFriends = document.querySelectorAll('.challenge-friend-checkbox:checked');

    const name = nameInput?.value.trim();
    const duration = 30; // Fixed 30-day duration
    const startDate = startDateInput?.value;

    if (!name) {
        alert('Please enter a challenge name');
        return;
    }

    if (selectedFriends.length === 0) {
        alert('Please select at least one friend to challenge');
        return;
    }

    if (!startDate) {
        alert('Please select a start date');
        return;
    }

    const btn = document.getElementById('create-challenge-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Creating...';
    }

    try {
        // Validate and get bet amount FIRST (before any DB writes)
        const betAmount = createChallengeBetAmount;
        if (betAmount < 10000) {
            alert('Minimum bet is 10,000 coins.');
            if (btn) { btn.disabled = false; btn.textContent = 'Create Challenge'; }
            return;
        }

        // Debit coins from creator FIRST (before creating anything)
        const { data: newBalance, error: coinError } = await window.supabaseClient
            .rpc('debit_coins', {
                user_uuid: window.currentUser.id,
                coin_amount: betAmount,
                txn_type: 'challenge_entry',
                txn_description: 'Created challenge: ' + name + ' (' + betAmount.toLocaleString() + ' coins)'
            });

        if (coinError) throw coinError;

        if (newBalance === -1) {
            alert('Not enough coins! You need ' + betAmount.toLocaleString() + ' coins to create a challenge.');
            if (typeof openCoinShop === 'function') openCoinShop();
            if (btn) { btn.disabled = false; btn.textContent = 'Create Challenge'; }
            return;
        }

        updateCoinBalanceDisplay(newBalance);

        // Calculate end date
        const start = new Date(startDate);
        const end = new Date(start);
        end.setDate(end.getDate() + duration);

        // Determine rare reward: featured = guaranteed specific, generic = random weighted
        let rareRewardId = null;
        if (window._challengeFeaturedRare) {
            rareRewardId = window._challengeFeaturedRare;
        } else {
            const randomDrop = getRandomRareDrop();
            if (randomDrop) rareRewardId = randomDrop.id;
        }

        // Create challenge (with entry_fee so accepters know the amount)
        const challengeInsert = {
            name: name,
            creator_id: window.currentUser.id,
            start_date: startDate,
            end_date: end.toISOString().split('T')[0],
            duration_days: duration,
            status: 'pending',
            entry_fee: betAmount
        };
        if (rareRewardId) challengeInsert.rare_reward_id = rareRewardId;

        const { data: challenge, error: createError } = await window.supabaseClient
            .from('challenges')
            .insert(challengeInsert)
            .select()
            .single();

        if (createError) throw createError;

        // Add creator as participant
        const { data: userPoints } = await window.supabaseClient
            .from('user_points')
            .select('current_points')
            .eq('user_id', window.currentUser.id)
            .maybeSingle();

        const currentPoints = userPoints?.current_points || 0;

        await window.supabaseClient
            .from('challenge_participants')
            .insert({
                challenge_id: challenge.id,
                user_id: window.currentUser.id,
                status: 'accepted',
                accepted_at: new Date().toISOString(),
                starting_points: currentPoints,
                current_points: currentPoints,
                challenge_points: 0,
                has_paid: true,
                paid_at: new Date().toISOString()
            });

        // Invite selected friends
        const friendIds = Array.from(selectedFriends).map(cb => cb.value);
        const invites = friendIds.map(friendId => ({
            challenge_id: challenge.id,
            user_id: friendId,
            status: 'invited'
        }));

        const { error: inviteError } = await window.supabaseClient
            .from('challenge_participants')
            .insert(invites);

        if (inviteError) throw inviteError;

        // Send nudge notification to each invited friend
        const creatorName = window.currentUser?.user_metadata?.name || window.currentUser?.email || 'Someone';
        const rareInfo = rareRewardId ? RARE_COLLECTION.find(r => r.id === rareRewardId) : null;
        const nudgeMessage = rareInfo
            ? `⚔️ CHALLENGE! ${creatorName} challenged you to "${name}" — win ${rareInfo.emoji} ${rareInfo.name}! 🪙 ${betAmount.toLocaleString()} entry`
            : `⚔️ CHALLENGE! ${creatorName} challenged you to "${name}"! 🪙 ${betAmount.toLocaleString()} entry`;

        for (const friendId of friendIds) {
            try {
                await window.supabaseClient
                    .from('nudges')
                    .insert({
                        sender_id: window.currentUser.id,
                        receiver_id: friendId,
                        message: nudgeMessage,
                        nudge_type: 'challenge_invite'
                    });
            } catch (nudgeErr) {
                console.warn('Failed to send nudge to', friendId, nudgeErr);
            }
        }

        closeCreateChallengeModal();
        if (typeof loadHomeChallenges === 'function') loadHomeChallenges();
        showToast('Challenge created! Invitations sent.', 'success');
        try { if (typeof checkChallengeBadges === 'function') checkChallengeBadges(); } catch(e) {}

    } catch (error) {
        console.error('Error creating challenge:', error);
        alert('Failed to create challenge: ' + (error.message || 'Please try again'));
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'Create Challenge';
        }
    }
}

// Store pending challenge ID for buy-in modal
let pendingChallengeId = null;

// Accept challenge invitation - always requires payment
async function acceptChallengeInvite(challengeId) {
    pendingChallengeId = challengeId;

    // Fetch the challenge to get the entry_fee and rare_reward_id
    try {
        const { data: challenge } = await window.supabaseClient
            .from('challenges')
            .select('entry_fee, rare_reward_id, name')
            .eq('id', challengeId)
            .single();

        if (challenge) {
            window._pendingChallengeEntryFee = challenge.entry_fee || 10000;
            window._pendingChallengeRareId = challenge.rare_reward_id || null;
            window._pendingChallengeName = challenge.name || 'Challenge';
        } else {
            window._pendingChallengeEntryFee = 10000;
            window._pendingChallengeRareId = null;
            window._pendingChallengeName = 'Challenge';
        }
    } catch (e) {
        console.warn('Could not fetch challenge details:', e);
        window._pendingChallengeEntryFee = 10000;
        window._pendingChallengeRareId = null;
        window._pendingChallengeName = 'Challenge';
    }

    // Show the buy-in payment modal locked to the creator's entry fee
    showChallengePassModal(window._pendingChallengeEntryFee, window._pendingChallengeRareId);
}

// Actually accept the challenge
async function doAcceptChallenge(challengeId) {
    try {
        const { data, error } = await window.supabaseClient
            .rpc('accept_challenge_invitation', {
                challenge_uuid: challengeId,
                user_uuid: window.currentUser.id
            });

        if (error) throw error;

        // Refresh challenges on home screen
        if (typeof loadHomeChallenges === 'function') loadHomeChallenges();
        alert('Challenge accepted! Good luck!');

    } catch (error) {
        console.error('Error accepting challenge:', error);
        alert('Failed to accept challenge');
    }
}

// Show challenge buy-in modal (locked to the challenge's entry fee)
function showChallengePassModal(lockedEntryFee, rareRewardId) {
    const modal = document.getElementById('challenge-pass-modal');
    if (!modal) return;

    const entryFee = lockedEntryFee || 10000;
    currentChallengeBet = entryFee;

    const joinBtn = document.getElementById('buy-challenge-pass-btn');
    if (joinBtn) joinBtn.innerHTML = 'Spend 🪙 ' + entryFee.toLocaleString() + ' Coins &amp; Join';

    // Hide the wager picker entirely — accepter must match creator's entry fee
    const betPicker = modal.querySelector('.challenge-bet-picker');
    if (betPicker) betPicker.style.display = 'none';
    const customInput = document.getElementById('challenge-custom-bet');
    if (customInput) customInput.parentElement.style.display = 'none';

    // Show the locked entry fee info
    const feeInfo = document.getElementById('challenge-pass-fee-info');
    if (feeInfo) {
        feeInfo.textContent = '🪙 ' + entryFee.toLocaleString() + ' Coins entry fee';
    }

    // Show rare reward info if available
    const rareInfoEl = document.getElementById('challenge-pass-rare-info');
    if (rareInfoEl) {
        if (rareRewardId && typeof RARE_COLLECTION !== 'undefined') {
            const rare = RARE_COLLECTION.find(r => r.id === rareRewardId);
            if (rare) {
                const tierData = RARE_TIERS[rare.tier] || RARE_TIERS.COMMON;
                rareInfoEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.2); border-radius: 12px; padding: 10px 14px; margin-bottom: 12px;">
                        <span style="font-size: 1.5rem;">${rare.emoji}</span>
                        <div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700;">Win This Rare</div>
                            <div style="font-weight: 700; color: var(--text-main);">${rare.name} <span style="padding: 1px 6px; border-radius: 4px; font-size: 0.55rem; font-weight: 800; background: ${tierData.gradient}; color: white;">${tierData.label}</span></div>
                        </div>
                    </div>
                `;
                rareInfoEl.style.display = 'block';
            } else {
                rareInfoEl.style.display = 'none';
            }
        } else {
            rareInfoEl.style.display = 'none';
        }
    }

    modal.style.display = 'flex';
    loadCoinBalance();
}

// Close challenge pass modal
function closeChallengePassModal() {
    const modal = document.getElementById('challenge-pass-modal');
    if (modal) {
        modal.style.display = 'none';
    }
    pendingChallengeId = null;
}

// Spend coins to join a challenge (minimum 1,000 coins)
const CHALLENGE_MIN_BET = 1000;
let currentChallengeBet = CHALLENGE_MIN_BET;

// Set challenge bet amount from join modal picker
window._setChallengeBet = function(amount, btnEl) {
    if (amount < CHALLENGE_MIN_BET && amount !== 0) {
        amount = CHALLENGE_MIN_BET;
    }
    currentChallengeBet = Math.max(amount, CHALLENGE_MIN_BET);

    // Update active button styling
    if (btnEl) {
        document.querySelectorAll('#challenge-pass-modal .challenge-bet-btn').forEach(b => {
            b.classList.remove('active');
        });
        btnEl.classList.add('active');
        // Clear custom input when a preset button is clicked
        const customInput = document.getElementById('challenge-custom-bet');
        if (customInput) customInput.value = '';
    } else {
        // Custom input was used, deactivate all preset buttons
        document.querySelectorAll('#challenge-pass-modal .challenge-bet-btn').forEach(b => {
            b.classList.remove('active');
        });
    }

    // Update join button text
    const joinBtn = document.getElementById('buy-challenge-pass-btn');
    if (joinBtn) {
        joinBtn.innerHTML = 'Spend 🪙 ' + currentChallengeBet.toLocaleString() + ' Coins &amp; Join';
    }
};

async function spendCoinsToJoinChallenge() {
    const challengeId = pendingChallengeId;
    if (!challengeId) {
        alert('No challenge selected');
        return;
    }

    const betAmount = currentChallengeBet;
    if (betAmount < CHALLENGE_MIN_BET) {
        alert('Minimum bet is ' + CHALLENGE_MIN_BET.toLocaleString() + ' coins.');
        return;
    }

    const btn = document.getElementById('buy-challenge-pass-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Joining...';
    }

    try {
        // Debit coins via RPC
        const { data: newBalance, error } = await window.supabaseClient
            .rpc('debit_coins', {
                user_uuid: window.currentUser.id,
                coin_amount: betAmount,
                txn_type: 'challenge_entry',
                txn_description: 'Challenge entry fee (' + betAmount.toLocaleString() + ' coins)',
                txn_reference: challengeId
            });

        if (error) throw error;

        if (newBalance === -1) {
            alert('Not enough coins! You need ' + betAmount.toLocaleString() + ' coins to enter.');
            closeChallengePassModal();
            openCoinShop();
            return;
        }

        // Update displayed balance
        updateCoinBalanceDisplay(newBalance);

        // Close modal and accept challenge
        closeChallengePassModal();
        await doAcceptChallenge(challengeId);

        // Mark as paid on the participant record
        try {
            await window.supabaseClient
                .from('challenge_participants')
                .update({ has_paid: true, paid_at: new Date().toISOString() })
                .eq('challenge_id', challengeId)
                .eq('user_id', window.currentUser.id);
        } catch (e) { console.warn('Could not update has_paid:', e); }

        pendingChallengeId = null;

    } catch (error) {
        console.error('Error spending coins for challenge:', error);
        alert('Failed to join challenge. Please try again.');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'Spend 🪙 ' + betAmount.toLocaleString() + ' Coins &amp; Join';
        }
    }
}

// Coin balance management
async function loadCoinBalance() {
    if (!window.supabaseClient || !window.currentUser) return 0;
    try {
        const { data, error } = await window.supabaseClient
            .rpc('get_coin_balance', { user_uuid: window.currentUser.id });
        if (error) throw error;
        const balance = data || 0;
        updateCoinBalanceDisplay(balance);
        return balance;
    } catch (e) {
        console.error('Error loading coin balance:', e);
        return 0;
    }
}

function updateCoinBalanceDisplay(balance) {
    const displays = ['coin-balance-display', 'coin-shop-balance', 'challenge-modal-coin-balance'];
    displays.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = balance.toLocaleString();
    });
    // Sync all header coin widgets
    document.querySelectorAll('.coin-balance-sync').forEach(el => {
        el.textContent = balance.toLocaleString();
    });
}

// Coin shop functions
function openCoinShop() {
    const modal = document.getElementById('coin-shop-modal');
    if (modal) {
        modal.style.display = 'flex';
        loadCoinBalance();
        // Show "Restore Purchases" button on native platforms (required by Apple)
        const restoreRow = document.getElementById('restore-purchases-row');
        if (restoreRow && window.Platform && window.Platform.isNative()) {
            restoreRow.style.display = 'block';
        }
    }
}

// Restore purchases (Apple requires this)
async function restoreIAPPurchases() {
    if (!window.NativeIAP) return;
    try {
        showToast('Restoring purchases...', 'info');
        const result = await window.NativeIAP.restorePurchases();
        const count = result?.purchases?.length || 0;
        showToast(count > 0 ? count + ' purchase(s) restored!' : 'No purchases to restore.', count > 0 ? 'success' : 'info');
    } catch (err) {
        console.error('Restore failed:', err);
        alert('Failed to restore purchases. Please try again.');
    }
}

function closeCoinShop() {
    const modal = document.getElementById('coin-shop-modal');
    if (modal) modal.style.display = 'none';
}

async function buyCoinPack(packId) {
    try {
        // Native app (App Store / Play Store): use IAP
        if (window.Platform && window.Platform.isNative()) {
            const result = await purchaseCoinPack(packId);
            if (result && result.cancelled) return;
            return;
        }

        // Web (website): use Stripe
        const response = await fetch('/.netlify/functions/create-coin-pack-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: window.currentUser.id,
                email: window.currentUser.email,
                packId: packId
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        const { error } = await window.stripe.redirectToCheckout({
            sessionId: data.sessionId
        });
        if (error) throw error;

    } catch (error) {
        console.error('Error buying coin pack:', error);
        alert('Failed to start checkout. Please try again.');
    }
}

// Decline challenge invitation
async function declineChallengeInvite(challengeId) {
    if (!confirm('Are you sure you want to decline this challenge?')) return;

    try {
        const { error } = await window.supabaseClient
            .from('challenge_participants')
            .update({ status: 'declined' })
            .eq('challenge_id', challengeId)
            .eq('user_id', window.currentUser.id);

        if (error) throw error;

        // Refresh challenges on home screen
        if (typeof loadHomeChallenges === 'function') loadHomeChallenges();

    } catch (error) {
        console.error('Error declining challenge:', error);
    }
}

// Open challenge leaderboard
async function openChallengeLeaderboard(challengeId) {
    currentChallengeId = challengeId;
    const modal = document.getElementById('challenge-leaderboard-modal');
    if (!modal) return;

    modal.style.display = 'block';

    try {
        // Get challenge details
        const { data: challenge } = await window.supabaseClient
            .from('challenges')
            .select('*')
            .eq('id', challengeId)
            .single();

        if (challenge) {
            document.getElementById('challenge-leaderboard-title').textContent = challenge.name;
            const endDate = new Date(challenge.end_date);
            const now = new Date();
            const daysRemaining = Math.max(0, Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)));

            if (challenge.status === 'completed') {
                document.getElementById('challenge-days-remaining').textContent = '✅ Challenge Complete!';
                document.getElementById('challenge-days-remaining').style.color = '#16a34a';
            } else if (daysRemaining === 0 && endDate < now) {
                document.getElementById('challenge-days-remaining').textContent = '⏰ Challenge ended — finalizing results...';
                document.getElementById('challenge-days-remaining').style.color = '#f59e0b';
                // Trigger completion if not already done
                if (!challenge.winner_rewarded && typeof completeAndRewardChallenge === 'function') {
                    completeAndRewardChallenge(challenge.id);
                }
            } else {
                document.getElementById('challenge-days-remaining').textContent = `${daysRemaining} days remaining`;
                document.getElementById('challenge-days-remaining').style.color = '#0369a1';
            }
        }

        // Get leaderboard
        const { data: leaderboard, error } = await window.supabaseClient
            .rpc('get_challenge_leaderboard', { challenge_uuid: challengeId });

        if (error) throw error;

        // Update podium
        updatePodium(leaderboard);

        // Update full rankings
        updateFullRankings(leaderboard);

        // Load and render graph
        await loadChallengeGraph(challengeId);

    } catch (error) {
        console.error('Error loading leaderboard:', error);
    }
}

// Update podium display
function updatePodium(leaderboard) {
    const positions = [
        { rank: 1, prefix: '1st' },
        { rank: 2, prefix: '2nd' },
        { rank: 3, prefix: '3rd' }
    ];

    positions.forEach(pos => {
        const participant = leaderboard.find(p => p.rank === pos.rank);
        const nameEl = document.getElementById(`podium-${pos.prefix.toLowerCase().replace('st','st').replace('nd','nd').replace('rd','rd')}-name`);
        const photoEl = document.getElementById(`podium-${pos.prefix.toLowerCase().replace('st','st').replace('nd','nd').replace('rd','rd')}-photo`);
        const ptsEl = document.getElementById(`podium-${pos.prefix.toLowerCase().replace('st','st').replace('nd','nd').replace('rd','rd')}-pts`);

        // Simpler approach - just use the rank number
        const suffix = pos.rank === 1 ? '1st' : pos.rank === 2 ? '2nd' : '3rd';
        const podiumNameEl = document.getElementById(`podium-${suffix}-name`);
        const podiumPhotoEl = document.getElementById(`podium-${suffix}-photo`);
        const podiumPtsEl = document.getElementById(`podium-${suffix}-pts`);

        if (participant) {
            if (podiumNameEl) podiumNameEl.textContent = participant.user_name;
            if (podiumPtsEl) podiumPtsEl.textContent = `${participant.challenge_points} PTS`;
            if (podiumPhotoEl) {
                const initials = (participant.user_name || '?').charAt(0).toUpperCase();
                podiumPhotoEl.innerHTML = participant.user_photo
                    ? `<img src="${participant.user_photo}" style="width: 100%; height: 100%; object-fit: cover;">`
                    : `<span style="font-size: 1.2rem; color: white; font-weight: 700;">${initials}</span>`;
                podiumPhotoEl.style.background = participant.user_photo ? 'transparent' : 'linear-gradient(135deg, var(--primary), #10b981)';
            }
        } else {
            if (podiumNameEl) podiumNameEl.textContent = '--';
            if (podiumPtsEl) podiumPtsEl.textContent = '0 PTS';
        }
    });
}

// Update full rankings list
function updateFullRankings(leaderboard) {
    const container = document.getElementById('challenge-full-rankings');
    if (!container) return;

    if (leaderboard.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No participants yet</div>';
        return;
    }

    container.innerHTML = leaderboard.map(participant => {
        const initials = (participant.user_name || '?').charAt(0).toUpperCase();
        const isCurrentUser = participant.user_id === window.currentUser?.id;
        const rankColor = participant.rank === 1 ? '#fbbf24' : participant.rank === 2 ? '#94a3b8' : participant.rank === 3 ? '#d97706' : '#6b7280';

        return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f1f5f9; ${isCurrentUser ? 'background: #f0fdf4; margin: 0 -15px; padding: 12px 15px;' : ''}">
                <div style="font-size: 1.1rem; font-weight: 700; color: ${rankColor}; width: 30px;">${participant.rank}</div>
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; overflow: hidden;">
                    ${participant.user_photo ? `<img src="${participant.user_photo}" style="width: 100%; height: 100%; object-fit: cover;">` : initials}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-main);">${participant.user_name}${isCurrentUser ? ' (You)' : ''}</div>
                </div>
                <div style="font-weight: 700; color: var(--text-main);">${participant.challenge_points} pts</div>
            </div>
        `;
    }).join('');
}

// Load and render challenge progress graph
async function loadChallengeGraph(challengeId) {
    try {
        const { data: history, error } = await window.supabaseClient
            .rpc('get_challenge_point_history', { challenge_uuid: challengeId });

        if (error) throw error;

        renderChallengeChart(history);

    } catch (error) {
        console.error('Error loading challenge graph:', error);
    }
}

// Render challenge progress chart
function renderChallengeChart(history) {
    const canvas = document.getElementById('challenge-progress-chart');
    if (!canvas) return;

    // Destroy existing chart
    if (challengeChart) {
        challengeChart.destroy();
    }

    if (!history || history.length === 0) {
        canvas.parentElement.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">Progress data will appear as the challenge progresses</div>';
        return;
    }

    // Group data by user
    const userColors = ['#7ba883', '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
    const users = [...new Set(history.map(h => h.user_id))];
    const dates = [...new Set(history.map(h => h.snapshot_date))].sort();

    const datasets = users.map((userId, idx) => {
        const userData = history.filter(h => h.user_id === userId);
        const userName = userData[0]?.user_name || 'Unknown';

        return {
            label: userName,
            data: dates.map(date => {
                const point = userData.find(d => d.snapshot_date === date);
                return point ? point.challenge_points : null;
            }),
            borderColor: userColors[idx % userColors.length],
            backgroundColor: userColors[idx % userColors.length] + '20',
            tension: 0.3,
            fill: false,
            pointRadius: 4
        };
    });

    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        canvas.parentElement.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">Chart library not loaded</div>';
        return;
    }

    challengeChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels: dates.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, padding: 15 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Points' }
                }
            }
        }
    });
}

// Close challenge leaderboard
function closeChallengeLeaderboard() {
    const modal = document.getElementById('challenge-leaderboard-modal');
    if (modal) modal.style.display = 'none';
    currentChallengeId = null;
}

// Leave current challenge
async function leaveCurrentChallenge() {
    if (!currentChallengeId) return;
    if (!confirm('Are you sure you want to leave this challenge? If you\'re the last participant, the challenge will be cancelled.')) return;

    try {
        const { data, error } = await window.supabaseClient
            .rpc('leave_challenge', {
                challenge_uuid: currentChallengeId,
                user_uuid: window.currentUser.id
            });

        if (error) throw error;

        closeChallengeLeaderboard();
        // Refresh challenges on home screen
        if (typeof loadHomeChallenges === 'function') loadHomeChallenges();

        if (data?.cancelled) {
            alert('You were the last participant. The challenge has been cancelled.');
        } else {
            alert('You have left the challenge.');
        }

    } catch (error) {
        console.error('Error leaving challenge:', error);
        alert('Failed to leave challenge');
    }
}

// Get time ago string
function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
    return date.toLocaleDateString();
}

// Open coach chat from friends view
function openCoachChatFromFriends() {
    openCoachChatModal();
}

// Send nudge to friend
async function sendNudgeToFriend(friendId, friendName) {
    if (!confirm(`Send a nudge to ${friendName} to remind them to work out?`)) return;

    try {
        const { error } = await window.supabaseClient
            .from('nudges')
            .insert({
                sender_id: window.currentUser.id,
                receiver_id: friendId,
                message: `Hey! Just checking in - have you worked out today? 💪`
            });

        if (error) throw error;

        showToast(`Nudge sent to ${friendName}!`, 'success');
        loadFriendsCards(); // Refresh to update can_nudge status
    } catch (error) {
        console.error('Error sending nudge:', error);
        showToast('Failed to send nudge. Try again later.', 'error');
    }
}

// Send cheers for an activity
async function sendCheers(userId, activityType) {
    const messages = {
        workout: ['Great workout! 💪', 'Crushing it! 🔥', 'Keep up the great work! ⭐'],
        meal: ['Healthy choices! 🥗', 'Nice meal logging! 📊', 'Staying on track! 🎯'],
        achievement: ['Amazing achievement! 🏆', 'So proud of you! 🌟', 'You\'re on fire! 🔥']
    };

    const randomMessage = messages[activityType][Math.floor(Math.random() * messages[activityType].length)];

    try {
        const { error } = await window.supabaseClient
            .from('nudges')
            .insert({
                sender_id: window.currentUser.id,
                receiver_id: userId,
                message: randomMessage
            });

        if (error) throw error;

        showToast('Cheers sent! 🎉', 'success');
    } catch (error) {
        console.error('Error sending cheers:', error);
        showToast('Failed to send cheers', 'error');
    }
}

// ============================================================
// DIRECT MESSAGING FUNCTIONS
// ============================================================

let currentDMRecipient = null;

// Open direct message modal
function openDirectMessage(userId, userName, userPhoto) {
    currentDMRecipient = { id: userId, name: userName, photo: userPhoto };

    const modal = document.getElementById('direct-message-modal');
    const nameEl = document.getElementById('dm-recipient-name');
    const photoEl = document.getElementById('dm-recipient-photo');
    const statusEl = document.getElementById('dm-recipient-status');

    if (nameEl) nameEl.textContent = userName;
    if (statusEl) statusEl.textContent = 'Friend';

    if (photoEl) {
        const initials = (userName || '?').charAt(0).toUpperCase();
        if (userPhoto) {
            photoEl.innerHTML = `<img src="${userPhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
        } else {
            photoEl.innerHTML = initials;
        }
    }

    if (modal) {
        modal.style.display = 'flex';
        loadDirectMessages(userId);
    }
}

// Close direct message modal
function closeDirectMessageModal() {
    const modal = document.getElementById('direct-message-modal');
    if (modal) modal.style.display = 'none';
    currentDMRecipient = null;
}

// Open coach chat modal
function openCoachChatModal() {
    const modal = document.getElementById('coach-chat-modal');
    if (modal) {
        modal.style.display = 'flex';
        // Load chat history when opening
        if (typeof window.loadChatHistory === 'function') {
            window.loadChatHistory();
        }
        // Focus the input
        setTimeout(() => {
            const input = document.getElementById('coach-chat-input');
            if (input) input.focus();
        }, 100);
    }
}

// Close coach chat modal
function closeCoachChatModal() {
    const modal = document.getElementById('coach-chat-modal');
    if (modal) modal.style.display = 'none';
}

// Load direct messages between current user and recipient
async function loadDirectMessages(recipientId) {
    const container = document.getElementById('dm-messages-container');
    if (!container) return;

    container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading messages...</div>`;

    try {
        // Get messages from nudges table (used as DMs for now)
        const { data: messages, error } = await window.supabaseClient
            .from('nudges')
            .select('*')
            .or(`and(sender_id.eq.${window.currentUser.id},receiver_id.eq.${recipientId}),and(sender_id.eq.${recipientId},receiver_id.eq.${window.currentUser.id})`)
            .order('created_at', { ascending: true })
            .limit(50);

        if (error) throw error;

        if (!messages || messages.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div style="font-size: 2rem; margin-bottom: 10px;">💬</div>
                    <div style="font-size: 0.9rem;">No messages yet. Say hi!</div>
                </div>
            `;
            return;
        }

        container.innerHTML = messages.map(msg => {
            const isSent = msg.sender_id === window.currentUser.id;
            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            return `
                <div style="display: flex; justify-content: ${isSent ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
                    <div style="max-width: 75%; padding: 10px 14px; border-radius: ${isSent ? '16px 16px 4px 16px' : '16px 16px 16px 4px'}; background: ${isSent ? 'var(--primary)' : 'white'}; color: ${isSent ? 'white' : 'var(--text-main)'}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 0.9rem; line-height: 1.4;">${msg.message}</div>
                        <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 4px; text-align: right;">${time}</div>
                    </div>
                </div>
            `;
        }).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

        // Mark messages as read
        await window.supabaseClient
            .from('nudges')
            .update({ read_at: new Date().toISOString() })
            .eq('receiver_id', window.currentUser.id)
            .eq('sender_id', recipientId)
            .is('read_at', null);

    } catch (error) {
        console.error('Error loading messages:', error);
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">Failed to load messages</div>`;
    }
}

// Send direct message
async function sendDirectMessage() {
    const input = document.getElementById('dm-input');
    if (!input || !currentDMRecipient) return;

    const message = input.value.trim();
    if (!message) return;

    input.value = '';

    try {
        const { error } = await window.supabaseClient
            .from('nudges')
            .insert({
                sender_id: window.currentUser.id,
                receiver_id: currentDMRecipient.id,
                message: message
            });

        if (error) throw error;

        // Reload messages
        loadDirectMessages(currentDMRecipient.id);

        // Send push notification to recipient
        if (typeof sendDMNotification === 'function') {
            sendDMNotification(currentDMRecipient.id, message);
        }

    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Failed to send message', 'error');
    }
}

// Open message inbox (shows friend selector to choose who to message)
async function openMessageInbox() {
    const modal = document.getElementById('message-selector-modal');
    const listContainer = document.getElementById('message-selector-list');

    if (!modal || !listContainer) return;

    // Show modal with loading state
    modal.style.display = 'flex';
    listContainer.innerHTML = `<div style="text-align: center; padding: 30px; color: var(--text-muted);">Loading contacts...</div>`;

    try {
        // Build list with Coach Shannon first, then friends
        let html = '';

        // Add Coach Shannon as first option
        html += `
            <div onclick="closeMessageSelectorModal(); openCoachChatModal();" style="display: flex; align-items: center; gap: 12px; padding: 15px; margin: 5px 0; background: #f8fafc; border-radius: 12px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.2rem; flex-shrink: 0;">S</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; color: var(--text-main);">Coach Shannon</div>
                    <div style="font-size: 0.85rem; color: var(--primary); font-weight: 500;">Your Coach</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-muted); flex-shrink: 0;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
        `;

        // Get friends list
        if (window.currentUser && window.dbHelpers && window.dbHelpers.friends) {
            const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);

            if (friends && friends.length > 0) {
                // Add divider
                html += `<div style="padding: 10px 15px; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Friends</div>`;

                friends.forEach(friend => {
                    const initials = (friend.friend_name || friend.friend_email || '?').charAt(0).toUpperCase();
                    const photoHtml = friend.friend_photo
                        ? `<img src="${friend.friend_photo}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.parentElement.innerHTML='${initials}'">`
                        : initials;

                    html += `
                        <div onclick="closeMessageSelectorModal(); openDirectMessage('${friend.friend_id}', '${(friend.friend_name || friend.friend_email || 'Friend').replace(/'/g, "\\'")}', '${friend.friend_photo || ''}');" style="display: flex; align-items: center; gap: 12px; padding: 15px; margin: 5px 0; background: #f8fafc; border-radius: 12px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--secondary); display: flex; align-items: center; justify-content: center; color: var(--text-main); font-weight: 600; font-size: 1.2rem; overflow: hidden; flex-shrink: 0;">${photoHtml}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${friend.friend_name || friend.friend_email || 'Friend'}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Tap to message</div>
                            </div>
                            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-muted); flex-shrink: 0;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        </div>
                    `;
                });
            }
        }

        // If no friends, show helpful message
        if (!html.includes('Friends')) {
            html += `
                <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                    <p style="margin: 0 0 10px 0;">Add friends to message them!</p>
                    <button onclick="closeMessageSelectorModal(); openAddFriendModal();" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer;">Add Friends</button>
                </div>
            `;
        }

        listContainer.innerHTML = html;

    } catch (error) {
        console.error('Error loading contacts:', error);
        listContainer.innerHTML = `<div style="text-align: center; padding: 30px; color: var(--text-muted);">Failed to load contacts</div>`;
    }
}

// Close message selector modal
function closeMessageSelectorModal() {
    const modal = document.getElementById('message-selector-modal');
    if (modal) modal.style.display = 'none';
}

// Open the Messages panel (slide-over with group chats + friends)
function openFeedMessagesPanel() {
    const panel = document.getElementById('feed-messages-panel');
    if (panel) {
        panel.style.display = 'block';
        // Close panel when clicking on backdrop (outside panel content)
        panel.onclick = function(e) {
            if (e.target === panel) closeFeedMessagesPanel();
        };
        loadPanelGroupChats();
        loadPanelFriends();
    }
}

// Close the Messages panel
function closeFeedMessagesPanel() {
    const panel = document.getElementById('feed-messages-panel');
    if (panel) panel.style.display = 'none';
}

// --- Home Friends Pill & Modal ---

// Update the friends pill count on the home page
async function updateHomeFriendsPillCount() {
    try {
        if (!window.currentUser) return;
        const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);
        const count = friends ? friends.length : 0;
        const pillCount = document.getElementById('home-friends-pill-count');
        if (pillCount) pillCount.textContent = count;
    } catch (e) {
        console.error('Error updating friends pill count:', e);
    }
}

function openHomeFriendsModal() {
    const modal = document.getElementById('home-friends-modal');
    if (modal) {
        modal.style.display = 'flex';
        loadHomeFriendsModal();
    }
}

function closeHomeFriendsModal() {
    const modal = document.getElementById('home-friends-modal');
    if (modal) modal.style.display = 'none';
}

async function loadHomeFriendsModal() {
    const container = document.getElementById('home-friends-modal-list');
    const countBadge = document.getElementById('home-friends-modal-count');
    if (!container || !window.currentUser) return;

    container.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 0.85rem;">Loading...</div>';

    try {
        const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);
        const count = friends ? friends.length : 0;
        if (countBadge) countBadge.textContent = count;

        // Also update the pill
        const pillCount = document.getElementById('home-friends-pill-count');
        if (pillCount) pillCount.textContent = count;

        if (!friends || friends.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">👥</div>
                    <div style="font-size: 0.95rem; margin-bottom: 6px; font-weight: 600; color: var(--text-main);">No friends yet</div>
                    <div style="font-size: 0.8rem; margin-bottom: 16px;">Add friends to see them here!</div>
                    <button onclick="closeHomeFriendsModal(); openAddFriendModal();" style="background: linear-gradient(135deg, var(--primary), #10b981); color: white; border: none; padding: 10px 24px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">Add Friends</button>
                </div>
            `;
            return;
        }

        container.innerHTML = friends.map(friend => {
            const initials = (friend.friend_name || '?').charAt(0).toUpperCase();
            const friendName = (friend.friend_name || 'Friend').replace(/'/g, "\\'");
            const friendPhoto = (friend.friend_photo || '').replace(/'/g, "\\'");
            const photoHtml = friend.friend_photo
                ? `<img src="${friend.friend_photo}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;" onerror="this.parentElement.innerHTML='${initials}'">`
                : initials;

            return `
                <div style="display: flex; align-items: center; padding: 10px 20px; border-bottom: 1px solid #f8fafc;">
                    <div onclick="closeHomeFriendsModal(); viewUserProfile('${friend.friend_id}', '${friendName}', '${friendPhoto}');" style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer; min-width: 0;">
                        <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; overflow: hidden; flex-shrink: 0;">
                            ${photoHtml}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: var(--text-main); font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${friend.friend_name || 'Friend'}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">View profile</div>
                        </div>
                    </div>
                    <button onclick="closeHomeFriendsModal(); openDirectMessage('${friend.friend_id}', '${friendName}', '${friendPhoto}');" style="width: 36px; height: 36px; background: #f1f5f9; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" title="Message">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--text-muted);"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                    </button>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading home friends modal:', error);
        container.innerHTML = '<div style="text-align: center; padding: 30px; color: #ef4444; font-size: 0.85rem;">Failed to load friends</div>';
    }
}

// Load group chats into the messages panel
async function loadPanelGroupChats() {
    const container = document.getElementById('panel-group-chats');
    if (!container || !window.currentUser) return;

    container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-muted); font-size: 0.85rem;">Loading...</div>';

    try {
        const { data: chats, error } = await window.supabaseClient
            .rpc('get_user_group_chats', { user_uuid: window.currentUser.id });

        if (error) throw error;

        if (!chats || chats.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">
                    <div style="margin-bottom: 8px;">No group chats yet</div>
                    <button onclick="openCreateGroupChatModal(); closeFeedMessagesPanel();" style="background: var(--primary); color: white; border: none; padding: 6px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">Create One</button>
                </div>
            `;
            return;
        }

        container.innerHTML = chats.map(chat => {
            const timeAgo = chat.last_message_at ? getTimeAgo(new Date(chat.last_message_at)) : '';
            const preview = chat.last_message ? (chat.last_message.length > 40 ? chat.last_message.substring(0, 40) + '...' : chat.last_message) : 'No messages yet';

            return `
                <div onclick="openGroupChat('${chat.chat_id}', '${escapeHtml(chat.chat_name)}', '${escapeHtml(chat.member_names || '')}'); closeFeedMessagesPanel();" style="display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 10px; cursor: pointer; transition: background 0.2s; background: #f8fafc;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
                    <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem; flex-shrink: 0;">💬</div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600; color: var(--text-main); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(chat.chat_name)}</div>
                            ${timeAgo ? `<div style="font-size: 0.7rem; color: var(--text-muted); flex-shrink: 0; margin-left: 8px;">${timeAgo}</div>` : ''}
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${chat.last_message_by ? `<span style="font-weight: 500;">${escapeHtml(chat.last_message_by)}:</span> ` : ''}${escapeHtml(preview)}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading panel group chats:', error);
        container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-muted); font-size: 0.85rem;">Failed to load chats</div>';
    }
}

// Load friends into the messages panel
async function loadPanelFriends() {
    const container = document.getElementById('panel-friends-list');
    const countEl = document.getElementById('panel-friends-count');
    if (!container || !window.currentUser) return;

    container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--text-muted); font-size: 0.85rem;">Loading...</div>';

    try {
        const friends = await db.friends.getFriendsWithFallback(window.currentUser.id);

        if (countEl) {
            countEl.textContent = friends.length === 0 ? '0 friends' :
                                  friends.length === 1 ? '1 friend' :
                                  `${friends.length} friends`;
        }

        if (!friends || friends.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">
                    <p style="margin: 0 0 10px 0;">Add friends to message them!</p>
                    <button onclick="closeFeedMessagesPanel(); openAddFriendModal();" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">Add Friends</button>
                </div>
            `;
            return;
        }

        container.innerHTML = friends.map(friend => {
            const initials = (friend.friend_name || '?').charAt(0).toUpperCase();
            const photoHtml = friend.friend_photo
                ? `<img src="${friend.friend_photo}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='${initials}'">`
                : initials;

            return `
                <div onclick="closeFeedMessagesPanel(); openDirectMessage('${friend.friend_id}', '${(friend.friend_name || 'Friend').replace(/'/g, "\\'")}', '${friend.friend_photo || ''}');" style="display: flex; align-items: center; padding: 10px 0; cursor: pointer; border-bottom: 1px solid #f1f5f9;">
                    <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1rem; overflow: hidden; margin-right: 12px; flex-shrink: 0;">${photoHtml}</div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: var(--text-main); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${friend.friend_name || 'Friend'}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Tap to message</div>
                    </div>
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--text-muted); flex-shrink: 0;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading panel friends:', error);
        container.innerHTML = '<div style="text-align: center; padding: 15px; color: #ef4444; font-size: 0.85rem;">Failed to load friends</div>';
    }
}

// Simple toast notification
function showToast(message, type = 'info') {
    // Remove any existing toast
    const existingToast = document.querySelector('.friend-toast');
    if (existingToast) existingToast.remove();

    const colors = {
        success: '#22c55e',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };

    const toast = document.createElement('div');
    toast.className = 'friend-toast';
    toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: ${colors[type]};
        color: white;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 10010;
        animation: fadeInUp 0.3s ease-out;
    `;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'fadeOutDown 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Add CSS for toast animations if not already present
if (!document.getElementById('friend-toast-styles')) {
    const style = document.createElement('style');
    style.id = 'friend-toast-styles';
    style.textContent = `
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        @keyframes fadeOutDown {
            from { opacity: 1; transform: translateX(-50%) translateY(0); }
            to { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
}

// Load referral stats and friends when community tab is opened
window.addEventListener('DOMContentLoaded', () => {
    // Attach to tab switching logic
    const originalShowSupportTab = window.showSupportTab;
    if (typeof originalShowSupportTab === 'function') {
        window.showSupportTab = function(tab, element) {
            originalShowSupportTab(tab, element);
            if (tab === 'community') {
                loadReferralStats();
                updateFriendsCount();
                loadPendingFriendRequests(); // Check for new friend requests
            }
        };
    }
});

// --- THEME SYSTEM ---
// --- THEME SYSTEM ---
const APP_THEMES = {
    'default': {
        name: 'Forest (Premium)',
        colors: {
            '--primary': '#7BA883',
            '--primary-light': '#98C9A3',
            '--secondary': '#E8D68E',
            '--secondary-light': '#F2E5B0',
            '--accent-green': '#f2f7f4',
            '--bg': '#f9f9f7',
            '--surface': '#ffffff',
            '--text-main': '#1a202c',
            '--text-muted': '#718096',
            '--chat-bg-user': '#7BA883',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f2f7f4',
            '--chat-text-coach': '#1a202c',
            '--chat-border-coach': '#e2e8f0'
        }
    },
    'flower-garden': {
        name: 'Flower Garden',
        colors: {
            '--primary': '#D98B9C',
            '--primary-light': '#F4B4C4',
            '--secondary': '#B4A7D6',
            '--secondary-light': '#D0C8E8',
            '--accent-green': '#FFF8F5',
            '--bg': '#FFFBF9',
            '--surface': '#ffffff',
            '--text-main': '#4A3F44',
            '--text-muted': '#8B7D82',
            '--chat-bg-user': '#D98B9C',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#FFF8F5',
            '--chat-text-coach': '#4A3F44',
            '--chat-border-coach': '#F4B4C4'
        }
    },
    'antigravity-light': {
        name: 'Antigravity Light',
        colors: {
            '--primary': '#4f46e5',
            '--primary-light': '#6366f1',
            '--secondary': '#0891b2',
            '--secondary-light': '#22D3EE',
            '--accent-green': '#eff6ff',
            '--bg': '#ffffff',
            '--surface': '#f8fafc',
            '--text-main': '#0f172a',
            '--text-muted': '#64748b',
            '--chat-bg-user': '#4f46e5',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f1f5f9',
            '--chat-text-coach': '#0f172a',
            '--chat-border-coach': '#e2e8f0'
        }
    },
    'ocean': {
        name: 'Ocean Calm',
        colors: {
            '--primary': '#0369a1',
            '--primary-light': '#0ea5e9',
            '--secondary': '#db2777',
            '--secondary-light': '#F472B6',
            '--accent-green': '#f0f9ff', 
            '--bg': '#f0f9ff', 
            '--surface': '#ffffff', 
            '--text-main': '#082f49', 
            '--text-muted': '#64748b',
            '--chat-bg-user': '#0369a1',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f1f5f9',
            '--chat-text-coach': '#082f49',
            '--chat-border-coach': '#e0f2fe'
        } 
    },
    'sunset': {
        name: 'Sunset Glow',
        colors: {
            '--primary': '#9d174d',
            '--primary-light': '#be123c',
            '--secondary': '#ea580c',
            '--secondary-light': '#FB923C',
            '--accent-green': '#fff1f2', 
            '--bg': '#fff1f2', 
            '--surface': '#ffffff', 
            '--text-main': '#500724', 
            '--text-muted': '#9d174d',
            '--chat-bg-user': '#9d174d',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#fff5f5',
            '--chat-text-coach': '#500724',
            '--chat-border-coach': '#ffe4e6'
        } 
    },
    'cycle-pink': {
        name: 'Cycle Harmony',
        colors: {
            '--primary': '#D81B60',
            '--primary-light': '#F06292',
            '--secondary': '#AB47BC',
            '--secondary-light': '#CE93D8',
            '--accent-green': '#FCE4EC',
            '--bg': '#FCE4EC',
            '--surface': '#ffffff',
            '--text-main': '#880E4F',
            '--text-muted': '#AD1457',
            '--chat-bg-user': '#D81B60',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#F8BBD0',
            '--chat-text-coach': '#880E4F',
            '--chat-border-coach': '#F48FB1'
        }
    },
    'midnight': {
        name: 'Midnight Luxe',
        colors: {
            '--primary': '#0f172a', // Slate 900
            '--primary-light': '#1e293b', // Slate 800
            '--secondary': '#fbbf24', // Amber 400
            '--secondary-light': '#FDE68A', // Amber 200
            '--accent-green': '#334155', // Slate 700
            '--bg': '#020617', // Slate 950
            '--surface': '#1e293b', // Slate 800
            '--text-main': '#f8fafc', // Slate 50
            '--text-muted': '#94a3b8', // Slate 400
            '--chat-bg-user': '#3b82f6',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#1e293b',
            '--chat-text-coach': '#f8fafc',
            '--chat-border-coach': '#334155'
        }
    },
    'lavender': {
        name: 'Lavender Haze',
        colors: {
            '--primary': '#6b21a8', // Purple 800
            '--primary-light': '#7e22ce', // Purple 700
            '--secondary': '#fcd34d', // Amber 300
            '--secondary-light': '#FEF08A', // Yellow 200
            '--accent-green': '#faf5ff', // Purple 50
            '--bg': '#faf5ff', 
            '--surface': '#ffffff',
            '--text-main': '#4c1d95',
            '--text-muted': '#9333ea',
            '--chat-bg-user': '#6b21a8',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f3e8ff',
            '--chat-text-coach': '#4c1d95',
            '--chat-border-coach': '#e9d5ff'
        }
    },
    'matcha': {
        name: 'Matcha Latte',
        colors: {
            '--primary': '#3f6212', // Lime 800
            '--primary-light': '#4d7c0f', // Lime 700
            '--secondary': '#a3e635', // Lime 400
            '--secondary-light': '#D9F99D', // Lime 200
            '--accent-green': '#f7fee7', // Lime 50
            '--bg': '#f7fee7',
            '--surface': '#ffffff',
            '--text-main': '#1a2e05',
            '--text-muted': '#4d7c0f',
            '--chat-bg-user': '#3f6212',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#ecfccb',
            '--chat-text-coach': '#1a2e05',
            '--chat-border-coach': '#d9f99d'
        }
    },
    'monochrome': {
        name: 'Monochrome',
        colors: {
            '--primary': '#1a1a1a', // Near black
            '--primary-light': '#333333', // Dark gray
            '--secondary': '#666666', // Medium gray
            '--secondary-light': '#A3A3A3', // Light gray
            '--accent-green': '#f5f5f5', // Light gray
            '--bg': '#ffffff', // White
            '--surface': '#fafafa', // Off-white
            '--text-main': '#1a1a1a', // Near black
            '--text-muted': '#737373', // Gray
            '--chat-bg-user': '#1a1a1a',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#f5f5f5',
            '--chat-text-coach': '#1a1a1a',
            '--chat-border-coach': '#e5e5e5'
        }
    },
    'dbz-warrior': {
        name: 'Super Saiyan',
        maleOnly: true,
        colors: {
            '--primary': '#FF6B00', // Goku's gi orange
            '--primary-light': '#FF8C00', // Lighter orange
            '--secondary': '#FFD700', // Super Saiyan gold
            '--secondary-light': '#FDE68A', // Light gold
            '--accent-green': '#FFF8E7', // Warm light background
            '--bg': '#FFFAF0', // Floral white warm
            '--surface': '#ffffff',
            '--text-main': '#1a1a1a',
            '--text-muted': '#8B4513', // Saddle brown
            '--chat-bg-user': '#FF6B00',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#FFF8E7',
            '--chat-text-coach': '#1a1a1a',
            '--chat-border-coach': '#FFD700'
        }
    },
    'dbz-vegeta': {
        name: 'Saiyan Prince',
        maleOnly: true,
        colors: {
            '--primary': '#0047AB', // Royal blue (Vegeta's suit)
            '--primary-light': '#1E90FF', // Dodger blue
            '--secondary': '#FFD700', // Super Saiyan gold
            '--secondary-light': '#FDE68A', // Light gold
            '--accent-green': '#F0F8FF', // Alice blue
            '--bg': '#F5F9FF', // Light blue tint
            '--surface': '#ffffff',
            '--text-main': '#0a1628',
            '--text-muted': '#4a5568',
            '--chat-bg-user': '#0047AB',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#F0F8FF',
            '--chat-text-coach': '#0a1628',
            '--chat-border-coach': '#87CEEB'
        }
    },
    'sailor-moon': {
        name: 'Moon Princess',
        femaleOnly: true,
        colors: {
            '--primary': '#FF69B4', // Hot pink (Sailor Moon's theme)
            '--primary-light': '#FFB6C1', // Light pink
            '--secondary': '#FFD700', // Gold (tiara and accents)
            '--secondary-light': '#FDE68A', // Light gold
            '--accent-green': '#FFF0F5', // Lavender blush
            '--bg': '#FFF5FA', // Light pink background
            '--surface': '#ffffff',
            '--text-main': '#1a1a1a',
            '--text-muted': '#8B4789', // Purple-ish
            '--chat-bg-user': '#FF69B4',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#FFF0F5',
            '--chat-text-coach': '#1a1a1a',
            '--chat-border-coach': '#FFD700'
        }
    },
    'sailor-venus': {
        name: 'Goddess of Love',
        femaleOnly: true,
        colors: {
            '--primary': '#FFA500', // Orange (Sailor Venus's theme)
            '--primary-light': '#FFB84D', // Light orange
            '--secondary': '#FFD700', // Gold
            '--secondary-light': '#FDE68A', // Light gold
            '--accent-green': '#FFF8DC', // Cornsilk
            '--bg': '#FFFAF0', // Floral white
            '--surface': '#ffffff',
            '--text-main': '#1a1a1a',
            '--text-muted': '#B8860B', // Dark goldenrod
            '--chat-bg-user': '#FFA500',
            '--chat-text-user': '#ffffff',
            '--chat-bg-coach': '#FFF8DC',
            '--chat-text-coach': '#1a1a1a',
            '--chat-border-coach': '#FFD700'
        }
    }
};

// Function to create falling flower animation for flower-garden theme
function createFallingFlowerAnimation() {
    const flowerAssets = [
        'assets/flower-cherry-blossom.svg',
        'assets/flower-rose.svg',
        'assets/flower-daisy.svg',
        'assets/flower-peony.svg',
        'assets/flower-lavender.svg'
    ];

    const numberOfFlowers = 15; // Number of flowers to fall
    const containerWidth = window.innerWidth;

    for (let i = 0; i < numberOfFlowers; i++) {
        setTimeout(() => {
            const flower = document.createElement('div');
            flower.className = 'falling-flower';

            // Random flower type
            const randomFlower = flowerAssets[Math.floor(Math.random() * flowerAssets.length)];
            flower.style.backgroundImage = `url('${randomFlower}')`;

            // Random horizontal position
            const randomX = Math.random() * containerWidth;
            flower.style.left = randomX + 'px';
            flower.style.top = '-100px';

            // Random size variation (30px to 50px)
            const randomSize = 30 + Math.random() * 20;
            flower.style.width = randomSize + 'px';
            flower.style.height = randomSize + 'px';

            // Random animation duration (4s to 7s for graceful fall)
            const randomDuration = 4 + Math.random() * 3;
            flower.style.animation = `flowerFall ${randomDuration}s ease-in-out forwards`;

            // Random delay for staggered effect
            flower.style.animationDelay = (Math.random() * 0.5) + 's';

            document.body.appendChild(flower);

            // Remove flower element after animation completes
            setTimeout(() => {
                if (flower.parentNode) {
                    flower.parentNode.removeChild(flower);
                }
            }, (randomDuration + 0.5) * 1000);
        }, i * 200); // Stagger the creation of flowers
    }
}

async function _applyAppThemeRealImpl(themeKey) {
    const theme = APP_THEMES[themeKey];
    if(!theme) return;

    // DBZ themes are restricted to male users only, Sailor Moon themes to female users only
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    const isFemale = !isMale;
    if ((theme.maleOnly && !isMale) || (theme.femaleOnly && !isFemale)) {
        // User trying to use gender-restricted theme - fall back to default
        themeKey = 'default';
        const defaultTheme = APP_THEMES['default'];
        for (const [key, value] of Object.entries(defaultTheme.colors)) {
            document.documentElement.style.setProperty(key, value);
        }
        localStorage.setItem('userThemePreference', 'default');
        const selector = document.getElementById('theme-selector');
        if(selector) selector.value = 'default';

        // Save to Supabase
        if (window.currentUser?.id && typeof dbHelpers !== 'undefined') {
            try {
                await dbHelpers.users.update(window.currentUser.id, { theme_preference: 'default' });
                console.log("Theme preference saved to DB: default");
            } catch (e) {
                console.warn("Failed to save theme preference to DB:", e);
            }
        }
        return;
    }

    for (const [key, value] of Object.entries(theme.colors)) { document.documentElement.style.setProperty(key, value); }
    localStorage.setItem('userThemePreference', themeKey);
    const selector = document.getElementById('theme-selector');
    if(selector) selector.value = themeKey;

    // CRITICAL: Save theme preference to Supabase for persistence across cache clears
    if (window.currentUser?.id && typeof dbHelpers !== 'undefined') {
        try {
            await dbHelpers.users.update(window.currentUser.id, { theme_preference: themeKey });
            console.log("Theme preference saved to DB:", themeKey);
        } catch (e) {
            console.warn("Failed to save theme preference to DB:", e);
        }
    }

    // Update dashboard-welcome background - keep gradient for all themes
    const welcomeSection = document.querySelector('.dashboard-welcome');
    if(welcomeSection) {
        // Always use dynamic theme gradient
        welcomeSection.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%)';
        welcomeSection.style.color = 'white';
        // Ensure all child elements use white text for maximum readability
        const children = welcomeSection.querySelectorAll('*');
        children.forEach(c => {
             c.style.color = 'white';
        });
    }

    // Handle DBZ theme decorations (male users only)
    const isDbzTheme = themeKey.startsWith('dbz-');

    // Handle Sailor Moon theme decorations (female users only)
    const isSailorMoonTheme = themeKey.startsWith('sailor-');

    // Easter egg: Show video on first theme selection (male users only)
    if (isMale && isDbzTheme) {
        const easterEggKey = `dbz_easter_egg_${themeKey}`;
        const hasSeenEasterEgg = localStorage.getItem(easterEggKey);

        if (!hasSeenEasterEgg) {
            // Show the appropriate Easter egg video
            let videoUrl, videoTitle;

            if (themeKey === 'dbz-warrior') {
                // Super Saiyan theme - bigger video
                videoUrl = 'https://f005.backblazeb2.com/file/shannonsvideos/download_20260120_225718_0000.mp4';
                videoTitle = 'Super Saiyan Unlocked!';
            } else if (themeKey === 'dbz-vegeta') {
                // Saiyan Prince theme - smaller video
                videoUrl = 'https://f005.backblazeb2.com/file/shannonsvideos/download_20260120_231525_0000.mp4';
                videoTitle = 'Saiyan Prince Unlocked!';
            }

            if (videoUrl) {
                // Mark as seen so it only shows once
                localStorage.setItem(easterEggKey, 'true');

                // Show the Easter egg video after a short delay to let theme apply
                setTimeout(() => {
                    if (typeof openExerciseVideo === 'function') {
                        openExerciseVideo(videoUrl, videoTitle, true); // autoplay = true
                    }
                }, 300);
            }
        }
    }

    // Flower Garden theme animation - falling flowers on first selection (female users only)
    const isFlowerTheme = (themeKey === 'flower-garden');
    // isFemale is already defined above

    if (isFemale && isFlowerTheme) {
        const flowerEasterEggKey = 'flower_garden_animation_seen';
        const hasSeenFlowerAnimation = localStorage.getItem(flowerEasterEggKey);

        if (!hasSeenFlowerAnimation) {
            // Mark as seen so it only shows once
            localStorage.setItem(flowerEasterEggKey, 'true');

            // Trigger falling flower animation after a short delay to let theme apply
            setTimeout(() => {
                if (typeof createFallingFlowerAnimation === 'function') {
                    createFallingFlowerAnimation();
                }
            }, 300);
        }
    }

    const dbzDecorations = document.getElementById('dbz-decorations');
    const gokuImg = document.getElementById('dbz-goku');
    const vegetaImg = document.getElementById('dbz-vegeta');

    if (dbzDecorations) {
        dbzDecorations.style.display = (isDbzTheme && isMale) ? 'block' : 'none';

        // Show the correct character based on theme
        if (gokuImg && vegetaImg) {
            if (themeKey === 'dbz-warrior') {
                // Super Saiyan theme - show Goku
                gokuImg.style.display = 'block';
                vegetaImg.style.display = 'none';
            } else if (themeKey === 'dbz-vegeta') {
                // Saiyan Prince theme - show Vegeta
                gokuImg.style.display = 'none';
                vegetaImg.style.display = 'block';
            }
        }
    }

    // Toggle DBZ body class for additional styling
    if (isDbzTheme && isMale) {
        document.body.classList.add('dbz-theme-active');
        // Add specific class for each character's theme
        document.body.classList.remove('dbz-goku-theme', 'dbz-vegeta-theme');
        document.body.classList.add(themeKey === 'dbz-warrior' ? 'dbz-goku-theme' : 'dbz-vegeta-theme');
    } else {
        document.body.classList.remove('dbz-theme-active', 'dbz-goku-theme', 'dbz-vegeta-theme');
    }

    // Handle Sailor Moon decorations (female users only)
    const sailorDecorations = document.getElementById('sailor-decorations');
    const sailorMoonImg = document.getElementById('sailor-moon-character');
    const sailorVenusImg = document.getElementById('sailor-venus-character');

    if (sailorDecorations) {
        sailorDecorations.style.display = (isSailorMoonTheme && isFemale) ? 'block' : 'none';

        // Show the correct character based on theme
        if (sailorMoonImg && sailorVenusImg) {
            if (themeKey === 'sailor-moon') {
                // Moon Princess theme - show Sailor Moon
                sailorMoonImg.style.display = 'block';
                sailorVenusImg.style.display = 'none';
            } else if (themeKey === 'sailor-venus') {
                // Goddess of Love theme - show Sailor Venus
                sailorMoonImg.style.display = 'none';
                sailorVenusImg.style.display = 'block';
            }
        }
    }

    // Toggle Sailor Moon body class for additional styling
    if (isSailorMoonTheme && isFemale) {
        document.body.classList.add('sailor-theme-active');
        // Add specific class for each character's theme
        document.body.classList.remove('sailor-moon-theme', 'sailor-venus-theme');
        document.body.classList.add(themeKey === 'sailor-moon' ? 'sailor-moon-theme' : 'sailor-venus-theme');
    } else {
        document.body.classList.remove('sailor-theme-active', 'sailor-moon-theme', 'sailor-venus-theme');
    }

    // Handle Flower Garden decorations (female users only)
    const flowerDecorations = document.getElementById('flower-decorations');
    if (flowerDecorations) {
        flowerDecorations.style.display = (isFlowerTheme && isFemale) ? 'block' : 'none';
    }

    // Toggle Flower Garden body class for additional styling
    if (isFlowerTheme && isFemale) {
        document.body.classList.add('flower-theme-active');
    } else {
        document.body.classList.remove('flower-theme-active');
    }

    // Trigger icon toggle update
    updateSettingsIcon();
}

// Replace stub with real implementation
_applyAppThemeReal = _applyAppThemeRealImpl;
applyAppTheme = _applyAppThemeRealImpl;

// Reusable function to toggle settings icon and profile icon based on current theme
function updateSettingsIcon() {
    const savedTheme = localStorage.getItem('userThemePreference') || 'default';
    const isDbzTheme = savedTheme.startsWith('dbz-');
    const isSailorMoonTheme = savedTheme.startsWith('sailor-');
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    const isFemale = !isMale;

    setTimeout(() => {
        // Update settings icon (gear vs dragon ball vs sailor moon)
        const gearIcon = document.getElementById('settings-icon-gear');
        const dragonBallIcon = document.getElementById('settings-icon-dragonball');
        const sailorMoonIcon = document.getElementById('settings-icon-sailormoon');

        if (gearIcon && dragonBallIcon && sailorMoonIcon) {
            if (isDbzTheme && isMale) {
                // DBZ theme: show dragon ball, hide others
                gearIcon.style.setProperty('display', 'none', 'important');
                dragonBallIcon.style.setProperty('display', 'inline-block', 'important');
                sailorMoonIcon.style.setProperty('display', 'none', 'important');
                console.log('✅ Dragon Ball settings icon activated');
            } else if (isSailorMoonTheme && isFemale) {
                // Sailor Moon theme: show moon, hide others
                gearIcon.style.setProperty('display', 'none', 'important');
                dragonBallIcon.style.setProperty('display', 'none', 'important');
                sailorMoonIcon.style.setProperty('display', 'inline-block', 'important');
                console.log('✅ Sailor Moon settings icon activated');
            } else {
                // Default: show gear, hide themed icons
                gearIcon.style.setProperty('display', 'inline-block', 'important');
                dragonBallIcon.style.setProperty('display', 'none', 'important');
                sailorMoonIcon.style.setProperty('display', 'none', 'important');
                console.log('✅ Gear settings icon activated (theme: ' + savedTheme + ')');
            }
        } else {
            console.warn('⚠️ Settings icons not found in DOM yet');
        }

        // Update profile icons (all instances with class profile-icon)
        const profileIcons = document.querySelectorAll('.profile-icon');
        profileIcons.forEach(icon => {
            if (isDbzTheme && isMale) {
                // DBZ theme: show dragon ball background
                icon.style.setProperty('background-image', 'url(assets/dragon-ball.svg)', 'important');
                icon.style.setProperty('background-size', 'cover', 'important');
                icon.style.setProperty('background-position', 'center', 'important');
                icon.style.setProperty('color', 'transparent', 'important');
                icon.style.setProperty('font-size', '0', 'important');
                console.log('✅ Dragon Ball profile icon activated');
            } else {
                // Default: remove dragon ball background, show "S"
                icon.style.removeProperty('background-image');
                icon.style.setProperty('background', 'var(--accent-green)', 'important');
                icon.style.setProperty('color', 'var(--primary)', 'important');
                icon.style.setProperty('font-size', '', 'important');
                console.log('✅ Standard profile icon activated');
            }
        });
    }, 50); // Small delay to ensure DOM is ready
}

// Diagnostic function for debugging Dragon Ball icons
function debugDragonBallIcon() {
    const profileIconElements = document.querySelectorAll('.profile-icon');
    const firstProfileIcon = profileIconElements[0];

    const results = {
        userGender: localStorage.getItem('userGender'),
        isMale: isMaleUser(),
        currentTheme: localStorage.getItem('userThemePreference'),
        bodyClasses: Array.from(document.body.classList),
        hasDbzThemeActive: document.body.classList.contains('dbz-theme-active'),
        settingsGearIcon: {
            exists: !!document.getElementById('settings-icon-gear'),
            display: document.getElementById('settings-icon-gear')?.style.display,
            computedDisplay: window.getComputedStyle(document.getElementById('settings-icon-gear') || document.createElement('div')).display
        },
        settingsDragonBallIcon: {
            exists: !!document.getElementById('settings-icon-dragonball'),
            display: document.getElementById('settings-icon-dragonball')?.style.display,
            computedDisplay: window.getComputedStyle(document.getElementById('settings-icon-dragonball') || document.createElement('div')).display,
            src: document.getElementById('settings-icon-dragonball')?.src
        },
        profileIcons: {
            count: profileIconElements.length,
            firstIcon: firstProfileIcon ? {
                backgroundImage: window.getComputedStyle(firstProfileIcon).backgroundImage,
                color: window.getComputedStyle(firstProfileIcon).color,
                textContent: firstProfileIcon.textContent
            } : null
        }
    };

    console.log('=== Dragon Ball Icon Debug Info ===');
    console.table(results);
    console.log('Full results:', results);

    // Show user-friendly message
    if (results.isMale && results.currentTheme?.startsWith('dbz-')) {
        console.log('✅ DBZ theme active for male user');
        console.log('  → Settings: Dragon Ball should show, Gear should hide');
        console.log('  → Profile icon (top right S): Should show Dragon Ball background');

        if (!results.hasDbzThemeActive) {
            console.log('  ❌ body.dbz-theme-active class is MISSING');
        }
        if (results.profileIcons.firstIcon?.backgroundImage.includes('dragon-ball')) {
            console.log('  ✅ Profile icon has Dragon Ball background');
        } else {
            console.log('  ❌ Profile icon does NOT have Dragon Ball background');
        }
    } else {
        console.log('ℹ️ Dragon Ball icons should NOT be visible because:');
        if (!results.isMale) console.log('  - User is not male (gender: ' + results.userGender + ')');
        if (!results.currentTheme?.startsWith('dbz-')) console.log('  - Current theme is not DBZ (theme: ' + results.currentTheme + ')');
    }

    return results;
}

// Make functions available in console for debugging
window.debugDragonBallIcon = debugDragonBallIcon;
window.updateSettingsIcon = updateSettingsIcon;

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Wait for Auth before loading user-specific data
    const waitForAuth = () => new Promise(resolve => {
        if(window.currentUser) return resolve(window.currentUser);
        const check = setInterval(() => {
            if(window.currentUser) { clearInterval(check); resolve(window.currentUser); }
        }, 100);
        setTimeout(() => { clearInterval(check); resolve(null); }, 3000);
    });

    waitForAuth().then(() => {
        // Only load user-specific data after auth is confirmed
        if(window.currentUser) {
            loadChatHistory();
            loadCommunityFeed();

            // Subscribe to Realtime updates for new coach messages
            subscribeToCoachMessages(window.currentUser.id);
        }
        checkUserRole();
        // Theme is now applied in the main initialization sequence after gender is loaded
    });

    // Event Listeners (Community only - Coach uses form onsubmit)
    document.getElementById('community-chat-input')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendCommunityMessage(); });
});
</script>

<!-- VIDEO MODAL (Ensured Existence) -->
<!-- VIDEO MODAL (Improved) -->
<div id="video-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10010; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <!-- Close Button (Top Right) -->
    <div onclick="closeVideoModal()" style="position: absolute; top: 25px; right: 25px; width: 45px; height: 45px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; z-index: 10011;">
        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: white;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </div>

    <div style="width:100%; max-width:900px; position:relative; padding: 20px;">
        <div style="background:black; width:100%; aspect-ratio:16/9; border-radius:24px; overflow:hidden; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); position:relative;">

            <!-- Native Video (Backblaze B2) -->
            <video id="video-direct" style="width:100%; height:100%; display:none; object-fit:cover;" controls playsinline crossorigin="anonymous"></video>

            <!-- Poster Overlay -->
            <div id="video-poster" onclick="playVideo()" style="position:absolute; inset:0; background-size:cover; background-position:center; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:10; background-color: #0f172a;">
                 <div style="width:70px; height:70px; background:rgba(0,0,0,0.6); border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid rgba(255,255,255,0.8); backdrop-filter:blur(4px); transition: transform 0.2s;">
                      <svg viewBox="0 0 24 24" style="width:34px; height:34px; fill:white; margin-left:4px;"><path d="M8 5v14l11-7z"/></svg>
                 </div>
            </div>

        </div>
        
        <div style="margin-top:25px; text-align:center;">
             <h3 id="video-modal-title" style="color:white; margin:0; font-size:1.1rem; font-weight:600; opacity:0.9; letter-spacing: 0.5px;">Exercise Video</h3>
        </div>
    </div>
</div>

<!-- DBZ Character Decorations (Male Only) -->
<div id="dbz-decorations" style="display:none;">
    <img src="assets/goku-ssj.webp" alt="Goku Super Saiyan" class="dbz-character-corner" id="dbz-goku" />
    <img src="assets/vegeta-ssj.webp" alt="Vegeta Super Saiyan" class="dbz-character-corner" id="dbz-vegeta" style="display:none;" />
    <img src="assets/dbz-lightning.svg" alt="Lightning" class="dbz-lightning-left" />
    <img src="assets/dbz-lightning.svg" alt="Lightning" class="dbz-lightning-right" />
</div>

<!-- Flower Garden Decorations (Female users only) -->
<div id="flower-decorations" style="display:none;">
    <img src="assets/flower-cherry-blossom.svg" alt="Cherry Blossom" class="flower-corner flower-top-right" />
    <img src="assets/flower-rose.svg" alt="Rose" class="flower-corner flower-bottom-left" />
    <img src="assets/flower-peony.svg" alt="Peony" class="flower-corner flower-top-left" />
    <img src="assets/flower-daisy.svg" alt="Daisy" class="flower-corner flower-bottom-right" />
</div>

<!-- Sailor Moon Character Decorations (Female Only) -->
<div id="sailor-decorations" style="display:none;">
    <img src="assets/sailor-moon-character.svg" alt="Sailor Moon" class="sailor-character-corner" id="sailor-moon-character" />
    <img src="assets/sailor-venus-character.svg" alt="Sailor Venus" class="sailor-character-corner" id="sailor-venus-character" style="display:none;" />
    <img src="assets/sailor-star.svg" alt="Star" class="sailor-star-left" />
    <img src="assets/sailor-star.svg" alt="Star" class="sailor-star-right" />
    <img src="assets/sailor-heart.svg" alt="Heart" class="sailor-heart-float" />
</div>

<!-- PWA INSTALL BANNER (Fixed Floating) -->
<!-- PWA INSTALL BANNER (Moved to TOP) -->
<div id="pwa-install-banner" style="display:none; position:fixed; top:0; left:0; width:100%; background:#046A38 !important; color:white; font-size:0.9rem; padding:12px 20px; z-index:99999; box-shadow:0 4px 15px rgba(0,0,0,0.2); align-items:center; justify-content:space-between;">
    <div style="display:flex; align-items:center; gap:12px;">
        <span style="font-size:1.2rem;">📲</span>
        <span style="font-weight:600;">Install App for Best Experience</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="dismissInstall()" style="background:transparent; border:1px solid rgba(255,255,255,0.4); color:white; padding:6px 12px; border-radius:20px; font-size:70%; font-weight:600; cursor:pointer;">LATER</button>
        <button class="pwa-install-btn" onclick="installPWA(this)" data-original-text="INSTALL" style="background:white; color:var(--primary); border:none; padding:6px 16px; border-radius:20px; font-size:0.8rem; font-weight:700; box-shadow:0 2px 10px rgba(0,0,0,0.1); cursor:pointer; min-width:80px;">INSTALL</button>
    </div>
</div>

<script src="exercise_videos.js"></script>
<script src="workout_library.js"></script>
<script src="workout_library_extended.js"></script>
<script>
// Merge extended library into main library
if (typeof WORKOUT_LIBRARY !== 'undefined' && typeof WORKOUT_LIBRARY_EXTENDED !== 'undefined') {
    // Merge yoga, bodyweight, and home libraries
    WORKOUT_LIBRARY.yoga = WORKOUT_LIBRARY_EXTENDED.yoga;
    WORKOUT_LIBRARY.bodyweight = WORKOUT_LIBRARY_EXTENDED.bodyweight;
    WORKOUT_LIBRARY.home = WORKOUT_LIBRARY_EXTENDED.home;
}
</script>
<script>
// Video Logic
let currentVideoUrl = '';

function findVideoMatch(name) {
    if(EXERCISE_VIDEOS[name]) return EXERCISE_VIDEOS[name];

    // Clean name logic: Remove common prefixes and trim
    const cleanName = name.replace(/(Dumbbell|Barbell|Body Weight|Band|Cable|Machine) /gi, '').trim();
    if(EXERCISE_VIDEOS[cleanName]) return EXERCISE_VIDEOS[cleanName];

    // Fuzzy Search (Simple Includes)
    const keys = Object.keys(EXERCISE_VIDEOS);
    
    // 1. Try to find a key that CONTAINS the clean name
    const partialMatch = keys.find(k => k.toLowerCase().includes(cleanName.toLowerCase()));
    if(partialMatch) return EXERCISE_VIDEOS[partialMatch];
    
    // 2. Try to find a key that is CONTAINED BY the clean name
    const reverseMatch = keys.find(k => cleanName.toLowerCase().includes(k.toLowerCase()));
    if(reverseMatch) return EXERCISE_VIDEOS[reverseMatch];

    return '';
}

// Inline video playback for workout cards
let currentInlineVideo = null;

function playInlineVideo(event, videoUrl) {
    event.stopPropagation();
    event.preventDefault();

    // Get the container that was clicked
    const container = event.currentTarget;
    const video = container.querySelector('video');
    const playOverlay = container.querySelector('.inline-play-overlay');

    if (!video || !videoUrl) return;

    // Stop any other playing inline video
    if (currentInlineVideo && currentInlineVideo !== video) {
        stopInlineVideo(currentInlineVideo);
    }

    // Check if video is already playing - if so, pause it
    if (!video.paused) {
        video.pause();
        if (playOverlay) playOverlay.style.display = 'flex';
        video.controls = false;
        currentInlineVideo = null;
        return;
    }

    // Hide play overlay and show controls
    if (playOverlay) playOverlay.style.display = 'none';
    video.controls = true;
    video.muted = false;

    // Set source directly on video element (currentSrc may be from source tag)
    if (!video.currentSrc || !video.currentSrc.includes('backblazeb2')) {
        video.src = videoUrl;
    }

    // Play the video
    video.play().catch(e => {
        console.error("Inline video play error:", e);
        if (playOverlay) playOverlay.style.display = 'flex';
        video.controls = false;
    });

    currentInlineVideo = video;

    // Listen for video end to reset
    video.onended = function() {
        if (playOverlay) playOverlay.style.display = 'flex';
        video.controls = false;
        video.currentTime = 0;
        currentInlineVideo = null;
    };

    // Listen for pause to show overlay
    video.onpause = function() {
        if (video.ended) return;
        // Small delay to allow user to use controls
        setTimeout(() => {
            if (video.paused && !video.ended) {
                if (playOverlay) playOverlay.style.display = 'flex';
            }
        }, 100);
    };
}

function stopInlineVideo(video) {
    if (!video) return;
    video.pause();
    video.currentTime = 0;
    video.controls = false;
    const container = video.closest('[data-video-container]');
    if (container) {
        const playOverlay = container.querySelector('.inline-play-overlay');
        if (playOverlay) playOverlay.style.display = 'flex';
    }
}

// =====================
// YOGA TIMER FUNCTIONS
// =====================

// Parse yoga time string (e.g., "2 min", "45 sec each", "5 breaths") to seconds
function parseYogaTimeToSeconds(timeStr) {
    if (!timeStr) return 60; // default 1 min

    const str = timeStr.toLowerCase().trim();

    // Handle "X breaths" - assume 5 seconds per breath
    const breathMatch = str.match(/(\d+)\s*breaths?/);
    if (breathMatch) {
        return parseInt(breathMatch[1]) * 5;
    }

    // Handle "X min" or "X minutes"
    const minMatch = str.match(/(\d+)\s*min/);
    if (minMatch) {
        return parseInt(minMatch[1]) * 60;
    }

    // Handle "X sec" or "X seconds"
    const secMatch = str.match(/(\d+)\s*sec/);
    if (secMatch) {
        return parseInt(secMatch[1]);
    }

    // Default to 60 seconds if unparseable
    return 60;
}

// Format seconds to display string (MM:SS)
function formatYogaTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${String(secs).padStart(2, '0')}`;
}

// Global yoga timer state
window.yogaTimers = {};

// Start yoga timer for a specific exercise
function startYogaTimer(exerciseIdx) {
    const timer = window.yogaTimers[exerciseIdx];
    if (!timer) return;

    const timerDisplay = document.getElementById(`yoga-timer-display-${exerciseIdx}`);
    const startBtn = document.getElementById(`yoga-timer-start-${exerciseIdx}`);
    const pauseBtn = document.getElementById(`yoga-timer-pause-${exerciseIdx}`);
    const resetBtn = document.getElementById(`yoga-timer-reset-${exerciseIdx}`);
    const progressRing = document.getElementById(`yoga-timer-progress-${exerciseIdx}`);

    if (timer.interval) {
        clearInterval(timer.interval);
    }

    timer.isRunning = true;
    startBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-flex';
    resetBtn.style.display = 'inline-flex';

    timer.interval = setInterval(() => {
        timer.remaining--;

        if (timer.remaining <= 0) {
            timer.remaining = 0;
            clearInterval(timer.interval);
            timer.interval = null;
            timer.isRunning = false;

            // Timer complete - play sound and show completion
            timerDisplay.textContent = '0:00';
            timerDisplay.style.color = 'var(--primary)';
            startBtn.textContent = '✓ Done';
            startBtn.style.display = 'inline-flex';
            startBtn.style.background = 'var(--primary)';
            startBtn.disabled = true;
            pauseBtn.style.display = 'none';

            // Update progress ring
            if (progressRing) {
                progressRing.style.strokeDashoffset = '0';
            }

            // Play completion sound if available
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU');
            } catch(e) {}

            // Vibrate on mobile if available
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }

            return;
        }

        timerDisplay.textContent = formatYogaTime(timer.remaining);

        // Update progress ring
        if (progressRing) {
            const circumference = 2 * Math.PI * 54; // radius 54
            const progress = timer.remaining / timer.total;
            const offset = circumference * progress;
            progressRing.style.strokeDashoffset = offset;
        }
    }, 1000);
}

// Pause yoga timer
function pauseYogaTimer(exerciseIdx) {
    const timer = window.yogaTimers[exerciseIdx];
    if (!timer) return;

    if (timer.interval) {
        clearInterval(timer.interval);
        timer.interval = null;
    }
    timer.isRunning = false;

    const startBtn = document.getElementById(`yoga-timer-start-${exerciseIdx}`);
    const pauseBtn = document.getElementById(`yoga-timer-pause-${exerciseIdx}`);

    startBtn.textContent = 'Resume';
    startBtn.style.display = 'inline-flex';
    pauseBtn.style.display = 'none';
}

// Reset yoga timer
function resetYogaTimer(exerciseIdx) {
    const timer = window.yogaTimers[exerciseIdx];
    if (!timer) return;

    if (timer.interval) {
        clearInterval(timer.interval);
        timer.interval = null;
    }
    timer.remaining = timer.total;
    timer.isRunning = false;

    const timerDisplay = document.getElementById(`yoga-timer-display-${exerciseIdx}`);
    const startBtn = document.getElementById(`yoga-timer-start-${exerciseIdx}`);
    const pauseBtn = document.getElementById(`yoga-timer-pause-${exerciseIdx}`);
    const resetBtn = document.getElementById(`yoga-timer-reset-${exerciseIdx}`);
    const progressRing = document.getElementById(`yoga-timer-progress-${exerciseIdx}`);

    timerDisplay.textContent = formatYogaTime(timer.total);
    timerDisplay.style.color = 'var(--text-main)';
    startBtn.textContent = 'Start';
    startBtn.style.display = 'inline-flex';
    startBtn.style.background = 'var(--primary)';
    startBtn.disabled = false;
    pauseBtn.style.display = 'none';
    resetBtn.style.display = 'none';

    // Reset progress ring
    if (progressRing) {
        const circumference = 2 * Math.PI * 54;
        progressRing.style.strokeDashoffset = circumference;
    }
}

// Clear all yoga timers when leaving workout
function clearAllYogaTimers() {
    Object.keys(window.yogaTimers).forEach(key => {
        const timer = window.yogaTimers[key];
        if (timer && timer.interval) {
            clearInterval(timer.interval);
        }
    });
    window.yogaTimers = {};
}

let pendingVideoUrl = '';

function playVideo() {
    const direct = document.getElementById('video-direct');
    const poster = document.getElementById('video-poster');

    if(poster) poster.style.display = 'none';

    // Play Backblaze B2 video in native player
    if (direct && pendingVideoUrl) {
        direct.style.display = 'block';
        direct.src = pendingVideoUrl;
        direct.play().catch(e => {
            console.error("Video play error:", e);
            alert("Unable to play video. The video file may not be accessible.");
        });
    }
}

function openExerciseVideo(url, title, autoplay = false) {
    console.log("Opening video for:", title);

    // 1. Resolve URL if missing
    if (!url) {
        url = findVideoMatch(title);
        if(!url) {
            console.log("No video found for:", title);
            alert("Video coming soon for: " + title);
            return;
        }
    }

    // 2. Check if this is a Google Drive video (not yet migrated)
    if (url.includes('drive.google.com')) {
        alert(`This video hasn't been migrated yet.\n\n"${title}" is still on Google Drive and needs to be uploaded to Backblaze B2.\n\nPlease check the migration list.`);
        console.log("Google Drive video not migrated:", title, url);
        return;
    }

    // 3. Only support Backblaze B2 and direct video files
    if (!url.includes('backblazeb2.com') && !url.match(/\.(mp4|mov|webm)$/i)) {
        alert(`Unsupported video format.\n\nOnly Backblaze B2 videos are supported. This video needs to be migrated: "${title}"`);
        console.log("Unsupported video format:", title, url);
        return;
    }

    // 4. Setup video for Backblaze B2
    let embedUrl = url;
    let viewUrl = url;
    let type = 'b2'; // Backblaze B2 native video

    // 5. Setup Modal State
    currentVideoUrl = viewUrl;
    pendingVideoUrl = embedUrl;
    window.pendingVideoType = type;

    // 6. Setup Modal
    const modal = document.getElementById('video-modal');
    const direct = document.getElementById('video-direct');
    const poster = document.getElementById('video-poster');
    const titleEl = document.getElementById('video-modal-title');

    if(titleEl) titleEl.innerText = title;

    // Reset video player
    if(direct) {
        direct.src = '';
        direct.style.display = 'none';
    }

    // Show poster with play button
    if(poster) {
        poster.style.display = 'flex';
        poster.style.backgroundImage = 'none'; // B2 videos don't have thumbnails
    }

    modal.style.display = 'flex';

    // Autoplay and auto-close for Easter egg videos
    if (autoplay && direct) {
        // Auto-play the video after a short delay
        setTimeout(() => {
            playVideo();

            // Add event listener to close modal when video ends
            const handleVideoEnd = () => {
                closeVideoModal();
                direct.removeEventListener('ended', handleVideoEnd);
            };
            direct.addEventListener('ended', handleVideoEnd);
        }, 500);
    }
}

function openVideoNewTab() {
    if(currentVideoUrl) window.open(currentVideoUrl, '_blank');
}

function closeVideoModal() {
    const modal = document.getElementById('video-modal');
    const direct = document.getElementById('video-direct');

    modal.style.display = 'none';

    // Stop video player
    if(direct) {
        direct.pause();
        direct.src = '';
    }
}

// Close on background click
document.getElementById('video-modal').addEventListener('click', function(e) {
    if (e.target === this) closeVideoModal();
});
</script>

<script>
// --- COACH CHAT ENHANCEMENTS ---

// 1. Office Hours Config (Brisbane Time)
const COACH_CONFIG = {
    timezone: 'Australia/Brisbane',
    startHour: 7,    // 7 AM
    endHour: 20,     // 8 PM
    endMin: 30       // :30
};

function getCoachState() {
    try {
        const now = new Date();
        const bneTimeStr = now.toLocaleString("en-US", {timeZone: COACH_CONFIG.timezone});
        const bneTime = new Date(bneTimeStr);
        
        const totalMins = bneTime.getHours() * 60 + bneTime.getMinutes();
        const startMins = COACH_CONFIG.startHour * 60;
        const endMins = COACH_CONFIG.endHour * 60 + COACH_CONFIG.endMin;
        
        const isOnline = totalMins >= startMins && totalMins < endMins;
        return { isOnline, totalMins };
    } catch(e) {
        return { isOnline: true }; // Fail-safe
    }
}

function updateCoachUI() {
    const { isOnline } = getCoachState();
    const headerStatus = document.getElementById('coach-header-status-text');

    const color = isOnline ? '#22c55e' : '#94a3b8'; // Green vs Slate
    const text = isOnline ? 'Active Now' : 'Offline (Back 7am)';

    if(headerStatus) {
        headerStatus.innerText = text;
        headerStatus.style.color = isOnline ? 'var(--primary)' : '#64748b';
    }

    // Also update the coach modal status
    const modalStatus = document.getElementById('coach-modal-status');
    if (modalStatus) {
        modalStatus.innerText = isOnline ? 'Coach - Active Now' : 'Coach - Offline';
        modalStatus.style.color = isOnline ? 'var(--primary)' : '#64748b';
    }
}

// Coach chat now uses direct messaging - no AI trigger needed

// 3. Daily Greeting
// Daily greeting removed - coach now responds only when user messages
async function checkCoachGreeting() {
    // Function kept for compatibility but no longer sends automated greetings
    return;
}

// 4. Bubble Interaction
function openCoachChat() {
    openCoachChatModal();
}

// 5. Push Notifications - Subscribe ALL users to server push
async function requestNotificationPermission() {
    if (!('Notification' in window) || !('serviceWorker' in navigator)) {
        console.log('Push notifications not supported');
        return;
    }

    // Check if permission already granted
    if (Notification.permission === 'granted') {
        // Auto-subscribe to push if permission already granted
        await subscribeUserToPush();
        return;
    }

    // Only request if not already denied
    if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted');
            await subscribeUserToPush();
        }
    }
}

// Subscribe user to server push notifications (for receiving DMs, etc.)
async function subscribeUserToPush() {
    try {
        if (!window.currentUser) return;

        const registration = await navigator.serviceWorker.ready;

        // Check if already subscribed
        let subscription = await registration.pushManager.getSubscription();

        if (!subscription) {
            // Subscribe to push
            subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });
        }

        // Save subscription to database
        const subscriptionJson = subscription.toJSON();
        const isAdmin = await db.pushSubscriptions.isAdmin();

        await db.pushSubscriptions.subscribe({
            endpoint: subscriptionJson.endpoint,
            keys: {
                p256dh: subscriptionJson.keys.p256dh,
                auth: subscriptionJson.keys.auth
            }
        }, isAdmin);

        console.log('User subscribed to push notifications');
    } catch (error) {
        console.error('Failed to subscribe to push notifications:', error);
    }
}

/**
 * Toggle user notifications preference
 */
window.toggleUserNotifications = async function(enabled) {
    localStorage.setItem('user_notifications_enabled', enabled ? 'true' : 'false');

    if (enabled) {
        // Request permission if enabling
        if ('Notification' in window && Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                // Revert toggle if permission denied
                const toggle = document.getElementById('user-notifications-toggle');
                if (toggle) toggle.checked = false;
                localStorage.setItem('user_notifications_enabled', 'false');
                alert('Please enable notifications in your browser settings to receive coach message alerts.');
                return;
            }
        }
    }

    console.log('User notifications:', enabled ? 'enabled' : 'disabled');
};

/**
 * Initialize user notification toggle state
 */
function initUserNotificationToggle() {
    const toggle = document.getElementById('user-notifications-toggle');
    if (toggle) {
        const enabled = localStorage.getItem('user_notifications_enabled') !== 'false'; // Default to true
        toggle.checked = enabled;
    }
}

async function sendCoachNotification(messageText) {
    // Check if user has disabled notifications
    if (localStorage.getItem('user_notifications_enabled') === 'false') {
        return;
    }

    // Check if notifications are supported and permitted
    if (!('Notification' in window) || Notification.permission !== 'granted') {
        return;
    }

    // Only send notification if app is in background
    if (document.visibilityState === 'hidden') {
        try {
            const registration = await navigator.serviceWorker.ready;

            // Truncate long messages for notification
            const displayText = messageText.length > 100
                ? messageText.substring(0, 100) + '...'
                : messageText;

            await registration.showNotification('Coach Shannon', {
                body: displayText,
                icon: './assets/coach_shannon.jpg',
                badge: './assets/Logo_dots.jpg',
                vibrate: [200, 100, 200],
                tag: 'coach-message',
                requireInteraction: false,
                data: {
                    url: './dashboard.html'
                }
            });
        } catch (error) {
            console.error('Error sending notification:', error);
        }
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updateCoachUI();
    setInterval(updateCoachUI, 1000); // Check every second for visibility toggle
    // Removed: setTimeout(checkCoachGreeting, 2000); - no more automated greetings
    requestNotificationPermission();
    initUserNotificationToggle();
});

// Immediate
updateCoachUI();

// 5. Welcome Modal Logic (REMOVED - Using original onboarding-modal instead)
// setTimeout(() => { ... }, 1000);
</script>
<!-- WORKOUT BUILDER VIEW -->
<div id="view-workout-builder" class="app-view" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:500; overflow-y:auto; padding-bottom: 100px;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
        <div style="font-weight: 700; font-size: 1.2rem;">Build Workout</div>
        <div onclick="switchAppTab('movement-tab')" style="cursor:pointer; color:var(--text-muted); font-weight:600;">Close</div>
    </div>

    <div style="padding: 20px;">
        <div style="position:relative; margin-bottom: 20px;">
            <input type="text" id="builder-search" placeholder="Search 1800+ exercises..." onkeyup="filterExerciseLibrary(this.value)"
                   style="width:100%; padding:15px 15px 15px 45px; border-radius:16px; border:1px solid #e2e8f0; font-size:1rem; background: #f8fafc;">
            <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#94a3b8; position:absolute; left:15px; top:50%; transform:translateY(-50%);"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </div>

        <!-- Exercise Filters -->
        <div style="margin-bottom: 20px;">
            <!-- Workout Type Filter -->
            <div style="margin-bottom: 8px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                <div onclick="toggleFilterSection('workoutType')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: #334155;">Workout Type</div>
                    <svg id="chevron-workoutType" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #64748b; transition: transform 0.2s;">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
                <div id="filter-content-workoutType" style="display: none; padding: 12px; background: white;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="toggleFilter('workoutType', 'yoga')" class="filter-chip" data-category="workoutType" data-value="yoga" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Yoga</button>
                        <button onclick="toggleFilter('workoutType', 'pilates')" class="filter-chip" data-category="workoutType" data-value="pilates" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Pilates</button>
                        <button onclick="toggleFilter('workoutType', 'cardio')" class="filter-chip" data-category="workoutType" data-value="cardio" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Cardio</button>
                        <button onclick="toggleFilter('workoutType', 'stretch')" class="filter-chip" data-category="workoutType" data-value="stretch" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Stretch</button>
                    </div>
                </div>
            </div>

            <!-- Equipment Filter -->
            <div style="margin-bottom: 8px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                <div onclick="toggleFilterSection('equipment')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: #334155;">Equipment</div>
                    <svg id="chevron-equipment" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #64748b; transition: transform 0.2s;">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
                <div id="filter-content-equipment" style="display: none; padding: 12px; background: white;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="toggleFilter('equipment', 'bodyweight')" class="filter-chip" data-category="equipment" data-value="bodyweight" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Bodyweight</button>
                        <button onclick="toggleFilter('equipment', 'dumbbell')" class="filter-chip" data-category="equipment" data-value="dumbbell" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Dumbbell</button>
                        <button onclick="toggleFilter('equipment', 'barbell')" class="filter-chip" data-category="equipment" data-value="barbell" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Barbell</button>
                        <button onclick="toggleFilter('equipment', 'cable')" class="filter-chip" data-category="equipment" data-value="cable" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Cable</button>
                        <button onclick="toggleFilter('equipment', 'band')" class="filter-chip" data-category="equipment" data-value="band" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Band</button>
                        <button onclick="toggleFilter('equipment', 'kettlebell')" class="filter-chip" data-category="equipment" data-value="kettlebell" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Kettlebell</button>
                        <button onclick="toggleFilter('equipment', 'machine')" class="filter-chip" data-category="equipment" data-value="machine" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Machine</button>
                    </div>
                </div>
            </div>

            <!-- Muscle Group Filter -->
            <div style="margin-bottom: 8px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                <div onclick="toggleFilterSection('muscle')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: #334155;">Muscle Group</div>
                    <svg id="chevron-muscle" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #64748b; transition: transform 0.2s;">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
                <div id="filter-content-muscle" style="display: none; padding: 12px; background: white;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="toggleFilter('muscle', 'chest')" class="filter-chip" data-category="muscle" data-value="chest" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Chest</button>
                        <button onclick="toggleFilter('muscle', 'back')" class="filter-chip" data-category="muscle" data-value="back" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Back</button>
                        <button onclick="toggleFilter('muscle', 'shoulders')" class="filter-chip" data-category="muscle" data-value="shoulders" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Shoulders</button>
                        <button onclick="toggleFilter('muscle', 'arms')" class="filter-chip" data-category="muscle" data-value="arms" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Arms</button>
                        <button onclick="toggleFilter('muscle', 'core')" class="filter-chip" data-category="muscle" data-value="core" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Core</button>
                        <button onclick="toggleFilter('muscle', 'legs')" class="filter-chip" data-category="muscle" data-value="legs" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Legs</button>
                        <button onclick="toggleFilter('muscle', 'glutes')" class="filter-chip" data-category="muscle" data-value="glutes" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Glutes</button>
                    </div>
                </div>
            </div>

            <!-- Clear Filters Button -->
            <div id="clear-filters-btn" style="display: none; margin-top: 12px;">
                <button onclick="clearAllFilters()" style="width: 100%; padding: 10px; border-radius: 12px; border: 1.5px solid #ef4444; background: #fef2f2; color: #ef4444; font-size: 0.85rem; font-weight: 700; cursor: pointer;">Clear All Filters</button>
            </div>
        </div>

        <div id="builder-library-list" style="display:flex; flex-direction:column; gap:10px;">
            <!-- Dynamic Content -->
        </div>
    </div>
    
    <div id="builder-floating-action" style="position:fixed; bottom:0; left:0; right:0; width:100%; padding:20px; display:none; z-index: 1000; background: white; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); pointer-events: auto;">
        <div style="display:flex; gap:10px;">
            <button onclick="saveCustomBuilderWorkout()" style="flex:1; background:white; color:var(--primary); border:2px solid var(--primary); padding:18px; border-radius:50px; font-weight:800; box-shadow:0 10px 25px rgba(0,0,0,0.05); font-size: 1.1rem; cursor:pointer; min-height:56px; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1); -webkit-touch-callout: none; user-select: none; position: relative;">
                SAVE
            </button>
            <button onclick="startCustomBuilderWorkout()" style="flex:2; background:var(--primary); color:white; padding:18px; border-radius:50px; font-weight:800; border:none; box-shadow:0 10px 25px rgba(4,106,56,0.3); font-size: 1.1rem; cursor:pointer; min-height:56px; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1); -webkit-touch-callout: none; user-select: none; position: relative;">
                START (<span id="builder-count">0</span>)
            </button>
        </div>
    </div>
    
    <script>
    async function saveCustomBuilderWorkout() {
        if (customWorkoutSelection.length === 0) return;
        const name = prompt("Name your workout:");
        if(!name) return;
        
        try {
            const user = window.currentUser;
            if(user) {
                 await dbHelpers.workouts.saveCustomWorkout(user.id, name, { 
                     exercises: customWorkoutSelection,
                     date: new Date().toISOString()
                 });
                 alert("Workout saved! You can find it in the Movement tab.");
                 switchAppTab('movement-tab');
                 renderMovementView(); // refresh list
            }
        } catch(e) {
            console.error("Failed to save workout:", e);
            alert("Failed to save workout. Please try again.");
        }
    }
    </script>
</div>
<script>
    async function startSavedWorkout(id) {
        // Use cache populated by renderMovementView
        const saved = window.savedWorkoutsCache || [];
        const workout = saved.find(w => w.id === id);
        if(!workout) return;

        // Track current custom workout ID so we can update it later with added exercises
        window.currentCustomWorkoutId = id;
        window.currentWorkoutName = workout.template_name || 'Custom Workout';

        // Preload workout history for previous stats and volume tracking
        const user = window.currentUser;
        if (user) {
            try {
                const rawHistory3 = await dbHelpers.workouts.getHistory(user.id);
                window.workoutHistoryCache = normalizeHistoryCache(rawHistory3);
            } catch(e) {
                console.error("Failed to load workout history", e);
            }
        }

        // Preload personal bests
        const exerciseNames = workout.template_data?.exercises || [];
        if (user) {
            try {
                window.personalBestsCache = await dbHelpers.personalBests.getForExercises(user.id, exerciseNames);
            } catch(e) { console.error("Failed to load personal bests", e); window.personalBestsCache = {}; }
        }

        // Map DB format to Player format
        // workout.template_data.exercises is array of strings (names)

        const customWorkout = {
            title: workout.template_name || 'Custom Workout',
            name: workout.template_name || 'Custom Workout',
            description: 'Saved Session • ' + new Date(workout.created_at || new Date()).toLocaleDateString(),
            exercises: exerciseNames.map(key => ({
                name: key,
                sets: 3,
                reps: '12',
                videoUrl: '',
                desc: ''
            }))
        };

        // Hijack the player
        document.getElementById('workout-player-title').innerText = customWorkout.title;
        document.getElementById('workout-player-goal').innerText = customWorkout.description;

        const list = document.getElementById('workout-exercises-list');
        list.innerHTML = '';

        customWorkout.exercises.forEach((ex, idx) => {
            const card = document.createElement('div');
            card.className = 'exercise-logger-card';
            card.setAttribute('data-exercise-name', ex.name);
            card.setAttribute('data-is-user-added', 'false');
            card.style.cssText = "background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9;";
            const videoUrl = findVideoMatch(ex.name);
            const previousSummaryHtml = formatPreviousWorkoutSummary(ex.name);
            const previousSummary = getPreviousWorkoutSummary(ex.name);
            const escapedName = ex.name.replace(/'/g, "\\'");
            const numSets = previousSummary && previousSummary.setCount > 0 ? previousSummary.setCount : 3;
            const setsHtml = Array.from({length: numSets}, (_, i) => {
                const prevSet = previousSummary && previousSummary.sets[i] ? previousSummary.sets[i] : null;
                return getSetRowHtml(ex.name, i + 1, false, prevSet);
            }).join('');

            card.innerHTML = `
            <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0 0 5px 0; font-size:1.05rem; font-weight:700; color:var(--text-main);">${ex.name}</h3>
                <div style="font-size:0.8rem; color:var(--text-muted);">Target: ${numSets} Sets x 12 Reps</div>
                ${previousSummaryHtml}
            </div>

            ${videoUrl ? `
            <div data-video-container style="position:relative; width:100%; padding-top:56.25%; background:black; cursor:pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:60px; height:60px; background:rgba(255,255,255,0.9); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width:30px; height:30px; fill:var(--primary); margin-left:3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            ${getVolumeDisplayHtml(ex.name)}

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr 32px 32px; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div><div></div><div></div>
            </div>

            <div class="sets-list-container">
                ${setsHtml}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${escapedName}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>`;
            list.appendChild(card);

            // Setup volume tracking for this card
            setupVolumeTracking(card);
        });

        hideAllAppViews();
        document.getElementById('view-active-workout').style.display = 'block';
        window.activeWorkoutSessions = customWorkout;

        // Start the workout timer
        startWorkoutTimer();

        // Push navigation state for Android back button
        pushNavigationState('view-active-workout', () => quitWorkout());

        // Show total volume popup and tracker
        showLastVolumePopup();
    }

    async function showWorkoutHistoryDetail(dateStr) {
        // Fetch workout history for this specific date
        const user = window.currentUser;
        if (!user) return;

        try {
            const { data, error } = await window.supabaseClient
                .from('workouts')
                .select('exercise_name, set_number, reps, weight_kg, time_duration')
                .eq('user_id', user.id)
                .eq('workout_type', 'history')
                .eq('workout_date', dateStr)
                .order('exercise_name')
                .order('set_number');

            if (error) throw error;
            if (!data || data.length === 0) {
                alert('No workout data found for this date.');
                return;
            }

            // Group by exercise
            const exercises = {};
            data.forEach(row => {
                if (!exercises[row.exercise_name]) {
                    exercises[row.exercise_name] = [];
                }
                exercises[row.exercise_name].push(row);
            });

            // Format date for display
            const dateObj = new Date(dateStr + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            // Build modal content
            let content = `
            <div class="workout-summary-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;" onclick="if(event.target === this) this.remove();">
                <div style="background:white; border-radius:24px; max-width:400px; width:100%; max-height:80vh; overflow-y:auto; box-shadow:0 25px 50px rgba(0,0,0,0.25);">
                    <div style="padding:25px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2 style="margin:0 0 5px 0; font-size:1.3rem; color:var(--text-main);">Workout Summary</h2>
                            <div style="font-size:0.85rem; color:var(--text-muted);">${formattedDate}</div>
                        </div>
                        <button onclick="this.closest('.workout-summary-modal').remove()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
                    </div>
                    <div style="padding:20px;">
            `;

            Object.entries(exercises).forEach(([name, sets]) => {
                content += `
                    <div style="margin-bottom:20px;">
                        <h4 style="margin:0 0 10px 0; font-size:0.95rem; color:var(--primary);">${name}</h4>
                        <div style="background:#f8fafc; border-radius:12px; padding:10px;">
                `;
                sets.forEach(set => {
                    const weightDisplay = set.weight_kg ? `${set.weight_kg} kg` : '-';
                    const repsDisplay = set.reps || '-';
                    const timeDisplay = set.time_duration || '';
                    content += `
                        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #e2e8f0; font-size:0.85rem;">
                            <span style="color:var(--text-muted);">Set ${set.set_number}</span>
                            <span style="color:var(--text-main);">${weightDisplay} × ${repsDisplay} reps${timeDisplay ? ' • ' + timeDisplay : ''}</span>
                        </div>
                    `;
                });
                content += `
                        </div>
                    </div>
                `;
            });

            content += `
                    </div>
                </div>
            </div>
            `;

            document.body.insertAdjacentHTML('beforeend', content);
        } catch (err) {
            console.error('Failed to load workout history detail:', err);
            alert('Failed to load workout details.');
        }
    }
</script>

<!-- Check-in modal functions - must be defined before modal HTML -->
<script>
// checkInProgress will be defined later, use window reference for safety
if (typeof window.checkInProgress === 'undefined') {
    window.checkInProgress = { flow: null, symptoms: [], mood: null, energy: null, fluid: null, equipment: null, recovery: null };
}

function selectCheckInOption(category, value, el) {
    window.checkInProgress[category] = value;
    const options = document.querySelectorAll('.check-in-chip[data-group="' + category + '"]');
    options.forEach(function(opt) { opt.classList.remove('selected'); });
    el.classList.add('selected');
}

function toggleCheckInOption(category, value, el) {
    if (!window.checkInProgress[category]) window.checkInProgress[category] = [];
    var idx = window.checkInProgress[category].indexOf(value);
    if (idx > -1) {
        window.checkInProgress[category].splice(idx, 1);
        el.classList.remove('selected');
    } else {
        window.checkInProgress[category].push(value);
        el.classList.add('selected');
    }
}

function openCheckInModal() {
    if (typeof applyGenderSpecificUI === 'function') {
        applyGenderSpecificUI();
    }
    document.getElementById('check-in-modal').style.display = 'flex';
}

function closeCheckInModal() {
    document.getElementById('check-in-modal').style.display = 'none';
}

// Full implementation of submitDailyCycleSync
async function submitDailyCycleSync() {
    try {
        // 1. Save Log locally
        const today = new Date().toISOString().split('T')[0];
        if (typeof userCycleData === 'undefined') {
            window.userCycleData = JSON.parse(localStorage.getItem('userCycleData') || '{}');
        }
        if (!userCycleData.logs) userCycleData.logs = {};

        // Clone to avoid ref issues and add timestamp for priority comparisons
        userCycleData.logs[today] = JSON.parse(JSON.stringify(window.checkInProgress));
        userCycleData.logs[today].timestamp = new Date().toISOString();

        // Update userCycleData.symptoms from check-in
        userCycleData.symptoms = window.checkInProgress.symptoms || [];

        // Persist to localStorage
        localStorage.setItem('userCycleData', JSON.stringify(userCycleData));

        // 2. Save to Supabase
        if (window.currentUser && typeof dbHelpers !== 'undefined') {
            try {
                await dbHelpers.checkins.upsert(window.currentUser.id, today, {
                    energy: window.checkInProgress.energy || null,
                    equipment: window.checkInProgress.equipment || null,
                    additional_data: {
                        symptoms: window.checkInProgress.symptoms || [],
                        mood: window.checkInProgress.mood || null,
                        flow: window.checkInProgress.flow || null,
                        fluid: window.checkInProgress.fluid || null,
                        recovery: window.checkInProgress.recovery || null
                    }
                });
                console.log('✅ Check-in saved to Supabase');
            } catch (e) {
                console.error('Failed to save check-in to DB:', e);
            }
        }

        // Mark check-in as completed for today
        localStorage.setItem('lastWellnessCheck', new Date().toDateString());

        // Save equipment selection
        if (window.checkInProgress.equipment && window.currentUser && typeof dbHelpers !== 'undefined') {
            try {
                await window.supabaseClient.from('quiz_results')
                    .update({ equipment_access: window.checkInProgress.equipment })
                    .eq('user_id', window.currentUser.id);

                const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                userProfile.equipment_access = window.checkInProgress.equipment;
                userProfile.gym_access = (window.checkInProgress.equipment === 'gym');
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                if (window.userProfile) {
                    window.userProfile.equipment_access = window.checkInProgress.equipment;
                    window.userProfile.gym_access = (window.checkInProgress.equipment === 'gym');
                }
                console.log('✅ Equipment access saved:', window.checkInProgress.equipment);
            } catch (e) {
                console.warn('Failed to save equipment access:', e);
            }
        }

        // Update Active Symptoms display
        const symptomsDisplay = document.getElementById('profile-symptoms-display');
        if (symptomsDisplay) {
            const symptoms = window.checkInProgress.symptoms || [];
            if (symptoms.length > 0) {
                const formattedSymptoms = symptoms.map(s =>
                    s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
                ).join(', ');
                symptomsDisplay.textContent = formattedSymptoms;
            } else {
                symptomsDisplay.textContent = 'None';
            }
        }

        // Trigger Cycle Sync Engine
        if (typeof applyCycleSync === 'function') applyCycleSync(window.checkInProgress);

        // Handle rest-indicating conditions - show yoga recommendation popup
        // IMPORTANT: Check this BEFORE refreshing views, as view refreshes may interfere
        const isMale = (typeof isMaleUser === 'function' && isMaleUser());
        const symptoms = window.checkInProgress.symptoms || [];
        let yogaPopupReason = null;

        // Debug logging for yoga popup trigger
        console.log('🧘 Yoga popup check:', {
            energy: window.checkInProgress.energy,
            recovery: window.checkInProgress.recovery,
            symptoms: symptoms,
            isMale: isMale
        });

        // Check for conditions that should trigger yoga recommendation
        if (window.checkInProgress.energy === 'low') {
            yogaPopupReason = 'low_energy';
        } else if (isMale && window.checkInProgress.recovery === 'tired') {
            yogaPopupReason = 'tired';
        } else if (isMale && window.checkInProgress.recovery === 'moderate') {
            yogaPopupReason = 'fatigued';
        } else if (isMale && symptoms.includes('muscle_soreness')) {
            yogaPopupReason = 'muscle_soreness';
        } else if (symptoms.includes('back_pain')) {
            yogaPopupReason = 'back_pain';
        } else if (!isMale && symptoms.includes('cramps')) {
            yogaPopupReason = 'cramps';
        }

        if (yogaPopupReason) {
            console.log('🧘 Triggering yoga popup with reason:', yogaPopupReason);
            // Close the check-in modal first so the yoga popup is visible
            closeCheckInModal();
            if (typeof showLowEnergyYogaPopup === 'function') showLowEnergyYogaPopup(yogaPopupReason);
            return;
        } else {
            console.log('🧘 No yoga popup needed');
        }

        // Close & Refresh views (only if no yoga popup shown)
        closeCheckInModal();
        if (typeof initCycleView === 'function') initCycleView();
        if (typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();
        if (typeof renderMovementView === 'function') renderMovementView();

        // Clear any workout override
        localStorage.removeItem('todayWorkoutOverride');
        if (userCycleData.logs && userCycleData.logs[today]) {
            delete userCycleData.logs[today].workoutOverride;
            localStorage.setItem('userCycleData', JSON.stringify(userCycleData));
        }

        if (typeof switchAppTab === 'function') switchAppTab('dashboard');
        if (typeof showCycleSyncBanner === 'function') showCycleSyncBanner();

    } catch (err) {
        console.error('Error in submitDailyCycleSync:', err);
        alert('There was an error saving your check-in. Please try again.');
    }
}

// Expose to global scope
window.selectCheckInOption = selectCheckInOption;
window.toggleCheckInOption = toggleCheckInOption;
window.openCheckInModal = openCheckInModal;
window.closeCheckInModal = closeCheckInModal;
window.submitDailyCycleSync = submitDailyCycleSync;
</script>

<!-- SUPERBOOST CHECK-IN MODAL -->
<div id="check-in-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center; padding:15px;">
    <div class="modal-content" style="background: white; width: 100%; border-radius: 24px; padding: 0; max-width: 480px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeInScale 0.2s ease-out;">
        
        <!-- Header (Fixed) -->
        <div style="padding: 20px 25px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="margin:0; font-family:'Playfair Display'; font-size: 1.5rem; color: var(--primary);">Daily Check-in</h3>
                <p style="margin:5px 0 0 0; color: var(--text-muted); font-size: 0.85rem;">Tailor your plan instantly.</p>
            </div>
            <div onclick="closeCheckInModal()" style="width:36px; height:36px; background:#f8fafc; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); font-weight:bold; transition:all 0.2s;">✕</div>
        </div>
        
        <!-- Scrollable Content -->
        <div id="check-in-questions" style="overflow-y: auto; padding: 25px; flex:1;">
            
            <!-- 1. Bleeding (Female Only) -->
            <div id="check-in-period-section" style="margin-bottom: 25px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Flow Status</label>
                <div class="check-in-options" style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'none', this)" data-group="flow">None</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'spotting', this)" data-group="flow">Spotting</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'light', this)" data-group="flow">Light 🩸</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'medium', this)" data-group="flow">Medium 🩸🩸</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('flow', 'heavy', this)" data-group="flow">Heavy 🩸🩸🩸</div>
                </div>
            </div>

            <!-- 2. Physical Symptoms -->
            <div style="margin-bottom: 25px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Physical</label>
                <div class="check-in-options" style="display:flex; flex-wrap:wrap; gap:8px;">
                     <div class="check-in-chip female-only-chip" onclick="toggleCheckInOption('symptoms', 'cramps', this)">Cramps ⚡</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'bloating', this)">Bloating 🎈</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'headache', this)">Headache 🤕</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'back_pain', this)">Back Pain 🦴</div>
                     <div class="check-in-chip female-only-chip" onclick="toggleCheckInOption('symptoms', 'tender_breasts', this)">Tender Breasts 👙</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'acne', this)">Acne / Skin 🫧</div>
                     <div class="check-in-chip" onclick="toggleCheckInOption('symptoms', 'digestion', this)">Digestion Issues 🤢</div>
                     <div class="check-in-chip male-only-chip" onclick="toggleCheckInOption('symptoms', 'muscle_soreness', this)" style="display:none;">Muscle Soreness 💪</div>
                </div>
            </div>

            <!-- 3. Mind & Energy -->
            <div style="margin-bottom: 25px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Energy & Mood</label>
                <div class="check-in-options" style="display:flex; flex-wrap:wrap; gap:8px;">
                     <div class="check-in-chip" onclick="selectCheckInOption('energy', 'high', this)" data-group="energy">High Energy ⚡</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('energy', 'medium', this)" data-group="energy">Balanced ⚖️</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('energy', 'low', this)" data-group="energy">Low / Tired 💤</div>
                     <div style="flex-basis:100%; height:8px;"></div>
                     <div class="check-in-chip" onclick="selectCheckInOption('mood', 'happy', this)" data-group="mood">Happy / Calm 😌</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('mood', 'anxious', this)" data-group="mood">Anxious 😰</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('mood', 'sad', this)" data-group="mood">Sad / Weepy 😢</div>
                     <div class="check-in-chip" onclick="selectCheckInOption('mood', 'irritated', this)" data-group="mood">Irritated 😠</div>
                </div>
            </div>

             <!-- 4. Fluid (Female Only) -->
             <div id="check-in-cervical-section" style="margin-bottom: 15px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Cervical Fluid</label>
                <div class="check-in-options" style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="check-in-chip" onclick="selectCheckInOption('fluid', 'dry', this)" data-group="fluid">Dry</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('fluid', 'sticky', this)" data-group="fluid">Sticky</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('fluid', 'creamy', this)" data-group="fluid">Creamy</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('fluid', 'egg_white', this)" data-group="fluid">Egg White 🥚</div>
                </div>
            </div>

            <!-- Recovery Section (Male Only - hidden by default) -->
            <div id="check-in-recovery-section" style="margin-bottom: 15px; display:none;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Recovery Status</label>
                <div class="check-in-options" style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="check-in-chip" onclick="selectCheckInOption('recovery', 'fresh', this)" data-group="recovery">Fully Recovered 💯</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('recovery', 'moderate', this)" data-group="recovery">Slightly Fatigued 😐</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('recovery', 'tired', this)" data-group="recovery">Need Rest 😴</div>
                </div>
            </div>

            <!-- Equipment Access Today -->
            <div style="margin-bottom: 15px;">
                <label style="display:block; font-weight:700; color:var(--text-main); margin-bottom:12px; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Equipment Access Today</label>
                <div class="check-in-options" style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="check-in-chip" onclick="selectCheckInOption('equipment', 'none', this)" data-group="equipment">Mat Only 🧘</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('equipment', 'bands', this)" data-group="equipment">Bands 🔗</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('equipment', 'dumbbells', this)" data-group="equipment">Dumbbells 🏋️</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('equipment', 'gym', this)" data-group="equipment">Full Gym 💪</div>
                    <div class="check-in-chip" onclick="selectCheckInOption('equipment', 'yoga_only', this)" data-group="equipment">Yoga Only 🧘‍♀️</div>
                </div>
            </div>

        </div>

        <!-- Footer (Fixed) -->
        <div style="padding: 20px 25px; border-top:1px solid #f1f5f9; background:white; border-radius: 0 0 24px 24px;">
            <button onclick="submitDailyCycleSync()" style="width:100%; background:var(--primary); color:white; padding:16px; border-radius:50px; border:none; font-weight:700; font-size:1.1rem; box-shadow: 0 4px 15px rgba(45, 74, 62, 0.3); cursor:pointer; transition: transform 0.1s;">
                SAVE & START DAY ✨
            </button>
        </div>
    </div>
</div>

<style>
    .check-in-chip {
        padding: 10px 18px;
        background: #f8fafc;
        border-radius: 12px;
        font-size: 0.95rem;
        color: var(--text-main);
        cursor: pointer;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        flex-grow: 0;
        text-align: center;
        justify-content: center;
    }
    .check-in-chip:hover {
        background: #f1f5f9;
        border-color: #cbd5e0;
    }
    .check-in-chip.selected {
        background: var(--primary); /* Green for wellness vibe */
        color: white;
        border-color: var(--primary);
        box-shadow: 0 4px 10px rgba(43, 61, 38, 0.2);
    }
    /* Separate colors for categories if desired, but green is safe/premium */
    
    @keyframes fadeInScale {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
</style>

<!-- DAILY WEIGH-IN PROMPT MODAL (First login of day) -->
<div id="weigh-in-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center; padding:15px;">
    <div class="modal-content" style="background: white; width: 100%; border-radius: 24px; padding: 0; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeInScale 0.2s ease-out;">

        <!-- Header -->
        <div style="padding: 25px 25px 20px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 24px 24px 0 0; color: white; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
            <div style="position: relative; z-index: 1;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">⚖️</div>
                <h3 style="margin: 0 0 5px 0; font-family: 'Playfair Display'; font-size: 1.5rem;">Daily Weigh-In</h3>
                <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Start your day by tracking your progress</p>
            </div>
        </div>

        <!-- Content -->
        <div style="padding: 25px;">
            <div id="weigh-in-modal-input-section">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 12px; font-size: 0.95rem;">Enter today's weight</label>
                <div style="position: relative; margin-bottom: 20px;">
                    <input type="number" id="weigh-in-modal-input" placeholder="Enter weight" step="0.1" min="20" max="500" style="width: 100%; padding: 16px 60px 16px 20px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1.1rem; box-sizing: border-box; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'">
                    <span id="weigh-in-modal-unit-label" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #666; font-size: 1rem; font-weight: 600;">kg</span>
                </div>
                <p id="weigh-in-modal-last-weight" style="margin: 0 0 20px 0; font-size: 0.85rem; color: var(--text-muted); text-align: center;"></p>

                <div style="display: flex; gap: 10px;">
                    <button onclick="closeWeighInModal()" style="flex: 1; background: #f1f5f9; color: var(--text-main); border: none; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.2s;">
                        Skip
                    </button>
                    <button onclick="submitWeighInModal()" style="flex: 2; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        Log It (+1 XP)
                    </button>
                </div>
            </div>

            <div id="weigh-in-modal-success-section" style="display: none; text-align: center; padding: 20px 0;">
                <div style="font-size: 3rem; margin-bottom: 15px;">🎉</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #667eea; margin-bottom: 8px;">+1 XP</div>
                <p style="margin: 0; font-weight: 600; color: var(--text-main);">Weigh-in complete!</p>
                <p style="margin: 10px 0 0 0; font-size: 0.85rem; color: var(--text-muted);">Keep up the great consistency!</p>
            </div>
        </div>
    </div>
</div>

<script>
// ===== DAILY WEIGH-IN MODAL LOGIC (First Login of Day) =====

/**
 * Check if this is the first login of the day and show weigh-in modal
 */
async function checkAndShowWeighInModal() {
    if (!window.currentUser) return;

    // Don't show weigh-in if onboarding wizard is active or pending
    if (window._onboardingWizardPending) return;
    const wizard = document.getElementById('onboarding-wizard');
    if (wizard && wizard.style.display !== 'none') return;

    // Check if we've already prompted today
    const lastPromptDate = localStorage.getItem('lastWeighInPromptDate');
    const today = new Date().toDateString();

    if (lastPromptDate === today) {
        // Already prompted today, don't show again
        return;
    }

    try {
        // Check if user has already weighed in today
        const todaysWeighIn = await db.weighIns.getTodaysWeighIn(window.currentUser.id);

        if (todaysWeighIn) {
            // Already weighed in today, mark as prompted and don't show modal
            localStorage.setItem('lastWeighInPromptDate', today);
            return;
        }

        // Show the weigh-in modal
        openWeighInModal();

    } catch (error) {
        console.error('Error checking weigh-in for modal:', error);
    }
}

/**
 * Open the daily weigh-in modal
 */
async function openWeighInModal() {
    const modal = document.getElementById('weigh-in-modal');
    const inputSection = document.getElementById('weigh-in-modal-input-section');
    const successSection = document.getElementById('weigh-in-modal-success-section');
    const input = document.getElementById('weigh-in-modal-input');
    const unitLabel = document.getElementById('weigh-in-modal-unit-label');
    const lastWeightText = document.getElementById('weigh-in-modal-last-weight');

    if (!modal) return;

    // Reset modal state
    if (inputSection) inputSection.style.display = 'block';
    if (successSection) successSection.style.display = 'none';
    if (input) input.value = '';

    // Set unit preference
    const preferLbs = localStorage.getItem('weightUnitPreference') === 'lbs';
    if (unitLabel) {
        unitLabel.textContent = preferLbs ? 'lbs' : 'kg';
    }
    if (input) {
        input.step = preferLbs ? '1' : '0.1';
    }

    // Show last known weight as reference
    try {
        const latestWeighIn = await db.weighIns.getLatest(window.currentUser.id);
        if (latestWeighIn && lastWeightText) {
            const displayWeight = preferLbs
                ? (latestWeighIn.weight_kg * 2.20462).toFixed(1) + ' lbs'
                : latestWeighIn.weight_kg.toFixed(1) + ' kg';
            lastWeightText.textContent = `Last weigh-in: ${displayWeight}`;
            lastWeightText.style.display = 'block';
        } else if (lastWeightText) {
            lastWeightText.style.display = 'none';
        }
    } catch (e) {
        if (lastWeightText) lastWeightText.style.display = 'none';
    }

    // Show modal
    modal.style.display = 'flex';
}

/**
 * Close the weigh-in modal
 */
function closeWeighInModal() {
    const modal = document.getElementById('weigh-in-modal');
    if (modal) modal.style.display = 'none';

    // Mark as prompted today even if skipped
    localStorage.setItem('lastWeighInPromptDate', new Date().toDateString());

    // Keep the dashboard card visible so user can still weigh in from the home screen
}

/**
 * Submit weight from the modal
 */
async function submitWeighInModal() {
    if (!window.currentUser) {
        alert('Please log in to track your weight.');
        return;
    }

    const input = document.getElementById('weigh-in-modal-input');
    const inputSection = document.getElementById('weigh-in-modal-input-section');
    const successSection = document.getElementById('weigh-in-modal-success-section');
    const modal = document.getElementById('weigh-in-modal');

    let weightValue = parseFloat(input?.value);

    if (!weightValue || weightValue < 20 || weightValue > 500) {
        alert('Please enter a valid weight.');
        return;
    }

    // Convert lbs to kg if needed
    const preferLbs = localStorage.getItem('weightUnitPreference') === 'lbs';
    if (preferLbs) {
        weightValue = weightValue * 0.453592;
    }

    try {
        // Log the weigh-in
        await db.weighIns.log(window.currentUser.id, weightValue);

        // Award 1 XP
        try {
            const { data: currentPoints } = await supabaseClient
                .from('user_points')
                .select('lifetime_points')
                .eq('user_id', window.currentUser.id)
                .maybeSingle();

            if (currentPoints) {
                await supabaseClient
                    .from('user_points')
                    .update({ lifetime_points: (currentPoints.lifetime_points || 0) + 1 })
                    .eq('user_id', window.currentUser.id);
            } else {
                await supabaseClient
                    .from('user_points')
                    .insert({ user_id: window.currentUser.id, lifetime_points: 1, current_points: 0 });
            }

            if (typeof triggerXPBarRainbow === 'function') triggerXPBarRainbow();
            if (typeof refreshLevelDisplay === 'function') refreshLevelDisplay();
        } catch (xpError) {
            console.log('XP award skipped:', xpError);
        }

        // Update user's current weight in profile
        try {
            await db.users.update(window.currentUser.id, { weight: weightValue });
        } catch (updateError) {
            console.log('Profile weight update skipped:', updateError);
        }

        // Show success animation
        if (inputSection) inputSection.style.display = 'none';
        if (successSection) successSection.style.display = 'block';

        // Mark as prompted today
        localStorage.setItem('lastWeighInPromptDate', new Date().toDateString());

        // Hide the card on dashboard since already logged
        const card = document.getElementById('daily-weigh-in-card');
        if (card) card.style.display = 'none';

        // Close modal after showing success
        setTimeout(() => {
            if (modal) modal.style.display = 'none';
            // Reset for next use
            if (inputSection) inputSection.style.display = 'block';
            if (successSection) successSection.style.display = 'none';
            if (input) input.value = '';
        }, 2000);

        // Refresh points display
        if (typeof refreshPointsDisplay === 'function') {
            refreshPointsDisplay();
        }

    } catch (error) {
        console.error('Error logging weigh-in from modal:', error);
        alert('Failed to log weigh-in. Please try again.');
    }
}

// Make functions globally available
window.checkAndShowWeighInModal = checkAndShowWeighInModal;
window.openWeighInModal = openWeighInModal;
window.closeWeighInModal = closeWeighInModal;
window.submitWeighInModal = submitWeighInModal;
</script>

<!-- Share Referral Modal -->
<div id="share-referral-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10006; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
    <div style="background:white; border-radius:20px; max-width:500px; width:90%; max-height:85vh; overflow-y:auto; animation:fadeInScale 0.3s ease-out; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <!-- Header -->
        <div style="padding:24px 24px 20px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; justify-content:space-between;">
            <div>
                <h2 style="margin:0 0 4px 0; font-size:1.5rem; color:var(--text-main);">Share Your Invite Link</h2>
                <p style="margin:0; font-size:0.875rem; color:#64748b;">You BOTH get 1 week double XP when they join!</p>
            </div>
            <button onclick="closeShareReferralModal()" style="background:none; border:none; font-size:1.8rem; color:#94a3b8; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:all 0.2s;">×</button>
        </div>

        <!-- Content -->
        <div style="padding:24px;">
            <!-- Referral Code Display -->
            <div style="margin-bottom:24px;">
                <label style="display:block; font-size:0.875rem; font-weight:600; color:var(--text-main); margin-bottom:8px;">Your Referral Code</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <div id="referral-code-display" style="flex:1; padding:14px; background:#f8fafc; border:2px solid #e2e8f0; border-radius:12px; font-family:monospace; font-size:1.1rem; font-weight:700; color:var(--primary); text-align:center; letter-spacing:2px;">
                        Loading...
                    </div>
                    <button onclick="copyReferralCode()" style="padding:14px 20px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; white-space:nowrap; transition:all 0.2s;">
                        Copy
                    </button>
                </div>
            </div>

            <!-- Share Options -->
            <div style="margin-bottom:16px;">
                <label style="display:block; font-size:0.875rem; font-weight:600; color:var(--text-main); margin-bottom:12px;">Share via</label>
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                    <!-- WhatsApp -->
                    <button onclick="shareViaWhatsApp()" style="padding:14px; background:#25D366; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                        WhatsApp
                    </button>

                    <!-- Facebook Messenger -->
                    <button onclick="shareViaFacebook()" style="padding:14px; background:#1877F2; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </button>

                    <!-- SMS -->
                    <button onclick="shareViaSMS()" style="padding:14px; background:#22c55e; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s; grid-column:span 2;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 11H7V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/>
                        </svg>
                        SMS
                    </button>
                </div>
            </div>

            <!-- Info -->
            <div style="padding:16px; background:#f0fdf4; border:2px solid #bbf7d0; border-radius:12px; margin-top:20px;">
                <div style="display:flex; gap:12px; align-items:start;">
                    <div style="font-size:1.5rem; flex-shrink:0;">💡</div>
                    <div style="font-size:0.875rem; color:#15803d; line-height:1.5;">
                        <strong>How it works:</strong> When your friend signs up using your code, you BOTH automatically get 1 week of double XP! The more friends you invite, the more weeks of 2x XP you earn. Share away!
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Friend Modal -->
<div id="add-friend-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10006; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
    <div style="background:white; border-radius:20px; max-width:500px; width:90%; max-height:85vh; overflow-y:auto; animation:fadeInScale 0.3s ease-out; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <!-- Header -->
        <div style="padding:24px 24px 20px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; justify-content:space-between;">
            <div>
                <h2 style="margin:0 0 4px 0; font-size:1.5rem; color:var(--text-main);">Add Friends</h2>
                <p style="margin:0; font-size:0.875rem; color:#64748b;">Search by name or email</p>
            </div>
            <button onclick="closeAddFriendModal()" style="background:none; border:none; font-size:1.8rem; color:#94a3b8; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:all 0.2s;">×</button>
        </div>

        <!-- Tab Switcher -->
        <div style="padding:16px 24px; border-bottom:1px solid #f1f5f9;">
            <div style="display:flex; background:#f1f5f9; padding:4px; border-radius:10px;">
                <button id="friend-tab-search" onclick="showFriendTab('search')" style="flex:1; padding:10px; border:none; background:white; color:var(--primary); font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s;">Search</button>
                <button id="friend-tab-requests" onclick="showFriendTab('requests')" style="flex:1; padding:10px; border:none; background:transparent; color:#64748b; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s;">Requests <span id="friend-request-badge" style="display:none; background:#ef4444; color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px; margin-left:4px;">0</span></button>
                <button id="friend-tab-friends" onclick="showFriendTab('friends')" style="flex:1; padding:10px; border:none; background:transparent; color:#64748b; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s;">Friends</button>
            </div>
        </div>

        <!-- Search Tab Content -->
        <div id="friend-search-content" style="padding:24px;">
            <!-- Search Input -->
            <div style="margin-bottom:20px;">
                <div style="display:flex; gap:8px; align-items:center;">
                    <input type="text" id="friend-search-input" placeholder="Search by name or email..." oninput="debouncedFriendSearch()" style="flex:1; padding:14px 16px; background:#f8fafc; border:2px solid #e2e8f0; border-radius:12px; font-size:1rem; outline:none; transition:all 0.2s;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#e2e8f0'">
                    <button onclick="searchForFriends()" style="padding:14px 20px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; transition:all 0.2s;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Search Results -->
            <div id="friend-search-results" style="min-height:100px;">
                <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <p style="margin:0; font-size:0.95rem;">Search for friends by their name or email address</p>
                </div>
            </div>
        </div>

        <!-- Requests Tab Content -->
        <div id="friend-requests-content" style="display:none; padding:24px;">
            <div id="friend-requests-list" style="min-height:100px;">
                <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                        <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <p style="margin:0; font-size:0.95rem;">No pending friend requests</p>
                </div>
            </div>
        </div>

        <!-- Friends List Tab Content -->
        <div id="friend-list-content" style="display:none; padding:24px;">
            <div id="friends-list" style="min-height:100px;">
                <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                    <p style="margin:0; font-size:0.95rem;">No friends yet. Start by adding some!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Story Camera Modal (Instagram-style) -->
<div id="story-camera-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10008; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Camera Preview -->
    <video id="camera-preview" autoplay playsinline style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0;"></video>

    <!-- Captured Preview (shown after capture) -->
    <div id="captured-preview" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:11;">
        <img id="captured-photo" style="width:100%; height:100%; object-fit:cover; display:none;">
        <video id="captured-video" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover; display:none;"></video>
    </div>

    <!-- Close Button -->
    <button onclick="closeCameraModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:12;">
        &times;
    </button>

    <!-- Post Button (shown after capture) -->
    <button id="post-story-btn" onclick="postCapturedStory()" style="display:none; position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:12px 30px; border:none; border-radius:25px; font-weight:600; font-size:1rem; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.5); z-index:12;">
        Post
    </button>

    <!-- Retake Button (shown after capture) -->
    <button id="retake-btn" onclick="retakePhoto()" style="display:none; position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:12px 24px; border:none; border-radius:25px; font-weight:600; font-size:1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:12;">
        Retake
    </button>

    <!-- Camera Controls -->
    <div id="camera-controls" style="position:absolute; bottom:40px; left:0; right:0; display:flex; justify-content:center; align-items:center; z-index:10;">
        <!-- Single Capture Button (Tap = Photo, Hold = Video) -->
        <button id="camera-capture-btn"
                onmousedown="handleCameraButtonDown()"
                onmouseup="handleCameraButtonUp()"
                onmouseleave="handleCameraButtonUp()"
                ontouchstart="handleCameraButtonDown()"
                ontouchend="handleCameraButtonUp()"
                style="width:70px; height:70px; background:white; border:5px solid rgba(255,255,255,0.8); border-radius:50%; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3); transition:all 0.2s;">
        </button>
    </div>

    <!-- Recording Indicator -->
    <div id="recording-indicator" style="position:absolute; top:20px; left:20px; background:rgba(239,68,68,0.9); color:white; padding:8px 16px; border-radius:20px; font-weight:600; display:none; z-index:10;">
        ⏺ Recording...
    </div>
</div>

<!-- Story Choice Modal (Photo or Video?) -->
<div id="story-choice-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10010; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <div style="width:90%; max-width:400px; background:white; border-radius:20px; overflow:hidden; text-align:center;">
        <!-- Header -->
        <div style="padding:30px 20px 20px 20px;">
            <h3 style="margin:0 0 10px 0; color:var(--primary); font-size:1.5rem;">Create a Post</h3>
            <p style="margin:0; color:var(--text-muted); font-size:0.9rem;">Choose what you'd like to share</p>
        </div>

        <!-- Choice Buttons -->
        <div style="padding:0 20px 30px 20px; display:flex; flex-direction:column; gap:12px;">
            <button onclick="openNativeCamera('photo')" style="width:100%; padding:20px; background:linear-gradient(135deg, var(--primary), var(--secondary)); color:white; border:none; border-radius:15px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.15); transition:transform 0.2s; display:flex; align-items:center; justify-content:center; gap:10px;">
                <svg viewBox="0 0 24 24" style="width:24px; height:24px; fill:white;">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                Take Photo
            </button>

            <button onclick="openNativeCamera('video')" style="width:100%; padding:20px; background:linear-gradient(135deg, #8b5cf6, #ec4899); color:white; border:none; border-radius:15px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.15); transition:transform 0.2s; display:flex; align-items:center; justify-content:center; gap:10px;">
                <svg viewBox="0 0 24 24" style="width:24px; height:24px; fill:white;">
                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                </svg>
                Record Video
            </button>

            <button onclick="closeChoiceModal()" style="width:100%; padding:16px; background:rgba(0,0,0,0.05); color:var(--text-muted); border:none; border-radius:15px; font-weight:600; font-size:1rem; cursor:pointer; transition:background 0.2s;">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Story Preview Modal (After Native Camera Capture) -->
<div id="story-preview-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10011; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Preview Content -->
    <img id="story-preview-photo" style="width:100%; height:100%; object-fit:contain; display:none; position:absolute; top:0; left:0;">
    <video id="story-preview-video-player" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:contain; display:none; position:absolute; top:0; left:0;"></video>

    <!-- Text Overlay Preview (user-added text) -->
    <div id="story-text-overlay-preview" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; font-size:1.5rem; font-weight:700; text-align:center; text-shadow:2px 2px 4px rgba(0,0,0,0.8); padding:10px 20px; max-width:80%; word-wrap:break-word; z-index:11; pointer-events:none;">
    </div>

    <!-- Close Button -->
    <button onclick="closePreviewModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:12; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Add Text Button -->
    <button id="add-text-btn" onclick="showTextEditor()" style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.5); border:none; color:white; padding:10px 20px; border-radius:20px; font-weight:600; cursor:pointer; z-index:12; backdrop-filter:blur(10px); display:flex; align-items:center; gap:8px;">
        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
            <path d="M5 4v3h5.5v12h3V7H19V4z"/>
        </svg>
        Add Text
    </button>

    <!-- Text Editor Overlay -->
    <div id="text-editor-overlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:13; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
        <textarea id="story-text-input" placeholder="Type your text..." maxlength="100" style="width:90%; max-width:400px; background:transparent; border:none; color:white; font-size:1.5rem; font-weight:700; text-align:center; resize:none; outline:none; font-family:inherit; min-height:100px; text-shadow:2px 2px 4px rgba(0,0,0,0.8);"></textarea>
        <div style="display:flex; gap:15px; margin-top:30px;">
            <button onclick="cancelTextEditor()" style="padding:12px 30px; background:rgba(255,255,255,0.2); color:white; border:none; border-radius:25px; font-weight:600; cursor:pointer; backdrop-filter:blur(10px);">
                Cancel
            </button>
            <button onclick="saveTextOverlay()" style="padding:12px 30px; background:var(--primary); color:white; border:none; border-radius:25px; font-weight:600; cursor:pointer;">
                Done
            </button>
        </div>
    </div>

    <!-- Post Button -->
    <button id="preview-post-btn" onclick="postCapturedStory()" style="position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:14px 35px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.6); z-index:12; transition:transform 0.2s;">
        Post
    </button>

    <!-- Retake Button -->
    <button onclick="retakeFromPreview()" style="position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:14px 28px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:12; transition:transform 0.2s;">
        Retake
    </button>
</div>

<!-- Meal Photo Preview Modal (After Native Camera Capture) -->
<div id="meal-preview-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10012; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Photo Preview -->
    <img id="meal-preview-photo" style="width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0;">

    <!-- Close Button -->
    <button onclick="closeMealPreviewModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:13; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Food Description Input -->
    <div style="position:absolute; bottom:110px; left:20px; right:20px; z-index:13;">
        <div id="meal-photo-type-row" style="display:flex; gap:8px; max-width:500px; margin:0 auto 10px auto;">
            <button class="meal-photo-type-pill active" data-type="breakfast" onclick="selectPhotoMealType('breakfast')">Breakfast</button>
            <button class="meal-photo-type-pill" data-type="lunch" onclick="selectPhotoMealType('lunch')">Lunch</button>
            <button class="meal-photo-type-pill" data-type="dinner" onclick="selectPhotoMealType('dinner')">Dinner</button>
            <button class="meal-photo-type-pill" data-type="snack" onclick="selectPhotoMealType('snack')">Snack</button>
        </div>
        <input type="text" id="meal-photo-description" placeholder="What did you have? e.g. 200g oats, 100ml milk" style="width:100%; max-width:500px; margin:0 auto; display:block; background:rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.3); border-radius:15px; color:white; padding:14px 20px; font-size:1rem; backdrop-filter:blur(10px); font-family:inherit; outline:none; box-sizing:border-box;" />
    </div>

    <!-- Analyze Button -->
    <button onclick="useMealPhoto()" style="position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:14px 35px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.6); z-index:13; transition:transform 0.2s;">
        Analyze Meal
    </button>

    <!-- Retake Button -->
    <button onclick="retakeMealPhotoFromPreview()" style="position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:14px 28px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:13; transition:transform 0.2s;">
        Retake
    </button>
</div>

<!-- Unified Camera Modal (Photo + Barcode) -->
<div id="unified-camera-modal" style="display:none; position:fixed; inset:0; background:#000; z-index:10013; flex-direction:column;">
    <!-- Close button -->
    <button onclick="closeUnifiedCamera()" style="position:absolute; top:16px; right:16px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:5; backdrop-filter:blur(10px);">&times;</button>
    <!-- Barcode detected banner (hidden by default) -->
    <div id="barcode-detected-banner" style="display:none; position:absolute; top:0; left:0; right:0; z-index:4; padding:14px 20px; background:linear-gradient(135deg, #22c55e, #16a34a); color:#fff; text-align:center; animation:fadeInUp 0.3s ease-out;">
        <div style="font-weight:700; font-size:1rem;" id="barcode-detected-name">Product found!</div>
        <div style="font-size:0.85rem; opacity:0.9; margin-top:2px;" id="barcode-detected-detail"></div>
        <button onclick="showBarcodeResult()" style="margin-top:8px; background:rgba(255,255,255,0.25); color:#fff; border:none; border-radius:20px; padding:8px 24px; font-weight:600; font-size:0.9rem; cursor:pointer; backdrop-filter:blur(5px);">View & Log Product</button>
    </div>
    <!-- AI food detected banner (hidden by default) -->
    <div id="ai-food-detected-banner" style="display:none; position:absolute; top:0; left:0; right:0; z-index:4; padding:14px 20px; background:linear-gradient(135deg, #8b5cf6, #6d28d9); color:#fff; text-align:center; animation:fadeInUp 0.3s ease-out;">
        <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
            <span style="font-weight:700; font-size:1rem;" id="ai-food-detected-name">Identifying...</span>
        </div>
        <div style="font-size:0.85rem; opacity:0.9; margin-top:2px;" id="ai-food-detected-detail"></div>
        <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
            <button onclick="useAiFoodSuggestion()" style="background:rgba(255,255,255,0.25); color:#fff; border:none; border-radius:20px; padding:8px 20px; font-weight:600; font-size:0.9rem; cursor:pointer; backdrop-filter:blur(5px);">Use this</button>
            <button onclick="dismissAiFoodBanner()" style="background:rgba(255,255,255,0.1); color:rgba(255,255,255,0.8); border:none; border-radius:20px; padding:8px 16px; font-weight:500; font-size:0.85rem; cursor:pointer;">Dismiss</button>
        </div>
    </div>
    <!-- Live camera feed -->
    <video id="unified-camera-video" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover;"></video>
    <!-- Hidden canvas for photo capture -->
    <canvas id="unified-camera-canvas" style="display:none;"></canvas>
    <!-- Hidden element for html5-qrcode barcode scanning -->
    <div id="barcode-reader" style="position:absolute; top:0; left:0; width:1px; height:1px; overflow:hidden; opacity:0;"></div>
    <!-- Bottom controls -->
    <div style="position:absolute; bottom:0; left:0; right:0; z-index:3; padding:20px; background:linear-gradient(transparent, rgba(0,0,0,0.8) 40%);">
        <!-- Food description input -->
        <div style="margin-bottom:14px;">
            <input type="text" id="unified-camera-description" placeholder="What is this? (optional)" style="width:100%; max-width:500px; margin:0 auto; display:block; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2); border-radius:15px; color:white; padding:12px 18px; font-size:0.95rem; backdrop-filter:blur(10px); font-family:inherit; outline:none; box-sizing:border-box;" />
        </div>
        <!-- Capture + barcode manual row -->
        <div style="display:flex; align-items:center; justify-content:center; gap:16px;">
            <!-- Manual barcode button -->
            <button onclick="showManualBarcodeEntry()" id="manual-barcode-btn" style="background:rgba(255,255,255,0.15); border:none; color:#fff; width:50px; height:50px; border-radius:50%; cursor:pointer; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center;" title="Type barcode">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                    <line x1="6" y1="8" x2="6" y2="16"></line>
                    <line x1="10" y1="8" x2="10" y2="16"></line>
                    <line x1="14" y1="8" x2="14" y2="16"></line>
                    <line x1="18" y1="8" x2="18" y2="16"></line>
                </svg>
            </button>
            <!-- Capture photo button -->
            <button onclick="captureUnifiedPhoto()" style="width:72px; height:72px; border-radius:50%; border:4px solid white; background:rgba(255,255,255,0.2); cursor:pointer; backdrop-filter:blur(10px); position:relative; transition:transform 0.15s;" id="unified-capture-btn">
                <div style="width:56px; height:56px; border-radius:50%; background:white; margin:auto; transition:transform 0.15s;"></div>
            </button>
            <!-- Flip camera button -->
            <button onclick="flipUnifiedCamera()" style="background:rgba(255,255,255,0.15); border:none; color:#fff; width:50px; height:50px; border-radius:50%; cursor:pointer; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center;" title="Flip camera">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 16V7a2 2 0 00-2-2H6"></path>
                    <polyline points="14 5 20 5 20 11"></polyline>
                    <path d="M4 8v9a2 2 0 002 2h12"></path>
                    <polyline points="10 19 4 19 4 13"></polyline>
                </svg>
            </button>
        </div>
        <!-- Manual barcode input (hidden by default) -->
        <div id="manual-barcode-row" style="display:none; margin-top:12px; gap:10px; align-items:center;">
            <input type="text" id="barcode-manual-input" inputmode="numeric" pattern="[0-9]*" placeholder="Enter barcode number..." style="flex:1; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2); border-radius:12px; color:#fff; padding:12px 16px; font-size:1rem; font-family:inherit; outline:none;" />
            <button onclick="lookupManualBarcode()" style="background:var(--primary); color:#fff; border:none; border-radius:12px; padding:12px 20px; font-weight:600; cursor:pointer; white-space:nowrap;">Look Up</button>
        </div>
        <!-- Scanning indicator -->
        <div style="text-align:center; margin-top:10px;">
            <span id="barcode-scan-status" style="color:rgba(255,255,255,0.5); font-size:0.8rem;">Scanning for barcodes automatically...</span>
        </div>
    </div>
</div>

<!-- Barcode Result Modal -->
<div id="barcode-result-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:10014; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
    <div style="background:var(--card-bg, #1e1e2e); border-radius:20px; max-width:420px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <!-- Product header -->
        <div style="padding:24px 24px 16px;">
            <div style="display:flex; align-items:flex-start; gap:16px;">
                <img id="barcode-product-image" src="" alt="" style="width:80px; height:80px; border-radius:12px; object-fit:cover; background:#2a2a3e; display:none;" />
                <div style="flex:1; min-width:0;">
                    <h3 id="barcode-product-name" style="margin:0 0 4px; color:var(--text-main, #fff); font-size:1.15rem; line-height:1.3;"></h3>
                    <p id="barcode-product-brand" style="margin:0; color:var(--text-muted, #888); font-size:0.9rem;"></p>
                    <p id="barcode-product-quantity" style="margin:4px 0 0; color:var(--text-muted, #888); font-size:0.85rem;"></p>
                </div>
            </div>
        </div>
        <!-- Amount selector (servings or custom g/ml) -->
        <div id="barcode-serving-section" style="padding:0 24px 16px;">
            <!-- Mode toggle -->
            <div style="display:flex; gap:0; margin-bottom:10px; background:rgba(255,255,255,0.06); border-radius:10px; overflow:hidden;">
                <button id="barcode-mode-servings" onclick="setBarcodeAmountMode('servings')" style="flex:1; padding:9px 0; border:none; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s; background:var(--primary); color:#fff;">Servings</button>
                <button id="barcode-mode-custom" onclick="setBarcodeAmountMode('custom')" style="flex:1; padding:9px 0; border:none; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s; background:transparent; color:var(--text-muted, #888);">Custom (g/ml)</button>
            </div>
            <!-- Servings row -->
            <div id="barcode-servings-row" style="display:flex; align-items:center; gap:12px;">
                <button onclick="adjustBarcodeServings(-0.5)" style="background:rgba(255,255,255,0.1); border:none; color:#fff; width:36px; height:36px; border-radius:50%; font-size:1.2rem; cursor:pointer;">&minus;</button>
                <span id="barcode-servings-display" style="color:#fff; font-size:1.1rem; font-weight:600; min-width:30px; text-align:center;">1</span>
                <button onclick="adjustBarcodeServings(0.5)" style="background:rgba(255,255,255,0.1); border:none; color:#fff; width:36px; height:36px; border-radius:50%; font-size:1.2rem; cursor:pointer;">+</button>
                <span id="barcode-serving-size-label" style="color:var(--text-muted, #888); font-size:0.85rem;"></span>
            </div>
            <!-- Custom amount row -->
            <div id="barcode-custom-row" style="display:none; align-items:center; gap:10px;">
                <input type="number" id="barcode-custom-amount" inputmode="decimal" placeholder="e.g. 150" min="0" step="any" oninput="onBarcodeCustomAmountChange()" style="flex:1; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); border-radius:12px; color:#fff; padding:11px 14px; font-size:1.05rem; font-family:inherit; outline:none; -moz-appearance:textfield;" />
                <span id="barcode-custom-unit" style="color:var(--text-muted, #aaa); font-size:0.95rem; min-width:20px;">g</span>
                <span id="barcode-custom-hint" style="color:var(--text-muted, #666); font-size:0.8rem; white-space:nowrap;"></span>
            </div>
        </div>
        <!-- Nutrition breakdown -->
        <div style="padding:0 24px 16px;">
            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
                <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:14px; text-align:center;">
                    <div id="barcode-calories" style="font-size:1.5rem; font-weight:700; color:#22c55e;">0</div>
                    <div style="font-size:0.75rem; color:var(--text-muted, #888); margin-top:2px;">Calories</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:14px; text-align:center;">
                    <div id="barcode-protein" style="font-size:1.5rem; font-weight:700; color:#3b82f6;">0g</div>
                    <div style="font-size:0.75rem; color:var(--text-muted, #888); margin-top:2px;">Protein</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:14px; text-align:center;">
                    <div id="barcode-carbs" style="font-size:1.5rem; font-weight:700; color:#f59e0b;">0g</div>
                    <div style="font-size:0.75rem; color:var(--text-muted, #888); margin-top:2px;">Carbs</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:14px; text-align:center;">
                    <div id="barcode-fat" style="font-size:1.5rem; font-weight:700; color:#ef4444;">0g</div>
                    <div style="font-size:0.75rem; color:var(--text-muted, #888); margin-top:2px;">Fat</div>
                </div>
            </div>
            <!-- Extra nutrients -->
            <div id="barcode-extra-nutrients" style="margin-top:10px; display:grid; grid-template-columns:repeat(3,1fr); gap:8px;"></div>
        </div>
        <!-- Action buttons -->
        <div style="padding:0 24px 24px; display:flex; gap:12px;">
            <button onclick="closeBarcodeResult()" style="flex:1; background:rgba(255,255,255,0.1); color:#fff; border:none; border-radius:14px; padding:14px; font-weight:600; font-size:1rem; cursor:pointer;">Cancel</button>
            <button onclick="logBarcodeAsMeal()" style="flex:2; background:var(--primary); color:#fff; border:none; border-radius:14px; padding:14px; font-weight:600; font-size:1rem; cursor:pointer; box-shadow:0 4px 15px rgba(123,168,131,0.3);">Log Meal</button>
        </div>
    </div>
</div>

<!-- Meal Input Modal (Photo/Text/Voice selector) -->
<div id="meal-input-modal" class="meal-input-modal">
    <div class="meal-input-container">
        <!-- Header -->
        <div class="meal-input-header">
            <h3>Log a Meal</h3>
            <button class="meal-input-close" onclick="closeMealInputModal()">&times;</button>
        </div>

        <!-- Meal Type Selector -->
        <div class="meal-type-selector">
            <button class="meal-type-btn active" data-type="breakfast" onclick="selectMealType('breakfast')">
                <span class="meal-type-emoji">🌅</span>
                <span class="meal-type-label">Breakfast</span>
            </button>
            <button class="meal-type-btn" data-type="lunch" onclick="selectMealType('lunch')">
                <span class="meal-type-emoji">☀️</span>
                <span class="meal-type-label">Lunch</span>
            </button>
            <button class="meal-type-btn" data-type="dinner" onclick="selectMealType('dinner')">
                <span class="meal-type-emoji">🌙</span>
                <span class="meal-type-label">Dinner</span>
            </button>
            <button class="meal-type-btn" data-type="snack" onclick="selectMealType('snack')">
                <span class="meal-type-emoji">🍎</span>
                <span class="meal-type-label">Snack</span>
            </button>
        </div>

        <!-- Input Method Buttons -->
        <div class="meal-input-methods" id="meal-input-methods">
            <button class="input-method-btn" onclick="selectInputMethod('photo')">
                <div class="input-method-icon photo">📸</div>
                <div class="input-method-info">
                    <div class="input-method-title">Take a Photo</div>
                    <div class="input-method-desc">Snap your meal for instant analysis</div>
                </div>
            </button>
            <button class="input-method-btn" onclick="selectInputMethod('text')">
                <div class="input-method-icon text">📝</div>
                <div class="input-method-info">
                    <div class="input-method-title">Type It In</div>
                    <div class="input-method-desc">Describe what you ate</div>
                </div>
            </button>
            <button class="input-method-btn" onclick="selectInputMethod('voice')">
                <div class="input-method-icon voice">🎤</div>
                <div class="input-method-info">
                    <div class="input-method-title">Voice Input</div>
                    <div class="input-method-desc">Say what you had</div>
                </div>
            </button>
        </div>

        <!-- Text Input Section (hidden by default) -->
        <div class="meal-text-section" id="meal-text-section">
            <textarea
                id="meal-text-input"
                class="meal-text-input"
                placeholder="What did you eat? Be as specific as you can about portions..."
                maxlength="500"
            ></textarea>
            <div class="meal-text-examples">
                <p>Examples:</p>
                <ul>
                    <li>"2 scrambled eggs, 2 slices whole wheat toast with butter, orange juice"</li>
                    <li>"Large bowl of oatmeal with banana and almonds"</li>
                    <li>"Chipotle burrito bowl with chicken, rice, beans, guac"</li>
                </ul>
            </div>
        </div>

        <!-- Voice Input Section (hidden by default) -->
        <div class="meal-voice-section" id="meal-voice-section">
            <p class="voice-status" id="voice-status">Tap the microphone and describe your meal</p>
            <button class="voice-record-btn" id="voice-record-btn" onclick="toggleVoiceRecording()">
                🎤
            </button>
            <div class="voice-transcript-wrapper">
                <div class="voice-transcript empty" id="voice-transcript">
                    Your spoken words will appear here...
                </div>
                <button class="voice-transcript-delete" id="voice-transcript-delete" onclick="clearVoiceTranscript()" style="display: none;">
                    Delete
                </button>
            </div>
        </div>

        <!-- Submit Button (for text/voice) -->
        <div class="meal-submit-section" id="meal-submit-section">
            <button class="meal-submit-btn" id="meal-submit-btn" onclick="submitMealDescription()" disabled>
                Analyze My Meal
            </button>
        </div>
    </div>
</div>

<!-- Simple Text Input Modal -->
<div id="meal-text-modal" class="meal-text-modal">
    <div class="meal-text-modal-container">
        <div class="meal-text-modal-header">
            <h3>What did you eat?</h3>
            <button class="meal-text-modal-close" onclick="closeMealTextModal()">&times;</button>
        </div>
        <div class="simple-meal-type-row" id="simple-meal-type-row">
            <button class="simple-meal-type-bubble active" data-type="breakfast" onclick="selectSimpleMealType('breakfast')">Breakfast</button>
            <button class="simple-meal-type-bubble" data-type="lunch" onclick="selectSimpleMealType('lunch')">Lunch</button>
            <button class="simple-meal-type-bubble" data-type="dinner" onclick="selectSimpleMealType('dinner')">Dinner</button>
            <button class="simple-meal-type-bubble" data-type="snack" onclick="selectSimpleMealType('snack')">Snack</button>
        </div>
        <textarea
            id="simple-meal-input"
            class="simple-meal-textarea"
            placeholder="e.g., 2 eggs, toast with butter, orange juice..."
        ></textarea>
        <button class="simple-meal-submit" id="simple-meal-submit" onclick="submitSimpleMealText()" disabled>
            Analyze My Meal
        </button>
    </div>
</div>

<!-- Recent Meals Modal -->
<div id="recent-meals-modal" class="recent-meals-modal" onclick="if(event.target===this)closeRecentMealsModal()">
    <div class="recent-meals-container">
        <div class="recent-meals-header">
            <h3 id="recent-meals-title">Recent Meals</h3>
            <button class="recent-meals-close" onclick="closeRecentMealsModal()">&times;</button>
        </div>
        <div class="recent-meals-list" id="recent-meals-list">
            <div class="recent-meals-empty">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <p>No recent meals yet.<br><span style="font-size: 0.85rem;">Your logged meals will appear here.</span></p>
            </div>
        </div>
        <div class="recent-meal-confirm" id="recent-meal-confirm">
            <div class="recent-meal-confirm-info">
                <div class="recent-meal-confirm-name" id="recent-meal-confirm-name"></div>
                <div class="recent-meal-confirm-macros" id="recent-meal-confirm-macros"></div>
            </div>
            <div class="recent-meal-confirm-btns">
                <button class="recent-meal-btn-photo" onclick="recentMealAddWithPhoto()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    Add with Photo <span class="xp-badge">+1 XP</span>
                </button>
                <button class="recent-meal-btn-quick" onclick="recentMealQuickAdd()">
                    Quick Add (No Photo)
                </button>
            </div>
            <div class="recent-meal-confirm-back">
                <button onclick="showRecentMealsList()">Back to list</button>
            </div>
        </div>
    </div>
</div>

<!-- Workout Photo Preview Modal -->
<div id="workout-preview-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10012; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Photo Preview -->
    <img id="workout-preview-photo" style="width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0;">

    <!-- Close Button -->
    <button onclick="closeWorkoutPreviewModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:13; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Loading Indicator -->
    <div id="workout-photo-loading" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); padding:30px 40px; border-radius:20px; z-index:14; text-align:center;">
        <div style="width:50px; height:50px; border:4px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 15px;"></div>
        <div id="workout-photo-loading-text" style="color:white; font-size:1rem;">Verifying workout...</div>
    </div>

    <!-- Error Message -->
    <div id="workout-photo-error" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(220,38,38,0.9); padding:25px 35px; border-radius:16px; z-index:14; text-align:center; max-width:80%;">
        <div style="color:white; font-size:1rem; font-weight:600;" id="workout-photo-error-text">Error</div>
        <button onclick="document.getElementById('workout-photo-error').style.display='none'" style="margin-top:15px; background:white; color:#dc2626; border:none; padding:10px 25px; border-radius:20px; font-weight:600; cursor:pointer;">OK</button>
    </div>

    <!-- Verify Button -->
    <button onclick="verifyWorkoutPhoto()" id="workout-verify-btn" style="position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:14px 35px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.6); z-index:13; transition:transform 0.2s;">
        Verify Workout
    </button>

    <!-- Cancel Button -->
    <button onclick="closeWorkoutPreviewModal()" style="position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:14px 28px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:13; transition:transform 0.2s;">
        Cancel
    </button>
</div>

<!-- Story Upload Modal -->
<div id="story-upload-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10007; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <div style="width:90%; max-width:500px; background:white; border-radius:20px; overflow:hidden;">
        <!-- Header -->
        <div style="padding:20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:var(--primary);">Create a Post</h3>
            <button onclick="closeStoryUploadModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>

        <!-- Preview Area -->
        <div id="story-preview-area" style="padding:30px; text-align:center; min-height:300px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#f8fafc;">
            <div id="story-preview-placeholder" style="color:var(--text-muted);">
                <svg viewBox="0 0 24 24" style="width:80px; height:80px; fill:var(--text-muted); margin-bottom:15px;">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <p style="font-size:0.9rem;">Select a photo or video to share</p>
            </div>
            <img id="story-preview-image" src="" style="display:none; max-width:100%; max-height:400px; border-radius:12px; object-fit:contain;">
            <video id="story-preview-video" controls style="display:none; max-width:100%; max-height:400px; border-radius:12px;"></video>
        </div>

        <!-- Caption Input -->
        <div style="padding:20px; border-top:1px solid #e5e7eb;">
            <textarea id="story-caption-input" placeholder="Add a caption (optional)..." style="width:100%; min-height:60px; padding:12px; border:1px solid #e5e7eb; border-radius:10px; font-size:0.9rem; resize:vertical; font-family:inherit;"></textarea>
        </div>

        <!-- Actions -->
        <div style="padding:0 20px 20px 20px; display:flex; gap:10px;">
            <label for="story-file-input" style="flex:1; padding:14px; background:var(--secondary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; text-align:center; transition:all 0.2s;">
                Choose Photo/Video
            </label>
            <input type="file" id="story-file-input" accept="image/*,video/*" capture="environment" style="display:none;" onchange="handleStoryFileSelect(event)">

            <button id="story-upload-button" onclick="uploadStory()" disabled style="flex:1; padding:14px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; transition:all 0.2s; opacity:0.5;">
                Share Post
            </button>
        </div>
    </div>
</div>

<!-- Story Viewer Modal -->
<div id="story-viewer-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.98); z-index:10008; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Close Button -->
    <button onclick="closeStoryViewer()" style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.5rem; z-index:10009; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Story Header -->
    <div id="story-viewer-header" style="position:absolute; top:0; left:0; right:0; padding:20px; display:flex; align-items:center; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 100%); z-index:10009;">
        <div id="story-user-avatar" onclick="openStoryUserProfile()" style="width:40px; height:40px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:600; overflow:hidden; cursor:pointer;">

        </div>
        <div onclick="openStoryUserProfile()" style="flex:1; cursor:pointer;">
            <div id="story-user-name" style="color:white; font-weight:600; font-size:0.95rem;"></div>
            <div id="story-timestamp" style="color:rgba(255,255,255,0.8); font-size:0.75rem;"></div>
        </div>

        <!-- Delete button (only show for own stories) -->
        <button id="story-delete-button" onclick="deleteCurrentStory()" style="display:none; background:rgba(239,68,68,0.9); border:none; color:white; padding:8px 16px; border-radius:20px; cursor:pointer; font-size:0.85rem; font-weight:600;">
            Delete
        </button>
    </div>

    <!-- Progress Bars -->
    <div id="story-progress-bars" style="position:absolute; top:0; left:0; right:0; padding:15px 20px; display:flex; gap:4px; z-index:10009;">
        <!-- Progress bars will be injected here -->
    </div>

    <!-- Story Content -->
    <div id="story-content-container" style="width:100%; max-width:500px; height:100%; display:flex; align-items:center; justify-content:center; position:relative;">
        <img id="story-image" src="" style="max-width:100%; max-height:100%; object-fit:contain; border-radius:0;">
        <video id="story-video" playsinline style="display:none; max-width:100%; max-height:100%; object-fit:contain; border-radius:0;"></video>
        <div id="story-caption-overlay" style="position:absolute; bottom:60px; left:0; right:0; padding:20px; background:linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%); color:white; font-size:0.9rem; text-align:center; display:none;">
        </div>
    </div>

    <!-- Navigation Areas (tap left/right to navigate) -->
    <div onclick="previousStory()" style="position:absolute; left:0; top:0; bottom:0; width:30%; z-index:10009; cursor:pointer;"></div>
    <div onclick="nextStory()" style="position:absolute; right:0; top:0; bottom:0; width:70%; z-index:10009; cursor:pointer;"></div>

    <!-- Story Viewers List (bottom section - only show for own stories) -->
    <div id="story-viewers-section" style="display:none; position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.9); padding:20px; max-height:40%; overflow-y:auto; z-index:10009;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h4 style="margin:0; color:white; font-size:0.95rem;">Viewers</h4>
            <span id="story-view-count" style="color:rgba(255,255,255,0.7); font-size:0.85rem;"></span>
        </div>
        <div id="story-viewers-list">
            <!-- Viewers will be injected here -->
        </div>
    </div>
</div>

<script>
// --- PROGRESS / ANALYTICS VIEW ---
async function initProgressView() {
    const user = window.currentUser;
    if (!user) {
        console.error('No user logged in');
        return;
    }

    console.log('Initializing Progress View for user:', user.id);

    try {
        // Show loading
        document.getElementById('progress-loading').style.display = 'block';
        document.getElementById('progress-main-content').style.display = 'none';

        // Fetch data individually with fallbacks
        let workoutCount = 0;
        let workoutHistory = [];
        let milestones = [];
        let checkins = [];
        let pointsData = null;
        let recentExercises = [];

        // Load workout count
        try {
            workoutCount = await dbHelpers.workouts.getWorkoutCount(user.id);
            console.log('Workout count:', workoutCount);
        } catch (e) {
            console.warn('Failed to load workout count:', e);
        }

        // Load workout history
        try {
            workoutHistory = await dbHelpers.workouts.getHistory(user.id, 30);
            console.log('Workout history:', workoutHistory?.length || 0, 'records');
        } catch (e) {
            console.warn('Failed to load workout history:', e);
        }

        // Load milestones
        try {
            milestones = await dbHelpers.milestones.getAll(user.id, 20);
            console.log('Milestones:', milestones?.length || 0);
        } catch (e) {
            console.warn('Failed to load milestones:', e);
        }

        // Load check-ins
        try {
            checkins = await dbHelpers.checkins.getRecent(user.id, 14);
            console.log('Check-ins:', checkins?.length || 0);
        } catch (e) {
            console.warn('Failed to load check-ins:', e);
        }

        // Load points data
        try {
            pointsData = await dbHelpers.points.getPoints(user.id);
            console.log('Points data:', pointsData);
        } catch (e) {
            console.warn('Failed to load points data:', e);
        }

        // Load recent exercises
        try {
            recentExercises = await dbHelpers.workouts.getRecentExercises(user.id, 100);
            console.log('Recent exercises:', recentExercises?.length || 0);
        } catch (e) {
            console.warn('Failed to load recent exercises:', e);
        }

        // Load personal bests
        let personalBests = [];
        let recentPBs = [];
        try {
            [personalBests, recentPBs] = await Promise.all([
                dbHelpers.personalBests.getAll(user.id, 50),
                dbHelpers.personalBests.getHistory(user.id, 5)
            ]);
            console.log('Personal bests:', personalBests?.length || 0);
            console.log('Recent PBs:', recentPBs?.length || 0);
        } catch (e) {
            console.warn('Failed to load personal bests:', e);
        }

        // Update overview stats (commented out as UI was removed in redesign)
        /*
        document.getElementById('total-workouts-stat').innerText = workoutCount || 0;
        document.getElementById('current-streak-stat').innerText = pointsData?.current_streak || 0;
        document.getElementById('total-points-stat').innerText = pointsData?.current_points || 0;
        document.getElementById('avg-calories-stat').innerText = '-';
        */

        // Cache PBs for the custom slot picker
        window._cachedPersonalBests = personalBests;
        window._cachedRecentPBs = recentPBs;

        // Load weigh-in data for body weight graph
        let weighIns = [];
        try {
            weighIns = await dbHelpers.weighIns.getRecent(user.id, 90);
            console.log('Weigh-ins:', weighIns?.length || 0);
        } catch (e) {
            console.warn('Failed to load weigh-ins:', e);
        }

        // Load progress photos
        let progressPhotos = [];
        try {
            progressPhotos = await db.progressPhotos.getAll(user.id, 52);
            console.log('Progress photos:', progressPhotos?.length || 0);
        } catch (e) {
            console.warn('Failed to load progress photos:', e);
        }

        // Render sections
        renderPersonalBests(personalBests, recentPBs);
        renderBodyWeightGraph(weighIns);
        renderProgressPhotosTimeline(progressPhotos);
        // renderCheckins(checkins); // UI removed in redesign
        await renderExerciseProgress(user.id, recentExercises);

        // Hide loading, show content
        document.getElementById('progress-loading').style.display = 'none';
        document.getElementById('progress-main-content').style.display = 'block';

        console.log('✅ Progress view loaded successfully');

    } catch (error) {
        console.error('Critical error loading progress view:', error);
        document.getElementById('progress-loading').innerHTML = `
            <div style="font-size: 2rem; margin-bottom: 10px;">😔</div>
            <div style="color: var(--text-muted); margin-bottom: 10px;">Failed to load progress data</div>
            <div style="font-size: 0.85rem; color: var(--text-muted); font-family: monospace;">${error.message}</div>
        `;
    }
}

function renderWorkoutHistory(workoutHistory) {
    const container = document.getElementById('workout-history-list');

    if (!workoutHistory || workoutHistory.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No workouts yet. Start your first workout!</div>';
        return;
    }

    // Group by date
    const grouped = {};
    workoutHistory.forEach(w => {
        const date = w.workout_date;
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(w);
    });

    // Get unique dates and sort descending
    const dates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).slice(0, 7);

    const html = dates.map(date => {
        const workouts = grouped[date];
        const exercises = [...new Set(workouts.map(w => w.exercise_name))];
        const formattedDate = new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const exerciseList = exercises.slice(0, 3).join(', ');

        return `
            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 5px;">${formattedDate}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                        ${exerciseList}${exercises.length > 3 ? ` +${exercises.length - 3} more` : ''}
                    </div>
                </div>
                <button onclick="shareWorkoutHistoryToFeed('${formattedDate}', '${exerciseList.replace(/'/g, "\\'")}')" style="background: linear-gradient(135deg, #f59e0b, #eab308); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
                    <span>🎉</span> Share
                </button>
            </div>
        `;
    }).join('');

    container.innerHTML = html || '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No recent workouts</div>';
}

// Render Body Weight Graph - line chart of weigh-in data over time
function renderBodyWeightGraph(weighIns) {
    const container = document.getElementById('bodyweight-graph');
    if (!container) return;

    if (!weighIns || weighIns.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 30px 20px;"><div style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;">&#9878;</div><div style="font-size: 0.9rem;">Log your first weigh-in to see your progress here!</div></div>';
        return;
    }

    const preferLbs = localStorage.getItem('weightUnitPreference') === 'lbs';
    const unitLabel = preferLbs ? 'lbs' : 'kg';

    // Sort ascending by date
    const sorted = [...weighIns].sort((a, b) => new Date(a.weigh_in_date) - new Date(b.weigh_in_date));

    const dates = sorted.map(w => {
        const d = new Date(w.weigh_in_date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    const weights = sorted.map(w => {
        const kg = parseFloat(w.weight_kg) || 0;
        return preferLbs ? +(kg * 2.20462).toFixed(1) : +kg.toFixed(1);
    });

    const minWeight = Math.min(...weights);
    const maxWeight = Math.max(...weights);
    // Add some padding to the range so the line doesn't hug the edges
    const range = maxWeight - minWeight || 1;
    const yMin = minWeight - range * 0.15;
    const yMax = maxWeight + range * 0.15;

    // Chart dimensions
    const width = 400;
    const height = 230;
    const padding = { top: 20, right: 15, bottom: 45, left: 45 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    const pointCount = sorted.length;
    const xStep = pointCount > 1 ? chartWidth / (pointCount - 1) : 0;

    // Build SVG
    let svg = `<svg viewBox="0 0 ${width} ${height}" style="width: 100%; display: block; overflow: visible;">`;

    // Gradient fill under the line
    svg += `
        <defs>
            <linearGradient id="weightFillGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#7BA883" stop-opacity="0.3"/>
                <stop offset="100%" stop-color="#7BA883" stop-opacity="0.02"/>
            </linearGradient>
        </defs>
    `;

    // Horizontal grid lines (5 lines)
    const gridLines = 4;
    for (let i = 0; i <= gridLines; i++) {
        const y = padding.top + (chartHeight / gridLines) * i;
        const val = yMax - ((yMax - yMin) / gridLines) * i;
        svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#f1f5f9" stroke-width="1"/>`;
        svg += `<text x="${padding.left - 8}" y="${y + 4}" text-anchor="end" font-size="10" fill="#94a3b8">${val.toFixed(1)}</text>`;
    }

    // Y-axis unit label
    svg += `<text x="${padding.left - 35}" y="${padding.top + chartHeight / 2}" text-anchor="middle" font-size="9" fill="#94a3b8" transform="rotate(-90, ${padding.left - 35}, ${padding.top + chartHeight / 2})">${unitLabel}</text>`;

    // Build line path and area fill
    let linePath = '';
    let areaPath = '';
    const points = [];

    weights.forEach((weight, i) => {
        const x = padding.left + xStep * i;
        const y = padding.top + chartHeight - ((weight - yMin) / (yMax - yMin)) * chartHeight;
        points.push({ x, y, weight, date: dates[i] });
        if (i === 0) {
            linePath = `M ${x},${y}`;
            areaPath = `M ${x},${padding.top + chartHeight} L ${x},${y}`;
        } else {
            linePath += ` L ${x},${y}`;
            areaPath += ` L ${x},${y}`;
        }
    });

    // Close area path
    if (points.length > 0) {
        areaPath += ` L ${points[points.length - 1].x},${padding.top + chartHeight} Z`;
    }

    // Area fill
    svg += `<path d="${areaPath}" fill="url(#weightFillGrad)"/>`;

    // Line
    svg += `<path d="${linePath}" fill="none" stroke="#7BA883" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>`;

    // Data points
    points.forEach((p, i) => {
        const isFirst = i === 0;
        const isLast = i === points.length - 1;
        const r = (isFirst || isLast) ? 5 : 3.5;
        svg += `<circle cx="${p.x}" cy="${p.y}" r="${r}" fill="${isLast ? '#7BA883' : 'white'}" stroke="#7BA883" stroke-width="2"/>`;
    });

    // X-axis date labels
    const labelFreq = Math.max(1, Math.ceil(pointCount / 7));
    points.forEach((p, i) => {
        const showLabel = pointCount <= 8 || i === 0 || i === pointCount - 1 || i % labelFreq === 0;
        if (showLabel) {
            let anchor = 'middle';
            if (i === 0 && pointCount > 1) anchor = 'start';
            else if (i === pointCount - 1 && pointCount > 1) anchor = 'end';
            svg += `<text x="${p.x}" y="${height - 8}" text-anchor="${anchor}" font-size="9" fill="#94a3b8">${p.date}</text>`;
        }
    });

    svg += '</svg>';

    // Stats
    const currentWeight = weights[weights.length - 1];
    const startWeight = weights[0];
    const change = currentWeight - startWeight;
    const changeColor = change < 0 ? '#10b981' : (change > 0 ? '#ef4444' : '#94a3b8');
    const changePrefix = change > 0 ? '+' : '';

    const stats = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 16px;">
            <div style="background: #f0fdf4; padding: 12px 8px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary);">${currentWeight}</div>
                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 3px;">Current (${unitLabel})</div>
            </div>
            <div style="background: #f0fdf4; padding: 12px 8px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.3rem; font-weight: 700; color: ${changeColor};">${changePrefix}${change.toFixed(1)}</div>
                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 3px;">Change (${unitLabel})</div>
            </div>
            <div style="background: #f0fdf4; padding: 12px 8px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary);">${sorted.length}</div>
                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 3px;">Weigh-ins</div>
            </div>
        </div>
    `;

    container.innerHTML = svg + stats;
}

// Render Progress Photos Timeline - grid of weekly progress photos
function renderProgressPhotosTimeline(photos) {
    const container = document.getElementById('progress-photos-container');
    if (!container) return;

    if (!photos || photos.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 30px 20px;"><div style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;">📸</div><div style="font-size: 0.9rem;">Upload your first progress photo on Monday to start tracking your transformation!</div></div>';
        return;
    }

    // Build a grid of photo thumbnails with dates
    let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">';

    photos.forEach(function(photo, index) {
        const weekDate = new Date(photo.photo_week + 'T00:00:00');
        const dateLabel = weekDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const yearLabel = weekDate.getFullYear();

        html += '<div onclick="openProgressPhotoModal(' + index + ')" style="cursor: pointer; position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 3/4; background: #f1f5f9;">';
        html += '<img src="' + photo.photo_url + '" alt="Progress photo" style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">';
        html += '<div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 8px 6px 6px; color: white;">';
        html += '<div style="font-size: 0.7rem; font-weight: 600;">' + dateLabel + '</div>';
        html += '<div style="font-size: 0.6rem; opacity: 0.8;">' + yearLabel + '</div>';
        html += '</div></div>';
    });

    html += '</div>';

    // Stats row
    html += '<div style="display: flex; justify-content: center; gap: 20px; margin-top: 16px; padding-top: 12px; border-top: 1px solid #f1f5f9;">';
    html += '<div style="text-align: center;">';
    html += '<div style="font-size: 1.3rem; font-weight: 700; color: var(--primary);">' + photos.length + '</div>';
    html += '<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 3px;">Photos</div>';
    html += '</div>';

    // Calculate weeks span
    if (photos.length >= 2) {
        var firstDate = new Date(photos[photos.length - 1].photo_week);
        var lastDate = new Date(photos[0].photo_week);
        var weeksDiff = Math.round((lastDate - firstDate) / (7 * 24 * 60 * 60 * 1000));
        html += '<div style="text-align: center;">';
        html += '<div style="font-size: 1.3rem; font-weight: 700; color: var(--primary);">' + weeksDiff + '</div>';
        html += '<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 3px;">Weeks tracked</div>';
        html += '</div>';
    }

    html += '</div>';

    container.innerHTML = html;

    // Store photos for modal
    window._progressPhotosData = photos;
}

// Full-screen modal for viewing a single progress photo
function openProgressPhotoModal(index) {
    var photos = window._progressPhotosData;
    if (!photos || !photos[index]) return;
    var photo = photos[index];

    var weekDate = new Date(photo.photo_week + 'T00:00:00');
    var dateLabel = weekDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

    // Create or reuse modal
    var modal = document.getElementById('progress-photo-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'progress-photo-modal';
        modal.style.cssText = 'display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:200001; align-items:center; justify-content:center; flex-direction:column; padding:20px;';
        document.body.appendChild(modal);
    }

    modal.innerHTML = '<button onclick="closeProgressPhotoModal()" style="position:absolute; top:15px; right:15px; background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem; z-index:2;">&#x2715;</button>'
        + '<img src="' + photo.photo_url + '" style="max-width:100%; max-height:75vh; object-fit:contain; border-radius:12px;">'
        + '<div style="color:white; text-align:center; margin-top:15px;">'
        + '<div style="font-weight:700; font-size:1rem;">' + dateLabel + '</div>'
        + '<div style="font-size:0.85rem; opacity:0.7; margin-top:4px;">Week ' + (photos.length - index) + ' of ' + photos.length + '</div>'
        + '</div>';

    // Navigation arrows
    if (index > 0) {
        modal.innerHTML += '<button onclick="openProgressPhotoModal(' + (index - 1) + ')" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">&#x276F;</button>';
    }
    if (index < photos.length - 1) {
        modal.innerHTML += '<button onclick="openProgressPhotoModal(' + (index + 1) + ')" style="position:absolute; left:15px; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">&#x276E;</button>';
    }

    modal.style.display = 'flex';
}

function closeProgressPhotoModal() {
    var modal = document.getElementById('progress-photo-modal');
    if (modal) modal.style.display = 'none';
}
window.openProgressPhotoModal = openProgressPhotoModal;
window.closeProgressPhotoModal = closeProgressPhotoModal;

// Render Personal Bests section
function renderPersonalBests(personalBests, recentPBs) {
    const pbsContainer = document.getElementById('personal-bests-list');
    const recentPBsContainer = document.getElementById('recent-pbs-list');

    recentPBsContainer.style.display = 'none';

    const preferLbs = localStorage.getItem('weightUnitPreference') === 'lbs';

    // Big 3 always shown
    const BIG_3 = [
        { key: 'Barbell Bench Press', label: 'Max Bench Press' },
        { key: 'Barbell Back Squat', label: 'Max Squat' },
        { key: 'Barbell Romanian Deadlift', label: 'Max Deadlift' }
    ];

    // Build PB lookup map
    const pbMap = {};
    if (personalBests) {
        personalBests.forEach(pb => { pbMap[pb.exercise_name] = pb; });
    }

    // Get custom slots from localStorage (3 user-selected exercises)
    let customSlots = [];
    try {
        customSlots = JSON.parse(localStorage.getItem('customPBSlots') || '[]');
    } catch (e) { customSlots = []; }
    // Ensure exactly 3 slots
    while (customSlots.length < 3) customSlots.push(null);
    customSlots = customSlots.slice(0, 3);

    function formatPBCard(pb, label, isCustom, slotIndex) {
        if (!pb || !pb.best_weight_kg) {
            // Empty state card
            if (isCustom && !label) {
                // Empty custom slot - show add button
                return `
                    <div onclick="openCustomPBPicker(${slotIndex})" style="background: white; padding: 18px; border-radius: 18px; box-shadow: var(--card-shadow); border: 2px dashed rgba(0,0,0,0.1); position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px; cursor: pointer; transition: border-color 0.2s; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;">
                        <div style="font-size: 1.5rem; opacity: 0.3; margin-bottom: 8px;">+</div>
                        <div style="font-weight: 600; color: var(--text-muted); font-size: 0.75rem; opacity: 0.6;">Add Exercise</div>
                    </div>
                `;
            }
            // Big 3 or custom slot with name but no data
            return `
                <div ${isCustom ? `onclick="openCustomPBPicker(${slotIndex})"` : ''} style="background: white; padding: 18px; border-radius: 18px; box-shadow: var(--card-shadow); border: 1px solid rgba(0,0,0,0.02); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; ${isCustom ? 'cursor: pointer; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;' : ''}">
                    <div style="position: absolute; top: 12px; right: 12px; font-size: 1.2rem; opacity: 0.15;">🏆</div>
                    <div style="font-weight: 600; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 15px; padding-right: 25px; line-height: 1.2;">${label}</div>
                    <div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: #e5e7eb; line-height: 1;">-</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 500; margin-top: 4px; opacity: 0.5;">No data yet</div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 12px; font-weight: 500; opacity: 0.5; text-align: right;">-</div>
                </div>
            `;
        }

        let weightDisplay;
        if (preferLbs) {
            const lbs = (pb.best_weight_kg * 2.20462).toFixed(0);
            weightDisplay = `${lbs}lbs`;
        } else {
            weightDisplay = `${pb.best_weight_kg}kg`;
        }
        const reps = pb.best_weight_reps || pb.best_reps || '-';
        const date = pb.best_weight_date
            ? new Date(pb.best_weight_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            : '';

        return `
            <div ${isCustom ? `onclick="openCustomPBPicker(${slotIndex})"` : ''} style="background: white; padding: 18px; border-radius: 18px; box-shadow: var(--card-shadow); border: 1px solid rgba(0,0,0,0.02); position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; ${isCustom ? 'cursor: pointer; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;' : ''}">
                <div style="position: absolute; top: 12px; right: 12px; font-size: 1.2rem; opacity: 0.3;">🏆</div>
                <div style="font-weight: 600; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 15px; padding-right: 25px; line-height: 1.2;">${label}</div>
                <div>
                    <div style="font-size: 1.8rem; font-weight: 800; color: #f59e0b; line-height: 1;">${weightDisplay}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500; margin-top: 4px;">x ${reps} reps</div>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 12px; font-weight: 500; opacity: 0.8; text-align: right;">${date}</div>
            </div>
        `;
    }

    // Render Big 3 cards
    let html = '';
    BIG_3.forEach(ex => {
        html += formatPBCard(pbMap[ex.key], ex.label, false, -1);
    });

    // Render 3 custom slots
    customSlots.forEach((exerciseName, i) => {
        const pb = exerciseName ? pbMap[exerciseName] : null;
        const label = exerciseName || null;
        html += formatPBCard(pb, label, true, i);
    });

    pbsContainer.innerHTML = html;
}

// Custom PB slot picker - uses a reusable overlay for instant display
(function() {
    // Create the persistent overlay once on load
    const overlay = document.createElement('div');
    overlay.id = 'pb-picker-overlay';
    overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200001; display: none; align-items: flex-end; justify-content: center;';
    overlay.innerHTML = `
        <div style="background: white; border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 70vh; display: flex; flex-direction: column; overflow: hidden;">
            <div style="padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 700; font-size: 1.05rem;">Choose Exercise</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 2px;">Select a personal best to track</div>
                </div>
                <div onclick="closePBPicker()" style="width: 32px; height: 32px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; color: var(--text-muted); touch-action: manipulation;">✕</div>
            </div>
            <div id="pb-picker-exercise-list" style="overflow-y: auto; flex: 1;"></div>
        </div>
    `;
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closePBPicker();
    });
    document.body.appendChild(overlay);
})();

function openCustomPBPicker(slotIndex) {
    const BIG_3_KEYS = ['Barbell Bench Press', 'Barbell Back Squat', 'Barbell Romanian Deadlift'];
    let customSlots = [];
    try {
        customSlots = JSON.parse(localStorage.getItem('customPBSlots') || '[]');
    } catch (e) { customSlots = []; }
    while (customSlots.length < 3) customSlots.push(null);

    // Get all available exercises from the stored PBs
    const allPBs = window._cachedPersonalBests || [];
    const usedExercises = new Set([...BIG_3_KEYS, ...customSlots.filter(Boolean)]);

    const availableExercises = allPBs
        .map(pb => pb.exercise_name)
        .filter(name => !usedExercises.has(name) || name === customSlots[slotIndex]);

    availableExercises.sort();

    const exerciseListHtml = availableExercises.length > 0
        ? availableExercises.map(name => `
            <div onclick="selectCustomPBSlot(${slotIndex}, '${name.replace(/'/g, "\\'")}')" style="padding: 14px 18px; border-bottom: 1px solid rgba(0,0,0,0.06); cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: background 0.15s; touch-action: manipulation;" ontouchstart="this.style.background='#f3f4f6'" ontouchend="this.style.background=''" onmouseenter="this.style.background='#f3f4f6'" onmouseleave="this.style.background=''">
                ${name}
            </div>
        `).join('')
        : `<div style="padding: 30px 20px; text-align: center; color: var(--text-muted);">
            <div style="font-size: 1.5rem; margin-bottom: 8px; opacity: 0.4;">🏋️</div>
            <div style="font-size: 0.9rem;">Complete more workouts to unlock exercises for tracking!</div>
        </div>`;

    const clearBtnHtml = customSlots[slotIndex]
        ? `<div onclick="selectCustomPBSlot(${slotIndex}, null)" style="padding: 14px 18px; border-bottom: 1px solid rgba(0,0,0,0.06); cursor: pointer; font-size: 0.95rem; font-weight: 500; color: #ef4444; transition: background 0.15s; touch-action: manipulation;" ontouchstart="this.style.background='#fef2f2'" ontouchend="this.style.background=''" onmouseenter="this.style.background='#fef2f2'" onmouseleave="this.style.background=''">
            Remove this exercise
        </div>`
        : '';

    // Update the exercise list content and show the overlay
    document.getElementById('pb-picker-exercise-list').innerHTML = clearBtnHtml + exerciseListHtml;
    document.getElementById('pb-picker-overlay').style.display = 'flex';
}

function selectCustomPBSlot(slotIndex, exerciseName) {
    let customSlots = [];
    try {
        customSlots = JSON.parse(localStorage.getItem('customPBSlots') || '[]');
    } catch (e) { customSlots = []; }
    while (customSlots.length < 3) customSlots.push(null);

    customSlots[slotIndex] = exerciseName;
    localStorage.setItem('customPBSlots', JSON.stringify(customSlots));

    closePBPicker();

    // Re-render with cached data
    if (window._cachedPersonalBests) {
        renderPersonalBests(window._cachedPersonalBests, window._cachedRecentPBs || []);
    }
}

function closePBPicker() {
    const overlay = document.getElementById('pb-picker-overlay');
    if (overlay) overlay.style.display = 'none';
}

// Share past workout - go to group chats
function shareWorkoutHistoryToFeed(date, exercises) {
    window.pendingWinShare = {
        type: 'workout_complete',
        message: `Throwback to my ${date} workout! 💪`,
        workoutName: exercises || 'Workout',
        improvement: ''
    };
    switchAppTab('friends');
    showToast('Open a group chat to share your win! 💬', 'success');
}

function renderMilestones(milestones, workoutCount = 0, pointsData = null, personalBests = []) {
    const container = document.getElementById('milestones-list');

    const getMilestoneEmoji = (type, value) => {
        if (type === 'workout_count') {
            if (value === 1) return '🎉';
            if (value >= 100) return '👑';
            if (value >= 50) return '🏆';
            if (value >= 25) return '🌟';
            if (value >= 10) return '🔥';
            return '💪';
        }
        if (type === 'workout_streak') return '⚡';
        if (type === 'personal_best') return '🏅';
        if (type === 'points') return '⭐';
        return '🎖️';
    };

    const getMilestoneMessage = (type, value) => {
        if (type === 'workout_count') {
            if (value === 1) return 'First Workout!';
            if (value >= 100) return '100 Workouts - Legend!';
            if (value >= 50) return '50 Workouts - Unstoppable!';
            if (value >= 25) return '25 Workouts - Amazing!';
            if (value >= 10) return '10 Workouts - On Fire!';
            if (value >= 5) return '5 Workouts - Great Start!';
            return `${value} Workouts Complete`;
        }
        if (type === 'workout_streak') return `${value}-Day Streak!`;
        if (type === 'personal_best') return `${value} Personal Best${value > 1 ? 's' : ''}!`;
        if (type === 'points') return `${value} Points Earned!`;
        return 'Achievement Unlocked';
    };

    // If no milestones from database, generate achievements from available data
    let achievementsToShow = milestones || [];

    if (achievementsToShow.length === 0 && (workoutCount > 0 || (personalBests && personalBests.length > 0) || (pointsData && pointsData.current_points > 0))) {
        const generatedAchievements = [];

        // Generate workout count achievements
        if (workoutCount >= 1) {
            const thresholds = [1, 5, 10, 25, 50, 100];
            for (const threshold of thresholds) {
                if (workoutCount >= threshold) {
                    generatedAchievements.push({
                        milestone_type: 'workout_count',
                        milestone_value: threshold,
                        achieved_at: new Date().toISOString()
                    });
                }
            }
        }

        // Generate streak achievements
        const streak = pointsData?.current_streak || 0;
        if (streak >= 7) {
            generatedAchievements.push({
                milestone_type: 'workout_streak',
                milestone_value: streak >= 30 ? 30 : (streak >= 14 ? 14 : 7),
                achieved_at: new Date().toISOString()
            });
        }

        // Generate personal bests achievement
        if (personalBests && personalBests.length > 0) {
            generatedAchievements.push({
                milestone_type: 'personal_best',
                milestone_value: personalBests.length,
                achieved_at: new Date().toISOString()
            });
        }

        // Generate points achievement
        if (pointsData && pointsData.lifetime_points >= 10) {
            generatedAchievements.push({
                milestone_type: 'points',
                milestone_value: pointsData.lifetime_points,
                achieved_at: new Date().toISOString()
            });
        }

        achievementsToShow = generatedAchievements;
    }

    if (achievementsToShow.length === 0) {
        container.innerHTML = '<div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); text-align: center; color: var(--text-muted);">Complete your first workout to unlock achievements!</div>';
        return;
    }

    const html = achievementsToShow.slice(0, 6).map(m => {
        const emoji = getMilestoneEmoji(m.milestone_type, m.milestone_value);
        const message = getMilestoneMessage(m.milestone_type, m.milestone_value);
        const date = new Date(m.achieved_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        return `
            <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 12px; display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 2.5rem;">${emoji}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--primary); font-size: 1rem; margin-bottom: 3px;">${message}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${date}</div>
                </div>
                <button onclick="shareMilestoneToFeed('${message}', '${emoji}')" style="background: linear-gradient(135deg, #f59e0b, #eab308); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <span>🎉</span> Share
                </button>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

// Share milestone - go to group chats
function shareMilestoneToFeed(message, emoji) {
    window.pendingWinShare = {
        type: 'milestone',
        message: `${message} ${emoji}`,
        workoutName: '',
        improvement: ''
    };
    switchAppTab('friends');
    showToast('Open a group chat to share your win! 💬', 'success');
}

function renderCheckins(checkins) {
    const container = document.getElementById('checkins-list');
    if (!container) return; // UI element removed in redesign

    if (!checkins || checkins.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No check-ins yet</div>';
        return;
    }

    const getEnergyEmoji = (level) => {
        if (level === 'high') return '⚡';
        if (level === 'moderate') return '🔋';
        return '🪫';
    };

    const getSleepEmoji = (quality) => {
        if (quality === 'excellent') return '😴';
        if (quality === 'good') return '😊';
        if (quality === 'fair') return '😐';
        return '😓';
    };

    const html = checkins.slice(0, 7).map(c => {
        const date = new Date(c.checkin_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const energyEmoji = getEnergyEmoji(c.energy);
        const sleepEmoji = getSleepEmoji(c.sleep);

        return `
            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 3px;">${date}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                        Energy: ${energyEmoji} ${c.energy || 'N/A'} | Sleep: ${sleepEmoji} ${c.sleep || 'N/A'}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.85rem; color: var(--text-muted);">💧 ${c.water_intake || 0} cups</div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

async function renderExerciseProgress(userId, exercises) {
    const dropdown = document.getElementById('exercise-selection-dropdown');
    if (!dropdown) return;

    if (!exercises || exercises.length === 0) {
        dropdown.innerHTML = '<option value="">No exercises tracked yet</option>';
        return;
    }

    // Sort exercises alphabetically
    const sortedExercises = [...exercises].sort();

    // Clear and populate dropdown
    dropdown.innerHTML = '<option value="">Select an exercise...</option>' + 
        sortedExercises.map(ex => `<option value="${ex.replace(/"/g, '&quot;')}">${ex}</option>`).join('');
}

// Show detailed exercise chart modal
async function showExerciseDetailChart(exerciseName, userId) {
    console.log('Opening chart for:', exerciseName);

    // Show modal
    const modal = document.getElementById('exercise-chart-modal');
    modal.style.display = 'flex';
    document.getElementById('exercise-chart-title').innerText = exerciseName;
    document.getElementById('exercise-chart-content').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Loading chart...</div>';

    try {
        // Fetch detailed progress (last 20 workouts)
        const progress = await dbHelpers.workouts.getExerciseProgress(userId, exerciseName, 20);

        if (!progress || progress.length === 0) {
            document.getElementById('exercise-chart-content').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No progress data available</div>';
            return;
        }

        // Render the chart
        renderExerciseChart(progress);

    } catch (error) {
        console.error('Error loading exercise chart:', error);
        document.getElementById('exercise-chart-content').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Failed to load chart</div>';
    }
}

// Close the exercise chart modal
function closeExerciseChartModal() {
    document.getElementById('exercise-chart-modal').style.display = 'none';
}

// Render SVG chart for exercise progress
function renderExerciseChart(progress) {
    const container = document.getElementById('exercise-chart-content');

    // Prepare data
    const dates = progress.map(p => {
        const d = new Date(p.workout_date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    const weights = progress.map(p => parseFloat(p.weight_kg) || 0);
    const reps = progress.map(p => parseInt(p.reps) || 0);

    const hasWeight = weights.some(w => w > 0);
    const hasReps = reps.some(r => r > 0);

    // Chart dimensions
    const width = 400;
    const height = 250;
    const padding = { top: 20, right: 50, bottom: 40, left: 50 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // Calculate scales
    const maxWeight = Math.max(...weights, 1);
    const maxReps = Math.max(...reps, 1);

    // Create SVG
    let svg = `<svg viewBox="0 0 ${width} ${height}" style="width: 100%; max-width: 500px; margin: 0 auto; display: block; overflow: visible;">`;

    // Grid lines
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#f1f5f9" stroke-width="1"/>`;
    }

    // X-axis labels (dates)
    const labelFrequency = Math.ceil(dates.length / 5);
    const xStep = dates.length > 1 ? chartWidth / (dates.length - 1) : 0;
    dates.forEach((date, i) => {
        if (i % labelFrequency === 0 || i === dates.length - 1) {
            const x = padding.left + xStep * i;
            // Use text-anchor start for first label, end for last, middle for others
            let anchor = 'middle';
            if (i === 0) anchor = 'start';
            else if (i === dates.length - 1 && dates.length > 1) anchor = 'end';
            svg += `<text x="${x}" y="${height - 10}" text-anchor="${anchor}" font-size="10" fill="#718096">${date}</text>`;
        }
    });

    // Y-axis labels and data lines
    const dataXStep = dates.length > 1 ? chartWidth / (dates.length - 1) : 0;

    if (hasWeight) {
        // Weight line (primary - green)
        let weightPath = 'M';
        weights.forEach((weight, i) => {
            const x = padding.left + dataXStep * i;
            const y = padding.top + chartHeight - (weight / maxWeight) * chartHeight;
            weightPath += ` ${x},${y}`;

            // Add point
            svg += `<circle cx="${x}" cy="${y}" r="4" fill="#7BA883" stroke="white" stroke-width="2"/>`;
        });
        svg += `<path d="${weightPath}" fill="none" stroke="#7BA883" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>`;

        // Y-axis labels for weight
        for (let i = 0; i <= 4; i++) {
            const value = (maxWeight / 4) * (4 - i);
            const y = padding.top + (chartHeight / 4) * i;
            svg += `<text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" font-size="10" fill="#7BA883" font-weight="600">${value.toFixed(0)}kg</text>`;
        }
    }

    if (hasReps) {
        // Reps line (secondary - gold)
        let repsPath = 'M';
        reps.forEach((rep, i) => {
            const x = padding.left + dataXStep * i;
            const y = padding.top + chartHeight - (rep / maxReps) * chartHeight;
            repsPath += ` ${x},${y}`;

            // Add point
            svg += `<circle cx="${x}" cy="${y}" r="4" fill="#E8D68E" stroke="white" stroke-width="2"/>`;
        });
        svg += `<path d="${repsPath}" fill="none" stroke="#E8D68E" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>`;

        // Y-axis labels for reps (on right side)
        for (let i = 0; i <= 4; i++) {
            const value = (maxReps / 4) * (4 - i);
            const y = padding.top + (chartHeight / 4) * i;
            svg += `<text x="${width - padding.right + 10}" y="${y + 4}" text-anchor="start" font-size="10" fill="#E8D68E" font-weight="600">${value.toFixed(0)} reps</text>`;
        }
    }

    svg += '</svg>';

    // Add legend
    let legend = '<div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px; font-size: 0.85rem;">';
    if (hasWeight) {
        legend += '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 3px; background: #7BA883; border-radius: 2px;"></div><span style="color: var(--text-muted);">Weight (kg)</span></div>';
    }
    if (hasReps) {
        legend += '<div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 3px; background: #E8D68E; border-radius: 2px;"></div><span style="color: var(--text-muted);">Reps</span></div>';
    }
    legend += '</div>';

    // Stats summary
    const firstWeight = weights[0] || 0;
    const lastWeight = weights[weights.length - 1] || 0;
    const firstReps = reps[0] || 0;
    const lastReps = reps[reps.length - 1] || 0;
    const weightChange = lastWeight - firstWeight;
    const repsChange = lastReps - firstReps;

    let stats = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">';

    if (hasWeight && weightChange !== 0) {
        stats += `
            <div style="background: #f0fdf4; padding: 15px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: ${weightChange > 0 ? '#10b981' : '#ef4444'};">${weightChange > 0 ? '+' : ''}${weightChange.toFixed(1)}kg</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">Weight Change</div>
            </div>
        `;
    }

    if (hasReps && repsChange !== 0) {
        stats += `
            <div style="background: #fefce8; padding: 15px; border-radius: 12px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: ${repsChange > 0 ? '#10b981' : '#ef4444'};">${repsChange > 0 ? '+' : ''}${repsChange}</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">Reps Change</div>
            </div>
        `;
    }

    stats += '</div>';

    container.innerHTML = `
        <div style="padding: 20px; overflow: visible;">
            ${svg}
            ${legend}
            ${stats}
        </div>
    `;
}
</script>

<script>
// --- HORMONE HUB & SUPERBOOST ENGINE ---

// Use window.checkInProgress (may already be defined by early script)
if (typeof window.checkInProgress === 'undefined') {
    window.checkInProgress = { flow: null, symptoms: [], mood: null, energy: null, fluid: null, equipment: null, recovery: null };
}
var checkInProgress = window.checkInProgress;

async function initCycleView() {
    // 1. Ensure Data Loaded - MUST await this to load from DB before rendering
    if(typeof initCalendarView === 'function') {
        await initCalendarView();
    }

    // 2. Render Wheel (now data is loaded)
    renderCycleStatus();

    // 3. Render Calendar
    if(typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();

    // 4. Check Daily Log Status
    const today = new Date().toISOString().split('T')[0];
    const hasLog = userCycleData.logs && userCycleData.logs[today];

    const promptCard = document.getElementById('check-in-prompt-card');
    const completeCard = document.getElementById('check-in-completed-card');

    if(promptCard && completeCard) {
        // Hide cycle sync cards for male users
        if (typeof isMaleUser === 'function' && isMaleUser()) {
            promptCard.style.display = 'none';
            completeCard.style.display = 'none';
        } else if(hasLog) {
            promptCard.style.display = 'none';
            completeCard.style.display = 'block';
        } else {
            promptCard.style.display = 'flex';
            completeCard.style.display = 'none';
        }
    }
}

function renderCycleStatus() {
    // For male users, show Performance Mode (no cycle tracking)
    if (typeof isMaleUser === 'function' && isMaleUser()) {
        const phase = PHASE_INFO['performance'];
        const dayDisplay = document.getElementById('cycle-day-display');
        const nameDisplay = document.getElementById('cycle-phase-name');
        const descDisplay = document.getElementById('cycle-phase-desc');
        const tagsContainer = document.getElementById('cycle-phase-tags');

        if (dayDisplay && dayDisplay.parentElement) {
            dayDisplay.parentElement.style.display = 'none'; // Hide day counter for males
        }
        if (nameDisplay && phase) {
            nameDisplay.innerText = phase.name;
            nameDisplay.style.color = phase.color;
        }
        if (descDisplay) {
            descDisplay.innerText = "Train based on energy and recovery. Push hard, recover smart.";
        }
        if (tagsContainer && phase) {
            tagsContainer.innerHTML = `
                <span style="background:${phase.color}20; color:${phase.color}; padding:4px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">${phase.icon} PERFORMANCE</span>
            `;
        }
        return;
    }

    const today = new Date();
    // Default values
    let dayNum = 1;
    let phase = 'wellness';
    
    if (userCycleData.lastPeriod && !userCycleData.noPeriodMode) {
        const lastP = new Date(userCycleData.lastPeriod);
        const diff = Math.floor((today - lastP) / (1000 * 60 * 60 * 24));
        dayNum = (diff % userCycleData.cycleLength) + 1;
        
        // Determine Phase
        if (dayNum >= 1 && dayNum <= 5) phase = 'menstrual';
        else if (dayNum <= 13) phase = 'follicular';
        else if (dayNum <= 16) phase = 'ovulation';
        else phase = 'luteal';
    }
    
    // Update UI
    const dayDisplay = document.getElementById('cycle-day-display');
    const nameDisplay = document.getElementById('cycle-phase-name');
    const descDisplay = document.getElementById('cycle-phase-desc');
    const tagsContainer = document.getElementById('cycle-phase-tags');
    
    if(dayDisplay) dayDisplay.innerText = dayNum;
    
    const info = PHASE_INFO[phase];
    if(nameDisplay && info) {
        nameDisplay.innerText = info.name;
        nameDisplay.style.color = info.color;
    }
    if(descDisplay && info) {
        descDisplay.innerText = info.rec || "Listen to your body.";
    }
    
    // Tags
    if(tagsContainer && info) {
        tagsContainer.innerHTML = `
            <span style="background:${info.color}20; color:${info.color}; padding:4px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">${info.icon} ${phase.toUpperCase()}</span>
        `;
    }
}

// --- CHECK-IN LOGIC ---

function openCheckInModal() {
    // Ensure gender-specific UI is applied before showing modal
    if (typeof applyGenderSpecificUI === 'function') {
        applyGenderSpecificUI();
    }
    document.getElementById('check-in-modal').style.display = 'flex';
    // Clear previous selection visually? Or keep if re-opening?
    // For now, keep state
}

function closeCheckInModal() {
    document.getElementById('check-in-modal').style.display = 'none';
}

function selectCheckInOption(category, value, el) {
    // 1. Update State
    checkInProgress[category] = value;

    // 2. Update UI (Siblings)
    const options = document.querySelectorAll(`.check-in-chip[data-group="${category}"]`);
    options.forEach(opt => opt.classList.remove('selected'));

    // 3. Select Clicked
    el.classList.add('selected');
}

function toggleCheckInOption(category, value, el) {
    // 1. Update State (Array)
    if(!checkInProgress[category]) checkInProgress[category] = [];

    const idx = checkInProgress[category].indexOf(value);
    if(idx > -1) {
        checkInProgress[category].splice(idx, 1); // Remove
        el.classList.remove('selected');
    } else {
        checkInProgress[category].push(value); // Add
        el.classList.add('selected');
    }
}

// Expose check-in functions to global scope for inline onclick handlers
window.openCheckInModal = openCheckInModal;
window.closeCheckInModal = closeCheckInModal;
window.selectCheckInOption = selectCheckInOption;
window.toggleCheckInOption = toggleCheckInOption;

// Real implementation of submitDailyCycleSync
window._submitDailyCycleSyncImpl = async function() {
    // 1. Save Log locally
    const today = new Date().toISOString().split('T')[0];
    if(!userCycleData.logs) userCycleData.logs = {};

    // Clone to avoid ref issues
    userCycleData.logs[today] = JSON.parse(JSON.stringify(checkInProgress));

    // NEW: Add timestamp for when check-in was completed (for equipment override priority)
    userCycleData.logs[today].timestamp = new Date().toISOString();

    // Update userCycleData.symptoms from check-in
    userCycleData.symptoms = checkInProgress.symptoms || [];

    // Persist to localStorage
    localStorage.setItem('userCycleData', JSON.stringify(userCycleData));

    // 2. Save to Supabase for persistence across refreshes
    if(window.currentUser && typeof dbHelpers !== 'undefined') {
        try {
            await dbHelpers.checkins.upsert(window.currentUser.id, today, {
                energy: checkInProgress.energy || null,
                equipment: checkInProgress.equipment || null,
                additional_data: {
                    symptoms: checkInProgress.symptoms || [],
                    mood: checkInProgress.mood || null,
                    flow: checkInProgress.flow || null,
                    fluid: checkInProgress.fluid || null,
                    recovery: checkInProgress.recovery || null
                }
            });
            console.log('✅ Check-in saved to Supabase');
        } catch (e) {
            console.error('Failed to save check-in to DB:', e);
        }
    }

    // Mark check-in as completed for today
    localStorage.setItem('lastWellnessCheck', new Date().toDateString());

    // 2.5. Save equipment selection to update workout recommendations
    if (checkInProgress.equipment && window.currentUser && typeof dbHelpers !== 'undefined') {
        try {
            // Update equipment_access in quiz_results (where it's stored)
            await window.supabaseClient.from('quiz_results')
                .update({ equipment_access: checkInProgress.equipment })
                .eq('user_id', window.currentUser.id);

            // Also update localStorage profile so workout schedules pick it up immediately
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            userProfile.equipment_access = checkInProgress.equipment;
            // Clear legacy gym_access field - equipment_access is the source of truth
            userProfile.gym_access = (checkInProgress.equipment === 'gym');

            // NEW: Add timestamp for equipment update (for override priority)
            userProfile.equipment_updated_at = new Date().toISOString();
            localStorage.setItem('equipmentUpdatedAt', userProfile.equipment_updated_at);
            localStorage.setItem('userProfile', JSON.stringify(userProfile));

            // Update window cache too
            if (window.userProfile) {
                window.userProfile.equipment_access = checkInProgress.equipment;
                window.userProfile.gym_access = (checkInProgress.equipment === 'gym');
                window.userProfile.equipment_updated_at = userProfile.equipment_updated_at;
            }

            // Also update sessionStorage for consistency across all views
            const sessionProfile = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
            sessionProfile.equipment_access = checkInProgress.equipment;
            sessionProfile.gym_access = (checkInProgress.equipment === 'gym');
            sessionProfile.equipment_updated_at = userProfile.equipment_updated_at;
            sessionStorage.setItem('userProfile', JSON.stringify(sessionProfile));

            console.log('✅ Equipment access saved:', checkInProgress.equipment, 'at', userProfile.equipment_updated_at);
        } catch (e) {
            console.warn('Failed to save equipment access:', e);
        }
    }

    // 3. Update Active Symptoms display in Metabolic Protocol section
    const symptomsDisplay = document.getElementById('profile-symptoms-display');
    if (symptomsDisplay) {
        const symptoms = checkInProgress.symptoms || [];
        if (symptoms.length > 0) {
            // Format symptom names nicely (e.g., cramps -> Cramps, back_pain -> Back Pain)
            const formattedSymptoms = symptoms.map(s =>
                s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
            ).join(', ');
            symptomsDisplay.textContent = formattedSymptoms;
        } else {
            symptomsDisplay.textContent = 'None';
        }
    }

    // 4. Trigger Cycle Sync Engine (updates workout recommendations)
    applyCycleSync(checkInProgress);

    // 5. Close & Refresh views
    closeCheckInModal();
    initCycleView(); // Updates calendar
    renderWeeklyCalendar(); // Update weekly calendar view

    // CRITICAL: Refresh Movement view to apply equipment selection
    if (typeof renderMovementView === 'function') {
        renderMovementView();
    }

    // 6. Handle rest-indicating conditions - show yoga recommendation popup
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    const checkInSymptoms = checkInProgress.symptoms || [];
    let yogaPopupReason = null;

    // Check for conditions that should trigger yoga recommendation
    if (checkInProgress.energy === 'low') {
        yogaPopupReason = 'low_energy';
    } else if (isMale && checkInProgress.recovery === 'tired') {
        yogaPopupReason = 'tired';
    } else if (isMale && checkInProgress.recovery === 'moderate') {
        yogaPopupReason = 'fatigued';
    } else if (isMale && checkInSymptoms.includes('muscle_soreness')) {
        yogaPopupReason = 'muscle_soreness';
    } else if (checkInSymptoms.includes('back_pain')) {
        yogaPopupReason = 'back_pain';
    } else if (!isMale && checkInSymptoms.includes('cramps')) {
        yogaPopupReason = 'cramps';
    }

    if (yogaPopupReason) {
        // Show yoga recommendation popup with context-aware message
        showLowEnergyYogaPopup(yogaPopupReason);
        return; // The popup will handle navigation
    }

    // 6.5. Handle cycle-based workout recommendations (for women who opted in)
    if (!isMale) {
        // Get user profile to check cycle preferences
        let userProfile = {};
        try { userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}'); } catch(e) {}
        const cycleSyncEnabled = userProfile.cycle_sync_preference === 'yes';
        const periodEnergyLow = userProfile.period_energy_response === 'low';

        // Calculate current cycle phase
        if (cycleSyncEnabled && periodEnergyLow && userCycleData.lastPeriod && !userCycleData.noPeriodMode) {
            const lastPeriod = new Date(userCycleData.lastPeriod);
            const todayDate = new Date();
            const daysSinceStart = Math.floor((todayDate - lastPeriod) / (24 * 60 * 60 * 1000));
            const currentCycleDay = (daysSinceStart % (userCycleData.cycleLength || 28)) + 1;

            // If in menstrual phase (days 1-5), AUTOMATICALLY switch to yoga (no popup)
            if (currentCycleDay >= 1 && currentCycleDay <= 5) {
                const todayDateStr = new Date().toISOString().split('T')[0];

                // Set automatic yoga override
                const yogaOverride = {
                    date: todayDateStr,
                    program: 'yoga',
                    reason: 'cycle_sync_automatic' // Distinct from 'low_energy' popup reason
                };
                localStorage.setItem('todayWorkoutOverride', JSON.stringify(yogaOverride));

                // Update check-in log with automatic flag
                if (userCycleData.logs && userCycleData.logs[todayDateStr]) {
                    userCycleData.logs[todayDateStr].workoutOverride = 'yoga';
                    userCycleData.logs[todayDateStr].cycleAutoSync = true;
                    localStorage.setItem('userCycleData', JSON.stringify(userCycleData));
                }

                // Save to database
                if (typeof saveUserCycleData === 'function') {
                    saveUserCycleData(userCycleData);
                }


                // NO POPUP - continue to dashboard display
                // Let it fall through to normal flow (don't return here)
            }
        }
    }

    // Clear any existing yoga override if energy is NOT low and not in menstrual phase
    localStorage.removeItem('todayWorkoutOverride');

    // Also clear the workoutOverride from today's log
    if (userCycleData.logs && userCycleData.logs[today]) {
        delete userCycleData.logs[today].workoutOverride;
        localStorage.setItem('userCycleData', JSON.stringify(userCycleData));
    }


    // 7. Redirect to Dashboard with Animation
    switchAppTab('dashboard');

    // Show Toast/Banner on Dashboard
    showCycleSyncBanner();
};

// Recovery/Rest yoga recommendation popup - supports multiple trigger reasons
function showLowEnergyYogaPopup(reason = 'low_energy') {
    const isMale = (typeof isMaleUser === 'function' && isMaleUser());
    const syncLabel = isMale ? '💪 Daily Sync' : '✨ Cycle Sync';

    // Context-aware messaging based on why the popup was triggered
    let messageText;
    switch(reason) {
        case 'tired':
        case 'need_rest':
            messageText = isMale
                ? "You indicated you need rest today. We recommend <strong>Somatic Yoga</strong> to help your body recover and rebuild."
                : "You indicated you need rest today. We recommend <strong>Somatic Yoga</strong> to support your recovery.";
            break;
        case 'fatigued':
            messageText = "You're feeling a bit fatigued today. We recommend <strong>Somatic Yoga</strong> to help restore your energy and support recovery.";
            break;
        case 'muscle_soreness':
            messageText = "You're feeling sore today. We recommend <strong>Somatic Yoga</strong> to ease tension, improve mobility, and speed up recovery.";
            break;
        case 'back_pain':
            messageText = "Back pain can benefit from gentle movement. We recommend <strong>Somatic Yoga</strong> to release tension and support healing.";
            break;
        case 'cramps':
            messageText = "Gentle movement can help with cramps. We recommend <strong>Somatic Yoga</strong> designed to ease discomfort and relax your body.";
            break;
        case 'low_energy':
        default:
            messageText = isMale
                ? "We noticed you're feeling low energy today. We recommend <strong>Somatic Yoga</strong> to help you recover and recharge."
                : "We noticed you're feeling low energy today. We recommend <strong>Somatic Yoga</strong> to help you recover and recharge.";
            break;
    }

    // Store the reason for acceptYogaRecommendation to use
    window._yogaPopupReason = reason;

    // Create popup overlay
    const popup = document.createElement('div');
    popup.id = 'low-energy-popup';
    popup.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6); z-index: 3000;
        display: flex; align-items: center; justify-content: center;
        animation: fadeIn 0.3s ease;
    `;

    popup.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 340px; margin: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="font-size: 3rem; margin-bottom: 15px;">🧘‍♀️</div>
            <h3 style="margin: 0 0 10px 0; color: var(--primary); font-size: 1.3rem;">${syncLabel}</h3>
            <p style="color: #64748b; margin: 0 0 20px 0; line-height: 1.5;">
                ${messageText}
            </p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="acceptYogaRecommendation()" style="
                    flex: 1; padding: 14px 20px; background: var(--primary); color: white;
                    border: none; border-radius: 12px; font-weight: 600; cursor: pointer;
                    font-size: 1rem;
                ">Yes, switch to Yoga</button>
                <button onclick="declineYogaRecommendation()" style="
                    flex: 1; padding: 14px 20px; background: #f1f5f9; color: #64748b;
                    border: none; border-radius: 12px; font-weight: 600; cursor: pointer;
                    font-size: 1rem;
                ">Keep my workout</button>
            </div>
        </div>
    `;

    document.body.appendChild(popup);
}

function acceptYogaRecommendation() {
    // Save yoga override for today - use the reason from popup trigger
    const today = new Date().toISOString().split('T')[0];
    const reason = window._yogaPopupReason || 'low_energy';
    const yogaOverride = { date: today, program: 'yoga', reason: reason };
    localStorage.setItem('todayWorkoutOverride', JSON.stringify(yogaOverride));

    // Also update the check-in log to reflect yoga choice
    if (userCycleData.logs && userCycleData.logs[today]) {
        userCycleData.logs[today].workoutOverride = 'yoga';
        localStorage.setItem('userCycleData', JSON.stringify(userCycleData));
    }

    // Save to database if possible
    if (window.currentUser && typeof dbHelpers !== 'undefined') {
        dbHelpers.checkins.upsert(window.currentUser.id, today, {
            workout_override: 'yoga'
        }).catch(e => console.warn('Failed to save workout override:', e));
    }

    // Close popup
    const popup = document.getElementById('low-energy-popup');
    if (popup) popup.remove();

    // Refresh views to show yoga
    if (typeof renderMovementView === 'function') renderMovementView();
    if (typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();

    // Navigate to dashboard
    switchAppTab('dashboard');

    // Show confirmation banner
    const banner = document.createElement('div');
    banner.innerText = "🧘 Switched to Somatic Yoga for today!";
    banner.style.cssText = "position:fixed; top:80px; left:50%; transform:translateX(-50%); background:var(--accent-green); color:white; padding:12px 24px; border-radius:20px; z-index:2000; font-weight:600; box-shadow:0 4px 12px rgba(0,0,0,0.2);";
    document.body.appendChild(banner);
    setTimeout(() => { banner.style.opacity = '0'; setTimeout(() => banner.remove(), 500); }, 3000);
}

function declineYogaRecommendation() {
    // Record that user declined - so we don't force yoga on them
    const today = new Date().toISOString().split('T')[0];
    if (userCycleData.logs && userCycleData.logs[today]) {
        userCycleData.logs[today].workoutOverride = 'declined';
        localStorage.setItem('userCycleData', JSON.stringify(userCycleData));
    }

    // Close popup without changing workout
    const popup = document.getElementById('low-energy-popup');
    if (popup) popup.remove();

    // Navigate to dashboard
    switchAppTab('dashboard');

    // Show regular banner
    showCycleSyncBanner();
}

// Expose yoga recommendation functions to global scope for inline onclick handlers
window.acceptYogaRecommendation = acceptYogaRecommendation;
window.declineYogaRecommendation = declineYogaRecommendation;

function applyCycleSync(data) {
    console.log("🚀 Applying Cycle Sync:", data);
    // This function will be called by renderDashboard to override suggestions
    // For now, we save it to session state or global
    window.cycleSyncState = data;
    
}

function showCycleSyncBanner() {
    // Create a temporary banner
    const banner = document.createElement('div');
    banner.innerText = "✨ Dashboard Updated with your Cycle Sync!";
    banner.style.cssText = "position:fixed; top:80px; left:50%; transform:translateX(-50%); background:var(--primary); color:white; padding:10px 20px; border-radius:20px; z-index:2000; font-weight:600; box-shadow:0 4px 12px rgba(0,0,0,0.2); animation: fadeIn 0.5s;";
    document.body.appendChild(banner);
    
    setTimeout(() => {
        banner.style.opacity = '0';
        setTimeout(() => banner.remove(), 500);
    }, 3000);
}

// --- CYCLE SYNC RECIPE DATABASE ---
const CYCLE_SYNC_RECIPES = {
    'bloating': {
        title: "Ginger Pear Smoothie",
        meta: "Anti-Bloat Elixir",
        img: "/assets/ginger_pear_smoothie.png",
        why: "Ginger and pear are natural diuretics that help flush excess water and soothe digestion.",
        ingredients: ["Pear 170g", "Spinach 50g", "Cucumber 80g", "Ginger 1 inch", "Pea Protein 30g"],
        prep: "Blend all ingredients with water and ice until smooth."
    },
    'cramps': {
        title: "Stuffed Sweet Potato",
        meta: "Magnesium Rescue",
        img: "/assets/stuffed_sweet_potato.jpg",
        why: "Sweet potatoes and black beans are rich in magnesium, which relaxes uterine muscles to ease cramps.",
        ingredients: ["Sweet Potato 1 large", "Black Beans 1/2 cup", "Quinoa 1/2 cup", "Pumpkin Seeds 1 tbsp"],
        prep: "Roast potato. Stuff with quinoa and beans. Top with seeds."
    },
    'mood': {
        title: "Cacao Night Calm",
        meta: "Serotonin Boost",
        img: "/assets/smoothie_cacao_calm.png",
        why: "Raw cacao stimulates serotonin, while almond butter stabilizes blood sugar to level out your mood.",
        ingredients: ["Frozen Banana 1", "Raw Cacao 1 tbsp", "Almond Butter 1 tbsp", "Oat Milk 1 cup"],
        prep: "Blend until creamy. Top with cacao nibs."
    },
    'fatigue': {
        title: "Matcha Mint Energy",
        meta: "Sustained Focus",
        img: "/assets/smoothie_matcha_mint.png",
        why: "L-Theanine in matcha provides calm, sustained energy without the cortisol spike of coffee.",
        ingredients: ["Matcha Powder 1 tsp", "Mint Leaves 5", "Frozen Banana 1/2", "Vanilla Protein 1 scoop"],
        prep: "Blend with coconut milk for a creamy energy boost."
    },
    'inflammation': {
        title: "Golden Turmeric Tonic",
        meta: "Inflammation Fighter",
        img: "/assets/smoothie_golden_turmeric.png",
        why: "Turmeric's curcumin is a potent anti-inflammatory compound, especially when paired with black pepper.",
        ingredients: ["Mango 1/2 cup", "Turmeric 1 tsp", "Black Pepper pinch", "Flax Oil 1 tsp"],
        prep: "Blend with coconut milk. Enjoy immediately."
    }
};

function renderCycleSyncMeal(reason, recipeKey) {
    const container = document.getElementById('today-meals-container'); // Need to ensure this exists or find where to inject
    const recipe = CYCLE_SYNC_RECIPES[recipeKey];
    if(!recipe || !container) return;

    // Save the swapped meal data so we can add it to the meal plan
    window.cycleSyncMealTitle = recipe.title;
    window.cycleSyncMealData = recipe;
    window.cycleSyncMealReason = reason;

    const html = `
    <div style="background: linear-gradient(135deg, #fff 0%, #fefce8 100%); border: 2px solid var(--secondary); border-radius: 16px; margin-bottom: 25px; overflow: hidden; box-shadow: 0 10px 30px rgba(180, 155, 10, 0.15); animation: slideUp 0.4s ease-out;">
        <div style="background: var(--secondary); color: black; padding: 8px 15px; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; display:flex; justify-content:space-between; align-items:center;">
             <span>✨ Cycle Sync Meal Swap</span>
             <span>${reason}</span>
        </div>
        <div style="display: flex; flex-direction: column; md:flex-row;">
            <div style="padding: 20px;">
                <div style="font-family:'Playfair Display'; font-size: 1.4rem; color: var(--primary); margin-bottom: 5px; font-weight:700;">${recipe.title}</div>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 12px; font-weight:500;">${recipe.meta}</div>
                <p style="font-size: 0.95rem; color: #4a5568; margin-bottom: 15px; line-height: 1.5; background: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; border-left: 3px solid var(--secondary);">${recipe.why}</p>
                
                <button onclick="switchAppTab('meals', this); setTimeout(() => switchWeek('today'), 50);" style="background: white; border: 1px solid #cbd5e0; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">View Recipe</button>
            </div>
            <img src="${recipe.img}" style="width: 100%; height: 180px; object-fit: cover; md:width: 150px; md:height: auto;" onerror="this.style.display='none'">
        </div>
        
        <!-- Collapsible Details (Hidden by default) -->
        <div class="card card-body" style="padding: 0 20px; margin:0; box-shadow:none; border:none; background:transparent;">
            <div style="padding: 20px 0;">
                <h4 style="margin-top:0;">Ingredients</h4>
                <ul style="margin-bottom:15px;">
                    ${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}
                </ul>
                <h4 style="margin-top:0;">Preparation</h4>
                <p>${recipe.prep}</p>
            </div>
        </div>
    </div>
    `;
    
    // Insert at top of meals
    const existing = document.getElementById('cycle-sync-meal-card');
    if(existing) existing.remove();
    
    // Create wrapper if implies
    const wrapper = document.createElement('div');
    wrapper.id = 'cycle-sync-meal-card';
    wrapper.innerHTML = html;
    
    container.insertBefore(wrapper, container.firstChild);
}

function checkAndRenderCycleSync() {
    // Check if we have a log for today
    if(!userCycleData || !userCycleData.logs) return;
    
    const today = new Date().toISOString().split('T')[0];
    const log = userCycleData.logs[today];
    
    if(log && log.symptoms && log.symptoms.length > 0) {
        // Prioritize symptoms for display
        const priorities = ['bloating', 'cramps', 'mood', 'fatigue', 'inflammation'];
        let match = null;
        
        // Find highest priority symptom
        for(let p of priorities) {
             // Basic matching - handle "mood" specially if it's a category
             if(p === 'mood') {
                 if(log.mood === 'sad' || log.mood === 'anxious') {
                     match = 'mood'; 
                     break; 
                 }
             }
             if(log.symptoms.includes(p)) {
                 match = p;
                 break;
             }
        }
        
        // Fallback to mood mapping if no physical symptoms but mood is low
        if(!match && (log.mood === 'sad' || log.mood === 'anxious')) {
            match = 'mood';
        }

        if(match) {
            renderCycleSyncMeal(match.charAt(0).toUpperCase() + match.slice(1), match);
        }
    
    } else if (log && log.energy === 'low') {
         renderCycleSyncMeal('Energy Boost', 'fatigue');
    }
}

// Initial Load - MUST wait for auth before loading cycle data from DB
document.addEventListener('DOMContentLoaded', async () => {
    // Wait for auth to complete before loading user-specific data
    const waitForAuth = () => new Promise(resolve => {
        if(window.currentUser) return resolve(window.currentUser);
        const check = setInterval(() => {
            if(window.currentUser) {
                clearInterval(check);
                resolve(window.currentUser);
            }
        }, 100);
        // Timeout after 5s just in case
        setTimeout(() => { clearInterval(check); resolve(null); }, 5000);
    });

    await waitForAuth();
    console.log('🔐 Auth ready for cycle data load, currentUser:', window.currentUser?.id);

    // Load cycle data from localStorage AND database (now that auth is ready)
    if(typeof initCalendarView === 'function') {
        initCalendarView().then(() => {
            // After data is loaded, check for Cycle Sync
            checkAndRenderCycleSync();
        }).catch(err => {
            console.log('Error loading calendar view:', err);
            // Still try to check Cycle Sync even if there was an error
            checkAndRenderCycleSync();
        });
    } else {
        // Fallback if initCalendarView doesn't exist
        setTimeout(checkAndRenderCycleSync, 1000);
    }
    // Check if we need to load cycle view
    // (Existing init calls will handle this if tab is active)
});

</script>

<script>
// ==========================================
// POINTS WIDGET FUNCTIONS
// ==========================================

const POINTS_FOR_FREE_WEEK = 200;
const MAX_LEVEL = 99;
const LEVEL_CURVE_MULTIPLIER = 1.3;
const LEVEL_CURVE_EXPONENT = 1.55;

// Calculate points required for a given level
function getPointsForLevel(level) {
    if (level <= 1) return 0;
    return Math.floor(LEVEL_CURVE_MULTIPLIER * Math.pow(level, LEVEL_CURVE_EXPONENT));
}

// Calculate user's current level from lifetime points
function calculateLevel(lifetimePoints) {
    let level = 1;

    while (level < MAX_LEVEL) {
        const pointsNeeded = getPointsForLevel(level + 1);
        if (lifetimePoints < pointsNeeded) break;
        level++;
    }

    const currentLevelPoints = getPointsForLevel(level);
    const nextLevelPoints = level < MAX_LEVEL ? getPointsForLevel(level + 1) : currentLevelPoints;
    const pointsIntoLevel = lifetimePoints - currentLevelPoints;
    const pointsNeededForNext = nextLevelPoints - currentLevelPoints;
    const progress = level >= MAX_LEVEL ? 100 : Math.min(100, Math.floor((pointsIntoLevel / pointsNeededForNext) * 100));

    return {
        level,
        currentLevelPoints,
        nextLevelPoints,
        pointsIntoLevel,
        pointsNeededForNext,
        progress,
        isMaxLevel: level >= MAX_LEVEL
    };
}

// Get level title based on level
function getLevelTitle(level) {
    if (level >= 99) return 'Legend';
    if (level >= 90) return 'Master';
    if (level >= 80) return 'Champion';
    if (level >= 70) return 'Expert';
    if (level >= 60) return 'Veteran';
    if (level >= 50) return 'Dedicated';
    if (level >= 40) return 'Committed';
    if (level >= 30) return 'Consistent';
    if (level >= 20) return 'Growing';
    if (level >= 10) return 'Rising';
    if (level >= 5) return 'Beginner';
    return 'Newcomer';
}

// Load and display user's points data
async function loadPointsWidget() {
    // Always show the widget (even with default values)
    const widget = document.getElementById('points-widget');
    if (widget) {
        widget.style.display = 'block';
    }

    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) {
            console.log('No user session, showing default points widget');
            updatePointsDisplay({ current_points: 0, current_streak: 0 });
            return;
        }

        const userId = session.user.id;

        // Try to get points data, fall back to defaults if table doesn't exist
        let pointsData = { current_points: 0, current_streak: 0 };
        try {
            const data = await window.db?.points?.getPoints(userId);
            if (data) {
                pointsData = data;
            }
        } catch (dbError) {
            console.log('Points table not set up yet, using defaults');
        }

        // Update points display
        updatePointsDisplay(pointsData);

    } catch (error) {
        console.error('Error loading points widget:', error);
        // Still show with defaults
        updatePointsDisplay({ current_points: 0, current_streak: 0 });
    }
}

// Expose to window for other scripts (stories.js) to refresh points
window.loadUserPoints = loadPointsWidget;
// Alias for learning-inline.js and other scripts that call refreshLevelDisplay
window.refreshLevelDisplay = loadPointsWidget;

// Update points display with current data
function updatePointsDisplay(pointsData) {
    const currentPoints = pointsData.current_points || 0;
    const lifetimePoints = pointsData.lifetime_points || 0;
    const currentStreak = pointsData.current_streak || 0;

    // Calculate level from lifetime points
    const levelData = calculateLevel(lifetimePoints);

    // Update level display
    const levelEl = document.getElementById('level-current');
    if (levelEl) {
        levelEl.textContent = levelData.level;
    }

    // Update SVG level ring progress (circumference = 2 * PI * 45 ≈ 283)
    const levelRingSvg = document.getElementById('level-ring-svg');
    if (levelRingSvg) {
        const circumference = 283;
        const offset = circumference - (levelData.progress / 100) * circumference;
        levelRingSvg.style.strokeDashoffset = offset;
    }

    // Update level title
    const levelTitleEl = document.getElementById('level-title');
    if (levelTitleEl) {
        levelTitleEl.textContent = getLevelTitle(levelData.level);
    }

    // Update level progress bar
    const levelProgressFill = document.getElementById('level-progress-fill');
    if (levelProgressFill) {
        levelProgressFill.style.width = `${levelData.progress}%`;
    }

    // Update level progress label
    const levelProgressLabel = document.getElementById('level-progress-label');
    if (levelProgressLabel) {
        if (levelData.isMaxLevel) {
            levelProgressLabel.textContent = 'MAX LEVEL - Legend!';
        } else {
            const xpToNext = levelData.pointsNeededForNext - levelData.pointsIntoLevel;
            levelProgressLabel.textContent = `${xpToNext} XP to Level ${levelData.level + 1}`;
        }
    }

    // Update points number
    const pointsEl = document.getElementById('points-current');
    if (pointsEl) {
        pointsEl.textContent = currentPoints.toLocaleString();
    }

    // Update streak
    const streakEl = document.getElementById('streak-current');
    if (streakEl) {
        streakEl.textContent = currentStreak;
    }

    // Update progress bar
    const progressPercent = Math.min(100, (currentPoints / POINTS_FOR_FREE_WEEK) * 100);
    const progressFill = document.getElementById('points-progress-fill');
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
    }

    // Update progress label
    const progressLabel = document.getElementById('points-progress-label');
    if (progressLabel) {
        const remaining = POINTS_FOR_FREE_WEEK - currentPoints;
        if (currentPoints >= POINTS_FOR_FREE_WEEK) {
            progressLabel.textContent = 'Ready to redeem a free week!';
        } else {
            progressLabel.textContent = `${currentPoints}/${POINTS_FOR_FREE_WEEK} to free week`;
        }
    }

    // UPDATE FITGOTCHI WIDGET
    if (typeof window.updateFitGotchi === 'function') {
        window.updateFitGotchi(pointsData);
    }
}

// Redeem points for free week
async function redeemPointsForFreeWeek() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) {
            alert('Please log in to redeem points');
            return;
        }

        const redeemBtn = document.getElementById('redeem-btn');
        if (redeemBtn) {
            redeemBtn.disabled = true;
            redeemBtn.textContent = 'Redeeming...';
        }

        const result = await window.db?.points?.redeemPoints(session.user.id);

        if (result?.success) {
            showMilestoneToast({
                label: 'Free Week Unlocked!',
                points: -POINTS_FOR_FREE_WEEK
            });

            // Refresh points display
            await loadPointsWidget();

            alert(`Congratulations! You've earned 7 free days!\n\nYour subscription has been extended.`);
        } else {
            alert(result?.message || 'Could not redeem points. Please try again.');
            // Re-enable button
            if (redeemBtn) {
                redeemBtn.disabled = false;
                redeemBtn.textContent = 'Redeem Free Week!';
            }
        }
    } catch (error) {
        console.error('Error redeeming points:', error);
        alert('An error occurred. Please try again.');
    }
}

// Show milestone achievement toast
function showMilestoneToast(milestone) {
    const toast = document.createElement('div');
    toast.className = 'milestone-toast';
    toast.innerHTML = `
        <div class="milestone-icon">&#x1F389;</div>
        <div>
            <div class="milestone-title">${milestone.label}</div>
            ${milestone.points > 0 ? `<div class="milestone-points">+${milestone.points} points</div>` : ''}
        </div>
    `;

    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 4 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Show points earned toast
function showPointsEarnedToast(points, bonusPoints = 0, streak = 0) {
    const toast = document.createElement('div');
    toast.className = 'points-earned-toast';
    toast.innerHTML = `
        <div class="points-earned-main">+${points} pt${points > 1 ? 's' : ''}</div>
        ${bonusPoints > 0 ? `<div class="points-earned-bonus">+${bonusPoints} streak bonus!</div>` : ''}
        ${streak > 0 ? `<div class="points-earned-streak">&#x1F525; ${streak}</div>` : ''}
    `;

    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Play level-up sound effect using Web Audio API
function playLevelUpSound() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Create a celebratory ascending arpeggio
        const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
        const noteDuration = 0.15;

        notes.forEach((freq, index) => {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime + index * noteDuration);

            // Envelope
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime + index * noteDuration);
            gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + index * noteDuration + 0.02);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + index * noteDuration + noteDuration);

            oscillator.start(audioCtx.currentTime + index * noteDuration);
            oscillator.stop(audioCtx.currentTime + index * noteDuration + noteDuration);
        });

        // Final triumphant chord
        const chordDelay = notes.length * noteDuration;
        const chordFreqs = [523.25, 659.25, 783.99]; // C major chord
        chordFreqs.forEach(freq => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + chordDelay);
            gain.gain.setValueAtTime(0, audioCtx.currentTime + chordDelay);
            gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + chordDelay + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + chordDelay + 0.5);
            osc.start(audioCtx.currentTime + chordDelay);
            osc.stop(audioCtx.currentTime + chordDelay + 0.5);
        });
    } catch (e) {
        console.log('Could not play level up sound:', e);
    }
}

// Create expanding glow rings effect
function createGlowRings() {
    const container = document.createElement('div');
    container.className = 'level-up-rings-container';

    for (let i = 0; i < 4; i++) {
        const ring = document.createElement('div');
        ring.className = 'level-up-ring';
        container.appendChild(ring);
    }

    document.body.appendChild(container);

    // Remove after animation completes
    setTimeout(() => container.remove(), 2000);
}

// Trigger victory animation on Shazie
function triggerVictoryAnimation() {
    const mv = document.getElementById('tamagotchi-model');
    if (!mv) return;

    function playVictoryAnim() {
        if (!mv.availableAnimations || !mv.availableAnimations.length) return;

        // Prioritise dance animations for level-up celebrations
        const victoryAnim = mv.availableAnimations.find(a =>
            a === 'dance' ||
            a === 'dance_1'
        ) || mv.availableAnimations.find(a =>
            a === 'clap' ||
            a === 'arms_up_still' ||
            a === 'laugh'
        ) || mv.availableAnimations.find(a =>
            a === 'greet' ||
            a === 'strut' ||
            a === 'warm_up'
        );

        if (victoryAnim) {
            mv.animationName = victoryAnim;
            mv.play();

            // Loop the dance: replay once after the first play to fill the celebration window
            setTimeout(() => {
                if (mv.animationName === victoryAnim) {
                    mv.currentTime = 0;
                    mv.play();
                }
            }, 2500);

            // Return to static stance after celebration
            setTimeout(() => {
                mv.pause();
                mv.currentTime = 0;
                mv.animationName = null;
                mv.removeAttribute('animation-name');
            }, 6000);
        }
    }

    // If model already has animations loaded, play immediately
    if (mv.availableAnimations && mv.availableAnimations.length) {
        playVictoryAnim();
    } else {
        // Wait for model to finish loading before playing animation
        mv.addEventListener('load', function onModelLoad() {
            mv.removeEventListener('load', onModelLoad);
            setTimeout(playVictoryAnim, 200);
        });
    }
}

// Show animation unlock notification
function showAnimationUnlockToast(animInfo) {
    const toast = document.createElement('div');
    toast.className = 'animation-unlock-toast';
    toast.innerHTML = `
        <div class="animation-unlock-icon">${animInfo.icon}</div>
        <div class="animation-unlock-title">New Move Unlocked!</div>
        <div class="animation-unlock-name">${animInfo.displayName}</div>
    `;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 10);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Check for newly unlocked animations when leveling up
function checkNewAnimationUnlocks(previousLevel, newLevel) {
    const mv = document.getElementById('tamagotchi-model');
    if (!mv || !mv.availableAnimations) return;

    // Check for milestone unlocks (character skin, battle mode, backgrounds)
    const MILESTONE_UNLOCKS = [
        { level: 5, displayName: 'Newcomer Skin', icon: '🧑', category: 'milestone' },
        { level: 5, displayName: 'Gym Background', icon: '🏋️', category: 'milestone' },
        { level: 10, displayName: 'Battle Mode', icon: '🥊', category: 'milestone' },
        { level: 10, displayName: 'Rising Skin', icon: '💪', category: 'milestone' },
    ];

    const newMilestones = MILESTONE_UNLOCKS.filter(m => previousLevel < m.level && newLevel >= m.level);
    newMilestones.forEach((milestone, index) => {
        setTimeout(() => {
            showAnimationUnlockToast(milestone);
        }, 1500 + (index * 3000));
    });

    // Find animations that were just unlocked
    const newlyUnlocked = ANIMATION_UNLOCKS.filter(unlock => {
        // Was locked before, unlocked now
        const wasLocked = previousLevel < unlock.unlockLevel;
        const isUnlockedNow = newLevel >= unlock.unlockLevel;

        // Check if this animation actually exists in the model
        const existsInModel = mv.availableAnimations.some(a =>
            a.toLowerCase() === unlock.name.toLowerCase()
        );

        return wasLocked && isUnlockedNow && existsInModel;
    });

    // Show unlock toasts with delay between each (after milestones)
    const milestoneDelay = newMilestones.length * 3000 + 1500;
    newlyUnlocked.forEach((unlock, index) => {
        setTimeout(() => {
            showAnimationUnlockToast(unlock);
        }, milestoneDelay + (index * 3500));
    });
}

// Trigger XP bar rainbow flash
function triggerXPBarRainbow() {
    const xpBar = document.getElementById('tamagotchi-xp-bar');
    if (xpBar) {
        xpBar.classList.add('xp-bar-rainbow');
        setTimeout(() => xpBar.classList.remove('xp-bar-rainbow'), 1500);
    }
}

/**
 * NEW LEVEL UP CELEBRATION SYSTEM
 * Shows celebration directly in the Tamagotchi widget instead of as a popup toast.
 * Auto-navigates to dashboard, plays dance animation, and animates the XP bar.
 * Persists pending celebration to localStorage so it survives page reloads.
 */
function triggerLevelUpCelebration(newLevel, title, previousLevel = null, lifetimePoints = 0, currentStreak = 0, previousProgress = 0) {
    console.log('🎉 Level Up Celebration triggered!', { newLevel, title, previousLevel });

    // Persist celebration data so it can be recovered if page reloads mid-flow
    try {
        localStorage.setItem('pendingLevelUpCelebration', JSON.stringify({
            newLevel, title, previousLevel, lifetimePoints, currentStreak, previousProgress,
            timestamp: Date.now()
        }));
    } catch (e) { /* ignore storage errors */ }

    // Get the previous title for rank transition display
    const previousTitle = previousLevel ? getLevelTitle(previousLevel) : null;
    const showRankTransition = previousTitle && previousTitle !== title;

    // Calculate new progress percentage for the new level
    const newLevelData = calculateLevel(lifetimePoints);
    const newProgress = newLevelData.progress || 0;

    // Step 1: Navigate to dashboard if not already there
    if (currentActiveTab !== 'dashboard') {
        // Find the dashboard nav button
        const dashboardBtn = document.querySelector('.bottom-nav .nav-item');
        switchAppTab('dashboard', dashboardBtn);
        // Wait for navigation transition then scroll to top so character is visible
        setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            startCelebrationSequence();
        }, 500);
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        startCelebrationSequence();
    }

    function startCelebrationSequence() {
        const overlay = document.getElementById('tamagotchi-levelup-overlay');
        const banner = document.getElementById('levelup-banner');
        const statsBar = document.getElementById('tamagotchi-stats-bar');
        const xpBar = document.getElementById('tamagotchi-xp-bar');
        const levelDisplay = document.getElementById('tamagotchi-level');
        const rankDisplay = document.getElementById('tamagotchi-rank');
        const xpText = document.getElementById('tamagotchi-xp-text');

        if (!overlay || !banner) {
            console.log('Level up overlay elements not found, falling back to toast');
            showLevelUpToast(newLevel, title, previousLevel, lifetimePoints, currentStreak);
            clearPendingCelebration();
            return;
        }

        // Clear any existing celebration elements
        overlay.innerHTML = '';

        // Step 2: Play sound
        playLevelUpSound();

        // Step 3: Full-screen flash effect for impact
        const flash = document.createElement('div');
        flash.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,215,0,0.4);z-index:9998;pointer-events:none;animation:celebrationFlash 0.6s ease-out forwards;';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 700);

        // Step 4: Activate overlay and add effects
        overlay.classList.add('active');

        // Add burst effect
        const burst = document.createElement('div');
        burst.className = 'levelup-burst';
        overlay.appendChild(burst);

        // Add sparkle particles (more particles for bigger celebration)
        for (let i = 0; i < 30; i++) {
            setTimeout(() => {
                const sparkle = document.createElement('div');
                sparkle.className = 'levelup-sparkle';
                sparkle.style.left = `${10 + Math.random() * 80}%`;
                sparkle.style.bottom = `${10 + Math.random() * 40}%`;
                sparkle.style.animationDelay = `${Math.random() * 0.5}s`;
                sparkle.style.animationDuration = `${1.5 + Math.random()}s`;
                overlay.appendChild(sparkle);
            }, i * 40);
        }

        // Add rising stars
        const starPositions = [15, 30, 42, 58, 70, 85];
        starPositions.forEach((pos, i) => {
            setTimeout(() => {
                const star = document.createElement('div');
                star.className = 'levelup-star';
                star.textContent = '⭐';
                star.style.left = `${pos}%`;
                star.style.bottom = '30%';
                star.style.animationDelay = `${i * 0.12}s`;
                overlay.appendChild(star);
            }, 200 + i * 80);
        });

        // Add confetti - first wave
        const confettiColors = ['#FFD700', '#FFA500', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96E6A1', '#FF69B4', '#9B59B6'];
        for (let i = 0; i < 40; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'levelup-confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = '-20px';
                confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.animationDuration = `${2 + Math.random() * 1.5}s`;
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                confetti.style.width = `${6 + Math.random() * 8}px`;
                confetti.style.height = `${6 + Math.random() * 8}px`;
                overlay.appendChild(confetti);
            }, i * 25);
        }

        // Second wave of confetti for sustained celebration
        setTimeout(() => {
            for (let i = 0; i < 25; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'levelup-confetti';
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.top = '-20px';
                    confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                    confetti.style.animationDelay = `${Math.random() * 0.3}s`;
                    confetti.style.animationDuration = `${2 + Math.random() * 1.5}s`;
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                    confetti.style.width = `${6 + Math.random() * 8}px`;
                    confetti.style.height = `${6 + Math.random() * 8}px`;
                    overlay.appendChild(confetti);
                }, i * 30);
            }
        }, 2000);

        // Step 5: Show level-up banner
        setTimeout(() => {
            banner.style.display = 'block';
            // Reset animation by removing and re-adding class
            banner.style.animation = 'none';
            banner.offsetHeight; // Trigger reflow
            banner.style.animation = 'bannerPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';

            // Update banner content
            document.getElementById('levelup-banner-number').textContent = newLevel;

            const rankContainer = document.getElementById('levelup-banner-rank');
            if (showRankTransition) {
                rankContainer.innerHTML = `
                    <div class="levelup-rank-transition">
                        <span class="levelup-rank-old">${previousTitle}</span>
                        <span class="levelup-rank-arrow">→</span>
                        <span class="levelup-rank-new">${title}</span>
                    </div>
                `;
            } else {
                rankContainer.textContent = title;
            }

            // Check for unlocked moves and display in banner
            const unlockedContainer = document.getElementById('levelup-unlocked-container');
            const unlockedIcon = document.getElementById('levelup-unlocked-icon');
            const unlockedText = document.getElementById('levelup-unlocked-text');

            if (unlockedContainer && previousLevel) {
                // Get newly unlocked animations for this level
                const mv = document.getElementById('tamagotchi-model');
                const availableAnims = mv?.availableAnimations || [];

                // Find animations unlocked at exactly this new level
                const newlyUnlocked = (typeof ANIMATION_UNLOCKS !== 'undefined' ? ANIMATION_UNLOCKS : []).filter(unlock => {
                    const wasLocked = previousLevel < unlock.unlockLevel;
                    const isUnlockedNow = newLevel >= unlock.unlockLevel;
                    const existsInModel = availableAnims.some(a =>
                        a.toLowerCase() === unlock.name.toLowerCase()
                    );
                    return wasLocked && isUnlockedNow && existsInModel;
                });

                if (newlyUnlocked.length > 0) {
                    // Show the first unlocked move (or combine if multiple)
                    const firstUnlock = newlyUnlocked[0];
                    unlockedIcon.textContent = firstUnlock.icon || '🎬';

                    if (newlyUnlocked.length === 1) {
                        unlockedText.textContent = firstUnlock.displayName;
                    } else {
                        // Multiple unlocks - show count
                        unlockedText.textContent = `${firstUnlock.displayName} +${newlyUnlocked.length - 1} more`;
                    }

                    unlockedContainer.style.display = 'block';
                    // Reset animation
                    unlockedContainer.style.animation = 'none';
                    unlockedContainer.offsetHeight;
                    unlockedContainer.style.animation = 'unlockSlideIn 0.5s ease-out 0.8s both';
                } else {
                    unlockedContainer.style.display = 'none';
                }
            } else if (unlockedContainer) {
                unlockedContainer.style.display = 'none';
            }
        }, 300);

        // Step 6: Trigger Shazie's celebration dance
        triggerVictoryAnimation();

        // Step 7: Animate XP bar (fill to 100%, then reset to new progress)
        if (xpBar) {
            // Set CSS variables for the animation
            xpBar.style.setProperty('--start-width', `${previousProgress}%`);
            xpBar.style.setProperty('--end-width', `${newProgress}%`);
            xpBar.classList.add('xp-bar-levelup-fill');

            setTimeout(() => {
                xpBar.classList.remove('xp-bar-levelup-fill');
                xpBar.style.width = `${newProgress}%`;
            }, 1600);
        }

        // Step 8: Update level number with animation
        if (levelDisplay) {
            setTimeout(() => {
                levelDisplay.textContent = newLevel;
                levelDisplay.classList.add('level-number-update');
                setTimeout(() => levelDisplay.classList.remove('level-number-update'), 600);
            }, 800);
        }

        // Step 9: Update rank display
        if (rankDisplay) {
            setTimeout(() => {
                rankDisplay.textContent = title.toUpperCase();
            }, 900);
        }

        // Step 10: Update XP text
        if (xpText && newLevelData) {
            setTimeout(() => {
                const pointsIntoLevel = newLevelData.pointsIntoLevel || 0;
                const pointsNeeded = newLevelData.pointsNeededForNext || 1;
                const nextLevel = newLevel + 1;
                xpText.textContent = newLevel >= 99
                    ? 'MAX LEVEL!'
                    : `${pointsIntoLevel} / ${pointsNeeded} XP to Level ${nextLevel}`;
            }, 1000);
        }

        // Step 11: Glow effect on stats bar
        if (statsBar) {
            statsBar.classList.add('stats-bar-celebrating');
            setTimeout(() => statsBar.classList.remove('stats-bar-celebrating'), 3000);
        }

        // Step 12: Check for newly unlocked animations
        if (previousLevel) {
            checkNewAnimationUnlocks(previousLevel, newLevel);
        }

        // Step 13: Auto-share level-up to feed
        shareLevelUpToFeed({
            newLevel: newLevel,
            previousLevel: previousLevel,
            title: title,
            lifetimePoints: lifetimePoints
        });

        // Step 14: Clean up after celebration (6.5 seconds - gives dance time to finish)
        setTimeout(() => {
            overlay.classList.remove('active');
            banner.style.display = 'none';
            banner.style.animation = '';
            overlay.innerHTML = '';
            // Reset unlocked move container
            const unlockedContainer = document.getElementById('levelup-unlocked-container');
            if (unlockedContainer) {
                unlockedContainer.style.display = 'none';
                unlockedContainer.style.animation = '';
            }
            // Clear localStorage flag - celebration completed successfully
            clearPendingCelebration();

            // Step 15: Show stat allocation modal after celebration ends
            // (grantStatPoints is called by the progression system hook, but the
            //  modal display is handled here to ensure correct timing)
            setTimeout(() => {
                if (typeof window.showStatAllocationModal === 'function') {
                    window.showStatAllocationModal();
                }
            }, 800);
        }, 6500);
    }
}

// Clear pending celebration from localStorage
function clearPendingCelebration() {
    try { localStorage.removeItem('pendingLevelUpCelebration'); } catch (e) { /* ignore */ }
}

// Check for and replay any pending celebration that was interrupted (e.g. page reload)
function checkPendingLevelUpCelebration() {
    try {
        const raw = localStorage.getItem('pendingLevelUpCelebration');
        if (!raw) return;
        const data = JSON.parse(raw);
        // Only replay if less than 2 minutes old (prevent stale celebrations)
        if (Date.now() - data.timestamp > 120000) {
            clearPendingCelebration();
            return;
        }
        console.log('🎉 Replaying pending level-up celebration from localStorage');
        clearPendingCelebration(); // Clear first to prevent infinite loop
        triggerLevelUpCelebration(
            data.newLevel,
            data.title,
            data.previousLevel,
            data.lifetimePoints,
            data.currentStreak || 0,
            data.previousProgress || 0
        );
    } catch (e) {
        clearPendingCelebration();
    }
}

// Show level up toast with celebration (legacy - kept as fallback)
function showLevelUpToast(newLevel, title, previousLevel = null, lifetimePoints = 0, currentStreak = 0) {
    // Get the previous title if we have previous level
    const previousTitle = previousLevel ? getLevelTitle(previousLevel) : null;
    const showTitleTransition = previousTitle && previousTitle !== title;

    // Build stats HTML
    const statsHtml = `
        <div class="level-up-stats">
            <div class="level-up-stat">
                <div class="level-up-stat-value">${lifetimePoints}</div>
                <div class="level-up-stat-label">Total XP</div>
            </div>
            <div class="level-up-stat">
                <div class="level-up-stat-value">${newLevel - (previousLevel || newLevel - 1)}</div>
                <div class="level-up-stat-label">Levels Gained</div>
            </div>
            <div class="level-up-stat">
                <div class="level-up-stat-value">${99 - newLevel}</div>
                <div class="level-up-stat-label">To Max</div>
            </div>
        </div>
    `;

    // Build streak bonus HTML if on a streak
    const streakHtml = currentStreak >= 2 ? `
        <div class="level-up-streak-bonus">
            <span>🔥</span> ${currentStreak} Day Streak!
        </div>
    ` : '';

    // Build title transition HTML
    const titleTransitionHtml = showTitleTransition ? `
        <div class="level-up-title-transition">
            <span class="level-up-old-title">${previousTitle}</span>
            <span class="level-up-arrow">→</span>
            <span class="level-up-new-title">${title}</span>
        </div>
    ` : `<div class="level-up-rank">${title}</div>`;

    const toast = document.createElement('div');
    toast.className = 'level-up-toast level-up-toast-enhanced';
    toast.innerHTML = `
        <div class="level-up-glow"></div>
        <div class="level-up-content">
            <div class="level-up-icon">⭐</div>
            <div class="level-up-text">
                <div class="level-up-title">LEVEL UP!</div>
                <div class="level-up-level">Level ${newLevel}</div>
                ${titleTransitionHtml}
                ${streakHtml}
                ${statsHtml}
            </div>
        </div>
    `;

    document.body.appendChild(toast);

    // Trigger all the celebration effects!
    playLevelUpSound();
    createGlowRings();
    triggerVictoryAnimation();
    triggerXPBarRainbow();

    // Auto-share level-up to feed
    shareLevelUpToFeed({
        newLevel: newLevel,
        previousLevel: previousLevel,
        title: title,
        lifetimePoints: lifetimePoints
    });

    // Check for newly unlocked animations
    if (previousLevel) {
        checkNewAnimationUnlocks(previousLevel, newLevel);
    }

    // Add level-up animation to the badge
    const levelBadge = document.getElementById('level-badge');
    if (levelBadge) {
        levelBadge.classList.add('level-up-animation');
        setTimeout(() => levelBadge.classList.remove('level-up-animation'), 600);
    }

    // Animate in
    setTimeout(() => toast.classList.add('show'), 10);

    // Remove after 5 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Track previous lifetime points to detect level-ups
let previousLifetimePoints = 0;

// Track current active tab and pending level-ups (only show level-up on home screen)
let currentActiveTab = 'dashboard';
let pendingLevelUp = null; // { level: number, title: string }

// Award points for a meal (called after successful meal logging)
async function awardPointsForMeal(mealLogId, photoTimestamp, aiConfidence, photoHash) {
    console.log('awardPointsForMeal called with:', { mealLogId, photoTimestamp, aiConfidence, photoHash });
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) {
            console.log('No user session for points');
            return null;
        }

        // Get current points to track level before awarding
        let pointsBefore = null;
        try {
            pointsBefore = await window.db?.points?.getPoints(session.user.id);
        } catch (e) {
            console.log('Could not get previous points');
        }
        const previousLevelData = calculateLevel(pointsBefore?.lifetime_points || 0);
        const previousLevel = previousLevelData.level;
        const previousProgress = previousLevelData.progress || 0;

        console.log('Calling window.db.points.awardPoints...');
        const result = await window.db?.points?.awardPoints(
            session.user.id,
            'meal',
            mealLogId,
            { photoTimestamp, aiConfidence, photoHash }
        );
        console.log('awardPoints result:', result);

        if (result?.success) {
            // Show points earned toast
            showPointsEarnedToast(
                result.pointsAwarded,
                result.bonusPoints,
                result.currentStreak
            );

            // Show milestone toasts
            if (result.milestonesUnlocked?.length > 0) {
                result.milestonesUnlocked.forEach((milestone, index) => {
                    setTimeout(() => showMilestoneToast(milestone), (index + 1) * 500);
                });
            }

            // Check for level-up
            const newLifetimePoints = result.newLifetimePoints || (pointsBefore?.lifetime_points || 0) + (result.pointsAwarded || 0) + (result.bonusPoints || 0);
            const newLevelData = calculateLevel(newLifetimePoints);
            if (newLevelData.level > previousLevel) {
                // Delay level-up celebration to appear after points toast
                const delayMs = (result.milestonesUnlocked?.length || 0) * 500 + 1000;
                setTimeout(() => {
                    // Use new in-Tamagotchi celebration (auto-navigates to dashboard)
                    triggerLevelUpCelebration(
                        newLevelData.level,
                        getLevelTitle(newLevelData.level),
                        previousLevel,
                        newLifetimePoints,
                        result.currentStreak || 0,
                        previousProgress
                    );
                }, delayMs);
            }

            // Refresh points widget
            await loadPointsWidget();

            // Refresh challenge widgets to show updated points
            if (typeof loadHomeChallenges === 'function') {
                loadHomeChallenges();
            }
        } else if (result?.error) {
            console.log('Points not awarded:', result.reason || result.error);
            // Optionally show a subtle message about why points weren't awarded
        }

        return result;
    } catch (error) {
        console.error('Error awarding points for meal:', error);
        return null;
    }
}

// Claim daily nutrition bonus (2 points for hitting within 20% of cal/macro goals)
async function claimDailyNutritionBonus() {
    // Use popup button if available, fall back to main button
    const btn = document.getElementById('popup-claim-btn') || document.getElementById('daily-log-btn');
    const hint = document.getElementById('popup-claim-hint') || document.getElementById('daily-log-hint');
    if (!btn) return;

    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) {
            if (hint) hint.textContent = 'Please log in to claim your daily bonus.';
            return;
        }

        // Disable button while processing
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.querySelector('span:nth-child(2)').textContent = 'Checking...';

        const today = getLocalDateString();

        // Get current points to track level before awarding
        let pointsBefore = null;
        try {
            pointsBefore = await window.db?.points?.getPoints(session.user.id);
        } catch (e) {
            console.log('Could not get previous points');
        }
        const previousLevelData = calculateLevel(pointsBefore?.lifetime_points || 0);
        const previousLevel = previousLevelData.level;
        const previousProgress = previousLevelData.progress || 0;

        // Call the award-points endpoint with daily_log type
        const response = await fetch('/api/award-points', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: session.user.id,
                type: 'daily_log',
                referenceId: `daily_${today}`,
                nutritionDate: today
            })
        });

        const result = await response.json();

        if (result.success) {
            // Show success state on popup button
            btn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';
            btn.innerHTML = `
                <span style="font-size: 1.3rem;">&#x1F389;</span>
                <span>Daily Bonus Claimed!</span>
                <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 20px; font-size: 0.85rem;">+${result.pointsAwarded} pts</span>
            `;
            btn.style.opacity = '1';
            if (hint) hint.textContent = 'Great job hitting your nutrition goals today!';

            // Also update the main Log button to show claimed state
            setDailyLogButtonClaimed();

            // Show points toast
            showPointsEarnedToast(result.pointsAwarded, result.bonusPoints || 0, result.currentStreak || 0);

            // Check for level-up
            const newLifetimePoints = result.newLifetimePoints || (pointsBefore?.lifetime_points || 0) + (result.pointsAwarded || 0) + (result.bonusPoints || 0);
            const newLevelData = calculateLevel(newLifetimePoints);
            if (newLevelData.level > previousLevel) {
                setTimeout(() => {
                    triggerLevelUpCelebration(
                        newLevelData.level,
                        getLevelTitle(newLevelData.level),
                        previousLevel,
                        newLifetimePoints,
                        result.currentStreak || 0,
                        previousProgress
                    );
                }, 1500);
            }

            // Refresh points widget
            await loadPointsWidget();
            if (typeof loadHomeChallenges === 'function') {
                loadHomeChallenges();
            }
        } else {
            // Handle specific errors
            btn.style.opacity = '1';
            if (result.error === 'Already claimed') {
                setDailyLogButtonClaimed();
            } else if (result.error === 'Goals not met') {
                btn.style.background = 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
                btn.style.boxShadow = '0 4px 12px rgba(108, 117, 125, 0.3)';
                btn.innerHTML = `
                    <span style="font-size: 1.3rem;">&#x274C;</span>
                    <span>Goals Not Met Yet</span>
                `;
                if (hint) hint.textContent = result.reason || 'Get closer to your calorie & macro goals, or finish your day without the bonus.';
                // Show "Finish Day Without Bonus" button in popup
                const finishDayBtn = document.getElementById('popup-finish-day-btn');
                const finishHint = document.getElementById('popup-finish-hint');
                if (finishDayBtn) finishDayBtn.style.display = 'flex';
                if (finishHint) finishHint.style.display = 'block';
                // Re-enable claim button after 3 seconds so they can try again
                setTimeout(() => {
                    resetDailyLogButton();
                }, 3000);
            } else if (result.error === 'No meals logged') {
                btn.style.background = 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
                btn.innerHTML = `
                    <span style="font-size: 1.3rem;">&#x1F37D;</span>
                    <span>Log Meals First</span>
                `;
                if (hint) hint.textContent = result.reason || 'Log at least one meal before claiming your bonus.';
                setTimeout(() => {
                    resetDailyLogButton();
                }, 3000);
            } else {
                btn.innerHTML = `
                    <span style="font-size: 1.3rem;">&#x26A0;</span>
                    <span>Something went wrong</span>
                `;
                if (hint) hint.textContent = result.reason || 'Please try again.';
                setTimeout(() => {
                    resetDailyLogButton();
                }, 3000);
            }
        }
    } catch (error) {
        console.error('Error claiming daily nutrition bonus:', error);
        btn.style.opacity = '1';
        btn.innerHTML = `
            <span style="font-size: 1.3rem;">&#x26A0;</span>
            <span>Error - Try Again</span>
        `;
        setTimeout(() => {
            resetDailyLogButton();
        }, 3000);
    }
}

// Finish day without bonus points (marks all meals as tracked for AI coach)
async function finishDayWithoutBonus() {
    const btn = document.getElementById('popup-finish-day-btn');
    const claimBtn = document.getElementById('popup-claim-btn') || document.getElementById('daily-log-btn');
    const hint = document.getElementById('popup-claim-hint') || document.getElementById('daily-log-hint');
    if (!btn) return;

    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.querySelector('span').textContent = 'Finishing...';

        const today = getLocalDateString();

        const response = await fetch('/api/award-points', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: session.user.id,
                type: 'daily_log',
                referenceId: `daily_${today}`,
                nutritionDate: today,
                finishDay: true
            })
        });

        const result = await response.json();

        if (result.success || result.dayCompleted) {
            // Mark both buttons as day completed (no bonus)
            setDailyLogButtonDayCompleted();
            // Hide the finish day button
            btn.style.display = 'none';
            const finishHint = document.getElementById('popup-finish-hint');
            if (finishHint) finishHint.style.display = 'none';
        } else if (result.error === 'Already claimed') {
            setDailyLogButtonClaimed();
            btn.style.display = 'none';
        } else {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.querySelector('span').textContent = 'Finish Day Without Bonus';
            if (hint) hint.textContent = result.reason || 'Something went wrong. Please try again.';
        }
    } catch (error) {
        console.error('Error finishing day:', error);
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.querySelector('span').textContent = 'Finish Day Without Bonus';
    }
}

// Set buttons to "Day Completed" state (no bonus earned)
function setDailyLogButtonDayCompleted() {
    const btn = document.getElementById('daily-log-btn');
    const hint = document.getElementById('daily-log-hint');
    if (btn) {
        btn.disabled = true;
        btn.style.background = 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
        btn.style.opacity = '0.7';
        btn.style.boxShadow = 'none';
        btn.style.cursor = 'default';
        btn.innerHTML = `
            <span style="font-size: 1.3rem;">&#x2705;</span>
            <span>Day Completed</span>
        `;
    }
    if (hint) hint.textContent = 'Your meals are tracked for today. Try to hit your macros tomorrow for bonus points!';

    const popupBtn = document.getElementById('popup-claim-btn');
    const popupHint = document.getElementById('popup-claim-hint');
    if (popupBtn) {
        popupBtn.disabled = true;
        popupBtn.style.background = 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
        popupBtn.style.opacity = '0.7';
        popupBtn.style.cursor = 'default';
        popupBtn.innerHTML = `
            <span style="font-size: 1.3rem;">&#x2705;</span>
            <span>Day Completed</span>
        `;
    }
    if (popupHint) popupHint.textContent = 'Your meals are tracked for today. Try to hit your macros tomorrow for bonus points!';

    // Hide finish day button
    const finishDayBtn = document.getElementById('popup-finish-day-btn');
    const finishHint = document.getElementById('popup-finish-hint');
    if (finishDayBtn) finishDayBtn.style.display = 'none';
    if (finishHint) finishHint.style.display = 'none';
}

function setDailyLogButtonClaimed() {
    const btn = document.getElementById('daily-log-btn');
    const hint = document.getElementById('daily-log-hint');
    if (btn) {
        btn.disabled = true;
        btn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';
        btn.style.opacity = '0.7';
        btn.style.boxShadow = 'none';
        btn.style.cursor = 'default';
        btn.innerHTML = `
            <span style="font-size: 1.3rem;">&#x2705;</span>
            <span>Daily Bonus Claimed</span>
        `;
    }
    if (hint) hint.textContent = 'Come back tomorrow for another chance!';

    // Also update popup claim button
    const popupBtn = document.getElementById('popup-claim-btn');
    const popupHint = document.getElementById('popup-claim-hint');
    if (popupBtn) {
        popupBtn.disabled = true;
        popupBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';
        popupBtn.style.opacity = '0.7';
        popupBtn.style.cursor = 'default';
        popupBtn.innerHTML = `
            <span style="font-size: 1.3rem;">&#x2705;</span>
            <span>Daily Bonus Claimed</span>
        `;
    }
    if (popupHint) popupHint.textContent = 'Come back tomorrow for another chance!';
}

function resetDailyLogButton() {
    const btn = document.getElementById('daily-log-btn');
    const hint = document.getElementById('daily-log-hint');
    if (btn) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.background = 'linear-gradient(135deg, var(--primary) 0%, #065f3a 100%)';
        btn.style.boxShadow = '0 4px 12px rgba(4, 106, 56, 0.3)';
        btn.style.cursor = 'pointer';
        btn.innerHTML = `
            <span style="font-size: 1.3rem;">&#x2705;</span>
            <span>Log Your Meals for the Day</span>
            <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 20px; font-size: 0.85rem;">+2 pts</span>
        `;
    }
    if (hint) hint.textContent = 'Hit within 20% of your calorie & macro goals to earn 2 bonus points';

    // Also reset popup claim button
    const popupBtn = document.getElementById('popup-claim-btn');
    const popupHint = document.getElementById('popup-claim-hint');
    if (popupBtn) {
        popupBtn.disabled = false;
        popupBtn.style.opacity = '1';
        popupBtn.style.background = 'linear-gradient(135deg, var(--primary) 0%, #065f3a 100%)';
        popupBtn.style.cursor = 'pointer';
        popupBtn.innerHTML = `
            <span style="font-size: 1.3rem;">&#x2705;</span>
            <span>Claim Daily Bonus</span>
            <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 20px; font-size: 0.85rem;">+2 pts</span>
        `;
    }
    if (popupHint) popupHint.textContent = 'Hit within 20% of your calorie & macro goals to earn 2 bonus points';
}

// Check if daily log bonus has already been claimed today (called from loadTodayNutrition)
async function checkDailyLogBonusStatus() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        const today = getLocalDateString();

        // Check for points bonus claim
        const { data: existingClaim } = await window.supabaseClient
            .from('point_transactions')
            .select('id')
            .eq('user_id', session.user.id)
            .eq('transaction_type', 'earn_daily_log')
            .gte('created_at', today + 'T00:00:00')
            .lte('created_at', today + 'T23:59:59')
            .limit(1)
            .maybeSingle();

        if (existingClaim) {
            setDailyLogButtonClaimed();
            return;
        }

        // Check if day was completed without bonus (finish day flow)
        const { data: dailyNutrition } = await window.supabaseClient
            .from('daily_nutrition')
            .select('day_completed')
            .eq('user_id', session.user.id)
            .eq('nutrition_date', today)
            .single();

        if (dailyNutrition?.day_completed) {
            setDailyLogButtonDayCompleted();
        }
    } catch (error) {
        console.error('Error checking daily log bonus status:', error);
    }
}

// Award points for a workout (called after successful workout logging)
async function awardPointsForWorkout(workoutId, photoTimestamp = null, aiConfidence = null, photoHash = null) {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return null;

        // Get current points to track level before awarding
        let pointsBefore = null;
        try {
            pointsBefore = await window.db?.points?.getPoints(session.user.id);
        } catch (e) {
            console.log('Could not get previous points');
        }
        const previousLevelData = calculateLevel(pointsBefore?.lifetime_points || 0);
        const previousLevel = previousLevelData.level;
        const previousProgress = previousLevelData.progress || 0;

        const result = await window.db?.points?.awardPoints(
            session.user.id,
            'workout',
            workoutId,
            { photoTimestamp, aiConfidence, photoHash }
        );

        if (result?.success) {
            // Show points earned toast
            showPointsEarnedToast(
                result.pointsAwarded,
                result.bonusPoints,
                result.currentStreak
            );

            // Show milestone toasts
            if (result.milestonesUnlocked?.length > 0) {
                result.milestonesUnlocked.forEach((milestone, index) => {
                    setTimeout(() => showMilestoneToast(milestone), (index + 1) * 500);
                });
            }

            // Check for level-up
            const newLifetimePoints = result.newLifetimePoints || (pointsBefore?.lifetime_points || 0) + (result.pointsAwarded || 0) + (result.bonusPoints || 0);
            const newLevelData = calculateLevel(newLifetimePoints);
            if (newLevelData.level > previousLevel) {
                // Delay level-up celebration to appear after points toast
                const delayMs = (result.milestonesUnlocked?.length || 0) * 500 + 1000;
                setTimeout(() => {
                    // Use new in-Tamagotchi celebration (auto-navigates to dashboard)
                    triggerLevelUpCelebration(
                        newLevelData.level,
                        getLevelTitle(newLevelData.level),
                        previousLevel,
                        newLifetimePoints,
                        result.currentStreak || 0,
                        previousProgress
                    );
                }, delayMs);
            }

            // Refresh points widget
            await loadPointsWidget();

            // Refresh challenge widgets to show updated points
            if (typeof loadHomeChallenges === 'function') {
                loadHomeChallenges();
            }
        }

        return result;
    } catch (error) {
        console.error('Error awarding points for workout:', error);
        return null;
    }
}

// Award points for achieving a personal best (1 point per PB)
async function awardPointsForPersonalBest(pbRefId, pbData) {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return null;

        // Get current points to track level before awarding
        let pointsBefore = null;
        try {
            pointsBefore = await window.db?.points?.getPoints(session.user.id);
        } catch (e) {
            console.log('Could not get previous points');
        }
        const previousLevelData = calculateLevel(pointsBefore?.lifetime_points || 0);
        const previousLevel = previousLevelData.level;
        const previousProgress = previousLevelData.progress || 0;

        // Award point for personal best (type: 'personal_best')
        const result = await window.db?.points?.awardPoints(
            session.user.id,
            'personal_best',
            pbRefId,
            {
                exercise: pbData.exercise,
                pbType: pbData.type, // 'weight' or 'reps'
                value: pbData.value,
                improvement: pbData.improvement
            }
        );

        if (result?.success) {
            // Show PB points toast
            const pbTypeText = pbData.type === 'weight' ? 'weight' : pbData.type === 'volume' ? 'volume' : 'reps';
            const toastMsg = pbData.type === 'volume'
                ? `+1 XP — Volume PR! ${pbData.value.toLocaleString()} kg total (+${pbData.improvement.toLocaleString()} kg)`
                : `+1 point for ${pbData.exercise} PB! (${pbTypeText})`;
            showToast(toastMsg, 'success');

            // Check for level-up
            const newLifetimePoints = result.newLifetimePoints || (pointsBefore?.lifetime_points || 0) + 1;
            const newLevelData = calculateLevel(newLifetimePoints);
            if (newLevelData.level > previousLevel) {
                setTimeout(() => {
                    // Use new in-Tamagotchi celebration (auto-navigates to dashboard)
                    triggerLevelUpCelebration(
                        newLevelData.level,
                        getLevelTitle(newLevelData.level),
                        previousLevel,
                        newLifetimePoints,
                        result.currentStreak || 0,
                        previousProgress
                    );
                }, 1500);
            }
        }

        return result;
    } catch (error) {
        console.error('Error awarding points for personal best:', error);
        return null;
    }
}

// ==========================================
// WORKOUT PHOTO VERIFICATION FUNCTIONS
// ==========================================

let capturedWorkoutFile = null;
let workoutPhotoBase64 = null;

// Capture workout completion screen and share to story
// Track which share type we're doing (story or groupchat)
let pendingWorkoutShareType = null;
let workoutPointsEarnedThisSession = { story: false, groupchat: false };

// Share workout to story - requires camera photo
function shareWorkoutToStory() {
    // Check if already earned story point this session
    if (workoutPointsEarnedThisSession.story) {
        showToast('You already earned the feed post point for this workout!', 'info');
        return;
    }

    // Check workout duration first - must be at least 15 minutes for points
    const successDurationEl = document.getElementById('success-duration');
    const durationText = successDurationEl ? successDurationEl.textContent : '00:00';
    const [mins, secs] = durationText.split(':').map(Number);
    const totalMinutes = mins + (secs / 60);

    if (totalMinutes < 15) {
        showToast(`Workout must be 15+ minutes for points (yours: ${mins}m ${secs}s)`, 'error');
        return;
    }

    pendingWorkoutShareType = 'story';

    // Create/get hidden camera input and trigger it
    let cameraInput = document.getElementById('workout-photo-input');
    if (!cameraInput) {
        cameraInput = document.createElement('input');
        cameraInput.type = 'file';
        cameraInput.id = 'workout-photo-input';
        cameraInput.accept = 'image/*';
        cameraInput.capture = 'environment';
        cameraInput.style.display = 'none';
        cameraInput.onchange = handleWorkoutPhotoCapture;
        document.body.appendChild(cameraInput);
    }
    cameraInput.click();
}

// Share workout to group chat - requires camera photo
function shareWorkoutToGroupChat() {
    // Check if already earned groupchat point this session
    if (workoutPointsEarnedThisSession.groupchat) {
        showToast('You already earned the group chat point for this workout!', 'info');
        return;
    }

    // Check workout duration first - must be at least 15 minutes for points
    const successDurationEl = document.getElementById('success-duration');
    const durationText = successDurationEl ? successDurationEl.textContent : '00:00';
    const [mins, secs] = durationText.split(':').map(Number);
    const totalMinutes = mins + (secs / 60);

    if (totalMinutes < 15) {
        showToast(`Workout must be 15+ minutes for points (yours: ${mins}m ${secs}s)`, 'error');
        return;
    }

    pendingWorkoutShareType = 'groupchat';

    // Create/get hidden camera input and trigger it
    let cameraInput = document.getElementById('workout-photo-input');
    if (!cameraInput) {
        cameraInput = document.createElement('input');
        cameraInput.type = 'file';
        cameraInput.id = 'workout-photo-input';
        cameraInput.accept = 'image/*';
        cameraInput.capture = 'environment';
        cameraInput.style.display = 'none';
        cameraInput.onchange = handleWorkoutPhotoCapture;
        document.body.appendChild(cameraInput);
    }
    cameraInput.click();
}

// Handle the captured workout photo
async function handleWorkoutPhotoCapture(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Reset input for next use
    event.target.value = '';

    // Check photo timestamp (must be recent - within last 5 minutes)
    const photoTimestamp = new Date().toISOString();

    // Convert to base64
    const reader = new FileReader();
    reader.onload = async function(e) {
        const base64Data = e.target.result;
        const base64Only = base64Data.split(',')[1];

        try {
            // Generate photo hash for duplicate detection
            const photoHash = await window.db?.points?.generatePhotoHash(base64Data);

            if (pendingWorkoutShareType === 'story') {
                // Store data and open story upload modal
                window.pendingStoryFile = file;
                window.pendingStoryBase64 = base64Data;
                window.pendingStoryType = 'image';
                window.pendingWorkoutPhotoData = {
                    timestamp: photoTimestamp,
                    hash: photoHash,
                    forPoints: true
                };

                // Open story modal
                const modal = document.getElementById('story-upload-modal');
                if (modal) modal.style.display = 'flex';

                // Set preview
                const previewImage = document.getElementById('story-preview-image');
                const previewVideo = document.getElementById('story-preview-video');
                const placeholder = document.getElementById('story-preview-placeholder');

                if (previewImage) {
                    previewImage.src = base64Data;
                    previewImage.style.display = 'block';
                }
                if (previewVideo) previewVideo.style.display = 'none';
                if (placeholder) placeholder.style.display = 'none';

                // Set caption
                const captionInput = document.getElementById('story-caption-input');
                if (captionInput) captionInput.value = 'Just finished my workout! 💪';

                // Enable upload button
                const uploadBtn = document.getElementById('story-upload-button');
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.style.opacity = '1';
                }
            } else if (pendingWorkoutShareType === 'groupchat') {
                // Award point first, then go to group chat selection
                await awardWorkoutSharePoint('groupchat', photoTimestamp, photoHash);

                // Go to quick share modal for group chat selection
                openQuickShareModal();
            }
        } catch (error) {
            console.error('Error processing workout photo:', error);
            showToast('Failed to process photo. Please try again.', 'error');
        }
    };
    reader.readAsDataURL(file);
}

// Award point for workout share
async function awardWorkoutSharePoint(shareType, photoTimestamp, photoHash) {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return null;

        const workoutRefId = `workout_${shareType}_${Date.now()}`;
        const result = await window.db?.points?.awardPoints(
            session.user.id,
            'workout',
            workoutRefId,
            { photoTimestamp, aiConfidence: 'high', photoHash }
        );

        if (result?.success) {
            // Mark as earned for this session
            if (shareType === 'story') {
                workoutPointsEarnedThisSession.story = true;
            } else {
                workoutPointsEarnedThisSession.groupchat = true;
            }

            // Update UI
            const pointsAwarded = document.getElementById('workout-points-awarded');
            const pointsText = document.getElementById('workout-points-text');
            if (pointsAwarded) {
                pointsAwarded.style.display = 'block';
                if (pointsText) {
                    pointsText.textContent = '+1 XP Earned!';
                }
            }

            showToast('+1 XP for posting your workout photo!', 'success');

            // Refresh tamagotchi display to sync XP with database
            if (typeof window.refreshLevelDisplay === 'function') {
                window.refreshLevelDisplay();
            }

            // Trigger XP bar rainbow animation
            if (typeof window.triggerXPBarRainbow === 'function') {
                window.triggerXPBarRainbow();
            }

            return result;
        }
    } catch (error) {
        console.error('Error awarding workout share point:', error);
    }
    return null;
}

// Legacy function - kept for backward compatibility but now uses new flow
async function captureAndShareWorkout() {
    shareWorkoutToStory();
}

// Share workout as an aesthetic card to feed (with gym photo carousel)
async function shareWorkoutCardToFeed() {
    // Check if already earned story point this session
    if (workoutPointsEarnedThisSession.story) {
        showToast('You already earned the feed post point for this workout!', 'info');
        return;
    }

    // Check workout duration - must be at least 15 minutes for points
    const successDurationEl = document.getElementById('success-duration');
    const durationText = successDurationEl ? successDurationEl.textContent : '00:00';
    const [mins, secs] = durationText.split(':').map(Number);
    const totalMinutes = mins + (secs / 60);

    if (totalMinutes < 15) {
        showToast(`Workout must be 15+ minutes for points (yours: ${mins}m ${secs}s)`, 'error');
        return;
    }

    if (!completedWorkoutDataForShare) {
        showToast('No workout data to share', 'error');
        return;
    }

    // Store context so we know this is a card share
    window._pendingCardShare = true;

    // Trigger camera to capture gym photo first
    let cameraInput = document.getElementById('workout-card-photo-input');
    if (!cameraInput) {
        cameraInput = document.createElement('input');
        cameraInput.type = 'file';
        cameraInput.id = 'workout-card-photo-input';
        cameraInput.accept = 'image/*';
        cameraInput.capture = 'environment';
        cameraInput.style.display = 'none';
        cameraInput.onchange = handleWorkoutCardPhotoCapture;
        document.body.appendChild(cameraInput);
    }
    cameraInput.click();
}

// Handle the gym photo captured for workout card share
async function handleWorkoutCardPhotoCapture(event) {
    const file = event.target.files[0];
    if (!file) {
        window._pendingCardShare = false;
        return;
    }

    // Reset input for next use
    event.target.value = '';

    const btn = document.getElementById('share-workout-card-btn');
    if (btn) {
        btn.disabled = true;
        btn.querySelector('span:last-child').textContent = 'Posting...';
    }

    try {
        // Compress photo first to avoid payload size issues
        const compressedFile = await compressMealImage(file);

        // Convert compressed photo to base64
        const base64Data = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(compressedFile);
        });

        // Build workout card data from completedWorkoutDataForShare
        const data = completedWorkoutDataForShare;
        const exerciseMap = {};
        (data.sets || []).forEach(set => {
            const name = set.exercise || set.exercise_name || 'Exercise';
            if (!exerciseMap[name]) {
                exerciseMap[name] = { name, sets: 0, bestKg: 0, bestReps: 0 };
            }
            exerciseMap[name].sets++;
            const kg = parseFloat(set.kg) || 0;
            const reps = parseInt(set.reps) || 0;
            if (kg > exerciseMap[name].bestKg) {
                exerciseMap[name].bestKg = kg;
                exerciseMap[name].bestReps = reps;
            } else if (kg === exerciseMap[name].bestKg && reps > exerciseMap[name].bestReps) {
                exerciseMap[name].bestReps = reps;
            }
        });

        const exercises = Object.values(exerciseMap).map(ex => ({
            name: ex.name,
            sets: ex.sets,
            best: ex.bestKg > 0 ? `${ex.sets}×${ex.bestReps} ${ex.bestKg}kg` : (ex.bestReps > 0 ? `${ex.sets}×${ex.bestReps}` : `${ex.sets} sets`)
        }));

        // Calculate total volume
        let totalVolume = 0;
        (data.sets || []).forEach(set => {
            const kg = parseFloat(set.kg) || 0;
            const reps = parseInt(set.reps) || 0;
            totalVolume += kg * reps;
        });

        // Build PBs data
        const pbs = (data.newPBs || []).map(pb => ({
            exercise: pb.exercise,
            type: pb.type,
            value: pb.value,
            reps: pb.reps,
            weight: pb.weight,
            improvement: pb.improvement
        }));

        const cardPayload = {
            card_type: 'workout',
            workout_name: data.workoutName || 'Workout',
            duration: data.duration || durationText,
            exercises: exercises,
            total_sets: data.sets ? data.sets.length : 0,
            total_volume: totalVolume > 0 ? totalVolume.toLocaleString() + ' kg' : null,
            pbs: pbs.length > 0 ? pbs : null
        };

        // Create story with photo + workout card data
        const story = await dbHelpers.stories.create(window.currentUser.id, {
            media_type: 'workout_card',
            media_url: base64Data,
            thumbnail_url: null,
            caption: JSON.stringify(cardPayload),
            duration: 5
        });

        console.log('Workout card story created:', story);

        // Award XP
        const photoTimestamp = new Date().toISOString();
        await awardWorkoutSharePoint('story', photoTimestamp, null);

        // Update button to show success
        if (btn) {
            btn.style.background = 'rgba(68, 255, 68, 0.3)';
            btn.style.border = '1px solid rgba(68, 255, 68, 0.5)';
            btn.innerHTML = '<span style="font-size:1.3rem;">✅</span><span style="font-size:0.95rem;">Shared! +1 XP</span>';
        }

        // Refresh feed if visible
        if (typeof loadPhotoFeed === 'function') {
            loadPhotoFeed('friends-photo-feed', 'friends-feed-empty');
        }

        showToast('Workout card shared to feed! +1 XP', 'success');

    } catch (error) {
        console.error('Error sharing workout card:', error);
        showToast('Failed to share workout card. Please try again.', 'error');

        if (btn) {
            btn.disabled = false;
            btn.querySelector('span:last-child').textContent = 'Share Workout Card (+1 XP)';
        }
    }

    window._pendingCardShare = false;
}

// Share a PB achievement card to feed
async function sharePBCardToFeed(pbData) {
    if (!pbData) return;

    try {
        const cardPayload = {
            card_type: 'pb',
            exercise: pbData.exercise,
            pb_type: pbData.type,
            value: pbData.value,
            reps: pbData.reps,
            weight: pbData.weight,
            improvement: pbData.improvement,
            previous: pbData.previous != null ? pbData.previous : (pbData.improvement ? pbData.value - pbData.improvement : null)
        };

        const story = await dbHelpers.stories.create(window.currentUser.id, {
            media_type: 'workout_card',
            media_url: '',
            thumbnail_url: null,
            caption: JSON.stringify(cardPayload),
            duration: 5
        });

        console.log('PB card story created:', story);

        // Refresh feed if visible
        if (typeof loadPhotoFeed === 'function') {
            loadPhotoFeed('friends-photo-feed', 'friends-feed-empty');
        }

        showToast('PB shared to feed!', 'success');

    } catch (error) {
        console.error('Error sharing PB card:', error);
        showToast('Failed to share PB. Please try again.', 'error');
    }
}

// Share daily nutrition summary card to feed
async function shareNutritionToFeed() {
    if (!window.currentUser) {
        showToast('You must be logged in to share', 'error');
        return;
    }

    const btn = document.getElementById('share-nutrition-btn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span style="font-size:1rem;">🥗</span><span style="font-size:0.85rem;">Sharing...</span>';
    }

    try {
        const userId = window.currentUser.id;
        const today = getLocalDateString();

        // Load today's nutrition data
        const { data: dailyData, error: dailyError } = await window.supabaseClient
            .from('daily_nutrition')
            .select('*')
            .eq('user_id', userId)
            .eq('nutrition_date', today)
            .single();

        if (dailyError || !dailyData || !dailyData.total_calories) {
            showToast('Log some meals first before sharing!', 'info');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size:1rem;">🥗</span><span style="font-size:0.85rem;">Share Nutrition</span>';
            }
            return;
        }

        // Calculate score
        const scoreData = calculateNutritionScore(dailyData);
        const score = scoreData ? scoreData.total : 0;

        // Get meal count for today
        const { data: mealsData } = await window.supabaseClient
            .from('meal_logs')
            .select('id')
            .eq('user_id', userId)
            .eq('meal_date', today);

        const mealCount = mealsData ? mealsData.length : 0;

        // Get streak
        let streak = 0;
        try {
            const pointsData = await window.db?.points?.getPoints(userId);
            streak = pointsData?.current_streak || 0;
        } catch (e) {
            console.log('Could not get streak for nutrition card');
        }

        const cardPayload = {
            card_type: 'nutrition',
            score: score,
            calories: dailyData.total_calories || 0,
            calorie_goal: dailyData.calorie_goal || 2000,
            protein: dailyData.total_protein_g || 0,
            protein_goal: dailyData.protein_goal_g || 50,
            carbs: dailyData.total_carbs_g || 0,
            carbs_goal: dailyData.carbs_goal_g || 250,
            fat: dailyData.total_fat_g || 0,
            fat_goal: dailyData.fat_goal_g || 70,
            meal_count: mealCount,
            streak: streak
        };

        const story = await dbHelpers.stories.create(window.currentUser.id, {
            media_type: 'nutrition_card',
            media_url: '',
            thumbnail_url: null,
            caption: JSON.stringify(cardPayload),
            duration: 5
        });

        console.log('Nutrition card story created:', story);

        // Update button to show success
        if (btn) {
            btn.style.background = 'rgba(99, 102, 241, 0.2)';
            btn.style.border = '1px solid rgba(99, 102, 241, 0.4)';
            btn.innerHTML = '<span style="font-size:1rem;">✅</span><span style="font-size:0.85rem;">Shared!</span>';
        }

        // Refresh feed if visible
        if (typeof loadPhotoFeed === 'function') {
            loadPhotoFeed('friends-photo-feed', 'friends-feed-empty');
        }

        showToast('Nutrition card shared to feed!', 'success');

    } catch (error) {
        console.error('Error sharing nutrition card:', error);
        showToast('Failed to share. Please try again.', 'error');

        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<span style="font-size:1rem;">🥗</span><span style="font-size:0.85rem;">Share Nutrition</span>';
        }
    }
}

// Share level-up achievement card to feed
async function shareLevelUpToFeed(levelData) {
    if (!window.currentUser || !levelData) return;

    try {
        // Get streak
        let streak = 0;
        try {
            const session = await window.authHelpers?.getSession();
            if (session?.user) {
                const pointsData = await window.db?.points?.getPoints(session.user.id);
                streak = pointsData?.current_streak || 0;
            }
        } catch (e) {
            console.log('Could not get streak for level-up card');
        }

        const cardPayload = {
            card_type: 'level_up',
            level: levelData.newLevel || levelData.level,
            title: levelData.title || getLevelTitle(levelData.newLevel || levelData.level),
            previous_level: levelData.previousLevel || null,
            previous_title: levelData.previousLevel ? getLevelTitle(levelData.previousLevel) : null,
            lifetime_xp: levelData.lifetimePoints || 0,
            streak: streak
        };

        const story = await dbHelpers.stories.create(window.currentUser.id, {
            media_type: 'level_up_card',
            media_url: '',
            thumbnail_url: null,
            caption: JSON.stringify(cardPayload),
            duration: 5
        });

        console.log('Level-up card story created:', story);

        // Refresh feed if visible
        if (typeof loadPhotoFeed === 'function') {
            loadPhotoFeed('friends-photo-feed', 'friends-feed-empty');
        }

        showToast('Level up shared to feed!', 'success');

    } catch (error) {
        console.error('Error sharing level-up card:', error);
        showToast('Failed to share level up. Please try again.', 'error');
    }
}

// ============================================
// ACTIVITY LOGGING SYSTEM
// Supports fitness classes, boxing, tennis, swimming, running, cycling, walking, yoga, dance, etc.
// ============================================

const ACTIVITY_TYPES = [
    { key: 'fitness_class', label: 'Fitness Class', emoji: '🏋️', color: '#dc2626' },
    { key: 'boxing',        label: 'Boxing',        emoji: '🥊', color: '#b91c1c' },
    { key: 'tennis',        label: 'Tennis',        emoji: '🎾', color: '#65a30d' },
    { key: 'swimming',      label: 'Swimming',      emoji: '🏊', color: '#0284c7' },
    { key: 'running',       label: 'Running',       emoji: '🏃', color: '#ea580c' },
    { key: 'cycling',       label: 'Cycling',       emoji: '🚴', color: '#7c3aed' },
    { key: 'walking',       label: 'Walking',       emoji: '🚶', color: '#059669' },
    { key: 'yoga',          label: 'Yoga',          emoji: '🧘', color: '#c026d3' },
    { key: 'dance',         label: 'Dance',         emoji: '💃', color: '#e11d48' },
    { key: 'hiking',        label: 'Hiking',        emoji: '🥾', color: '#854d0e' },
    { key: 'pilates',       label: 'Pilates',       emoji: '🤸', color: '#0d9488' },
    { key: 'martial_arts',  label: 'Martial Arts',  emoji: '🥋', color: '#1e293b' },
    { key: 'other',         label: 'Other',         emoji: '⚡', color: '#64748b' }
];

// MET values for calorie estimation (Metabolic Equivalent of Task)
// Source: Compendium of Physical Activities
const ACTIVITY_MET_VALUES = {
    walking:        { light: 2.5, moderate: 3.5, vigorous: 5.0 },
    running:        { light: 6.0, moderate: 8.0, vigorous: 11.0 },
    cycling:        { light: 4.0, moderate: 6.8, vigorous: 10.0 },
    swimming:       { light: 4.5, moderate: 6.0, vigorous: 9.8 },
    boxing:         { light: 5.5, moderate: 7.8, vigorous: 12.0 },
    tennis:         { light: 5.0, moderate: 7.3, vigorous: 10.0 },
    yoga:           { light: 2.5, moderate: 3.0, vigorous: 4.0 },
    dance:          { light: 3.5, moderate: 5.5, vigorous: 7.8 },
    pilates:        { light: 3.0, moderate: 4.0, vigorous: 5.0 },
    fitness_class:  { light: 4.5, moderate: 6.5, vigorous: 9.0 },
    hiking:         { light: 4.5, moderate: 6.0, vigorous: 8.0 },
    martial_arts:   { light: 5.0, moderate: 7.0, vigorous: 10.3 },
    other:          { light: 3.5, moderate: 5.0, vigorous: 7.0 }
};

function estimateCaloriesBurned(activityType, intensityLevel, durationMinutes, userWeightKg) {
    const mets = ACTIVITY_MET_VALUES[activityType] || ACTIVITY_MET_VALUES.other;
    const met = mets[intensityLevel] || mets.moderate;
    const hours = durationMinutes / 60;
    return Math.round(met * userWeightKg * hours);
}

// XP eligibility check for activities
function isActivityXPEligible(activityType, hasPhoto, venueVerifiable) {
    if (!hasPhoto) return false;
    // Walks/runs/hikes only get XP with a verifiable venue (treadmill, track, etc.)
    const outdoorOnlyTypes = ['walking', 'running', 'hiking'];
    if (outdoorOnlyTypes.includes(activityType)) {
        return venueVerifiable === true;
    }
    // All other activities with a verifiable venue photo get XP
    return venueVerifiable === true;
}

// Activity form state
let activityFormState = {
    selectedType: null,
    duration: 30,
    intensity: 'moderate',
    photoBase64: null,
    photoMimeType: null,
    userWeightKg: 70 // default, will be loaded from quiz_results
};

// Saved activity data for sharing after save
let savedActivityData = null;

function openLogActivityForm() {
    hideAllAppViews();
    document.getElementById('view-log-activity').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-log-activity', () => closeLogActivity());

    // Reset form state
    activityFormState = {
        selectedType: null,
        duration: 30,
        intensity: 'moderate',
        photoBase64: null,
        photoMimeType: null,
        userWeightKg: 70
    };
    savedActivityData = null;

    // Reset form UI
    document.getElementById('activity-label-input').value = '';
    document.getElementById('activity-notes-input').value = '';
    document.getElementById('activity-duration-display').textContent = '30';
    document.getElementById('activity-photo-preview').style.display = 'none';
    document.getElementById('activity-photo-btn').style.display = 'flex';
    document.getElementById('activity-calories-display').textContent = '0';
    document.getElementById('activity-save-btn').disabled = false;
    document.getElementById('activity-save-btn').textContent = 'Log Activity';

    // Reset intensity to moderate
    selectActivityIntensity('moderate');

    // Build activity type grid
    const grid = document.getElementById('activity-type-grid');
    grid.innerHTML = ACTIVITY_TYPES.map(t => `
        <button onclick="selectActivityType('${t.key}')" id="activity-type-btn-${t.key}" style="padding: 14px 8px; border-radius: 14px; border: 2px solid var(--border); background: var(--card-bg); cursor: pointer; text-align: center; transition: all 0.2s;">
            <div style="font-size: 1.5rem;">${t.emoji}</div>
            <div style="font-weight: 700; font-size: 0.75rem; margin-top: 4px; color: var(--text-main);">${t.label}</div>
        </button>
    `).join('');

    // Load user weight for calorie estimation
    loadUserWeightForActivity();

    // Push navigation state
    window.history.pushState({ view: 'log-activity' }, '', '#log-activity');
}
window.openLogActivityForm = openLogActivityForm;

async function loadUserWeightForActivity() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;
        const quiz = await window.dbHelpers?.quizResults?.getLatest(session.user.id);
        if (quiz?.weight) {
            activityFormState.userWeightKg = parseFloat(quiz.weight) || 70;
            updateActivityCalories();
        }
    } catch (e) {
        console.error('Failed to load user weight for activity:', e);
    }
}

function selectActivityType(typeKey) {
    activityFormState.selectedType = typeKey;
    // Update UI - highlight selected
    ACTIVITY_TYPES.forEach(t => {
        const btn = document.getElementById(`activity-type-btn-${t.key}`);
        if (btn) {
            if (t.key === typeKey) {
                btn.style.border = `2px solid ${t.color}`;
                btn.style.background = `${t.color}15`;
                btn.style.transform = 'scale(1.05)';
            } else {
                btn.style.border = '2px solid var(--border)';
                btn.style.background = 'var(--card-bg)';
                btn.style.transform = 'scale(1)';
            }
        }
    });
    updateActivityCalories();
}
window.selectActivityType = selectActivityType;

function adjustActivityDuration(delta) {
    activityFormState.duration = Math.max(5, Math.min(300, activityFormState.duration + delta));
    document.getElementById('activity-duration-display').textContent = activityFormState.duration;
    updateActivityCalories();
}
window.adjustActivityDuration = adjustActivityDuration;

function selectActivityIntensity(level) {
    activityFormState.intensity = level;
    document.querySelectorAll('#activity-intensity-row .intensity-btn').forEach(btn => {
        const isSelected = btn.getAttribute('data-intensity') === level;
        btn.style.border = isSelected ? '2px solid #0ea5e9' : '2px solid var(--border)';
        btn.style.background = isSelected ? 'rgba(14,165,233,0.1)' : 'var(--card-bg)';
    });
    updateActivityCalories();
}
window.selectActivityIntensity = selectActivityIntensity;

function updateActivityCalories() {
    const type = activityFormState.selectedType || 'other';
    const cal = estimateCaloriesBurned(type, activityFormState.intensity, activityFormState.duration, activityFormState.userWeightKg);
    document.getElementById('activity-calories-display').textContent = cal;
}

function captureActivityPhoto() {
    document.getElementById('activity-photo-input').click();
}
window.captureActivityPhoto = captureActivityPhoto;

function handleActivityPhotoCapture(input) {
    const file = input.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const base64Full = e.target.result;
        const base64Data = base64Full.split(',')[1];
        activityFormState.photoBase64 = base64Data;
        activityFormState.photoMimeType = file.type || 'image/jpeg';

        // Show preview
        document.getElementById('activity-photo-img').src = base64Full;
        document.getElementById('activity-photo-preview').style.display = 'block';
        document.getElementById('activity-photo-btn').style.display = 'none';
    };
    reader.readAsDataURL(file);
    // Reset input so same file can be re-selected
    input.value = '';
}
window.handleActivityPhotoCapture = handleActivityPhotoCapture;

function removeActivityPhoto() {
    activityFormState.photoBase64 = null;
    activityFormState.photoMimeType = null;
    document.getElementById('activity-photo-preview').style.display = 'none';
    document.getElementById('activity-photo-btn').style.display = 'flex';
}
window.removeActivityPhoto = removeActivityPhoto;

async function saveActivity() {
    if (!activityFormState.selectedType) {
        showToast('Please select an activity type', 'error');
        return;
    }

    const saveBtn = document.getElementById('activity-save-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) {
            showToast('Please log in to save activities', 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = 'Log Activity';
            return;
        }

        const activityType = activityFormState.selectedType;
        const duration = activityFormState.duration;
        const intensity = activityFormState.intensity;
        const label = document.getElementById('activity-label-input').value.trim();
        const notes = document.getElementById('activity-notes-input').value.trim();
        const calories = estimateCaloriesBurned(activityType, intensity, duration, activityFormState.userWeightKg);
        const metValues = ACTIVITY_MET_VALUES[activityType] || ACTIVITY_MET_VALUES.other;
        const metValue = metValues[intensity] || metValues.moderate;

        // Photo verification
        let venueVerifiable = false;
        let venueType = null;
        let aiConfidence = null;
        let detectedElements = [];
        let photoVerified = false;
        let xpEligible = false;

        if (activityFormState.photoBase64) {
            saveBtn.textContent = 'Verifying photo...';
            try {
                const verifyResponse = await fetch('/api/analyze-workout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageBase64: activityFormState.photoBase64,
                        mimeType: activityFormState.photoMimeType,
                        activityType: activityType
                    })
                });

                if (verifyResponse.ok) {
                    const verifyData = await verifyResponse.json();
                    if (verifyData.success) {
                        venueVerifiable = verifyData.venueVerifiable || false;
                        venueType = verifyData.venueType || 'unknown';
                        aiConfidence = verifyData.data?.confidence || 'low';
                        detectedElements = verifyData.data?.detectedElements || [];
                        photoVerified = verifyData.data?.isWorkoutPhoto || false;
                    }
                }
            } catch (verifyError) {
                console.error('Photo verification failed:', verifyError);
                // Continue without verification — no XP but still save
            }

            xpEligible = isActivityXPEligible(activityType, true, venueVerifiable);
        }

        saveBtn.textContent = 'Saving...';

        // Save to database
        const activityRecord = await window.dbHelpers?.activityLogs?.create(session.user.id, {
            activity_type: activityType,
            activity_label: label || null,
            duration_minutes: duration,
            intensity: intensity,
            estimated_calories: calories,
            met_value: metValue,
            photo_url: activityFormState.photoBase64 ? 'photo_captured' : null,
            photo_verified: photoVerified,
            venue_type: venueType,
            venue_verifiable: venueVerifiable,
            ai_confidence: aiConfidence,
            detected_elements: detectedElements,
            xp_eligible: xpEligible,
            notes: notes || null
        });

        // Store for sharing
        const typeInfo = ACTIVITY_TYPES.find(t => t.key === activityType) || ACTIVITY_TYPES[ACTIVITY_TYPES.length - 1];
        savedActivityData = {
            id: activityRecord?.id,
            activity_type: activityType,
            activity_label: label || typeInfo.label,
            duration: duration,
            intensity: intensity,
            calories: calories,
            emoji: typeInfo.emoji,
            color: typeInfo.color,
            xpEligible: xpEligible,
            venueVerifiable: venueVerifiable,
            venueType: venueType,
            photoBase64: activityFormState.photoBase64,
            photoMimeType: activityFormState.photoMimeType
        };

        // Show success screen
        showActivitySuccess(savedActivityData);

    } catch (error) {
        console.error('Error saving activity:', error);
        showToast('Failed to save activity. Please try again.', 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Log Activity';
    }
}
window.saveActivity = saveActivity;

function showActivitySuccess(data) {
    hideAllAppViews();
    document.getElementById('view-activity-success').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    pushNavigationState('view-activity-success', () => closeActivitySuccess());

    // Update success screen
    document.getElementById('activity-success-emoji').textContent = data.emoji;
    document.getElementById('activity-success-label').textContent = data.activity_label;
    document.getElementById('activity-success-duration').textContent = data.duration + ' min';
    document.getElementById('activity-success-calories').textContent = data.calories + ' kcal';

    const intensityEmojis = { light: '🚶', moderate: '🏃', vigorous: '🔥' };
    document.getElementById('activity-success-intensity').textContent = intensityEmojis[data.intensity] || '🏃';

    // XP status
    const xpStatus = document.getElementById('activity-xp-status');
    const noXpHint = document.getElementById('activity-no-xp-hint');

    if (data.xpEligible) {
        xpStatus.style.display = 'block';
        xpStatus.style.background = 'rgba(68, 255, 68, 0.2)';
        xpStatus.style.border = '2px solid rgba(68, 255, 68, 0.5)';
        xpStatus.innerHTML = '<div style="font-weight:700;">📸 Venue verified! Share to earn XP</div>';
        noXpHint.style.display = 'none';
    } else if (data.photoBase64) {
        xpStatus.style.display = 'block';
        xpStatus.style.background = 'rgba(255, 200, 50, 0.2)';
        xpStatus.style.border = '2px solid rgba(255, 200, 50, 0.5)';
        xpStatus.innerHTML = '<div style="font-weight:700;">📸 Photo taken but venue not verified for XP</div><div style="font-size:0.8rem; margin-top:4px; opacity:0.85;">Try a clearer photo showing gym equipment, court, or studio next time</div>';
        noXpHint.style.display = 'none';
    } else {
        xpStatus.style.display = 'none';
        noXpHint.style.display = 'block';
    }

    // Reset share button
    const shareBtn = document.getElementById('activity-share-btn');
    shareBtn.disabled = false;
    document.getElementById('activity-share-btn-text').textContent = data.xpEligible ? 'Share Activity Card (+1 XP)' : 'Share Activity Card';

    window.history.pushState({ view: 'activity-success' }, '', '#activity-success');
}

async function shareActivityCardToFeed() {
    if (!savedActivityData) {
        showToast('No activity data to share', 'error');
        return;
    }

    const shareBtn = document.getElementById('activity-share-btn');
    shareBtn.disabled = true;
    document.getElementById('activity-share-btn-text').textContent = 'Sharing...';

    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) {
            showToast('Please log in to share', 'error');
            shareBtn.disabled = false;
            document.getElementById('activity-share-btn-text').textContent = 'Share Activity Card';
            return;
        }

        // Build card payload for feed rendering
        const cardPayload = {
            card_type: 'activity',
            activity_type: savedActivityData.activity_type,
            activity_label: savedActivityData.activity_label,
            duration: savedActivityData.duration + ' min',
            intensity: savedActivityData.intensity,
            calories: savedActivityData.calories,
            emoji: savedActivityData.emoji,
            venue_type: savedActivityData.venueType
        };

        // Create story in feed
        const storyData = {
            media_type: 'workout_card',
            media_url: savedActivityData.photoBase64 ? `data:${savedActivityData.photoMimeType || 'image/jpeg'};base64,${savedActivityData.photoBase64}` : '',
            caption: JSON.stringify(cardPayload),
            duration: 5
        };

        await window.dbHelpers?.stories?.create(session.user.id, storyData);

        // Award XP if eligible
        if (savedActivityData.xpEligible) {
            await awardWorkoutSharePoint('story', Date.now(), null);

            const xpStatus = document.getElementById('activity-xp-status');
            xpStatus.style.display = 'block';
            xpStatus.style.background = 'rgba(68, 255, 68, 0.2)';
            xpStatus.style.border = '2px solid rgba(68, 255, 68, 0.5)';
            xpStatus.innerHTML = '<div style="font-weight:700; font-size:1.1rem;">+1 XP Earned! 🎉</div>';
        }

        // Update activity log record
        if (savedActivityData.id) {
            try {
                await window.dbHelpers?.activityLogs?.update(savedActivityData.id, {
                    shared_to_feed: true,
                    xp_awarded: savedActivityData.xpEligible
                });
            } catch (e) {
                console.error('Failed to update activity log:', e);
            }
        }

        document.getElementById('activity-share-btn-text').textContent = '✅ Shared!';
        showToast('Activity shared to feed!', 'success');

        // Refresh feed in background
        if (typeof window.loadPhotoFeed === 'function') {
            window.loadPhotoFeed();
        }

    } catch (error) {
        console.error('Error sharing activity:', error);
        showToast('Failed to share. Please try again.', 'error');
        shareBtn.disabled = false;
        document.getElementById('activity-share-btn-text').textContent = 'Share Activity Card';
    }
}
window.shareActivityCardToFeed = shareActivityCardToFeed;

function closeLogActivity() {
    document.getElementById('view-log-activity').style.display = 'none';
    switchAppTab('movement-tab');
}
window.closeLogActivity = closeLogActivity;

function closeActivitySuccess() {
    // Grab activity info for rating before clearing
    const activityName = savedActivityData?.activity_label || savedActivityData?.activity_type || 'Activity';
    const activityId = savedActivityData?.id || null;

    document.getElementById('view-activity-success').style.display = 'none';
    switchAppTab('movement-tab');

    // Show post-workout rating modal for activity
    openWorkoutRatingModal(activityName, 'activity', activityId);
}
window.closeActivitySuccess = closeActivitySuccess;

// ============================================
// END ACTIVITY LOGGING SYSTEM
// ============================================

// Open story upload modal with a pre-loaded image
function openStoryUploadWithImage(file, base64Data, defaultCaption = '') {
    // Store the file for upload
    window.pendingStoryFile = file;
    window.pendingStoryBase64 = base64Data;
    window.pendingStoryType = 'image';

    // Show the story upload modal
    const modal = document.getElementById('story-upload-modal');
    if (modal) {
        modal.style.display = 'flex';
    }

    // Set the preview image
    const previewImage = document.getElementById('story-preview-image');
    const previewVideo = document.getElementById('story-preview-video');
    const placeholder = document.getElementById('story-preview-placeholder');

    if (previewImage) {
        previewImage.src = base64Data;
        previewImage.style.display = 'block';
    }
    if (previewVideo) previewVideo.style.display = 'none';
    if (placeholder) placeholder.style.display = 'none';

    // Set default caption
    const captionInput = document.getElementById('story-caption-input');
    if (captionInput) {
        captionInput.value = defaultCaption;
    }

    // Enable the upload button
    const uploadBtn = document.getElementById('story-upload-button');
    if (uploadBtn) {
        uploadBtn.disabled = false;
        uploadBtn.style.opacity = '1';
    }
}

// Handle story file selection (from file picker)
function handleStoryFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const isVideo = file.type.startsWith('video/');
    const reader = new FileReader();

    reader.onload = function(e) {
        const base64Data = e.target.result;
        window.pendingStoryFile = file;
        window.pendingStoryBase64 = base64Data;
        window.pendingStoryType = isVideo ? 'video' : 'image';

        // Show preview
        const previewImage = document.getElementById('story-preview-image');
        const previewVideo = document.getElementById('story-preview-video');
        const placeholder = document.getElementById('story-preview-placeholder');

        if (isVideo) {
            if (previewVideo) {
                previewVideo.src = base64Data;
                previewVideo.style.display = 'block';
            }
            if (previewImage) previewImage.style.display = 'none';
        } else {
            if (previewImage) {
                previewImage.src = base64Data;
                previewImage.style.display = 'block';
            }
            if (previewVideo) previewVideo.style.display = 'none';
        }
        if (placeholder) placeholder.style.display = 'none';

        // Enable upload button
        const uploadBtn = document.getElementById('story-upload-button');
        if (uploadBtn) {
            uploadBtn.disabled = false;
            uploadBtn.style.opacity = '1';
        }
    };

    reader.readAsDataURL(file);
    event.target.value = ''; // Reset for future selections
}

// Close story upload modal
function closeStoryUploadModal() {
    const modal = document.getElementById('story-upload-modal');
    if (modal) modal.style.display = 'none';

    // Reset state
    window.pendingStoryFile = null;
    window.pendingStoryBase64 = null;
    window.pendingStoryType = null;

    // Reset preview
    const previewImage = document.getElementById('story-preview-image');
    const previewVideo = document.getElementById('story-preview-video');
    const placeholder = document.getElementById('story-preview-placeholder');
    const captionInput = document.getElementById('story-caption-input');
    const uploadBtn = document.getElementById('story-upload-button');

    if (previewImage) { previewImage.src = ''; previewImage.style.display = 'none'; }
    if (previewVideo) { previewVideo.src = ''; previewVideo.style.display = 'none'; }
    if (placeholder) placeholder.style.display = 'flex';
    if (captionInput) captionInput.value = '';
    if (uploadBtn) { uploadBtn.disabled = true; uploadBtn.style.opacity = '0.5'; }
}

// Upload story to database and storage
async function uploadStory() {
    if (!window.pendingStoryFile || !window.pendingStoryBase64) {
        alert('Please select a photo or video first');
        return;
    }

    const uploadBtn = document.getElementById('story-upload-button');
    const captionInput = document.getElementById('story-caption-input');
    const caption = captionInput ? captionInput.value.trim() : '';

    // Disable button and show loading
    if (uploadBtn) {
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';
    }

    try {
        const user = await window.supabaseClient.auth.getUser();
        const userId = user?.data?.user?.id;

        if (!userId) {
            throw new Error('Please sign in to share stories');
        }

        // Compress image if needed
        let fileToUpload = window.pendingStoryFile;
        if (window.pendingStoryType === 'image') {
            fileToUpload = await compressMealImage(window.pendingStoryFile);
        }

        // Check file size - if > 5MB, use Backblaze B2, otherwise use Base64
        const fileSizeMB = fileToUpload.size / (1024 * 1024);
        let mediaUrl;

        if (fileSizeMB > 5) {
            // Upload to Backblaze B2 for larger files
            if (uploadBtn) {
                uploadBtn.textContent = `Uploading ${Math.round(fileSizeMB)}MB...`;
            }

            const tempStoryId = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString();
            const formData = new FormData();
            formData.append('file', fileToUpload);
            formData.append('userId', userId);
            formData.append('storyId', tempStoryId);

            const uploadResponse = await fetch('/api/upload-story-media', {
                method: 'POST',
                body: formData
            });

            if (!uploadResponse.ok) {
                const errorData = await uploadResponse.json();
                throw new Error(errorData.error || 'Upload failed');
            }

            const uploadData = await uploadResponse.json();
            mediaUrl = uploadData.url;
        } else {
            // Use Base64 for smaller files (< 5MB)
            mediaUrl = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(fileToUpload);
            });
        }

        // Save story to database
        const storyData = await dbHelpers.stories.create(userId, {
            media_type: window.pendingStoryType || 'image',
            media_url: mediaUrl,
            thumbnail_url: null,
            caption: caption,
            duration: 5
        });

        // Check if this is a verified workout share (from the workout success screen)
        if (window.pendingWorkoutPhotoData?.forPoints) {
            // Award workout point with verified photo data
            await awardWorkoutSharePoint('story', window.pendingWorkoutPhotoData.timestamp, window.pendingWorkoutPhotoData.hash);
            window.pendingWorkoutPhotoData = null; // Clear after use
        } else if (window.pendingStoryType === 'image') {
            // Regular story - analyze for workout points (in background)
            analyzeStoryForPoints(userId, storyData.id, window.pendingStoryBase64);
        }

        // Close modal and show success
        closeStoryUploadModal();
        showToast('Post shared!', 'success');

        // Refresh feed and stories
        if (typeof loadPhotoFeed === 'function') {
            loadPhotoFeed('friends-photo-feed', 'friends-feed-empty');
        }
        if (typeof loadStories === 'function') {
            loadStories();
        }

    } catch (error) {
        console.error('Error uploading story:', error);
        alert('Failed to upload story: ' + (error.message || 'Please try again'));
    } finally {
        if (uploadBtn) {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Share Post';
        }
    }
}

// Analyze story for workout points
async function analyzeStoryForPoints(userId, storyId, imageBase64) {
    try {
        // Extract base64 data without prefix
        const base64Data = imageBase64.includes(',') ? imageBase64.split(',')[1] : imageBase64;

        const response = await fetch('/api/analyze-story-points', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId,
                storyId,
                imageBase64: base64Data
            })
        });

        const result = await response.json();

        if (result.success && result.pointsAwarded > 0) {
            console.log(`Workout point awarded! Total points: ${result.newTotal}`);
            // Optionally show a toast notification
            if (typeof showToast === 'function') {
                showToast(`+${result.pointsAwarded} point${result.pointsAwarded > 1 ? 's' : ''} for workout story!`, 'success');
            }
        }
    } catch (error) {
        console.error('Error analyzing story for points:', error);
        // Don't alert - this runs in background
    }
}

// Handle workout photo selection
async function handleWorkoutPhotoSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Compress image first to avoid 502 errors on large photos
    capturedWorkoutFile = await compressMealImage(file);

    // Convert compressed image to base64 for preview and analysis
    workoutPhotoBase64 = await fileToBase64(capturedWorkoutFile);

    // Show preview modal
    const previewModal = document.getElementById('workout-preview-modal');
    const previewPhoto = document.getElementById('workout-preview-photo');

    if (previewModal && previewPhoto) {
        previewPhoto.src = workoutPhotoBase64;
        previewModal.style.display = 'flex';
    }

    // Reset file input for future selections
    event.target.value = '';
}

// Close workout preview modal
function closeWorkoutPreviewModal() {
    const previewModal = document.getElementById('workout-preview-modal');
    if (previewModal) {
        previewModal.style.display = 'none';
    }
    capturedWorkoutFile = null;
    workoutPhotoBase64 = null;

    // Hide any loading/error states
    const loading = document.getElementById('workout-photo-loading');
    const error = document.getElementById('workout-photo-error');
    if (loading) loading.style.display = 'none';
    if (error) error.style.display = 'none';
}

// Verify workout photo with Gemini AI
async function verifyWorkoutPhoto() {
    if (!capturedWorkoutFile || !workoutPhotoBase64) {
        alert('No photo captured. Please try again.');
        return;
    }

    const loadingEl = document.getElementById('workout-photo-loading');
    const errorEl = document.getElementById('workout-photo-error');
    const verifyBtn = document.getElementById('workout-verify-btn');

    // Check workout duration first - must be at least 15 minutes for points
    // Try success-duration first (on success screen), then fallback to workout-timer
    const successDurationEl = document.getElementById('success-duration');
    const workoutTimerEl = document.getElementById('workout-timer');
    const durationText = (successDurationEl && successDurationEl.textContent !== '00:00')
        ? successDurationEl.textContent
        : (workoutTimerEl ? workoutTimerEl.textContent : '00:00');
    const [mins, secs] = durationText.split(':').map(Number);
    const totalMinutes = mins + (secs / 60);

    if (totalMinutes < 15) {
        if (errorEl) {
            document.getElementById('workout-photo-error-text').textContent =
                `Workouts need to be at least 15 minutes to earn points. Your workout was ${mins} minute${mins !== 1 ? 's' : ''} ${secs} second${secs !== 1 ? 's' : ''}. Keep going next time!`;
            errorEl.style.display = 'block';
        }
        return;
    }

    // Show loading
    if (loadingEl) loadingEl.style.display = 'block';
    if (verifyBtn) verifyBtn.disabled = true;

    try {
        // Get base64 data without prefix
        const base64Data = workoutPhotoBase64.split(',')[1];

        // Call Gemini API to verify workout photo
        const response = await fetch('/api/analyze-workout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                imageBase64: base64Data,
                mimeType: capturedWorkoutFile.type
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            throw new Error(errorData.error || 'Failed to verify workout photo');
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Verification failed');
        }

        const analysisData = result.data;

        // Check if photo is eligible for points
        if (!result.pointsEligible) {
            // Show why it wasn't eligible
            let reason = 'This photo could not be verified as a workout.';
            if (!analysisData.isWorkoutPhoto) {
                reason = 'This doesn\'t appear to be a workout photo. Try taking a photo at the gym, during exercise, or showing workout equipment.';
            } else if (analysisData.confidence === 'low') {
                reason = 'The photo quality or content couldn\'t be clearly verified. Try a clearer photo showing your workout.';
            } else if (analysisData.suspiciousIndicators?.length > 0) {
                reason = 'This photo appears to be a screenshot or stock image. Please take a real photo of your workout.';
            }

            if (errorEl) {
                document.getElementById('workout-photo-error-text').textContent = reason;
                errorEl.style.display = 'block';
            }
            if (loadingEl) loadingEl.style.display = 'none';
            if (verifyBtn) verifyBtn.disabled = false;
            return;
        }

        // Photo verified! Upload and save
        await saveVerifiedWorkoutPhoto(analysisData);

    } catch (error) {
        console.error('Error verifying workout photo:', error);
        if (errorEl) {
            document.getElementById('workout-photo-error-text').textContent = error.message || 'Failed to verify photo. Please try again.';
            errorEl.style.display = 'block';
        }
        if (loadingEl) loadingEl.style.display = 'none';
        if (verifyBtn) verifyBtn.disabled = false;
    }
}

// Save verified workout photo and award points
async function saveVerifiedWorkoutPhoto(analysisData) {
    const loadingEl = document.getElementById('workout-photo-loading');
    const loadingText = document.getElementById('workout-photo-loading-text');

    if (loadingText) loadingText.textContent = 'Saving workout...';

    try {
        const user = await window.supabaseClient.auth.getUser();
        const userId = user?.data?.user?.id;

        if (!userId) {
            throw new Error('User not authenticated');
        }

        // Upload photo to B2
        const formData = new FormData();
        formData.append('file', capturedWorkoutFile);
        formData.append('userId', userId);

        const uploadResponse = await fetch('/api/upload-workout-photo', {
            method: 'POST',
            body: formData
        });

        if (!uploadResponse.ok) {
            const errorData = await uploadResponse.json();
            throw new Error(errorData.error || 'Failed to upload photo');
        }

        const uploadData = await uploadResponse.json();
        const photoUrl = uploadData.url;

        // Generate photo hash for duplicate detection
        const photoHash = await window.db?.points?.generatePhotoHash(workoutPhotoBase64);

        // Save workout photo log to database
        const { data: savedLog, error: saveError } = await window.supabaseClient
            .from('workout_photo_logs')
            .insert({
                user_id: userId,
                photo_url: photoUrl,
                storage_path: uploadData.fileName,
                is_workout_photo: analysisData.isWorkoutPhoto,
                workout_type: analysisData.workoutType,
                detected_elements: analysisData.detectedElements || [],
                suspicious_indicators: analysisData.suspiciousIndicators || [],
                ai_confidence: analysisData.confidence,
                ai_notes: analysisData.notes,
                analysis_timestamp: new Date().toISOString(),
                points_eligible: true,
                photo_hash: photoHash
            })
            .select();

        if (saveError) {
            console.error('Error saving workout photo log:', saveError);
            // Continue anyway - we still want to award points
        }

        // Award points for the verified workout photo
        const workoutLogId = savedLog?.[0]?.id || `workout_photo_${Date.now()}`;
        const photoTimestamp = capturedWorkoutFile.lastModified
            ? new Date(capturedWorkoutFile.lastModified).toISOString()
            : null;

        const pointsResult = await awardPointsForWorkout(
            workoutLogId,
            photoTimestamp,
            analysisData.confidence,
            photoHash
        );

        // Update the saved log with points awarded
        if (savedLog?.[0]?.id && pointsResult?.pointsAwarded) {
            await window.supabaseClient
                .from('workout_photo_logs')
                .update({ points_awarded: pointsResult.pointsAwarded })
                .eq('id', savedLog[0].id);
        }

        // Close modal and show success
        closeWorkoutPreviewModal();

        // Update success screen to show points earned
        const photoSection = document.getElementById('workout-photo-section');
        const pointsAwarded = document.getElementById('workout-points-awarded');

        if (photoSection) photoSection.style.display = 'none';
        if (pointsAwarded) pointsAwarded.style.display = 'block';

        console.log('Workout photo verified and points awarded!', pointsResult);

    } catch (error) {
        console.error('Error saving workout photo:', error);
        const errorEl = document.getElementById('workout-photo-error');
        if (errorEl) {
            document.getElementById('workout-photo-error-text').textContent = error.message || 'Failed to save workout. Please try again.';
            errorEl.style.display = 'block';
        }
        if (loadingEl) loadingEl.style.display = 'none';
        const verifyBtn = document.getElementById('workout-verify-btn');
        if (verifyBtn) verifyBtn.disabled = false;
    }
}

// Upload workout photo to B2 storage
async function uploadWorkoutPhoto(file) {
    const user = await window.supabaseClient.auth.getUser();
    const userId = user?.data?.user?.id;

    if (!userId) {
        throw new Error('User not authenticated');
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('userId', userId);

    const response = await fetch('/api/upload-workout-photo', {
        method: 'POST',
        body: formData
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to upload photo');
    }

    const data = await response.json();
    return data.url;
}

// Initialize points widget on dashboard load
document.addEventListener('DOMContentLoaded', function() {
    // Load points widget after a short delay to ensure auth is ready
    setTimeout(loadPointsWidget, 1000);
});
</script>

<script>
// ==========================================
// CALORIE TRACKER FUNCTIONS
// ==========================================

let mealCameraSource = 'widget'; // Track where camera was opened from
let mealCameraStream = null; // Camera stream (legacy, no longer used)
let capturedMealFile = null; // Captured meal photo file
let selectedMealType = 'breakfast'; // Default meal type
let selectedInputMethod = null; // 'photo', 'text', or 'voice'
let isRecordingVoice = false;
let speechRecognition = null;

// Auto-detect meal type based on current time
function autoDetectMealType() {
    const hour = new Date().getHours();
    if (hour < 11) return 'breakfast';
    if (hour < 15) return 'lunch';
    if (hour < 21) return 'dinner';
    return 'snack';
}

// Simple text input modal functions
let simpleMealInputInitialized = false;

function selectSimpleMealType(type) {
    selectedMealType = type;
    document.querySelectorAll('.simple-meal-type-bubble').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });
}

function selectPhotoMealType(type) {
    selectedMealType = type;
    document.querySelectorAll('.meal-photo-type-pill').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });
}

function openMealTextInput(source) {
    mealCameraSource = source || 'widget';
    selectedMealType = autoDetectMealType();

    // Update simple modal meal type bubbles
    document.querySelectorAll('.simple-meal-type-bubble').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === selectedMealType);
    });

    const modal = document.getElementById('meal-text-modal');
    const textarea = document.getElementById('simple-meal-input');
    const submitBtn = document.getElementById('simple-meal-submit');

    // Only add event listener once
    if (!simpleMealInputInitialized && textarea) {
        textarea.addEventListener('input', function() {
            const btn = document.getElementById('simple-meal-submit');
            if (btn) btn.disabled = this.value.trim().length === 0;
        });
        simpleMealInputInitialized = true;
    }

    if (textarea) textarea.value = '';
    if (submitBtn) submitBtn.disabled = true;
    if (modal) modal.classList.add('visible');

    // Focus textarea after modal opens
    setTimeout(() => {
        if (textarea) textarea.focus();
    }, 100);
}

function closeMealTextModal() {
    const modal = document.getElementById('meal-text-modal');
    if (modal) modal.classList.remove('visible');
}

async function submitSimpleMealText() {
    const textarea = document.getElementById('simple-meal-input');
    const submitBtn = document.getElementById('simple-meal-submit');
    const description = textarea ? textarea.value.trim() : '';

    if (description.length < 3) {
        alert('Please describe what you ate.');
        return;
    }

    // Close modal immediately and show quick confirmation so user can continue
    closeMealTextModal();
    showToast('📝 Analysing your meal in the background...', 'info');

    // Capture meal type before it can be reset
    const capturedMealType = selectedMealType;

    // Run analysis in background — user can keep using the app
    analyzeMealInBackground({
        description: description,
        mealType: capturedMealType,
        inputMethod: 'text',
        saveFn: async (nutritionData) => {
            await saveMealLogWithType({
                foodItems: nutritionData.foodItems,
                totals: nutritionData.totals,
                micronutrients: nutritionData.micronutrients,
                confidence: nutritionData.confidence,
                notes: nutritionData.notes || description,
                mealType: capturedMealType,
                inputMethod: 'text',
                mealDescription: description
            });
        }
    });
}

// Open the meal input modal (primary entry point)
function openMealInputModal(source) {
    mealCameraSource = source || 'widget';
    selectedMealType = autoDetectMealType();
    selectedInputMethod = null;

    // Reset UI state
    const modal = document.getElementById('meal-input-modal');
    const methodsSection = document.getElementById('meal-input-methods');
    const textSection = document.getElementById('meal-text-section');
    const voiceSection = document.getElementById('meal-voice-section');
    const submitSection = document.getElementById('meal-submit-section');

    if (methodsSection) methodsSection.style.display = 'block';
    if (textSection) textSection.classList.remove('visible');
    if (voiceSection) voiceSection.classList.remove('visible');
    if (submitSection) submitSection.classList.remove('visible');

    // Reset text input
    const textInput = document.getElementById('meal-text-input');
    if (textInput) textInput.value = '';

    // Reset voice transcript
    const voiceTranscript = document.getElementById('voice-transcript');
    if (voiceTranscript) {
        voiceTranscript.textContent = 'Your spoken words will appear here...';
        voiceTranscript.dataset.final = '';
        voiceTranscript.classList.add('empty');
    }

    // Hide delete button
    const deleteBtn = document.getElementById('voice-transcript-delete');
    if (deleteBtn) deleteBtn.style.display = 'none';

    // Update meal type selection UI
    document.querySelectorAll('.meal-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === selectedMealType);
    });

    // Update submit button state
    updateSubmitButtonState();

    // Show modal
    if (modal) modal.classList.add('visible');
}

// Close meal input modal
function closeMealInputModal() {
    const modal = document.getElementById('meal-input-modal');
    if (modal) modal.classList.remove('visible');

    // Stop voice recording if active
    if (isRecordingVoice && speechRecognition) {
        speechRecognition.stop();
        isRecordingVoice = false;
    }
}

// Select meal type
function selectMealType(type) {
    selectedMealType = type;
    document.querySelectorAll('.meal-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });
}

// Select input method
function selectInputMethod(method) {
    selectedInputMethod = method;

    const methodsSection = document.getElementById('meal-input-methods');
    const textSection = document.getElementById('meal-text-section');
    const voiceSection = document.getElementById('meal-voice-section');
    const submitSection = document.getElementById('meal-submit-section');

    if (method === 'photo') {
        // Close modal and open camera
        closeMealInputModal();
        openMealCameraDirect(mealCameraSource);
    } else if (method === 'text') {
        // Show text input
        if (methodsSection) methodsSection.style.display = 'none';
        if (textSection) textSection.classList.add('visible');
        if (voiceSection) voiceSection.classList.remove('visible');
        if (submitSection) submitSection.classList.add('visible');

        // Focus text input
        setTimeout(() => {
            const textInput = document.getElementById('meal-text-input');
            if (textInput) textInput.focus();
        }, 100);
    } else if (method === 'voice') {
        // Show voice input
        if (methodsSection) methodsSection.style.display = 'none';
        if (textSection) textSection.classList.remove('visible');
        if (voiceSection) voiceSection.classList.add('visible');
        if (submitSection) submitSection.classList.add('visible');

        // Check for speech recognition support
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Voice input is not supported in your browser. Please use Chrome or Safari.');
            selectInputMethod('text');
        }
    }

    updateSubmitButtonState();
}

// Update submit button state
function updateSubmitButtonState() {
    const submitBtn = document.getElementById('meal-submit-btn');
    if (!submitBtn) return;

    let hasContent = false;

    if (selectedInputMethod === 'text') {
        const textInput = document.getElementById('meal-text-input');
        hasContent = textInput && textInput.value.trim().length >= 3;
    } else if (selectedInputMethod === 'voice') {
        const voiceTranscript = document.getElementById('voice-transcript');
        hasContent = voiceTranscript && !voiceTranscript.classList.contains('empty') && voiceTranscript.textContent.trim().length >= 3;
    }

    submitBtn.disabled = !hasContent;
}

// Toggle voice recording
function toggleVoiceRecording() {
    if (isRecordingVoice) {
        stopVoiceRecording();
    } else {
        startVoiceRecording();
    }
}

// Start voice recording
function startVoiceRecording() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert('Voice input is not supported in your browser.');
        return;
    }

    speechRecognition = new SpeechRecognition();
    speechRecognition.continuous = true;
    speechRecognition.interimResults = true;
    speechRecognition.lang = 'en-US';

    const recordBtn = document.getElementById('voice-record-btn');
    const statusText = document.getElementById('voice-status');
    const transcript = document.getElementById('voice-transcript');

    speechRecognition.onstart = function() {
        isRecordingVoice = true;
        if (recordBtn) recordBtn.classList.add('recording');
        if (statusText) statusText.textContent = 'Listening... Tap to stop';
        if (transcript) {
            transcript.textContent = '';
            transcript.dataset.final = '';
            transcript.classList.remove('empty');
        }
    };

    speechRecognition.onresult = function(event) {
        let finalTranscript = '';
        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
            const result = event.results[i];
            if (result.isFinal) {
                finalTranscript += result[0].transcript;
            } else {
                interimTranscript += result[0].transcript;
            }
        }

        if (transcript) {
            const currentFinal = transcript.dataset.final || '';
            transcript.dataset.final = currentFinal + finalTranscript;
            transcript.textContent = transcript.dataset.final + interimTranscript;

            // Show delete button and remove empty state when there's content
            if (transcript.textContent.trim().length > 0) {
                transcript.classList.remove('empty');
                const deleteBtn = document.getElementById('voice-transcript-delete');
                if (deleteBtn) deleteBtn.style.display = 'block';
            }
        }

        updateSubmitButtonState();
    };

    speechRecognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        if (statusText) {
            if (event.error === 'not-allowed') {
                statusText.textContent = 'Microphone access denied. Please enable it in settings.';
            } else {
                statusText.textContent = 'Error: ' + event.error + '. Tap to try again.';
            }
        }
        stopVoiceRecording();
    };

    speechRecognition.onend = function() {
        stopVoiceRecording();
    };

    try {
        speechRecognition.start();
    } catch (e) {
        console.error('Failed to start speech recognition:', e);
        alert('Failed to start voice input. Please check microphone permissions.');
    }
}

// Stop voice recording
function stopVoiceRecording() {
    if (speechRecognition) {
        try {
            speechRecognition.stop();
        } catch (e) {
            console.log('Speech recognition already stopped');
        }
    }

    isRecordingVoice = false;

    const recordBtn = document.getElementById('voice-record-btn');
    const statusText = document.getElementById('voice-status');
    const transcript = document.getElementById('voice-transcript');

    if (recordBtn) recordBtn.classList.remove('recording');
    if (statusText) statusText.textContent = 'Tap the microphone to record again';

    // Check if we got any content
    if (transcript && (!transcript.textContent || transcript.textContent.trim().length === 0)) {
        transcript.textContent = 'Your spoken words will appear here...';
        transcript.classList.add('empty');
    }

    updateSubmitButtonState();
}

// Clear voice transcript
function clearVoiceTranscript() {
    const transcript = document.getElementById('voice-transcript');
    const deleteBtn = document.getElementById('voice-transcript-delete');
    const statusText = document.getElementById('voice-status');

    if (transcript) {
        transcript.textContent = 'Your spoken words will appear here...';
        transcript.dataset.final = '';
        transcript.classList.add('empty');
    }

    if (deleteBtn) {
        deleteBtn.style.display = 'none';
    }

    if (statusText) {
        statusText.textContent = 'Tap the microphone and describe your meal';
    }

    updateSubmitButtonState();
}

// Submit meal description (text or voice)
async function submitMealDescription() {
    let description = '';

    if (selectedInputMethod === 'text') {
        const textInput = document.getElementById('meal-text-input');
        description = textInput ? textInput.value.trim() : '';
    } else if (selectedInputMethod === 'voice') {
        const voiceTranscript = document.getElementById('voice-transcript');
        description = voiceTranscript ? voiceTranscript.textContent.trim() : '';
    }

    if (description.length < 3) {
        alert('Please describe what you ate.');
        return;
    }

    // Capture values before closing (modal resets them)
    const capturedMealType = selectedMealType;
    const capturedInputMethod = selectedInputMethod;

    // Close modal immediately so user can continue using the app
    closeMealInputModal();
    showToast('📝 Analysing your meal in the background...', 'info');

    // Run analysis in background
    analyzeMealInBackground({
        description: description,
        mealType: capturedMealType,
        inputMethod: capturedInputMethod,
        saveFn: async (nutritionData) => {
            await saveMealLogWithType({
                foodItems: nutritionData.foodItems,
                totals: nutritionData.totals,
                micronutrients: nutritionData.micronutrients,
                confidence: nutritionData.confidence,
                notes: nutritionData.notes,
                mealType: capturedMealType,
                inputMethod: capturedInputMethod,
                mealDescription: description
            });
        }
    });
}

// ========== Recent Meals Feature ==========

// Track which recent meal is currently selected for confirm step
let _selectedRecentMealIndex = null;

// Open the recent meals modal and load data
async function openRecentMealsModal() {
    const modal = document.getElementById('recent-meals-modal');
    if (modal) modal.classList.add('visible');
    showRecentMealsList();
    await loadRecentMeals();
}

// Close the recent meals modal
function closeRecentMealsModal() {
    const modal = document.getElementById('recent-meals-modal');
    if (modal) modal.classList.remove('visible');
    _selectedRecentMealIndex = null;
}

// Toggle between the list view and the confirm view
function showRecentMealsList() {
    const list = document.getElementById('recent-meals-list');
    const confirm = document.getElementById('recent-meal-confirm');
    const title = document.getElementById('recent-meals-title');
    if (list) list.style.display = '';
    if (confirm) confirm.classList.remove('active');
    if (title) title.textContent = 'Recent Meals';
    _selectedRecentMealIndex = null;
}

function showRecentMealConfirm(index) {
    const meal = window._recentMealsData && window._recentMealsData[index];
    if (!meal) return;

    _selectedRecentMealIndex = index;

    const foodNames = getRecentMealName(meal);
    const cal = Math.round(meal.calories || 0);
    const protein = Math.round(meal.protein_g || 0);
    const carbs = Math.round(meal.carbs_g || 0);
    const fat = Math.round(meal.fat_g || 0);

    const nameEl = document.getElementById('recent-meal-confirm-name');
    const macrosEl = document.getElementById('recent-meal-confirm-macros');
    if (nameEl) nameEl.textContent = foodNames;
    if (macrosEl) macrosEl.textContent = cal + ' cal \u00B7 P: ' + protein + 'g \u00B7 C: ' + carbs + 'g \u00B7 F: ' + fat + 'g';

    const list = document.getElementById('recent-meals-list');
    const confirm = document.getElementById('recent-meal-confirm');
    const title = document.getElementById('recent-meals-title');
    if (list) list.style.display = 'none';
    if (confirm) confirm.classList.add('active');
    if (title) title.textContent = 'Add Meal';
}

// Helper to get display name for a meal
function getRecentMealName(meal) {
    if (Array.isArray(meal.food_items) && meal.food_items.length > 0) {
        return meal.food_items.map(function(item) { return item.name; }).join(', ');
    }
    return meal.meal_description || 'Meal';
}

// Load recent meals from the database (unique meals from last 30 days)
async function loadRecentMeals() {
    var listEl = document.getElementById('recent-meals-list');
    if (!listEl) return;

    listEl.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted);">Loading recent meals...</div>';

    try {
        if (!window.supabaseClient) return;
        var user = await window.supabaseClient.auth.getUser();
        var userId = user?.data?.user?.id;
        if (!userId) return;

        var thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        var sinceDate = thirtyDaysAgo.toISOString().split('T')[0];

        var { data: meals, error } = await window.supabaseClient
            .from('meal_logs')
            .select('food_items, calories, protein_g, carbs_g, fat_g, fiber_g, micronutrients, meal_description, photo_url, meal_type, notes')
            .eq('user_id', userId)
            .gte('meal_date', sinceDate)
            .order('created_at', { ascending: false })
            .limit(100);

        if (error) {
            console.error('Error loading recent meals:', error);
            listEl.innerHTML = '<div class="recent-meals-empty"><p>Could not load recent meals.</p></div>';
            return;
        }

        if (!meals || meals.length === 0) {
            listEl.innerHTML = '<div class="recent-meals-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><p>No recent meals yet.<br><span style="font-size:0.85rem;">Your logged meals will appear here.</span></p></div>';
            return;
        }

        var uniqueMeals = deduplicateRecentMeals(meals);
        renderRecentMealsList(listEl, uniqueMeals);

    } catch (err) {
        console.error('Error in loadRecentMeals:', err);
        listEl.innerHTML = '<div class="recent-meals-empty"><p>Something went wrong.</p></div>';
    }
}

// Deduplicate by sorted food item names
function deduplicateRecentMeals(meals) {
    var seen = new Map();
    for (var i = 0; i < meals.length; i++) {
        var key = getMealKey(meals[i]);
        if (!seen.has(key)) seen.set(key, meals[i]);
    }
    return Array.from(seen.values());
}

function getMealKey(meal) {
    if (Array.isArray(meal.food_items) && meal.food_items.length > 0) {
        return meal.food_items.map(function(item) { return (item.name || '').toLowerCase().trim(); }).sort().join('|');
    }
    if (meal.meal_description) return meal.meal_description.toLowerCase().trim();
    return 'meal-' + meal.calories + '-' + meal.protein_g;
}

// Render the list of recent meals
function renderRecentMealsList(container, meals) {
    if (!meals || meals.length === 0) {
        container.innerHTML = '<div class="recent-meals-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><p>No recent meals yet.<br><span style="font-size:0.85rem;">Your logged meals will appear here.</span></p></div>';
        return;
    }

    var html = '';
    for (var i = 0; i < meals.length; i++) {
        var meal = meals[i];
        var foodNames = getRecentMealName(meal);
        var cal = Math.round(meal.calories || 0);
        var protein = Math.round(meal.protein_g || 0);
        var carbs = Math.round(meal.carbs_g || 0);
        var fat = Math.round(meal.fat_g || 0);

        var hasPhoto = meal.photo_url && meal.photo_url.trim() !== '' && meal.photo_url !== 'text-input';
        var iconHtml = hasPhoto
            ? '<div class="recent-meal-icon"><img src="' + meal.photo_url + '" alt="" referrerpolicy="no-referrer" onerror="this.parentElement.innerHTML=\'&#127869;\'"></div>'
            : '<div class="recent-meal-icon">&#127869;</div>';

        html += '<div class="recent-meal-item" onclick="showRecentMealConfirm(' + i + ')">'
            + iconHtml
            + '<div class="recent-meal-info">'
            + '<div class="recent-meal-name">' + foodNames + '</div>'
            + '<div class="recent-meal-macros">' + cal + ' cal &middot; P: ' + protein + 'g &middot; C: ' + carbs + 'g &middot; F: ' + fat + 'g</div>'
            + '</div>'
            + '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="flex-shrink:0;"><polyline points="9 18 15 12 9 6"></polyline></svg>'
            + '</div>';
    }

    container.innerHTML = html;
    window._recentMealsData = meals;
}

// "Add with Photo" — opens camera, uploads photo, saves meal + awards XP
function recentMealAddWithPhoto() {
    var meal = window._recentMealsData && window._recentMealsData[_selectedRecentMealIndex];
    if (!meal) return;

    // Close modal
    closeRecentMealsModal();

    // Open native camera and wire up the photo flow
    var fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.capture = 'environment';
    fileInput.style.display = 'none';

    var hasProcessed = false;

    fileInput.onchange = async function(e) {
        if (hasProcessed) return;
        hasProcessed = true;

        var file = e.target.files[0];
        cleanup();

        if (!file || !file.type.startsWith('image/')) {
            showToast('No valid photo taken. Meal not added.', 'error');
            return;
        }

        showToast('Uploading photo and saving meal...', 'info');

        try {
            // Compress the photo before uploading (phone photos can be 5-15MB)
            var compressedFile = await compressMealImage(file);

            // Upload the photo
            var photoUrl = await uploadMealPhoto(compressedFile);

            // Save the meal with the photo URL
            var mealType = autoDetectMealType();
            selectedMealType = mealType;

            var savedMeal = await saveMealLog({
                photoUrl: photoUrl,
                foodItems: meal.food_items || [],
                totals: {
                    calories: parseFloat(meal.calories) || 0,
                    protein_g: parseFloat(meal.protein_g) || 0,
                    carbs_g: parseFloat(meal.carbs_g) || 0,
                    fat_g: parseFloat(meal.fat_g) || 0,
                    fiber_g: parseFloat(meal.fiber_g) || 0
                },
                micronutrients: meal.micronutrients || {},
                confidence: 'high',
                notes: meal.notes || getRecentMealName(meal),
                mealType: mealType
            });

            // Award XP points since there's a photo
            if (savedMeal && savedMeal[0]?.id) {
                try {
                    var photoTimestamp = file.lastModified ? new Date(file.lastModified).toISOString() : null;
                    var base64ForHash = await fileToBase64(file);
                    var photoHash = await window.db?.points?.generatePhotoHash(base64ForHash);
                    await awardPointsForMeal(savedMeal[0].id, photoTimestamp, 'high', photoHash);
                } catch (pointsErr) {
                    console.error('Error awarding points (meal still saved):', pointsErr);
                }
            }

            await recalculateDailyNutrition();
            await loadTodayNutrition();
            try { await loadMicronutrientInsights(); } catch(e) {}
            try { if (typeof checkMealBadges === 'function') checkMealBadges(); } catch(e) {}

            showToast('Meal added with photo! +1 XP', 'success');

        } catch (err) {
            console.error('Error adding recent meal with photo:', err);
            showToast('Failed to add meal. Please try again.', 'error');
        }
    };

    function cleanup() {
        try { if (fileInput && fileInput.parentNode) fileInput.parentNode.removeChild(fileInput); } catch(e) {}
    }

    fileInput.addEventListener('cancel', function() {
        cleanup();
        showToast('Photo cancelled. Meal not added.', 'info');
    });

    document.body.appendChild(fileInput);
    setTimeout(function() {
        try { fileInput.click(); } catch(e) { showToast('Camera unavailable.', 'error'); cleanup(); }
    }, 100);
}

// "Quick Add" — saves meal without photo (no XP)
async function recentMealQuickAdd() {
    var meal = window._recentMealsData && window._recentMealsData[_selectedRecentMealIndex];
    if (!meal) return;

    var foodNames = getRecentMealName(meal);

    closeRecentMealsModal();
    showToast('Adding "' + foodNames.substring(0, 40) + '"...', 'info');

    try {
        var mealType = autoDetectMealType();
        selectedMealType = mealType;

        await saveMealLog({
            foodItems: meal.food_items || [],
            totals: {
                calories: parseFloat(meal.calories) || 0,
                protein_g: parseFloat(meal.protein_g) || 0,
                carbs_g: parseFloat(meal.carbs_g) || 0,
                fat_g: parseFloat(meal.fat_g) || 0,
                fiber_g: parseFloat(meal.fiber_g) || 0
            },
            micronutrients: meal.micronutrients || {},
            confidence: 'high',
            notes: meal.notes || foodNames,
            mealType: mealType
        });

        await recalculateDailyNutrition();
        await loadTodayNutrition();
        try { await loadMicronutrientInsights(); } catch(e) {}
        try { if (typeof checkMealBadges === 'function') checkMealBadges(); } catch(e) {}

        showToast('"' + foodNames.substring(0, 30) + '" added!', 'success');

    } catch (err) {
        console.error('Error quick-adding recent meal:', err);
        showToast('Failed to add meal. Please try again.', 'error');
    }
}

// ========== End Recent Meals Feature ==========

// Background meal analysis — fires off the API call and saves results without blocking the UI
async function analyzeMealInBackground({ description, mealType, inputMethod, saveFn }) {
    try {
        const response = await fetch('/.netlify/functions/analyze-meal-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description, mealType })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            throw new Error(errorData.error || 'Failed to analyze meal');
        }

        const result = await response.json();

        if (!result.success || !result.data) {
            throw new Error('Invalid response from analysis');
        }

        const nutritionData = result.data;

        // Save using the provided save function
        await saveFn(nutritionData);

        // Refresh the UI with new data
        await recalculateDailyNutrition();
        await loadTodayNutrition();

        // Refresh micronutrient bars
        await loadMicronutrientInsights();

        // Check meal badges
        try { if (typeof checkMealBadges === 'function') checkMealBadges(); } catch(e) {}

        // Notify user of success
        showMealAnalysisSuccess(nutritionData);

    } catch (error) {
        console.error('Background meal analysis error:', error);
        showMealAnalysisError(error.message);
    }
}

// Save meal log with meal type and input method
async function saveMealLogWithType(mealData) {
    const user = await window.supabaseClient.auth.getUser();
    const userId = user?.data?.user?.id;

    if (!userId) {
        throw new Error('User not authenticated');
    }

    const now = new Date();
    const mealDate = getLocalDateString(now);
    const mealTime = now.toTimeString().split(' ')[0];

    const insertData = {
            user_id: userId,
            meal_date: mealDate,
            meal_time: mealTime,
            meal_type: mealData.mealType || selectedMealType,
            food_items: mealData.foodItems,
            calories: mealData.totals.calories,
            protein_g: mealData.totals.protein_g,
            carbs_g: mealData.totals.carbs_g,
            fat_g: mealData.totals.fat_g,
            fiber_g: mealData.totals.fiber_g,
            micronutrients: mealData.micronutrients,
            notes: mealData.notes,
            ai_confidence: mealData.confidence,
            input_method: mealData.inputMethod || 'photo',
            meal_description: mealData.mealDescription || null,
            analysis_timestamp: new Date().toISOString()
    };

    // Always include photo fields — use 'text-input' sentinel when no photo
    // to satisfy any NOT NULL constraint and match existing UI checks
    insertData.photo_url = mealData.photoUrl || 'text-input';
    insertData.storage_path = mealData.photoUrl || 'text-input';

    const { data, error } = await window.supabaseClient
        .from('meal_logs')
        .insert(insertData)
        .select();

    if (error) {
        console.error('Error saving meal log:', error);
        throw error;
    }

    return data;
}

// Add event listener for text input
document.addEventListener('DOMContentLoaded', function() {
    const textInput = document.getElementById('meal-text-input');
    if (textInput) {
        textInput.addEventListener('input', updateSubmitButtonState);
    }

    // Initialize meal reminder settings
    loadMealReminderSettings();

    // Check for URL parameters to open meal input modal
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('action') === 'log') {
        const mealType = urlParams.get('type') || autoDetectMealType();
        const method = urlParams.get('method') || 'photo';

        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);

        // Open meal input modal after a short delay for page load
        setTimeout(() => {
            openMealInputModal('notification');
            selectMealType(mealType);
            if (method !== 'photo') {
                selectInputMethod(method);
            }
        }, 500);
    }
});

// Listen for messages from service worker (meal reminder clicks)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'open_meal_input') {
            const mealType = event.data.mealType || autoDetectMealType();
            const action = event.data.action;

            // Open meal input modal
            openMealInputModal('notification');
            selectMealType(mealType);

            // If user clicked the text/describe button, go to text input
            if (action === 'log_text') {
                selectInputMethod('text');
            }
        }
    });
}

// ==========================================
// MEAL REMINDER SETTINGS FUNCTIONS
// ==========================================

// Toggle meal reminders on/off
async function toggleMealReminders(enabled) {
    const timesContainer = document.getElementById('meal-reminder-times');
    if (timesContainer) {
        timesContainer.style.display = enabled ? 'block' : 'none';
    }

    // Request notification permission if enabling
    if (enabled && 'Notification' in window) {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            alert('Please enable notifications to receive meal reminders.');
            const toggle = document.getElementById('meal-reminders-toggle');
            if (toggle) toggle.checked = false;
            if (timesContainer) timesContainer.style.display = 'none';
            return;
        }
    }

    await saveMealReminderSettings();
}

// Check if error indicates missing table (table not created yet)
function isMealReminderTableMissing(error) {
    if (!error) return false;
    // PGRST116 = no rows found (not a missing table error)
    // PGRST205 = relation not found in schema cache (PostgREST error)
    // 42P01 = relation does not exist (PostgreSQL error)
    return error.code === 'PGRST205' || error.code === '42P01' ||
           error.message?.includes('relation') ||
           error.message?.includes('does not exist') ||
           error.message?.includes('Could not find the table');
}

// Apply meal reminder settings to UI
function applyMealReminderSettingsToUI(data) {
    const toggle = document.getElementById('meal-reminders-toggle');
    const timesContainer = document.getElementById('meal-reminder-times');

    if (toggle) toggle.checked = data.reminders_enabled;
    if (timesContainer) {
        timesContainer.style.display = data.reminders_enabled ? 'block' : 'none';
    }

    // Set checkbox states
    const breakfastCheck = document.getElementById('breakfast-reminder-check');
    const lunchCheck = document.getElementById('lunch-reminder-check');
    const dinnerCheck = document.getElementById('dinner-reminder-check');

    if (breakfastCheck) breakfastCheck.checked = data.breakfast_reminder;
    if (lunchCheck) lunchCheck.checked = data.lunch_reminder;
    if (dinnerCheck) dinnerCheck.checked = data.dinner_reminder;

    // Set time inputs (convert from time to HH:MM format)
    const breakfastTime = document.getElementById('breakfast-reminder-time');
    const lunchTime = document.getElementById('lunch-reminder-time');
    const dinnerTime = document.getElementById('dinner-reminder-time');

    if (breakfastTime && data.breakfast_time) {
        breakfastTime.value = data.breakfast_time.substring(0, 5);
    }
    if (lunchTime && data.lunch_time) {
        lunchTime.value = data.lunch_time.substring(0, 5);
    }
    if (dinnerTime && data.dinner_time) {
        dinnerTime.value = data.dinner_time.substring(0, 5);
    }
}

// Load meal reminder settings from localStorage (fallback)
function loadMealReminderSettingsFromLocalStorage() {
    const saved = localStorage.getItem('meal_reminder_settings');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            applyMealReminderSettingsToUI(data);
            return true;
        } catch (e) {
            console.error('Error parsing localStorage meal reminder settings:', e);
        }
    }
    return false;
}

// Save meal reminder settings to localStorage (fallback)
function saveMealReminderSettingsToLocalStorage(settings) {
    try {
        localStorage.setItem('meal_reminder_settings', JSON.stringify(settings));
        console.log('Meal reminder settings saved to localStorage');
        return true;
    } catch (e) {
        console.error('Error saving meal reminder settings to localStorage:', e);
        return false;
    }
}

// Load meal reminder settings from database
async function loadMealReminderSettings() {
    try {
        const user = await window.supabaseClient?.auth?.getUser();
        const userId = user?.data?.user?.id;
        if (!userId) {
            // Not logged in, try localStorage
            loadMealReminderSettingsFromLocalStorage();
            return;
        }

        const { data, error } = await window.supabaseClient
            .from('meal_reminder_preferences')
            .select('*')
            .eq('user_id', userId)
            .single();

        // If table doesn't exist, fall back to localStorage
        if (isMealReminderTableMissing(error)) {
            console.log('Meal reminder table not found, using localStorage fallback');
            loadMealReminderSettingsFromLocalStorage();
            return;
        }

        // PGRST116 = no rows found (expected for new users)
        if (error && error.code !== 'PGRST116') {
            console.error('Error loading meal reminder settings:', error);
            // Try localStorage as fallback
            loadMealReminderSettingsFromLocalStorage();
            return;
        }

        if (data) {
            applyMealReminderSettingsToUI(data);
        } else {
            // No DB data, try localStorage
            loadMealReminderSettingsFromLocalStorage();
        }
    } catch (e) {
        console.error('Error loading meal reminder settings:', e);
        // Try localStorage as fallback
        loadMealReminderSettingsFromLocalStorage();
    }
}

// Save meal reminder settings to database
async function saveMealReminderSettings() {
    // Get current UI values
    const remindersEnabled = document.getElementById('meal-reminders-toggle')?.checked || false;
    const breakfastEnabled = document.getElementById('breakfast-reminder-check')?.checked || false;
    const lunchEnabled = document.getElementById('lunch-reminder-check')?.checked || false;
    const dinnerEnabled = document.getElementById('dinner-reminder-check')?.checked || false;

    const breakfastTime = document.getElementById('breakfast-reminder-time')?.value || '08:00';
    const lunchTime = document.getElementById('lunch-reminder-time')?.value || '12:30';
    const dinnerTime = document.getElementById('dinner-reminder-time')?.value || '18:30';

    // Get user's timezone
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    const settings = {
        reminders_enabled: remindersEnabled,
        breakfast_reminder: breakfastEnabled,
        lunch_reminder: lunchEnabled,
        dinner_reminder: dinnerEnabled,
        breakfast_time: breakfastTime + ':00',
        lunch_time: lunchTime + ':00',
        dinner_time: dinnerTime + ':00',
        timezone: timezone,
        updated_at: new Date().toISOString()
    };

    // Always save to localStorage as backup
    saveMealReminderSettingsToLocalStorage(settings);

    try {
        const user = await window.supabaseClient?.auth?.getUser();
        const userId = user?.data?.user?.id;
        if (!userId) {
            // Not logged in, localStorage save is sufficient
            return;
        }

        // Add user_id for database save
        const dbSettings = { ...settings, user_id: userId };

        const { error } = await window.supabaseClient
            .from('meal_reminder_preferences')
            .upsert(dbSettings, { onConflict: 'user_id' });

        // If table doesn't exist, localStorage fallback is already done
        if (isMealReminderTableMissing(error)) {
            console.log('Meal reminder table not found, settings saved to localStorage only');
            return;
        }

        if (error) {
            console.error('Error saving meal reminder settings to database:', error);
        } else {
            console.log('Meal reminder settings saved to database');
        }
    } catch (e) {
        console.error('Error saving meal reminder settings:', e);
        // localStorage save already done above
    }
}

// Open unified camera for meal photos + barcode scanning
function openMealCameraDirect(source) {
    console.log('openMealCameraDirect called from:', source);
    mealCameraSource = source || 'widget';
    openUnifiedCamera();
}

// Keep original function name for backwards compatibility but redirect to new modal
function openMealCamera(source) {
    console.log('openMealCamera called - opening input modal');
    // Now opens the new meal input modal instead of directly opening camera
    openMealInputModal(source);
}

// Legacy camera function - kept for compatibility but no longer used directly
function _legacyOpenMealCamera(source) {
    console.log('_legacyOpenMealCamera called from:', source);
    mealCameraSource = source || 'widget';

    // Create file input to trigger native camera
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.capture = 'environment'; // Opens native camera app
    fileInput.style.display = 'none';

    let hasProcessedFile = false;

    fileInput.onchange = function(e) {
        if (hasProcessedFile) return; // Prevent double-processing
        hasProcessedFile = true;

        const file = e.target.files[0];
        if (!file) {
            console.log('No photo selected from camera');
            cleanup();
            return;
        }

        console.log('Meal photo captured:', file.name, file.type, 'Size:', (file.size / 1024 / 1024).toFixed(2), 'MB');

        // Validate it's an image
        if (!file.type.startsWith('image/')) {
            alert('Invalid file type. Please take a photo.');
            cleanup();
            return;
        }

        // Set as captured meal file
        capturedMealFile = file;

        // Show preview in modal
        const reader = new FileReader();
        reader.onload = function(e) {
            showMealPhotoPreview(e.target.result);
        };
        reader.onerror = function(error) {
            console.error('FileReader error:', error);
            alert('Failed to load photo. Please try again.');
            cleanup();
        };
        reader.readAsDataURL(file);

        // Clean up after processing
        setTimeout(cleanup, 500);
    };

    function cleanup() {
        try {
            if (fileInput && fileInput.parentNode) {
                fileInput.parentNode.removeChild(fileInput);
            }
        } catch (e) {
            console.log('Cleanup error (non-critical):', e);
        }
    }

    // Handle cancel
    fileInput.addEventListener('cancel', function() {
        console.log('Camera cancelled by user');
        cleanup();
    });

    // Fallback cleanup after 2 minutes
    setTimeout(() => {
        if (!hasProcessedFile) {
            console.log('Camera timeout - cleaning up');
            cleanup();
        }
    }, 120000);

    // Add to DOM and trigger
    document.body.appendChild(fileInput);

    // Small delay to ensure proper triggering on all devices
    setTimeout(() => {
        try {
            fileInput.click();
        } catch (error) {
            console.error('Failed to trigger camera:', error);
            alert('Camera unavailable. Please check your browser permissions.');
            cleanup();
        }
    }, 100);
}

// Show meal photo preview in modal
function showMealPhotoPreview(dataUrl) {
    const previewModal = document.getElementById('meal-preview-modal');
    const previewPhoto = document.getElementById('meal-preview-photo');

    if (!previewModal || !previewPhoto) {
        console.error('Preview modal elements not found');
        return;
    }

    // Auto-detect meal type and highlight the correct pill
    selectedMealType = autoDetectMealType();
    document.querySelectorAll('.meal-photo-type-pill').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === selectedMealType);
    });

    // Show modal with preview
    previewPhoto.src = dataUrl;
    previewModal.style.display = 'flex';
}

// Close meal preview modal
function closeMealPreviewModal() {
    const previewModal = document.getElementById('meal-preview-modal');
    if (previewModal) {
        previewModal.style.display = 'none';
    }

    // Clear the food description input
    const descInput = document.getElementById('meal-photo-description');
    if (descInput) descInput.value = '';

    capturedMealFile = null;
}

// Retake meal photo from preview
function retakeMealPhotoFromPreview() {
    closeMealPreviewModal();
    // Reopen camera with same source
    openMealCamera(mealCameraSource);
}

// Legacy functions - no longer needed with native camera

// Use captured meal photo for analysis
async function useMealPhoto() {
    if (!capturedMealFile) {
        alert('No photo captured. Please try again.');
        return;
    }

    // Store file reference before closing modal (modal clears capturedMealFile)
    const fileToAnalyze = capturedMealFile;

    // Get meal description from the text input
    const descInput = document.getElementById('meal-photo-description');
    let mealDescription = descInput ? descInput.value.trim() : '';

    // Close preview modal
    closeMealPreviewModal();

    // Show loading state
    showMealAnalysisLoading();

    // Compress image first to avoid 502 errors on large photos
    const compressedFile = await compressMealImage(fileToAnalyze);

    // Convert compressed image to base64
    const base64 = await fileToBase64(compressedFile);
    const base64Data = base64.split(',')[1]; // Remove data:image/jpeg;base64, prefix

    // Retry logic - try up to 5 times
    const maxAttempts = 5;
    let attempt = 1;
    let success = false;
    let nutritionData = null;
    let lastError = null;

    while (!success && attempt <= maxAttempts) {
        try {
            // Update loading message with retry attempt
            if (attempt > 1) {
                showMealAnalysisLoading(`Analyzing meal... (attempt ${attempt})`);
            }

            // Call Gemini API via edge function
            console.log(`Analyzing food photo (attempt ${attempt})...`);
            const response = await fetch('/.netlify/functions/analyze-food', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    imageBase64: base64Data,
                    mimeType: fileToAnalyze.type,
                    description: mealDescription
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error occurred' }));
                throw new Error(errorData.error || `Failed to analyze food photo (${response.status})`);
            }

            const result = await response.json();

            if (!result.success || !result.data) {
                throw new Error('Invalid response from analysis');
            }

            nutritionData = result.data;
            success = true;

        } catch (error) {
            console.error(`Error analyzing meal (attempt ${attempt}):`, error);
            lastError = error;

            // If not the last attempt, wait before retrying (exponential backoff)
            if (attempt < maxAttempts) {
                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000); // Max 10 seconds
                console.log(`Retrying in ${delay}ms...`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            attempt++;
        }
    }

    // Check if we failed after all attempts
    if (!success) {
        const errorDetails = lastError?.message || "Unknown error";
        showMealAnalysisError(`Failed after ${maxAttempts} attempts. Error: ${errorDetails}`);
        return;
    }

    // Success - save meal to database
    try {
        // Upload photo to Supabase Storage
        const photoUrl = await uploadMealPhoto(fileToAnalyze);

        // Save meal log to database
        const savedMeal = await saveMealLog({
            photoUrl,
            foodItems: nutritionData.foodItems,
            totals: nutritionData.totals,
            micronutrients: nutritionData.micronutrients,
            confidence: nutritionData.confidence,
            notes: nutritionData.notes
        });

        // Award points for the meal (with anti-cheat data)
        if (savedMeal && savedMeal[0]?.id) {
            try {
                // Get photo timestamp from file
                const photoTimestamp = fileToAnalyze.lastModified ? new Date(fileToAnalyze.lastModified).toISOString() : null;

                // Generate photo hash for duplicate detection
                const photoHash = await window.db?.points?.generatePhotoHash(base64);

                // Award points
                await awardPointsForMeal(
                    savedMeal[0].id,
                    photoTimestamp,
                    nutritionData.confidence,
                    photoHash
                );
            } catch (pointsError) {
                console.error('Error awarding points (meal still saved):', pointsError);
                // Don't throw - meal was saved successfully, points are bonus
            }
        }

        // Recalculate daily nutrition totals
        await recalculateDailyNutrition();

        // Refresh display
        await loadTodayNutrition();

        // Refresh micronutrient bars
        await loadMicronutrientInsights();

        // Check meal badges
        try { if (typeof checkMealBadges === 'function') checkMealBadges(); } catch(e) {}

        // Show success message
        showMealAnalysisSuccess(nutritionData);

    } catch (error) {
        console.error('Error saving meal:', error);
        showMealAnalysisError(error.message);
    }
}

// Handle meal photo selection
async function handleMealPhotoSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Compress image first (do this before background so user sees quick response)
    const compressedFile = await compressMealImage(file);
    const base64 = await fileToBase64(compressedFile);
    const base64Data = base64.split(',')[1];

    // Reset file input immediately
    event.target.value = '';

    // Show quick confirmation and let user continue
    showToast('📸 Analysing your photo in the background...', 'info');

    // Run everything else in the background
    analyzePhotoInBackground(file, compressedFile, base64, base64Data);
}

// Background photo analysis with retry logic
async function analyzePhotoInBackground(originalFile, compressedFile, base64, base64Data) {
    const maxAttempts = 5;
    let attempt = 1;
    let success = false;
    let nutritionData = null;
    let lastError = null;

    while (!success && attempt <= maxAttempts) {
        try {
            console.log(`Analyzing food photo (attempt ${attempt})...`);
            const response = await fetch('/.netlify/functions/analyze-food', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    imageBase64: base64Data,
                    mimeType: originalFile.type
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error occurred' }));
                throw new Error(errorData.error || `Failed to analyze food photo (${response.status})`);
            }

            const result = await response.json();

            if (!result.success || !result.data) {
                throw new Error('Invalid response from analysis');
            }

            nutritionData = result.data;
            success = true;
            console.log('Food analysis complete:', nutritionData);

        } catch (error) {
            console.error(`Error analyzing meal (attempt ${attempt}):`, error);
            lastError = error;

            if (attempt < maxAttempts) {
                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
                console.log(`Retrying in ${delay}ms...`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            attempt++;
        }
    }

    if (!success) {
        const errorDetails = lastError?.message || "Unknown error";
        showMealAnalysisError(`Failed after ${maxAttempts} attempts. Error: ${errorDetails}`);
        return;
    }

    // Success - save meal to database
    try {
        const photoUrl = await uploadMealPhoto(originalFile);

        const savedMeal = await saveMealLog({
            photoUrl,
            foodItems: nutritionData.foodItems,
            totals: nutritionData.totals,
            micronutrients: nutritionData.micronutrients,
            confidence: nutritionData.confidence,
            notes: nutritionData.notes
        });

        // Award points
        if (savedMeal && savedMeal[0]?.id) {
            try {
                const photoTimestamp = originalFile.lastModified ? new Date(originalFile.lastModified).toISOString() : null;
                const photoHash = await window.db?.points?.generatePhotoHash(base64);
                await awardPointsForMeal(savedMeal[0].id, photoTimestamp, nutritionData.confidence, photoHash);
            } catch (pointsError) {
                console.error('Error awarding points (meal still saved):', pointsError);
            }
        }

        await recalculateDailyNutrition();
        await loadTodayNutrition();
        await loadMicronutrientInsights();
        showMealAnalysisSuccess(nutritionData);

    } catch (error) {
        console.error('Error saving meal:', error);
        showMealAnalysisError(error.message);
    }
}

// Convert file to base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Compress image for meal analysis (reduces large phone photos to reasonable size)
// Max 1280px dimension, 70% JPEG quality - plenty for food recognition
async function compressMealImage(file) {
    return new Promise((resolve) => {
        // Skip if already small (< 1MB)
        const fileSizeMB = file.size / (1024 * 1024);
        if (fileSizeMB < 1) {
            console.log(`Meal image already small (${fileSizeMB.toFixed(1)}MB), skipping compression`);
            resolve(file);
            return;
        }

        console.log(`Compressing meal image: ${fileSizeMB.toFixed(1)}MB`);

        const img = new Image();
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        img.onload = () => {
            // Calculate new dimensions (max 1280px on longest side)
            const maxDim = 1280;
            let width = img.width;
            let height = img.height;

            if (width > maxDim || height > maxDim) {
                if (width > height) {
                    height = Math.round((height * maxDim) / width);
                    width = maxDim;
                } else {
                    width = Math.round((width * maxDim) / height);
                    height = maxDim;
                }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            // Convert to blob with reduced quality
            canvas.toBlob((blob) => {
                if (blob) {
                    const newSizeMB = blob.size / (1024 * 1024);
                    console.log(`Meal image compressed: ${fileSizeMB.toFixed(1)}MB → ${newSizeMB.toFixed(1)}MB`);
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    resolve(compressedFile);
                } else {
                    console.warn('Meal image compression failed, using original');
                    resolve(file);
                }
            }, 'image/jpeg', 0.7);
        };

        img.onerror = () => {
            console.warn('Failed to load image for compression, using original');
            resolve(file);
        };

        // Load the image
        const reader = new FileReader();
        reader.onload = (e) => { img.src = e.target.result; };
        reader.onerror = () => resolve(file);
        reader.readAsDataURL(file);
    });
}

// Upload meal photo to Backblaze B2
async function uploadMealPhoto(file) {
    const user = await window.supabaseClient.auth.getUser();
    const userId = user?.data?.user?.id;

    if (!userId) {
        throw new Error('User not authenticated');
    }

    // Create form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('userId', userId);

    // Upload to B2 via edge function
    const response = await fetch('/api/upload-meal-photo', {
        method: 'POST',
        body: formData
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to upload photo');
    }

    const data = await response.json();
    return data.url;
}

// Helper function to get local date in YYYY-MM-DD format
// This ensures the date is based on user's local timezone, not UTC
// Get user's dietary preference from storage
function getUserDietaryPreference() {
    // Check localStorage first (fastest)
    const stored = localStorage.getItem('dietaryPreference');
    if (stored) return stored;
    // Fallback to sessionStorage userProfile
    try {
        const profile = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
        if (profile.dietary_preference) {
            localStorage.setItem('dietaryPreference', profile.dietary_preference);
            return profile.dietary_preference;
        }
    } catch (e) {}
    return null; // Not set
}

function getLocalDateString(date = new Date()) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Save meal log to database
async function saveMealLog(mealData) {
    const user = await window.supabaseClient.auth.getUser();
    const userId = user?.data?.user?.id;

    if (!userId) {
        throw new Error('User not authenticated');
    }

    const now = new Date();
    const mealDate = getLocalDateString(now);
    const mealTime = now.toTimeString().split(' ')[0];

    const insertData = {
            user_id: userId,
            meal_date: mealDate,
            meal_time: mealTime,
            meal_type: mealData.mealType || selectedMealType,
            food_items: mealData.foodItems,
            calories: mealData.totals.calories,
            protein_g: mealData.totals.protein_g,
            carbs_g: mealData.totals.carbs_g,
            fat_g: mealData.totals.fat_g,
            fiber_g: mealData.totals.fiber_g,
            micronutrients: mealData.micronutrients,
            notes: mealData.notes,
            ai_confidence: mealData.confidence,
            analysis_timestamp: new Date().toISOString()
    };

    // Always include photo fields — use 'text-input' sentinel when no photo
    // to satisfy any NOT NULL constraint and match existing UI checks
    insertData.photo_url = mealData.photoUrl || 'text-input';
    insertData.storage_path = mealData.photoUrl || 'text-input';

    const { data, error } = await window.supabaseClient
        .from('meal_logs')
        .insert(insertData)
        .select();

    if (error) {
        console.error('Error saving meal log:', error);
        throw error;
    }

    return data;
}

// Manually recalculate and update daily nutrition totals
async function recalculateDailyNutrition() {
    try {
        if (!window.supabaseClient) { console.log('Supabase not initialized'); return; }
        const user = await window.supabaseClient.auth.getUser();
        const userId = user?.data?.user?.id;

        if (!userId) {
            console.log('User not authenticated');
            return;
        }

        const today = getLocalDateString();

        console.log('Recalculating nutrition for user:', userId, 'date:', today);

        // Get all meals for today
        const { data: meals, error: mealsError } = await window.supabaseClient
            .from('meal_logs')
            .select('*')
            .eq('user_id', userId)
            .eq('meal_date', today);

        if (mealsError) {
            console.error('Error fetching meals for recalculation:', mealsError);
            return;
        }

        console.log('Found meals:', meals?.length || 0, meals);

        // Calculate totals
        const totals = {
            total_calories: 0,
            total_protein_g: 0,
            total_carbs_g: 0,
            total_fat_g: 0,
            total_fiber_g: 0,
            meal_count: 0
        };

        if (meals && meals.length > 0) {
            meals.forEach(meal => {
                totals.total_calories += parseFloat(meal.calories) || 0;
                totals.total_protein_g += parseFloat(meal.protein_g) || 0;
                totals.total_carbs_g += parseFloat(meal.carbs_g) || 0;
                totals.total_fat_g += parseFloat(meal.fat_g) || 0;
                totals.total_fiber_g += parseFloat(meal.fiber_g) || 0;
            });
            totals.meal_count = meals.length;
        }

        console.log('Calculated totals:', totals);

        // Get existing goals or use defaults
        const { data: existingData } = await window.supabaseClient
            .from('daily_nutrition')
            .select('calorie_goal, protein_goal_g, carbs_goal_g, fat_goal_g')
            .eq('user_id', userId)
            .eq('nutrition_date', today)
            .maybeSingle();

        console.log('Existing goals:', existingData);

        // Prepare upsert data
        const upsertData = {
            user_id: userId,
            nutrition_date: today,
            total_calories: totals.total_calories,
            total_protein_g: totals.total_protein_g,
            total_carbs_g: totals.total_carbs_g,
            total_fat_g: totals.total_fat_g,
            total_fiber_g: totals.total_fiber_g,
            meal_count: totals.meal_count,
            // Preserve existing goals or use defaults
            calorie_goal: existingData?.calorie_goal || 2000,
            protein_goal_g: existingData?.protein_goal_g || 50,
            carbs_goal_g: existingData?.carbs_goal_g || 250,
            fat_goal_g: existingData?.fat_goal_g || 70
        };

        console.log('Upserting data:', upsertData);

        // Upsert into daily_nutrition
        const { data: upsertResult, error: upsertError } = await window.supabaseClient
            .from('daily_nutrition')
            .upsert(upsertData, { onConflict: 'user_id,nutrition_date' })
            .select();

        if (upsertError) {
            console.error('Error updating daily nutrition:', upsertError);
        } else {
            console.log('Daily nutrition updated successfully:', upsertResult);
        }

    } catch (error) {
        console.error('Error in recalculateDailyNutrition:', error);
    }
}

// Check if it's a new day and reset if needed
function checkAndResetNewDay() {
    const today = getLocalDateString();
    const lastDate = localStorage.getItem('lastCalorieTrackerDate');

    if (lastDate !== today) {
        console.log('New day detected, resetting calorie tracker data');
        localStorage.setItem('lastCalorieTrackerDate', today);
        // Clear any cached data
        return true;
    }
    return false;
}

// Load weekly metrics (last 7 days)
async function loadWeeklyMetrics(userId) {
    try {
        if (!userId) {
            console.log('User not authenticated');
            return;
        }

        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6); // Last 7 days including today

        const startDate = getLocalDateString(sevenDaysAgo);
        const endDate = getLocalDateString(today);

        console.log('Loading weekly metrics from', startDate, 'to', endDate);

        // Fetch last 7 days of nutrition data
        const { data: weeklyData, error: weeklyError } = await window.supabaseClient
            .from('daily_nutrition')
            .select('*')
            .eq('user_id', userId)
            .gte('nutrition_date', startDate)
            .lte('nutrition_date', endDate)
            .order('nutrition_date', { ascending: true });

        if (weeklyError) {
            console.error('Error loading weekly metrics:', weeklyError);
            return;
        }

        console.log('Weekly data loaded:', weeklyData);

        // Calculate weekly totals and averages
        let totalCalories = 0;
        let totalProtein = 0;
        let totalCarbs = 0;
        let totalFat = 0;
        let daysWithData = 0;

        if (weeklyData && weeklyData.length > 0) {
            weeklyData.forEach(day => {
                if (day.total_calories > 0) {
                    totalCalories += day.total_calories || 0;
                    totalProtein += day.total_protein_g || 0;
                    totalCarbs += day.total_carbs_g || 0;
                    totalFat += day.total_fat_g || 0;
                    daysWithData++;
                }
            });
        }

        const weeklyMetrics = {
            totalCalories: Math.round(totalCalories),
            avgCalories: daysWithData > 0 ? Math.round(totalCalories / daysWithData) : 0,
            totalProtein: Math.round(totalProtein),
            totalCarbs: Math.round(totalCarbs),
            totalFat: Math.round(totalFat),
            daysWithData,
            dailyData: weeklyData || []
        };

        console.log('Weekly metrics calculated:', weeklyMetrics);

        // Update weekly metrics UI
        updateWeeklyMetricsUI(weeklyMetrics);

    } catch (error) {
        console.error('Error in loadWeeklyMetrics:', error);
    }
}

// Load today's nutrition data
async function loadTodayNutrition() {
    try {
        // Check if it's a new day
        checkAndResetNewDay();

        if (!window.supabaseClient) { console.log('Supabase not initialized'); return; }
        const user = await window.supabaseClient.auth.getUser();
        const userId = user?.data?.user?.id;

        if (!userId) {
            console.log('User not authenticated');
            return;
        }

        const today = getLocalDateString();

        // Load daily nutrition summary
        const { data: dailyData, error: dailyError } = await window.supabaseClient
            .from('daily_nutrition')
            .select('*')
            .eq('user_id', userId)
            .eq('nutrition_date', today)
            .single();

        if (dailyError && dailyError.code !== 'PGRST116') { // PGRST116 is "not found"
            console.error('Error loading daily nutrition:', dailyError);
        }

        // Check if we need to fetch personalized goals from quiz_results
        // This handles the case where daily_nutrition doesn't exist for today
        // or has default goals instead of personalized ones
        let nutritionDataWithGoals = dailyData;
        const hasPersonalizedGoals = dailyData && dailyData.calorie_goal && dailyData.calorie_goal !== 2000;

        if (!hasPersonalizedGoals) {
            console.log('No personalized goals in daily_nutrition, fetching from quiz_results...');

            // Fetch user's personalized goals from quiz_results
            const { data: quizData, error: quizError } = await window.supabaseClient
                .from('quiz_results')
                .select('calorie_goal, protein_goal_g, carbs_goal_g, fat_goal_g')
                .eq('user_id', userId)
                .order('taken_at', { ascending: false })
                .limit(1)
                .single();

            if (quizError && quizError.code !== 'PGRST116') {
                console.error('Error loading quiz results:', quizError);
            }

            if (quizData && quizData.calorie_goal) {
                console.log('Found personalized goals in quiz_results:', quizData);

                // Merge quiz goals with daily data (or create new object)
                nutritionDataWithGoals = {
                    ...(dailyData || {}),
                    calorie_goal: quizData.calorie_goal,
                    protein_goal_g: quizData.protein_goal_g,
                    carbs_goal_g: quizData.carbs_goal_g,
                    fat_goal_g: quizData.fat_goal_g
                };

                // Also save the goals to daily_nutrition for today so they persist
                try {
                    await window.supabaseClient
                        .from('daily_nutrition')
                        .upsert({
                            user_id: userId,
                            nutrition_date: today,
                            calorie_goal: quizData.calorie_goal,
                            protein_goal_g: quizData.protein_goal_g,
                            carbs_goal_g: quizData.carbs_goal_g,
                            fat_goal_g: quizData.fat_goal_g,
                            total_calories: dailyData?.total_calories || 0,
                            total_protein_g: dailyData?.total_protein_g || 0,
                            total_carbs_g: dailyData?.total_carbs_g || 0,
                            total_fat_g: dailyData?.total_fat_g || 0,
                            total_fiber_g: dailyData?.total_fiber_g || 0
                        }, {
                            onConflict: 'user_id,nutrition_date'
                        });
                    console.log('Saved personalized goals to daily_nutrition for today');
                } catch (saveError) {
                    console.error('Error saving goals to daily_nutrition:', saveError);
                }
            }
        }

        // Load individual meals
        const { data: mealsData, error: mealsError } = await window.supabaseClient
            .from('meal_logs')
            .select('*')
            .eq('user_id', userId)
            .eq('meal_date', today)
            .order('meal_time', { ascending: true });

        if (mealsError) {
            console.error('Error loading meals:', mealsError);
        }

        // Load weekly metrics
        await loadWeeklyMetrics(userId);

        // Update UI with personalized goals
        updateNutritionUI(nutritionDataWithGoals, mealsData);

        // Check if daily log bonus already claimed today
        checkDailyLogBonusStatus();

    } catch (error) {
        console.error('Error in loadTodayNutrition:', error);
    }
}

// Update weekly metrics UI
function updateWeeklyMetricsUI(metrics) {
    // Update total weekly calories
    updateElement('weekly-total-calories', metrics.totalCalories);
    updateElement('weekly-avg-calories', metrics.avgCalories);
    updateElement('weekly-days-logged', metrics.daysWithData);

    // Update daily breakdown if elements exist
    const dailyBreakdownContainer = document.getElementById('weekly-daily-breakdown');
    if (dailyBreakdownContainer && metrics.dailyData.length > 0) {
        let html = '';
        metrics.dailyData.forEach(day => {
            const date = new Date(day.nutrition_date);
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const calories = Math.round(day.total_calories || 0);
            const percentage = day.calorie_goal > 0 ? Math.min((calories / day.calorie_goal) * 100, 100) : 0;

            html += `
                <div class="weekly-day-item">
                    <div class="weekly-day-header">
                        <span class="weekly-day-name">${dayName}</span>
                        <span class="weekly-day-calories">${calories} cal</span>
                    </div>
                    <div class="progress-bar-small">
                        <div class="progress-fill" style="width: ${percentage}%; background: var(--primary);"></div>
                    </div>
                </div>
            `;
        });
        dailyBreakdownContainer.innerHTML = html;
    }
}

// ============================================================
// ENHANCED NUTRITION TAB FEATURES
// ============================================================

// --- 1. Daily Nutrition Score (0-100) ---
function calculateNutritionScore(dailyData) {
    if (!dailyData || !dailyData.calorie_goal) return null;

    const calorieGoal = dailyData.calorie_goal || 2000;
    const proteinGoal = dailyData.protein_goal_g || 50;
    const carbsGoal = dailyData.carbs_goal_g || 250;
    const fatGoal = dailyData.fat_goal_g || 70;

    const calories = dailyData.total_calories || 0;
    const protein = dailyData.total_protein_g || 0;
    const carbs = dailyData.total_carbs_g || 0;
    const fat = dailyData.total_fat_g || 0;

    if (calories === 0) return null;

    // Score each macro: 100 if on target, decreases as you deviate
    function macroScore(actual, goal) {
        if (goal === 0) return 100;
        const ratio = actual / goal;
        // Perfect = 1.0, penalize for over or under
        const deviation = Math.abs(1 - ratio);
        return Math.max(0, Math.round(100 - (deviation * 120)));
    }

    const calScore = macroScore(calories, calorieGoal);
    const proScore = macroScore(protein, proteinGoal);
    const carbScore = macroScore(carbs, carbsGoal);
    const fatScore = macroScore(fat, fatGoal);

    // Weighted average: calories 40%, protein 25%, carbs 20%, fat 15%
    const total = Math.round(calScore * 0.4 + proScore * 0.25 + carbScore * 0.2 + fatScore * 0.15);

    return { total, calScore, proScore, carbScore, fatScore };
}

function updateNutritionScoreUI(dailyData) {
    const scoreData = calculateNutritionScore(dailyData);
    const valueEl = document.getElementById('nutrition-score-value');
    const gradeEl = document.getElementById('nutrition-score-grade');
    const circleEl = document.getElementById('nutrition-score-circle');

    if (!scoreData || !valueEl) return;

    valueEl.textContent = scoreData.total;

    // Update grade text
    let grade = 'Keep going!';
    if (scoreData.total >= 90) grade = 'Excellent!';
    else if (scoreData.total >= 75) grade = 'Great job!';
    else if (scoreData.total >= 60) grade = 'Good progress';
    else if (scoreData.total >= 40) grade = 'Getting there';
    if (gradeEl) gradeEl.textContent = grade;

    // Update ring
    if (circleEl) {
        const circumference = 2 * Math.PI * 42;
        const offset = circumference * (1 - scoreData.total / 100);
        circleEl.style.strokeDashoffset = offset;

        // Color based on score
        if (scoreData.total >= 75) circleEl.style.stroke = 'var(--primary)';
        else if (scoreData.total >= 50) circleEl.style.stroke = '#f59e0b';
        else circleEl.style.stroke = '#ef4444';
    }

    // Update breakdown
    const breakdownEl = document.getElementById('score-breakdown');
    if (breakdownEl) {
        breakdownEl.innerHTML = `
            <div class="score-breakdown-item"><span class="score-dot" style="background: var(--primary);"></span> Cal ${scoreData.calScore}%</div>
            <div class="score-breakdown-item"><span class="score-dot" style="background: #3b82f6;"></span> Pro ${scoreData.proScore}%</div>
            <div class="score-breakdown-item"><span class="score-dot" style="background: #f59e0b;"></span> Carb ${scoreData.carbScore}%</div>
            <div class="score-breakdown-item"><span class="score-dot" style="background: #ef4444;"></span> Fat ${scoreData.fatScore}%</div>
        `;
    }

    // Also update popup score elements
    const popupValueEl = document.getElementById('popup-score-value');
    const popupGradeEl = document.getElementById('popup-score-grade');
    const popupCircleEl = document.getElementById('popup-score-circle');
    const popupBreakdownEl = document.getElementById('popup-score-breakdown');

    if (popupValueEl) popupValueEl.textContent = scoreData.total;
    if (popupGradeEl) popupGradeEl.textContent = grade;
    if (popupCircleEl) {
        const circumference = 2 * Math.PI * 42;
        const offset = circumference * (1 - scoreData.total / 100);
        popupCircleEl.style.strokeDashoffset = offset;
        if (scoreData.total >= 75) popupCircleEl.style.stroke = 'var(--primary)';
        else if (scoreData.total >= 50) popupCircleEl.style.stroke = '#f59e0b';
        else popupCircleEl.style.stroke = '#ef4444';
    }
    if (popupBreakdownEl) {
        popupBreakdownEl.innerHTML = `
            <div class="score-breakdown-item"><span class="score-dot" style="background: var(--primary);"></span> Cal ${scoreData.calScore}%</div>
            <div class="score-breakdown-item"><span class="score-dot" style="background: #3b82f6;"></span> Pro ${scoreData.proScore}%</div>
            <div class="score-breakdown-item"><span class="score-dot" style="background: #f59e0b;"></span> Carb ${scoreData.carbScore}%</div>
            <div class="score-breakdown-item"><span class="score-dot" style="background: #ef4444;"></span> Fat ${scoreData.fatScore}%</div>
        `;
    }
}

// --- Daily Score Popup ---
function openDailyScorePopup() {
    const overlay = document.getElementById('score-popup-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function closeDailyScorePopup(event) {
    if (event && event.target !== event.currentTarget) return;
    const overlay = document.getElementById('score-popup-overlay');
    if (overlay) {
        overlay.style.display = 'none';
        document.body.style.overflow = '';
    }
}

// --- 2. Streak Tracker ---
async function loadStreakData() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        const userId = session.user.id;
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        // Check point_transactions for daily_log claims to determine streak
        const { data: claims, error } = await window.supabaseClient
            .from('point_transactions')
            .select('created_at')
            .eq('user_id', userId)
            .eq('transaction_type', 'earn_daily_log')
            .gte('created_at', getLocalDateString(thirtyDaysAgo))
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading streak:', error);
            // Fallback: use daily_nutrition table
            await loadStreakFromNutrition(userId);
            return;
        }

        // Calculate streak from daily log claims
        const claimedDates = new Set();
        (claims || []).forEach(c => {
            const d = c.created_at.split('T')[0];
            claimedDates.add(d);
        });

        // Also check daily_nutrition for days with data (broader definition of streak)
        const { data: nutritionDays } = await window.supabaseClient
            .from('daily_nutrition')
            .select('nutrition_date, total_calories')
            .eq('user_id', userId)
            .gte('nutrition_date', getLocalDateString(thirtyDaysAgo))
            .order('nutrition_date', { ascending: false });

        const loggedDates = new Set();
        (nutritionDays || []).forEach(d => {
            if (d.total_calories > 0) loggedDates.add(d.nutrition_date);
        });

        // Calculate streak (consecutive days with logged nutrition)
        let streak = 0;
        const checkDate = new Date(today);
        for (let i = 0; i < 100; i++) {
            const ds = getLocalDateString(checkDate);
            if (loggedDates.has(ds) || claimedDates.has(ds)) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            } else {
                break;
            }
        }

        renderStreakUI(streak, loggedDates);
    } catch (err) {
        console.error('Error in loadStreakData:', err);
    }
}

async function loadStreakFromNutrition(userId) {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    const { data: nutritionDays } = await window.supabaseClient
        .from('daily_nutrition')
        .select('nutrition_date, total_calories')
        .eq('user_id', userId)
        .gte('nutrition_date', getLocalDateString(thirtyDaysAgo))
        .order('nutrition_date', { ascending: false });

    const loggedDates = new Set();
    (nutritionDays || []).forEach(d => {
        if (d.total_calories > 0) loggedDates.add(d.nutrition_date);
    });

    let streak = 0;
    const checkDate = new Date(today);
    for (let i = 0; i < 100; i++) {
        if (loggedDates.has(getLocalDateString(checkDate))) {
            streak++;
            checkDate.setDate(checkDate.getDate() - 1);
        } else {
            break;
        }
    }

    renderStreakUI(streak, loggedDates);
}

function renderStreakUI(streak, loggedDates) {
    const countEl = document.getElementById('streak-count');
    if (countEl) countEl.textContent = streak;

    // Update inline streak badge in Daily Nutrition Tracker header
    const inlineCountEl = document.getElementById('streak-inline-count');
    if (inlineCountEl) inlineCountEl.textContent = streak;

    // Streak bonuses from config
    const bonuses = [
        { days: 7, points: 5 },
        { days: 14, points: 10 },
        { days: 30, points: 25 },
        { days: 60, points: 50 },
        { days: 100, points: 100 }
    ];

    // Find next bonus
    const nextBonus = bonuses.find(b => b.days > streak) || bonuses[bonuses.length - 1];
    const nextBonusEl = document.getElementById('streak-next-bonus');
    if (nextBonusEl) {
        if (streak >= 100) {
            nextBonusEl.textContent = '+100 pts earned!';
        } else {
            nextBonusEl.textContent = `+${nextBonus.points} pts at ${nextBonus.days}d`;
        }
    }

    const targetLabel = document.getElementById('streak-target-label');
    if (targetLabel) {
        if (streak >= 100) {
            targetLabel.textContent = 'Max streak bonus reached!';
        } else {
            targetLabel.textContent = `Next: ${nextBonus.days}-day (${nextBonus.points} pts)`;
        }
    }

    // Progress bar toward next bonus
    const progressEl = document.getElementById('streak-progress-fill');
    if (progressEl && nextBonus) {
        const prevBonus = bonuses.filter(b => b.days <= streak).pop();
        const start = prevBonus ? prevBonus.days : 0;
        const pct = Math.min(100, ((streak - start) / (nextBonus.days - start)) * 100);
        progressEl.style.width = pct + '%';
    }

    // Render 7-day dots
    const gridEl = document.getElementById('streak-days-grid');
    if (gridEl) {
        const today = new Date();
        let html = '';
        for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const ds = getLocalDateString(d);
            const dayName = d.toLocaleDateString('en-US', { weekday: 'narrow' });
            const isFilled = loggedDates && loggedDates.has(ds);
            const isToday = i === 0;
            html += `<div class="streak-day-dot${isFilled ? ' filled' : ''}${isToday ? ' today' : ''}">${dayName}</div>`;
        }
        gridEl.innerHTML = html;
    }
}

// --- 3. Multi-Week History ---
async function loadMultiWeekData(numWeeks = 4) {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        // Update nav buttons
        document.querySelectorAll('#multi-week-nav button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.includes(numWeeks)) btn.classList.add('active');
        });

        const userId = session.user.id;
        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - (numWeeks * 7));

        const { data: allData, error } = await window.supabaseClient
            .from('daily_nutrition')
            .select('nutrition_date, total_calories, total_protein_g, total_carbs_g, total_fat_g, calorie_goal')
            .eq('user_id', userId)
            .gte('nutrition_date', getLocalDateString(startDate))
            .order('nutrition_date', { ascending: true });

        if (error) {
            console.error('Error loading multi-week:', error);
            return;
        }

        // Group by week
        const weeks = [];
        for (let w = 0; w < numWeeks; w++) {
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - ((numWeeks - 1 - w) * 7 + 6));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            const weekData = (allData || []).filter(d => {
                return d.nutrition_date >= getLocalDateString(weekStart) && d.nutrition_date <= getLocalDateString(weekEnd);
            });

            const daysWithData = weekData.filter(d => d.total_calories > 0);
            const totalCal = daysWithData.reduce((s, d) => s + (d.total_calories || 0), 0);
            const totalPro = daysWithData.reduce((s, d) => s + (d.total_protein_g || 0), 0);
            const totalCarb = daysWithData.reduce((s, d) => s + (d.total_carbs_g || 0), 0);
            const totalFat = daysWithData.reduce((s, d) => s + (d.total_fat_g || 0), 0);
            const count = daysWithData.length || 1;

            weeks.push({
                label: `Wk ${w + 1}`,
                avgCal: Math.round(totalCal / count),
                avgPro: Math.round(totalPro / count),
                avgCarb: Math.round(totalCarb / count),
                avgFat: Math.round(totalFat / count),
                daysLogged: daysWithData.length,
                totalCal: Math.round(totalCal)
            });
        }

        renderMultiWeekUI(weeks);
    } catch (err) {
        console.error('Error in loadMultiWeekData:', err);
    }
}

function renderMultiWeekUI(weeks) {
    const container = document.getElementById('multi-week-sparklines');
    const compareGrid = document.getElementById('week-compare-grid');
    if (!container) return;

    if (!weeks || weeks.length === 0 || weeks.every(w => w.avgCal === 0)) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px 0; font-size: 0.85rem;">Log meals for at least 2 weeks to see trends</p>';
        if (compareGrid) compareGrid.innerHTML = '';
        return;
    }

    // Build sparklines for calories, protein, carbs, fat
    const metrics = [
        { key: 'avgCal', label: 'Calories', color: 'var(--primary)', suffix: '' },
        { key: 'avgPro', label: 'Protein', color: '#3b82f6', suffix: 'g' },
        { key: 'avgCarb', label: 'Carbs', color: '#f59e0b', suffix: 'g' },
        { key: 'avgFat', label: 'Fat', color: '#ef4444', suffix: 'g' }
    ];

    let html = '';
    metrics.forEach(metric => {
        const values = weeks.map(w => w[metric.key]);
        const max = Math.max(...values, 1);
        const min = Math.min(...values.filter(v => v > 0));
        const current = values[values.length - 1];
        const previous = values.length >= 2 ? values[values.length - 2] : current;

        // Trend
        let trendClass = 'neutral';
        let trendText = '--';
        if (previous > 0 && current > 0) {
            const pctChange = Math.round(((current - previous) / previous) * 100);
            if (pctChange > 2) { trendClass = 'up'; trendText = '+' + pctChange + '%'; }
            else if (pctChange < -2) { trendClass = 'down'; trendText = pctChange + '%'; }
            else { trendText = '~0%'; }
        }

        // Build SVG sparkline
        const svgWidth = 120;
        const svgHeight = 30;
        const padding = 4;
        const points = values.map((v, i) => {
            const x = padding + (i / (values.length - 1 || 1)) * (svgWidth - padding * 2);
            const y = max > min ? svgHeight - padding - ((v - min) / (max - min)) * (svgHeight - padding * 2) : svgHeight / 2;
            return `${x},${y}`;
        }).join(' ');

        html += `
            <div class="sparkline-row">
                <div class="sparkline-label">${metric.label}</div>
                <svg class="sparkline-svg" viewBox="0 0 ${svgWidth} ${svgHeight}">
                    <polyline points="${points}" fill="none" stroke="${metric.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    ${values.map((v, i) => {
                        const x = padding + (i / (values.length - 1 || 1)) * (svgWidth - padding * 2);
                        const y = max > min ? svgHeight - padding - ((v - min) / (max - min)) * (svgHeight - padding * 2) : svgHeight / 2;
                        return `<circle cx="${x}" cy="${y}" r="3" fill="${metric.color}" opacity="${i === values.length - 1 ? 1 : 0.4}"/>`;
                    }).join('')}
                </svg>
                <div class="sparkline-value">${current}${metric.suffix}</div>
                <div class="sparkline-trend ${trendClass}">${trendText}</div>
            </div>
        `;
    });

    container.innerHTML = html;

    // Comparison stats: this week vs last week
    if (compareGrid && weeks.length >= 2) {
        const thisWeek = weeks[weeks.length - 1];
        const lastWeek = weeks[weeks.length - 2];

        compareGrid.innerHTML = `
            <div class="week-compare-stat">
                <div class="stat-value">${thisWeek.avgCal}</div>
                <div class="stat-label">Avg Cal/Day (This Week)</div>
            </div>
            <div class="week-compare-stat">
                <div class="stat-value">${lastWeek.avgCal}</div>
                <div class="stat-label">Avg Cal/Day (Last Week)</div>
            </div>
            <div class="week-compare-stat">
                <div class="stat-value">${thisWeek.daysLogged}/7</div>
                <div class="stat-label">Days Logged (This Week)</div>
            </div>
            <div class="week-compare-stat">
                <div class="stat-value">${lastWeek.daysLogged}/7</div>
                <div class="stat-label">Days Logged (Last Week)</div>
            </div>
        `;
    }
}

// --- 4. Micronutrient Insights ---
async function loadMicronutrientInsights() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        const today = getLocalDateString();

        const { data: meals, error } = await window.supabaseClient
            .from('meal_logs')
            .select('micronutrients, food_items, calories, protein_g')
            .eq('user_id', session.user.id)
            .eq('meal_date', today);

        if (error) {
            console.error('Error loading micronutrients:', error);
            return;
        }

        // Aggregate micronutrients from meal data
        // Map from stored DB keys (with unit suffixes) to display keys
        const keyMap = {
            iron: ['iron_mg', 'iron'],
            vitamin_c: ['vitamin_c_mg', 'vitamin_c'],
            calcium: ['calcium_mg', 'calcium'],
            b12: ['b12_mcg', 'b12'],
            omega3: ['omega3_g', 'omega3'],
            zinc: ['zinc_mg', 'zinc'],
            vitamin_d: ['vitamin_d_mcg', 'vitamin_d'],
            iodine: ['iodine_mcg', 'iodine'],
            selenium: ['selenium_mcg', 'selenium'],
            folate: ['folate_mcg', 'folate'],
            potassium: ['potassium_mg', 'potassium'],
            magnesium: ['magnesium_mg', 'magnesium'],
            vitamin_a: ['vitamin_a_mcg', 'vitamin_a'],
            vitamin_e: ['vitamin_e_mg', 'vitamin_e'],
            vitamin_k: ['vitamin_k_mcg', 'vitamin_k']
        };
        const totals = { iron: 0, vitamin_c: 0, calcium: 0, b12: 0, omega3: 0, zinc: 0, vitamin_d: 0, iodine: 0, selenium: 0, folate: 0, potassium: 0, magnesium: 0, vitamin_a: 0, vitamin_e: 0, vitamin_k: 0 };
        let mealCount = 0;

        (meals || []).forEach(meal => {
            mealCount++;
            if (meal.micronutrients && typeof meal.micronutrients === 'object') {
                Object.keys(totals).forEach(k => {
                    const aliases = keyMap[k] || [k];
                    for (const alias of aliases) {
                        if (meal.micronutrients[alias]) {
                            totals[k] += parseFloat(meal.micronutrients[alias]) || 0;
                            break;
                        }
                    }
                });
            }
        });

        // Daily totals for today
        const dailyTotals = {};
        Object.keys(totals).forEach(k => { dailyTotals[k] = Math.round(totals[k]); });

        renderMicronutrientUI(dailyTotals, mealCount);
    } catch (err) {
        console.error('Error in loadMicronutrientInsights:', err);
    }
}

function renderMicronutrientUI(dailyAvg, mealCount) {
    const grid = document.getElementById('tracker-micro-grid');
    if (!grid) return;

    const userDiet = getUserDietaryPreference();

    // Adjust RDAs based on diet — vegans/vegetarians need more iron (non-heme absorption is lower)
    const ironRda = (userDiet === 'vegan' || userDiet === 'vegetarian') ? 32 : 18;
    // B12 is critical for vegans (no natural dietary source)
    const b12Rda = 2.4;

    // RDA values (daily recommended for adults), adjusted per diet
    const nutrients = [
        { key: 'iron', name: 'Iron', rda: ironRda, unit: 'mg', icon: '&#x1FA78;', barColor: '#ef4444' },
        { key: 'vitamin_c', name: 'Vitamin C', rda: 90, unit: 'mg', icon: '&#x1F34A;', barColor: '#f97316' },
        { key: 'calcium', name: 'Calcium', rda: 1000, unit: 'mg', icon: '&#x1F9B4;', barColor: '#22c55e' },
        { key: 'b12', name: 'B12', rda: b12Rda, unit: 'mcg', icon: '&#x1F9EC;', barColor: '#6366f1' },
        { key: 'omega3', name: 'Omega-3', rda: 1.6, unit: 'g', icon: '&#x1F41F;', barColor: '#0ea5e9' },
        { key: 'zinc', name: 'Zinc', rda: 11, unit: 'mg', icon: '&#x1F6E1;', barColor: '#a855f7' },
        { key: 'vitamin_d', name: 'Vitamin D', rda: 15, unit: 'mcg', icon: '&#x2600;', barColor: '#eab308' },
        { key: 'iodine', name: 'Iodine', rda: 150, unit: 'mcg', icon: '&#x1F30A;', barColor: '#14b8a6' },
        { key: 'selenium', name: 'Selenium', rda: 55, unit: 'mcg', icon: '&#x1FAA8;', barColor: '#78716c' },
        { key: 'folate', name: 'Folate', rda: 400, unit: 'mcg', icon: '&#x1F96C;', barColor: '#16a34a' },
        { key: 'potassium', name: 'Potassium', rda: 2600, unit: 'mg', icon: '&#x1F34C;', barColor: '#d97706' },
        { key: 'magnesium', name: 'Magnesium', rda: 400, unit: 'mg', icon: '&#x1FAB6;', barColor: '#8b5cf6' },
        { key: 'vitamin_a', name: 'Vitamin A', rda: 900, unit: 'mcg', icon: '&#x1F955;', barColor: '#ea580c' },
        { key: 'vitamin_e', name: 'Vitamin E', rda: 15, unit: 'mg', icon: '&#x1F331;', barColor: '#65a30d' },
        { key: 'vitamin_k', name: 'Vitamin K', rda: 120, unit: 'mcg', icon: '&#x1F343;', barColor: '#059669' }
    ];

    if (mealCount === 0) {
        grid.innerHTML = nutrients.map(n => `
            <div class="micro-tracker-item">
                <div class="micro-tracker-header">
                    <span class="micro-tracker-name"><span class="micro-tracker-icon">${n.icon}</span> ${n.name}</span>
                    <span class="micro-tracker-status" style="color: #9ca3af;">--</span>
                </div>
                <div class="progress-bar-micro">
                    <div class="progress-fill-micro" style="width: 0%; background: ${n.barColor};"></div>
                </div>
            </div>
        `).join('');
        return;
    }

    grid.innerHTML = nutrients.map(n => {
        const val = dailyAvg[n.key] || 0;
        const pct = Math.min(100, (val / n.rda) * 100);
        let status = 'Low';
        let statusColor = '#ef4444';
        if (pct >= 80) { status = 'Good'; statusColor = '#22c55e'; }
        else if (pct >= 50) { status = 'Fair'; statusColor = '#f59e0b'; }

        return `
            <div class="micro-tracker-item">
                <div class="micro-tracker-header">
                    <span class="micro-tracker-name"><span class="micro-tracker-icon">${n.icon}</span> ${n.name}</span>
                    <span class="micro-tracker-status" style="color: ${statusColor};">${status}</span>
                </div>
                <div class="progress-bar-micro">
                    <div class="progress-fill-micro" style="width: ${pct}%; background: ${n.barColor};"></div>
                </div>
            </div>
        `;
    }).join('');
}

// --- 5. Meal Pattern Analysis ---
async function loadMealPatterns() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);

        const { data: meals, error } = await window.supabaseClient
            .from('meal_logs')
            .select('meal_date, meal_time, meal_type, calories, protein_g, carbs_g, fat_g, fiber_g, micronutrients')
            .eq('user_id', session.user.id)
            .gte('meal_date', getLocalDateString(sevenDaysAgo))
            .order('meal_date', { ascending: true });

        if (error) {
            console.error('Error loading meal patterns:', error);
            return;
        }

        if (!meals || meals.length < 3) {
            return; // Not enough data for patterns
        }

        const insights = analyzeMealPatterns(meals);
        renderMealPatterns(insights);
    } catch (err) {
        console.error('Error in loadMealPatterns:', err);
    }
}

function analyzeMealPatterns(meals) {
    const insights = [];

    // 1. Meal frequency by day of week
    const dayMealCounts = {};
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    meals.forEach(m => {
        const d = new Date(m.meal_date);
        const day = dayNames[d.getDay()];
        dayMealCounts[day] = (dayMealCounts[day] || 0) + 1;
    });

    // Find day with least meals
    const dayEntries = Object.entries(dayMealCounts);
    if (dayEntries.length >= 3) {
        dayEntries.sort((a, b) => a[1] - b[1]);
        const lowestDay = dayEntries[0];
        const highestDay = dayEntries[dayEntries.length - 1];
        if (lowestDay[1] < highestDay[1] * 0.5) {
            insights.push({
                icon: '&#x1F4C5;',
                text: `You log fewer meals on <strong>${lowestDay[0]}</strong> (${lowestDay[1]} meals) vs <strong>${highestDay[0]}</strong> (${highestDay[1]} meals). Try to stay consistent!`
            });
        }
    }

    // 2. Meal type distribution
    const typeCount = { breakfast: 0, lunch: 0, dinner: 0, snack: 0 };
    meals.forEach(m => {
        const t = (m.meal_type || '').toLowerCase();
        if (typeCount[t] !== undefined) typeCount[t]++;
    });

    const totalMeals = meals.length;
    if (typeCount.breakfast < totalMeals * 0.05 && totalMeals >= 5) {
        insights.push({
            icon: '&#x1F305;',
            text: `You rarely log <strong>breakfast</strong>. Starting the day with protein helps stabilize energy and blood sugar.`
        });
    }

    // 3. Protein distribution across meals
    const mealTypeProtein = { breakfast: [], lunch: [], dinner: [], snack: [] };
    meals.forEach(m => {
        const t = (m.meal_type || '').toLowerCase();
        if (mealTypeProtein[t]) mealTypeProtein[t].push(m.protein_g || 0);
    });

    const avgProtein = {};
    Object.entries(mealTypeProtein).forEach(([type, values]) => {
        if (values.length > 0) {
            avgProtein[type] = Math.round(values.reduce((a, b) => a + b, 0) / values.length);
        }
    });

    const proteinEntries = Object.entries(avgProtein).filter(e => e[1] > 0);
    if (proteinEntries.length >= 2) {
        proteinEntries.sort((a, b) => a[1] - b[1]);
        const lowest = proteinEntries[0];
        const highest = proteinEntries[proteinEntries.length - 1];
        if (lowest[1] < highest[1] * 0.4) {
            insights.push({
                icon: '&#x1F4AA;',
                text: `Your <strong>${lowest[0]}</strong> averages only ${lowest[1]}g protein vs ${highest[1]}g at <strong>${highest[0]}</strong>. Spreading protein evenly aids muscle synthesis.`
            });
        }
    }

    // 4. Eating timing
    const mealHours = meals.filter(m => m.meal_time).map(m => parseInt(m.meal_time.split(':')[0]));
    if (mealHours.length >= 5) {
        const lateCount = mealHours.filter(h => h >= 21).length;
        if (lateCount >= 3) {
            insights.push({
                icon: '&#x1F319;',
                text: `You've had <strong>${lateCount} late-night meals</strong> (after 9pm) this week. Earlier dinners may improve sleep and digestion.`
            });
        }

        const earlyFirst = Math.min(...mealHours);
        const lateLast = Math.max(...mealHours);
        const window = lateLast - earlyFirst;
        if (window <= 8) {
            insights.push({
                icon: '&#x23F0;',
                text: `Your eating window is <strong>${window} hours</strong> - a naturally tight window that supports metabolic health.`
            });
        }
    }

    // 5. Calorie consistency
    const dailyCals = {};
    meals.forEach(m => {
        dailyCals[m.meal_date] = (dailyCals[m.meal_date] || 0) + (m.calories || 0);
    });
    const calValues = Object.values(dailyCals);
    if (calValues.length >= 3) {
        const avg = calValues.reduce((a, b) => a + b, 0) / calValues.length;
        const variance = calValues.reduce((s, v) => s + Math.pow(v - avg, 2), 0) / calValues.length;
        const stdDev = Math.sqrt(variance);
        const cv = avg > 0 ? (stdDev / avg) * 100 : 0;
        if (cv < 15) {
            insights.push({
                icon: '&#x2705;',
                text: `Your daily calories are <strong>very consistent</strong> (only ${Math.round(cv)}% variation). Great discipline!`
            });
        } else if (cv > 35) {
            insights.push({
                icon: '&#x1F4C9;',
                text: `Your calorie intake varies a lot (${Math.round(cv)}% variation). More consistency can help with steady progress.`
            });
        }
    }

    // --- 6. Macro Balance Analysis ---
    const totalProtein = meals.reduce((s, m) => s + (parseFloat(m.protein_g) || 0), 0);
    const totalCarbs = meals.reduce((s, m) => s + (parseFloat(m.carbs_g) || 0), 0);
    const totalFat = meals.reduce((s, m) => s + (parseFloat(m.fat_g) || 0), 0);
    const totalCals = meals.reduce((s, m) => s + (parseFloat(m.calories) || 0), 0);

    if (totalCals > 0) {
        const proteinPct = Math.round((totalProtein * 4 / totalCals) * 100);
        const carbsPct = Math.round((totalCarbs * 4 / totalCals) * 100);
        const fatPct = Math.round((totalFat * 9 / totalCals) * 100);

        if (proteinPct < 12) {
            insights.push({
                icon: '&#x1F4AA;',
                text: `Only <strong>${proteinPct}%</strong> of your calories come from protein this week. Aim for 15-25% to support muscle recovery and satiety.`
            });
        }
        if (fatPct > 40) {
            insights.push({
                icon: '&#x1F95C;',
                text: `<strong>${fatPct}%</strong> of your calories come from fat. Try shifting some towards whole carbs for sustained energy.`
            });
        } else if (fatPct < 15) {
            insights.push({
                icon: '&#x1F95C;',
                text: `Only <strong>${fatPct}%</strong> of your calories come from fat. Healthy fats (avocado, nuts, seeds) support hormone production.`
            });
        }
    }

    // --- 7. Fiber check ---
    const totalFiber = meals.reduce((s, m) => s + (parseFloat(m.fiber_g) || 0), 0);
    const daysWithData = Object.keys(dailyCals).length;
    if (daysWithData >= 3 && totalFiber > 0) {
        const avgFiber = totalFiber / daysWithData;
        if (avgFiber < 20) {
            insights.push({
                icon: '&#x1F33E;',
                text: `Your fiber averages <strong>${Math.round(avgFiber)}g/day</strong>. Aim for 25-35g via beans, oats, and veggies for gut health and satiety.`
            });
        } else if (avgFiber >= 35) {
            insights.push({
                icon: '&#x2705;',
                text: `Great fiber intake at <strong>${Math.round(avgFiber)}g/day</strong>! This supports digestion, gut bacteria, and blood sugar control.`
            });
        }
    }

    // --- 8. Micronutrient Analysis with Supplement Recommendations ---
    const userDiet = (typeof getUserDietaryPreference === 'function') ? getUserDietaryPreference() : null;
    const isPlantBased = userDiet === 'vegan' || userDiet === 'vegetarian';
    const ironRda = isPlantBased ? 32 : 18;

    const microRdas = {
        iron: { rda: ironRda, unit: 'mg', name: 'Iron', keys: ['iron_mg', 'iron'] },
        vitamin_c: { rda: 90, unit: 'mg', name: 'Vitamin C', keys: ['vitamin_c_mg', 'vitamin_c'] },
        calcium: { rda: 1000, unit: 'mg', name: 'Calcium', keys: ['calcium_mg', 'calcium'] },
        b12: { rda: 2.4, unit: 'mcg', name: 'B12', keys: ['b12_mcg', 'b12'] },
        omega3: { rda: 1.6, unit: 'g', name: 'Omega-3', keys: ['omega3_g', 'omega3'] },
        zinc: { rda: 11, unit: 'mg', name: 'Zinc', keys: ['zinc_mg', 'zinc'] },
        vitamin_d: { rda: 15, unit: 'mcg', name: 'Vitamin D', keys: ['vitamin_d_mcg', 'vitamin_d'] },
        iodine: { rda: 150, unit: 'mcg', name: 'Iodine', keys: ['iodine_mcg', 'iodine'] },
        selenium: { rda: 55, unit: 'mcg', name: 'Selenium', keys: ['selenium_mcg', 'selenium'] },
        folate: { rda: 400, unit: 'mcg', name: 'Folate', keys: ['folate_mcg', 'folate'] },
        potassium: { rda: 2600, unit: 'mg', name: 'Potassium', keys: ['potassium_mg', 'potassium'] },
        magnesium: { rda: 400, unit: 'mg', name: 'Magnesium', keys: ['magnesium_mg', 'magnesium'] },
        vitamin_a: { rda: 900, unit: 'mcg', name: 'Vitamin A', keys: ['vitamin_a_mcg', 'vitamin_a'] },
        vitamin_e: { rda: 15, unit: 'mg', name: 'Vitamin E', keys: ['vitamin_e_mg', 'vitamin_e'] },
        vitamin_k: { rda: 120, unit: 'mcg', name: 'Vitamin K', keys: ['vitamin_k_mcg', 'vitamin_k'] }
    };

    // Aggregate weekly micronutrient totals
    const microDailyTotals = {}; // { nutrient: { date: amount } }
    Object.keys(microRdas).forEach(k => { microDailyTotals[k] = {}; });

    meals.forEach(meal => {
        if (!meal.micronutrients || typeof meal.micronutrients !== 'object') return;
        const mDate = meal.meal_date;
        Object.keys(microRdas).forEach(k => {
            const aliases = microRdas[k].keys;
            let val = 0;
            for (const alias of aliases) {
                if (meal.micronutrients[alias]) {
                    val = parseFloat(meal.micronutrients[alias]) || 0;
                    break;
                }
            }
            if (val > 0) {
                microDailyTotals[k][mDate] = (microDailyTotals[k][mDate] || 0) + val;
            }
        });
    });

    // Check each micronutrient: if consistently below 50% RDA across logged days, flag it
    const supplementRecs = {
        omega3: 'Consider an <strong>algae-based Omega-3</strong> supplement (300-600mg DHA/EPA daily) for brain health and inflammation.',
        b12: 'Consider a <strong>B12 supplement</strong> (1,000mcg 3x weekly). Essential for energy and nerve function, especially on a plant-based diet.',
        iron: 'Your iron is low \u2014 consider <strong>Iron Bisglycinate</strong> (18-25mg every other day) paired with Vitamin C for absorption.',
        calcium: 'Consider a <strong>Calcium Citrate + D3</strong> supplement (500mg Ca + 2000IU D3) for bone density protection.',
        zinc: 'Your zinc intake is low \u2014 consider a <strong>Zinc supplement</strong> (15mg every other day). Supports immunity and thyroid function.',
        vitamin_c: 'Your Vitamin C is low. Add citrus fruits, bell peppers, or strawberries \u2014 also boosts iron absorption.',
        vitamin_d: 'Your Vitamin D is low \u2014 consider a <strong>Vitamin D3 supplement</strong> (2000 IU daily). Critical for calcium absorption and immune function, especially with limited sun exposure.',
        iodine: 'Your iodine is low \u2014 consider using <strong>iodized salt</strong> or a <strong>kelp supplement</strong> (150mcg daily). Supports thyroid function and metabolism.',
        selenium: 'Your selenium is low \u2014 try eating <strong>1-2 Brazil nuts daily</strong> (the richest plant source). Supports antioxidant defense and thyroid health.',
        folate: 'Your folate is low \u2014 add more <strong>leafy greens, lentils, and chickpeas</strong>. Essential for cell division and DNA synthesis.',
        potassium: 'Your potassium is low \u2014 add more <strong>bananas, sweet potatoes, and beans</strong>. Important for blood pressure regulation and muscle function.',
        magnesium: 'Your magnesium is low \u2014 consider a <strong>Magnesium Glycinate</strong> supplement (200-400mg daily) or add more pumpkin seeds, spinach, and dark chocolate.',
        vitamin_a: 'Your Vitamin A is low \u2014 add more <strong>sweet potatoes, carrots, and spinach</strong>. Essential for vision, immune function, and skin health.',
        vitamin_e: 'Your Vitamin E is low \u2014 add more <strong>almonds, sunflower seeds, and avocado</strong>. A key antioxidant that protects cells from oxidative damage.',
        vitamin_k: 'Your Vitamin K is low \u2014 add more <strong>kale, broccoli, and Brussels sprouts</strong>. Critical for blood clotting and bone mineralization.'
    };

    const microIcons = {
        omega3: '&#x1F41F;', b12: '&#x1F9EC;', iron: '&#x1FA78;',
        calcium: '&#x1F9B4;', zinc: '&#x1F6E1;', vitamin_c: '&#x1F34A;',
        vitamin_d: '&#x2600;', iodine: '&#x1F30A;', selenium: '&#x1FAA8;',
        folate: '&#x1F96C;', potassium: '&#x1F34C;', magnesium: '&#x1FAB6;',
        vitamin_a: '&#x1F955;', vitamin_e: '&#x1F331;', vitamin_k: '&#x1F343;'
    };

    Object.keys(microRdas).forEach(k => {
        const dailyEntries = Object.values(microDailyTotals[k]);
        if (dailyEntries.length < 3) return; // Not enough data days

        const avgDaily = dailyEntries.reduce((a, b) => a + b, 0) / dailyEntries.length;
        const pctOfRda = (avgDaily / microRdas[k].rda) * 100;

        // If below 50% RDA consistently, recommend supplement
        if (pctOfRda < 50) {
            const rec = supplementRecs[k];
            if (rec) {
                insights.push({
                    icon: microIcons[k] || '&#x1F48A;',
                    text: `Your <strong>${microRdas[k].name}</strong> averages ${Math.round(pctOfRda)}% of daily needs this week. ${rec}`
                });
            }
        } else if (pctOfRda >= 90) {
            // Positive reinforcement for good nutrient levels
            insights.push({
                icon: '&#x2705;',
                text: `Your <strong>${microRdas[k].name}</strong> intake is strong at ${Math.round(pctOfRda)}% of daily needs. Keep it up!`
            });
        }
    });

    return insights.slice(0, 12); // Max 12 insights (expanded for additional micronutrients)
}

function renderMealPatterns(insights) {
    const container = document.getElementById('meal-pattern-insights');
    if (!container) return;

    if (!insights || insights.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Log more meals to see patterns</p>';
        return;
    }

    container.innerHTML = insights.map(i => `
        <div class="pattern-insight">
            <span class="pattern-icon">${i.icon}</span>
            <div class="pattern-text">${i.text}</div>
        </div>
    `).join('');
}

// --- Adaptive Calorie Adjustment ---

// Store current adjustment data so the modal can reference it
let _pendingAdaptiveAdjustment = null;

/**
 * Load and check adaptive calorie adjustment eligibility.
 * Called when the Weekly Trends page opens.
 */
async function loadAdaptiveAdjustment() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;
        const userId = session.user.id;

        const card = document.getElementById('adaptive-adjustment-section');
        if (!card) return;

        // Check if user dismissed this today
        const dismissedDate = localStorage.getItem('adaptiveAdjustmentDismissedDate');
        const today = getLocalDateString();
        if (dismissedDate === today) {
            card.style.display = 'none';
            return;
        }

        // Show the card
        card.style.display = '';

        // Calculate date range: last 14 days
        const now = new Date();
        const fourteenDaysAgo = new Date(now);
        fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 13);
        const startDate = getLocalDateString(fourteenDaysAgo);
        const endDate = getLocalDateString(now);

        // Fetch nutrition data, weigh-ins, and user goals in parallel
        const [nutritionResult, weighInResult, quizResult] = await Promise.allSettled([
            window.supabaseClient
                .from('daily_nutrition')
                .select('*')
                .eq('user_id', userId)
                .gte('nutrition_date', startDate)
                .lte('nutrition_date', endDate)
                .order('nutrition_date', { ascending: true }),
            window.supabaseClient
                .from('daily_weigh_ins')
                .select('*')
                .eq('user_id', userId)
                .gte('weigh_in_date', startDate)
                .lte('weigh_in_date', endDate)
                .order('weigh_in_date', { ascending: true }),
            window.supabaseClient
                .from('quiz_results')
                .select('calorie_goal, protein_goal_g, carbs_goal_g, fat_goal_g, goal_weight, goal_body_type, sex, weight')
                .eq('user_id', userId)
                .order('taken_at', { ascending: false })
                .limit(1)
                .single()
        ]);

        const nutritionDays = nutritionResult.status === 'fulfilled' ? (nutritionResult.value.data || []) : [];
        const weighIns = weighInResult.status === 'fulfilled' ? (weighInResult.value.data || []) : [];
        const quizData = quizResult.status === 'fulfilled' ? quizResult.value.data : null;

        if (!quizData || !quizData.calorie_goal) {
            card.style.display = 'none';
            return;
        }

        const currentCalorieGoal = quizData.calorie_goal;
        const goalWeight = quizData.goal_weight || quizData.weight;

        // Run the analysis
        const result = analyzeAdaptiveAdjustment(nutritionDays, weighIns, currentCalorieGoal, goalWeight);

        if (!result) {
            card.style.display = 'none';
            return;
        }

        // Render the result
        renderAdaptiveAdjustment(result, quizData);

    } catch (err) {
        console.error('Error loading adaptive adjustment:', err);
    }
}

/**
 * Render the adaptive adjustment card based on analysis results.
 */
function renderAdaptiveAdjustment(result, quizData) {
    const card = document.getElementById('adaptive-adjustment-section');
    const progressSection = document.getElementById('adaptive-progress-section');
    const eligibleSection = document.getElementById('adaptive-eligible-section');

    if (!card) return;

    if (!result.eligible) {
        // Show progress toward eligibility
        card.classList.remove('has-suggestion', 'on-track');
        progressSection.style.display = '';
        eligibleSection.style.display = 'none';

        const progressLabel = document.getElementById('adaptive-progress-label');
        const progressFill = document.getElementById('adaptive-progress-fill');
        const progressMessage = document.getElementById('adaptive-progress-message');

        if (result.reason === 'not_enough_tracking') {
            const pct = Math.round((result.trackedDays / result.requiredDays) * 100);
            progressLabel.textContent = `${result.trackedDays} / ${result.requiredDays} days tracked`;
            progressFill.style.width = pct + '%';
            progressMessage.textContent = result.message;
        } else if (result.reason === 'not_enough_weigh_ins') {
            progressLabel.textContent = `${result.weighInCount} / 2 weigh-ins`;
            progressFill.style.width = (result.weighInCount / 2 * 100) + '%';
            progressMessage.textContent = result.message;
        }
        return;
    }

    // Eligible - show full analysis
    progressSection.style.display = 'none';
    eligibleSection.style.display = '';

    // Update stats
    document.getElementById('adaptive-stat-tracked').textContent = result.trackedDays;
    document.getElementById('adaptive-stat-adherence').textContent = result.adherenceRate + '%';

    const weightChangeEl = document.getElementById('adaptive-stat-weight-change');
    const weightUnitPref = localStorage.getItem('weightUnitPreference') || 'kg';
    let weightChangeDisplay;
    if (weightUnitPref === 'lbs') {
        weightChangeDisplay = (result.weightChange * 2.20462).toFixed(1) + ' lbs';
    } else {
        weightChangeDisplay = result.weightChange.toFixed(1) + ' kg';
    }
    if (result.weightChange > 0) weightChangeDisplay = '+' + weightChangeDisplay;
    weightChangeEl.textContent = weightChangeDisplay;

    // Build suggestion
    const container = document.getElementById('adaptive-suggestion-container');
    const suggestion = result.suggestion;

    if (!suggestion) {
        container.innerHTML = '';
        return;
    }

    if (suggestion.direction === 'none') {
        // On track - positive reinforcement
        card.classList.add('on-track');
        card.classList.remove('has-suggestion');
        container.innerHTML = `
            <div class="adaptive-suggestion-box positive">
                <div class="adaptive-suggestion-text">${suggestion.reason}</div>
            </div>
        `;
    } else {
        // Has a suggestion
        card.classList.add('has-suggestion');
        card.classList.remove('on-track');

        const directionWord = suggestion.direction === 'increase' ? 'Increase' : 'Decrease';
        const directionIcon = suggestion.direction === 'increase' ? '&#x1F4C8;' : '&#x1F4C9;';

        container.innerHTML = `
            <div class="adaptive-suggestion-box">
                <div class="adaptive-suggestion-text">${suggestion.reason}</div>
                ${suggestion.question ? `<div class="adaptive-suggestion-question">${suggestion.question}</div>` : ''}
            </div>
            <button class="adaptive-adjust-btn" onclick="openAdaptiveModal()">
                <span>${directionIcon}</span>
                <span>${directionWord} to ${result.newCalorieGoal} kcal/day</span>
            </button>
            <button class="adaptive-dismiss-btn" onclick="dismissAdaptiveAdjustment()">Not right now</button>
        `;

        // Store pending adjustment data for the modal
        _pendingAdaptiveAdjustment = {
            currentCalorieGoal: result.currentCalorieGoal,
            newCalorieGoal: result.newCalorieGoal,
            direction: suggestion.direction,
            quizData: quizData
        };
    }
}

/**
 * Open the confirmation modal for calorie adjustment.
 */
function openAdaptiveModal() {
    if (!_pendingAdaptiveAdjustment) return;

    const overlay = document.getElementById('adaptive-modal-overlay');
    const { currentCalorieGoal, newCalorieGoal, direction } = _pendingAdaptiveAdjustment;

    document.getElementById('adaptive-modal-icon').innerHTML = direction === 'increase' ? '&#x1F4C8;' : '&#x1F4C9;';
    document.getElementById('adaptive-modal-title').textContent =
        direction === 'increase' ? 'Increase Your Calories?' : 'Reduce Your Calories?';

    const diff = Math.abs(newCalorieGoal - currentCalorieGoal);
    document.getElementById('adaptive-modal-body').textContent =
        direction === 'increase'
            ? `Based on your 2-week tracking data, we suggest adding ${diff} calories per day to support your weight gain goals.`
            : `Based on your 2-week tracking data, we suggest reducing ${diff} calories per day to support your weight loss goals.`;

    document.getElementById('adaptive-modal-old').textContent = currentCalorieGoal + ' kcal';
    document.getElementById('adaptive-modal-new').textContent = newCalorieGoal + ' kcal';

    overlay.classList.add('active');
}

/**
 * Close the adjustment modal without applying.
 */
function closeAdaptiveModal() {
    const overlay = document.getElementById('adaptive-modal-overlay');
    overlay.classList.remove('active');
}

/**
 * Confirm and apply the adaptive calorie adjustment.
 * Updates quiz_results, daily_nutrition, and reloads the UI.
 */
async function confirmAdaptiveAdjustment() {
    if (!_pendingAdaptiveAdjustment) return;

    const confirmBtn = document.querySelector('.adaptive-modal-confirm');
    confirmBtn.textContent = 'Updating...';
    confirmBtn.disabled = true;

    try {
        const userId = window.currentUser?.id;
        if (!userId) throw new Error('Not authenticated');

        const { newCalorieGoal, quizData } = _pendingAdaptiveAdjustment;

        // Recalculate macros proportionally based on new calorie goal
        const goalBodyType = quizData.goal_body_type || 'Athletic';
        const currentWeight = quizData.weight || 70;
        const macros = calculateMacros(newCalorieGoal, goalBodyType, currentWeight);

        const newGoals = {
            calorie_goal: newCalorieGoal,
            protein_goal_g: macros.protein_g,
            carbs_goal_g: macros.carbs_g,
            fat_goal_g: macros.fat_g
        };

        // Update quiz_results
        await window.supabaseClient.from('quiz_results')
            .update({
                calorie_goal: newGoals.calorie_goal,
                protein_goal_g: newGoals.protein_goal_g,
                carbs_goal_g: newGoals.carbs_goal_g,
                fat_goal_g: newGoals.fat_goal_g
            })
            .eq('user_id', userId);

        // Update today's daily_nutrition goals
        const today = getLocalDateString();
        await window.supabaseClient.from('daily_nutrition')
            .upsert({
                user_id: userId,
                nutrition_date: today,
                calorie_goal: newGoals.calorie_goal,
                protein_goal_g: newGoals.protein_goal_g,
                carbs_goal_g: newGoals.carbs_goal_g,
                fat_goal_g: newGoals.fat_goal_g
            }, {
                onConflict: 'user_id,nutrition_date'
            });

        // Close modal
        closeAdaptiveModal();

        // Update the card to show success
        const container = document.getElementById('adaptive-suggestion-container');
        const card = document.getElementById('adaptive-adjustment-section');
        card.classList.remove('has-suggestion');
        card.classList.add('on-track');
        container.innerHTML = `
            <div class="adaptive-suggestion-box positive">
                <div class="adaptive-suggestion-text">
                    <strong>Goals updated!</strong> Your new daily target is <strong>${newGoals.calorie_goal} kcal</strong>
                    (${newGoals.protein_goal_g}g protein, ${newGoals.carbs_goal_g}g carbs, ${newGoals.fat_goal_g}g fat).
                    Keep tracking and we'll check in again in 2 weeks.
                </div>
            </div>
        `;

        // Reload nutrition UI to reflect new goals
        _pendingAdaptiveAdjustment = null;
        if (typeof loadTodayNutrition === 'function') {
            loadTodayNutrition();
        }

    } catch (err) {
        console.error('Error applying adaptive adjustment:', err);
        alert('Failed to update goals. Please try again.');
    } finally {
        confirmBtn.textContent = 'Yes, update my goals';
        confirmBtn.disabled = false;
    }
}

/**
 * Dismiss the adaptive adjustment suggestion for today.
 */
function dismissAdaptiveAdjustment() {
    localStorage.setItem('adaptiveAdjustmentDismissedDate', getLocalDateString());
    const card = document.getElementById('adaptive-adjustment-section');
    if (card) card.style.display = 'none';
}

// --- 6. Photo Meal Journal ---
async function loadMealJournal() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);

        const { data: meals, error } = await window.supabaseClient
            .from('meal_logs')
            .select('meal_date, meal_time, photo_url, calories, food_items')
            .eq('user_id', session.user.id)
            .gte('meal_date', getLocalDateString(sevenDaysAgo))
            .order('meal_date', { ascending: false });

        if (error) {
            console.error('Error loading meal journal:', error);
            return;
        }

        renderMealJournal(meals || []);
    } catch (err) {
        console.error('Error in loadMealJournal:', err);
    }
}

function renderMealJournal(meals) {
    const container = document.getElementById('journal-timeline');
    if (!container) return;

    if (!meals || meals.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">No meals logged yet this week</p>';
        return;
    }

    // Group by date
    const grouped = {};
    meals.forEach(m => {
        if (!grouped[m.meal_date]) grouped[m.meal_date] = [];
        grouped[m.meal_date].push(m);
    });

    const dates = Object.keys(grouped).sort().reverse().slice(0, 7);

    let html = '';
    dates.forEach(dateStr => {
        const d = new Date(dateStr + 'T12:00:00');
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const dayNum = d.getDate();
        const dayMeals = grouped[dateStr];
        const totalCal = dayMeals.reduce((s, m) => s + (m.calories || 0), 0);

        html += `
            <div class="journal-day">
                <div class="journal-date-col">
                    <div class="journal-date-day">${dayName}</div>
                    <div class="journal-date-num">${dayNum}</div>
                    <div class="journal-day-cals">${Math.round(totalCal)} cal</div>
                </div>
                <div class="journal-photos">
        `;

        dayMeals.forEach(meal => {
            const hasPhoto = meal.photo_url && meal.photo_url.trim() !== '' && meal.photo_url !== 'text-input';
            if (hasPhoto) {
                html += `<div class="journal-photo"><img src="${meal.photo_url}" alt="Meal" referrerpolicy="no-referrer" onerror="this.parentElement.innerHTML='<span class=\\'placeholder\\'>&#x1F37D;</span>';"></div>`;
            } else {
                const foodName = Array.isArray(meal.food_items) && meal.food_items.length > 0
                    ? meal.food_items[0].name || 'Meal'
                    : 'Meal';
                html += `<div class="journal-photo" style="font-size: 0.65rem; color: var(--text-muted); padding: 4px; text-align: center; word-break: break-word;">${foodName.substring(0, 20)}</div>`;
            }
        });

        html += `
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// --- 7. Cycle-Synced Nutrition Tips ---
function loadCycleNutritionTips() {
    // Only show for female users with cycle tracking
    if (typeof isMaleUser === 'function' && isMaleUser()) return;

    const section = document.getElementById('cycle-nutrition-section');
    if (!section) return;

    // Get current cycle phase
    let phaseKey = null;
    try {
        if (typeof userCycleData !== 'undefined' && userCycleData.lastPeriod) {
            const lastPeriod = new Date(userCycleData.lastPeriod);
            const today = new Date();
            const diffMs = today - lastPeriod;
            const dayOfCycle = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
            const cycleLen = userCycleData.cycleLength || 28;
            phaseKey = getCyclePhase(dayOfCycle, cycleLen);
        }
    } catch (e) {
        console.log('Could not determine cycle phase for nutrition tips');
    }

    if (!phaseKey || phaseKey === 'performance' || phaseKey === 'wellness') return;

    const tips = {
        menstrual: {
            phase: 'Menstrual Phase',
            icon: '&#x1FA78;',
            color: '#E57373',
            bgColor: '#fef2f2',
            borderColor: '#fecaca',
            tipBg: 'rgba(239, 68, 68, 0.06)',
            tips: (function() {
                const diet = getUserDietaryPreference();
                const ironFoods = (diet === 'omnivore' || diet === 'flexitarian') ? 'red meat, spinach, lentils, and pumpkin seeds' :
                    (diet === 'pescatarian') ? 'fish, spinach, lentils, and pumpkin seeds' :
                    'spinach, lentils, pumpkin seeds, and dark chocolate';
                return [
                    { icon: '&#x1FA78;', text: `<strong>Focus on iron-rich foods</strong> — ${ironFoods} to replenish iron lost during menstruation.` },
                    { icon: '&#x1F9CA;', text: '<strong>Anti-inflammatory foods</strong> — turmeric, ginger, and berries help reduce cramps and bloating.' },
                    { icon: '&#x2615;', text: '<strong>Warm, comforting meals</strong> — soups and stews are easier to digest. Your body needs gentle nourishment right now.' },
                    { icon: '&#x1F4A7;', text: '<strong>Stay hydrated</strong> — water retention is common. Drink more water to help flush excess fluid.' }
                ];
            })()
        },
        follicular: {
            phase: 'Follicular Phase',
            icon: '&#x26A1;',
            color: '#F06292',
            bgColor: '#fdf2f8',
            borderColor: '#fbcfe8',
            tipBg: 'rgba(240, 98, 146, 0.06)',
            tips: (function() {
                const diet = getUserDietaryPreference();
                const proteinTip = (diet === 'omnivore' || diet === 'flexitarian') ? 'Aim for lean meats, eggs, or legumes with each meal.' :
                    (diet === 'pescatarian') ? 'Aim for fish, eggs, or legumes with each meal.' :
                    (diet === 'vegetarian') ? 'Aim for eggs, dairy, or legumes with each meal.' :
                    'Aim for tofu, tempeh, or legumes with each meal.';
                return [
                    { icon: '&#x1F95A;', text: `<strong>Higher protein intake</strong> — your body is primed for muscle building. ${proteinTip}` },
                    { icon: '&#x1F966;', text: '<strong>Fermented and sprouted foods</strong> — your gut is more receptive now. Great time for kimchi, sauerkraut, and sprouted grains.' },
                    { icon: '&#x26A1;', text: '<strong>Light, energizing meals</strong> — your metabolism is speeding up. Fresh salads, grain bowls, and smoothies work well.' },
                    { icon: '&#x1F3CB;', text: '<strong>Pre-workout carbs</strong> — energy is rising. Fuel your workouts with oats, sweet potato, or banana.' }
                ];
            })()
        },
        ovulation: {
            phase: 'Ovulation Phase',
            icon: '&#x1F31F;',
            color: '#BA68C8',
            bgColor: '#faf5ff',
            borderColor: '#e9d5ff',
            tipBg: 'rgba(186, 104, 200, 0.06)',
            tips: [
                { icon: '&#x1F966;', text: '<strong>Cruciferous vegetables</strong> — broccoli, kale, cauliflower help your liver process the estrogen peak.' },
                { icon: '&#x1F95C;', text: '<strong>Fiber-rich foods</strong> — help eliminate excess estrogen. Flaxseeds, chia seeds, and legumes are ideal.' },
                { icon: '&#x1F4A7;', text: '<strong>Lighter meals</strong> — energy is at its peak but appetite may drop slightly. Listen to your body.' },
                { icon: '&#x1F34E;', text: '<strong>Antioxidant-rich fruits</strong> — support egg health and reduce oxidative stress.' }
            ]
        },
        luteal: {
            phase: 'Luteal Phase',
            icon: '&#x1F319;',
            color: '#FFB74D',
            bgColor: '#fffbeb',
            borderColor: '#fde68a',
            tipBg: 'rgba(255, 183, 77, 0.06)',
            tips: [
                { icon: '&#x1F360;', text: '<strong>Complex carbs are key</strong> — sweet potato, brown rice, quinoa help boost serotonin and manage cravings.' },
                { icon: '&#x1F36B;', text: '<strong>Magnesium-rich foods</strong> — dark chocolate, nuts, and seeds help reduce PMS symptoms and improve sleep.' },
                { icon: '&#x1F9C0;', text: '<strong>Calcium boost</strong> — studies show calcium reduces PMS. Include leafy greens, fortified plant milk, and tahini.' },
                { icon: '&#x1F34C;', text: '<strong>B6 foods</strong> — bananas, chickpeas, and potatoes help with mood stability and reduce water retention.' }
            ]
        }
    };

    const phaseData = tips[phaseKey];
    if (!phaseData) return;

    section.style.display = 'block';
    section.style.background = `linear-gradient(135deg, ${phaseData.bgColor} 0%, white 100%)`;
    section.style.borderColor = phaseData.borderColor;

    const iconEl = document.getElementById('cycle-nutrition-icon');
    const phaseEl = document.getElementById('cycle-nutrition-phase');
    const listEl = document.getElementById('cycle-tip-list');

    if (iconEl) iconEl.innerHTML = phaseData.icon;
    if (phaseEl) {
        phaseEl.textContent = phaseData.phase;
        phaseEl.style.color = phaseData.color;
    }

    if (listEl) {
        listEl.innerHTML = phaseData.tips.map(t => `
            <div class="cycle-tip" style="background: ${phaseData.tipBg};">
                <span class="cycle-tip-icon">${t.icon}</span>
                <div>${t.text}</div>
            </div>
        `).join('');
    }
}

// ============================================================
// ENHANCED NUTRITION TAB FEATURES - PHASE 2
// ============================================================

// --- 8. Weekly Score History ---
async function loadScoreHistory() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);

        const { data: days, error } = await window.supabaseClient
            .from('daily_nutrition')
            .select('nutrition_date, total_calories, total_protein_g, total_carbs_g, total_fat_g, calorie_goal, protein_goal_g, carbs_goal_g, fat_goal_g')
            .eq('user_id', session.user.id)
            .gte('nutrition_date', getLocalDateString(sevenDaysAgo))
            .lte('nutrition_date', getLocalDateString(today))
            .order('nutrition_date', { ascending: true });

        if (error) { console.error('Error loading score history:', error); return; }

        renderScoreHistory(days || []);
    } catch (err) {
        console.error('Error in loadScoreHistory:', err);
    }
}

function renderScoreHistory(days) {
    const container = document.getElementById('score-history-bars');
    if (!container) return;

    const today = new Date();
    const dayMap = {};
    (days || []).forEach(d => { dayMap[d.nutrition_date] = d; });

    let html = '';
    for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const ds = getLocalDateString(d);
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const dayData = dayMap[ds];
        const score = dayData ? calculateNutritionScore(dayData) : null;
        const value = score ? score.total : 0;
        const height = Math.max(4, value); // percentage of container height

        let barColor = '#e5e7eb';
        if (value >= 75) barColor = 'var(--primary)';
        else if (value >= 50) barColor = '#f59e0b';
        else if (value > 0) barColor = '#ef4444';

        const isToday = i === 0;
        html += `
            <div class="score-bar-col">
                <div class="score-bar-value">${value > 0 ? value : ''}</div>
                <div class="score-bar" style="height: ${height}%; background: ${barColor};${isToday ? ' box-shadow: 0 0 0 2px rgba(72,134,75,0.3);' : ''}"></div>
                <div class="score-bar-label" style="${isToday ? 'color: var(--primary); font-weight: 700;' : ''}">${dayName}</div>
            </div>
        `;
    }

    container.innerHTML = html;
}

// --- 9. Smart Meal Suggestions (on-the-fly) ---
function generateSmartSuggestions(dailyData) {
    const section = document.getElementById('smart-suggestions-section');
    const listEl = document.getElementById('suggestion-list');
    const subtitleEl = document.getElementById('smart-suggestions-subtitle');
    if (!section || !listEl) return;

    if (!dailyData || !dailyData.calorie_goal) { section.style.display = 'none'; return; }

    const calLeft = (dailyData.calorie_goal || 2000) - (dailyData.total_calories || 0);
    const proLeft = (dailyData.protein_goal_g || 50) - (dailyData.total_protein_g || 0);
    const carbLeft = (dailyData.carbs_goal_g || 250) - (dailyData.total_carbs_g || 0);
    const fatLeft = (dailyData.fat_goal_g || 70) - (dailyData.total_fat_g || 0);

    // Only show if there's meaningful gap
    if (calLeft < 100 && proLeft < 5) { section.style.display = 'none'; return; }

    // Get user's dietary preference
    const userDiet = getUserDietaryPreference();

    // Diet-aware food database
    // diet field: which diets can eat this ('all' = everyone, or specific diet keys)
    const allFoods = [
        // === Universal foods (all diets) ===
        { name: 'Oatmeal with Banana', emoji: '&#x1F35A;', cal: 300, pro: 8, carb: 55, fat: 6, diet: 'all' },
        { name: 'Sweet Potato (large)', emoji: '&#x1F360;', cal: 180, pro: 4, carb: 41, fat: 0, diet: 'all' },
        { name: 'Quinoa Bowl', emoji: '&#x1F35B;', cal: 320, pro: 12, carb: 50, fat: 8, diet: 'all' },
        { name: 'Brown Rice + Beans', emoji: '&#x1F35A;', cal: 350, pro: 14, carb: 60, fat: 4, diet: 'all' },
        { name: 'Banana + PB Toast', emoji: '&#x1F34C;', cal: 280, pro: 8, carb: 38, fat: 12, diet: 'all' },
        { name: 'Avocado Toast', emoji: '&#x1F951;', cal: 280, pro: 7, carb: 25, fat: 18, diet: 'all' },
        { name: 'Trail Mix (1/3 cup)', emoji: '&#x1F95C;', cal: 200, pro: 6, carb: 18, fat: 14, diet: 'all' },
        { name: 'Green Salad + Tahini', emoji: '&#x1F957;', cal: 150, pro: 5, carb: 12, fat: 10, diet: 'all' },
        { name: 'Veggie Soup', emoji: '&#x1F963;', cal: 120, pro: 4, carb: 18, fat: 3, diet: 'all' },
        { name: 'Fruit Bowl', emoji: '&#x1F353;', cal: 140, pro: 2, carb: 34, fat: 1, diet: 'all' },
        { name: 'Hummus + Veggies', emoji: '&#x1FAD8;', cal: 160, pro: 6, carb: 16, fat: 8, diet: 'all' },
        { name: 'Lentil Soup (1 bowl)', emoji: '&#x1F963;', cal: 230, pro: 18, carb: 40, fat: 1, diet: 'all' },
        { name: 'Chickpea Salad', emoji: '&#x1F957;', cal: 280, pro: 14, carb: 35, fat: 10, diet: 'all' },
        { name: 'Edamame (1 cup)', emoji: '&#x1FAD8;', cal: 190, pro: 17, carb: 14, fat: 8, diet: 'all' },
        { name: 'Black Bean Tacos (2)', emoji: '&#x1F32E;', cal: 340, pro: 16, carb: 42, fat: 12, diet: 'all' },

        // === Vegan / plant-based only ===
        { name: 'Tofu Scramble', emoji: '&#x1F95A;', cal: 220, pro: 18, carb: 8, fat: 14, diet: 'vegan,vegetarian,flexitarian,pescatarian' },
        { name: 'Tempeh Stir-Fry', emoji: '&#x1F372;', cal: 320, pro: 22, carb: 25, fat: 14, diet: 'vegan,vegetarian,flexitarian,pescatarian' },
        { name: 'Chia Pudding', emoji: '&#x1F366;', cal: 220, pro: 6, carb: 22, fat: 12, diet: 'vegan,vegetarian,flexitarian,pescatarian' },
        { name: 'Hemp Seed Bowl', emoji: '&#x1F331;', cal: 250, pro: 15, carb: 20, fat: 14, diet: 'vegan,vegetarian,flexitarian,pescatarian' },
        { name: 'Vegan Protein Smoothie', emoji: '&#x1F964;', cal: 280, pro: 25, carb: 35, fat: 6, diet: 'vegan,vegetarian,flexitarian' },

        // === Vegetarian (includes dairy/eggs) ===
        { name: 'Greek Yogurt + Granola', emoji: '&#x1F95B;', cal: 280, pro: 18, carb: 35, fat: 8, diet: 'vegetarian,flexitarian,pescatarian,omnivore' },
        { name: 'Scrambled Eggs (3)', emoji: '&#x1F373;', cal: 240, pro: 18, carb: 2, fat: 18, diet: 'vegetarian,flexitarian,pescatarian,omnivore' },
        { name: 'Cottage Cheese + Fruit', emoji: '&#x1F9C0;', cal: 200, pro: 20, carb: 16, fat: 5, diet: 'vegetarian,flexitarian,pescatarian,omnivore' },
        { name: 'Cheese Omelette', emoji: '&#x1F95A;', cal: 310, pro: 22, carb: 3, fat: 24, diet: 'vegetarian,flexitarian,pescatarian,omnivore' },
        { name: 'Whey Protein Shake', emoji: '&#x1F964;', cal: 250, pro: 30, carb: 15, fat: 4, diet: 'vegetarian,flexitarian,pescatarian,omnivore' },

        // === Pescatarian (fish + vegetarian) ===
        { name: 'Salmon Fillet (150g)', emoji: '&#x1F41F;', cal: 310, pro: 34, carb: 0, fat: 18, diet: 'pescatarian,flexitarian,omnivore' },
        { name: 'Tuna Salad', emoji: '&#x1F957;', cal: 260, pro: 28, carb: 8, fat: 12, diet: 'pescatarian,flexitarian,omnivore' },
        { name: 'Shrimp Stir-Fry', emoji: '&#x1F364;', cal: 280, pro: 26, carb: 18, fat: 10, diet: 'pescatarian,flexitarian,omnivore' },
        { name: 'Smoked Salmon Toast', emoji: '&#x1F363;', cal: 250, pro: 20, carb: 22, fat: 10, diet: 'pescatarian,flexitarian,omnivore' },

        // === Omnivore (everything) ===
        { name: 'Grilled Chicken Breast', emoji: '&#x1F357;', cal: 280, pro: 38, carb: 0, fat: 12, diet: 'omnivore,flexitarian' },
        { name: 'Turkey Mince Bowl', emoji: '&#x1F35B;', cal: 320, pro: 30, carb: 25, fat: 12, diet: 'omnivore,flexitarian' },
        { name: 'Steak + Sweet Potato', emoji: '&#x1F969;', cal: 450, pro: 40, carb: 35, fat: 16, diet: 'omnivore,flexitarian' },
        { name: 'Chicken Wrap', emoji: '&#x1F32F;', cal: 380, pro: 28, carb: 35, fat: 14, diet: 'omnivore,flexitarian' },
        { name: 'Beef Meatballs (5)', emoji: '&#x1F356;', cal: 350, pro: 28, carb: 12, fat: 22, diet: 'omnivore,flexitarian' },
        { name: 'Chicken + Rice Bowl', emoji: '&#x1F35B;', cal: 420, pro: 35, carb: 45, fat: 10, diet: 'omnivore,flexitarian' }
    ];

    // Filter foods based on user's dietary preference
    const foods = allFoods.filter(f => {
        if (f.diet === 'all') return true;
        if (!userDiet) return true; // No preference set, show everything
        return f.diet.split(',').includes(userDiet);
    });

    // Score each food by how well it fills gaps
    const scored = foods.map(f => {
        let score = 0;
        // Reward filling calorie gap without overshooting
        if (f.cal <= calLeft + 50) score += 20;
        else if (f.cal <= calLeft + 150) score += 5;
        else score -= 10;

        // Reward filling the biggest macro gap
        if (proLeft > 10 && f.pro >= 12) score += 30;
        if (proLeft > 5 && f.pro >= 8) score += 15;
        if (carbLeft > 20 && f.carb >= 25) score += 15;
        if (fatLeft > 10 && f.fat >= 10) score += 10;

        // Penalize if we'd overshoot a macro that's already met
        if (proLeft <= 0 && f.pro > 10) score -= 10;
        if (carbLeft <= 0 && f.carb > 20) score -= 10;
        if (fatLeft <= 0 && f.fat > 10) score -= 10;

        return { ...f, score };
    });

    scored.sort((a, b) => b.score - a.score);
    const top3 = scored.slice(0, 3);

    // Determine what's most needed
    let gapText = '';
    if (proLeft > 10 && calLeft > 200) gapText = `You need ~${Math.round(proLeft)}g protein and ${Math.round(calLeft)} cal`;
    else if (proLeft > 10) gapText = `Focus on protein — ${Math.round(proLeft)}g left to hit your goal`;
    else if (calLeft > 200) gapText = `${Math.round(calLeft)} calories left to reach your target`;
    else gapText = 'Fine-tune your macros with one of these';

    if (subtitleEl) subtitleEl.textContent = gapText;

    section.style.display = 'block';
    listEl.innerHTML = top3.map(f => {
        // Tag for the main benefit
        let tagText = 'Balanced';
        let tagBg = '#dbeafe';
        let tagColor = '#1e40af';
        if (f.pro >= 15) { tagText = 'High Protein'; tagBg = '#dcfce7'; tagColor = '#166534'; }
        else if (f.carb >= 35) { tagText = 'Carb Rich'; tagBg = '#fef3c7'; tagColor = '#92400e'; }
        else if (f.fat >= 12) { tagText = 'Healthy Fats'; tagBg = '#fce7f3'; tagColor = '#9d174d'; }

        return `
            <div class="suggestion-item">
                <div class="suggestion-emoji">${f.emoji}</div>
                <div class="suggestion-info">
                    <div class="suggestion-name">${f.name}</div>
                    <div class="suggestion-macros">${f.cal} cal | P: ${f.pro}g | C: ${f.carb}g | F: ${f.fat}g</div>
                </div>
                <span class="suggestion-tag" style="background: ${tagBg}; color: ${tagColor};">${tagText}</span>
            </div>
        `;
    }).join('');
}

// --- Water Goal Calculation (Onboarding Wizard) ---
let wizardWaterGoalMl = 2100;
let wizardGlassSize = 250;

function calculateWaterGoal(weightKg, activityLevel) {
    // Base: 33ml per kg body weight (standard hydration guideline)
    let baseWater = Math.round(weightKg * 33);

    // Activity level adjustment
    const activityBonus = {
        'sedentary': 0,
        'light': 250,
        'moderate': 500,
        'very': 750
    };
    baseWater += (activityBonus[activityLevel] || 0);

    // Round to nearest 50ml for cleaner numbers
    return Math.round(baseWater / 50) * 50;
}

function calculateAndDisplayWaterGoal() {
    // Pull user data from sessionStorage (already saved from slide 2)
    let userData = {};
    try { userData = JSON.parse(sessionStorage.getItem('userProfile') || '{}'); } catch(e) {}

    const weight = parseFloat(userData.weight) || 70;
    const activityLevel = userData.activity_level || 'sedentary';

    const recommended = calculateWaterGoal(weight, activityLevel);
    wizardWaterGoalMl = recommended;

    // Update display
    const recEl = document.getElementById('wizard-water-recommended');
    if (recEl) recEl.textContent = recommended.toLocaleString() + ' ml';

    const goalEl = document.getElementById('wizard-water-goal');
    if (goalEl) goalEl.textContent = recommended.toLocaleString();

    const hiddenEl = document.getElementById('wizard-water-goal-ml');
    if (hiddenEl) hiddenEl.value = recommended;

    // Update formula note
    const noteEl = document.getElementById('wizard-water-formula-note');
    if (noteEl) {
        const base = Math.round(weight * 33);
        const bonus = {'sedentary': 0, 'light': 250, 'moderate': 500, 'very': 750}[activityLevel] || 0;
        let note = `${weight}kg × 33ml = ${base.toLocaleString()}ml`;
        if (bonus > 0) note += ` + ${bonus}ml activity`;
        noteEl.textContent = note;
    }

    updateWizardGlassCount();
}

function adjustWaterGoal(delta) {
    wizardWaterGoalMl = Math.max(500, Math.min(5000, wizardWaterGoalMl + delta));

    const goalEl = document.getElementById('wizard-water-goal');
    if (goalEl) goalEl.textContent = wizardWaterGoalMl.toLocaleString();

    const hiddenEl = document.getElementById('wizard-water-goal-ml');
    if (hiddenEl) hiddenEl.value = wizardWaterGoalMl;

    updateWizardGlassCount();
}

function selectGlassSize(size) {
    wizardGlassSize = size;

    const hiddenEl = document.getElementById('wizard-glass-size');
    if (hiddenEl) hiddenEl.value = size;

    // Update button styles
    document.querySelectorAll('.glass-size-btn').forEach(btn => {
        const btnSize = parseInt(btn.dataset.size);
        if (btnSize === size) {
            btn.style.borderColor = '#0284c7';
            btn.style.background = '#e0f2fe';
            btn.style.color = '#0c4a6e';
            btn.classList.add('active');
        } else {
            btn.style.borderColor = '#e2e8f0';
            btn.style.background = 'white';
            btn.style.color = '#334155';
            btn.classList.remove('active');
        }
    });

    updateWizardGlassCount();
}

function updateWizardGlassCount() {
    const glasses = Math.ceil(wizardWaterGoalMl / wizardGlassSize);
    const countEl = document.getElementById('wizard-glass-count');
    if (countEl) countEl.textContent = glasses;
}

// --- 10. Hydration Tracker (Personalized Circular Design) ---
function getHydrationSettings() {
    const goalMl = parseInt(localStorage.getItem('pbb_water_goal_ml')) || 2000;
    const glassSize = parseInt(localStorage.getItem('pbb_water_glass_size')) || 250;
    const totalGlasses = parseInt(localStorage.getItem('pbb_water_total_glasses')) || Math.ceil(goalMl / glassSize);
    return { goalMl, glassSize, totalGlasses };
}

function initHydrationTracker() {
    const circleEl = document.getElementById('hydration-circle-fill');
    if (!circleEl) return;

    const today = getLocalDateString();
    const storageKey = `pbb_hydration_${today}`;
    let glasses = parseInt(localStorage.getItem(storageKey) || '0');

    // Update the goal display in the header
    const settings = getHydrationSettings();
    const headerEl = document.getElementById('hydration-goal-display');
    if (headerEl) headerEl.textContent = `Goal: ${settings.goalMl.toLocaleString()} ml`;

    const hintEl = document.getElementById('hydration-circle-hint');
    if (hintEl) hintEl.textContent = `Tap to add ${settings.glassSize}ml`;

    updateHydrationCircle(glasses);
}

function updateHydrationCircle(glasses) {
    const { goalMl, glassSize, totalGlasses } = getHydrationSettings();
    const circumference = 2 * Math.PI * 42; // ~264
    const progress = Math.min(glasses / totalGlasses, 1);
    const offset = circumference * (1 - progress);

    const circleEl = document.getElementById('hydration-circle-fill');
    if (circleEl) {
        circleEl.style.strokeDashoffset = offset;
        if (glasses >= totalGlasses) {
            circleEl.style.stroke = '#16a34a';
        } else {
            circleEl.style.stroke = '#0284c7';
        }
    }

    const countEl = document.getElementById('hydration-cup-count');
    if (countEl) countEl.textContent = `${glasses}/${totalGlasses}`;

    const labelEl = document.getElementById('hydration-circle-label');
    if (labelEl) {
        const ml = glasses * glassSize;
        labelEl.textContent = `${ml.toLocaleString()} / ${goalMl.toLocaleString()} ml`;
    }

    const cupSvg = document.getElementById('hydration-cup-svg');
    if (cupSvg) {
        cupSvg.style.fill = glasses >= totalGlasses ? '#16a34a' : '#0284c7';
    }
}

function addHydrationGlass() {
    const { totalGlasses } = getHydrationSettings();
    const today = getLocalDateString();
    const storageKey = `pbb_hydration_${today}`;
    let glasses = parseInt(localStorage.getItem(storageKey) || '0');

    if (glasses >= totalGlasses) {
        glasses = 0;
    } else {
        glasses++;
    }

    localStorage.setItem(storageKey, glasses.toString());
    updateHydrationCircle(glasses);

    // Ripple animation
    const wrap = document.getElementById('hydration-circle-tap');
    if (wrap) {
        wrap.classList.remove('hydration-ripple');
        void wrap.offsetWidth; // trigger reflow
        wrap.classList.add('hydration-ripple');
    }
}

// --- Weekly Trends Page ---
function openWeeklyTrendsPage() {
    const page = document.getElementById('weekly-trends-page');
    if (!page) return;

    page.classList.add('active');
    page.style.transform = 'translateX(100%)';
    page.style.transition = 'transform 0.3s ease-out';
    requestAnimationFrame(() => {
        page.style.transform = 'translateX(0)';
    });

    // Load data for the page
    Promise.allSettled([
        loadWeeklyMetrics(window.currentUser?.id),
        loadMultiWeekData(4),
        loadMealPatterns(),
        loadMealJournal(),
        loadAdaptiveAdjustment()
    ]);

}


function closeWeeklyTrendsPage() {
    const page = document.getElementById('weekly-trends-page');
    if (!page) return;

    // Close adaptive modal if open
    closeAdaptiveModal();

    // Ensure we return to the Nutrition tab
    const mealsBtn = document.querySelector('.bottom-nav .nav-item[onclick*="meals"]');
    if (mealsBtn) {
        switchAppTab('meals', mealsBtn);
    }

    page.style.transition = 'transform 0.3s ease-out';
    page.style.transform = 'translateX(100%)';
    setTimeout(() => {
        page.classList.remove('active');
        page.style.transform = '';
        page.style.transition = '';
    }, 300);
}

// --- Movement Weekly Trends Page ---

function openMovementWeeklyTrendsPage() {
    const page = document.getElementById('movement-weekly-trends-page');
    if (!page) return;

    // Ensure overlay is a direct child of body so it's never hidden by a parent container
    if (page.parentElement !== document.body) {
        document.body.appendChild(page);
    }

    page.classList.add('active');
    page.style.transform = 'translateX(100%)';
    page.style.transition = 'transform 0.3s ease-out';
    requestAnimationFrame(() => {
        page.style.transform = 'translateX(0)';
    });

    // Push navigation state for Android back button
    pushNavigationState('movement-weekly-trends-page', () => closeMovementWeeklyTrendsPage());

    // Load data for the page
    Promise.allSettled([
        loadMovementWeeklyMetrics(),
        loadMovementMultiWeekData(4),
        loadMovementWorkoutJournal(),
        loadMovementWorkoutPatterns()
    ]);
}

function closeMovementWeeklyTrendsPage() {
    const page = document.getElementById('movement-weekly-trends-page');
    if (!page) return;

    const movementBtn = document.querySelector('.bottom-nav .nav-item[onclick*="movement"]');
    if (movementBtn) {
        switchAppTab('movement-tab', movementBtn);
    }

    page.style.transition = 'transform 0.3s ease-out';
    page.style.transform = 'translateX(100%)';
    setTimeout(() => {
        page.classList.remove('active');
        page.style.transform = '';
        page.style.transition = '';
    }, 300);
}

async function loadMovementWeeklyMetrics() {
    try {
        if (!window.currentUser) return;
        const userId = window.currentUser.id;

        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);

        const startDate = getLocalDateString(sevenDaysAgo);
        const endDate = getLocalDateString(today);

        // Fetch workouts for last 7 days
        const [workoutsResult, activitiesResult] = await Promise.allSettled([
            window.supabaseClient
                .from('workouts')
                .select('workout_date, exercise_name, set_number, reps, weight_kg, time_duration')
                .eq('user_id', userId)
                .eq('workout_type', 'history')
                .gte('workout_date', startDate)
                .lte('workout_date', endDate)
                .order('workout_date', { ascending: true }),
            window.supabaseClient
                .from('activity_logs')
                .select('activity_date, activity_type, activity_label, duration_minutes, estimated_calories')
                .eq('user_id', userId)
                .gte('activity_date', startDate)
                .lte('activity_date', endDate)
                .order('activity_date', { ascending: true })
        ]);

        const workouts = workoutsResult.status === 'fulfilled' && !workoutsResult.value.error ? workoutsResult.value.data || [] : [];
        const activities = activitiesResult.status === 'fulfilled' && !activitiesResult.value.error ? activitiesResult.value.data || [] : [];

        // Calculate metrics
        const workoutDates = new Set();
        const exerciseNames = new Set();
        const allActiveDates = new Set();

        workouts.forEach(w => {
            if (w.workout_date) {
                workoutDates.add(w.workout_date);
                allActiveDates.add(w.workout_date);
            }
            if (w.exercise_name) exerciseNames.add(w.exercise_name);
        });

        activities.forEach(a => {
            if (a.activity_date) allActiveDates.add(a.activity_date);
        });

        const totalSessions = workoutDates.size + activities.length;
        const totalExercises = exerciseNames.size;
        const activeDays = allActiveDates.size;

        updateElement('mvmt-weekly-workouts', totalSessions);
        updateElement('mvmt-weekly-exercises', totalExercises);
        updateElement('mvmt-weekly-active-days', activeDays);

        // Build daily breakdown
        const breakdownContainer = document.getElementById('mvmt-weekly-daily-breakdown');
        if (breakdownContainer) {
            let html = '';
            for (let i = 6; i >= 0; i--) {
                const day = new Date(today);
                day.setDate(day.getDate() - i);
                const dateStr = getLocalDateString(day);
                const dayName = day.toLocaleDateString('en-US', { weekday: 'short' });

                const dayWorkouts = workouts.filter(w => w.workout_date === dateStr);
                const dayActivities = activities.filter(a => a.activity_date === dateStr);

                const dayExercises = [...new Set(dayWorkouts.map(w => w.exercise_name).filter(Boolean))];
                const dayActivityLabels = dayActivities.map(a => a.activity_label || a.activity_type).filter(Boolean);

                const hasActivity = dayWorkouts.length > 0 || dayActivities.length > 0;
                const totalSets = dayWorkouts.length;

                let rightLabel = 'Rest';
                if (totalSets > 0 && dayActivityLabels.length > 0) {
                    rightLabel = totalSets + ' sets + ' + dayActivityLabels[0];
                } else if (totalSets > 0) {
                    rightLabel = totalSets + ' sets';
                } else if (dayActivityLabels.length > 0) {
                    rightLabel = dayActivityLabels[0];
                }

                html += `
                    <div class="weekly-day-item">
                        <div class="weekly-day-header">
                            <span class="weekly-day-name">${dayName}</span>
                            <span class="weekly-day-calories">${rightLabel}</span>
                        </div>
                        <div class="progress-bar-small">
                            <div class="progress-fill" style="width: ${hasActivity ? '100' : '0'}%; background: ${hasActivity ? '#6366f1' : '#e5e7eb'};"></div>
                        </div>
                    </div>
                `;
            }
            breakdownContainer.innerHTML = html;
        }
    } catch (error) {
        console.error('Error in loadMovementWeeklyMetrics:', error);
    }
}

async function loadMovementMultiWeekData(numWeeks) {
    numWeeks = numWeeks || 4;
    try {
        if (!window.currentUser) return;
        const userId = window.currentUser.id;

        // Update nav buttons
        document.querySelectorAll('#mvmt-multi-week-nav button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.includes(numWeeks)) btn.classList.add('active');
        });

        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - (numWeeks * 7));
        const startDateStr = getLocalDateString(startDate);

        const [workoutsResult, activitiesResult] = await Promise.allSettled([
            window.supabaseClient
                .from('workouts')
                .select('workout_date, exercise_name, set_number, reps, weight_kg, time_duration')
                .eq('user_id', userId)
                .eq('workout_type', 'history')
                .gte('workout_date', startDateStr)
                .order('workout_date', { ascending: true }),
            window.supabaseClient
                .from('activity_logs')
                .select('activity_date, duration_minutes, estimated_calories')
                .eq('user_id', userId)
                .gte('activity_date', startDateStr)
                .order('activity_date', { ascending: true })
        ]);

        const workouts = workoutsResult.status === 'fulfilled' && !workoutsResult.value.error ? workoutsResult.value.data || [] : [];
        const activities = activitiesResult.status === 'fulfilled' && !activitiesResult.value.error ? activitiesResult.value.data || [] : [];

        // Group by week
        const weeks = [];
        for (let w = 0; w < numWeeks; w++) {
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - ((numWeeks - 1 - w) * 7 + 6));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            const weekStartStr = getLocalDateString(weekStart);
            const weekEndStr = getLocalDateString(weekEnd);

            const weekWorkouts = workouts.filter(d => d.workout_date >= weekStartStr && d.workout_date <= weekEndStr);
            const weekActivities = activities.filter(a => a.activity_date >= weekStartStr && a.activity_date <= weekEndStr);

            const workoutDateSet = new Set(weekWorkouts.map(r => r.workout_date).filter(Boolean));
            const activityDateSet = new Set(weekActivities.map(a => a.activity_date).filter(Boolean));
            const allDates = new Set([...workoutDateSet, ...activityDateSet]);

            const totalSets = weekWorkouts.length;
            const totalVolume = weekWorkouts.reduce((sum, r) => {
                return sum + ((parseFloat(r.weight_kg) || 0) * (parseInt(r.reps) || 0));
            }, 0);

            const activityMinutes = weekActivities.reduce((sum, a) => sum + (a.duration_minutes || 0), 0);
            const workoutMinutes = totalSets * 2;

            weeks.push({
                label: 'Wk ' + (w + 1),
                sessions: allDates.size,
                totalSets: totalSets,
                totalVolume: Math.round(totalVolume),
                activeMinutes: activityMinutes + workoutMinutes,
                activeDays: allDates.size
            });
        }

        renderMovementMultiWeekUI(weeks);
    } catch (err) {
        console.error('Error in loadMovementMultiWeekData:', err);
    }
}

function renderMovementMultiWeekUI(weeks) {
    const container = document.getElementById('mvmt-multi-week-sparklines');
    const compareGrid = document.getElementById('mvmt-week-compare-grid');
    if (!container) return;

    if (!weeks || weeks.length === 0 || weeks.every(w => w.sessions === 0)) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px 0; font-size: 0.85rem;">Log workouts for at least 2 weeks to see trends</p>';
        if (compareGrid) compareGrid.innerHTML = '';
        return;
    }

    const metrics = [
        { key: 'sessions', label: 'Sessions', color: '#6366f1', suffix: '' },
        { key: 'totalSets', label: 'Sets', color: '#3b82f6', suffix: '' },
        { key: 'totalVolume', label: 'Volume', color: '#f59e0b', suffix: 'kg' },
        { key: 'activeMinutes', label: 'Minutes', color: '#ef4444', suffix: '' }
    ];

    let html = '';
    metrics.forEach(metric => {
        const values = weeks.map(w => w[metric.key]);
        const max = Math.max(...values, 1);
        const minPositive = values.filter(v => v > 0);
        const min = minPositive.length > 0 ? Math.min(...minPositive) : 0;
        const current = values[values.length - 1];
        const previous = values.length >= 2 ? values[values.length - 2] : current;

        let trendClass = 'neutral';
        let trendText = '--';
        if (previous > 0 && current > 0) {
            const pctChange = Math.round(((current - previous) / previous) * 100);
            if (pctChange > 2) { trendClass = 'up'; trendText = '+' + pctChange + '%'; }
            else if (pctChange < -2) { trendClass = 'down'; trendText = pctChange + '%'; }
            else { trendText = '~0%'; }
        }

        const svgWidth = 120;
        const svgHeight = 30;
        const padding = 4;
        const points = values.map((v, i) => {
            const x = padding + (i / (values.length - 1 || 1)) * (svgWidth - padding * 2);
            const y = max > min ? svgHeight - padding - ((v - min) / (max - min)) * (svgHeight - padding * 2) : svgHeight / 2;
            return x + ',' + y;
        }).join(' ');

        const displayValue = metric.key === 'totalVolume' && current >= 1000
            ? (Math.round(current / 100) / 10) + 'k'
            : current;

        html += '<div class="sparkline-row">';
        html += '<div class="sparkline-label">' + metric.label + '</div>';
        html += '<svg class="sparkline-svg" viewBox="0 0 ' + svgWidth + ' ' + svgHeight + '">';
        html += '<polyline points="' + points + '" fill="none" stroke="' + metric.color + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
        values.forEach((v, i) => {
            const x = padding + (i / (values.length - 1 || 1)) * (svgWidth - padding * 2);
            const y = max > min ? svgHeight - padding - ((v - min) / (max - min)) * (svgHeight - padding * 2) : svgHeight / 2;
            html += '<circle cx="' + x + '" cy="' + y + '" r="3" fill="' + metric.color + '" opacity="' + (i === values.length - 1 ? 1 : 0.4) + '"/>';
        });
        html += '</svg>';
        html += '<div class="sparkline-value">' + displayValue + metric.suffix + '</div>';
        html += '<div class="sparkline-trend ' + trendClass + '">' + trendText + '</div>';
        html += '</div>';
    });

    container.innerHTML = html;

    if (compareGrid && weeks.length >= 2) {
        const thisWeek = weeks[weeks.length - 1];
        const lastWeek = weeks[weeks.length - 2];

        compareGrid.innerHTML = ''
            + '<div class="week-compare-stat">'
            + '    <div class="stat-value">' + thisWeek.sessions + '</div>'
            + '    <div class="stat-label">Sessions (This Week)</div>'
            + '</div>'
            + '<div class="week-compare-stat">'
            + '    <div class="stat-value">' + lastWeek.sessions + '</div>'
            + '    <div class="stat-label">Sessions (Last Week)</div>'
            + '</div>'
            + '<div class="week-compare-stat">'
            + '    <div class="stat-value">' + thisWeek.activeDays + '/7</div>'
            + '    <div class="stat-label">Active Days (This Week)</div>'
            + '</div>'
            + '<div class="week-compare-stat">'
            + '    <div class="stat-value">' + lastWeek.activeDays + '/7</div>'
            + '    <div class="stat-label">Active Days (Last Week)</div>'
            + '</div>';
    }
}

async function loadMovementWorkoutJournal() {
    try {
        if (!window.currentUser) return;
        const userId = window.currentUser.id;

        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
        const startDate = getLocalDateString(sevenDaysAgo);
        const endDate = getLocalDateString(today);

        const [workoutsResult, activitiesResult] = await Promise.allSettled([
            window.supabaseClient
                .from('workouts')
                .select('workout_date, exercise_name, set_number, reps, weight_kg')
                .eq('user_id', userId)
                .eq('workout_type', 'history')
                .gte('workout_date', startDate)
                .lte('workout_date', endDate)
                .order('workout_date', { ascending: false }),
            window.supabaseClient
                .from('activity_logs')
                .select('activity_date, activity_type, activity_label, duration_minutes, estimated_calories')
                .eq('user_id', userId)
                .gte('activity_date', startDate)
                .lte('activity_date', endDate)
                .order('activity_date', { ascending: false })
        ]);

        const workouts = workoutsResult.status === 'fulfilled' && !workoutsResult.value.error ? workoutsResult.value.data || [] : [];
        const activities = activitiesResult.status === 'fulfilled' && !activitiesResult.value.error ? activitiesResult.value.data || [] : [];

        const container = document.getElementById('mvmt-workout-journal-timeline');
        if (!container) return;

        // Group by date
        const byDate = {};
        workouts.forEach(w => {
            if (!w.workout_date) return;
            if (!byDate[w.workout_date]) byDate[w.workout_date] = { exercises: {}, activities: [] };
            if (!byDate[w.workout_date].exercises[w.exercise_name]) {
                byDate[w.workout_date].exercises[w.exercise_name] = { name: w.exercise_name, sets: 0, bestWeight: 0, bestReps: 0 };
            }
            var ex = byDate[w.workout_date].exercises[w.exercise_name];
            ex.sets++;
            var weight = parseFloat(w.weight_kg) || 0;
            var reps = parseInt(w.reps) || 0;
            if (weight > ex.bestWeight) { ex.bestWeight = weight; ex.bestReps = reps; }
            else if (weight === ex.bestWeight && reps > ex.bestReps) { ex.bestReps = reps; }
        });

        activities.forEach(a => {
            if (!a.activity_date) return;
            if (!byDate[a.activity_date]) byDate[a.activity_date] = { exercises: {}, activities: [] };
            byDate[a.activity_date].activities.push(a);
        });

        var dates = Object.keys(byDate).sort(function(a, b) { return new Date(b) - new Date(a); });

        if (dates.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">No workouts logged this week</p>';
            return;
        }

        var html = '';
        dates.forEach(function(dateStr) {
            var date = new Date(dateStr + 'T12:00:00');
            var dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            var dayNum = date.getDate();
            var dayData = byDate[dateStr];
            var exercises = Object.values(dayData.exercises);
            var acts = dayData.activities;

            var detailsHtml = '';
            exercises.forEach(function(ex) {
                var weightInfo = ex.bestWeight > 0 ? ex.bestWeight + 'kg x ' + ex.bestReps : ex.bestReps + ' reps';
                detailsHtml += '<div style="background: #ededff; color: #4338ca; padding: 6px 12px; border-radius: 10px; font-size: 0.8rem; font-weight: 600;">'
                    + ex.name + ' <span style="opacity:0.6; font-weight: 500;">(' + ex.sets + 's · ' + weightInfo + ')</span></div>';
            });

            acts.forEach(function(a) {
                var label = a.activity_label || a.activity_type;
                var mins = a.duration_minutes ? a.duration_minutes + 'min' : '';
                detailsHtml += '<div style="background: #ecfdf5; color: #16a34a; padding: 6px 12px; border-radius: 10px; font-size: 0.8rem; font-weight: 600;">'
                    + label + ' <span style="opacity:0.6; font-weight: 500;">' + mins + '</span></div>';
            });

            var totalSets = exercises.reduce(function(s, e) { return s + e.sets; }, 0);
            var totalExercises = exercises.length;
            var summaryParts = [];
            if (totalExercises > 0) summaryParts.push(totalExercises + ' exercise' + (totalExercises !== 1 ? 's' : '') + ' · ' + totalSets + ' sets');
            if (acts.length > 0) summaryParts.push(acts.length + ' activit' + (acts.length !== 1 ? 'ies' : 'y'));

            html += '<div style="background: #fafafa; border-radius: 12px; padding: 14px 16px; border: 1px solid #f0f0f0;">'
                + '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">'
                + '    <div style="background: #6366f1; color: white; width: 42px; height: 42px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0;">'
                + '        <div style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase; line-height: 1; opacity: 0.9;">' + dayName + '</div>'
                + '        <div style="font-size: 1.1rem; font-weight: 800; line-height: 1.1;">' + dayNum + '</div>'
                + '    </div>'
                + '    <div style="flex: 1; font-size: 0.82rem; color: var(--text-muted); font-weight: 600;">' + summaryParts.join(' · ') + '</div>'
                + '</div>'
                + '<div style="display: flex; flex-wrap: wrap; gap: 6px;">'
                + detailsHtml
                + '</div>'
                + '</div>';
        });

        container.innerHTML = html;
    } catch (error) {
        console.error('Error in loadMovementWorkoutJournal:', error);
    }
}

async function loadMovementWorkoutPatterns() {
    try {
        if (!window.currentUser) return;
        var userId = window.currentUser.id;

        var today = new Date();
        var sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
        var startDate = getLocalDateString(sevenDaysAgo);
        var endDate = getLocalDateString(today);

        var [workoutsResult, activitiesResult] = await Promise.allSettled([
            window.supabaseClient
                .from('workouts')
                .select('workout_date, exercise_name, reps, weight_kg, set_number')
                .eq('user_id', userId)
                .eq('workout_type', 'history')
                .gte('workout_date', startDate)
                .lte('workout_date', endDate)
                .order('workout_date', { ascending: true }),
            window.supabaseClient
                .from('activity_logs')
                .select('activity_date, activity_type, duration_minutes')
                .eq('user_id', userId)
                .gte('activity_date', startDate)
                .lte('activity_date', endDate)
                .order('activity_date', { ascending: true })
        ]);

        var workouts = workoutsResult.status === 'fulfilled' && !workoutsResult.value.error ? workoutsResult.value.data || [] : [];
        var activities = activitiesResult.status === 'fulfilled' && !activitiesResult.value.error ? activitiesResult.value.data || [] : [];

        var insights = analyzeMovementPatterns(workouts, activities, today);
        renderMovementPatternInsights(insights);
    } catch (error) {
        console.error('Error in loadMovementWorkoutPatterns:', error);
    }
}

function analyzeMovementPatterns(workouts, activities, today) {
    var insights = [];

    var workoutDates = new Set(workouts.map(function(w) { return w.workout_date; }).filter(Boolean));
    var activityDates = new Set(activities.map(function(a) { return a.activity_date; }).filter(Boolean));
    var allDates = new Set([...workoutDates, ...activityDates]);

    if (allDates.size === 0) return insights;

    // 1. Training frequency
    var activeDays = allDates.size;
    var restDays = 7 - activeDays;
    if (activeDays >= 6) {
        insights.push({ icon: '⚡', text: 'You trained <strong>' + activeDays + ' out of 7 days</strong> this week. Consider adding a rest day for recovery.' });
    } else if (activeDays >= 4) {
        insights.push({ icon: '💪', text: '<strong>' + activeDays + ' active days</strong> this week with <strong>' + restDays + ' rest days</strong>. Great balance of training and recovery!' });
    } else if (activeDays >= 1) {
        insights.push({ icon: '📈', text: '<strong>' + activeDays + ' active day' + (activeDays !== 1 ? 's' : '') + '</strong> this week. Try to aim for 3-4 sessions for consistent progress.' });
    }

    // 2. Exercise variety
    var uniqueExercises = new Set(workouts.map(function(w) { return w.exercise_name; }).filter(Boolean));
    if (uniqueExercises.size >= 8) {
        insights.push({ icon: '🎯', text: '<strong>' + uniqueExercises.size + ' different exercises</strong> this week. Excellent variety across muscle groups!' });
    } else if (uniqueExercises.size >= 4) {
        insights.push({ icon: '🔄', text: '<strong>' + uniqueExercises.size + ' exercises</strong> in your rotation. Consider mixing in new movements for balanced development.' });
    } else if (uniqueExercises.size >= 1) {
        insights.push({ icon: '🎯', text: 'Only <strong>' + uniqueExercises.size + ' exercise' + (uniqueExercises.size !== 1 ? 's' : '') + '</strong> this week. Adding variety can help prevent plateaus.' });
    }

    // 3. Volume check
    var totalSets = workouts.length;
    var totalVolume = workouts.reduce(function(sum, w) {
        return sum + ((parseFloat(w.weight_kg) || 0) * (parseInt(w.reps) || 0));
    }, 0);
    if (totalVolume > 0) {
        var avgVolumePerSession = workoutDates.size > 0 ? Math.round(totalVolume / workoutDates.size) : 0;
        var volDisplay = totalVolume >= 1000 ? (Math.round(totalVolume / 100) / 10) + 'k' : totalVolume;
        insights.push({ icon: '🏋️', text: 'Total volume: <strong>' + volDisplay + ' kg</strong> across <strong>' + totalSets + ' sets</strong>.' + (avgVolumePerSession > 0 ? ' Averaging ' + avgVolumePerSession + ' kg per session.' : '') });
    }

    // 4. Consecutive rest days warning
    var maxConsecutiveRest = 0;
    var currentRestStreak = 0;
    for (var i = 6; i >= 0; i--) {
        var day = new Date(today);
        day.setDate(day.getDate() - i);
        var dateStr = getLocalDateString(day);
        if (allDates.has(dateStr)) {
            currentRestStreak = 0;
        } else {
            currentRestStreak++;
            maxConsecutiveRest = Math.max(maxConsecutiveRest, currentRestStreak);
        }
    }
    if (maxConsecutiveRest >= 3) {
        insights.push({ icon: '⏰', text: '<strong>' + maxConsecutiveRest + ' consecutive rest days</strong> detected. A short walk or stretch session can help maintain momentum.' });
    }

    // 5. Activity mix
    if (activities.length > 0 && workoutDates.size > 0) {
        insights.push({ icon: '🌟', text: 'Nice mix of <strong>structured workouts</strong> and <strong>activities</strong> this week. Cross-training supports overall fitness.' });
    }

    return insights.slice(0, 4);
}

function renderMovementPatternInsights(insights) {
    var container = document.getElementById('mvmt-workout-pattern-insights');
    if (!container) return;

    if (!insights || insights.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Log more workouts to see patterns</p>';
        return;
    }

    var html = '';
    insights.forEach(function(insight) {
        html += '<div class="pattern-insight">'
            + '<div class="pattern-icon">' + insight.icon + '</div>'
            + '<div class="pattern-text">' + insight.text + '</div>'
            + '</div>';
    });
    container.innerHTML = html;
}

// --- 11. Macro Ratio Pie Chart ---
function updateMacroPieChart(dailyData) {
    const svg = document.getElementById('macro-pie-svg');
    const legend = document.getElementById('macro-pie-legend');
    if (!svg) return;

    const protein = dailyData?.total_protein_g || 0;
    const carbs = dailyData?.total_carbs_g || 0;
    const fat = dailyData?.total_fat_g || 0;

    // Convert to calories for ratio
    const proCal = protein * 4;
    const carbCal = carbs * 4;
    const fatCal = fat * 9;
    const totalCal = proCal + carbCal + fatCal;

    if (totalCal === 0) {
        svg.innerHTML = '<circle cx="60" cy="60" r="50" fill="#f3f4f6" stroke="none"/><text x="60" y="63" text-anchor="middle" font-size="10" fill="#9ca3af">No data</text>';
        return;
    }

    const proPct = Math.round((proCal / totalCal) * 100);
    const carbPct = Math.round((carbCal / totalCal) * 100);
    const fatPct = 100 - proPct - carbPct;

    // Build donut segments
    const segments = [
        { pct: proPct, color: '#3b82f6' },
        { pct: carbPct, color: '#f59e0b' },
        { pct: fatPct, color: '#ef4444' }
    ];

    const radius = 50;
    const cx = 60, cy = 60;
    const circumference = 2 * Math.PI * radius;
    let accumulatedOffset = 0;
    let svgContent = '';

    segments.forEach(seg => {
        const dashLen = (seg.pct / 100) * circumference;
        const dashGap = circumference - dashLen;
        const rotation = (accumulatedOffset / 100) * 360 - 90;
        svgContent += `<circle cx="${cx}" cy="${cy}" r="${radius}" fill="none" stroke="${seg.color}" stroke-width="20"
            stroke-dasharray="${dashLen} ${dashGap}"
            transform="rotate(${rotation} ${cx} ${cy})"/>`;
        accumulatedOffset += seg.pct;
    });

    // Inner white circle for donut hole
    svgContent += `<circle cx="${cx}" cy="${cy}" r="32" fill="white"/>`;
    // Center text
    svgContent += `<text x="${cx}" y="${cy - 4}" text-anchor="middle" font-size="10" font-weight="700" fill="var(--text-main)">${Math.round(totalCal)}</text>`;
    svgContent += `<text x="${cx}" y="${cy + 8}" text-anchor="middle" font-size="7" fill="var(--text-muted)">cal</text>`;

    svg.innerHTML = svgContent;

    // Update legend with target comparison
    if (legend) {
        const goalPro = dailyData?.protein_goal_g || 50;
        const goalCarb = dailyData?.carbs_goal_g || 250;
        const goalFat = dailyData?.fat_goal_g || 70;
        const goalProCal = goalPro * 4;
        const goalCarbCal = goalCarb * 4;
        const goalFatCal = goalFat * 9;
        const goalTotal = goalProCal + goalCarbCal + goalFatCal;
        const goalProPct = goalTotal > 0 ? Math.round((goalProCal / goalTotal) * 100) : 0;
        const goalCarbPct = goalTotal > 0 ? Math.round((goalCarbCal / goalTotal) * 100) : 0;
        const goalFatPct = goalTotal > 0 ? 100 - goalProPct - goalCarbPct : 0;

        legend.innerHTML = `
            <div class="macro-pie-legend-item"><span class="macro-legend-dot" style="background: #3b82f6;"></span><span class="macro-legend-label">Protein</span><span class="macro-legend-value">${proPct}% <span style="font-weight:400;color:var(--text-muted);font-size:0.72rem;">(goal ${goalProPct}%)</span></span></div>
            <div class="macro-pie-legend-item"><span class="macro-legend-dot" style="background: #f59e0b;"></span><span class="macro-legend-label">Carbs</span><span class="macro-legend-value">${carbPct}% <span style="font-weight:400;color:var(--text-muted);font-size:0.72rem;">(goal ${goalCarbPct}%)</span></span></div>
            <div class="macro-pie-legend-item"><span class="macro-legend-dot" style="background: #ef4444;"></span><span class="macro-legend-label">Fat</span><span class="macro-legend-value">${fatPct}% <span style="font-weight:400;color:var(--text-muted);font-size:0.72rem;">(goal ${goalFatPct}%)</span></span></div>
        `;
    }
}

// --- 12. Meal Prep Score ---
async function loadMealPrepScore() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);

        const { data: meals, error } = await window.supabaseClient
            .from('meal_logs')
            .select('meal_date, meal_type, photo_url, food_items, ai_confidence')
            .eq('user_id', session.user.id)
            .gte('meal_date', getLocalDateString(sevenDaysAgo))
            .order('meal_date', { ascending: true });

        if (error) { console.error('Error loading meal prep data:', error); return; }
        renderMealPrepScore(meals || []);
    } catch (err) {
        console.error('Error in loadMealPrepScore:', err);
    }
}

function renderMealPrepScore(meals) {
    const circleEl = document.getElementById('prep-score-circle');
    const valueEl = document.getElementById('prep-score-value');
    const labelEl = document.getElementById('prep-score-label');
    const statsEl = document.getElementById('prep-stats');

    if (!meals || meals.length === 0) {
        if (valueEl) valueEl.textContent = '--';
        if (statsEl) statsEl.innerHTML = '<div class="prep-stat"><div class="prep-stat-value">0</div><div class="prep-stat-label">Total Meals</div></div>';
        return;
    }

    // Classify meals as home-cooked vs dining out
    // Home-cooked: has photo with high/medium confidence, or text-input meals
    // Dining out: meal type contains "dining" or food_items suggest restaurant
    let homeMeals = 0;
    let diningMeals = 0;

    meals.forEach(m => {
        const items = Array.isArray(m.food_items) ? m.food_items : [];
        const isDining = items.some(i =>
            (i.name || '').toLowerCase().match(/restaurant|takeout|take-out|delivery|uber|doordash|fast food|mcdonald|burger king|subway|starbucks|pizza hut|chipotle|panda express/)
        );
        if (isDining) diningMeals++;
        else homeMeals++;
    });

    const total = meals.length;
    const score = total > 0 ? Math.round((homeMeals / total) * 100) : 0;

    if (valueEl) valueEl.textContent = score;
    if (circleEl) {
        const circumference = 2 * Math.PI * 38;
        const offset = circumference * (1 - score / 100);
        circleEl.style.strokeDashoffset = offset;
    }
    if (labelEl) {
        if (score >= 80) labelEl.textContent = 'Amazing prep consistency!';
        else if (score >= 60) labelEl.textContent = 'Solid home cooking habit';
        else if (score >= 40) labelEl.textContent = 'Room to cook more at home';
        else labelEl.textContent = 'Try prepping a few meals this week';
    }

    // Group by day
    const daySet = new Set(meals.map(m => m.meal_date));

    if (statsEl) {
        statsEl.innerHTML = `
            <div class="prep-stat"><div class="prep-stat-value">${homeMeals}</div><div class="prep-stat-label">Home Meals</div></div>
            <div class="prep-stat"><div class="prep-stat-value">${diningMeals}</div><div class="prep-stat-label">Dining Out</div></div>
            <div class="prep-stat"><div class="prep-stat-value">${daySet.size}/7</div><div class="prep-stat-label">Days Active</div></div>
        `;
    }
}

// --- 13. Nutrition Badges ---
async function loadNutritionBadges() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        const userId = session.user.id;
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        // Get daily nutrition for last 30 days
        const { data: days, error } = await window.supabaseClient
            .from('daily_nutrition')
            .select('nutrition_date, total_calories, total_protein_g, total_carbs_g, total_fat_g, calorie_goal, protein_goal_g, carbs_goal_g, fat_goal_g')
            .eq('user_id', userId)
            .gte('nutrition_date', getLocalDateString(thirtyDaysAgo))
            .order('nutrition_date', { ascending: true });

        if (error) { console.error('Error loading badge data:', error); return; }

        // Get meal count
        const { count: mealCount } = await window.supabaseClient
            .from('meal_logs')
            .select('id', { count: 'exact', head: true })
            .eq('user_id', userId);

        // Get micronutrient data
        const { data: mealMicros } = await window.supabaseClient
            .from('meal_logs')
            .select('meal_date, micronutrients')
            .eq('user_id', userId)
            .gte('meal_date', getLocalDateString(thirtyDaysAgo));

        renderNutritionBadges(days || [], mealCount || 0, mealMicros || []);
    } catch (err) {
        console.error('Error in loadNutritionBadges:', err);
    }
}

function renderNutritionBadges(days, mealCount, mealMicros) {
    const grid = document.getElementById('badges-grid');
    if (!grid) return;

    // Calculate streaks and achievements
    let proteinStreak = 0;
    let maxProteinStreak = 0;
    let balancedStreak = 0;
    let maxBalancedStreak = 0;
    let loggingStreak = 0;
    let maxLoggingStreak = 0;

    // Iron tracking
    let ironDays = 0;
    const ironByDate = {};
    (mealMicros || []).forEach(m => {
        if (m.micronutrients && m.micronutrients.iron) {
            ironByDate[m.meal_date] = (ironByDate[m.meal_date] || 0) + m.micronutrients.iron;
        }
    });
    Object.values(ironByDate).forEach(v => { if (v >= 14) ironDays++; }); // ~80% RDA

    const sortedDays = [...days].sort((a, b) => a.nutrition_date.localeCompare(b.nutrition_date));

    sortedDays.forEach(d => {
        if (d.total_calories > 0) {
            loggingStreak++;
            maxLoggingStreak = Math.max(maxLoggingStreak, loggingStreak);
        } else {
            loggingStreak = 0;
        }

        const proGoal = d.protein_goal_g || 50;
        if (d.total_protein_g >= proGoal * 0.9) {
            proteinStreak++;
            maxProteinStreak = Math.max(maxProteinStreak, proteinStreak);
        } else {
            proteinStreak = 0;
        }

        // Balanced = all macros within 15%
        const calOk = d.calorie_goal > 0 && Math.abs(d.total_calories - d.calorie_goal) / d.calorie_goal < 0.15;
        const proOk = proGoal > 0 && Math.abs(d.total_protein_g - proGoal) / proGoal < 0.15;
        const carbGoal = d.carbs_goal_g || 250;
        const carbOk = carbGoal > 0 && Math.abs(d.total_carbs_g - carbGoal) / carbGoal < 0.15;
        if (calOk && proOk && carbOk) {
            balancedStreak++;
            maxBalancedStreak = Math.max(maxBalancedStreak, balancedStreak);
        } else {
            balancedStreak = 0;
        }
    });

    // Define badges
    const badges = [
        { icon: '&#x1F525;', name: 'First Flame', desc: 'Log meals 3 days in a row', target: 3, current: maxLoggingStreak, earned: maxLoggingStreak >= 3 },
        { icon: '&#x1F4AA;', name: 'Protein Pro', desc: 'Hit protein goal 7 days', target: 7, current: maxProteinStreak, earned: maxProteinStreak >= 7 },
        { icon: '&#x2696;&#xFE0F;', name: 'Balanced Week', desc: 'All macros within 15% for 7 days', target: 7, current: maxBalancedStreak, earned: maxBalancedStreak >= 7 },
        { icon: '&#x1FA78;', name: 'Iron Warrior', desc: 'Hit iron RDA 7 days', target: 7, current: ironDays, earned: ironDays >= 7 },
        { icon: '&#x1F4F8;', name: 'Snap Happy', desc: 'Log 50 meals', target: 50, current: Math.min(mealCount, 50), earned: mealCount >= 50 },
        { icon: '&#x1F451;', name: 'Legend', desc: 'Log meals 30 days straight', target: 30, current: maxLoggingStreak, earned: maxLoggingStreak >= 30 }
    ];

    grid.innerHTML = badges.map(b => {
        const progress = b.target > 0 ? Math.min(100, Math.round((b.current / b.target) * 100)) : 0;
        const stateClass = b.earned ? 'earned' : (b.current > 0 ? '' : 'locked');
        return `
            <div class="badge-item ${stateClass}">
                <div class="badge-icon">${b.earned ? b.icon : '&#x1F512;'}</div>
                <div class="badge-name">${b.name}</div>
                <div class="badge-progress">${b.earned ? 'Earned!' : `${b.current}/${b.target}`}</div>
            </div>
        `;
    }).join('');
}

// --- 14. Social Meal Comparison ---
async function loadSocialComparison() {
    try {
        const session = await window.authHelpers?.getSession();
        if (!session?.user) return;

        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);

        // Get this user's averages
        const { data: myDays, error } = await window.supabaseClient
            .from('daily_nutrition')
            .select('total_calories, total_protein_g, total_carbs_g, total_fat_g, calorie_goal')
            .eq('user_id', session.user.id)
            .gte('nutrition_date', getLocalDateString(sevenDaysAgo));

        if (error) { console.error('Error loading social comparison:', error); return; }

        const myData = (myDays || []).filter(d => d.total_calories > 0);
        if (myData.length < 2) {
            const container = document.getElementById('social-compare-content');
            if (container) container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Log at least 2 days to see how you compare</p>';
            return;
        }

        const myAvgCal = Math.round(myData.reduce((s, d) => s + d.total_calories, 0) / myData.length);
        const myAvgPro = Math.round(myData.reduce((s, d) => s + d.total_protein_g, 0) / myData.length);
        const myGoal = myData[0]?.calorie_goal || 2000;
        const myConsistency = myData.length; // Days logged out of 7

        // Get anonymized community averages (all users, last 7 days)
        const { data: communityData, error: commError } = await window.supabaseClient
            .from('daily_nutrition')
            .select('total_calories, total_protein_g')
            .gte('nutrition_date', getLocalDateString(sevenDaysAgo))
            .gt('total_calories', 0);

        if (commError) {
            console.error('Error loading community data:', commError);
            renderSocialFallback(myAvgCal, myAvgPro, myConsistency);
            return;
        }

        const community = communityData || [];
        if (community.length < 5) {
            renderSocialFallback(myAvgCal, myAvgPro, myConsistency);
            return;
        }

        // Calculate percentiles
        const allCals = community.map(d => d.total_calories).sort((a, b) => a - b);
        const allPro = community.map(d => d.total_protein_g).sort((a, b) => a - b);

        const calPercentile = Math.round((allCals.filter(c => c <= myAvgCal).length / allCals.length) * 100);
        const proPercentile = Math.round((allPro.filter(p => p <= myAvgPro).length / allPro.length) * 100);
        const consistencyPercentile = Math.min(100, Math.round((myConsistency / 7) * 100));

        // Goal adherence
        const goalAdherence = myGoal > 0 ? Math.round((1 - Math.abs(myAvgCal - myGoal) / myGoal) * 100) : 50;

        renderSocialComparison(proPercentile, consistencyPercentile, goalAdherence);
    } catch (err) {
        console.error('Error in loadSocialComparison:', err);
    }
}

function renderSocialFallback(avgCal, avgPro, consistency) {
    // Fallback when not enough community data — show personal stats as percentile estimates
    const proPercentile = Math.min(95, Math.max(20, Math.round(avgPro / 0.8)));
    const consistencyPercentile = Math.round((consistency / 7) * 100);
    const goalPercentile = 50;
    renderSocialComparison(proPercentile, consistencyPercentile, goalPercentile);
}

function renderSocialComparison(proteinPct, consistencyPct, goalPct) {
    const container = document.getElementById('social-compare-content');
    if (!container) return;

    const stats = [
        { label: 'Protein', pct: Math.min(99, Math.max(1, proteinPct)), desc: 'intake vs community' },
        { label: 'Logging', pct: Math.min(99, Math.max(1, consistencyPct)), desc: 'consistency' },
        { label: 'On Goal', pct: Math.min(99, Math.max(1, goalPct)), desc: 'adherence' }
    ];

    container.innerHTML = stats.map(s => `
        <div class="social-stat-row">
            <div class="social-stat-label">${s.label}</div>
            <div class="social-bar-bg"><div class="social-bar-fill" style="width: ${s.pct}%;"></div></div>
            <div class="social-percentile">Top ${100 - s.pct}%</div>
        </div>
    `).join('') + '<p style="text-align: center; font-size: 0.68rem; color: #9333ea; margin: 10px 0 0 0;">Based on anonymous, aggregated data from all users</p>';
}

// --- Master function to load all enhanced nutrition features ---
async function loadEnhancedNutritionFeatures() {
    try {
        // Load features in parallel for speed
        // Weekly trends, meal patterns, meal journal are now loaded on-demand from Weekly Trends page
        await Promise.allSettled([
            loadStreakData(),
            loadMicronutrientInsights()
        ]);
        // Synchronous features (use already-loaded data)
        loadCycleNutritionTips();
        initHydrationTracker();
    } catch (err) {
        console.error('Error loading enhanced nutrition features:', err);
    }
}

// Update nutrition UI with data
function updateNutritionUI(dailyData, mealsData) {
    const defaults = {
        total_calories: 0,
        total_protein_g: 0,
        total_carbs_g: 0,
        total_fat_g: 0,
        total_fiber_g: 0,
        calorie_goal: 2000,
        protein_goal_g: 50,
        carbs_goal_g: 250,
        fat_goal_g: 70
    };

    const data = dailyData || defaults;

    // Update widget (dashboard)
    updateElement('widget-calories-current', Math.round(data.total_calories || 0));
    updateElement('widget-calories-goal', data.calorie_goal || 2000);
    updateElement('widget-protein', Math.round(data.total_protein_g || 0));
    updateElement('widget-protein-goal', data.protein_goal_g || 50);
    updateElement('widget-carbs', Math.round(data.total_carbs_g || 0));
    updateElement('widget-carbs-goal', data.carbs_goal_g || 250);
    updateElement('widget-fat', Math.round(data.total_fat_g || 0));
    updateElement('widget-fat-goal', data.fat_goal_g || 70);

    // Update progress bars (widget)
    updateProgressBar('widget-calories-bar', data.total_calories, data.calorie_goal || 2000);
    updateProgressBar('widget-protein-bar', data.total_protein_g, data.protein_goal_g || 50);
    updateProgressBar('widget-carbs-bar', data.total_carbs_g, data.carbs_goal_g || 250);
    updateProgressBar('widget-fat-bar', data.total_fat_g, data.fat_goal_g || 70);

    // Update tracker (full view)
    updateElement('tracker-calories-current', Math.round(data.total_calories || 0));
    updateElement('tracker-calories-goal', data.calorie_goal || 2000);
    updateElement('tracker-protein', Math.round(data.total_protein_g || 0));
    updateElement('tracker-protein-goal', data.protein_goal_g || 50);
    updateElement('tracker-carbs', Math.round(data.total_carbs_g || 0));
    updateElement('tracker-carbs-goal', data.carbs_goal_g || 250);
    updateElement('tracker-fat', Math.round(data.total_fat_g || 0));
    updateElement('tracker-fat-goal', data.fat_goal_g || 70);
    updateElement('tracker-fiber', Math.round(data.total_fiber_g || 0));
    updateElement('tracker-fiber-goal', 25);

    // Update progress bars (tracker)
    updateProgressBar('tracker-protein-bar', data.total_protein_g, data.protein_goal_g || 50);
    updateProgressBar('tracker-carbs-bar', data.total_carbs_g, data.carbs_goal_g || 250);
    updateProgressBar('tracker-fat-bar', data.total_fat_g, data.fat_goal_g || 70);
    updateProgressBar('tracker-fiber-bar', data.total_fiber_g, 25);

    // Update circular progress (tri-color macro ring)
    updateCircularProgress(
        data.total_calories,
        data.calorie_goal || 2000,
        data.total_protein_g,
        data.total_carbs_g,
        data.total_fat_g
    );

    // Update meals list
    if (mealsData && mealsData.length > 0) {
        renderMealsList(mealsData);
    }

    // Update daily nutrition score
    updateNutritionScoreUI(data);
}

// Helper function to update element text
function updateElement(id, value) {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = value;
    }
}

// Helper function to update progress bar
function updateProgressBar(id, current, goal) {
    const el = document.getElementById(id);
    if (el && goal > 0) {
        const percent = Math.min((current / goal) * 100, 100);
        el.style.width = percent + '%';
    }
}

// Update circular progress (tri-color macro ring)
function updateCircularProgress(current, goal, proteinG, carbsG, fatG) {
    const svg = document.getElementById('calorie-circle-svg');
    if (!svg || !goal || goal <= 0) return;

    const radius = 90;
    const circumference = 2 * Math.PI * radius;
    const totalPercent = Math.min(current / goal, 1);
    const totalFill = totalPercent * circumference;

    // Convert macros to calories
    const proCal = (proteinG || 0) * 4;
    const carbCal = (carbsG || 0) * 4;
    const fatCal = (fatG || 0) * 9;
    const macroCal = proCal + carbCal + fatCal;

    // Calculate each segment's share of the filled arc
    let proFill = 0, carbFill = 0, fatFill = 0;
    if (macroCal > 0) {
        proFill = (proCal / macroCal) * totalFill;
        carbFill = (carbCal / macroCal) * totalFill;
        fatFill = (fatCal / macroCal) * totalFill;
    }

    // Clear existing progress circles (keep bg circle)
    const existingProgress = svg.querySelectorAll('.macro-ring-segment');
    existingProgress.forEach(el => el.remove());

    const segments = [
        { fill: proFill, color: '#3b82f6' },   // Protein - blue
        { fill: carbFill, color: '#f59e0b' },   // Carbs - amber
        { fill: fatFill, color: '#ef4444' }      // Fat - red
    ];

    let accumulatedAngle = -90; // Start from top
    segments.forEach(seg => {
        if (seg.fill <= 0) return;
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('class', 'macro-ring-segment');
        circle.setAttribute('cx', '100');
        circle.setAttribute('cy', '100');
        circle.setAttribute('r', String(radius));
        circle.setAttribute('fill', 'none');
        circle.setAttribute('stroke', seg.color);
        circle.setAttribute('stroke-width', '12');
        circle.setAttribute('stroke-linecap', 'butt');
        circle.setAttribute('stroke-dasharray', `${seg.fill} ${circumference - seg.fill}`);
        circle.setAttribute('transform', `rotate(${accumulatedAngle} 100 100)`);
        circle.style.transition = 'stroke-dasharray 0.5s ease, transform 0.5s ease';
        svg.appendChild(circle);
        // Calculate rotation for next segment
        accumulatedAngle += (seg.fill / circumference) * 360;
    });

    // Update macro ring legend percentages
    if (macroCal > 0) {
        const proPct = Math.round((proCal / macroCal) * 100);
        const carbPct = Math.round((carbCal / macroCal) * 100);
        const fatPct = 100 - proPct - carbPct;
        updateElement('macro-ring-protein-pct', proPct + '%');
        updateElement('macro-ring-carbs-pct', carbPct + '%');
        updateElement('macro-ring-fat-pct', fatPct + '%');
    }
}

// Store meals data for popup access
let currentMealsList = [];

// Check if image URL is accessible (for debugging)
async function checkImageUrl(url) {
    if (!url || url === 'text-input') return { accessible: false, reason: 'no-url' };
    try {
        const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
        // Note: no-cors mode always returns opaque response, so we can't check status
        // But if it throws, the URL is definitely not accessible
        return { accessible: true, status: 'opaque' };
    } catch (error) {
        console.log('Image URL check failed:', url, error.message);
        return { accessible: false, reason: error.message };
    }
}

// Render meals list
function renderMealsList(meals) {
    const container = document.getElementById('meals-log-list');
    if (!container) return;

    // Store meals for popup access
    currentMealsList = meals || [];

    // Debug: Log meal photo URLs and check accessibility
    console.log('Meals data received:', meals?.map(m => ({
        time: m.meal_time,
        photo_url: m.photo_url,
        hasValidPhoto: m.photo_url && m.photo_url.trim() !== '' && m.photo_url !== 'text-input'
    })));

    // Check first meal photo URL for debugging
    if (meals && meals.length > 0) {
        const firstMealWithPhoto = meals.find(m => m.photo_url && m.photo_url.trim() !== '' && m.photo_url !== 'text-input');
        if (firstMealWithPhoto) {
            checkImageUrl(firstMealWithPhoto.photo_url).then(result => {
                console.log('Image URL accessibility check:', result);
            });
        }
    }

    if (!meals || meals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                    📸 No meals logged yet today.<br>
                    <span style="font-size: 0.9rem;">Take a photo of your meal to get started!</span>
                </p>
            </div>
        `;
        return;
    }

    let html = '';
    meals.forEach((meal, index) => {
        const time = new Date(`2000-01-01T${meal.meal_time}`).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });

        const foodItemsText = Array.isArray(meal.food_items)
            ? meal.food_items.map(item => item.name).join(', ')
            : 'Food';

        // Handle photo display - show placeholder if no photo or text-input placeholder
        const hasPhoto = meal.photo_url && meal.photo_url.trim() !== '' && meal.photo_url !== 'text-input';
        const imageHtml = hasPhoto
            ? `<div class="meal-log-image" style="overflow: hidden;"><img src="${meal.photo_url}" alt="Meal" style="width: 100%; height: 100%; object-fit: cover;" referrerpolicy="no-referrer" onerror="try{console.log('Meal card image failed to load:', this.src);var p=this.parentElement;if(p){p.innerHTML='🍽️';p.style.display='flex';p.style.alignItems='center';p.style.justifyContent='center';p.style.fontSize='2rem';}}catch(e){}"></div>`
            : `<div class="meal-log-image" style="display: flex; align-items: center; justify-content: center; font-size: 2rem;">🍽️</div>`;

        // Check if any item in this meal is verified
        const isVerified = Array.isArray(meal.food_items) && meal.food_items.some(item => item.verified);
        const verifiedTag = isVerified ? `<span class="verified-badge">✓ Verified</span>` : '';

        const mealTypeLabel = meal.meal_type ? meal.meal_type.charAt(0).toUpperCase() + meal.meal_type.slice(1) : '';

        html += `
            <div class="meal-log-card" onclick="openMealDetailPopup(${index})">
                ${imageHtml}
                <div class="meal-log-content">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2px;">
                        <div class="meal-log-time">${mealTypeLabel ? `<span class="meal-type-tag">${mealTypeLabel}</span> ` : ''}${time}</div>
                        ${verifiedTag}
                    </div>
                    <div class="meal-log-foods">${foodItemsText}</div>
                    <div class="meal-log-macros">
                        <span>${Math.round(meal.calories)} cal</span>
                        <span>P: ${Math.round(meal.protein_g)}g</span>
                        <span>C: ${Math.round(meal.carbs_g)}g</span>
                        <span>F: ${Math.round(meal.fat_g)}g</span>
                    </div>
                </div>
                <button class="meal-log-delete" onclick="event.stopPropagation(); deleteMealLog('${meal.id}')" title="Delete meal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        `;
    });

    container.innerHTML = html;
}

// Open meal detail popup
function openMealDetailPopup(index) {
    const meal = currentMealsList[index];
    if (!meal) return;

    // Track which meal is being viewed for edit functionality
    currentEditingMealIndex = index;

    const popup = document.getElementById('mealDetailPopup');
    const photoSection = document.getElementById('mealDetailPhotoSection');
    const timeEl = document.getElementById('mealDetailTime');
    const foodsEl = document.getElementById('mealDetailFoods');
    const caloriesEl = document.getElementById('mealDetailCalories');
    const proteinEl = document.getElementById('mealDetailProtein');
    const carbsEl = document.getElementById('mealDetailCarbs');
    const fatEl = document.getElementById('mealDetailFat');
    const itemsEl = document.getElementById('mealDetailItems');

    // Format time
    const time = new Date(`2000-01-01T${meal.meal_time}`).toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });

    // Get food items text
    const foodItemsText = Array.isArray(meal.food_items)
        ? meal.food_items.map(item => item.name).join(', ')
        : 'Food';

    // Handle photo display - exclude 'text-input' placeholder
    const hasPhoto = meal.photo_url && meal.photo_url.trim() !== '' && meal.photo_url !== 'text-input';
    console.log('Popup photo URL:', meal.photo_url);
    if (hasPhoto) {
        photoSection.innerHTML = `
            <div class="meal-detail-photo" style="position: relative; overflow: hidden;">
                <img src="${meal.photo_url}" alt="Meal photo"
                     style="width: 100%; height: 100%; object-fit: cover;"
                     referrerpolicy="no-referrer"
                     onerror="try{console.log('Popup image failed to load:', this.src);this.style.display='none';var p=this.nextElementSibling;if(p)p.style.display='flex';}catch(e){}"
                     onload="console.log('Image loaded successfully');">
                <div style="display:none; width:100%; height:100%; align-items:center; justify-content:center; font-size:1rem; color:#999; position:absolute; top:0; left:0; background:#f5f5f5;">Photo unavailable</div>
                <button class="meal-detail-close" onclick="closeMealDetailPopup()">&times;</button>
            </div>
        `;
    } else {
        photoSection.innerHTML = `
            <div class="meal-detail-photo-placeholder">
                <button class="meal-detail-close" onclick="closeMealDetailPopup()" style="position: absolute; top: 12px; right: 12px;">&times;</button>
                🍽️
            </div>
        `;
    }

    // Populate data
    timeEl.textContent = time;
    foodsEl.textContent = foodItemsText;
    caloriesEl.textContent = Math.round(meal.calories || 0);
    proteinEl.textContent = `${Math.round(meal.protein_g || 0)}g`;
    carbsEl.textContent = `${Math.round(meal.carbs_g || 0)}g`;
    fatEl.textContent = `${Math.round(meal.fat_g || 0)}g`;

    // Populate food items breakdown
    if (Array.isArray(meal.food_items) && meal.food_items.length > 0) {
        let itemsHtml = '<div class="meal-detail-items-title">Food Items</div>';
        meal.food_items.forEach(item => {
            const itemCals = item.calories ? Math.round(item.calories) : 0;
            const verifiedHtml = item.verified 
                ? `<span class="verified-badge-pill" title="Verified by ${item.db_source || 'Database'}"><svg viewBox="0 0 20 20"><path d="M7.629 14.571L3.125 10.067a.642.642 0 010-.909l.909-.909a.642.642 0 01.909 0l2.677 2.677 6.152-6.152a.642.642 0 01.909 0l.909.909a.642.642 0 010 .909l-7.962 7.962a.642.642 0 01-.909 0z"/></svg>Verified</span>`
                : '';
            
            itemsHtml += `
                <div class="meal-detail-item">
                    <div style="display: flex; flex-direction: column; flex: 1;">
                        <span class="meal-detail-item-name">${item.name}</span>
                        ${verifiedHtml}
                    </div>
                    <span class="meal-detail-item-cals">${itemCals} cal</span>
                </div>
            `;
        });
        itemsEl.innerHTML = itemsHtml;
        itemsEl.style.display = 'block';
    } else {
        itemsEl.style.display = 'none';
    }

    // Show popup
    popup.classList.add('visible');
    document.body.style.overflow = 'hidden';
}

// Close meal detail popup
function closeMealDetailPopup() {
    const popup = document.getElementById('mealDetailPopup');
    popup.classList.remove('visible');
    document.body.style.overflow = '';
    currentEditingMealIndex = null;
}

// Close popup on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const popup = document.getElementById('mealDetailPopup');
        if (popup && popup.classList.contains('visible')) {
            closeMealDetailPopup();
        }
        const editModal = document.getElementById('editItemsModal');
        if (editModal && editModal.classList.contains('visible')) {
            closeEditItemsModal();
        }
    }
});

// Food Items Modal State
let currentEditingMealIndex = null;
let editingFoodItems = [];
let foodItemsModalMode = 'edit'; // 'edit' or 'add'
let addedFoodItemsForPhoto = []; // Items added before photo analysis

// Open edit items modal (from meal detail popup)
function openEditItemsModal() {
    if (currentEditingMealIndex === null) {
        console.error('No meal selected for editing');
        return;
    }

    const meal = currentMealsList[currentEditingMealIndex];
    if (!meal || !Array.isArray(meal.food_items)) {
        console.error('No food items to edit');
        return;
    }

    // Set mode to edit
    foodItemsModalMode = 'edit';

    // Clone the food items for editing
    editingFoodItems = meal.food_items.map(item => ({ ...item }));

    // Update modal title and button text
    document.getElementById('foodItemsModalTitle').textContent = 'Edit Food';
    document.getElementById('foodItemsSubmitText').textContent = '🔄 Recalculate';

    // Render the editable list
    renderEditItemsList();

    // Show the modal
    const modal = document.getElementById('editItemsModal');
    modal.classList.add('visible');
}

// Open add items modal (from meal photo preview)
function openAddItemsModal() {
    // Set mode to add
    foodItemsModalMode = 'add';

    // Load any previously added items
    editingFoodItems = [...addedFoodItemsForPhoto];

    // Update modal title and button text
    document.getElementById('foodItemsModalTitle').textContent = 'Add Food';
    document.getElementById('foodItemsSubmitText').textContent = '✓ Done';

    // Render the editable list
    renderEditItemsList();

    // Show the modal
    const modal = document.getElementById('editItemsModal');
    modal.classList.add('visible');
}

// Close food items modal (unified function)
function closeFoodItemsModal() {
    const modal = document.getElementById('editItemsModal');
    modal.classList.remove('visible');
    editingFoodItems = [];
    document.getElementById('newItemInput').value = '';
    const portionInput = document.getElementById('newItemPortionInput');
    if (portionInput) portionInput.value = '';
}

// Legacy alias for backwards compatibility
function closeEditItemsModal() {
    closeFoodItemsModal();
}

// Render editable items list
function renderEditItemsList() {
    const listEl = document.getElementById('editItemsList');

    if (editingFoodItems.length === 0) {
        listEl.innerHTML = '<div class="edit-items-empty">No items. Add some items below.</div>';
        return;
    }

    let html = '';
    editingFoodItems.forEach((item, index) => {
        const portion = item.portion || '';
        html += `
            <div class="edit-item-row" data-index="${index}">
                <div class="edit-item-inputs">
                    <input type="text" class="edit-item-input edit-item-name" value="${escapeHtml(item.name)}"
                           onchange="updateItemName(${index}, this.value)"
                           placeholder="Food item">
                    <input type="text" class="edit-item-input edit-item-portion" value="${escapeHtml(portion)}"
                           onchange="updateItemPortion(${index}, this.value)"
                           placeholder="Amount (e.g., 200g)">
                </div>
                <button class="edit-item-delete" onclick="deleteEditItem(${index})" title="Remove item">🗑️</button>
            </div>
        `;
    });

    listEl.innerHTML = html;
}

// Escape HTML for safe display
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Update item name
function updateItemName(index, newName) {
    if (editingFoodItems[index]) {
        editingFoodItems[index].name = newName.trim();
    }
}

// Update item portion
function updateItemPortion(index, newPortion) {
    if (editingFoodItems[index]) {
        editingFoodItems[index].portion = newPortion.trim();
    }
}

// Delete item from edit list
function deleteEditItem(index) {
    editingFoodItems.splice(index, 1);
    renderEditItemsList();
}

// Add new item to edit list
function addNewItem() {
    const nameInput = document.getElementById('newItemInput');
    const portionInput = document.getElementById('newItemPortionInput');
    const newItemName = nameInput.value.trim();
    const newItemPortion = portionInput ? portionInput.value.trim() : '';

    if (!newItemName) return;

    // Add the item with portion
    editingFoodItems.push({
        name: newItemName,
        portion: newItemPortion || '',
        calories: 0,
        protein_g: 0,
        carbs_g: 0,
        fat_g: 0,
        fiber_g: 0
    });

    nameInput.value = '';
    if (portionInput) portionInput.value = '';
    renderEditItemsList();
}

// Handle submit button based on mode
function handleFoodItemsSubmit() {
    if (foodItemsModalMode === 'add') {
        // Save items for photo analysis and close modal
        addedFoodItemsForPhoto = editingFoodItems.filter(item => item.name.trim().length > 0);
        updateAddItemsButton();
        closeFoodItemsModal();
    } else {
        // Edit mode - recalculate with Gemini
        recalculateWithGemini();
    }
}

// Update the add items button text to show count
function updateAddItemsButton() {
    const btnText = document.getElementById('add-items-btn-text');
    if (btnText) {
        if (addedFoodItemsForPhoto.length > 0) {
            btnText.textContent = `${addedFoodItemsForPhoto.length} item${addedFoodItemsForPhoto.length > 1 ? 's' : ''} added ✓`;
        } else {
            btnText.textContent = 'Add Food Items (optional)';
        }
    }
}

// Recalculate nutrition with Gemini
async function recalculateWithGemini() {
    if (editingFoodItems.length === 0) {
        showToast('Please add at least one food item', 'error');
        return;
    }

    // Get all current items with portions (filter out empty names)
    const itemDescriptions = editingFoodItems
        .filter(item => item.name.trim().length > 0)
        .map(item => {
            const name = item.name.trim();
            const portion = item.portion ? item.portion.trim() : '';
            // Include portion if specified (e.g., "200g oats" or "oats 200g")
            return portion ? `${portion} ${name}` : name;
        });

    if (itemDescriptions.length === 0) {
        showToast('Please enter at least one food item name', 'error');
        return;
    }

    // Create description for Gemini with portions
    const description = itemDescriptions.join(', ');

    // Show loading state
    const btn = document.getElementById('recalculateBtn');
    const textSpan = btn.querySelector('.recalc-text');
    const loadingSpan = btn.querySelector('.recalc-loading');
    btn.disabled = true;
    textSpan.style.display = 'none';
    loadingSpan.style.display = 'inline';

    try {
        // Call Gemini text analysis endpoint
        const response = await fetch('/.netlify/functions/analyze-meal-text', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                description: description,
                mealType: null
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to analyze meal');
        }

        const result = await response.json();

        if (!result.success || !result.data) {
            throw new Error('Invalid response from analysis');
        }

        const nutritionData = result.data;

        // Update the meal in the database
        await updateMealWithNewNutrition(nutritionData);

        // Show success
        showToast('Meal updated successfully!', 'success');

        // Close modal and refresh
        closeEditItemsModal();
        closeMealDetailPopup();
        await loadTodayNutrition();

    } catch (error) {
        console.error('Error recalculating nutrition:', error);
        showToast(error.message || 'Failed to recalculate. Please try again.', 'error');
    } finally {
        // Reset button state
        btn.disabled = false;
        textSpan.style.display = 'inline';
        loadingSpan.style.display = 'none';
    }
}

// Update meal in database with new nutrition data
async function updateMealWithNewNutrition(nutritionData) {
    if (currentEditingMealIndex === null) {
        throw new Error('No meal selected for update');
    }

    const meal = currentMealsList[currentEditingMealIndex];
    if (!meal || !meal.id) {
        throw new Error('Invalid meal data');
    }

    const { data: userData } = await window.supabaseClient.auth.getUser();
    if (!userData?.user?.id) {
        throw new Error('User not authenticated');
    }

    // Prepare updated meal data
    const updateData = {
        food_items: nutritionData.foodItems,
        calories: nutritionData.totals.calories,
        protein_g: nutritionData.totals.protein_g,
        carbs_g: nutritionData.totals.carbs_g,
        fat_g: nutritionData.totals.fat_g,
        fiber_g: nutritionData.totals.fiber_g || 0,
        micronutrients: nutritionData.micronutrients || {},
        ai_confidence: nutritionData.confidence || 'medium',
        analysis_timestamp: new Date().toISOString(),
        updated_at: new Date().toISOString()
    };

    const { error } = await window.supabaseClient
        .from('meal_logs')
        .update(updateData)
        .eq('id', meal.id)
        .eq('user_id', userData.user.id);

    if (error) {
        console.error('Database update error:', error);
        throw new Error('Failed to save changes');
    }

    // Trigger recalculation of daily nutrition
    await recalculateDailyNutrition();
    await loadMicronutrientInsights();
}

// Delete meal log
async function deleteMealLog(mealId) {
    if (!confirm('Are you sure you want to delete this meal?')) {
        return;
    }

    try {
        const { error } = await window.supabaseClient
            .from('meal_logs')
            .delete()
            .eq('id', mealId);

        if (error) {
            console.error('Error deleting meal:', error);
            alert('Failed to delete meal. Please try again.');
            return;
        }

        // Recalculate daily nutrition totals
        await recalculateDailyNutrition();

        // Reload data
        await loadTodayNutrition();
        await loadMicronutrientInsights();
    } catch (error) {
        console.error('Error deleting meal:', error);
        alert('Failed to delete meal. Please try again.');
    }
}

// Show loading state
function showMealAnalysisLoading(message = 'Analyzing meal...') {
    // Could add a modal or toast here
    console.log(message);
    if (typeof showToast === 'function') {
        showToast(message, 'info');
    }
}

// Hide loading state (toast auto-hides, but this allows explicit dismissal)
function hideMealAnalysisLoading() {
    // Toast notifications auto-hide, so this is a no-op
    // Kept for compatibility with code that calls it
}

// Show success message
function showMealAnalysisSuccess(data) {
    const message = `Meal logged! ${Math.round(data.totals.calories)} calories added.`;

    // Simple alert for now - could be replaced with a toast notification
    if (typeof showToast === 'function') {
        showToast(message, 'success');
    } else {
        console.log(message);
    }
}

// Show error message
function showMealAnalysisError(message) {
    const errorMsg = `Failed to analyze meal: ${message}`;

    // Simple alert for now - could be replaced with a toast notification
    if (typeof showToast === 'function') {
        showToast(errorMsg, 'error');
    } else {
        alert(errorMsg);
    }
}

// ==========================================
// UNIFIED CAMERA (Photo + Barcode Scanner)
// ==========================================

let unifiedCameraStream = null;
let unifiedFacingMode = 'environment';
let barcodeScanInterval = null;
let lastBarcodeDetected = null;
let barcodeProductData = null;

// AI food recognition state
let aiFoodScanTimeout = null;
let aiFoodScanActive = false;
let aiFoodScanCount = 0;
const AI_FOOD_SCAN_MAX = 3;        // Max auto-scans before stopping
const AI_FOOD_SCAN_DELAY = 2500;   // First scan after 2.5s
const AI_FOOD_SCAN_INTERVAL = 6000; // Subsequent scans every 6s
let lastAiFoodResult = null;
let barcodeServings = 1;
let barcodeAmountMode = 'servings'; // 'servings' or 'custom'
let barcodeCustomAmount = '';

async function openUnifiedCamera() {
    const modal = document.getElementById('unified-camera-modal');
    if (!modal) return;

    // Reset state
    lastBarcodeDetected = null;
    lastAiFoodResult = null;
    document.getElementById('barcode-detected-banner').style.display = 'none';
    document.getElementById('ai-food-detected-banner').style.display = 'none';
    document.getElementById('unified-camera-description').value = '';
    document.getElementById('manual-barcode-row').style.display = 'none';
    document.getElementById('barcode-scan-status').textContent = 'Scanning for barcodes & identifying food...';

    modal.style.display = 'flex';
    await startUnifiedCamera();
}

function closeUnifiedCamera() {
    stopUnifiedCamera();
    const modal = document.getElementById('unified-camera-modal');
    if (modal) modal.style.display = 'none';
}

async function startUnifiedCamera() {
    stopUnifiedCamera();
    try {
        unifiedCameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: unifiedFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } },
            audio: false
        });
        const video = document.getElementById('unified-camera-video');
        video.srcObject = unifiedCameraStream;
        await video.play();

        // Start background barcode scanning on the live video frames
        startBarcodeScanLoop(video);
        // Start AI food recognition scanning
        startAiFoodScanLoop(video);
    } catch (err) {
        console.error('Failed to access camera:', err);
        showToast('Could not access camera. Check permissions.', 'error');
    }
}

function stopUnifiedCamera() {
    stopBarcodeScanLoop();
    stopAiFoodScanLoop();
    if (unifiedCameraStream) {
        unifiedCameraStream.getTracks().forEach(t => t.stop());
        unifiedCameraStream = null;
    }
    const video = document.getElementById('unified-camera-video');
    if (video) video.srcObject = null;
}

async function flipUnifiedCamera() {
    unifiedFacingMode = unifiedFacingMode === 'environment' ? 'user' : 'environment';
    await startUnifiedCamera();
}

// --- Barcode scanning on video frames ---
function startBarcodeScanLoop(videoEl) {
    stopBarcodeScanLoop();

    // Use BarcodeDetector API if available (Chrome, Edge, Android WebView)
    if ('BarcodeDetector' in window) {
        const detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39'] });
        barcodeScanInterval = setInterval(async () => {
            if (videoEl.readyState < 2) return;
            try {
                const barcodes = await detector.detect(videoEl);
                if (barcodes.length > 0) {
                    const code = barcodes[0].rawValue;
                    if (code && code !== lastBarcodeDetected) {
                        lastBarcodeDetected = code;
                        onBarcodeDetected(code);
                    }
                }
            } catch (e) {}
        }, 400);
        return;
    }

    // Fallback: use html5-qrcode scanning on canvas snapshots
    if (typeof Html5Qrcode !== 'undefined') {
        const scanCanvas = document.createElement('canvas');
        const scanCtx = scanCanvas.getContext('2d');
        const qr = new Html5Qrcode('barcode-reader', /* verbose= */ false);

        barcodeScanInterval = setInterval(async () => {
            if (videoEl.readyState < 2) return;
            try {
                scanCanvas.width = videoEl.videoWidth;
                scanCanvas.height = videoEl.videoHeight;
                scanCtx.drawImage(videoEl, 0, 0);
                scanCanvas.toBlob(async (blob) => {
                    if (!blob) return;
                    try {
                        const imageFile = new File([blob], 'frame.jpg', { type: 'image/jpeg' });
                        const result = await qr.scanFileV2(imageFile, /* showImage= */ false);
                        if (result && result.decodedText && result.decodedText !== lastBarcodeDetected) {
                            lastBarcodeDetected = result.decodedText;
                            onBarcodeDetected(result.decodedText);
                        }
                    } catch (e) {
                        // No barcode found in this frame — expected
                    }
                }, 'image/jpeg', 0.8);
            } catch (e) {}
        }, 800);
        return;
    }

    // No barcode scanning available
    document.getElementById('barcode-scan-status').textContent = 'Barcode scanning unavailable — use manual entry';
}

function stopBarcodeScanLoop() {
    if (barcodeScanInterval) {
        clearInterval(barcodeScanInterval);
        barcodeScanInterval = null;
    }
}

// --- AI Food Recognition on live camera frames ---
function startAiFoodScanLoop(videoEl) {
    stopAiFoodScanLoop();
    aiFoodScanActive = true;
    aiFoodScanCount = 0;
    lastAiFoodResult = null;

    // Update status to show AI scanning is active
    const status = document.getElementById('barcode-scan-status');
    if (status) status.textContent = 'Scanning for barcodes & identifying food...';

    // First scan after initial delay (let camera stabilise)
    aiFoodScanTimeout = setTimeout(() => doAiFoodScan(videoEl), AI_FOOD_SCAN_DELAY);
}

function stopAiFoodScanLoop() {
    aiFoodScanActive = false;
    if (aiFoodScanTimeout) {
        clearTimeout(aiFoodScanTimeout);
        aiFoodScanTimeout = null;
    }
}

async function doAiFoodScan(videoEl) {
    if (!aiFoodScanActive || !videoEl || videoEl.readyState < 2) return;
    if (aiFoodScanCount >= AI_FOOD_SCAN_MAX) {
        aiFoodScanActive = false;
        return;
    }

    // Don't scan if barcode was already detected (barcode takes priority)
    if (lastBarcodeDetected && document.getElementById('barcode-detected-banner').style.display === 'block') {
        // Schedule next scan in case barcode banner is dismissed
        if (aiFoodScanActive) {
            aiFoodScanTimeout = setTimeout(() => doAiFoodScan(videoEl), AI_FOOD_SCAN_INTERVAL);
        }
        return;
    }

    aiFoodScanCount++;

    // Show scanning indicator
    const banner = document.getElementById('ai-food-detected-banner');
    const nameEl = document.getElementById('ai-food-detected-name');
    const detailEl = document.getElementById('ai-food-detected-detail');
    if (nameEl) nameEl.textContent = 'Identifying food...';
    if (detailEl) detailEl.textContent = '';
    if (banner) {
        banner.style.display = 'block';
        banner.querySelector('button')?.style.setProperty('display', 'none');
        // Hide buttons while scanning
        const btns = banner.querySelectorAll('button');
        btns.forEach(b => b.style.display = 'none');
    }

    try {
        // Capture a low-res frame from the video
        const scanCanvas = document.createElement('canvas');
        const maxDim = 640; // Keep it small for fast upload
        const scale = Math.min(maxDim / videoEl.videoWidth, maxDim / videoEl.videoHeight, 1);
        scanCanvas.width = Math.round(videoEl.videoWidth * scale);
        scanCanvas.height = Math.round(videoEl.videoHeight * scale);
        scanCanvas.getContext('2d').drawImage(videoEl, 0, 0, scanCanvas.width, scanCanvas.height);

        const base64 = await new Promise((resolve) => {
            scanCanvas.toBlob((blob) => {
                if (!blob) { resolve(null); return; }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.6);
        });

        if (!base64 || !aiFoodScanActive) return;

        const base64Data = base64.split(',')[1];

        const response = await fetch('/api/identify-food', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imageBase64: base64Data, mimeType: 'image/jpeg' })
        });

        if (!response.ok) throw new Error('API error');

        const result = await response.json();

        if (!aiFoodScanActive) return; // Camera may have closed during fetch

        if (result.success && result.data && result.data.identified) {
            lastAiFoodResult = result.data;
            // Show result in banner
            if (nameEl) nameEl.textContent = result.data.name;
            if (detailEl) detailEl.textContent =
                `~${result.data.approx_calories} cal ${result.data.serving_hint || ''}`.trim();
            if (banner) {
                banner.style.display = 'block';
                const btns = banner.querySelectorAll('button');
                btns.forEach(b => b.style.display = '');
            }
            // Stop auto-scanning once we have a result
            aiFoodScanActive = false;
            return;
        } else {
            // No food identified — hide banner and try again
            if (banner) banner.style.display = 'none';
        }
    } catch (err) {
        console.log('AI food scan error (non-critical):', err.message);
        if (banner) banner.style.display = 'none';
    }

    // Schedule next scan
    if (aiFoodScanActive && aiFoodScanCount < AI_FOOD_SCAN_MAX) {
        aiFoodScanTimeout = setTimeout(() => doAiFoodScan(videoEl), AI_FOOD_SCAN_INTERVAL);
    } else if (banner && banner.style.display !== 'block') {
        // All scans exhausted without result
        banner.style.display = 'none';
    }
}

function useAiFoodSuggestion() {
    if (!lastAiFoodResult) return;
    const descInput = document.getElementById('unified-camera-description');
    if (descInput) {
        descInput.value = lastAiFoodResult.suggestion || lastAiFoodResult.name || '';
        descInput.focus();
        // Place cursor at end so user can append details
        descInput.selectionStart = descInput.selectionEnd = descInput.value.length;
    }
    // Hide the banner but keep the result available
    const banner = document.getElementById('ai-food-detected-banner');
    if (banner) banner.style.display = 'none';
    showToast('Food identified! Edit the description if needed, then take a photo.', 'success');
}

function dismissAiFoodBanner() {
    const banner = document.getElementById('ai-food-detected-banner');
    if (banner) banner.style.display = 'none';
    lastAiFoodResult = null;
}

async function onBarcodeDetected(code) {
    document.getElementById('barcode-scan-status').textContent = 'Barcode found! Looking up...';
    // Hide AI food banner — barcode takes priority
    const aiBanner = document.getElementById('ai-food-detected-banner');
    if (aiBanner) aiBanner.style.display = 'none';
    stopAiFoodScanLoop();

    try {
        const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${encodeURIComponent(code)}.json`);
        if (!response.ok) throw new Error('Network error');
        const data = await response.json();

        if (data.status !== 1 || !data.product) {
            document.getElementById('barcode-scan-status').textContent = `Barcode ${code} not found in database. Keep scanning or snap a photo.`;
            // Allow re-detection of same barcode after a delay
            setTimeout(() => { lastBarcodeDetected = null; }, 5000);
            return;
        }

        const product = data.product;
        const nutrients = product.nutriments || {};

        // Always store per-100g values for custom gram entry
        const per100g = {
            calories: parseFloat(nutrients['energy-kcal_100g']) || 0,
            protein_g: parseFloat(nutrients.proteins_100g) || 0,
            carbs_g: parseFloat(nutrients.carbohydrates_100g) || 0,
            fat_g: parseFloat(nutrients.fat_100g) || 0,
            fiber_g: parseFloat(nutrients.fiber_100g) || 0,
            sugars_g: parseFloat(nutrients.sugars_100g) || 0,
            saturated_fat_g: parseFloat(nutrients['saturated-fat_100g']) || 0,
            sodium_mg: (parseFloat(nutrients.sodium_100g) || 0) * 1000
        };

        const hasServingData = !!(nutrients['energy-kcal_serving']);
        const perServing = hasServingData ? {
            calories: parseFloat(nutrients['energy-kcal_serving']) || 0,
            protein_g: parseFloat(nutrients.proteins_serving) || 0,
            carbs_g: parseFloat(nutrients.carbohydrates_serving) || 0,
            fat_g: parseFloat(nutrients.fat_serving) || 0,
            fiber_g: parseFloat(nutrients.fiber_serving) || 0,
            sugars_g: parseFloat(nutrients.sugars_serving) || 0,
            saturated_fat_g: parseFloat(nutrients['saturated-fat_serving']) || 0,
            sodium_mg: (parseFloat(nutrients.sodium_serving) || 0) * 1000
        } : { ...per100g }; // fall back to per-100g

        // Parse serving weight in grams (e.g. "30g", "250 ml")
        const servingSizeStr = product.serving_size || '';
        const servingWeightMatch = servingSizeStr.match(/([\d.]+)\s*(g|ml)/i);
        const servingWeightG = servingWeightMatch ? parseFloat(servingWeightMatch[1]) : null;

        const micro100g = {
            vitamin_c_mg: parseFloat(nutrients['vitamin-c_100g']) || 0,
            iron_mg: parseFloat(nutrients['iron_100g']) || 0,
            calcium_mg: parseFloat(nutrients['calcium_100g']) || 0,
            potassium_mg: parseFloat(nutrients['potassium_100g']) || 0,
            vitamin_a_mcg: parseFloat(nutrients['vitamin-a_100g']) || 0,
            vitamin_d_mcg: parseFloat(nutrients['vitamin-d_100g']) || 0
        };

        barcodeProductData = {
            name: product.product_name || product.product_name_en || 'Unknown Product',
            brand: product.brands || '',
            quantity: product.quantity || '',
            image: product.image_front_small_url || product.image_url || '',
            servingSize: servingSizeStr,
            servingWeightG: servingWeightG,
            perServing: perServing,
            per100g: per100g,
            micro100g: micro100g,
            micronutrients: {
                vitamin_c_mg: parseFloat(nutrients['vitamin-c_serving']) || micro100g.vitamin_c_mg,
                iron_mg: parseFloat(nutrients['iron_serving']) || micro100g.iron_mg,
                calcium_mg: parseFloat(nutrients['calcium_serving']) || micro100g.calcium_mg,
                potassium_mg: parseFloat(nutrients['potassium_serving']) || micro100g.potassium_mg,
                vitamin_a_mcg: parseFloat(nutrients['vitamin-a_serving']) || micro100g.vitamin_a_mcg,
                vitamin_d_mcg: parseFloat(nutrients['vitamin-d_serving']) || micro100g.vitamin_d_mcg
            },
            isPerServing: hasServingData,
            barcode: code
        };

        barcodeServings = 1;
        barcodeAmountMode = 'servings'; // reset to servings mode
        barcodeCustomAmount = '';

        // Show the detected banner on the camera view
        const banner = document.getElementById('barcode-detected-banner');
        document.getElementById('barcode-detected-name').textContent = barcodeProductData.name;
        document.getElementById('barcode-detected-detail').textContent =
            (barcodeProductData.brand ? barcodeProductData.brand + ' — ' : '') +
            Math.round(barcodeProductData.perServing.calories) + ' kcal per serving';
        banner.style.display = 'block';
        document.getElementById('barcode-scan-status').textContent = 'Product found! Tap banner to log, or snap a photo instead.';

    } catch (error) {
        console.error('Barcode lookup error:', error);
        document.getElementById('barcode-scan-status').textContent = 'Lookup failed. Keep scanning or snap a photo.';
        setTimeout(() => { lastBarcodeDetected = null; }, 3000);
    }
}

// --- Photo capture from live video ---
function captureUnifiedPhoto() {
    const video = document.getElementById('unified-camera-video');
    const canvas = document.getElementById('unified-camera-canvas');
    if (!video || !canvas || video.readyState < 2) {
        showToast('Camera not ready. Please wait a moment.', 'warning');
        return;
    }

    // Animate the capture button
    const btn = document.getElementById('unified-capture-btn');
    if (btn) { btn.style.transform = 'scale(0.9)'; setTimeout(() => { btn.style.transform = ''; }, 150); }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    canvas.toBlob((blob) => {
        if (!blob) {
            showToast('Failed to capture photo.', 'error');
            return;
        }

        const file = new File([blob], `meal-${Date.now()}.jpg`, { type: 'image/jpeg' });
        capturedMealFile = file;

        // Get description from the unified camera input
        const desc = document.getElementById('unified-camera-description');
        let description = desc ? desc.value.trim() : '';

        // If user hasn't typed anything but AI identified food, use the AI suggestion
        if (!description && lastAiFoodResult && lastAiFoodResult.suggestion) {
            description = lastAiFoodResult.suggestion;
        }

        // Close camera and show the existing meal preview flow
        closeUnifiedCamera();

        const reader = new FileReader();
        reader.onload = function(e) {
            showMealPhotoPreview(e.target.result);
            // Pre-fill the description field in the preview modal
            if (description) {
                const previewDesc = document.getElementById('meal-photo-description');
                if (previewDesc) previewDesc.value = description;
            }
        };
        reader.readAsDataURL(file);
    }, 'image/jpeg', 0.85);
}

// --- Manual barcode entry toggle ---
function showManualBarcodeEntry() {
    const row = document.getElementById('manual-barcode-row');
    if (row) {
        const isVisible = row.style.display === 'flex';
        row.style.display = isVisible ? 'none' : 'flex';
        if (!isVisible) document.getElementById('barcode-manual-input').focus();
    }
}

function lookupManualBarcode() {
    const input = document.getElementById('barcode-manual-input');
    const code = input ? input.value.trim() : '';
    if (!code) {
        showToast('Please enter a barcode number.', 'warning');
        return;
    }
    showToast('Looking up product...', 'info');
    onBarcodeDetected(code);
}

// --- Barcode lookup (called from result modal "View & Log") ---
async function lookupBarcode(barcode) {
    // This function is kept for any external callers; main flow uses onBarcodeDetected
    await onBarcodeDetected(barcode);
}

function showBarcodeResult() {
    if (!barcodeProductData) return;

    // Close the unified camera — user is moving to the result modal
    closeUnifiedCamera();

    const modal = document.getElementById('barcode-result-modal');
    if (!modal) return;

    // Product info
    document.getElementById('barcode-product-name').textContent = barcodeProductData.name;
    document.getElementById('barcode-product-brand').textContent = barcodeProductData.brand;
    document.getElementById('barcode-product-quantity').textContent = barcodeProductData.quantity;

    const img = document.getElementById('barcode-product-image');
    if (barcodeProductData.image) {
        img.src = barcodeProductData.image;
        img.style.display = 'block';
    } else {
        img.style.display = 'none';
    }

    // Serving label
    const servingLabel = document.getElementById('barcode-serving-size-label');
    if (barcodeProductData.isPerServing && barcodeProductData.servingSize) {
        servingLabel.textContent = `(${barcodeProductData.servingSize} each)`;
    } else {
        servingLabel.textContent = '(per 100g)';
    }

    // Determine unit hint for custom mode (g or ml)
    const unitEl = document.getElementById('barcode-custom-unit');
    const isLiquid = /ml|litr/i.test(barcodeProductData.quantity || '') || /ml|litr/i.test(barcodeProductData.servingSize || '');
    if (unitEl) unitEl.textContent = isLiquid ? 'ml' : 'g';

    // Show hint with serving weight if known
    const hintEl = document.getElementById('barcode-custom-hint');
    if (hintEl && barcodeProductData.servingWeightG) {
        hintEl.textContent = `1 serving = ${barcodeProductData.servingWeightG}${isLiquid ? 'ml' : 'g'}`;
    } else if (hintEl) {
        hintEl.textContent = '';
    }

    // Reset to servings mode
    barcodeAmountMode = 'servings';
    barcodeServings = 1;
    barcodeCustomAmount = '';
    setBarcodeAmountMode('servings');

    updateBarcodeNutritionDisplay();
    modal.style.display = 'flex';
}

function setBarcodeAmountMode(mode) {
    barcodeAmountMode = mode;
    const servingsBtn = document.getElementById('barcode-mode-servings');
    const customBtn = document.getElementById('barcode-mode-custom');
    const servingsRow = document.getElementById('barcode-servings-row');
    const customRow = document.getElementById('barcode-custom-row');

    if (mode === 'servings') {
        servingsBtn.style.background = 'var(--primary)';
        servingsBtn.style.color = '#fff';
        customBtn.style.background = 'transparent';
        customBtn.style.color = 'var(--text-muted, #888)';
        servingsRow.style.display = 'flex';
        customRow.style.display = 'none';
    } else {
        customBtn.style.background = 'var(--primary)';
        customBtn.style.color = '#fff';
        servingsBtn.style.background = 'transparent';
        servingsBtn.style.color = 'var(--text-muted, #888)';
        servingsRow.style.display = 'none';
        customRow.style.display = 'flex';
        // Pre-fill with serving weight if available
        const input = document.getElementById('barcode-custom-amount');
        if (input && !input.value && barcodeProductData && barcodeProductData.servingWeightG) {
            input.value = barcodeProductData.servingWeightG;
            barcodeCustomAmount = String(barcodeProductData.servingWeightG);
        }
        if (input) input.focus();
    }
    updateBarcodeNutritionDisplay();
}

function adjustBarcodeServings(delta) {
    barcodeServings = Math.max(0.5, barcodeServings + delta);
    document.getElementById('barcode-servings-display').textContent = barcodeServings % 1 === 0 ? barcodeServings : barcodeServings.toFixed(1);
    updateBarcodeNutritionDisplay();
}

function onBarcodeCustomAmountChange() {
    const input = document.getElementById('barcode-custom-amount');
    barcodeCustomAmount = input ? input.value : '';
    updateBarcodeNutritionDisplay();
}

// Returns { multiplier, per } based on current mode
function getBarcodeMultiplier() {
    if (!barcodeProductData) return { multiplier: 0, per: barcodeProductData?.perServing || {} };
    if (barcodeAmountMode === 'custom') {
        const grams = parseFloat(barcodeCustomAmount) || 0;
        // per100g values × (grams / 100)
        return { multiplier: grams / 100, per: barcodeProductData.per100g };
    }
    return { multiplier: barcodeServings, per: barcodeProductData.perServing };
}

function updateBarcodeNutritionDisplay() {
    if (!barcodeProductData) return;
    const { multiplier, per } = getBarcodeMultiplier();

    document.getElementById('barcode-calories').textContent = Math.round(per.calories * multiplier);
    document.getElementById('barcode-protein').textContent = Math.round(per.protein_g * multiplier) + 'g';
    document.getElementById('barcode-carbs').textContent = Math.round(per.carbs_g * multiplier) + 'g';
    document.getElementById('barcode-fat').textContent = Math.round(per.fat_g * multiplier) + 'g';

    // Extra nutrients
    const extras = document.getElementById('barcode-extra-nutrients');
    const extraItems = [
        { label: 'Fiber', value: per.fiber_g * multiplier, unit: 'g' },
        { label: 'Sugar', value: per.sugars_g * multiplier, unit: 'g' },
        { label: 'Sodium', value: per.sodium_mg * multiplier, unit: 'mg' }
    ].filter(item => item.value > 0);

    extras.innerHTML = extraItems.map(item =>
        `<div style="background:rgba(255,255,255,0.05); border-radius:10px; padding:10px; text-align:center;">
            <div style="font-size:1rem; font-weight:600; color:var(--text-main, #fff);">${Math.round(item.value)}${item.unit}</div>
            <div style="font-size:0.7rem; color:var(--text-muted, #888); margin-top:2px;">${item.label}</div>
        </div>`
    ).join('');
}

function closeBarcodeResult() {
    const modal = document.getElementById('barcode-result-modal');
    if (modal) modal.style.display = 'none';
    barcodeProductData = null;
    barcodeServings = 1;
    barcodeAmountMode = 'servings';
    barcodeCustomAmount = '';
}

async function logBarcodeAsMeal() {
    if (!barcodeProductData) return;

    // Capture all data before closeBarcodeResult() nulls barcodeProductData
    const { multiplier, per } = getBarcodeMultiplier();
    const barcode = barcodeProductData.barcode;
    const isLiquid = /ml|litr/i.test(barcodeProductData.quantity || '') || /ml|litr/i.test(barcodeProductData.servingSize || '');
    const unit = isLiquid ? 'ml' : 'g';
    const microSrc = barcodeAmountMode === 'custom' ? barcodeProductData.micro100g : barcodeProductData.micronutrients;
    const microScale = barcodeAmountMode === 'custom' ? multiplier : barcodeServings;

    // Build portion description based on mode
    let portion;
    if (barcodeAmountMode === 'custom') {
        const amt = parseFloat(barcodeCustomAmount) || 0;
        portion = `${amt}${unit}`;
    } else {
        const s = barcodeServings;
        if (barcodeProductData.isPerServing) {
            portion = `${s} serving${s !== 1 ? 's' : ''}${barcodeProductData.servingSize ? ' (' + barcodeProductData.servingSize + ')' : ''}`;
        } else {
            portion = `${Math.round(100 * s)}${unit}`;
        }
    }

    const foodItems = [{
        name: barcodeProductData.name + (barcodeProductData.brand ? ` (${barcodeProductData.brand})` : ''),
        portion: portion,
        calories: Math.round(per.calories * multiplier),
        protein_g: Math.round(per.protein_g * multiplier * 10) / 10,
        carbs_g: Math.round(per.carbs_g * multiplier * 10) / 10,
        fat_g: Math.round(per.fat_g * multiplier * 10) / 10,
        fiber_g: Math.round(per.fiber_g * multiplier * 10) / 10
    }];

    const totals = {
        calories: Math.round(per.calories * multiplier),
        protein_g: Math.round(per.protein_g * multiplier * 10) / 10,
        carbs_g: Math.round(per.carbs_g * multiplier * 10) / 10,
        fat_g: Math.round(per.fat_g * multiplier * 10) / 10,
        fiber_g: Math.round(per.fiber_g * multiplier * 10) / 10
    };

    const micronutrients = {
        vitamin_c_mg: Math.round((microSrc.vitamin_c_mg || 0) * microScale * 10) / 10,
        iron_mg: Math.round((microSrc.iron_mg || 0) * microScale * 10) / 10,
        calcium_mg: Math.round((microSrc.calcium_mg || 0) * microScale * 10) / 10,
        potassium_mg: Math.round((microSrc.potassium_mg || 0) * microScale * 10) / 10,
        vitamin_a_mcg: Math.round((microSrc.vitamin_a_mcg || 0) * microScale * 10) / 10,
        vitamin_d_mcg: Math.round((microSrc.vitamin_d_mcg || 0) * microScale * 10) / 10,
        b12_mcg: 0, omega3_g: 0, zinc_mg: 0, iodine_mcg: 0,
        selenium_mcg: 0, folate_mcg: 0, magnesium_mg: 0,
        vitamin_e_mg: 0, vitamin_k_mcg: 0
    };

    closeBarcodeResult();
    showToast('Logging meal...', 'info');

    try {
        const savedMeal = await saveMealLog({
            foodItems,
            totals,
            micronutrients,
            confidence: 'high',
            notes: `Barcode scan: ${barcode}`
        });

        // Award points
        if (savedMeal && savedMeal[0]?.id) {
            try {
                await awardPointsForMeal(savedMeal[0].id, new Date().toISOString(), 'high', null);
            } catch (pointsError) {
                console.error('Error awarding points (meal still saved):', pointsError);
            }
        }

        await recalculateDailyNutrition();
        await loadTodayNutrition();
        try { await loadMicronutrientInsights(); } catch(e) {}
        try { if (typeof checkMealBadges === 'function') checkMealBadges(); } catch(e) {}

        showMealAnalysisSuccess({ totals });
    } catch (error) {
        console.error('Error logging barcode meal:', error);
        showToast('Failed to log meal. Please try again.', 'error');
    }

    barcodeProductData = null;
    barcodeServings = 1;
    barcodeAmountMode = 'servings';
    barcodeCustomAmount = '';
}

// Initialize calorie tracker when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Initialize the last date tracker
    const today = getLocalDateString();
    if (!localStorage.getItem('lastCalorieTrackerDate')) {
        localStorage.setItem('lastCalorieTrackerDate', today);
    }

    // Load nutrition data after a short delay to ensure auth is ready
    setTimeout(async () => {
        // Check for daily reset
        checkAndResetNewDay();
        // Recalculate to ensure data is in sync
        await recalculateDailyNutrition();
        // Then load and display
        loadTodayNutrition();
    }, 1000);
});

</script>

<script>
// ==========================================
// SERVICE WORKER MESSAGE HANDLER
// ==========================================
// Listen for messages from service worker (e.g., notification clicks)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'open_approval_modal') {
            // Open the approval modal
            window.openApprovalModal();
        }
    });
}

// Check URL parameters for approval modal trigger
window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('openApproval') === 'true') {
        // Wait a bit for everything to load, then open approval modal
        setTimeout(() => {
            window.openApprovalModal();
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 1000);
    }
});
</script>

<!-- ========================================== -->
<!-- APPROVAL MODAL -->
<!-- ========================================== -->
<div id="approval-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <!-- Header -->
        <div style="padding: 24px; border-bottom: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 1.5rem; color: #1e293b;">Approve Coach Response</h2>
                <button onclick="closeApprovalModal()" style="background: none; border: none; font-size: 1.5rem; color: #64748b; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
        </div>

        <!-- Content -->
        <div style="padding: 24px;">
            <!-- User Info -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">User:</label>
                <div id="approval-user-name" style="padding: 12px; background: #f1f5f9; border-radius: 8px; color: #1e293b;"></div>
            </div>

            <!-- User Message -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">User Message:</label>
                <div id="approval-user-message" style="padding: 12px; background: #f1f5f9; border-radius: 8px; color: #1e293b; white-space: pre-wrap;"></div>
            </div>

            <!-- AI Response (Editable) -->
            <div style="margin-bottom: 24px;">
                <label for="approval-response-text" style="display: block; font-weight: 600; color: #475569; margin-bottom: 8px;">AI Response (Editable):</label>
                <textarea id="approval-response-text" style="width: 100%; min-height: 200px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 1rem; resize: vertical; box-sizing: border-box;" placeholder="AI response will appear here..."></textarea>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="rejectResponse()" style="padding: 12px 24px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Reject
                </button>
                <button onclick="approveResponse()" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Approve & Send
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preference Wizard Modal -->
<div class="pref-wizard-overlay" id="pref-wizard-overlay">
    <div class="pref-wizard-modal">
        <div class="pref-wizard-header">
            <h2 id="pref-wizard-title">Customize Your Plan</h2>
            <p id="pref-wizard-subtitle">Tell us about your preferences</p>
            <div class="pref-wizard-progress">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
            </div>
        </div>
        <div class="pref-wizard-body">
            <!-- Step 1: Diet Type -->
            <div class="pref-wizard-step active" data-step="1">
                <h3>What's your diet preference?</h3>
                <div class="pref-option-grid">
                    <div class="pref-option" data-value="vegan" onclick="selectPrefOption(this, 'diet')">
                        <div class="option-icon">🌱</div>
                        <div class="option-label">Vegan</div>
                        <div class="option-desc">100% plant-based</div>
                    </div>
                    <div class="pref-option" data-value="vegetarian" onclick="selectPrefOption(this, 'diet')">
                        <div class="option-icon">🥚</div>
                        <div class="option-label">Vegetarian</div>
                        <div class="option-desc">Includes eggs & dairy</div>
                    </div>
                    <div class="pref-option" data-value="pescatarian" onclick="selectPrefOption(this, 'diet')">
                        <div class="option-icon">🐟</div>
                        <div class="option-label">Pescatarian</div>
                        <div class="option-desc">Includes fish & seafood</div>
                    </div>
                    <div class="pref-option" data-value="omnivore" onclick="selectPrefOption(this, 'diet')">
                        <div class="option-icon">🍗</div>
                        <div class="option-label">Omnivore</div>
                        <div class="option-desc">All food groups</div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Allergies/Restrictions -->
            <div class="pref-wizard-step" data-step="2">
                <h3>Any allergies or restrictions?</h3>
                <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;">Select all that apply (or skip if none)</p>
                <div class="pref-checkbox-list" style="justify-content: center;">
                    <div class="pref-checkbox" data-value="gluten" onclick="togglePrefCheckbox(this)">🌾 Gluten-Free</div>
                    <div class="pref-checkbox" data-value="dairy" onclick="togglePrefCheckbox(this)">🥛 Dairy-Free</div>
                    <div class="pref-checkbox" data-value="nuts" onclick="togglePrefCheckbox(this)">🥜 Nut-Free</div>
                    <div class="pref-checkbox" data-value="soy" onclick="togglePrefCheckbox(this)">🫘 Soy-Free</div>
                    <div class="pref-checkbox" data-value="eggs" onclick="togglePrefCheckbox(this)">🥚 Egg-Free</div>
                    <div class="pref-checkbox" data-value="fodmap" onclick="togglePrefCheckbox(this)">🍎 Low FODMAP</div>
                </div>
            </div>

            <!-- Step 3: Cooking Preference -->
            <div class="pref-wizard-step" data-step="3">
                <h3>How much time for cooking?</h3>
                <div class="pref-option-grid">
                    <div class="pref-option" data-value="quick" onclick="selectPrefOption(this, 'time')">
                        <div class="option-icon">⚡</div>
                        <div class="option-label">Quick</div>
                        <div class="option-desc">Under 20 mins</div>
                    </div>
                    <div class="pref-option" data-value="moderate" onclick="selectPrefOption(this, 'time')">
                        <div class="option-icon">⏱️</div>
                        <div class="option-label">Moderate</div>
                        <div class="option-desc">20-40 mins</div>
                    </div>
                    <div class="pref-option" data-value="any" onclick="selectPrefOption(this, 'time')" style="grid-column: span 2;">
                        <div class="option-icon">👨‍🍳</div>
                        <div class="option-label">I Love Cooking</div>
                        <div class="option-desc">Any prep time is fine</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="pref-wizard-footer">
            <button class="pref-wizard-btn secondary" id="pref-wizard-back" onclick="prefWizardBack()">Back</button>
            <button class="pref-wizard-btn primary" id="pref-wizard-next" onclick="prefWizardNext()" disabled>Next</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// PREFERENCE WIZARD LOGIC
// ============================================================

let prefWizardState = {
    currentStep: 1,
    totalSteps: 3,
    planSlug: null,
    preferences: {
        diet: null,
        allergies: [],
        cookingTime: null
    }
};

function openPreferenceWizard(planSlug) {
    prefWizardState = {
        currentStep: 1,
        totalSteps: 3,
        planSlug: planSlug,
        preferences: {
            diet: null,
            allergies: [],
            cookingTime: null
        }
    };

    // Update title with plan name
    const planNames = {
        'summer-shred': 'Summer Shred',
        'clean-bulk': 'Clean Bulk',
        'energy-boost': 'Energy Boost',
        'gut-reset': 'Gut Reset',
        'quick-easy': 'Quick & Easy'
    };
    document.getElementById('pref-wizard-title').textContent = planNames[planSlug] || 'Customize Your Plan';

    // Reset UI
    updatePrefWizardStep(1);
    clearPrefSelections();

    // Show modal
    document.getElementById('pref-wizard-overlay').classList.add('active');
}

function closePrefWizard() {
    document.getElementById('pref-wizard-overlay').classList.remove('active');
}

function updatePrefWizardStep(step) {
    prefWizardState.currentStep = step;

    // Update step dots
    document.querySelectorAll('.pref-wizard-progress .step-dot').forEach(dot => {
        const dotStep = parseInt(dot.dataset.step);
        dot.classList.remove('active', 'completed');
        if (dotStep === step) {
            dot.classList.add('active');
        } else if (dotStep < step) {
            dot.classList.add('completed');
        }
    });

    // Update step content
    document.querySelectorAll('.pref-wizard-step').forEach(stepEl => {
        stepEl.classList.remove('active');
        if (parseInt(stepEl.dataset.step) === step) {
            stepEl.classList.add('active');
        }
    });

    // Update buttons
    const backBtn = document.getElementById('pref-wizard-back');
    const nextBtn = document.getElementById('pref-wizard-next');

    backBtn.style.visibility = step === 1 ? 'hidden' : 'visible';
    nextBtn.textContent = step === prefWizardState.totalSteps ? 'Continue to Checkout' : 'Next';

    // Update next button state
    updatePrefNextButton();
}

function updatePrefNextButton() {
    const nextBtn = document.getElementById('pref-wizard-next');
    const step = prefWizardState.currentStep;

    let isValid = false;
    if (step === 1) {
        isValid = prefWizardState.preferences.diet !== null;
    } else if (step === 2) {
        isValid = true; // Allergies are optional
    } else if (step === 3) {
        isValid = prefWizardState.preferences.cookingTime !== null;
    }

    nextBtn.disabled = !isValid;
}

function selectPrefOption(el, type) {
    // Remove selected from siblings
    el.parentElement.querySelectorAll('.pref-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');

    // Store value
    if (type === 'diet') {
        prefWizardState.preferences.diet = el.dataset.value;
    } else if (type === 'time') {
        prefWizardState.preferences.cookingTime = el.dataset.value;
    }

    updatePrefNextButton();
}

function togglePrefCheckbox(el) {
    el.classList.toggle('selected');

    // Update allergies array
    const value = el.dataset.value;
    const idx = prefWizardState.preferences.allergies.indexOf(value);
    if (idx > -1) {
        prefWizardState.preferences.allergies.splice(idx, 1);
    } else {
        prefWizardState.preferences.allergies.push(value);
    }
}

function clearPrefSelections() {
    document.querySelectorAll('.pref-option, .pref-checkbox').forEach(el => el.classList.remove('selected'));
}

function prefWizardBack() {
    if (prefWizardState.currentStep > 1) {
        updatePrefWizardStep(prefWizardState.currentStep - 1);
    }
}

function prefWizardNext() {
    if (prefWizardState.currentStep < prefWizardState.totalSteps) {
        updatePrefWizardStep(prefWizardState.currentStep + 1);
    } else {
        // Complete - proceed to checkout
        completePrefWizard();
    }
}

function completePrefWizard() {
    // Store preferences
    localStorage.setItem('selected_meal_plan', prefWizardState.planSlug);
    localStorage.setItem('user_food_preferences', JSON.stringify(prefWizardState.preferences));

    closePrefWizard();

    // Proceed to Stripe checkout
    initiateMealPlanCheckout(prefWizardState.planSlug, prefWizardState.preferences);
}

async function initiateMealPlanCheckout(planSlug, preferences) {
    // Native app (App Store / Play Store): use IAP
    if (window.Platform && window.Platform.isNative()) {
        try {
            const result = await purchaseMealPlan(planSlug, preferences);
            if (result && !result.cancelled) {
                showToast('Meal plan unlocked!', 'success');
            }
        } catch (error) {
            console.error('IAP meal plan error:', error);
            alert('Purchase failed. Please try again.');
        }
        return;
    }

    // Web (website): use Stripe
    // Show loading state
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'checkout-loading';
    loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;';
    loadingDiv.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 16px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 15px;">🍽️</div>
            <p style="color: var(--primary); font-weight: 600;">Preparing your checkout...</p>
        </div>
    `;
    document.body.appendChild(loadingDiv);

    try {
        // Get user email if logged in
        const userEmail = window.currentUser?.email || localStorage.getItem('user_email') || null;
        const userId = window.currentUser?.id || localStorage.getItem('user_id') || null;

        // Call the Stripe checkout endpoint
        const response = await fetch('/api/create-meal-plan-checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                planSlug: planSlug,
                email: userEmail,
                userId: userId,
                preferences: preferences
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error?.message || 'Failed to create checkout session');
        }

        // Remove loading
        loadingDiv.remove();

        // Redirect to Stripe checkout
        if (data.url) {
            // Direct URL redirect (preferred)
            window.location.href = data.url;
        } else if (data.sessionId) {
            // Use Stripe.js to redirect (fallback)
            const stripe = Stripe(window.STRIPE_PUBLIC_KEY || 'pk_live_your_key');
            await stripe.redirectToCheckout({ sessionId: data.sessionId });
        } else {
            throw new Error('No checkout URL returned');
        }

    } catch (error) {
        loadingDiv.remove();
        console.error('Checkout error:', error);

        // For development/demo: Allow fallback to demo mode
        if (confirm(`Checkout error: ${error.message}\n\nWould you like to continue in demo mode? (This will simulate a purchase)`)) {
            // Demo mode - mark as purchased locally
            let purchased = [];
            try { purchased = JSON.parse(localStorage.getItem('purchased_meal_plans') || '[]'); } catch(e) {}
            if (!purchased.includes(planSlug)) {
                purchased.push(planSlug);
                localStorage.setItem('purchased_meal_plans', JSON.stringify(purchased));
            }
            localStorage.setItem('user_food_preferences', JSON.stringify(preferences));

            alert('Demo purchase successful! Refreshing your meal plan view...');
            initializeMealPlanView();
        }
    }
}

// Close wizard on overlay click
document.getElementById('pref-wizard-overlay')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closePrefWizard();
    }
});
</script>

<!-- PROGRAM BUILDER VIEW - Build Your Own Multi-Week Workout Program -->
<div id="view-program-builder" class="app-view" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#f8fafc; z-index:100001; overflow-y:auto; padding-bottom: 120px;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
        <button onclick="closeProgramBuilder()" style="width: 40px; height: 40px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-main);"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
        <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main);">Build Your Program</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 20px;">
        <!-- Program Name -->
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 700; color: var(--text-main); margin-bottom: 8px; font-size: 0.9rem;">Program Name</label>
            <input type="text" id="program-name-input" placeholder="e.g., My 6-Week Challenge"
                   style="width: 100%; padding: 15px; border-radius: 16px; border: 1px solid #e2e8f0; font-size: 1rem; background: white;">
        </div>

        <!-- Duration Selection -->
        <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: 700; color: var(--text-main); margin-bottom: 12px; font-size: 0.9rem;">Program Duration</label>
            <div style="display: flex; gap: 10px;">
                <button onclick="selectProgramDuration(4)" class="duration-btn" data-weeks="4" style="flex: 1; padding: 18px 12px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                    <div style="font-weight: 800; font-size: 1.4rem; color: var(--primary);">4</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">weeks</div>
                </button>
                <button onclick="selectProgramDuration(6)" class="duration-btn" data-weeks="6" style="flex: 1; padding: 18px 12px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                    <div style="font-weight: 800; font-size: 1.4rem; color: var(--primary);">6</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">weeks</div>
                </button>
                <button onclick="selectProgramDuration(8)" class="duration-btn" data-weeks="8" style="flex: 1; padding: 18px 12px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                    <div style="font-weight: 800; font-size: 1.4rem; color: var(--primary);">8</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">weeks</div>
                </button>
            </div>
        </div>

        <!-- Weekly Schedule -->
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 700; color: var(--text-main); margin-bottom: 12px; font-size: 0.9rem;">Weekly Schedule</label>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0 0 15px 0;">Tap each day to assign a workout. This schedule repeats each week.</p>

            <div id="program-weekly-schedule" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Days will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; background: white; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 100;">
        <button onclick="saveProgramBuilder()" id="save-program-btn" style="width: 100%; background: var(--primary); color: white; padding: 18px; border-radius: 50px; font-weight: 800; border: none; font-size: 1.1rem; cursor: pointer; opacity: 0.5;" disabled>
            Save Program
        </button>
    </div>
</div>

<!-- Workout Picker Modal for Program Builder -->
<div id="workout-picker-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100002; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-height: 80vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="font-weight: 700; font-size: 1.1rem;">Select Workout for <span id="picker-day-name">Monday</span></div>
            <button onclick="closeWorkoutPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <!-- Rest Day Option -->
        <div onclick="selectWorkoutForDay('rest', 'Rest Day', null)" style="background: #f1f5f9; border-radius: 16px; padding: 16px; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
                😴
            </div>
            <div>
                <div style="font-weight: 700; color: var(--text-main);">Rest Day</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">Recovery and regeneration</div>
            </div>
        </div>

        <!-- Your Custom Workouts Section -->
        <div id="picker-custom-workouts-section" style="margin-bottom: 15px; display: none;">
            <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">🛠️</span> Your Custom Workouts
            </div>
            <div id="picker-custom-workouts-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Custom workouts will be rendered here -->
            </div>
        </div>

        <!-- Workout Library Section -->
        <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.1rem;">📚</span> Workout Library
        </div>
        <div id="workout-picker-categories" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Categories will be rendered here -->
        </div>
    </div>
</div>

<!-- Workout Subcategory Picker -->
<div id="workout-subcategory-picker" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100003; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-height: 80vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToWorkoutPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;" id="subcategory-picker-title">Select Workout</div>
            <button onclick="closeSubcategoryPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div id="workout-subcategory-list" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Subcategories will be rendered here -->
        </div>
    </div>
</div>

<!-- Calendar Workout Action Modal - Shows when clicking calendar workout -->
<div id="calendar-workout-action-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100002; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="font-weight: 700; font-size: 1.1rem;" id="action-modal-title">Workout Options</div>
            <button onclick="closeCalendarActionModal()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <!-- Current Workout Info -->
        <div id="action-modal-current-workout" style="background: #f8fafc; border-radius: 16px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Currently scheduled:</div>
            <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;" id="action-modal-workout-name">Loading...</div>
        </div>

        <!-- Replacement Active Notice (hidden by default) -->
        <div id="action-modal-replacement-notice" style="display: none; background: #fef3c7; border-radius: 16px; padding: 16px; margin-bottom: 20px; border: 1px solid #f59e0b;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.2rem;">🔄</span>
                <div>
                    <div style="font-weight: 600; color: #92400e; font-size: 0.9rem;">Replacement Active</div>
                    <div style="font-size: 0.85rem; color: #a16207;" id="replacement-notice-text">Ends in X weeks</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Start Workout Button -->
            <button onclick="startWorkoutFromActionModal()" style="background: var(--primary); color: white; border: none; border-radius: 16px; padding: 18px; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: white;"><path d="M8 5v14l11-7z"/></svg>
                Start Workout
            </button>

            <!-- Replace Workout Button -->
            <button onclick="openReplacementPicker()" style="background: white; color: var(--primary); border: 2px solid var(--primary); border-radius: 16px; padding: 16px; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: var(--primary);"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg>
                Replace This Workout
            </button>

            <!-- Remove Replacement Button (only shown if replacement is active) -->
            <button id="remove-replacement-btn" onclick="removeCurrentReplacement()" style="display: none; background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; border-radius: 16px; padding: 14px; font-weight: 600; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #dc2626;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                Remove Replacement
            </button>
        </div>
    </div>
</div>

<!-- Replacement Workout Picker Modal -->
<div id="replacement-picker-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100003; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; max-height: 85vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToActionModal()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;">Choose Replacement</div>
            <button onclick="closeReplacementPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <!-- Rest Day Option -->
        <div onclick="selectReplacementWorkout('rest', 'Rest Day', null)" style="background: #f1f5f9; border-radius: 16px; padding: 16px; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
                😴
            </div>
            <div>
                <div style="font-weight: 700; color: var(--text-main);">Rest Day</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">Take a recovery day</div>
            </div>
        </div>

        <!-- Custom Workouts Section -->
        <div id="replacement-custom-section" style="margin-bottom: 15px; display: none;">
            <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">🛠️</span> Your Custom Workouts
            </div>
            <div id="replacement-custom-list" style="display: flex; flex-direction: column; gap: 10px;">
            </div>
        </div>

        <!-- Library Categories Section -->
        <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.1rem;">📚</span> Workout Library
        </div>
        <div id="replacement-categories" style="display: flex; flex-direction: column; gap: 10px;">
        </div>
    </div>
</div>

<!-- Replacement Subcategory Picker -->
<div id="replacement-subcategory-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100004; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; max-height: 85vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToReplacementPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;" id="replacement-subcategory-title">Select Workout</div>
            <button onclick="closeReplacementSubcategory()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div id="replacement-subcategory-list" style="display: flex; flex-direction: column; gap: 10px;">
        </div>
    </div>
</div>

<!-- Replacement Duration Picker Modal -->
<div id="replacement-duration-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100005; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 24px; width: 90%; max-width: 400px; padding: 24px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-weight: 800; font-size: 1.2rem; color: var(--text-main); margin-bottom: 8px;">How Long?</div>
            <div style="font-size: 0.9rem; color: var(--text-muted);">How many weeks should this replacement last?</div>
        </div>

        <div id="replacement-selected-workout" style="background: #f8fafc; border-radius: 12px; padding: 12px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 0.8rem; color: var(--text-muted);">Replacing with:</div>
            <div style="font-weight: 700; color: var(--text-main);" id="duration-workout-name">Workout Name</div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
            <button onclick="selectReplacementDuration(1)" class="duration-option-btn" data-weeks="1" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">1</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">week</div>
            </button>
            <button onclick="selectReplacementDuration(2)" class="duration-option-btn" data-weeks="2" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">2</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
            <button onclick="selectReplacementDuration(3)" class="duration-option-btn" data-weeks="3" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">3</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
            <button onclick="selectReplacementDuration(4)" class="duration-option-btn" data-weeks="4" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">4</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
            <button onclick="selectReplacementDuration(6)" class="duration-option-btn" data-weeks="6" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">6</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
            <button onclick="selectReplacementDuration(8)" class="duration-option-btn" data-weeks="8" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">8</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="closeDurationModal()" style="flex: 1; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; background: white; color: var(--text-muted); font-weight: 600; cursor: pointer;">
                Cancel
            </button>
            <button onclick="confirmReplacement()" id="confirm-replacement-btn" style="flex: 2; padding: 14px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: 700; cursor: pointer; opacity: 0.5;" disabled>
                Confirm Replacement
            </button>
        </div>
    </div>
</div>

<!-- Workout Variations List Modal - Shows all variations in a subcategory -->
<div id="workout-variations-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100006; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; max-height: 85vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="closeVariationsModal()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;" id="variations-modal-title">Back Day</div>
            <button onclick="closeAllVariationsModals()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div id="variations-list" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Variations will be rendered here -->
        </div>
    </div>
</div>

<!-- Workout Exercises Modal - Shows exercises in a specific workout -->
<div id="workout-exercises-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100007; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; max-height: 85vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="closeExercisesModal()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;" id="exercises-modal-title">Back 1</div>
            <button onclick="closeAllVariationsModals()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <!-- Workout Info -->
        <div id="exercises-workout-info" style="background: #f8fafc; border-radius: 12px; padding: 14px; margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
            <div id="exercises-duration" style="font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px;">
                <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--text-muted);"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                <span>45 min</span>
            </div>
            <div id="exercises-difficulty" style="font-size: 0.85rem; color: var(--text-muted);">Intermediate</div>
        </div>

        <!-- Exercise List -->
        <div id="exercises-list" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
            <!-- Exercises will be rendered here -->
        </div>

        <!-- Select Button -->
        <button onclick="selectPreviewedWorkout()" id="select-workout-btn" style="width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--primary); color: white; font-weight: 700; font-size: 1rem; cursor: pointer;">
            Select This Workout
        </button>
    </div>
</div>

<script>
// Program Builder State
let programBuilderState = {
    name: '',
    durationWeeks: 4,
    weeklySchedule: [
        { day: 'Mon', workout: null },
        { day: 'Tue', workout: null },
        { day: 'Wed', workout: null },
        { day: 'Thu', workout: null },
        { day: 'Fri', workout: null },
        { day: 'Sat', workout: null },
        { day: 'Sun', workout: null }
    ],
    currentPickerDayIndex: null
};

// Day names for display
const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

// ============================================
// WORKOUT PREVIEW FEATURE (Simplified)
// ============================================

// Workout Preview State
let workoutPreviewState = {
    mode: null, // 'replacement' or 'programBuilder'
    category: null,
    subcategory: null,
    subcategoryName: null,
    icon: null,
    selectedWorkout: null,
    allWorkouts: []
};

// Open variations list when clicking a subcategory
window.openWorkoutPreview = function(mode, categoryKey, subcategoryKey, subcategoryName, icon) {
    const category = WORKOUT_LIBRARY[categoryKey];
    if (!category || !category.subcategories) return;

    const subcategory = category.subcategories[subcategoryKey];
    if (!subcategory || !subcategory.workouts || subcategory.workouts.length === 0) {
        showToast('No workouts available for this category');
        return;
    }

    // Store state
    workoutPreviewState = {
        mode: mode,
        category: categoryKey,
        subcategory: subcategoryKey,
        subcategoryName: subcategoryName,
        icon: icon,
        selectedWorkout: null,
        allWorkouts: subcategory.workouts
    };

    // Update title
    document.getElementById('variations-modal-title').textContent = subcategoryName;

    // Render variations list
    const container = document.getElementById('variations-list');
    container.innerHTML = subcategory.workouts.map((workout, index) => `
        <div onclick="openExercisesList(${index})" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9;">
            <div style="width: 44px; height: 44px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem;">
                ${icon}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text-main);">${workout.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${workout.exercises?.length || 0} exercises · ${workout.duration || '45 min'}</div>
            </div>
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
        </div>
    `).join('');

    // Hide previous modals
    if (mode === 'replacement') {
        document.getElementById('replacement-subcategory-modal').style.display = 'none';
    } else if (mode === 'programBuilder') {
        document.getElementById('workout-subcategory-picker').style.display = 'none';
    }

    // Show variations modal
    document.getElementById('workout-variations-modal').style.display = 'flex';
};

// Open exercises list for a specific workout
window.openExercisesList = function(workoutIndex) {
    const workout = workoutPreviewState.allWorkouts[workoutIndex];
    if (!workout) return;

    workoutPreviewState.selectedWorkout = workout;

    // Update title
    document.getElementById('exercises-modal-title').textContent = workout.name;

    // Update workout info
    document.getElementById('exercises-duration').innerHTML = `
        <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--text-muted);"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
        <span>${workout.duration || '45 min'}</span>
    `;
    document.getElementById('exercises-difficulty').textContent = workout.difficulty || 'Intermediate';

    // Render exercises
    const container = document.getElementById('exercises-list');
    const exercises = workout.exercises || [];

    container.innerHTML = exercises.map((ex, index) => `
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 14px; display: flex; align-items: center; gap: 12px;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), #22c55e); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85rem; flex-shrink: 0;">
                ${index + 1}
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">${ex.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${ex.sets} sets × ${ex.reps}</div>
            </div>
        </div>
    `).join('');

    // Update button text
    const btn = document.getElementById('select-workout-btn');
    btn.textContent = workoutPreviewState.mode === 'replacement' ? 'Select This Workout' : 'Add This Workout';

    // Hide variations modal and show exercises modal
    document.getElementById('workout-variations-modal').style.display = 'none';
    document.getElementById('workout-exercises-modal').style.display = 'flex';
};

// Close variations modal and go back to subcategory
window.closeVariationsModal = function() {
    document.getElementById('workout-variations-modal').style.display = 'none';

    // Re-open the subcategory modal
    if (workoutPreviewState.mode === 'replacement') {
        document.getElementById('replacement-subcategory-modal').style.display = 'flex';
    } else if (workoutPreviewState.mode === 'programBuilder') {
        document.getElementById('workout-subcategory-picker').style.display = 'flex';
    }
};

// Close exercises modal and go back to variations
window.closeExercisesModal = function() {
    document.getElementById('workout-exercises-modal').style.display = 'none';
    document.getElementById('workout-variations-modal').style.display = 'flex';
};

// Close all preview-related modals
window.closeAllVariationsModals = function() {
    document.getElementById('workout-exercises-modal').style.display = 'none';
    document.getElementById('workout-variations-modal').style.display = 'none';
    document.getElementById('replacement-subcategory-modal').style.display = 'none';
    document.getElementById('replacement-picker-modal').style.display = 'none';
    document.getElementById('workout-subcategory-picker').style.display = 'none';
    document.getElementById('workout-picker-modal').style.display = 'none';
    document.getElementById('calendar-workout-action-modal').style.display = 'none';
};

// Select the previewed workout
window.selectPreviewedWorkout = function() {
    const { mode, subcategoryName, category, subcategory, icon } = workoutPreviewState;

    // Close all modals
    closeAllVariationsModals();

    if (mode === 'replacement') {
        // For replacement mode, proceed to duration picker
        selectReplacementWorkout('library', subcategoryName, {
            category: category,
            subcategory: subcategory,
            icon: icon
        });
    } else if (mode === 'programBuilder') {
        // For program builder mode, select the workout for the day
        selectWorkoutForDay('library', subcategoryName, {
            category: category,
            subcategory: subcategory,
            icon: icon
        });
    }
};

// ============================================
// END WORKOUT PREVIEW FEATURE
// ============================================

function openProgramBuilder() {
    // Reset state
    programBuilderState = {
        name: '',
        durationWeeks: 4,
        weeklySchedule: [
            { day: 'Mon', workout: null },
            { day: 'Tue', workout: null },
            { day: 'Wed', workout: null },
            { day: 'Thu', workout: null },
            { day: 'Fri', workout: null },
            { day: 'Sat', workout: null },
            { day: 'Sun', workout: null }
        ],
        currentPickerDayIndex: null
    };

    // Reset UI
    document.getElementById('program-name-input').value = '';
    selectProgramDuration(4);
    renderWeeklyScheduleBuilder();
    updateSaveButtonState();

    // Show view
    hideAllAppViews();
    document.getElementById('view-program-builder').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    if (typeof pushNavigationState === 'function') {
        pushNavigationState('view-program-builder', () => closeProgramBuilder());
    }
}

function closeProgramBuilder() {
    document.getElementById('view-program-builder').style.display = 'none';
    closeWorkoutPicker();
    closeSubcategoryPicker();
    switchAppTab('movement-tab');
}

function selectProgramDuration(weeks) {
    programBuilderState.durationWeeks = weeks;

    // Update UI
    document.querySelectorAll('.duration-btn').forEach(btn => {
        const btnWeeks = parseInt(btn.dataset.weeks);
        if (btnWeeks === weeks) {
            btn.style.borderColor = 'var(--primary)';
            btn.style.background = 'rgba(4, 106, 56, 0.05)';
        } else {
            btn.style.borderColor = '#e2e8f0';
            btn.style.background = 'white';
        }
    });
}

function renderWeeklyScheduleBuilder() {
    const container = document.getElementById('program-weekly-schedule');
    if (!container) return;

    container.innerHTML = programBuilderState.weeklySchedule.map((scheduleItem, index) => {
        const workout = scheduleItem.workout;
        const isRest = workout && workout.type === 'rest';
        const hasWorkout = workout && workout.type !== 'rest';

        let workoutDisplay = '';
        if (isRest) {
            workoutDisplay = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">😴</span>
                    <span style="font-weight: 600; color: var(--text-muted);">Rest Day</span>
                </div>`;
        } else if (hasWorkout) {
            workoutDisplay = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">${workout.icon || '💪'}</span>
                    <div>
                        <div style="font-weight: 600; color: var(--text-main); font-size: 0.9rem;">${workout.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${workout.category || ''}</div>
                    </div>
                </div>`;
        } else {
            workoutDisplay = `
                <div style="color: var(--text-muted); font-size: 0.9rem;">Tap to assign workout</div>`;
        }

        return `
            <div onclick="openWorkoutPickerForDay(${index})" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid ${hasWorkout || isRest ? 'var(--primary)' : '#e2e8f0'}; ${hasWorkout || isRest ? 'border-left: 4px solid var(--primary);' : ''}">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; font-weight: 800; color: var(--primary); font-size: 0.95rem;">${scheduleItem.day}</div>
                    ${workoutDisplay}
                </div>
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8; flex-shrink: 0;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
        `;
    }).join('');
}

function openWorkoutPickerForDay(dayIndex) {
    programBuilderState.currentPickerDayIndex = dayIndex;
    document.getElementById('picker-day-name').textContent = dayNames[dayIndex];

    // Render custom workouts (if any)
    renderPickerCustomWorkouts();

    // Render workout categories
    renderWorkoutPickerCategories();

    // Show modal
    const modal = document.getElementById('workout-picker-modal');
    modal.style.display = 'flex';
}

async function renderPickerCustomWorkouts() {
    const section = document.getElementById('picker-custom-workouts-section');
    const container = document.getElementById('picker-custom-workouts-list');
    if (!section || !container) return;

    try {
        // Use cached workouts if available, otherwise fetch
        let customWorkouts = window.savedWorkoutsCache;

        if (!customWorkouts) {
            const user = window.currentUser;
            if (user && typeof dbHelpers !== 'undefined' && dbHelpers.workouts) {
                customWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
                window.savedWorkoutsCache = customWorkouts;
            }
        }

        if (!customWorkouts || customWorkouts.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        container.innerHTML = customWorkouts.map(w => {
            const name = w.template_name || 'Untitled Workout';
            const exercises = w.template_data?.exercises || [];

            return `
                <div onclick="selectWorkoutForDay('custom', '${name.replace(/'/g, "\\'")}', { customWorkoutId: '${w.id}', exerciseCount: ${exercises.length} })"
                     style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #22c55e); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 1rem;">
                        ${name.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: var(--text-main);">${name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${exercises.length} exercises</div>
                    </div>
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--primary);"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error('renderPickerCustomWorkouts: Error', err);
        section.style.display = 'none';
    }
}

function closeWorkoutPicker() {
    document.getElementById('workout-picker-modal').style.display = 'none';
    programBuilderState.currentPickerDayIndex = null;
}

function renderWorkoutPickerCategories() {
    const container = document.getElementById('workout-picker-categories');
    if (!container || typeof WORKOUT_LIBRARY === 'undefined') {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Workout library not available</div>';
        return;
    }

    const categoryIcons = {
        'gym': '🏋️',
        'yoga': '🧘',
        'bodyweight': '💪',
        'home': '🏠',
        'cardio': '🏃',
        'hiit': '⚡',
        'bands': '🎯'
    };

    const categoryNames = {
        'gym': 'Gym Workouts',
        'yoga': 'Yoga & Recovery',
        'bodyweight': 'Bodyweight',
        'home': 'Home (Dumbbells)',
        'cardio': 'Cardio',
        'hiit': 'HIIT',
        'bands': 'Resistance Bands'
    };

    const categories = Object.keys(WORKOUT_LIBRARY);

    container.innerHTML = categories.map(categoryKey => {
        const category = WORKOUT_LIBRARY[categoryKey];
        const subcategoryCount = Object.keys(category.subcategories || {}).length;

        return `
            <div onclick="openSubcategoryPicker('${categoryKey}')" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #22c55e); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
                    ${categoryIcons[categoryKey] || '💪'}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--text-main);">${categoryNames[categoryKey] || category.name || categoryKey}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">${subcategoryCount} workout types</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
        `;
    }).join('');
}

function openSubcategoryPicker(categoryKey) {
    const category = WORKOUT_LIBRARY[categoryKey];
    if (!category || !category.subcategories) return;

    document.getElementById('subcategory-picker-title').textContent = category.name || categoryKey;

    const container = document.getElementById('workout-subcategory-list');
    const subcategories = category.subcategories;

    const subcategoryIcons = {
        'back': '🔙', 'chest': '💪', 'legs': '🦵', 'shoulders': '🏋️', 'arms': '💪', 'core': '🎯',
        'push': '👐', 'pull': '🤲', 'lowerbody': '🦵', 'upperbody': '💪',
        'power': '⚡', 'yin': '🧘', 'restorative': '😌', 'flow': '🌊',
        'fullbody': '🏃', 'tabata': '🔥', 'armscore': '💪'
    };

    container.innerHTML = Object.keys(subcategories).map(subKey => {
        const sub = subcategories[subKey];
        const workoutCount = sub.workouts?.length || 0;
        const icon = subcategoryIcons[subKey] || '💪';
        const subName = sub.name || subKey;

        return `
            <div onclick="openWorkoutPreview('programBuilder', '${categoryKey}', '${subKey}', '${subName.replace(/'/g, "\\'")}', '${icon}')"
                 style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9;">
                <div style="width: 44px; height: 44px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem;">
                    ${icon}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-main);">${subName}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">${workoutCount} variations</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
        `;
    }).join('');

    // Show subcategory picker
    document.getElementById('workout-subcategory-picker').style.display = 'flex';
}

function closeSubcategoryPicker() {
    document.getElementById('workout-subcategory-picker').style.display = 'none';
}

function backToWorkoutPicker() {
    closeSubcategoryPicker();
}

function selectWorkoutForDay(type, name, data) {
    const dayIndex = programBuilderState.currentPickerDayIndex;
    if (dayIndex === null) return;

    if (type === 'rest') {
        programBuilderState.weeklySchedule[dayIndex].workout = {
            type: 'rest',
            name: 'Rest Day'
        };
    } else if (type === 'custom') {
        // Custom workout from user's saved workouts
        programBuilderState.weeklySchedule[dayIndex].workout = {
            type: 'custom',
            name: name,
            customWorkoutId: data?.customWorkoutId || '',
            exerciseCount: data?.exerciseCount || 0,
            icon: '🛠️'
        };
    } else {
        // Library workout
        programBuilderState.weeklySchedule[dayIndex].workout = {
            type: type,
            name: name,
            category: data?.category || '',
            subcategory: data?.subcategory || '',
            icon: data?.icon || '💪'
        };
    }

    // Update UI
    renderWeeklyScheduleBuilder();
    updateSaveButtonState();

    // Close pickers
    closeSubcategoryPicker();
    closeWorkoutPicker();
}

function updateSaveButtonState() {
    const nameInput = document.getElementById('program-name-input');
    const saveBtn = document.getElementById('save-program-btn');

    const hasName = nameInput.value.trim().length > 0;
    const hasAtLeastOneWorkout = programBuilderState.weeklySchedule.some(s => s.workout !== null);

    if (hasName && hasAtLeastOneWorkout) {
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';
    } else {
        saveBtn.disabled = true;
        saveBtn.style.opacity = '0.5';
    }
}

// Listen for name input changes
document.getElementById('program-name-input')?.addEventListener('input', function() {
    programBuilderState.name = this.value.trim();
    updateSaveButtonState();
});

async function saveProgramBuilder() {
    const nameInput = document.getElementById('program-name-input');
    const programName = nameInput.value.trim();

    if (!programName) {
        alert('Please enter a program name');
        return;
    }

    const hasWorkouts = programBuilderState.weeklySchedule.some(s => s.workout !== null);
    if (!hasWorkouts) {
        alert('Please assign at least one workout to your program');
        return;
    }

    try {
        const user = window.currentUser;
        if (!user) {
            alert('Please log in to save your program');
            return;
        }

        // Save to database
        const programData = {
            name: programName,
            durationWeeks: programBuilderState.durationWeeks,
            weeklySchedule: programBuilderState.weeklySchedule
        };

        const savedProgram = await dbHelpers.customPrograms.create(user.id, programData);

        // Ask if user wants to activate the program
        const startNow = confirm(`Program "${programName}" saved!\n\nWould you like to start this program now? It will replace your current workout schedule.`);

        if (startNow) {
            await dbHelpers.customPrograms.activate(user.id, savedProgram.id);
            alert(`Program activated! Your ${programBuilderState.durationWeeks}-week program starts today.`);
        }

        // Close and refresh
        closeProgramBuilder();

        if (typeof renderMovementView === 'function') {
            renderMovementView();
        }
        if (typeof renderWeeklyCalendar === 'function') {
            renderWeeklyCalendar();
        }

    } catch (error) {
        console.error('Failed to save program:', error);
        alert('Failed to save program. Please try again.');
    }
}

// Initialize name input listener on page load
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('program-name-input');
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            programBuilderState.name = this.value.trim();
            updateSaveButtonState();
        });
    }
});

// ============================================================
// WORKOUT REPLACEMENT FEATURE
// ============================================================

// State for workout replacement
let workoutReplacementState = {
    dayIndex: null,           // Day of week being replaced (0 = Monday)
    currentWorkoutName: '',   // Original workout name
    selectedWorkout: null,    // Selected replacement workout
    selectedDuration: null,   // Selected duration in weeks
    currentReplacement: null  // Existing replacement (if any)
};

// Cache for active replacements (refreshed when needed)
let activeReplacementsCache = null;

// Load active replacements from database
async function loadActiveReplacements() {
    try {
        const user = window.currentUser;
        if (!user || !dbHelpers?.workoutReplacements) {
            activeReplacementsCache = [];
            return [];
        }
        activeReplacementsCache = await dbHelpers.workoutReplacements.getActive(user.id);
        return activeReplacementsCache;
    } catch (err) {
        console.error('loadActiveReplacements error:', err);
        activeReplacementsCache = [];
        return [];
    }
}

// Get replacement for a specific day (from cache)
function getReplacementForDay(dayIndex) {
    if (!activeReplacementsCache) return null;
    return activeReplacementsCache.find(r => r.day_of_week === dayIndex) || null;
}

// Open the calendar action modal when clicking a workout on the calendar
window.openCalendarActionModal = async function(dayIndex, workoutName) {
    workoutReplacementState.dayIndex = dayIndex;
    workoutReplacementState.currentWorkoutName = workoutName;
    workoutReplacementState.selectedWorkout = null;
    workoutReplacementState.selectedDuration = null;

    // Update modal title
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    document.getElementById('action-modal-title').textContent = dayNames[dayIndex];
    document.getElementById('action-modal-workout-name').textContent = workoutName;

    // Check for existing replacement
    await loadActiveReplacements();
    const existingReplacement = getReplacementForDay(dayIndex);
    workoutReplacementState.currentReplacement = existingReplacement;

    const noticeEl = document.getElementById('action-modal-replacement-notice');
    const removeBtn = document.getElementById('remove-replacement-btn');

    if (existingReplacement) {
        // Calculate weeks remaining
        const endDate = new Date(existingReplacement.end_date);
        const today = new Date();
        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
        const weeksRemaining = Math.ceil((endDate - today) / msPerWeek);

        document.getElementById('replacement-notice-text').textContent =
            weeksRemaining <= 1 ? 'Ends this week' : `${weeksRemaining} weeks remaining`;
        noticeEl.style.display = 'block';
        removeBtn.style.display = 'flex';
    } else {
        noticeEl.style.display = 'none';
        removeBtn.style.display = 'none';
    }

    // Show modal
    document.getElementById('calendar-workout-action-modal').style.display = 'flex';
};

// Close the action modal
window.closeCalendarActionModal = function() {
    document.getElementById('calendar-workout-action-modal').style.display = 'none';
    workoutReplacementState.dayIndex = null;
};

// Start workout from action modal (delegates to existing function)
window.startWorkoutFromActionModal = function() {
    closeCalendarActionModal();
    if (typeof openCalendarWorkout === 'function') {
        openCalendarWorkout(workoutReplacementState.dayIndex);
    }
};

// Open replacement picker
window.openReplacementPicker = function() {
    document.getElementById('calendar-workout-action-modal').style.display = 'none';

    // Render custom workouts
    renderReplacementCustomWorkouts();

    // Render library categories
    renderReplacementCategories();

    document.getElementById('replacement-picker-modal').style.display = 'flex';
};

// Close replacement picker
window.closeReplacementPicker = function() {
    document.getElementById('replacement-picker-modal').style.display = 'none';
    closeReplacementSubcategory();
    closeDurationModal();
};

// Back to action modal from replacement picker
window.backToActionModal = function() {
    document.getElementById('replacement-picker-modal').style.display = 'none';
    document.getElementById('calendar-workout-action-modal').style.display = 'flex';
};

// Render custom workouts for replacement picker
async function renderReplacementCustomWorkouts() {
    const section = document.getElementById('replacement-custom-section');
    const container = document.getElementById('replacement-custom-list');
    if (!section || !container) return;

    try {
        let customWorkouts = window.savedWorkoutsCache;

        if (!customWorkouts) {
            const user = window.currentUser;
            if (user && dbHelpers?.workouts) {
                customWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
                window.savedWorkoutsCache = customWorkouts;
            }
        }

        if (!customWorkouts || customWorkouts.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        container.innerHTML = customWorkouts.map(w => {
            const name = w.template_name || 'Untitled Workout';
            const exercises = w.template_data?.exercises || [];

            return `
                <div onclick="selectReplacementWorkout('custom', '${name.replace(/'/g, "\\'")}', { customWorkoutId: '${w.id}', exerciseCount: ${exercises.length} })"
                     style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #22c55e); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 1rem;">
                        ${name.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: var(--text-main);">${name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${exercises.length} exercises</div>
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error('renderReplacementCustomWorkouts error:', err);
        section.style.display = 'none';
    }
}

// Render workout library categories for replacement picker
function renderReplacementCategories() {
    const container = document.getElementById('replacement-categories');
    if (!container || typeof WORKOUT_LIBRARY === 'undefined') {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Workout library not available</div>';
        return;
    }

    const categoryIcons = {
        'gym': '🏋️', 'yoga': '🧘', 'bodyweight': '💪', 'home': '🏠',
        'cardio': '🏃', 'hiit': '⚡', 'bands': '🎯'
    };

    const categoryNames = {
        'gym': 'Gym Workouts', 'yoga': 'Yoga & Recovery', 'bodyweight': 'Bodyweight',
        'home': 'Home (Dumbbells)', 'cardio': 'Cardio', 'hiit': 'HIIT', 'bands': 'Resistance Bands'
    };

    const categories = Object.keys(WORKOUT_LIBRARY);

    container.innerHTML = categories.map(categoryKey => {
        const category = WORKOUT_LIBRARY[categoryKey];
        const subcategoryCount = Object.keys(category.subcategories || {}).length;

        return `
            <div onclick="openReplacementSubcategory('${categoryKey}')" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #22c55e); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
                    ${categoryIcons[categoryKey] || '💪'}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--text-main);">${categoryNames[categoryKey] || category.name || categoryKey}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">${subcategoryCount} workout types</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
        `;
    }).join('');
}

// Open subcategory picker for replacement
window.openReplacementSubcategory = function(categoryKey) {
    const category = WORKOUT_LIBRARY[categoryKey];
    if (!category || !category.subcategories) return;

    document.getElementById('replacement-subcategory-title').textContent = category.name || categoryKey;

    const container = document.getElementById('replacement-subcategory-list');
    const subcategories = category.subcategories;

    const subcategoryIcons = {
        'back': '🔙', 'chest': '💪', 'legs': '🦵', 'shoulders': '🏋️', 'arms': '💪', 'core': '🎯',
        'push': '👐', 'pull': '🤲', 'lowerbody': '🦵', 'upperbody': '💪',
        'power': '⚡', 'yin': '🧘', 'restorative': '😌', 'flow': '🌊',
        'fullbody': '🏃', 'tabata': '🔥', 'armscore': '💪'
    };

    container.innerHTML = Object.keys(subcategories).map(subKey => {
        const sub = subcategories[subKey];
        const workoutCount = sub.workouts?.length || 0;
        const icon = subcategoryIcons[subKey] || '💪';
        const subName = sub.name || subKey;

        return `
            <div onclick="openWorkoutPreview('replacement', '${categoryKey}', '${subKey}', '${subName.replace(/'/g, "\\'")}', '${icon}')"
                 style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9;">
                <div style="width: 44px; height: 44px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem;">
                    ${icon}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-main);">${subName}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">${workoutCount} variations</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
        `;
    }).join('');

    document.getElementById('replacement-subcategory-modal').style.display = 'flex';
};

// Close replacement subcategory picker
window.closeReplacementSubcategory = function() {
    document.getElementById('replacement-subcategory-modal').style.display = 'none';
};

// Back to replacement picker from subcategory
window.backToReplacementPicker = function() {
    closeReplacementSubcategory();
};

// Select a workout for replacement (then show duration picker)
window.selectReplacementWorkout = function(type, name, data) {
    workoutReplacementState.selectedWorkout = { type, name, data };
    workoutReplacementState.selectedDuration = null;

    // Close previous modals
    document.getElementById('replacement-picker-modal').style.display = 'none';
    closeReplacementSubcategory();

    // Update duration modal with selected workout name
    document.getElementById('duration-workout-name').textContent = name;

    // Reset duration selection UI
    document.querySelectorAll('.duration-option-btn').forEach(btn => {
        btn.style.borderColor = '#e2e8f0';
        btn.style.background = 'white';
    });
    document.getElementById('confirm-replacement-btn').disabled = true;
    document.getElementById('confirm-replacement-btn').style.opacity = '0.5';

    // Show duration picker
    document.getElementById('replacement-duration-modal').style.display = 'flex';
};

// Select replacement duration
window.selectReplacementDuration = function(weeks) {
    workoutReplacementState.selectedDuration = weeks;

    // Update UI
    document.querySelectorAll('.duration-option-btn').forEach(btn => {
        const btnWeeks = parseInt(btn.dataset.weeks);
        if (btnWeeks === weeks) {
            btn.style.borderColor = 'var(--primary)';
            btn.style.background = 'rgba(4, 106, 56, 0.1)';
        } else {
            btn.style.borderColor = '#e2e8f0';
            btn.style.background = 'white';
        }
    });

    // Enable confirm button
    document.getElementById('confirm-replacement-btn').disabled = false;
    document.getElementById('confirm-replacement-btn').style.opacity = '1';
};

// Close duration modal
window.closeDurationModal = function() {
    document.getElementById('replacement-duration-modal').style.display = 'none';
    // Re-open action modal
    document.getElementById('calendar-workout-action-modal').style.display = 'flex';
};

// Confirm and save the replacement
window.confirmReplacement = async function() {
    const { dayIndex, selectedWorkout, selectedDuration } = workoutReplacementState;

    if (dayIndex === null || !selectedWorkout || !selectedDuration) {
        showToast('Please select a workout and duration');
        return;
    }

    try {
        const user = window.currentUser;
        if (!user) {
            showToast('Please log in to save replacements');
            return;
        }

        // Build replacement workout object
        const workoutData = {
            type: selectedWorkout.type,
            name: selectedWorkout.name,
            ...(selectedWorkout.data || {})
        };

        // Calculate start date (next occurrence of this day)
        const today = new Date();
        const todayDayOfWeek = (today.getDay() + 6) % 7; // Monday = 0
        let daysUntilTarget = dayIndex - todayDayOfWeek;
        if (daysUntilTarget < 0) daysUntilTarget += 7;
        const startDate = new Date(today);
        startDate.setDate(today.getDate() + daysUntilTarget);

        // Delete any existing replacement for this day first
        await dbHelpers.workoutReplacements.deleteForDay(user.id, dayIndex);

        // Create new replacement
        await dbHelpers.workoutReplacements.create(user.id, {
            dayOfWeek: dayIndex,
            workout: workoutData,
            durationWeeks: selectedDuration,
            startDate: startDate.toISOString().split('T')[0]
        });

        // Refresh cache
        await loadActiveReplacements();

        // Close all modals
        closeDurationModal();
        closeCalendarActionModal();

        // Refresh calendar
        if (typeof renderWeeklyCalendar === 'function') {
            renderWeeklyCalendar();
        }
        if (typeof renderMonthlyCalendar === 'function') {
            renderMonthlyCalendar();
        }

        showToast(`Workout replaced for ${selectedDuration} week${selectedDuration > 1 ? 's' : ''}`);

    } catch (err) {
        console.error('confirmReplacement error:', err);
        showToast('Failed to save replacement. Please try again.');
    }
};

// Remove current replacement
window.removeCurrentReplacement = async function() {
    const replacement = workoutReplacementState.currentReplacement;
    if (!replacement) return;

    try {
        await dbHelpers.workoutReplacements.delete(replacement.id);

        // Refresh cache
        await loadActiveReplacements();

        // Close modal
        closeCalendarActionModal();

        // Refresh calendar
        if (typeof renderWeeklyCalendar === 'function') {
            renderWeeklyCalendar();
        }
        if (typeof renderMonthlyCalendar === 'function') {
            renderMonthlyCalendar();
        }

        showToast('Replacement removed');

    } catch (err) {
        console.error('removeCurrentReplacement error:', err);
        showToast('Failed to remove replacement. Please try again.');
    }
};

// Initialize replacements cache on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Load active replacements cache
    setTimeout(() => {
        if (window.currentUser) {
            loadActiveReplacements();
        }
    }, 1000);
});
</script>

    <!-- Tamagotchi Initialization Logic -->
    <script>
    (function() {
        const TAMAGOTCHI_EVOLUTIONS_MALE = [
            { level: 1,  xp: 0,    title: "Hatchling", src: "https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb" },
            { level: 5,  xp: 15,   title: "Newcomer",  src: "https://f005.backblazeb2.com/file/shannonsvideos/level_1_good_final.glb" },
            { level: 10, xp: 46,   title: "Rising",    src: "https://f005.backblazeb2.com/file/shannonsvideos/level_10_real_final.glb" },
            { level: 20, xp: 133,  title: "Growing",   src: "https://f005.backblazeb2.com/file/shannonsvideos/level_20_real_final.glb" },
            { level: 30, xp: 251,  title: "Consistent",src: "https://f005.backblazeb2.com/file/shannonsvideos/level_30_real_final.glb" },
            { level: 40, xp: 393,  title: "Committed", src: "https://f005.backblazeb2.com/file/shannonsvideos/level_40_real_final.glb" },
            { level: 50, xp: 557,  title: "Dedicated", src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_real_final.glb" },
            { level: 60, xp: 739,  title: "Veteran",   src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_real_final.glb" },
            { level: 70, xp: 938,  title: "Expert",    src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_real_final.glb" },
            { level: 80, xp: 1152, title: "Champion",  src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_real_final.glb" },
            { level: 90, xp: 1381, title: "Master",    src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_real_final.glb" },
            { level: 99, xp: 1605, title: "Legend",    src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_real_final.glb" }
        ];

        const TAMAGOTCHI_EVOLUTIONS_FEMALE = [
            { level: 1,  xp: 0,    title: "Hatchling", src: "https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb" },
            { level: 5,  xp: 15,   title: "Newcomer",  src: "https://f005.backblazeb2.com/file/shannonsvideos/level_1_female_final.glb" },
            { level: 10, xp: 46,   title: "Rising",    src: "https://f005.backblazeb2.com/file/shannonsvideos/level_10_female_final.glb" },
            { level: 20, xp: 133,  title: "Growing",   src: "https://f005.backblazeb2.com/file/shannonsvideos/level_20_female_final.glb" },
            { level: 30, xp: 251,  title: "Consistent",src: "https://f005.backblazeb2.com/file/shannonsvideos/level_30_female_final.glb" },
            { level: 40, xp: 393,  title: "Committed", src: "https://f005.backblazeb2.com/file/shannonsvideos/level_40_female_final.glb" },
            { level: 50, xp: 557,  title: "Dedicated", src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_female_final.glb" }
        ];

        // Default to Male for backward compatibility, will be overridden by user fact
        let TAMAGOTCHI_EVOLUTIONS = TAMAGOTCHI_EVOLUTIONS_MALE;

        // Character material mappings for each level model
        // Maps body part names to material indices for color customization
        const CHARACTER_MATERIAL_MAPPINGS = {
            // Dynamic logic used instead
        };

        // Color options for character customization
        const CHARACTER_COLOR_OPTIONS = {
            hair: [
                { name: 'Black', hex: '#1a1a1a' },
                { name: 'Brown', hex: '#4a3728' },
                { name: 'Blonde', hex: '#d4a574' },
                { name: 'Red', hex: '#8b2500' },
                { name: 'Auburn', hex: '#6b3a2e' },
                { name: 'Gray', hex: '#808080' },
                { name: 'Pink', hex: '#ff69b4' },
                { name: 'Blue', hex: '#4169e1' },
                { name: 'Purple', hex: '#8b008b' },
                { name: 'Green', hex: '#228b22' }
            ],
            shirt: [
                { name: 'Green', hex: '#7BA883' },
                { name: 'Blue', hex: '#4A90D9' },
                { name: 'Pink', hex: '#D98B9C' },
                { name: 'Purple', hex: '#9B59B6' },
                { name: 'Orange', hex: '#E67E22' },
                { name: 'Red', hex: '#E74C3C' },
                { name: 'Yellow', hex: '#F1C40F' },
                { name: 'Black', hex: '#2C3E50' },
                { name: 'White', hex: '#ECF0F1' },
                { name: 'Teal', hex: '#16A085' }
            ],
            pants: [
                { name: 'Black', hex: '#2C3E50' },
                { name: 'Navy', hex: '#1a365d' },
                { name: 'Gray', hex: '#718096' },
                { name: 'Green', hex: '#276749' },
                { name: 'Blue', hex: '#2b6cb0' },
                { name: 'Purple', hex: '#6b46c1' },
                { name: 'Red', hex: '#c53030' },
                { name: 'Pink', hex: '#d53f8c' }
            ],
            shoes: [
                { name: 'White', hex: '#f7fafc' },
                { name: 'Black', hex: '#1a202c' },
                { name: 'Gray', hex: '#718096' },
                { name: 'Red', hex: '#e53e3e' },
                { name: 'Blue', hex: '#3182ce' },
                { name: 'Green', hex: '#38a169' },
                { name: 'Pink', hex: '#ed64a6' },
                { name: 'Purple', hex: '#805ad5' }
            ],
            skin: [
                { name: 'Light', hex: '#FFE4C4' },
                { name: 'Fair', hex: '#FFDAB9' },
                { name: 'Medium', hex: '#DEB887' },
                { name: 'Olive', hex: '#C9A86C' },
                { name: 'Tan', hex: '#CD853F' },
                { name: 'Brown', hex: '#A0522D' },
                { name: 'Dark', hex: '#8B4513' },
                { name: 'Deep', hex: '#654321' }
            ]
        };

        // Default character colors
        const DEFAULT_CHARACTER_COLORS = {
            hair: '#4a3728',      // Brown
            shirt: '#7BA883',     // Green
            pants: '#2C3E50',    // Black
            shoes: '#1a202c',     // Black
            skin: '#DEB887'       // Medium
        };

        // Get saved character colors or defaults
        window.getCharacterColors = function() {
            try {
                const saved = localStorage.getItem('characterColors');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading character colors:', e);
            }
            return { ...DEFAULT_CHARACTER_COLORS };
        };

        // Load character colors and gender from database
        window.loadCharacterColorsFromDb = async function() {
            if (!window.currentUser || !window.dbHelpers) return;

            try {
                const userId = window.currentUser.id || window.currentUser.user_id;

                // Get user profile from users table (which has the sex field)
                const userProfile = await window.dbHelpers.users.get(userId);
                const facts = await window.dbHelpers.userFacts.get(userId);

                // Get gender from user profile (users table has the authoritative sex field)
                const userSex = userProfile?.sex || 'female';
                window.currentUserGender = userSex;

                if (userSex.toLowerCase() === 'female') {
                    TAMAGOTCHI_EVOLUTIONS = TAMAGOTCHI_EVOLUTIONS_FEMALE;
                    console.log('Character system: Switched to Female evolution path');
                } else {
                    TAMAGOTCHI_EVOLUTIONS = TAMAGOTCHI_EVOLUTIONS_MALE;
                    console.log('Character system: Switched to Male evolution path');
                }

                // Load character colors from user_facts if available
                if (facts?.additional_data?.character_colors) {
                    const dbColors = facts.additional_data.character_colors;
                    const mergedColors = { ...DEFAULT_CHARACTER_COLORS, ...dbColors };
                    localStorage.setItem('characterColors', JSON.stringify(mergedColors));
                    console.log('Character colors loaded from database:', mergedColors);

                    // Re-apply to model if loaded
                    const modelViewer = document.getElementById('tamagotchi-model');
                    if (modelViewer && modelViewer.model) {
                        window.applyCharacterColors(modelViewer, modelViewer.getAttribute('src'));
                    }
                }
            } catch (e) {
                console.warn('Could not load character colors from database:', e);
            }
        };

        // Save character colors (localStorage and database)
        window.saveCharacterColors = async function(colors) {
            try {
                // Save to localStorage
                localStorage.setItem('characterColors', JSON.stringify(colors));
                console.log('Character colors saved to localStorage:', colors);

                // Save to database if user is logged in
                if (window.currentUser && window.dbHelpers) {
                    const userId = window.currentUser.id || window.currentUser.user_id;
                    try {
                        const existingFacts = await window.dbHelpers.userFacts.get(userId) || {};
                        const currentAdditional = existingFacts.additional_data || {};

                        await window.dbHelpers.userFacts.upsert(userId, {
                            additional_data: {
                                ...currentAdditional,
                                character_colors: colors
                            }
                        });
                        console.log('Character colors saved to database:', colors);
                    } catch (dbErr) {
                        console.warn('Could not save character colors to database:', dbErr);
                    }
                }
            } catch (e) {
                console.error('Error saving character colors:', e);
            }
        };

        // Apply colors to a model-viewer element
        window.applyCharacterColors = async function(modelViewer, modelSrc) {
            if (!modelViewer) return;

            const colors = window.getCharacterColors();
            const modelName = modelSrc ? modelSrc.split('/').pop() : modelViewer.getAttribute('src')?.split('/').pop();
            const mapping = CHARACTER_MATERIAL_MAPPINGS[modelName];

            if (!mapping) {
                console.log('No material mapping found for model:', modelName);
                return;
            }

            // Wait for model to be loaded
            if (!modelViewer.model) {
                await new Promise(resolve => {
                    modelViewer.addEventListener('load', resolve, { once: true });
                });
            }

            const model = modelViewer.model;
            if (!model || !model.materials) {
                console.log('Model or materials not available');
                return;
            }

            console.log('Applying character colors to', modelName, colors);

            // Apply each color to corresponding material
            for (const [part, config] of Object.entries(mapping)) {
                const colorKey = part.replace('Secondary', '').replace('Accent', '');
                const colorHex = colors[colorKey];

                if (colorHex) {
                    try {
                        if (config.names) {
                            // Name-based mapping (for segmented Tripo models)
                            model.materials.forEach(mat => {
                                const name = (mat.name || "").toLowerCase();
                                if (config.names.some(target => name.includes(target.toLowerCase()))) {
                                    applyColorToMaterial(mat, colorHex);
                                }
                            });
                        } else if (config.index !== undefined && model.materials[config.index]) {
                            // Index-based mapping (for legacy models)
                            applyColorToMaterial(model.materials[config.index], colorHex);
                        }
                    } catch (e) {
                        console.log('Could not apply color to', part, e);
                    }
                }
            }
        };

        // Helper function to apply color and clear textures for visibility
        function applyColorToMaterial(material, colorHex) {
            const rgb = hexToRgb(colorHex);
            if (rgb && material.pbrMetallicRoughness) {
                const pbr = material.pbrMetallicRoughness;
                // Clearing baseColorTexture is key for Tripo-segmented models to show custom colors
                pbr.baseColorTexture = null; 
                pbr.setBaseColorFactor([
                    rgb.r / 255,
                    rgb.g / 255,
                    rgb.b / 255,
                    1
                ]);
            }
        }

        // Helper function to convert hex to RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        // Expose material mappings and color options globally
        window.CHARACTER_MATERIAL_MAPPINGS = CHARACTER_MATERIAL_MAPPINGS;
        window.CHARACTER_COLOR_OPTIONS = CHARACTER_COLOR_OPTIONS;
        window.DEFAULT_CHARACTER_COLORS = DEFAULT_CHARACTER_COLORS;

        // Function to calculate XP threshold for a specific level based on the app's curve
        // Math.floor(1.3 * Math.pow(level, 1.55))
        function getXPForLevel(lvl) {
            if (lvl <= 1) return 0;
            return Math.floor(1.3 * Math.pow(lvl, 1.55));
        }

        window.updateFitGotchi = async function(pointsData) {
            const lifetimePoints = pointsData.lifetime_points || 0;
            const currentStreak = pointsData.current_streak || 0;
            
            // Calculate actual level using app's logic
            let level = 1;
            while (level < 99) {
                if (lifetimePoints < getXPForLevel(level + 1)) break;
                level++;
            }

            const currentLevelXP = getXPForLevel(level);
            const nextLevelXP = getXPForLevel(level + 1);
            
            // Update UI Elements
            const levelEl = document.getElementById('tamagotchi-level');
            const rankEl = document.getElementById('tamagotchi-rank');
            const xpTextEl = document.getElementById('tamagotchi-xp-text');
            const xpBarEl = document.getElementById('tamagotchi-xp-bar');
            const streakEl = document.getElementById('tamagotchi-streak');
            const modelViewer = document.getElementById('tamagotchi-model');

            if (levelEl) levelEl.textContent = level;
            if (streakEl) streakEl.textContent = currentStreak;

            // Check level and streak badges
            try {
                if (typeof checkLevelBadges === 'function') checkLevelBadges(level);
                if (typeof checkStreakBadges === 'function') checkStreakBadges(currentStreak);
            } catch(e) {}

            // Find matching evolution for the model
            // Ensure gender is loaded BEFORE selecting evolution (must await to fix female character bug)
            if (!window.currentUserGender && window.currentUser) {
                await loadCharacterColorsFromDb();
            }
            
            const currentEvolution = [...TAMAGOTCHI_EVOLUTIONS].reverse().find(e => level >= e.level) || TAMAGOTCHI_EVOLUTIONS[0];
            if (rankEl) rankEl.textContent = currentEvolution.title;

            // Progress calculation
            if (level < 99) {
                const range = nextLevelXP - currentLevelXP;
                const progress = lifetimePoints - currentLevelXP;
                const percent = Math.min(100, Math.max(0, (progress / range) * 100));
                if (xpBarEl) xpBarEl.style.width = percent + '%';
                if (xpTextEl) xpTextEl.textContent = `${lifetimePoints - currentLevelXP} / ${range} XP to Level ${level + 1}`;
            } else {
                if (xpBarEl) xpBarEl.style.width = '100%';
                if (xpTextEl) xpTextEl.textContent = `${lifetimePoints} XP (MAX)`;
            }

            // Update Model if changed (but respect active rare skin)
            if (modelViewer) {
                const activeRareSkinId = localStorage.getItem('active_rare_skin');
                if (activeRareSkinId && typeof RARE_COLLECTION !== 'undefined' && typeof isRareUnlocked === 'function') {
                    const rareData = RARE_COLLECTION.find(r => r.id === activeRareSkinId);
                    if (rareData && isRareUnlocked(activeRareSkinId)) {
                        // Rare skin is active - use it instead of level evolution
                        const currentSrc = modelViewer.getAttribute('src');
                        if (currentSrc !== rareData.model) {
                            modelViewer.setAttribute('src', rareData.model);
                        }
                        // Skip the rest of model update (level evolution)
                    } else {
                        // Rare skin invalid/locked, clear it
                        localStorage.removeItem('active_rare_skin');
                    }
                }
                const currentSrc = modelViewer.getAttribute('src');
                const activeRareCheck = localStorage.getItem('active_rare_skin');
                const activeEvoSkinCheck = localStorage.getItem('active_evolution_skin');

                // Check for evolution skin override (user swapped to a different unlocked evolution)
                if (!activeRareCheck && activeEvoSkinCheck) {
                    if (currentSrc !== activeEvoSkinCheck) {
                        modelViewer.setAttribute('src', activeEvoSkinCheck);
                    }
                } else if (!activeRareCheck && currentSrc !== currentEvolution.src) {
                    modelViewer.setAttribute('src', currentEvolution.src);

                    // Trigger "evolution" effect if it actually changed
                    if (currentSrc) {
                        modelViewer.style.filter = 'brightness(3) contrast(1.2)';
                        setTimeout(() => modelViewer.style.filter = '', 500);
                    }

                    // Log when new model's animations are loaded and apply character colors
                    modelViewer.addEventListener('load', function onModelLoad() {
                        console.log('Model loaded:', currentEvolution.src);
                        console.log('Available animations:', modelViewer.availableAnimations);
                        
                        // Force opaque materials for all parts
                        if (modelViewer.model) {
                            modelViewer.model.materials.forEach(m => m.setAlphaMode("OPAQUE"));
                        }

                        // Apply user's custom character colors to the new model
                        if (window.applyCharacterColors) {
                            window.applyCharacterColors(modelViewer, currentEvolution.src);
                        }
                        
                        // Setup correct Idle animation for the new model/gender
                        setTimeout(() => {
                            let idleAnim = 'idle';

                            if (modelViewer.availableAnimations.includes(idleAnim)) {
                                modelViewer.animationName = idleAnim;
                                modelViewer.play();
                            }
                        }, 500);

                        modelViewer.removeEventListener('load', onModelLoad);
                    }, { once: true });
                } else {
                    // Model already loaded, just apply colors if not already done
                    if (window.applyCharacterColors && modelViewer.model) {
                        window.applyCharacterColors(modelViewer, currentSrc);
                    }
                }

                // Camera distance logic based on level (larger values = smaller character in room)
                let cameraDist = 22.0;
                if (level >= 99) cameraDist = 12.0;
                else if (level >= 40) cameraDist = 18.0 - ((level - 40) / 59 * 6.0);
                else cameraDist = 22.0 - (level / 40 * 4.0);

                // Use consistent field-of-view for both male and female characters
                let fov = 30;

                // Only update camera if not in battle (battle locks camera to side profile)
                if (!window._battleInProgress && !window.isDuringBattle) {
                    modelViewer.setAttribute('camera-orbit', `0deg 85deg ${cameraDist}m`);
                    modelViewer.setAttribute('field-of-view', `${fov}deg`);
                }

                // Scale down both male and female characters equally via CSS transform
                modelViewer.style.transform = 'scale(0.75)';
                modelViewer.style.transformOrigin = 'center center';

                // Cache current model state for instant restore on next page load
                try {
                    var finalSrc = modelViewer.getAttribute('src');
                    if (finalSrc) localStorage.setItem('fitgotchi_model_src', finalSrc);
                    localStorage.setItem('fitgotchi_camera_orbit', `0deg 85deg ${cameraDist}m`);
                    localStorage.setItem('fitgotchi_fov', `${fov}deg`);
                    localStorage.setItem('fitgotchi_scale', 'scale(0.75)');
                } catch(e) {}
            }

            // Cache stats for instant restore on next page load
            try {
                localStorage.setItem('fitgotchi_level', String(level));
                localStorage.setItem('fitgotchi_rank', currentEvolution.title);
                localStorage.setItem('fitgotchi_streak', String(currentStreak));
                if (xpBarEl) localStorage.setItem('fitgotchi_xp_percent', xpBarEl.style.width);
                if (xpTextEl) localStorage.setItem('fitgotchi_xp_text', xpTextEl.textContent);
            } catch(e) {}
        };

        // Animation unlock system - animations unlocked at specific levels
        // 55 real model animations (idle is always available, NlaTrack.055 is internal):
        // laugh, walk, warm_up, greet, pitch, arms_up_still, greet_1, laugh_1,
        // angry, karate, sad_stand, boxing, laugh_2, stretch, hit_to_1, dance,
        // hit_to_2, fold_arms, die, laugh_3, angry_1, idle, stand_hands_on_hips,
        // hit_to_head, strut, hit_to_side, dance_1, dance_2, dance_3, dance_4,
        // sit, lose, kick, pushup, clap, boxing_1, angry_walk, boxing_2,
        // cartwheel, basketball, greet_2, depressed_walk, angry_2, hit_to_3,
        // bow, say_goodbye, block, die_1, volleyball, kick_2, dance_5, agree,
        // stand, angry_3, heart_pose
        // NOTE: 'idle' is NOT in the unlock array - unmapped animations default to unlocked
        const ANIMATION_UNLOCKS = [
            // Level 1 starter animations (baby has full animations now)
            { name: 'walk', displayName: 'Walk', unlockLevel: 1, icon: '🚶', category: 'special' },
            { name: 'greet', displayName: 'Greet', unlockLevel: 1, icon: '👋', category: 'greetings' },
            { name: 'agree', displayName: 'Agree', unlockLevel: 1, icon: '👍', category: 'reactions' },
            { name: 'laugh', displayName: 'Laugh', unlockLevel: 1, icon: '😄', category: 'celebrations' },
            { name: 'boxing', displayName: 'Boxing', unlockLevel: 1, icon: '🥊', category: 'combat' },

            // Level 3 unlocks
            { name: 'fold_arms', displayName: 'Fold Arms', unlockLevel: 3, icon: '🤔', category: 'reactions' },

            // Level 5 unlocks (Newcomer evolution)
            { name: 'bow', displayName: 'Bow', unlockLevel: 5, icon: '🙇', category: 'greetings' },
            { name: 'sad_stand', displayName: 'Sad', unlockLevel: 5, icon: '😔', category: 'reactions' },
            { name: 'clap', displayName: 'Clap', unlockLevel: 5, icon: '👏', category: 'celebrations' },
            { name: 'warm_up', displayName: 'Warm Up', unlockLevel: 5, icon: '🔥', category: 'exercise' },
            { name: 'dance', displayName: 'Dance', unlockLevel: 5, icon: '💃', category: 'dance' },

            // Level 8 unlocks
            { name: 'angry', displayName: 'Angry', unlockLevel: 8, icon: '😠', category: 'reactions' },
            { name: 'laugh_1', displayName: 'Giggle', unlockLevel: 8, icon: '😂', category: 'celebrations' },
            { name: 'angry_2', displayName: 'Furious', unlockLevel: 8, icon: '🤬', category: 'reactions' },

            // Level 10 unlocks (Rising evolution + Battle Mode)
            { name: 'greet_1', displayName: 'Hey!', unlockLevel: 10, icon: '🤙', category: 'greetings' },
            { name: 'greet_2', displayName: 'Hi There', unlockLevel: 10, icon: '✌️', category: 'greetings' },
            { name: 'angry_1', displayName: 'Annoyed', unlockLevel: 10, icon: '😤', category: 'reactions' },
            { name: 'stretch', displayName: 'Stretch', unlockLevel: 10, icon: '🧘', category: 'exercise' },
            { name: 'kick', displayName: 'Kick', unlockLevel: 10, icon: '🦵', category: 'combat' },
            { name: 'hit_to_2', displayName: 'Hit To 2', unlockLevel: 10, icon: '🤜', category: 'reactions' },
            { name: 'stand_hands_on_hips', displayName: 'Power Pose', unlockLevel: 10, icon: '💪', category: 'poses' },
            { name: 'strut', displayName: 'Strut', unlockLevel: 10, icon: '🚶', category: 'dance' },

            // Level 15 unlocks
            { name: 'lose', displayName: 'Lose', unlockLevel: 15, icon: '😞', category: 'reactions' },
            { name: 'pushup', displayName: 'Push-Up', unlockLevel: 15, icon: '💪', category: 'exercise' },
            { name: 'karate', displayName: 'Karate', unlockLevel: 15, icon: '🥋', category: 'combat' },
            { name: 'hit_to_head', displayName: 'Hit To Head', unlockLevel: 15, icon: '🎯', category: 'reactions' },
            { name: 'hit_to_side', displayName: 'Hit To Side', unlockLevel: 15, icon: '⚡', category: 'reactions' },
            { name: 'dance_1', displayName: 'Groove', unlockLevel: 15, icon: '🎵', category: 'dance' },
            { name: 'arms_up_still', displayName: 'Arms Up', unlockLevel: 15, icon: '🙌', category: 'celebrations' },
            { name: 'laugh_3', displayName: 'Cracking Up', unlockLevel: 15, icon: '😹', category: 'celebrations' },

            // Level 20 unlocks (Growing evolution)
            { name: 'say_goodbye', displayName: 'Goodbye', unlockLevel: 20, icon: '👋', category: 'greetings' },
            { name: 'depressed_walk', displayName: 'Sad Walk', unlockLevel: 20, icon: '🚶', category: 'reactions' },
            { name: 'angry_3', displayName: 'Rage', unlockLevel: 20, icon: '💢', category: 'reactions' },
            { name: 'heart_pose', displayName: 'Heart Pose', unlockLevel: 20, icon: '❤️', category: 'celebrations' },
            { name: 'basketball', displayName: 'Basketball', unlockLevel: 20, icon: '🏀', category: 'exercise' },
            { name: 'boxing_1', displayName: 'Boxing Combo', unlockLevel: 20, icon: '🥊', category: 'combat' },
            { name: 'hit_to_3', displayName: 'Hit To 3', unlockLevel: 20, icon: '💥', category: 'reactions' },
            { name: 'stand', displayName: 'Stand Tall', unlockLevel: 20, icon: '🧍', category: 'poses' },
            { name: 'dance_2', displayName: 'Moves', unlockLevel: 20, icon: '🎶', category: 'dance' },

            // Level 25 unlocks
            { name: 'angry_walk', displayName: 'Angry Walk', unlockLevel: 25, icon: '😡', category: 'reactions' },
            { name: 'laugh_2', displayName: 'LOL', unlockLevel: 25, icon: '🤣', category: 'celebrations' },
            { name: 'volleyball', displayName: 'Volleyball', unlockLevel: 25, icon: '🏐', category: 'exercise' },
            { name: 'hit_to_1', displayName: 'Hit To 1', unlockLevel: 25, icon: '👊', category: 'reactions' },
            { name: 'dance_3', displayName: 'Boogie', unlockLevel: 25, icon: '🕺', category: 'dance' },

            // Level 30 unlocks (Consistent evolution)
            { name: 'pitch', displayName: 'Pitch', unlockLevel: 30, icon: '⚾', category: 'poses' },
            { name: 'cartwheel', displayName: 'Cartwheel', unlockLevel: 30, icon: '🤸', category: 'special' },
            { name: 'dance_4', displayName: 'Freestyle', unlockLevel: 30, icon: '🎧', category: 'dance' },
            { name: 'boxing_2', displayName: 'Boxing Pro', unlockLevel: 30, icon: '💥', category: 'combat' },

            // Level 35 unlocks
            { name: 'dance_5', displayName: 'Show Off', unlockLevel: 35, icon: '✨', category: 'dance' },

            // Level 40 unlocks (Committed evolution)
            { name: 'kick_2', displayName: 'Spin Kick', unlockLevel: 40, icon: '🌀', category: 'combat' },
            { name: 'sit', displayName: 'Sit Down', unlockLevel: 40, icon: '🪑', category: 'special' },
            { name: 'block', displayName: 'Block', unlockLevel: 40, icon: '🛡️', category: 'combat' },

            // Level 50+ unlocks (Dedicated evolution)
            { name: 'die', displayName: 'Drama Fall', unlockLevel: 50, icon: '🎭', category: 'special' },
            { name: 'die_1', displayName: 'Play Dead', unlockLevel: 60, icon: '😵', category: 'special' },
        ];

        // Background unlock system - backgrounds unlocked at specific levels
        const BACKGROUND_UNLOCKS = [
            { name: 'none', displayName: 'Default', unlockLevel: 1, icon: '🌑', theme: 'tamagotchi-bg-none', image: null },
            { name: 'gym', displayName: 'Gym', unlockLevel: 5, icon: '🏋️', theme: 'tamagotchi-bg-gym', image: './assets/gym_bg.jpeg' },
            { name: 'park', displayName: 'Park', unlockLevel: 10, icon: '🌳', theme: 'tamagotchi-bg-park', image: './assets/park.jpeg' },
            { name: 'home', displayName: 'Home', unlockLevel: 20, icon: '🏠', theme: 'tamagotchi-bg-home', image: './assets/home.jpeg' },
            { name: 'beach', displayName: 'Beach', unlockLevel: 30, icon: '🏖️', theme: 'tamagotchi-bg-beach', image: './assets/beach.jpeg' },
            { name: 'mountain', displayName: 'Mountain', unlockLevel: 40, icon: '⛰️', theme: 'tamagotchi-bg-mountain', image: './assets/mountain.jpeg' },
        ];
        // Expose globally so battle restore can look up the saved background image
        window.BACKGROUND_UNLOCKS = BACKGROUND_UNLOCKS;

        // Expose ANIMATION_UNLOCKS globally for use by checkNewAnimationUnlocks
        window.ANIMATION_UNLOCKS = ANIMATION_UNLOCKS;

        // Get user's current level for animation unlocks
        function getCurrentUserLevel() {
            const levelEl = document.getElementById('tamagotchi-level');
            return levelEl ? parseInt(levelEl.textContent) || 1 : 1;
        }
        window.getCurrentUserLevel = getCurrentUserLevel;

        // Check if an animation is unlocked for current user
        function isAnimationUnlocked(animName) {
            const level = getCurrentUserLevel();
            // First try exact match, then includes match
            let unlock = ANIMATION_UNLOCKS.find(a =>
                a.name.toLowerCase() === animName.toLowerCase()
            );
            if (!unlock) {
                unlock = ANIMATION_UNLOCKS.find(a =>
                    animName.toLowerCase().includes(a.name.toLowerCase()) ||
                    a.name.toLowerCase().includes(animName.toLowerCase())
                );
            }
            return unlock ? level >= unlock.unlockLevel : true; // Unknown animations are unlocked
        }

        // Get unlock info for an animation
        function getAnimationUnlockInfo(animName) {
            // First try exact match, then includes match
            let unlock = ANIMATION_UNLOCKS.find(a =>
                a.name.toLowerCase() === animName.toLowerCase()
            );
            if (!unlock) {
                unlock = ANIMATION_UNLOCKS.find(a =>
                    animName.toLowerCase().includes(a.name.toLowerCase()) ||
                    a.name.toLowerCase().includes(animName.toLowerCase())
                );
            }
            return unlock;
        }

        // Get all unlocked animations from available animations
        function getUnlockedAnimations(availableAnimations) {
            const level = getCurrentUserLevel();
            return availableAnimations.filter(animName => {
                const unlock = getAnimationUnlockInfo(animName);
                return unlock ? level >= unlock.unlockLevel : true;
            });
        }

        // Store available animations when model loads
        let shaziAvailableAnimations = [];

        // Stop any playing animation and return to static stance
        let previewTimeoutId = null;
        function stopAnimation() {
            const mv = document.getElementById('tamagotchi-model');
            if (previewTimeoutId) { clearTimeout(previewTimeoutId); previewTimeoutId = null; }
            if (mv) {
                mv.pause();
                mv.currentTime = 0;
            }
        }

        // Play a specific animation
        function playAnimation(animName, returnToStatic = true) {
            const mv = document.getElementById('tamagotchi-model');
            if (!mv) return false;

            // Cancel any pending preview reset from a previous animation
            if (previewTimeoutId) { clearTimeout(previewTimeoutId); previewTimeoutId = null; }

            // Check if unlocked based on level
            if (!isAnimationUnlocked(animName)) {
                const unlock = getAnimationUnlockInfo(animName);
                if (unlock) {
                    showToast(`Unlock at Level ${unlock.unlockLevel}`, 'info');
                }
                return false;
            }

            // Try to find matching animation in availableAnimations if they exist
            let targetAnim = animName;
            if (mv.availableAnimations?.length) {
                // First try exact match (case insensitive)
                let found = mv.availableAnimations.find(a =>
                    a.toLowerCase() === animName.toLowerCase()
                );
                // If no exact match, try includes match
                if (!found) {
                    found = mv.availableAnimations.find(a =>
                        a.toLowerCase().includes(animName.toLowerCase())
                    );
                }
                if (found) targetAnim = found;
            }

            // Set and play the animation
            mv.animationName = targetAnim;
            mv.play();

            if (returnToStatic) {
                // Use the actual animation duration so the full move plays before resetting
                requestAnimationFrame(() => {
                    const durationMs = (mv.duration > 0 ? mv.duration : 3.5) * 1000;
                    previewTimeoutId = setTimeout(() => {
                        mv.pause();
                        mv.currentTime = 0;
                        mv.animationName = null;
                        mv.removeAttribute('animation-name');
                        previewTimeoutId = null;
                    }, durationMs);
                });
            }
            return true;
        }

        // Build and show animation selector UI (exposed to window for onclick)
        window.showAnimationSelector = function() {
            const mv = document.getElementById('tamagotchi-model');
            if (!mv) return;

            const level = getCurrentUserLevel();

            // Use ANIMATION_UNLOCKS directly - don't rely on availableAnimations detection
            // The model has animations, we just show what's possible based on level
            const categories = {};
            ANIMATION_UNLOCKS.forEach(unlock => {
                if (!categories[unlock.category]) {
                    categories[unlock.category] = [];
                }
                categories[unlock.category].push({
                    name: unlock.name,
                    displayName: unlock.displayName,
                    icon: unlock.icon,
                    unlockLevel: unlock.unlockLevel,
                    category: unlock.category,
                    isUnlocked: level >= unlock.unlockLevel
                });
            });

            const categoryNames = {
                'greetings': '👋 Greetings',
                'reactions': '👀 Reactions',
                'celebrations': '🎉 Celebrations',
                'exercise': '🏋️ Exercise',
                'combat': '🥊 Combat',
                'poses': '💪 Poses',
                'dance': '💃 Dance',
                'special': '⭐ Special'
            };

            const selectorTitle = "Unlocks";

            let html = `
                <div class="animation-selector-backdrop" onclick="closeAnimationSelector()"></div>
                <div class="animation-selector-modal">
                    <div class="animation-selector-header">
                        <h3>${selectorTitle}</h3>
                        <span class="animation-selector-close" onclick="closeAnimationSelector()">&times;</span>
                    </div>
                    <div class="animation-selector-content">
            `;

            const categoryOrder = ['greetings', 'reactions', 'celebrations', 'exercise', 'combat', 'poses', 'dance', 'special'];

            categoryOrder.forEach(cat => {
                if (categories[cat]?.length) {
                    html += `<div class="animation-category">
                        <div class="animation-category-title">${categoryNames[cat] || cat}</div>
                        <div class="animation-grid">`;

                    categories[cat].forEach(anim => {
                        if (anim.isUnlocked) {
                            html += `
                                <div class="animation-item unlocked" onclick="playAnimationFromSelector('${anim.name}')">
                                    <span class="animation-icon">${anim.icon}</span>
                                    <span class="animation-name">${anim.displayName}</span>
                                </div>`;
                        } else {
                            html += `
                                <div class="animation-item locked">
                                    <span class="animation-icon">🔒</span>
                                    <span class="animation-name">${anim.displayName}</span>
                                    <span class="animation-unlock-level">Lvl ${anim.unlockLevel}</span>
                                </div>`;
                        }
                    });

                    html += `</div></div>`;
                }
            });

            // Add Character Skins section showing level unlocks
            const skinEvolutions = TAMAGOTCHI_EVOLUTIONS.filter((e, i, arr) => {
                // Only show entries where the model source changes (actual new skin)
                return i === 0 || e.src !== arr[i - 1].src;
            });

            html += `<div class="animation-category">
                <div class="animation-category-title">🎨 Character Skins</div>
                <div class="skin-levels-grid">`;

            const activeRareSkinForEvo = localStorage.getItem('active_rare_skin') || '';
            const activeEvoSkin = localStorage.getItem('active_evolution_skin') || '';
            skinEvolutions.forEach(evo => {
                const isUnlocked = level >= evo.level;
                const isActiveEvo = !activeRareSkinForEvo && (activeEvoSkin === evo.src || (!activeEvoSkin && evo === skinEvolutions.filter(e => level >= e.level).pop()));
                const skinClass = isUnlocked ? 'skin-level-item unlocked' : 'skin-level-item locked';
                const checkOrLock = isUnlocked ? (isActiveEvo ? '✨' : '✅') : '🔒';
                const activeStyle = isActiveEvo ? 'border: 2px solid var(--primary); box-shadow: 0 0 10px rgba(123,168,131,0.4);' : '';
                const clickHandler = isUnlocked ? `onclick="selectEvolutionSkin('${evo.src}', '${evo.title}')" style="cursor: pointer; ${activeStyle}"` : '';
                html += `
                    <div class="${skinClass}" ${clickHandler}>
                        <span class="skin-level-badge">Lvl ${evo.level}</span>
                        <span class="skin-level-icon">${checkOrLock}</span>
                        <span class="skin-level-title">${evo.title}</span>
                    </div>`;
            });

            html += `</div></div>`;

            // Add Rare Skins section
            const activeRareSkin = localStorage.getItem('active_rare_skin') || '';
            html += `<div class="animation-category">
                <div class="animation-category-title">💎 Rare Skins</div>
                <div class="skin-levels-grid">`;

            RARE_COLLECTION.forEach(rare => {
                const rareUnlocked = isRareUnlocked(rare.id);
                const tierData = RARE_TIERS[rare.tier];
                const isActive = activeRareSkin === rare.id;
                if (rareUnlocked) {
                    html += `
                        <div class="skin-level-item unlocked${isActive ? ' rare-skin-active' : ''}" onclick="selectRareSkin('${rare.id}')" style="cursor: pointer; position: relative; ${isActive ? 'border: 2px solid ' + tierData.color + '; box-shadow: 0 0 10px ' + tierData.glow + ';' : ''}">
                            <span class="skin-level-badge" style="background: ${tierData.gradient}; color: white; font-size: 0.55rem;">${tierData.label}</span>
                            <span class="skin-level-icon">${rare.emoji}</span>
                            <span class="skin-level-title">${rare.name}</span>
                        </div>`;
                } else {
                    html += `
                        <div class="skin-level-item locked" style="position: relative;">
                            <span class="skin-level-badge" style="background: ${tierData.gradient}; color: white; font-size: 0.55rem;">${tierData.label}</span>
                            <span class="skin-level-icon">🔒</span>
                            <span class="skin-level-title" style="opacity: 0.5;">${rare.name}</span>
                        </div>`;
                }
            });

            // Add "Use Level Skin" reset option if a rare or evolution override is active
            if (activeRareSkin || activeEvoSkin) {
                html += `
                    <div class="skin-level-item unlocked" onclick="clearRareSkin()" style="cursor: pointer; border: 1px dashed rgba(255,255,255,0.3);">
                        <span class="skin-level-badge" style="background: rgba(255,255,255,0.2); color: white; font-size: 0.55rem;">RESET</span>
                        <span class="skin-level-icon">↩️</span>
                        <span class="skin-level-title">Current Level</span>
                    </div>`;
            }

            html += `</div></div>`;

            // Add Backgrounds section
            html += `<div class="animation-category">
                <div class="animation-category-title">🖼️ Backgrounds</div>
                <div class="animation-grid">`;

            const savedBg = localStorage.getItem('selectedBackground') || '';
            BACKGROUND_UNLOCKS.forEach(bg => {
                const isBgUnlocked = level >= bg.unlockLevel;
                const isSelected = savedBg === bg.name;
                if (isBgUnlocked) {
                    html += `
                        <div class="animation-item unlocked bg-selector-item${isSelected ? ' bg-selected' : ''}" data-bg="${bg.name}" onclick="selectBackground('${bg.name}')">
                            <span class="animation-icon">${bg.icon}</span>
                            <span class="animation-name">${bg.displayName}</span>
                        </div>`;
                } else {
                    html += `
                        <div class="animation-item locked">
                            <span class="animation-icon">🔒</span>
                            <span class="animation-name">${bg.displayName}</span>
                            <span class="animation-unlock-level">Lvl ${bg.unlockLevel}</span>
                        </div>`;
                }
            });

            html += `</div></div>`;

            html += `
                    </div>
                </div>
            `;

            // Create container inside tamagotchi widget
            let container = document.getElementById('animation-selector-container');
            const tamagotchiContainer = document.getElementById('tamagotchi-widget-container');

            if (!container && tamagotchiContainer) {
                container = document.createElement('div');
                container.id = 'animation-selector-container';
                container.className = 'animation-selector-container';
                tamagotchiContainer.appendChild(container);
            }

            if (container) {
                container.innerHTML = html;
                container.style.display = 'block';
            }
        }

        window.closeAnimationSelector = function() {
            const container = document.getElementById('animation-selector-container');
            if (container) {
                container.style.display = 'none';
            }
        };

        window.playAnimationFromSelector = function(animName) {
            playAnimation(animName, true);
            window.closeAnimationSelector();
        };

        // All possible background theme classes (for cleanup)
        const ALL_BG_THEME_CLASSES = [
            'tamagotchi-bg-gym', 'tamagotchi-bg-park', 'tamagotchi-bg-home',
            'tamagotchi-bg-beach', 'tamagotchi-bg-mountain',
            'tamagotchi-bg-dojo', 'tamagotchi-bg-arena'
        ];

        // Select and apply a background theme from the Unlocks panel
        window.selectBackground = function(bgName) {
            const bg = (window.BACKGROUND_UNLOCKS || BACKGROUND_UNLOCKS).find(b => b.name === bgName);
            if (!bg || !bg.theme) return;

            const container = document.getElementById('tamagotchi-widget-container');
            if (!container) return;

            // Remove all background CSS theme classes
            ALL_BG_THEME_CLASSES.forEach(theme => container.classList.remove(theme));

            // Apply the selected CSS theme (gradient backdrop)
            container.classList.add(bg.theme);

            // Handle background display - ALL backgrounds use static images now
            const bgModel = document.getElementById('tamagotchi-bg-model');
            const floor = document.getElementById('tamagotchi-floor');
            const staticBg = document.getElementById('tamagotchi-static-bg');

            // Hide 3D model and floor - we use static images for everything
            if (bgModel) bgModel.style.display = 'none';
            if (floor) floor.style.display = 'none';

            if (bg.image && staticBg) {
                // Show static background image
                staticBg.style.display = 'block';
                staticBg.style.backgroundImage = "url('" + bg.image + "')";
                staticBg.style.backgroundSize = 'cover';
                staticBg.style.backgroundPosition = 'center center';
            } else if (staticBg) {
                // No image available (e.g. Home) - hide static bg, show floor as fallback
                staticBg.style.display = 'none';
                if (floor) floor.style.display = 'block';
            }

            // Save selection to localStorage
            localStorage.setItem('selectedBackground', bgName);

            // Update the selected state in the UI
            document.querySelectorAll('.bg-selector-item').forEach(el => {
                el.classList.remove('bg-selected');
            });
            const selectedEl = document.querySelector(`.bg-selector-item[data-bg="${bgName}"]`);
            if (selectedEl) selectedEl.classList.add('bg-selected');
        };

        // Listen for initial model load to log available animations and apply colors
        const initialModelViewer = document.getElementById('tamagotchi-model');
        if (initialModelViewer) {
            initialModelViewer.addEventListener('load', () => {
                console.log('Initial model loaded:', initialModelViewer.getAttribute('src'));
                console.log('Available animations:', initialModelViewer.availableAnimations);

                // Store animations globally for debugging
                window.shaziAnimations = initialModelViewer.availableAnimations || [];

                // Apply user's custom character colors to the initial model
                if (window.applyCharacterColors) {
                    window.applyCharacterColors(initialModelViewer, initialModelViewer.getAttribute('src'));
                }
            });
        }

        // ============================================================
        // CAMERA SYNC: Gym background rotates with character
        // Makes the gym part of the scene instead of a flat backdrop
        // ============================================================
        (function setupBackgroundCameraSync() {
            const charViewer = document.getElementById('tamagotchi-model');
            const bgViewer = document.getElementById('tamagotchi-bg-model');
            if (!charViewer || !bgViewer) return;

            // Base background camera distance - scales proportionally with character zoom
            // Higher BG_BASE_DISTANCE = gym appears larger/closer
            const BG_BASE_DISTANCE = 8.0; // meters at default character distance
            const CHAR_BASE_DISTANCE = 22; // default character orbit distance
            const BG_SCALE = BG_BASE_DISTANCE / CHAR_BASE_DISTANCE;

            charViewer.addEventListener('camera-change', () => {
                // Skip sync if background is hidden
                if (bgViewer.style.display === 'none') return;

                const orbit = charViewer.getCameraOrbit();
                // theta = horizontal rotation (radians)
                // phi = vertical angle (radians)
                // radius = distance from target (meters)
                const thetaDeg = (orbit.theta * 180 / Math.PI);
                const phiDeg = (orbit.phi * 180 / Math.PI);

                // Scale bg distance proportionally to character zoom
                // so gym scales naturally when character zooms in/out with level
                const bgDist = orbit.radius * BG_SCALE;

                bgViewer.cameraOrbit = `${thetaDeg}deg ${phiDeg}deg ${bgDist}m`;
                bgViewer.jumpCameraToGoal();
            });

            console.log('Background camera sync initialized');
        })();

        // Tap reaction - greeting animation
        document.getElementById('tamagotchi-model')?.addEventListener('click', () => {
            const mv = document.getElementById('tamagotchi-model');
            if (!mv || !mv.availableAnimations || !mv.availableAnimations.length) return;

            // Find the greeting animation
            let greetAnim = mv.availableAnimations.find(a => a === 'greet');
            if (!greetAnim) {
                greetAnim = mv.availableAnimations.find(a => a === 'bow');
            }
            if (greetAnim) {
                mv.animationName = greetAnim;
                mv.play();

                // Return to static stance after animation plays
                setTimeout(() => {
                    mv.pause();
                    mv.currentTime = 0;
                    mv.animationName = null;
                    mv.removeAttribute('animation-name');
                }, 3000);
            }
        });

        // Battle state flags (used by camera distance update guard)
        window.isDuringBattle = false;
    })();
    </script>

    <!-- Learning System Script -->
    <script src="lib/learning-inline.js"></script>
    <!-- Battle System & Logic Overrides -->
    <script>
    console.log("🔥 LOADING BATTLE SYSTEM OVERRIDES...");

    // Sound System
    const BATTLE_SOUNDS = {
        intro: new Audio('assets/battle_intro.wav'),
        bell: new Audio('assets/bell.wav'),
        whoosh: new Audio('assets/whoosh.wav'),
        hit: new Audio('assets/hit.wav'),
        victory: new Audio('assets/victory.wav')
    };

    function playBattleSound(name) {
        if(BATTLE_SOUNDS[name]) {
            BATTLE_SOUNDS[name].currentTime = 0;
            BATTLE_SOUNDS[name].volume = 0.6;
            BATTLE_SOUNDS[name].play().catch(e => console.log("Audio play failed:", e));
        }
    }

    // (V2 battle logic removed - all battle logic is now in _runBattle below)

    // --- OVERRIDE COLOR APPLICATION ---
    window.applyCharacterColors = async function(modelViewer, modelSrc) {
        if(!modelViewer) return;
        
        // Wait for load
        if(!modelViewer.model) {
            await new Promise(r => modelViewer.addEventListener('load', r, {once:true}));
        }
        const model = modelViewer.model;
        if(!model || !model.materials) return;

        const colors = window.getCharacterColors(); // Uses existing helper which reads localStorage
        const src = (modelSrc || modelViewer.src || "").toLowerCase();

        // Hex to RGB Helper
        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16)/255, g: parseInt(result[2], 16)/255, b: parseInt(result[3], 16)/255 } : null;
        };

        Object.keys(colors).forEach(cat => {
            const hex = colors[cat];
            if(!hex) return;
            const linkColor = hexToRgb(hex);
            if(!linkColor) return;

            let targets = [];
            
            // KEYWORD MATCHING LOGIC
            if (src.includes('baby')) {
                 if(cat==='skin') targets=['tripo_part_new_0.001']; if(cat==='hair') targets=['tripo_part_0.001']; if(cat==='pants') targets=['tripo_part_8.001']; if(cat==='shoes') targets=['tripo_part_3.001'];
            }
            else if (src.includes('level_50_female')) {
                if(cat==='skin') targets=['part_11']; if(cat==='hair') targets=['part_4']; if(cat==='shirt') targets=['part_9']; if(cat==='shoes') targets=['part_9'];
            } 
            else if (src.includes('level_40_female')) {
                 if(cat==='skin') targets=['part_1']; if(cat==='hair') targets=['part_10']; if(cat==='shirt') targets=['part_7']; if(cat==='pants') targets=['part_6']; if(cat==='shoes') targets=['part_2'];
            }
            else if (src.includes('level_30_female')) {
                 if(cat==='skin') targets=['new_0_material']; if(cat==='hair') targets=['new_0_0']; if(cat==='shirt') targets=['part_10']; if(cat==='pants') targets=['part_2']; if(cat==='shoes') targets=['part_1'];
            }
            else if (src.includes('level_20_female')) {
                 if(cat==='skin') targets=['part_11', 'part_8', 'tripo_part_new_0_0']; if(cat==='hair') targets=['part_0', 'tripo_part_8']; if(cat==='shirt') targets=['part_3', 'tripo_part_5']; if(cat==='pants') targets=['tripo_part_4']; if(cat==='shoes') targets=['part_1', 'tripo_part_9'];
            }
            else if (src.includes('level_10_female')) {
                 if(cat==='skin') targets=['part_8.001']; if(cat==='hair') targets=['part_new_0.001', 'part_new.001']; if(cat==='shirt') targets=['part_new_0_0.001']; if(cat==='pants') targets=['part_6.001']; if(cat==='shoes') targets=['part_1.001', 'part_10.001'];
            }
            else if (src.includes('level_1_female')) {
                 if(cat==='skin') targets=['part_new']; if(cat==='hair') targets=['part_2']; if(cat==='shirt') targets=['part_8']; if(cat==='pants') targets=['part_4']; if(cat==='shoes') targets=['part_11'];
            }
            // MALE / REAL MODELS
            else if (src.includes('level_50_real')) {
                 if(cat==='skin') targets=['part_4_material']; if(cat==='hair') targets=['part_1_material']; if(cat==='pants') targets=['new_0_material']; if(cat==='shoes') targets=['part_6_material'];
            }
            else if (src.includes('level_40_real')) {
                 if(cat==='skin') targets=['part_3_material']; if(cat==='hair') targets=['part_5_material']; if(cat==='shirt') targets=['part_10_material']; if(cat==='pants') targets=['part_6_material']; if(cat==='shoes') targets=['part_2_material'];
            }
            else if (src.includes('level_30_real')) {
                 if(cat==='skin') targets=['part_13_material']; if(cat==='hair') targets=['part_4_material']; if(cat==='shirt') targets=['new_0_material']; if(cat==='pants') targets=['part_5_material']; if(cat==='shoes') targets=['part_2_material'];
            }
            else if (src.includes('level_20_real')) {
                 if(cat==='skin') targets=['part_0_material']; if(cat==='hair') targets=['part_12_material']; if(cat==='shirt') targets=['part_6_material']; if(cat==='pants') targets=['part_9_material']; if(cat==='shoes') targets=['part_2_material'];
            }
            else if (src.includes('level_10_real')) {
                 if(cat==='skin') targets=['part_0_material']; if(cat==='hair') targets=['part_5_material']; if(cat==='shirt') targets=['part_12_material']; if(cat==='pants') targets=['part_6_material']; if(cat==='shoes') targets=['part_10_material'];
            }
            else if (src.includes('level_1_good') || src.includes('shazylvl1')) {
                 if(cat==='skin') targets=['part_10_material']; if(cat==='hair') targets=['part_7_material']; if(cat==='shirt') targets=['part_5_material']; if(cat==='pants') targets=['part_6_material']; if(cat==='shoes') targets=['part_9_material'];
            }
            
            // Fallback
            if(targets.length === 0) {
                 if(cat==='skin') targets=['skin', 'body', 'face', 'arm', 'hand'];
                 if(cat==='hair') targets=['hair', 'head'];
                 if(cat==='shirt') targets=['shirt', 'top', 'vest'];
                 if(cat==='pants') targets=['pants', 'shorts', 'leg'];
                 if(cat==='shoes') targets=['shoes', 'boot', 'feet'];
            }

            // Apply
            model.materials.forEach(mat => {
                const matName = (mat.name || "").toLowerCase();
                const matched = targets.some(t => {
                    if(t.startsWith('part_') || t.startsWith('new_')) {
                        // Strict ID match
                        return matName.includes(t);
                    }
                    return matName.includes(t);
                });

                if(matched) {
                    const pbr = mat.pbrMetallicRoughness;
                    pbr.baseColorTexture = null;
                    pbr.setBaseColorFactor([linkColor.r, linkColor.g, linkColor.b, 1]);
                    if(cat==='skin' || cat==='hair') {
                        pbr.setRoughnessFactor(0.9);
                        pbr.setMetallicFactor(0.0);
                    }
                }
            });
        });
    };
    </script>

    <!-- ============================================================
         BACKGROUND INITIALIZATION (separate script to avoid battle errors blocking it)
         ============================================================ -->
    <script>
    (function() {
        function initBackground() {
            const savedBg = localStorage.getItem('selectedBackground') || 'none';
            if (window.selectBackground) {
                window.selectBackground(savedBg);
                return;
            }
            // Fallback if selectBackground not yet available - default to plain dark background
            const container = document.getElementById('tamagotchi-widget-container');
            if (!container) return;
            const ALL_BG = ['tamagotchi-bg-none','tamagotchi-bg-gym','tamagotchi-bg-park','tamagotchi-bg-home','tamagotchi-bg-beach','tamagotchi-bg-mountain','tamagotchi-bg-dojo','tamagotchi-bg-arena'];
            ALL_BG.forEach(t => container.classList.remove(t));
            container.classList.add('tamagotchi-bg-none');
            const staticBg = document.getElementById('tamagotchi-static-bg');
            const bgModel = document.getElementById('tamagotchi-bg-model');
            const floor = document.getElementById('tamagotchi-floor');
            if (staticBg) staticBg.style.display = 'none';
            if (bgModel) bgModel.style.display = 'none';
            if (floor) floor.style.display = 'none';
        }
        // Run after a short delay so models have time to initialize
        setTimeout(initBackground, 2500);
        // Also expose for other code
        window._initBackground = initBackground;
    })();
    </script>

    <!-- ============================================================
         PROGRESSION & BATTLE SYSTEM
         Stats (STR/HP/Mana), Stat Allocation, Battle Overhaul,
         Backgrounds, Move Picker
         ============================================================ -->
    <script>
    (function() {
        'use strict';
        console.log('🎮 Loading Progression & Battle System...');

        // ============================================================
        // STAT SYSTEM - Save/Load/Display
        // ============================================================
        const STAT_MAX = 150; // Visual max for bar display
        const DEFAULT_STATS = { str: 0, hp: 0, mana: 0 };

        // Points per level (front-loaded)
        function getStatPointsForLevel(level) {
            if (level <= 10) return 3;
            if (level <= 20) return 2;
            return 1;
        }

        // Bonus points at skin evolution levels
        const EVOLUTION_BONUS_LEVELS = [10, 20, 30, 40, 50];
        const EVOLUTION_BONUS_POINTS = 5;

        function getBattleStats() {
            try {
                const saved = localStorage.getItem('battleStats');
                return saved ? { ...DEFAULT_STATS, ...JSON.parse(saved) } : { ...DEFAULT_STATS };
            } catch (e) {
                return { ...DEFAULT_STATS };
            }
        }

        function saveBattleStats(stats) {
            localStorage.setItem('battleStats', JSON.stringify(stats));
            updateStatBarsUI(stats);
            // Also save to DB if available
            saveBattleStatsToDb(stats);
        }

        async function saveBattleStatsToDb(stats) {
            if (!window.currentUser || !window.dbHelpers) return;
            try {
                const userId = window.currentUser.id || window.currentUser.user_id;
                const existing = await window.dbHelpers.userFacts.get(userId) || {};
                const currentAdditional = existing.additional_data || {};
                await window.dbHelpers.userFacts.upsert(userId, {
                    additional_data: { ...currentAdditional, battle_stats: stats }
                });
            } catch (e) {
                console.warn('Could not save battle stats to DB:', e);
            }
        }

        async function loadBattleStatsFromDb() {
            if (!window.currentUser || !window.dbHelpers) return;
            try {
                const userId = window.currentUser.id || window.currentUser.user_id;
                const facts = await window.dbHelpers.userFacts.get(userId);
                if (facts?.additional_data?.battle_stats) {
                    const dbStats = { ...DEFAULT_STATS, ...facts.additional_data.battle_stats };
                    localStorage.setItem('battleStats', JSON.stringify(dbStats));
                    updateStatBarsUI(dbStats);
                }
            } catch (e) {
                console.warn('Could not load battle stats from DB:', e);
            }
        }

        function updateStatBarsUI(stats) {
            const s = stats || getBattleStats();
            ['str', 'hp', 'mana'].forEach(stat => {
                const valEl = document.getElementById(`stat-${stat}-value`);
                const fillEl = document.getElementById(`stat-${stat}-fill`);
                if (valEl) valEl.textContent = s[stat];
                if (fillEl) fillEl.style.width = `${Math.min(100, (s[stat] / STAT_MAX) * 100)}%`;
            });
        }

        // Tooltip on stat tap
        window.showStatTooltip = function(stat) {
            const descriptions = {
                str: 'Strength increases your attack damage in battle',
                hp: 'Health Points give you more HP in battle',
                mana: 'Mana makes your special move charge faster'
            };
            if (typeof showToast === 'function') {
                showToast(descriptions[stat] || '', 'info');
            }
        };

        // Initialize stats on page load
        setTimeout(() => {
            updateStatBarsUI();
            loadBattleStatsFromDb();
        }, 2000);

        // ============================================================
        // STAT ALLOCATION MODAL
        // ============================================================
        // Track pending allocations
        let pendingAllocations = { str: 0, hp: 0, mana: 0 };

        function getUnallocatedPoints() {
            try {
                return parseInt(localStorage.getItem('unallocatedStatPoints') || '0');
            } catch (e) {
                return 0;
            }
        }

        function setUnallocatedPoints(pts) {
            localStorage.setItem('unallocatedStatPoints', String(Math.max(0, pts)));
        }

        // Called when user levels up - grants stat points
        function grantStatPoints(previousLevel, newLevel) {
            let totalNewPoints = 0;
            for (let lvl = previousLevel + 1; lvl <= newLevel; lvl++) {
                totalNewPoints += getStatPointsForLevel(lvl);
                if (EVOLUTION_BONUS_LEVELS.includes(lvl)) {
                    totalNewPoints += EVOLUTION_BONUS_POINTS;
                }
            }
            if (totalNewPoints > 0) {
                const current = getUnallocatedPoints();
                setUnallocatedPoints(current + totalNewPoints);
                console.log(`🎮 Granted ${totalNewPoints} stat points (levels ${previousLevel+1}-${newLevel})`);
                // The stat allocation modal is now shown by the celebration cleanup
                // in triggerLevelUpCelebration (Step 15) for correct timing.
                // No separate timeout needed here.
            }
        }

        function showStatAllocationModal() {
            const pointsLeft = getUnallocatedPoints();
            if (pointsLeft <= 0) return;

            const stats = getBattleStats();
            pendingAllocations = { str: 0, hp: 0, mana: 0 };

            const overlay = document.createElement('div');
            overlay.className = 'stat-alloc-overlay';
            overlay.id = 'stat-alloc-overlay';
            overlay.innerHTML = `
                <div class="stat-alloc-modal">
                    <div class="stat-alloc-header">
                        <h2>Power Up!</h2>
                        <div class="stat-alloc-points-left">You have <span id="alloc-points-left">${pointsLeft}</span> points to spend</div>
                    </div>
                    <div class="stat-alloc-body">
                        <div class="stat-alloc-row">
                            <div class="stat-alloc-icon str">⚔️</div>
                            <div class="stat-alloc-details">
                                <div class="stat-alloc-name">Strength</div>
                                <div class="stat-alloc-desc">Increases attack damage</div>
                            </div>
                            <div class="stat-alloc-current str" id="alloc-str-val">${stats.str}</div>
                            <button class="stat-alloc-btn str" onclick="window._allocStat('str')">+</button>
                        </div>
                        <div class="stat-alloc-row">
                            <div class="stat-alloc-icon hp">❤️</div>
                            <div class="stat-alloc-details">
                                <div class="stat-alloc-name">Health Points</div>
                                <div class="stat-alloc-desc">More HP in battle</div>
                            </div>
                            <div class="stat-alloc-current hp" id="alloc-hp-val">${stats.hp}</div>
                            <button class="stat-alloc-btn hp" onclick="window._allocStat('hp')">+</button>
                        </div>
                        <div class="stat-alloc-row">
                            <div class="stat-alloc-icon mana">🔮</div>
                            <div class="stat-alloc-details">
                                <div class="stat-alloc-name">Mana</div>
                                <div class="stat-alloc-desc">Faster special move charge</div>
                            </div>
                            <div class="stat-alloc-current mana" id="alloc-mana-val">${stats.mana}</div>
                            <button class="stat-alloc-btn mana" onclick="window._allocStat('mana')">+</button>
                        </div>
                    </div>
                    <div class="stat-alloc-footer">
                        <button class="stat-alloc-confirm" id="alloc-confirm-btn" onclick="window._confirmAlloc()" disabled>Allocate Points First</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        window._allocStat = function(stat) {
            const pointsLeftEl = document.getElementById('alloc-points-left');
            const currentPointsLeft = parseInt(pointsLeftEl.textContent);
            if (currentPointsLeft <= 0) return;

            const stats = getBattleStats();
            pendingAllocations[stat]++;
            const newVal = stats[stat] + pendingAllocations[stat];

            // Update display
            const valEl = document.getElementById(`alloc-${stat}-val`);
            if (valEl) {
                valEl.textContent = newVal;
                valEl.classList.remove('stat-pop');
                void valEl.offsetWidth;
                valEl.classList.add('stat-pop');
            }

            pointsLeftEl.textContent = currentPointsLeft - 1;

            // Update confirm button
            const confirmBtn = document.getElementById('alloc-confirm-btn');
            const totalAllocated = pendingAllocations.str + pendingAllocations.hp + pendingAllocations.mana;
            if (totalAllocated > 0) {
                confirmBtn.disabled = false;
                confirmBtn.textContent = currentPointsLeft - 1 > 0 ? `Spend More or Confirm` : `Confirm Allocation`;
            }

            // Disable + buttons if no points left
            if (currentPointsLeft - 1 <= 0) {
                document.querySelectorAll('.stat-alloc-btn').forEach(btn => btn.disabled = true);
            }
        };

        window._confirmAlloc = function() {
            const stats = getBattleStats();
            stats.str += pendingAllocations.str;
            stats.hp += pendingAllocations.hp;
            stats.mana += pendingAllocations.mana;
            saveBattleStats(stats);

            // Subtract spent points
            const totalSpent = pendingAllocations.str + pendingAllocations.hp + pendingAllocations.mana;
            const remaining = getUnallocatedPoints() - totalSpent;
            setUnallocatedPoints(remaining);

            // Close modal
            const overlay = document.getElementById('stat-alloc-overlay');
            if (overlay) overlay.remove();

            if (typeof showToast === 'function') {
                showToast('Stats allocated!', 'success');
            }

            pendingAllocations = { str: 0, hp: 0, mana: 0 };

            // If still have points, show again
            if (remaining > 0) {
                setTimeout(() => showStatAllocationModal(), 500);
            }
        };

        // Expose for level up system
        window.grantStatPoints = grantStatPoints;
        window.showStatAllocationModal = showStatAllocationModal;
        window.getBattleStats = getBattleStats;

        // ============================================================
        // SETTINGS - STAT ALLOCATION UI
        // ============================================================

        // Calculate total expected stat points for a given level
        function getTotalExpectedPointsForLevel(level) {
            let total = 0;
            for (let lvl = 1; lvl <= level; lvl++) {
                total += getStatPointsForLevel(lvl);
                if (EVOLUTION_BONUS_LEVELS.includes(lvl)) {
                    total += EVOLUTION_BONUS_POINTS;
                }
            }
            return total;
        }

        // Grant any missing stat points for users who leveled before the stat system existed
        function ensureRetroactiveStatPoints() {
            const level = window.getCurrentUserLevel ? window.getCurrentUserLevel() : 1;
            const expectedTotal = getTotalExpectedPointsForLevel(level);

            const stats = getBattleStats();
            const allocated = stats.str + stats.hp + stats.mana;
            const unallocated = getUnallocatedPoints();
            const actualTotal = allocated + unallocated;

            if (actualTotal < expectedTotal) {
                const missing = expectedTotal - actualTotal;
                setUnallocatedPoints(unallocated + missing);
                console.log(`🎮 Retroactively granted ${missing} stat points (level ${level}, expected ${expectedTotal}, had ${actualTotal})`);
            }
        }

        // Run retroactive check on load
        setTimeout(() => {
            ensureRetroactiveStatPoints();
        }, 3000);

        window.ensureRetroactiveStatPoints = ensureRetroactiveStatPoints;

        // ============================================================
        // BACKGROUND THEMES (combined into character model-viewer)
        // ============================================================
        function applyBackgroundForLevel(level) {
            // If user has manually selected a background, respect that choice
            const savedBg = localStorage.getItem('selectedBackground');
            if (savedBg && window.selectBackground) {
                window.selectBackground(savedBg);
                return;
            }

            const container = document.getElementById('tamagotchi-widget-container');
            if (!container) return;

            // Remove all CSS bg themes
            const ALL_BG_THEME_CLASSES_LOCAL = [
                'tamagotchi-bg-gym', 'tamagotchi-bg-park', 'tamagotchi-bg-home',
                'tamagotchi-bg-beach', 'tamagotchi-bg-mountain',
                'tamagotchi-bg-dojo', 'tamagotchi-bg-arena'
            ];
            ALL_BG_THEME_CLASSES_LOCAL.forEach(theme => container.classList.remove(theme));

            // Default to gym bg
            if (level >= 1) {
                container.classList.add('tamagotchi-bg-gym');
                const staticBg = document.getElementById('tamagotchi-static-bg');
                const bgModel = document.getElementById('tamagotchi-bg-model');
                const floor = document.getElementById('tamagotchi-floor');
                if (staticBg) {
                    staticBg.style.display = 'block';
                    staticBg.style.backgroundImage = "url('./assets/gym_bg.jpeg')";
                    staticBg.style.backgroundSize = 'cover';
                    staticBg.style.backgroundPosition = 'center center';
                }
                if (bgModel) bgModel.style.display = 'none';
                if (floor) floor.style.display = 'none';
            }
        }

        // Apply saved background or default on load
        setTimeout(() => {
            const savedBg = localStorage.getItem('selectedBackground');
            if (savedBg && window.selectBackground) {
                window.selectBackground(savedBg);
            } else {
                const levelEl = document.getElementById('tamagotchi-level');
                const level = levelEl ? parseInt(levelEl.textContent) || 1 : 1;
                applyBackgroundForLevel(level);
            }
        }, 2500);

        window.applyBackgroundForLevel = applyBackgroundForLevel;

        // ============================================================
        // BATTLE LEVEL GATE
        // ============================================================
        function updateBattleButtonLock() {
            const btn = document.querySelector('.battle-trigger-btn');
            if (!btn) return;
            const level = window.getCurrentUserLevel ? window.getCurrentUserLevel() : 1;
            if (level < 10) {
                btn.classList.add('locked');
            } else {
                btn.classList.remove('locked');
            }
        }

        setTimeout(updateBattleButtonLock, 2500);
        window.updateBattleButtonLock = updateBattleButtonLock;

        // ============================================================
        // MOVE PICKER (Pre-Battle)
        // ============================================================
        function showMovePicker() {
            return new Promise((resolve) => {
                const level = window.getCurrentUserLevel ? window.getCurrentUserLevel() : 1;
                const unlocks = (window.ANIMATION_UNLOCKS || []).filter(a => a.category === 'combat' && level >= a.unlockLevel);

                if (unlocks.length === 0) {
                    resolve({ name: 'boxing', displayName: 'Boxing', power: 1 });
                    return;
                }

                // Power rankings for combat moves
                const powerMap = {
                    'boxing': 1, 'kick': 1.5, 'karate': 2, 'boxing_1': 2.5,
                    'boxing_2': 3.5, 'kick_2': 4, 'block': 0
                };

                const container = document.getElementById('tamagotchi-widget-container');
                const picker = document.createElement('div');
                picker.className = 'move-picker-overlay';
                picker.id = 'move-picker';

                let html = '<div class="move-picker-title">Choose Your Move</div><div class="move-picker-grid">';
                unlocks.filter(u => u.name !== 'block').forEach(u => {
                    const power = powerMap[u.name] || 1;
                    const stars = '⭐'.repeat(Math.ceil(power));
                    html += `
                        <div class="move-picker-item" data-move="${u.name}" data-power="${power}">
                            <div class="pick-icon">${u.icon}</div>
                            <div class="pick-name">${u.displayName}</div>
                            <div class="pick-power">${stars}</div>
                        </div>`;
                });
                html += '</div>';
                picker.innerHTML = html;
                container.appendChild(picker);

                picker.querySelectorAll('.move-picker-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const moveName = item.dataset.move;
                        const movePower = parseFloat(item.dataset.power) || 1;
                        const unlock = unlocks.find(u => u.name === moveName);
                        picker.remove();
                        resolve({
                            name: moveName,
                            displayName: unlock?.displayName || moveName,
                            power: movePower,
                            icon: unlock?.icon || '👊'
                        });
                    });
                });
            });
        }

        // ============================================================
        // BATTLE INVITE SYSTEM
        // ============================================================
        window.startBattle = async function() {
            console.log('🥊 BATTLE BUTTON CLICKED');

            // Level gate
            const level = window.getCurrentUserLevel ? window.getCurrentUserLevel() : 1;
            if (level < 10) {
                if (typeof showToast === 'function') {
                    showToast('Battle Mode unlocks at Level 10!', 'info');
                }
                return;
            }

            if (window._battleInProgress) return;

            // Show the invite friend modal
            showBattleInviteModal();
        };

        // Track current battle bet amount
        window._currentBattleBet = 0;

        async function showBattleInviteModal() {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'battle-invite-overlay';
            overlay.id = 'battle-invite-overlay';

            // Get coin balance for display
            let coinBalance = 0;
            try {
                if (window.supabaseClient && window.currentUser) {
                    const { data } = await window.supabaseClient.rpc('get_coin_balance', { user_uuid: window.currentUser.id });
                    coinBalance = data || 0;
                }
            } catch (e) {}

            let friendsHtml = '';

            try {
                // Fetch friends list
                if (window.supabaseClient && window.currentUser) {
                    const { data: friends, error } = await window.supabaseClient
                        .rpc('get_friends_with_status', { user_uuid: window.currentUser.id });

                    if (!error && friends && friends.length > 0) {
                        friendsHtml = friends.map(friend => {
                            const initials = (friend.friend_name || '?').charAt(0).toUpperCase();
                            const isActive = friend.has_workout_today || friend.has_meal_today;
                            const statusText = isActive ? 'Active today' : (friend.days_inactive > 0 ? `${friend.days_inactive}d ago` : 'Online');
                            const statusClass = isActive ? 'active' : '';
                            const photoHtml = friend.friend_photo
                                ? `<img src="${friend.friend_photo}" alt="${friend.friend_name}">`
                                : initials;
                            const streak = friend.current_streak > 0 ? ` 🔥${friend.current_streak}` : '';

                            return `
                                <div class="battle-invite-friend" onclick="window._sendBattleInvite('${friend.friend_id}', '${(friend.friend_name || '').replace(/'/g, "\\'")}')">
                                    <div class="battle-invite-avatar">${photoHtml}</div>
                                    <div class="battle-invite-info">
                                        <div class="battle-invite-name">${friend.friend_name || 'Friend'}${streak}</div>
                                        <div class="battle-invite-status ${statusClass}">${statusText}</div>
                                    </div>
                                    <button class="battle-invite-btn">Challenge</button>
                                </div>`;
                        }).join('');
                    }
                }
            } catch (e) {
                console.warn('Could not fetch friends for battle invite:', e);
            }

            overlay.innerHTML = `
                <div class="battle-invite-modal">
                    <div class="battle-invite-header">
                        <h2>⚔️ Battle Mode</h2>
                        <p>Choose your opponent</p>
                    </div>
                    <div class="battle-invite-body">
                        <!-- Coin Bet Picker -->
                        <div style="padding: 10px 0 14px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 0.8rem; color: rgba(255,255,255,0.6); font-weight: 600;">WAGER COINS</span>
                                <span style="font-size: 0.75rem; color: rgba(255,255,255,0.4);">Balance: 🪙 ${coinBalance.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <button onclick="window._setBattleBet(0, this)" class="battle-bet-btn active" style="flex: 1; min-width: 50px; padding: 8px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; color: white; font-weight: 700; font-size: 0.8rem; cursor: pointer;">Free</button>
                                <button onclick="window._setBattleBet(10, this)" class="battle-bet-btn" style="flex: 1; min-width: 50px; padding: 8px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.8rem; cursor: pointer;">🪙 10</button>
                                <button onclick="window._setBattleBet(50, this)" class="battle-bet-btn" style="flex: 1; min-width: 50px; padding: 8px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.8rem; cursor: pointer;">🪙 50</button>
                                <button onclick="window._setBattleBet(100, this)" class="battle-bet-btn" style="flex: 1; min-width: 50px; padding: 8px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.8rem; cursor: pointer;">🪙 100</button>
                                <button onclick="window._setBattleBet(500, this)" class="battle-bet-btn" style="flex: 1; min-width: 50px; padding: 8px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.8rem; cursor: pointer;">🪙 500</button>
                            </div>
                            <div style="margin-top: 8px;">
                                <input type="number" id="battle-custom-bet" placeholder="Or enter custom amount..." min="0" style="width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-size: 0.85rem; box-sizing: border-box;" oninput="window._setBattleBet(parseInt(this.value) || 0)">
                            </div>
                        </div>

                        <div class="battle-invite-friend battle-bot-option" onclick="window.closeBattleInvite(); window._runBattle('Bot');">
                            <div class="battle-invite-avatar" style="background: linear-gradient(135deg, rgba(100,100,255,0.4), rgba(150,50,255,0.4));">🤖</div>
                            <div class="battle-invite-info">
                                <div class="battle-invite-name">Practice Mode</div>
                                <div class="battle-invite-status active">Free training, no bet</div>
                            </div>
                            <button class="battle-invite-btn" style="background: linear-gradient(135deg, #7c3aed, #6366f1);">Fight</button>
                        </div>
                        ${friendsHtml ? '<div style="padding: 8px 0 4px; font-size: 0.7rem; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px;">Challenge a friend (bet applies)</div>' : ''}
                        ${friendsHtml}
                    </div>
                    <div class="battle-invite-footer">
                        <button class="battle-invite-close" onclick="window.closeBattleInvite()">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Close on backdrop click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) window.closeBattleInvite();
            });
        }

        window._setBattleBet = function(amount, btnEl) {
            window._currentBattleBet = amount;
            // Update active button styling
            if (btnEl) {
                document.querySelectorAll('.battle-bet-btn').forEach(b => {
                    b.style.background = 'rgba(255,255,255,0.08)';
                    b.style.borderColor = 'rgba(255,255,255,0.15)';
                    b.className = 'battle-bet-btn';
                });
                btnEl.style.background = 'rgba(255,255,255,0.15)';
                btnEl.style.borderColor = 'rgba(255,255,255,0.3)';
                btnEl.className = 'battle-bet-btn active';
            }
        };

        window.closeBattleInvite = function() {
            const overlay = document.getElementById('battle-invite-overlay');
            if (overlay) overlay.remove();
        };

        // ============================================================
        // ARENA MODE - Among Us-style battle arena
        // ============================================================
        window._arenaPlayerCount = 4;

        async function showArenaInviteModal() {
            // Level gate
            const level = window.getCurrentUserLevel ? window.getCurrentUserLevel() : 1;
            if (level < 10) {
                if (typeof showToast === 'function') showToast('Reach Level 10 to unlock Arena Mode!');
                return;
            }

            const overlay = document.createElement('div');
            overlay.className = 'arena-invite-overlay';
            overlay.id = 'arena-invite-overlay';

            let friendsHtml = '';
            try {
                if (window.supabaseClient && window.currentUser) {
                    const { data: friends, error } = await window.supabaseClient
                        .rpc('get_friends_with_status', { user_uuid: window.currentUser.id });

                    if (!error && friends && friends.length > 0) {
                        friendsHtml = friends.map(friend => {
                            const initials = (friend.friend_name || '?').charAt(0).toUpperCase();
                            const isActive = friend.has_workout_today || friend.has_meal_today;
                            const statusText = isActive ? 'Active today' : (friend.days_inactive > 0 ? `${friend.days_inactive}d ago` : 'Online');
                            const statusClass = isActive ? 'active' : '';
                            const photoHtml = friend.friend_photo
                                ? `<img src="${friend.friend_photo}" alt="${friend.friend_name}">`
                                : initials;
                            const streak = friend.current_streak > 0 ? ` 🔥${friend.current_streak}` : '';

                            return `
                                <div class="arena-invite-friend" onclick="window._launchArena('${friend.friend_id}', '${(friend.friend_name || '').replace(/'/g, "\\'")}')">
                                    <div class="arena-invite-avatar">${photoHtml}</div>
                                    <div class="arena-invite-info">
                                        <div class="arena-invite-name">${friend.friend_name || 'Friend'}${streak}</div>
                                        <div class="arena-invite-status ${statusClass}">${statusText}</div>
                                    </div>
                                    <button class="arena-invite-btn">Invite</button>
                                </div>`;
                        }).join('');
                    }
                }
            } catch (e) {
                console.warn('Could not fetch friends for arena invite:', e);
            }

            overlay.innerHTML = `
                <div class="arena-invite-modal">
                    <div class="arena-invite-header">
                        <h2>🗺️ Arena Mode</h2>
                        <p>Run around, find opponents, battle it out!</p>
                    </div>
                    <div class="arena-invite-body">
                        <!-- Player count -->
                        <div style="padding: 10px 0 14px;">
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); font-weight: 600; margin-bottom: 8px;">ARENA SIZE</div>
                            <div class="arena-player-count">
                                <button onclick="window._setArenaCount(4, this)" class="arena-count-btn active">4 Players</button>
                                <button onclick="window._setArenaCount(6, this)" class="arena-count-btn">6 Players</button>
                                <button onclick="window._setArenaCount(8, this)" class="arena-count-btn">8 Players</button>
                            </div>
                        </div>

                        <div class="arena-invite-friend" onclick="window._launchArena(null, null)">
                            <div class="arena-invite-avatar" style="background: linear-gradient(135deg, rgba(16,185,129,0.4), rgba(5,150,105,0.4));">🤖</div>
                            <div class="arena-invite-info">
                                <div class="arena-invite-name">Solo Practice</div>
                                <div class="arena-invite-status" style="color:#10b981;">Play vs bots</div>
                            </div>
                            <button class="arena-invite-btn">Play</button>
                        </div>
                        ${friendsHtml ? '<div style="padding: 8px 0 4px; font-size: 0.7rem; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px;">Invite friends to the arena</div>' : ''}
                        ${friendsHtml || '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4);font-size:0.85rem;">Add friends from the Feed to invite them!</div>'}
                    </div>
                    <div class="arena-invite-footer">
                        <button class="arena-invite-close" onclick="window.closeArenaInvite()">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) window.closeArenaInvite();
            });
        }

        window.showArenaInviteModal = showArenaInviteModal;

        window._setArenaCount = function(count, btnEl) {
            window._arenaPlayerCount = count;
            if (btnEl) {
                document.querySelectorAll('.arena-count-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btnEl.classList.add('active');
            }
        };

        window.closeArenaInvite = function() {
            const overlay = document.getElementById('arena-invite-overlay');
            if (overlay) overlay.remove();
        };

        window._launchArena = function(friendId, friendName) {
            window.closeArenaInvite();
            // Navigate to arena with params
            const params = new URLSearchParams();
            params.set('players', window._arenaPlayerCount || 4);
            if (friendId) {
                params.set('invite', friendId);
                params.set('inviteName', friendName || '');
            }
            window.location.href = 'battle-arena.html?' + params.toString();
        };

        // Arena level gate
        function updateArenaButtonLock() {
            const btn = document.querySelector('.arena-trigger-btn');
            if (!btn) return;
            const level = window.getCurrentUserLevel ? window.getCurrentUserLevel() : 1;
            if (level < 10) {
                btn.classList.add('locked');
            } else {
                btn.classList.remove('locked');
            }
        }
        setTimeout(updateArenaButtonLock, 2500);
        window.updateArenaButtonLock = updateArenaButtonLock;

        window._sendBattleInvite = async function(friendId, friendName) {
            const betAmount = window._currentBattleBet || 0;

            // Debit coins for the bet before starting
            if (betAmount > 0 && window.supabaseClient && window.currentUser) {
                try {
                    const { data: newBalance, error } = await window.supabaseClient
                        .rpc('debit_coins', {
                            user_uuid: window.currentUser.id,
                            coin_amount: betAmount,
                            txn_type: 'battle_bet',
                            txn_description: 'Battle bet vs ' + friendName,
                            txn_reference: friendId
                        });

                    if (error) throw error;

                    if (newBalance === -1) {
                        alert('Not enough coins for this bet!');
                        return;
                    }

                    if (typeof updateCoinBalanceDisplay === 'function') updateCoinBalanceDisplay(newBalance);
                } catch (e) {
                    console.warn('Could not debit battle bet:', e);
                    alert('Failed to place bet. Please try again.');
                    return;
                }
            }

            window.closeBattleInvite();

            // Create tamagotchi battle record in DB
            let battleId = null;
            const stats = getBattleStats();
            const level = window.getCurrentUserLevel ? window.getCurrentUserLevel() : 1;
            try {
                if (window.supabaseClient && window.currentUser) {
                    const { data, error } = await window.supabaseClient
                        .rpc('create_tamagotchi_battle', {
                            p_challenger_id: window.currentUser.id,
                            p_opponent_id: friendId,
                            p_coin_bet: betAmount,
                            p_challenger_stats: { str: stats.str, hp: stats.hp, mana: stats.mana, level }
                        });
                    if (error) throw error;
                    battleId = data;
                }
            } catch (e) {
                console.warn('Could not create tamagotchi battle:', e);
            }

            // Send battle invite via nudges table
            try {
                if (window.supabaseClient && window.currentUser) {
                    const userId = window.currentUser.id || window.currentUser.user_id;

                    await window.supabaseClient
                        .from('nudges')
                        .insert({
                            sender_id: userId,
                            receiver_id: friendId,
                            message: betAmount > 0
                                ? '⚔️ BATTLE CHALLENGE! 🪙 ' + betAmount + ' coin bet! Tap to accept and fight!'
                                : '⚔️ BATTLE CHALLENGE! Tap to accept and fight!',
                            coin_bet: betAmount
                        });

                    console.log('Battle invite sent to', friendName, 'bet:', betAmount);
                }
            } catch (e) {
                console.warn('Could not send battle invite:', e);
            }

            // Store battle info for PvP
            window._activeBattleBet = betAmount;
            window._activeBattleOpponentId = friendId;
            window._activeBattleId = battleId;
            window._isBattleChallenger = true;

            // Start battle — will enter waiting room if PvP (battleId set)
            window._runBattle(friendName || 'Opponent');
        };

        window.cancelBattleWait = function(opponentName) {
            if (window._battleWaitTimer) {
                clearTimeout(window._battleWaitTimer);
                window._battleWaitTimer = null;
            }
            const waiting = document.getElementById('battle-waiting-overlay');
            if (waiting) waiting.remove();

            // Start the actual battle
            window._runBattle(opponentName || 'Opponent');
        };

        // ============================================================
        // INCOMING BATTLE CHALLENGE NOTIFICATION
        // ============================================================
        function showBattleChallengeNotification(fromName, fromId, battleId, coinBet) {
            // Remove existing challenge toasts
            document.querySelectorAll('.battle-challenge-toast:not(.quiz-battle-challenge-toast)').forEach(el => el.remove());

            const betText = coinBet > 0 ? ` 🪙 ${coinBet} coins` : '';
            const toast = document.createElement('div');
            toast.className = 'battle-challenge-toast';
            toast.innerHTML = `
                <div class="battle-challenge-header">
                    <div class="battle-challenge-icon">⚔️</div>
                    <div>
                        <div class="battle-challenge-title">Battle Challenge!</div>
                        <div class="battle-challenge-from">${fromName} wants to fight!${betText}</div>
                    </div>
                </div>
                <div class="battle-challenge-actions">
                    <button class="battle-challenge-accept" onclick="acceptBattleChallenge('${fromId}', '${fromName.replace(/'/g, "\\'")}', this, '${battleId || ''}', ${coinBet || 0})">Accept</button>
                    <button class="battle-challenge-decline" onclick="this.closest('.battle-challenge-toast').remove()">Decline</button>
                </div>
            `;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto-dismiss after 30 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 400);
                }
            }, 30000);
        }

        window.acceptBattleChallenge = async function(fromId, fromName, btn, battleId, coinBet) {
            const toast = btn.closest('.battle-challenge-toast');
            if (toast) toast.remove();

            // If we have a battleId, this is a PvP battle — join it and debit coins
            if (battleId && window.supabaseClient && window.currentUser) {
                // Debit opponent's coins
                if (coinBet > 0) {
                    try {
                        const { data: newBalance, error } = await window.supabaseClient
                            .rpc('debit_coins', {
                                user_uuid: window.currentUser.id,
                                coin_amount: coinBet,
                                txn_type: 'battle_bet',
                                txn_description: 'Battle bet vs ' + fromName,
                                txn_reference: battleId
                            });
                        if (error) throw error;
                        if (newBalance === -1) {
                            alert('Not enough coins for this bet!');
                            return;
                        }
                        if (typeof updateCoinBalanceDisplay === 'function') updateCoinBalanceDisplay(newBalance);
                    } catch (e) {
                        console.warn('Could not debit battle bet:', e);
                        alert('Failed to place bet. Please try again.');
                        return;
                    }
                }

                // Join the battle in DB
                const stats = getBattleStats();
                const level = window.getCurrentUserLevel ? window.getCurrentUserLevel() : 1;
                try {
                    const { data, error } = await window.supabaseClient
                        .rpc('join_tamagotchi_battle', {
                            p_battle_id: battleId,
                            p_user_id: window.currentUser.id,
                            p_opponent_stats: { str: stats.str, hp: stats.hp, mana: stats.mana, level }
                        });
                    if (error) throw error;
                    if (data && data.error) {
                        if (typeof showToast === 'function') showToast('Battle ' + data.error, 'error');
                        return;
                    }
                } catch (e) {
                    console.warn('Could not join tamagotchi battle:', e);
                }

                // Set PvP state
                window._activeBattleBet = coinBet || 0;
                window._activeBattleOpponentId = fromId;
                window._activeBattleId = battleId;
                window._isBattleChallenger = false;
            }

            // Navigate to dashboard if needed
            if (typeof switchAppTab === 'function' && typeof currentActiveTab !== 'undefined' && currentActiveTab !== 'dashboard') {
                const dashBtn = document.querySelector('.bottom-nav .nav-item');
                switchAppTab('dashboard', dashBtn);
                setTimeout(() => window._runBattle(fromName), 500);
            } else {
                window._runBattle(fromName);
            }
        };

        // Poll for incoming battle challenges (check nudges)
        async function checkForBattleChallenges() {
            if (!window.supabaseClient || !window.currentUser) return;
            try {
                const userId = window.currentUser.id || window.currentUser.user_id;
                const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();

                const { data, error } = await window.supabaseClient
                    .from('nudges')
                    .select('id, sender_id, message, coin_bet, created_at')
                    .eq('receiver_id', userId)
                    .like('message', '%BATTLE CHALLENGE%')
                    .is('read_at', null)
                    .gte('created_at', fiveMinAgo)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (!error && data && data.length > 0) {
                    const challenge = data[0];

                    // Skip quiz battle nudges
                    if (challenge.message.includes('QUIZ BATTLE')) return;

                    // Mark as read
                    await window.supabaseClient
                        .from('nudges')
                        .update({ read_at: new Date().toISOString() })
                        .eq('id', challenge.id);

                    // Get sender name
                    const { data: sender } = await window.supabaseClient
                        .from('users')
                        .select('name')
                        .eq('id', challenge.sender_id)
                        .single();

                    const senderName = sender?.name || 'A friend';

                    // Find the tamagotchi battle record
                    let battleId = null;
                    let coinBet = challenge.coin_bet || 0;
                    try {
                        const { data: battles } = await window.supabaseClient
                            .from('tamagotchi_battles')
                            .select('id, coin_bet')
                            .eq('challenger_id', challenge.sender_id)
                            .eq('opponent_id', userId)
                            .eq('status', 'pending')
                            .order('created_at', { ascending: false })
                            .limit(1);
                        if (battles && battles.length > 0) {
                            battleId = battles[0].id;
                            coinBet = battles[0].coin_bet;
                        }
                    } catch (e) {}

                    showBattleChallengeNotification(senderName, challenge.sender_id, battleId, coinBet);
                }
            } catch (e) {
                // Silently fail
            }
        }

        // Check for challenges every 15 seconds
        setInterval(checkForBattleChallenges, 15000);
        // Initial check after page load
        setTimeout(checkForBattleChallenges, 5000);

        // ============================================================
        // INCOMING QUIZ BATTLE CHALLENGE NOTIFICATION
        // ============================================================
        function showQuizBattleChallengeNotification(fromName, fromId, battleId, coinBet) {
            // Remove existing quiz battle toasts
            document.querySelectorAll('.quiz-battle-challenge-toast').forEach(el => el.remove());

            const toast = document.createElement('div');
            toast.className = 'battle-challenge-toast quiz-battle-challenge-toast';
            toast.innerHTML = `
                <div class="battle-challenge-header">
                    <div class="battle-challenge-icon" style="background: linear-gradient(135deg, rgba(124,58,237,0.3), rgba(99,102,241,0.3));">⚡</div>
                    <div>
                        <div class="battle-challenge-title">Quiz Battle!</div>
                        <div class="battle-challenge-from">${fromName} challenges you!${coinBet > 0 ? ' 🪙 ' + coinBet + ' coins' : ''}</div>
                    </div>
                </div>
                <div class="battle-challenge-actions">
                    <button class="battle-challenge-accept" style="background: linear-gradient(135deg, #7c3aed, #6366f1);" onclick="window._acceptQuizBattleFromToast('${battleId}', '${fromName.replace(/'/g, "\\'")}', ${coinBet}, this)">Accept</button>
                    <button class="battle-challenge-decline" onclick="this.closest('.battle-challenge-toast').remove()">Decline</button>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto-dismiss after 60 seconds (longer for quiz battles)
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 400);
                }
            }, 60000);
        }

        window._acceptQuizBattleFromToast = function(battleId, fromName, coinBet, btn) {
            const toast = btn.closest('.battle-challenge-toast');
            if (toast) toast.remove();

            // Call the acceptQuizBattle function from learning-inline.js
            if (typeof window.acceptQuizBattle === 'function') {
                window.acceptQuizBattle(battleId, fromName, coinBet);
            }
        };

        // Poll for incoming quiz battle challenges
        async function checkForQuizBattleChallenges() {
            if (!window.supabaseClient || !window.currentUser) return;
            try {
                const userId = window.currentUser.id || window.currentUser.user_id;
                const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();

                const { data, error } = await window.supabaseClient
                    .from('nudges')
                    .select('id, sender_id, message, coin_bet, created_at')
                    .eq('receiver_id', userId)
                    .like('message', '%QUIZ BATTLE%')
                    .is('read_at', null)
                    .gte('created_at', fiveMinAgo)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (!error && data && data.length > 0) {
                    const challenge = data[0];

                    // Mark as read
                    await window.supabaseClient
                        .from('nudges')
                        .update({ read_at: new Date().toISOString() })
                        .eq('id', challenge.id);

                    // Get sender name
                    const { data: sender } = await window.supabaseClient
                        .from('users')
                        .select('name')
                        .eq('id', challenge.sender_id)
                        .single();

                    const senderName = sender?.name || 'A friend';

                    // Find the quiz battle record
                    const { data: battles } = await window.supabaseClient
                        .from('quiz_battles')
                        .select('id, coin_bet')
                        .eq('challenger_id', challenge.sender_id)
                        .eq('opponent_id', userId)
                        .eq('status', 'pending')
                        .order('created_at', { ascending: false })
                        .limit(1);

                    if (battles && battles.length > 0) {
                        showQuizBattleChallengeNotification(senderName, challenge.sender_id, battles[0].id, battles[0].coin_bet);
                    }
                }
            } catch (e) {
                // Silently fail
            }
        }

        // Check for quiz battle challenges every 15 seconds
        setInterval(checkForQuizBattleChallenges, 15000);
        setTimeout(checkForQuizBattleChallenges, 6000);

        // ============================================================
        // ACTUAL BATTLE ENGINE (renamed from startBattle)
        // ============================================================
        window._runBattle = async function(opponentName) {
            console.log('🥊 BATTLE START vs', opponentName);

            if (window._battleInProgress) return;
            window._battleInProgress = true;
            window.isDuringBattle = true;

            // PvP state
            const isPvP = !!window._activeBattleId;
            const battleId = window._activeBattleId || null;
            const isChallenger = window._isBattleChallenger || false;
            let battleChannel = null;
            let opponentReady = false;
            let opponentStats = null;

            try {

            const viewer = document.getElementById('tamagotchi-model');
            const overlay = document.getElementById('battle-mode-overlay');
            const overlayText = overlay?.querySelector('.battle-text');
            const widget = document.getElementById('tamagotchi-widget-container');
            const hpContainer = document.getElementById('battle-hp-container');
            const manaContainer = document.getElementById('battle-mana-container');
            const actionContainer = document.getElementById('battle-action-container');
            let bashBtn = document.getElementById('battle-btn-bash');

            if (!widget || !viewer) {
                window._battleInProgress = false;
                window.isDuringBattle = false;
                return;
            }

            // === SAVE ORIGINAL STATE ===
            const savedOrbit = viewer.getAttribute('camera-orbit');
            const hadAutoRotate = viewer.hasAttribute('auto-rotate');
            const hadCameraControls = viewer.hasAttribute('camera-controls');

            // === BATTLE DOJO BACKGROUND ===
            const battleBgClasses = ['tamagotchi-bg-gym','tamagotchi-bg-park','tamagotchi-bg-home','tamagotchi-bg-beach','tamagotchi-bg-mountain','tamagotchi-bg-dojo','tamagotchi-bg-arena'];
            const savedBgClasses = battleBgClasses.filter(c => widget.classList.contains(c));
            battleBgClasses.forEach(c => widget.classList.remove(c));
            widget.classList.add('tamagotchi-bg-dojo');
            const battleStaticBg = document.getElementById('tamagotchi-static-bg');
            if (battleStaticBg) {
                battleStaticBg.style.display = 'block';
                battleStaticBg.style.backgroundImage = "url('./assets/battle_dojo_bg.jpeg')";
                battleStaticBg.style.backgroundSize = 'cover';
                battleStaticBg.style.backgroundPosition = 'center center';
            }

            // === BATTLE CAMERA SETUP ===
            viewer.removeAttribute('auto-rotate');
            viewer.removeAttribute('camera-controls');

            if (typeof viewer.resetTurntableRotation === 'function') {
                viewer.resetTurntableRotation();
            }

            const orbitParts = (savedOrbit || '0deg 85deg 22m').split(/\s+/);
            const currentDist = orbitParts[2] || '22m';
            viewer.setAttribute('camera-orbit', `0deg 85deg ${currentDist}`);

            viewer.style.left = '-30%';

            // Get stats
            const stats = getBattleStats();
            const level = window.getCurrentUserLevel ? window.getCurrentUserLevel() : 1;
            const baseDmg = 20;
            const playerMaxHP = 100 + (stats.hp * 5);
            const playerSTR = stats.str;
            const playerMana = stats.mana;

            // Enemy stats: adaptive bot scales with user's FitGotchi level
            // Curve ramps up gradually - bot should feel beatable but increasingly challenging
            // Low levels (1-10): easy opponent to learn mechanics
            // Mid levels (11-30): competitive, ~50/50 feel
            // High levels (31-50+): tough, requires stat allocation and good moves
            let enemyMaxHP = Math.floor(70 + (level * 5) + Math.pow(level, 1.4));
            let enemyBaseDmg = Math.floor(12 + (level * 0.8) + Math.pow(level, 1.15));

            let playerHP = playerMaxHP;
            let enemyHP = enemyMaxHP;

            // Move picker
            const chosenMove = await showMovePicker();
            const movePower = chosenMove.power || 1;

            // === PvP WAITING ROOM ===
            if (isPvP && window.supabaseClient) {
                // Set up Realtime channel
                battleChannel = window.supabaseClient.channel('tamagotchi-battle-' + battleId);

                // Wait for opponent to be ready
                const myStats = { str: stats.str, hp: stats.hp, mana: stats.mana, movePower, level };
                let waitingResolve = null;

                battleChannel.on('broadcast', { event: 'ready' }, (payload) => {
                    if (payload.payload.userId !== (window.currentUser?.id)) {
                        opponentReady = true;
                        opponentStats = payload.payload.stats;
                        if (waitingResolve) waitingResolve();
                    }
                });

                await battleChannel.subscribe((status) => {
                    console.log('Battle channel status:', status);
                });

                // Broadcast our ready state
                await battleChannel.send({
                    type: 'broadcast',
                    event: 'ready',
                    payload: { userId: window.currentUser?.id, stats: myStats, name: window.currentUser?.user_metadata?.name || 'Player' }
                });

                // If challenger, show waiting room
                if (isChallenger && !opponentReady) {
                    if (overlayText && overlay) {
                        overlayText.textContent = 'WAITING...';
                        overlayText.style.fontSize = '1.5rem';
                        overlay.classList.add('active');
                    }

                    // Wait up to 2 minutes for opponent
                    await Promise.race([
                        new Promise(resolve => { waitingResolve = resolve; }),
                        new Promise(resolve => setTimeout(resolve, 120000))
                    ]);
                    waitingResolve = null;

                    if (overlayText) overlayText.style.fontSize = '';
                    if (overlay) overlay.classList.remove('active');

                    if (!opponentReady) {
                        // Timeout — fall back to bot mode
                        if (typeof showToast === 'function') showToast('Opponent didn\'t join. Fighting bot instead!', 'info');
                    }
                } else if (!isChallenger) {
                    // Opponent side: wait briefly for challenger's ready signal
                    if (!opponentReady) {
                        await Promise.race([
                            new Promise(resolve => { waitingResolve = resolve; }),
                            new Promise(resolve => setTimeout(resolve, 5000))
                        ]);
                        waitingResolve = null;
                    }
                }

                // Set enemy stats from real opponent if PvP connected
                if (opponentReady && opponentStats) {
                    enemyMaxHP = 100 + ((opponentStats.hp || 0) * 5);
                    enemyHP = enemyMaxHP;
                    enemyBaseDmg = baseDmg; // PvP: damage comes from opponent's broadcasts, not this formula
                }

                // Synced countdown (challenger broadcasts)
                if (isChallenger && opponentReady) {
                    for (let c = 3; c >= 0; c--) {
                        await battleChannel.send({ type: 'broadcast', event: 'countdown', payload: { count: c } });
                        if (c > 0) {
                            if (overlayText && overlay) {
                                overlayText.textContent = '' + c;
                                overlay.classList.add('active');
                            }
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                    if (overlay) overlay.classList.remove('active');
                } else if (!isChallenger && opponentReady) {
                    // Listen for countdown from challenger
                    await new Promise(resolve => {
                        let countdownDone = false;
                        battleChannel.on('broadcast', { event: 'countdown' }, (payload) => {
                            const c = payload.payload.count;
                            if (c > 0 && overlayText && overlay) {
                                overlayText.textContent = '' + c;
                                overlay.classList.add('active');
                            }
                            if (c <= 0 && !countdownDone) {
                                countdownDone = true;
                                if (overlay) overlay.classList.remove('active');
                                resolve();
                            }
                        });
                        // Fallback timeout
                        setTimeout(() => { if (!countdownDone) { countdownDone = true; resolve(); } }, 6000);
                    });
                }
            }

            const pvpConnected = isPvP && opponentReady && opponentStats;

            // Animations (shared across all battle functions) - declared early
            const anims = viewer.availableAnimations || [];
            const attackAnim = anims.find(a => a.toLowerCase() === chosenMove.name.toLowerCase())
                || anims.find(a => a.toLowerCase().includes(chosenMove.name.toLowerCase()))
                || anims.find(a => /^boxing$/i.test(a))
                || anims[0];
            const hitAnim = anims.find(a => /^hit_to_1$|^hit_to_2$|^hit_to_3$|^hit_to_head$|^hit_to_side$/i.test(a)) || anims[0];
            const loseAnim = anims.find(a => /^lose$|^die$|^die_1$/i.test(a)) || anims[0];

            // Bash system: mana reduces taps needed (30 base, min 10)
            const baseTapsNeeded = 30;
            const manaReduction = Math.floor(playerMana / 5); // every 5 mana = 1 less tap
            const tapsNeeded = Math.max(10, baseTapsNeeded - manaReduction);
            let bashCount = 0;
            let battleOver = false;
            let battleTimer = null;
            const BATTLE_DURATION = 30000; // 30 seconds

            // === ROUND SYSTEM ===
            let playerRoundWins = 0;
            let enemyRoundWins = 0;
            let currentRound = 0;
            const ROUNDS_TO_WIN = 2; // Best of 3: first to 2 wins

            // Show round transition overlay (e.g. "ROUND 2" with score "1 - 0")
            async function showRoundTransition(roundNum, pWins, eWins) {
                if (overlayText && overlay) {
                    // Show round number
                    overlay.style.color = '#FFD700';
                    overlay.style.textShadow = '0 0 30px rgba(255,215,0,0.8), 0 4px 20px rgba(0,0,0,0.7)';
                    overlayText.innerHTML = `<div style="font-size:1.2em;animation:roundTextPop 0.5s ease-out;">ROUND ${roundNum}</div>` +
                        (roundNum > 1 ? `<div style="font-size:0.6em;margin-top:8px;opacity:0.9;">${pWins} - ${eWins}</div>` : '');
                    overlay.classList.add('active');
                    playSound('bell');
                    await new Promise(r => setTimeout(r, 2000));
                    overlay.classList.remove('active');
                    overlay.style.color = '';
                    overlay.style.textShadow = '';
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            // Show round result briefly (e.g. "ROUND 1 - YOU WIN!")
            async function showRoundResult(roundNum, playerWonRound) {
                if (overlayText && overlay) {
                    const color = playerWonRound ? '#00ff00' : '#ff4444';
                    const text = playerWonRound ? 'YOU WIN!' : 'DEFEATED!';
                    overlay.style.color = color;
                    overlay.style.textShadow = `0 0 20px ${color}`;
                    overlayText.innerHTML = `<div style="font-size:0.8em;opacity:0.7;">ROUND ${roundNum}</div><div style="font-size:1.1em;margin-top:4px;">${text}</div>`;
                    overlay.classList.add('active');
                    playSound(playerWonRound ? 'victory' : 'hit');
                    await new Promise(r => setTimeout(r, 2000));
                    overlay.classList.remove('active');
                    overlay.style.color = '';
                    overlay.style.textShadow = '';
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            // Reset state between rounds
            function resetRoundState() {
                battleOver = false;
                superReady = false;
                bashCount = 0;
                botAttackCount = 0;
                blockSuccess = false;
                fireWindowOpen = false;
                blockWindowOpen = false;

                // Reset HP
                playerHP = playerMaxHP;
                enemyHP = enemyMaxHP;
                updateHPBars();

                // Reset bash UI (ring)
                updateBashUI();

                // Clear all timers
                if (autoAttackInterval) { clearInterval(autoAttackInterval); autoAttackInterval = null; }
                if (enemyAttackInterval) { clearTimeout(enemyAttackInterval); enemyAttackInterval = null; }
                if (battleTimer) { clearInterval(battleTimer); battleTimer = null; }
                if (fireTimeout) { clearTimeout(fireTimeout); fireTimeout = null; }
                if (blockTimeout) { clearTimeout(blockTimeout); blockTimeout = null; }

                // Hide fire/block buttons
                if (fireBtn) fireBtn.style.display = 'none';
                if (blockBtn) blockBtn.style.display = 'none';
            }

            // Re-attach event listeners to fresh button references after cloneNode
            function reattachBattleListeners() {
                bashBtn = document.getElementById('battle-btn-bash');
                if (bashBtn) {
                    bashBtn.addEventListener('click', onBash);
                    bashBtn.addEventListener('touchstart', (e) => { e.preventDefault(); onBash(); }, { passive: false });
                }
                // Fire button - get fresh reference
                const freshFireBtn = document.getElementById('battle-btn-fire');
                if (freshFireBtn) {
                    freshFireBtn.addEventListener('click', onFireTap);
                    freshFireBtn.addEventListener('touchstart', (e) => { e.preventDefault(); onFireTap(); }, { passive: false });
                }
                // Block button - get fresh reference
                const freshBlockBtn = document.getElementById('battle-btn-block');
                if (freshBlockBtn) {
                    freshBlockBtn.addEventListener('click', onBlockTap);
                    freshBlockBtn.addEventListener('touchstart', (e) => { e.preventDefault(); onBlockTap(); }, { passive: false });
                }
            }

            // UI elements
            const bashRingFill = document.getElementById('bash-ring-fill');
            const ringCircumference = 163.36; // 2 * PI * 26

            function updateBashUI() {
                // Update progress ring
                const progress = (bashCount % tapsNeeded) / tapsNeeded;
                if (bashRingFill) {
                    bashRingFill.style.strokeDashoffset = ringCircumference * (1 - progress);
                }
            }

            // HP bar updates
            function updateHPBars() {
                const playerFill = document.getElementById('battle-hp-player');
                const playerText = document.getElementById('battle-hp-player-text');
                const enemyFill = document.getElementById('battle-hp-enemy');
                const enemyText = document.getElementById('battle-hp-enemy-text');
                const playerPct = Math.max(0, (playerHP / playerMaxHP) * 100);
                const enemyPct = Math.max(0, (enemyHP / enemyMaxHP) * 100);
                if (playerFill) playerFill.style.width = playerPct + '%';
                if (playerText) playerText.textContent = `${Math.max(0, Math.round(playerHP))} / ${playerMaxHP}`;
                if (enemyFill) enemyFill.style.width = enemyPct + '%';
                if (enemyText) enemyText.textContent = `${Math.max(0, Math.round(enemyHP))} / ${enemyMaxHP}`;
            }

            function playSound(name) {
                if (typeof playBattleSound === 'function') playBattleSound(name);
            }

            // Triple fireball using special.png
            function spawnTripleFireball(container) {
                const offsets = [-80, 0, 80]; // top, middle, bottom spread
                offsets.forEach((yOff, i) => {
                    const fb = document.createElement('div');
                    fb.innerHTML = `<img src="./assets/special.png" style="width:140px;height:140px;border-radius:50%;filter:drop-shadow(0 0 30px gold) brightness(1.3);">`;
                    fb.style.cssText = `position:absolute; left:150px; top:calc(50% + ${yOff}px); transform:translateY(-50%); z-index:100; pointer-events:none;`;
                    container.appendChild(fb);
                    let posX = 150;
                    const speed = 5 + i; // slightly different speeds for spread effect (50% slower)
                    function move() {
                        posX += speed;
                        fb.style.left = posX + 'px';
                        if (posX > container.clientWidth) fb.remove();
                        else requestAnimationFrame(move);
                    }
                    setTimeout(() => move(), i * 60); // stagger slightly
                });
            }

            // Incoming enemy fireball
            function spawnIncomingBattleFireball(container) {
                return new Promise(resolve => {
                    const fb = document.createElement('div');
                    fb.innerHTML = `<img src="./assets/fireball.png" style="width:140px;height:140px; transform:scaleX(-1); filter:drop-shadow(0 0 22px orange);" onerror="this.style.background='radial-gradient(circle, orange, red)'; this.style.borderRadius='50%';">`;
                    fb.style.cssText = 'position:absolute; right:-150px; top:50%; transform:translateY(-50%); z-index:100; pointer-events:none;';
                    container.appendChild(fb);
                    let posX = container.clientWidth;
                    const targetX = container.clientWidth / 2;
                    const speed = 4;
                    function move() {
                        posX -= speed;
                        fb.style.left = posX + 'px';
                        if (posX <= targetX) { fb.remove(); resolve(); }
                        else requestAnimationFrame(move);
                    }
                    move();
                });
            }

            // Track if super attack is ready
            let superReady = false;

            // Normal auto-attack (character attacks on a timer)
            function spawnNormalFireball(container) {
                const fb = document.createElement('div');
                fb.innerHTML = `<img src="./assets/fireball.png" style="width:140px;height:140px;filter:drop-shadow(0 0 22px orange);" onerror="this.style.background='radial-gradient(circle, orange, red)'; this.style.borderRadius='50%';">`;
                fb.style.cssText = `position:absolute; left:150px; top:50%; transform:translateY(-50%); z-index:100; pointer-events:none;`;
                container.appendChild(fb);
                let posX = 150;
                function move() {
                    posX += 5;
                    fb.style.left = posX + 'px';
                    if (posX > container.clientWidth) fb.remove();
                    else requestAnimationFrame(move);
                }
                move();
            }

            // Broadcast damage to opponent via Realtime (PvP only)
            function broadcastAttack(damage, isSuper) {
                if (battleChannel && pvpConnected) {
                    battleChannel.send({
                        type: 'broadcast',
                        event: 'attack',
                        payload: { userId: window.currentUser?.id, damage, isSuper }
                    });
                }
            }

            // Fire super attack (3 parallel fireballs with special.jpeg)
            function fireSuperAttack() {
                viewer.animationName = attackAnim;
                viewer.play();

                const damage = (baseDmg + playerSTR) * movePower * 1.0;

                // In PvP, don't reduce enemy HP locally — opponent handles their own HP
                // In bot mode, reduce enemy HP directly
                if (!pvpConnected) {
                    enemyHP -= damage;
                    updateHPBars();
                }
                broadcastAttack(damage, true);

                spawnTripleFireball(widget);
                playSound('whoosh');

                // Screen shake
                widget.style.transform = 'translateX(5px)';
                setTimeout(() => widget.style.transform = 'translateX(-5px)', 50);
                setTimeout(() => widget.style.transform = 'translateX(3px)', 100);
                setTimeout(() => widget.style.transform = '', 150);

                // Flash bash button gold briefly
                if (bashBtn) {
                    bashBtn.classList.add('attack-ready');
                    setTimeout(() => bashBtn.classList.remove('attack-ready'), 400);
                }

                superReady = false;
                bashCount = 0;
                updateBashUI();

                if (!pvpConnected && enemyHP <= 0) {
                    battleOver = true;
                }
            }

            // Normal auto-attack
            function fireNormalAttack() {
                viewer.animationName = attackAnim;
                viewer.play();

                const damage = (baseDmg + playerSTR) * movePower * 0.2;

                if (!pvpConnected) {
                    enemyHP -= damage;
                    updateHPBars();
                }
                broadcastAttack(damage, false);

                spawnNormalFireball(widget);
                playSound('whoosh');

                if (!pvpConnected && enemyHP <= 0) {
                    battleOver = true;
                }
            }

            // Auto-attack timer: character fires normal attacks every 2.5s
            // Super attacks are now player-triggered via the FIRE button
            let autoAttackInterval = null;
            function startAutoAttacks() {
                autoAttackInterval = setInterval(() => {
                    if (battleOver) return;
                    // Only fire normal attacks - super is manual via FIRE button
                    if (!superReady) {
                        fireNormalAttack();
                    }
                }, 2500);
            }

            // Incoming triple special fireball (3 blue fireballs from right side)
            function spawnIncomingTripleFireball(container) {
                return new Promise(resolve => {
                    const offsets = [-60, 0, 60];
                    let resolved = false;
                    offsets.forEach((yOff, i) => {
                        const fb = document.createElement('div');
                        fb.innerHTML = `<img src="./assets/special.png" style="width:140px;height:140px;border-radius:50%;transform:scaleX(-1);filter:drop-shadow(0 0 30px cyan) brightness(1.3);">`;
                        fb.style.cssText = `position:absolute; right:-150px; top:calc(50% + ${yOff}px); transform:translateY(-50%); z-index:100; pointer-events:none;`;
                        container.appendChild(fb);
                        let posX = container.clientWidth;
                        const targetX = container.clientWidth / 2;
                        const speed = 4 + i;
                        function move() {
                            posX -= speed;
                            fb.style.left = posX + 'px';
                            if (posX <= targetX) {
                                fb.remove();
                                if (!resolved) { resolved = true; resolve(); }
                            }
                            else requestAnimationFrame(move);
                        }
                        setTimeout(() => move(), i * 60);
                    });
                });
            }

            // Bot enemy counter-attacks (only used in bot mode)
            // Attack speed scales with level: 4.5s at level 1 down to 1.8s at level 50+
            let enemyAttackInterval = null;
            let botAttackCount = 0;
            function startEnemyAttacks() {
                const baseInterval = Math.max(1800, 4500 - Math.floor(Math.pow(level, 1.1) * 50));
                // Bot fires a super attack every 4th hit (scales with level - higher levels do it every 3rd)
                const superEvery = level >= 30 ? 3 : 4;

                function scheduleNextAttack() {
                    if (battleOver) return;
                    // Add +/- 20% variance so bot doesn't feel like a metronome
                    const variance = baseInterval * (0.8 + Math.random() * 0.4);
                    enemyAttackInterval = setTimeout(async () => {
                        if (battleOver) return;

                        botAttackCount++;
                        const isSuper = (botAttackCount % superEvery === 0);

                        // Show BLOCK button before the attack lands
                        showBlockButton();
                        // Brief delay for the block window before fireball spawns
                        await new Promise(r => setTimeout(r, Math.min(blockWindowMs, 200)));

                        if (battleOver) { scheduleNextAttack(); return; }

                        if (isSuper) {
                            await spawnIncomingTripleFireball(widget);
                        } else {
                            await spawnIncomingBattleFireball(widget);
                        }
                        viewer.animationName = hitAnim;
                        viewer.play();
                        playSound('hit');

                        // Check if player blocked
                        const blocked = consumeBlock();

                        const hitFlash = document.createElement('div');
                        if (blocked) {
                            hitFlash.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(96,165,250,0.3);z-index:998;pointer-events:none;';
                        } else {
                            hitFlash.style.cssText = `position:absolute;top:0;left:0;width:100%;height:100%;background:${isSuper ? 'cyan' : 'red'};opacity:${isSuper ? '0.4' : '0.3'};z-index:998;pointer-events:none;`;
                        }
                        widget.appendChild(hitFlash);
                        setTimeout(() => hitFlash.remove(), isSuper ? 250 : 150);

                        // Calculate damage (50% reduction if blocked)
                        const dmgVariance = 0.75 + Math.random() * 0.5;
                        const dmgMultiplier = isSuper ? 1.5 : 1.0;
                        const blockMultiplier = blocked ? 0.5 : 1.0;
                        const finalDmg = Math.floor(enemyBaseDmg * dmgVariance * dmgMultiplier * blockMultiplier);
                        playerHP -= finalDmg;
                        updateHPBars();

                        // Screen shake on super (less if blocked)
                        if (isSuper && !blocked) {
                            widget.style.animation = 'none';
                            widget.offsetHeight;
                            widget.style.animation = 'battleShake 0.4s ease';
                        }

                        if (playerHP <= 0) battleOver = true;

                        scheduleNextAttack();
                    }, variance);
                }
                scheduleNextAttack();
            }

            // PvP: listen for real opponent attacks via Realtime
            function listenForOpponentAttacks() {
                if (!battleChannel) return;
                battleChannel.on('broadcast', { event: 'attack' }, async (payload) => {
                    if (battleOver) return;
                    if (payload.payload.userId === window.currentUser?.id) return; // Ignore own attacks

                    const damage = payload.payload.damage || 0;
                    const isSuper = payload.payload.isSuper;

                    // Show BLOCK button before incoming attack
                    showBlockButton();
                    await new Promise(r => setTimeout(r, Math.min(blockWindowMs, 200)));

                    // Show incoming fireball + hit effects
                    if (isSuper) {
                        await spawnIncomingTripleFireball(widget);
                    } else {
                        await spawnIncomingBattleFireball(widget);
                    }

                    viewer.animationName = hitAnim;
                    viewer.play();
                    playSound('hit');

                    // Check if player blocked
                    const blocked = consumeBlock();

                    const hitFlash = document.createElement('div');
                    if (blocked) {
                        hitFlash.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(96,165,250,0.3);z-index:998;pointer-events:none;';
                    } else {
                        hitFlash.style.cssText = `position:absolute;top:0;left:0;width:100%;height:100%;background:${isSuper ? 'cyan' : 'red'};opacity:${isSuper ? '0.4' : '0.3'};z-index:998;pointer-events:none;`;
                        // Screen shake on unblocked super
                        if (isSuper) {
                            widget.style.animation = 'none';
                            widget.offsetHeight;
                            widget.style.animation = 'battleShake 0.4s ease';
                        }
                    }
                    widget.appendChild(hitFlash);
                    setTimeout(() => hitFlash.remove(), isSuper ? 250 : 150);

                    // Take damage (50% reduction if blocked)
                    const blockMult = blocked ? 0.5 : 1.0;
                    playerHP -= Math.floor(damage * blockMult);
                    updateHPBars();
                    if (playerHP <= 0) battleOver = true;
                });

                // Listen for opponent finishing
                battleChannel.on('broadcast', { event: 'finished' }, (payload) => {
                    if (payload.payload.userId !== window.currentUser?.id) {
                        // Opponent has submitted their result — we should finish too if not already
                        console.log('Opponent finished battle');
                    }
                });
            }

            // Bash button handler — bashing charges the super attack
            // === FIRE BUTTON LOGIC ===
            let fireBtn = document.getElementById('battle-btn-fire');
            let fireTimeout = null;
            let fireWindowOpen = false;

            function showFireButton() {
                if (battleOver || fireWindowOpen) return;
                fireWindowOpen = true;
                if (fireBtn) {
                    fireBtn.style.display = 'flex';
                    fireBtn.style.animation = 'actionBtnAppear 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), firePulse 0.5s ease-in-out infinite alternate';
                }
                if (bashBtn) bashBtn.classList.add('attack-ready');
                if (navigator.vibrate) navigator.vibrate([50, 30, 100]);

                // 1.5s window to tap FIRE - miss it and charge resets
                fireTimeout = setTimeout(() => {
                    if (fireWindowOpen) {
                        hideFireButton(true); // missed - reset charge
                    }
                }, 1500);
            }

            function hideFireButton(missed) {
                fireWindowOpen = false;
                if (fireTimeout) { clearTimeout(fireTimeout); fireTimeout = null; }
                if (fireBtn) {
                    fireBtn.style.animation = 'actionBtnDisappear 0.15s ease-out forwards';
                    setTimeout(() => { fireBtn.style.display = 'none'; }, 150);
                }
                if (bashBtn) bashBtn.classList.remove('attack-ready');
                if (missed) {
                    // Charge lost - reset bash count
                    superReady = false;
                    bashCount = 0;
                    updateBashUI();
                    if (typeof showToast === 'function') showToast('Special missed! Charge again...', 'info');
                }
            }

            function onFireTap() {
                if (!fireWindowOpen || battleOver) return;
                hideFireButton(false);
                fireSuperAttack();
            }

            if (fireBtn) {
                fireBtn.addEventListener('click', onFireTap);
                fireBtn.addEventListener('touchstart', (e) => { e.preventDefault(); onFireTap(); }, { passive: false });
            }

            // === BLOCK BUTTON LOGIC ===
            let blockBtn = document.getElementById('battle-btn-block');
            let blockWindowOpen = false;
            let blockTimeout = null;
            let blockSuccess = false;
            // Block window duration scales with level: 0.5s at L1, 0.25s at L50+
            // Tight timing - block button appears right before impact
            const blockWindowMs = Math.max(250, 500 - Math.floor(level * 5));

            function showBlockButton() {
                if (battleOver || blockWindowOpen || fireWindowOpen) return;
                blockWindowOpen = true;
                blockSuccess = false;
                if (blockBtn) {
                    blockBtn.style.display = 'flex';
                    blockBtn.style.animation = 'actionBtnAppear 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), blockPulse 0.4s ease-in-out infinite alternate';
                }

                blockTimeout = setTimeout(() => {
                    hideBlockButton();
                }, blockWindowMs);
            }

            function hideBlockButton() {
                blockWindowOpen = false;
                if (blockTimeout) { clearTimeout(blockTimeout); blockTimeout = null; }
                if (blockBtn) {
                    blockBtn.style.animation = 'actionBtnDisappear 0.15s ease-out forwards';
                    setTimeout(() => { blockBtn.style.display = 'none'; }, 150);
                }
            }

            function onBlockTap() {
                if (!blockWindowOpen || battleOver) return;
                blockSuccess = true;
                hideBlockButton();

                // Show shield visual
                const shield = document.createElement('div');
                shield.className = 'battle-shield-overlay';
                widget.appendChild(shield);
                setTimeout(() => shield.remove(), 500);

                if (navigator.vibrate) navigator.vibrate([30, 20, 30]);
            }

            if (blockBtn) {
                blockBtn.addEventListener('click', onBlockTap);
                blockBtn.addEventListener('touchstart', (e) => { e.preventDefault(); onBlockTap(); }, { passive: false });
            }

            // Returns true if block is active (damage should be halved)
            function consumeBlock() {
                if (blockSuccess) {
                    blockSuccess = false;
                    return true;
                }
                return false;
            }

            function onBash() {
                if (battleOver) return;
                bashCount++;
                updateBashUI();

                // Haptic rumble on each tap
                if (navigator.vibrate) navigator.vibrate(50);

                // Visual feedback on each tap
                if (bashBtn) {
                    bashBtn.classList.remove('bash-rumble');
                    void bashBtn.offsetWidth; // force reflow to restart animation
                    bashBtn.classList.add('bash-rumble');
                }

                // When bash threshold reached, show FIRE button instead of auto-firing
                if (bashCount >= tapsNeeded && !superReady && !fireWindowOpen) {
                    superReady = true;
                    showFireButton();
                }
            }

            // Init HP
            updateHPBars();
            updateBashUI();
            const enemyNameEl = document.querySelector('.battle-hp-box.enemy .battle-hp-name');
            if (enemyNameEl) enemyNameEl.textContent = (opponentName || 'BOT').toUpperCase();

            // === INTRO (skip if PvP already did countdown) ===
            if (!pvpConnected) {
                playSound('intro');
                if (overlayText && overlay) {
                    overlayText.textContent = `VS ${(opponentName || 'BOT').toUpperCase()}!`;
                    overlay.classList.add('active');
                }

                const flash = document.createElement('div');
                flash.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:white;opacity:0.8;transition:opacity 0.5s;pointer-events:none;z-index:999;';
                widget.appendChild(flash);
                setTimeout(() => flash.style.opacity = 0, 50);
                setTimeout(() => flash.remove(), 550);

                await new Promise(r => setTimeout(r, 2000));
                if (overlay) overlay.classList.remove('active');
            } else {
                playSound('intro');
            }

            // Hide battle trigger + unlocks buttons during battle
            const battleTriggerBtn = document.querySelector('.battle-trigger-btn');
            const animTriggerBtn = document.querySelector('.animation-trigger-btn');
            const arenaTriggerBtn = document.querySelector('.arena-trigger-btn');
            if (battleTriggerBtn) battleTriggerBtn.style.display = 'none';
            if (animTriggerBtn) animTriggerBtn.style.display = 'none';
            if (arenaTriggerBtn) arenaTriggerBtn.style.display = 'none';

            // Show battle UI (hide mana bar - not needed anymore)
            if (hpContainer) hpContainer.classList.add('active');
            if (manaContainer) manaContainer.style.display = 'none';
            if (actionContainer) actionContainer.classList.add('active');

            await new Promise(r => setTimeout(r, 600));

            // === 3-ROUND BATTLE LOOP ===
            for (let round = 1; round <= 3; round++) {
                currentRound = round;

                // Show round transition (with score for rounds 2+)
                await showRoundTransition(round, playerRoundWins, enemyRoundWins);

                // Reset state for new round (except round 1 which is already fresh)
                if (round > 1) {
                    resetRoundState();
                    reattachBattleListeners();
                    // Re-get fire/block button refs after cloneNode in previous round cleanup
                    fireBtn = document.getElementById('battle-btn-fire');
                    blockBtn = document.getElementById('battle-btn-block');
                }

                // "FIGHT!" / "BASH!" text
                if (overlayText && overlay) {
                    overlayText.textContent = pvpConnected ? 'FIGHT!' : 'BASH!';
                    overlay.classList.add('active');
                    playSound('bell');
                    await new Promise(r => setTimeout(r, 1000));
                    overlay.classList.remove('active');
                }

                // Add bash listener (round 1 only - subsequent rounds use reattachBattleListeners)
                if (round === 1) {
                    bashBtn.addEventListener('click', onBash);
                    bashBtn.addEventListener('touchstart', (e) => { e.preventDefault(); onBash(); }, { passive: false });
                }

                // Start auto-attacks
                startAutoAttacks();

                // Start enemy attacks: PvP uses real opponent, bot uses simulated
                if (pvpConnected) {
                    listenForOpponentAttacks();
                } else {
                    startEnemyAttacks();
                }

                // Battle timer - 30 seconds per round
                await new Promise(resolve => {
                    battleTimer = setInterval(() => {
                        if (battleOver) {
                            clearInterval(battleTimer);
                            resolve();
                        }
                    }, 100);

                    setTimeout(() => {
                        if (!battleOver) {
                            battleOver = true;
                        }
                    }, BATTLE_DURATION);
                });

                // === END OF ROUND CLEANUP ===
                if (autoAttackInterval) clearInterval(autoAttackInterval);
                if (enemyAttackInterval) clearTimeout(enemyAttackInterval);
                if (battleTimer) clearInterval(battleTimer);
                if (fireTimeout) clearTimeout(fireTimeout);
                if (blockTimeout) clearTimeout(blockTimeout);
                bashBtn.removeEventListener('click', onBash);
                bashBtn.replaceWith(bashBtn.cloneNode(true));
                bashBtn = document.getElementById('battle-btn-bash');

                // Hide fire and block buttons
                const curFireBtn = document.getElementById('battle-btn-fire');
                const curBlockBtn = document.getElementById('battle-btn-block');
                if (curFireBtn) { curFireBtn.style.display = 'none'; curFireBtn.replaceWith(curFireBtn.cloneNode(true)); }
                if (curBlockBtn) { curBlockBtn.style.display = 'none'; curBlockBtn.replaceWith(curBlockBtn.cloneNode(true)); }

                // Determine round winner
                const playerWonRound = pvpConnected ? (playerHP > 0) : (enemyHP <= 0 || playerHP > enemyHP);
                if (playerWonRound) {
                    playerRoundWins++;
                } else {
                    enemyRoundWins++;
                }

                // PvP: broadcast round result
                if (pvpConnected && battleChannel) {
                    battleChannel.send({
                        type: 'broadcast',
                        event: 'round_result',
                        payload: { userId: window.currentUser?.id, round, playerWonRound, playerRoundWins, enemyRoundWins }
                    });
                }

                // Show round result animation
                await showRoundResult(round, playerWonRound);

                // Check if match is decided (first to 2 wins)
                if (playerRoundWins >= ROUNDS_TO_WIN || enemyRoundWins >= ROUNDS_TO_WIN) {
                    break;
                }
            }

            // === MATCH RESULT ===
            const playerWon = playerRoundWins >= ROUNDS_TO_WIN;

            // Restore hidden buttons
            if (battleTriggerBtn) battleTriggerBtn.style.display = '';
            if (animTriggerBtn) animTriggerBtn.style.display = '';
            if (arenaTriggerBtn) arenaTriggerBtn.style.display = '';

            // Settle battle
            const battleBet = window._activeBattleBet || 0;
            const opponentId = window._activeBattleOpponentId || null;

            // PvP: broadcast finished + submit to server RPC
            if (pvpConnected && battleChannel) {
                battleChannel.send({
                    type: 'broadcast',
                    event: 'finished',
                    payload: { userId: window.currentUser?.id, hpRemaining: playerWon ? 100 : 0 }
                });

                try {
                    if (window.supabaseClient && window.currentUser) {
                        const { data: result } = await window.supabaseClient
                            .rpc('finish_tamagotchi_battle', {
                                p_battle_id: battleId,
                                p_user_id: window.currentUser.id,
                                p_hp_remaining: playerWon ? 100 : 0
                            });
                        console.log('Battle result submitted:', result);

                        if (result && result.finished) {
                            if (typeof loadCoinBalance === 'function') loadCoinBalance();
                        }
                    }
                } catch (e) {
                    console.warn('Could not submit battle result:', e);
                }

                battleChannel.unsubscribe();
                battleChannel = null;
            }

            // Show match result with score
            const scoreText = playerRoundWins + ' - ' + enemyRoundWins;

            if (playerWon) {
                const victoryAnim = anims.find(a => /laugh|clap|arms_up/i.test(a)) || 'idle';
                viewer.animationName = victoryAnim;
                viewer.play();
                playSound('victory');
                if (overlayText && overlay) {
                    overlayText.innerHTML = `<div style="font-size:1.2em;">VICTORY!</div><div style="font-size:0.5em;margin-top:8px;opacity:0.8;">${scoreText}</div>`;
                    overlay.style.color = '#00ff00';
                    overlay.style.textShadow = '0 0 20px #00ff00';
                    overlay.classList.add('active');
                }

                if (pvpConnected) {
                    if (typeof showToast === 'function') {
                        const msg = battleBet > 0 ? 'Victory! 🪙 ' + (battleBet * 2) + ' coins won!' : 'Victory!';
                        setTimeout(() => showToast(msg, 'success'), 2000);
                    }
                } else if (battleBet > 0 && window.supabaseClient && window.currentUser) {
                    try {
                        const winnings = battleBet * 2;
                        await window.supabaseClient.rpc('credit_coins', {
                            user_uuid: window.currentUser.id,
                            coin_amount: winnings,
                            txn_type: 'battle_win',
                            txn_description: 'Won battle bet (' + winnings + ' coins)',
                            txn_reference: opponentId || 'battle'
                        });
                        if (typeof loadCoinBalance === 'function') loadCoinBalance();
                        if (typeof showToast === 'function') {
                            setTimeout(() => showToast('Victory! 🪙 ' + winnings + ' coins won!', 'success'), 2000);
                        }
                    } catch (e) {
                        console.warn('Could not settle battle bet:', e);
                        if (typeof showToast === 'function') {
                            setTimeout(() => showToast('Victory!', 'success'), 2000);
                        }
                    }
                } else {
                    if (typeof showToast === 'function') {
                        setTimeout(() => showToast('Victory!', 'success'), 2000);
                    }
                }
            } else {
                viewer.animationName = loseAnim;
                viewer.play();
                if (overlayText && overlay) {
                    overlayText.innerHTML = `<div style="font-size:1.2em;">DEFEATED!</div><div style="font-size:0.5em;margin-top:8px;opacity:0.8;">${scoreText}</div>`;
                    overlay.style.color = '#ff4444';
                    overlay.style.textShadow = '0 0 20px #ff4444';
                    overlay.classList.add('active');
                }
                if (typeof showToast === 'function') {
                    const lossMsg = battleBet > 0
                        ? 'Defeated! Lost 🪙 ' + battleBet + ' coins. Train harder!'
                        : 'Train harder and try again!';
                    setTimeout(() => showToast(lossMsg, 'info'), 2000);
                }
            }

            // Reset battle state
            window._activeBattleBet = 0;
            window._activeBattleOpponentId = null;
            window._activeBattleId = null;
            window._isBattleChallenger = false;

            await new Promise(r => setTimeout(r, 4000));

            // === CLEAN RESET ===
            if (overlay) {
                overlay.classList.remove('active');
                overlay.style.color = '';
                overlay.style.textShadow = '';
            }
            if (hpContainer) hpContainer.classList.remove('active');
            if (manaContainer) { manaContainer.classList.remove('active'); manaContainer.style.display = ''; }
            if (actionContainer) actionContainer.classList.remove('active');

            // Restore background to whatever was selected before battle
            widget.classList.remove('tamagotchi-bg-dojo');
            savedBgClasses.forEach(c => widget.classList.add(c));
            const restoreStaticBg = document.getElementById('tamagotchi-static-bg');
            if (restoreStaticBg) {
                const savedBgName = localStorage.getItem('selectedBackground') || 'none';
                const savedBgObj = (window.BACKGROUND_UNLOCKS || []).find(b => b.name === savedBgName);
                const restoreImage = savedBgObj && savedBgObj.image ? savedBgObj.image : './assets/gym_bg.jpeg';
                restoreStaticBg.style.display = 'block';
                restoreStaticBg.style.backgroundImage = "url('" + restoreImage + "')";
                restoreStaticBg.style.backgroundSize = 'cover';
                restoreStaticBg.style.backgroundPosition = 'center center';
            }

            // Restore camera, controls, and position
            if (savedOrbit) viewer.setAttribute('camera-orbit', savedOrbit);
            if (hadCameraControls) viewer.setAttribute('camera-controls', '');
            if (hadAutoRotate) viewer.setAttribute('auto-rotate', '');
            viewer.style.left = '0';

            viewer.animationName = 'idle';
            setTimeout(() => {
                viewer.pause();
                viewer.currentTime = 0;
                viewer.animationName = null;
                viewer.removeAttribute('animation-name');
            }, 500);

            } catch (e) {
                console.error('Battle error:', e);
                if (battleChannel) { battleChannel.unsubscribe(); battleChannel = null; }
            } finally {
                window._battleInProgress = false;
                window.isDuringBattle = false;
            }
        };

        // ============================================================
        // HOOK INTO LEVEL UP CELEBRATION
        // ============================================================
        const originalTriggerLevelUp = window.triggerLevelUpCelebration;
        if (typeof originalTriggerLevelUp === 'function') {
            window.triggerLevelUpCelebration = function(newLevel, title, previousLevel, lifetimePoints, currentStreak, previousProgress) {
                // Call original
                originalTriggerLevelUp(newLevel, title, previousLevel, lifetimePoints, currentStreak, previousProgress);

                // Grant stat points
                if (previousLevel && newLevel > previousLevel) {
                    grantStatPoints(previousLevel, newLevel);
                }

                // Update background
                applyBackgroundForLevel(newLevel);

                // Update battle button lock
                updateBattleButtonLock();
            };
        }

        // Also check for unallocated points on page load (in case user closed before allocating)
        // Delay longer to avoid interrupting any pending level-up celebration
        setTimeout(() => {
            // Skip if a celebration is pending/playing - the celebration cleanup will show the modal
            const pendingCeleb = localStorage.getItem('pendingLevelUpCelebration');
            if (pendingCeleb) return;

            const unalloc = getUnallocatedPoints();
            if (unalloc > 0) {
                showStatAllocationModal();
            }
        }, 8000);

        console.log('🎮 Progression & Battle System loaded!');
    })();
    </script>
    <script>
    const RARE_TIERS = {
        LEGENDARY: { label: 'LEGENDARY', color: '#fbbf24', glow: 'rgba(251,191,36,0.4)', gradient: 'linear-gradient(135deg, #fbbf24, #f59e0b)', buyIn: 10000, weight: 1 },
        EPIC:      { label: 'EPIC',      color: '#a855f7', glow: 'rgba(168,85,247,0.4)', gradient: 'linear-gradient(135deg, #a855f7, #7c3aed)', buyIn: 5000,  weight: 3 },
        RARE:      { label: 'RARE',      color: '#3b82f6', glow: 'rgba(59,130,246,0.4)', gradient: 'linear-gradient(135deg, #3b82f6, #2563eb)', buyIn: 2500,  weight: 5 },
        COMMON:    { label: 'COMMON',    color: '#6b7280', glow: 'rgba(107,114,128,0.4)', gradient: 'linear-gradient(135deg, #6b7280, #4b5563)', buyIn: 1000,  weight: 10 }
    };

    const RARE_COLLECTION = [
        { id: 'arny', name: 'Arny', model: 'https://f005.backblazeb2.com/file/shannonsvideos/arny.glb', emoji: '🥋', desc: 'The Austrian Oak', tier: 'LEGENDARY' },
        { id: 'optimus', name: 'Optimus', model: 'https://f005.backblazeb2.com/file/shannonsvideos/optimus.glb', emoji: '🚛', desc: 'Prime Leadership', tier: 'EPIC' },
        { id: 'gohan', name: 'Gohan', model: 'https://f005.backblazeb2.com/file/shannonsvideos/gohan.glb', emoji: '🐲', desc: 'Beast Within', tier: 'EPIC' },
        { id: 'goku', name: 'Goku', model: 'https://f005.backblazeb2.com/file/shannonsvideos/goku.glb', emoji: '🌌', desc: 'Super Saiyan God', tier: 'EPIC' },
        { id: 'vegeta', name: 'Vegeta', model: 'https://f005.backblazeb2.com/file/shannonsvideos/vegeta.glb', emoji: '🤴', desc: 'Prince of All Saiyans', tier: 'EPIC' },
        { id: 'cbum', name: 'CBum', model: 'https://f005.backblazeb2.com/file/shannonsvideos/cbum.glb', emoji: '🥇', desc: 'Modern Classic Physique', tier: 'RARE' },
        { id: 'ronny', name: 'Ronny', model: 'https://f005.backblazeb2.com/file/shannonsvideos/ronny.glb', emoji: '👑', desc: 'The King of Intensity', tier: 'RARE' },
        { id: 'steve_irwin', name: 'Steve Irwin', model: 'https://f005.backblazeb2.com/file/shannonsvideos/steve_irwin.glb', emoji: '🐊', desc: 'The Crocodile Hunter', tier: 'RARE' },
        { id: 'itadori', name: 'Itadori', model: 'https://f005.backblazeb2.com/file/shannonsvideos/itadori.glb', emoji: '👹', desc: 'Sukuna\'s Vessel', tier: 'RARE' },
        { id: 'elon', name: 'Elon', model: 'https://f005.backblazeb2.com/file/shannonsvideos/elon.glb', emoji: '🚀', desc: 'Techno-King Mode', tier: 'COMMON' },
        { id: 'trump', name: 'Trump', model: 'https://f005.backblazeb2.com/file/shannonsvideos/trump.glb', emoji: '🇺🇸', desc: 'High Stakes Player', tier: 'COMMON' },
        { id: 'epstein', name: 'Epstein', model: 'https://f005.backblazeb2.com/file/shannonsvideos/epstein_rigged.glb', emoji: '🏝️', desc: 'Didn\'t Kill Himself', tier: 'COMMON' }
    ];

    // ============================================================
    // BACKGROUND MODEL PREFETCH - warm browser cache for 3D models
    // ============================================================
    (function prefetchRareModels() {
        // Wait for page to finish loading critical content first
        const startPrefetch = () => {
            // Prioritize: 1) active skin, 2) featured monthly rare, 3) first in collection, 4) rest
            const activeRareSkinId = localStorage.getItem('active_rare_skin');
            const featured = getFeaturedMonthlyRareId();
            const priorityIds = new Set();
            if (activeRareSkinId) priorityIds.add(activeRareSkinId);
            if (featured) priorityIds.add(featured);
            priorityIds.add(RARE_COLLECTION[0].id); // First in list (shown when opening Rare Drops)

            const priorityModels = [];
            const remainingModels = [];
            RARE_COLLECTION.forEach(rare => {
                if (priorityIds.has(rare.id)) {
                    priorityModels.push(rare.model);
                } else {
                    remainingModels.push(rare.model);
                }
            });

            // Prefetch priority models immediately (low-priority fetch to not block UI)
            prefetchBatch(priorityModels).then(() => {
                // Then prefetch remaining models with staggered delays
                prefetchBatch(remainingModels);
            });
        };

        function prefetchBatch(urls) {
            const fetches = urls.map((url, i) => {
                return new Promise(resolve => {
                    // Stagger by 200ms each to avoid flooding the network
                    setTimeout(() => {
                        fetch(url, { mode: 'cors', credentials: 'omit' })
                            .then(() => console.log('Prefetched:', url.split('/').pop()))
                            .catch(() => {}) // Silently ignore prefetch failures
                            .finally(resolve);
                    }, i * 200);
                });
            });
            return Promise.all(fetches);
        }

        // Helper to get featured rare ID without creating the full object
        function getFeaturedMonthlyRareId() {
            const now = new Date();
            const monthIndex = now.getFullYear() * 12 + now.getMonth();
            const rare = RARE_COLLECTION[monthIndex % RARE_COLLECTION.length];
            return rare ? rare.id : null;
        }

        // Start prefetching after page is idle (use requestIdleCallback if available)
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => startPrefetch(), { timeout: 5000 });
        } else {
            setTimeout(startPrefetch, 3000);
        }
    })();

    // Helper: check if a rare skin is unlocked
    function isRareUnlocked(id) {
        let unlocked = [];
        try { unlocked = JSON.parse(localStorage.getItem('user_rares_unlocked') || '[]'); } catch(e) {}
        return unlocked.includes(id);
    }

    // Helper: unlock a rare skin
    function unlockRare(id) {
        let unlocked = [];
        try { unlocked = JSON.parse(localStorage.getItem('user_rares_unlocked') || '[]'); } catch(e) {}
        if (!unlocked.includes(id)) {
            unlocked.push(id);
            localStorage.setItem('user_rares_unlocked', JSON.stringify(unlocked));
            try { if (typeof checkRareBadges === 'function') checkRareBadges(); } catch(e) {}
        }
    }

    // Helper: get weighted random rare drop (from all rares, weighted by tier)
    function getRandomRareDrop() {
        const pool = [];
        RARE_COLLECTION.forEach(rare => {
            const tierData = RARE_TIERS[rare.tier];
            if (tierData) {
                for (let i = 0; i < tierData.weight; i++) {
                    pool.push(rare);
                }
            }
        });
        return pool[Math.floor(Math.random() * pool.length)];
    }

    // Helper: get featured monthly rare (deterministic rotation by month)
    function getFeaturedMonthlyRare() {
        const now = new Date();
        const monthIndex = now.getFullYear() * 12 + now.getMonth();
        return RARE_COLLECTION[monthIndex % RARE_COLLECTION.length];
    }

    // Select a rare skin as active tamagotchi skin
    // Select an evolution skin (swap to any unlocked evolution model)
    window.selectEvolutionSkin = function(modelSrc, title) {
        // Clear any active rare skin
        localStorage.removeItem('active_rare_skin');
        // Save the selected evolution skin override
        localStorage.setItem('active_evolution_skin', modelSrc);
        // Update the main model-viewer immediately
        const modelViewer = document.getElementById('tamagotchi-model');
        if (modelViewer) {
            modelViewer.setAttribute('src', modelSrc);
            // Apply character colors when model loads
            modelViewer.addEventListener('load', function onLoad() {
                if (window.applyCharacterColors) {
                    window.applyCharacterColors(modelViewer, modelSrc);
                }
                modelViewer.removeEventListener('load', onLoad);
            });
        }
        // Refresh the unlocks display if open
        if (typeof populateTamagotchiAnimations === 'function') {
            populateTamagotchiAnimations();
        }
        showToast('🎨 ' + title + ' skin equipped!', 'success');
    };

    function selectRareSkin(id) {
        const rare = RARE_COLLECTION.find(r => r.id === id);
        if (!rare || !isRareUnlocked(id)) return;
        localStorage.setItem('active_rare_skin', id);
        // Clear evolution skin override when equipping rare
        localStorage.removeItem('active_evolution_skin');
        // Update the main model-viewer immediately
        const modelViewer = document.getElementById('tamagotchi-model');
        if (modelViewer) {
            modelViewer.setAttribute('src', rare.model);
        }
        // Refresh the tamagotchi modal skins display if open
        if (typeof populateTamagotchiAnimations === 'function') {
            populateTamagotchiAnimations();
        }
        showToast(rare.emoji + ' ' + rare.name + ' skin equipped!', 'success');
    }

    // Clear rare skin and revert to level-based evolution
    function clearRareSkin() {
        localStorage.removeItem('active_rare_skin');
        localStorage.removeItem('active_evolution_skin');
        // Trigger level-based model update
        if (typeof updateTamagotchiDisplay === 'function') {
            updateTamagotchiDisplay();
        } else if (typeof updateFitGotchi === 'function') {
            updateFitGotchi();
        }
        // Refresh the tamagotchi modal skins display if open
        if (typeof populateTamagotchiAnimations === 'function') {
            populateTamagotchiAnimations();
        }
        showToast('Reverted to level skin!', 'success');
    }

    // Render the featured monthly rare card on the home page
    function renderFeaturedRareCard() {
        const container = document.getElementById('rare-challenges-preview');
        if (!container) return;

        const featured = getFeaturedMonthlyRare();
        if (!featured) return;

        const tierData = RARE_TIERS[featured.tier];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const currentMonth = monthNames[new Date().getMonth()];

        container.innerHTML = `
            <div class="card" onclick="openCreateChallengeModal('${featured.id}')" style="min-width: 280px; max-width: 340px; padding: 20px; border: 2px solid ${tierData.color}; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3), 0 0 20px ${tierData.glow}; border-radius: 16px;">
                <div style="position: absolute; top: -15px; right: -15px; font-size: 5rem; opacity: 0.08; transform: rotate(15deg);">${featured.emoji}</div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="font-size: 2rem;">${featured.emoji}</span>
                    <div>
                        <div style="font-weight: 800; color: white; font-size: 1.15rem;">${currentMonth} Featured</div>
                        <span style="display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 800; letter-spacing: 1.5px; background: ${tierData.gradient}; color: white;">${tierData.label}</span>
                    </div>
                </div>
                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 14px;">30 Days • ${tierData.buyIn.toLocaleString()} Coins</div>
                <div style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 1.4rem;">${featured.emoji}</div>
                    <div style="flex: 1;">
                        <div style="font-size: 0.6rem; color: rgba(255,255,255,0.5); text-transform: uppercase; font-weight: 700; letter-spacing: 1px;">Guaranteed Drop</div>
                        <div style="font-size: 0.85rem; font-weight: 700; color: ${tierData.color};">${featured.name}</div>
                    </div>
                    <div style="background: ${tierData.gradient}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800;">WIN</div>
                </div>
            </div>
        `;
    }

    // ============================================================
    // CHALLENGE COMPLETION & RARE REWARD GRANTING
    // ============================================================

    // Check for expired challenges that need completion
    async function checkAndCompleteExpiredChallenges() {
        if (!window.currentUser) return;

        try {
            // Get all active/pending challenges for this user that have passed their end date
            const { data: challenges, error } = await window.supabaseClient
                .from('challenge_participants')
                .select('challenge_id, challenges!inner(id, name, end_date, status, winner_id, winner_rewarded, rare_reward_id)')
                .eq('user_id', window.currentUser.id)
                .eq('status', 'accepted')
                .in('challenges.status', ['active', 'pending']);

            if (error || !challenges) return;

            const now = new Date();
            for (const cp of challenges) {
                const challenge = cp.challenges;
                const endDate = new Date(challenge.end_date);

                // If challenge has passed its end date and hasn't been completed
                if (endDate < now && !challenge.winner_rewarded) {
                    console.log('Completing expired challenge:', challenge.name);
                    await completeAndRewardChallenge(challenge.id);
                }
            }
        } catch (err) {
            console.error('Error checking expired challenges:', err);
        }
    }

    // Complete a challenge and handle rare reward
    async function completeAndRewardChallenge(challengeId) {
        try {
            const { data: result, error } = await window.supabaseClient
                .rpc('complete_challenge', { challenge_uuid: challengeId });

            if (error) {
                console.error('Error completing challenge:', error);
                return;
            }

            if (result?.error) {
                console.log('Challenge already completed:', result.message);
                return;
            }

            const winnerId = result?.winner_id;
            const rareRewardId = result?.rare_reward_id;
            const isCurrentUserWinner = winnerId === window.currentUser?.id;

            if (isCurrentUserWinner && rareRewardId) {
                // Unlock the rare skin locally
                unlockRare(rareRewardId);
                // Show the epic celebration modal
                showRareUnlockCelebration(rareRewardId, result.winner_name, true);
            } else if (isCurrentUserWinner) {
                // Winner but no rare reward — just show a simple congrats
                showToast('🏆 You won the challenge! +200 XP', 'success');
            } else {
                // Not the winner
                const winnerName = result?.winner_name || 'Someone';
                showToast(`Challenge complete! ${winnerName} won.`, 'info');
            }

            // Check challenge badges
            try { if (typeof checkChallengeBadges === 'function') checkChallengeBadges(); } catch(e) {}

            // Refresh challenges on home screen
            if (typeof loadHomeChallenges === 'function') loadHomeChallenges();

        } catch (err) {
            console.error('Error in completeAndRewardChallenge:', err);
        }
    }

    // ============================================================
    // UNLOCK CELEBRATION MODAL
    // ============================================================

    // Track which rare was just unlocked for the equip button
    window._lastUnlockedRareId = null;

    function showRareUnlockCelebration(rareId, winnerName, isWinner) {
        const rare = RARE_COLLECTION.find(r => r.id === rareId);
        if (!rare) return;

        const tierData = RARE_TIERS[rare.tier] || RARE_TIERS.COMMON;
        window._lastUnlockedRareId = rareId;

        const modal = document.getElementById('rare-unlock-celebration');
        if (!modal) return;

        // Set result text
        const resultText = document.getElementById('unlock-result-text');
        if (resultText) {
            resultText.textContent = isWinner ? 'YOU WON!' : 'REWARD UNLOCKED!';
            resultText.style.color = isWinner ? '#4ade80' : '#fbbf24';
        }

        // Set 3D model
        const viewer = document.getElementById('unlock-rare-viewer');
        if (viewer) viewer.setAttribute('src', rare.model);

        // Set glow ring color
        const glowRing = document.getElementById('unlock-glow-ring');
        if (glowRing) {
            glowRing.style.background = `radial-gradient(circle, ${tierData.glow} 0%, transparent 70%)`;
        }

        // Set tier badge
        const badgeEl = document.getElementById('unlock-tier-badge');
        if (badgeEl) {
            badgeEl.textContent = tierData.label;
            badgeEl.style.background = tierData.gradient;
        }

        // Set name and desc
        const nameEl = document.getElementById('unlock-rare-name');
        if (nameEl) nameEl.textContent = rare.name;
        const descEl = document.getElementById('unlock-rare-desc');
        if (descEl) descEl.textContent = rare.desc;

        // Generate sparkles
        generateSparkles(tierData.color);

        // Show the modal
        modal.style.display = 'flex';

        // Haptic feedback (if available)
        if (navigator.vibrate) navigator.vibrate([100, 50, 200, 50, 100]);
    }

    function generateSparkles(color) {
        const container = document.getElementById('unlock-sparkles');
        if (!container) return;
        container.innerHTML = '';

        const emojis = ['✨', '⭐', '🌟', '💫', '🎆', '🎇'];
        for (let i = 0; i < 20; i++) {
            const sparkle = document.createElement('div');
            sparkle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            sparkle.style.cssText = `
                position: absolute;
                font-size: ${0.8 + Math.random() * 1.5}rem;
                left: ${10 + Math.random() * 80}%;
                bottom: ${Math.random() * 40}%;
                animation: sparkleFloat ${1.5 + Math.random() * 2}s ease-out ${Math.random() * 1}s forwards;
                opacity: 0;
                pointer-events: none;
            `;
            // Start the animation after a brief delay
            setTimeout(() => sparkle.style.opacity = '1', i * 80);
            container.appendChild(sparkle);
        }
    }

    function equipUnlockedRare() {
        if (window._lastUnlockedRareId) {
            selectRareSkin(window._lastUnlockedRareId);
        }
        closeUnlockCelebration();
    }

    function closeUnlockCelebration() {
        const modal = document.getElementById('rare-unlock-celebration');
        if (modal) modal.style.display = 'none';
        // Clear the viewer to stop loading
        const viewer = document.getElementById('unlock-rare-viewer');
        if (viewer) viewer.removeAttribute('src');
        window._lastUnlockedRareId = null;
    }

    function openRareRewardsModal() {
        const modal = document.getElementById('rare-rewards-modal');
        if (modal) {
            modal.style.display = 'flex';
            renderRaresGrid();
            previewRare(RARE_COLLECTION[0].id);
        }
    }

    function closeRareRewardsModal() {
        const modal = document.getElementById('rare-rewards-modal');
        if (modal) modal.style.display = 'none';
        const viewer = document.getElementById('rare-reward-viewer');
        if (viewer) viewer.src = '';
    }

    function renderRaresGrid() {
        const grid = document.getElementById('rares-grid');
        let userProgress = [];
        try { userProgress = JSON.parse(localStorage.getItem('user_rares_unlocked') || '[]'); } catch(e) {}
        grid.innerHTML = RARE_COLLECTION.map(rare => {
            const isUnlocked = userProgress.includes(rare.id);
            const tierData = RARE_TIERS[rare.tier] || RARE_TIERS.COMMON;
            return `
                <div onclick="previewRare('${rare.id}')" class="rare-item-card" style="aspect-ratio: 1; border: 2px solid ${isUnlocked ? tierData.color : '#f1f5f9'}; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; background: ${isUnlocked ? '#fffbeb' : 'white'};">
                    <div style="position: absolute; top: 4px; left: 4px; padding: 1px 5px; border-radius: 3px; font-size: 0.45rem; font-weight: 800; letter-spacing: 1px; background: ${tierData.gradient}; color: white;">${tierData.label}</div>
                    <div style="font-size: 2rem; filter: ${isUnlocked ? 'none' : 'grayscale(1) opacity(0.5)'};">${rare.emoji}</div>
                    <div style="font-size: 0.65rem; font-weight: 700; margin-top: 5px; color: ${isUnlocked ? 'var(--primary)' : '#94a3b8'};">${rare.name.toUpperCase()}</div>
                    ${!isUnlocked ? '<div style="position: absolute; top: 5px; right: 5px; font-size: 0.7rem;">🔒</div>' : ''}
                </div>
            `;
        }).join('');
    }

    // ============================================================
    // BADGE SYSTEM
    // ============================================================

    const BADGES = [
        // Workout Badges
        { id: 'workout_1',   name: 'First Rep',       emoji: '🏋️', desc: 'Complete your first workout', category: 'Workouts', req: { type: 'workouts', count: 1 } },
        { id: 'workout_5',   name: 'Getting Started',  emoji: '💪', desc: 'Complete 5 workouts', category: 'Workouts', req: { type: 'workouts', count: 5 } },
        { id: 'workout_10',  name: 'Double Digits',    emoji: '🔟', desc: 'Complete 10 workouts', category: 'Workouts', req: { type: 'workouts', count: 10 } },
        { id: 'workout_25',  name: 'Quarter Century',  emoji: '⚡', desc: 'Complete 25 workouts', category: 'Workouts', req: { type: 'workouts', count: 25 } },
        { id: 'workout_50',  name: 'Half Century',     emoji: '🔥', desc: 'Complete 50 workouts', category: 'Workouts', req: { type: 'workouts', count: 50 } },
        { id: 'workout_100', name: 'Centurion',        emoji: '💯', desc: 'Complete 100 workouts', category: 'Workouts', req: { type: 'workouts', count: 100 } },
        { id: 'workout_365', name: 'Year Round',       emoji: '🗓️', desc: 'Complete 365 workouts', category: 'Workouts', req: { type: 'workouts', count: 365 } },
        // Streak Badges
        { id: 'streak_7',    name: 'On Fire',          emoji: '🔥', desc: '7-day workout streak', category: 'Streaks', req: { type: 'streak', count: 7 } },
        { id: 'streak_14',   name: 'Dedicated',        emoji: '⭐', desc: '14-day workout streak', category: 'Streaks', req: { type: 'streak', count: 14 } },
        { id: 'streak_30',   name: 'Iron Will',        emoji: '🏅', desc: '30-day workout streak', category: 'Streaks', req: { type: 'streak', count: 30 } },
        { id: 'streak_60',   name: 'Unbreakable',      emoji: '💎', desc: '60-day workout streak', category: 'Streaks', req: { type: 'streak', count: 60 } },
        // Meal Badges
        { id: 'meal_1',      name: 'First Bite',       emoji: '🥗', desc: 'Track your first meal', category: 'Nutrition', req: { type: 'meals', count: 1 } },
        { id: 'meal_10',     name: 'Meal Prep',        emoji: '🍽️', desc: 'Track 10 meals', category: 'Nutrition', req: { type: 'meals', count: 10 } },
        { id: 'meal_50',     name: 'Nutrition Nerd',   emoji: '📊', desc: 'Track 50 meals', category: 'Nutrition', req: { type: 'meals', count: 50 } },
        { id: 'meal_100',    name: 'Centurion Chef',   emoji: '👨‍🍳', desc: 'Track 100 meals', category: 'Nutrition', req: { type: 'meals', count: 100 } },
        { id: 'meal_365',    name: 'Year of Eating',   emoji: '🏆', desc: 'Track 365 meals', category: 'Nutrition', req: { type: 'meals', count: 365 } },
        // Personal Best Badges
        { id: 'pb_1',        name: 'First PB',         emoji: '🥇', desc: 'Set your first personal best', category: 'PBs', req: { type: 'pbs', count: 1 } },
        { id: 'pb_10',       name: 'PB Machine',       emoji: '⚡', desc: 'Set 10 personal bests', category: 'PBs', req: { type: 'pbs', count: 10 } },
        { id: 'pb_25',       name: 'Record Breaker',   emoji: '💥', desc: 'Set 25 personal bests', category: 'PBs', req: { type: 'pbs', count: 25 } },
        { id: 'pb_50',       name: 'Limitless',        emoji: '🚀', desc: 'Set 50 personal bests', category: 'PBs', req: { type: 'pbs', count: 50 } },
        // Rare Collection Badges
        { id: 'rare_1',      name: 'First Drop',       emoji: '✨', desc: 'Unlock your first rare skin', category: 'Collection', req: { type: 'rares', count: 1 } },
        { id: 'rare_3',      name: 'Collector',        emoji: '🎭', desc: 'Unlock 3 rare skins', category: 'Collection', req: { type: 'rares', count: 3 } },
        { id: 'rare_6',      name: 'Rare Hunter',      emoji: '🏹', desc: 'Unlock 6 rare skins', category: 'Collection', req: { type: 'rares', count: 6 } },
        { id: 'rare_11',     name: 'Complete Set',     emoji: '👑', desc: 'Unlock all 11 rare skins', category: 'Collection', req: { type: 'rares', count: 11 } },
        // Challenge Badges
        { id: 'challenge_1', name: 'Challenger',       emoji: '⚔️', desc: 'Enter your first challenge', category: 'Challenges', req: { type: 'challenges_entered', count: 1 } },
        { id: 'challenge_3', name: 'Competitor',       emoji: '🎯', desc: 'Complete 3 challenges', category: 'Challenges', req: { type: 'challenges_completed', count: 3 } },
        { id: 'challenge_w1',name: 'Champion',         emoji: '🏆', desc: 'Win your first challenge', category: 'Challenges', req: { type: 'challenges_won', count: 1 } },
        { id: 'challenge_w5',name: 'Legendary',        emoji: '🌟', desc: 'Win 5 challenges', category: 'Challenges', req: { type: 'challenges_won', count: 5 } },
        // Level Badges
        { id: 'level_10',    name: 'Rising Star',      emoji: '⭐', desc: 'Reach level 10', category: 'Level', req: { type: 'level', count: 10 } },
        { id: 'level_30',    name: 'Veteran',          emoji: '🎖️', desc: 'Reach level 30', category: 'Level', req: { type: 'level', count: 30 } },
        { id: 'level_50',    name: 'Elite',            emoji: '💎', desc: 'Reach level 50', category: 'Level', req: { type: 'level', count: 50 } },
        { id: 'level_99',    name: 'Legend',           emoji: '👑', desc: 'Reach level 99', category: 'Level', req: { type: 'level', count: 99 } }
    ];

    const BADGE_CATEGORIES = ['Workouts', 'Streaks', 'Nutrition', 'PBs', 'Collection', 'Challenges', 'Level'];

    function getEarnedBadges() {
        try { return JSON.parse(localStorage.getItem('user_badges_earned') || '[]'); } catch(e) { return []; }
    }

    function isBadgeEarned(id) {
        return getEarnedBadges().includes(id);
    }

    function earnBadge(id) {
        const earned = getEarnedBadges();
        if (earned.includes(id)) return false;
        earned.push(id);
        localStorage.setItem('user_badges_earned', JSON.stringify(earned));
        return true;
    }

    // Show a badge-earned toast with animation
    function showBadgeToast(badge) {
        const existing = document.getElementById('badge-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.id = 'badge-toast';
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.6rem;">${badge.emoji}</span>
                <div>
                    <div style="font-weight: 800; font-size: 0.8rem; color: #fbbf24; letter-spacing: 1px;">BADGE UNLOCKED!</div>
                    <div style="font-weight: 700; font-size: 0.95rem; color: white;">${badge.name}</div>
                    <div style="font-size: 0.7rem; color: rgba(255,255,255,0.6);">${badge.desc}</div>
                </div>
            </div>
        `;
        Object.assign(toast.style, {
            position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%) translateY(-100px)',
            background: 'linear-gradient(135deg, #1a1a2e, #16213e)', border: '1px solid rgba(251,191,36,0.3)',
            borderRadius: '16px', padding: '14px 20px', zIndex: '99999', boxShadow: '0 8px 32px rgba(0,0,0,0.5), 0 0 20px rgba(251,191,36,0.2)',
            transition: 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease', opacity: '0', minWidth: '240px'
        });
        document.body.appendChild(toast);

        requestAnimationFrame(() => {
            toast.style.transform = 'translateX(-50%) translateY(0)';
            toast.style.opacity = '1';
        });

        setTimeout(() => {
            toast.style.transform = 'translateX(-50%) translateY(-100px)';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
        }, 3500);
    }

    // Award a badge and show toast if new
    function awardBadge(id) {
        const badge = BADGES.find(b => b.id === id);
        if (!badge) return;
        const isNew = earnBadge(id);
        if (isNew) {
            showBadgeToast(badge);
            renderBadgeOverlay();
        }
    }

    // Check badges by type against a count
    function checkBadgesForType(type, count) {
        BADGES.filter(b => b.req.type === type && count >= b.req.count).forEach(b => awardBadge(b.id));
    }

    // Individual check functions called from existing code
    async function checkWorkoutBadges() {
        if (!window.currentUser) return;
        try {
            const count = await dbHelpers.workouts.getWorkoutCount(window.currentUser.id);
            checkBadgesForType('workouts', count);
        } catch(e) { console.error('Badge check workouts error:', e); }
    }

    function checkStreakBadges(streakCount) {
        if (typeof streakCount === 'number') checkBadgesForType('streak', streakCount);
    }

    async function checkMealBadges() {
        if (!window.currentUser) return;
        try {
            const { data } = await window.supabaseClient
                .from('user_points')
                .select('total_meals_logged')
                .eq('user_id', window.currentUser.id)
                .maybeSingle();
            if (data?.total_meals_logged) checkBadgesForType('meals', data.total_meals_logged);
        } catch(e) { console.error('Badge check meals error:', e); }
    }

    async function checkPBBadges() {
        if (!window.currentUser) return;
        try {
            const { data, count } = await window.supabaseClient
                .from('personal_bests')
                .select('id', { count: 'exact', head: true })
                .eq('user_id', window.currentUser.id);
            if (count != null) checkBadgesForType('pbs', count);
        } catch(e) { console.error('Badge check PBs error:', e); }
    }

    function checkRareBadges() {
        let rares = [];
        try { rares = JSON.parse(localStorage.getItem('user_rares_unlocked') || '[]'); } catch(e) {}
        checkBadgesForType('rares', rares.length);
    }

    async function checkChallengeBadges() {
        if (!window.currentUser) return;
        try {
            const { data: challenges } = await window.supabaseClient
                .from('challenge_participants')
                .select('challenge_id, status, challenges!inner(status, winner_id)')
                .eq('user_id', window.currentUser.id);
            if (!challenges) return;
            const entered = challenges.filter(c => c.status === 'accepted').length;
            const completed = challenges.filter(c => c.challenges?.status === 'completed').length;
            const won = challenges.filter(c => c.challenges?.winner_id === window.currentUser.id).length;
            checkBadgesForType('challenges_entered', entered);
            checkBadgesForType('challenges_completed', completed);
            checkBadgesForType('challenges_won', won);
        } catch(e) { console.error('Badge check challenges error:', e); }
    }

    function checkLevelBadges(level) {
        if (typeof level === 'number') checkBadgesForType('level', level);
    }

    // Master check — called on page load
    async function checkAllBadges() {
        if (!window.currentUser) return;
        try {
            await checkWorkoutBadges();
            await checkMealBadges();
            await checkPBBadges();
            checkRareBadges();
            await checkChallengeBadges();
            // Streak + level pulled from existing UI
            const streakEl = document.getElementById('tamagotchi-streak');
            if (streakEl) checkStreakBadges(parseInt(streakEl.textContent) || 0);
            const levelEl = document.getElementById('tamagotchi-level');
            if (levelEl) checkLevelBadges(parseInt(levelEl.textContent) || 0);
        } catch(e) { console.error('checkAllBadges error:', e); }
    }

    // Render the small badge overlay on tamagotchi screen
    function renderBadgeOverlay() {
        const container = document.getElementById('tamagotchi-widget-container');
        if (!container) return;

        let overlay = document.getElementById('badge-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'badge-overlay';
            Object.assign(overlay.style, {
                position: 'absolute', top: '10px', left: '10px', zIndex: '5',
                display: 'flex', alignItems: 'center', gap: '3px',
                background: 'rgba(0,0,0,0.5)', backdropFilter: 'blur(8px)',
                borderRadius: '20px', padding: '4px 8px', cursor: 'pointer',
                border: '1px solid rgba(255,255,255,0.1)', maxWidth: '180px'
            });
            overlay.onclick = () => openBadgeModal();
            container.appendChild(overlay);
        }

        const earned = getEarnedBadges();
        const earnedBadges = BADGES.filter(b => earned.includes(b.id));
        const maxShow = 5;
        const shown = earnedBadges.slice(-maxShow);
        const overflow = earnedBadges.length - maxShow;

        if (earnedBadges.length === 0) {
            overlay.style.display = 'none';
            return;
        }

        overlay.style.display = 'flex';
        overlay.innerHTML = shown.map(b =>
            `<span title="${b.name}" style="font-size: 0.85rem; line-height: 1;">${b.emoji}</span>`
        ).join('') + (overflow > 0 ? `<span style="font-size: 0.6rem; color: rgba(255,255,255,0.7); font-weight: 700; margin-left: 2px;">+${overflow}</span>` : '');
    }

    // Open the full badge collection modal
    function openBadgeModal() {
        const modal = document.getElementById('badge-collection-modal');
        if (!modal) return;
        modal.style.display = 'flex';
        renderBadgeGrid();
    }

    function closeBadgeModal() {
        const modal = document.getElementById('badge-collection-modal');
        if (modal) modal.style.display = 'none';
    }

    function renderBadgeGrid() {
        const content = document.getElementById('badge-grid-content');
        if (!content) return;
        const earned = getEarnedBadges();
        const totalEarned = earned.length;
        const totalBadges = BADGES.length;

        // Progress header
        const progressPct = Math.round((totalEarned / totalBadges) * 100);
        let html = `
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 2rem; margin-bottom: 6px;">🏅</div>
                <div style="font-size: 1.1rem; font-weight: 800; color: white;">${totalEarned} / ${totalBadges} Badges</div>
                <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 8px; overflow: hidden;">
                    <div style="width: ${progressPct}%; height: 100%; background: linear-gradient(90deg, #3b82f6, #fbbf24); border-radius: 10px; transition: width 0.5s ease;"></div>
                </div>
            </div>
        `;

        // Categories
        BADGE_CATEGORIES.forEach(cat => {
            const catBadges = BADGES.filter(b => b.category === cat);
            const catEarned = catBadges.filter(b => earned.includes(b.id)).length;

            html += `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 0.75rem; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1.5px;">${cat}</div>
                        <div style="font-size: 0.65rem; color: rgba(255,255,255,0.3); font-weight: 600;">${catEarned}/${catBadges.length}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
            `;

            catBadges.forEach(badge => {
                const isEarned = earned.includes(badge.id);
                html += `
                    <div style="text-align: center; padding: 10px 4px; background: ${isEarned ? 'rgba(255,255,255,0.08)' : 'rgba(255,255,255,0.03)'}; border-radius: 12px; border: 1px solid ${isEarned ? 'rgba(251,191,36,0.2)' : 'rgba(255,255,255,0.05)'}; ${isEarned ? 'box-shadow: 0 0 12px rgba(251,191,36,0.1);' : 'opacity: 0.4;'}">
                        <div style="font-size: 1.5rem; margin-bottom: 4px; ${isEarned ? '' : 'filter: grayscale(1); opacity: 0.5;'}">${isEarned ? badge.emoji : '❓'}</div>
                        <div style="font-size: 0.6rem; font-weight: 700; color: ${isEarned ? 'white' : 'rgba(255,255,255,0.4)'}; line-height: 1.2;">${isEarned ? badge.name : '???'}</div>
                        <div style="font-size: 0.5rem; color: rgba(255,255,255,0.35); margin-top: 2px; line-height: 1.2;">${badge.desc}</div>
                    </div>
                `;
            });

            html += `</div></div>`;
        });

        content.innerHTML = html;
    }

    // Init badges on page load (delayed to not block initial render)
    setTimeout(() => {
        renderBadgeOverlay();
        setTimeout(() => checkAllBadges(), 3000);
    }, 2000);

    function previewRare(id) {
        const rare = RARE_COLLECTION.find(r => r.id === id);
        if (!rare) return;
        const tierData = RARE_TIERS[rare.tier] || RARE_TIERS.COMMON;
        const viewer = document.getElementById('rare-reward-viewer');
        const loader = document.getElementById('rare-preview-loading');
        const info = document.getElementById('rare-info-panel');
        const nameEl = document.getElementById('rare-reward-name');
        const descEl = document.getElementById('rare-reward-desc');
        const statusEl = document.getElementById('rare-reward-status');
        if (!viewer) return;
        loader.style.display = 'flex';
        info.style.display = 'block';
        if (nameEl) nameEl.textContent = rare.name;
        if (descEl) descEl.textContent = `${tierData.label} • ${rare.desc} • ${tierData.buyIn.toLocaleString()} Coins`;
        let unlocked = false;
        try { unlocked = JSON.parse(localStorage.getItem('user_rares_unlocked') || '[]').includes(id); } catch(e) {}
        if (statusEl) {
            statusEl.textContent = unlocked ? '🎉 UNLOCKED' : '🏆 CHALLENGE DROPS ONLY';
            statusEl.style.background = unlocked ? '#f0fdf4' : '#fef3c7';
            statusEl.style.color = unlocked ? '#166534' : '#92400e';
        }
        viewer.src = rare.model;
        viewer.addEventListener('load', () => {
            loader.style.display = 'none';
        }, { once: true });
    }
    </script>

    <!-- User Profile Page Script -->
    <script>
    // Track which view we came from (so back button returns correctly)
    var _userProfilePreviousView = 'friends';

    /**
     * Open profile from the story viewer (full-screen story view)
     */
    function openStoryUserProfile() {
        // Get current story from the stories module
        if (typeof currentUserStories !== 'undefined' && typeof currentUserStoryIndex !== 'undefined') {
            const story = currentUserStories[currentUserStoryIndex];
            if (story && story.user_id) {
                // Close the story viewer first
                if (typeof closeStoryViewer === 'function') closeStoryViewer();
                viewUserProfile(story.user_id, story.user_name, story.profile_photo);
            }
        }
    }
    window.openStoryUserProfile = openStoryUserProfile;

    /**
     * Open another user's profile from the feed
     * @param {string} userId - The UUID of the user whose profile to view
     * @param {string} [userName] - Optional pre-loaded name
     * @param {string} [userPhoto] - Optional pre-loaded photo URL
     */
    async function viewUserProfile(userId, userName, userPhoto) {
        if (!userId) return;

        // Remember where we came from
        const currentView = document.querySelector('.app-view[style*="display: block"], .app-view[style*="display:block"], .app-view.active');
        if (currentView) {
            _userProfilePreviousView = currentView.id || 'friends';
        }

        // Hide all views, show profile
        hideAllAppViews();
        const profileView = document.getElementById('view-user-profile');
        profileView.style.display = 'block';

        // Hide bottom nav for immersive feel
        document.querySelector('.bottom-nav').style.display = 'none';

        // Set initial data if provided
        const headerName = document.getElementById('user-profile-header-name');
        const nameEl = document.getElementById('user-profile-name');
        const avatarEl = document.getElementById('user-profile-avatar');

        if (userName) {
            headerName.textContent = userName;
            nameEl.textContent = userName;
        } else {
            headerName.textContent = 'Profile';
            nameEl.textContent = 'Loading...';
        }

        if (userPhoto) {
            avatarEl.innerHTML = `<img src="${userPhoto}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
        } else {
            const initial = (userName || '?').charAt(0).toUpperCase();
            avatarEl.innerHTML = `<span style="font-size:2.2rem; color:white; font-weight:700;">${initial}</span>`;
        }

        // Reset sections
        document.getElementById('user-profile-level').textContent = '1';
        document.getElementById('user-profile-level-title').textContent = 'Newcomer';
        document.getElementById('user-profile-workouts').textContent = '0';
        document.getElementById('user-profile-streak').textContent = '0';
        document.getElementById('user-profile-points').textContent = '0';
        document.getElementById('user-profile-tamagotchi-section').style.display = 'none';
        document.getElementById('user-profile-pbs-section').style.display = 'none';
        document.getElementById('user-profile-badges-section').style.display = 'none';
        document.getElementById('user-profile-posts-grid').innerHTML = '';
        document.getElementById('user-profile-posts-empty').style.display = 'none';

        // Scroll to top
        profileView.scrollTop = 0;

        // Load all data in parallel
        try {
            const [userData, pointsData, personalBests, milestones, stories] = await Promise.all([
                db.users.get(userId).catch(() => null),
                db.points.getPoints(userId).catch(() => null),
                db.personalBests.getAll(userId, 20).catch(() => []),
                db.milestones.getAll(userId, 50).catch(() => []),
                loadUserProfileStories(userId).catch(() => [])
            ]);

            // Update user info
            if (userData) {
                headerName.textContent = userData.name || 'User';
                nameEl.textContent = userData.name || 'User';
                if (userData.profile_photo) {
                    avatarEl.innerHTML = `<img src="${userData.profile_photo}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                }
            }

            // Update level & stats
            let userLevel = 1;
            if (pointsData) {
                const levelInfo = calculateLevelFromPoints(pointsData.lifetime_points || 0);
                userLevel = levelInfo.level;
                document.getElementById('user-profile-level').textContent = levelInfo.level;
                document.getElementById('user-profile-level-title').textContent = levelInfo.title;
                document.getElementById('user-profile-workouts').textContent = pointsData.total_workouts_logged || 0;
                document.getElementById('user-profile-streak').textContent = pointsData.current_streak || 0;
                document.getElementById('user-profile-points').textContent = (pointsData.lifetime_points || 0).toLocaleString();
            }

            // Load tamagotchi model based on user level and gender
            try {
                const EVOLUTIONS_MALE = [
                    { level: 1,  src: "https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb" },
                    { level: 5,  src: "https://f005.backblazeb2.com/file/shannonsvideos/level_1_good_final.glb" },
                    { level: 10, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_10_real_final.glb" },
                    { level: 20, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_20_real_final.glb" },
                    { level: 30, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_30_real_final.glb" },
                    { level: 40, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_40_real_final.glb" },
                    { level: 50, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_real_final.glb" }
                ];
                const EVOLUTIONS_FEMALE = [
                    { level: 1,  src: "https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb" },
                    { level: 5,  src: "https://f005.backblazeb2.com/file/shannonsvideos/level_1_female_final.glb" },
                    { level: 10, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_10_female_final.glb" },
                    { level: 20, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_20_female_final.glb" },
                    { level: 30, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_30_female_final.glb" },
                    { level: 40, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_40_female_final.glb" },
                    { level: 50, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_female_final.glb" }
                ];
                const userSex = userData && userData.sex === 'female' ? 'female' : 'male';
                const evolutions = userSex === 'female' ? EVOLUTIONS_FEMALE : EVOLUTIONS_MALE;
                const evo = [...evolutions].reverse().find(e => userLevel >= e.level) || evolutions[0];

                const tamaSection = document.getElementById('user-profile-tamagotchi-section');
                const tamaModel = document.getElementById('user-profile-tamagotchi-model');
                const tamaFallback = document.getElementById('user-profile-tamagotchi-fallback');

                if (tamaSection && tamaModel && evo.src) {
                    tamaSection.style.display = 'block';
                    tamaModel.setAttribute('src', evo.src);
                    tamaFallback.style.display = 'none';
                }
            } catch (tamaErr) {
                console.error('Error loading profile tamagotchi:', tamaErr);
            }

            // Render personal bests
            renderUserProfilePBs(personalBests);

            // Render badges/milestones
            renderUserProfileBadges(milestones, pointsData);

            // Render posts
            renderUserProfilePosts(stories);

        } catch (err) {
            console.error('Error loading user profile:', err);
        }
    }
    window.viewUserProfile = viewUserProfile;

    /**
     * Close the user profile and return to the previous view
     */
    function closeUserProfile() {
        document.getElementById('view-user-profile').style.display = 'none';
        document.querySelector('.bottom-nav').style.display = 'flex';

        // Map view IDs back to their tab names for proper navigation
        const viewToTab = {
            'view-friends': 'friends',
            'friends': 'friends',
            'view-dashboard': 'dashboard',
            'dashboard': 'dashboard',
            'movement-tab': 'movement-tab',
            'view-meals': 'meals',
            'view-profile': 'profile',
            'view-learning': 'learning',
            'view-cycle': 'cycle'
        };

        const tabName = viewToTab[_userProfilePreviousView];
        if (tabName) {
            switchAppTab(tabName);
        } else {
            // Fallback for unknown views
            switchAppTab('friends');
        }
    }
    window.closeUserProfile = closeUserProfile;

    /**
     * Calculate level info from lifetime points (client-side)
     */
    function calculateLevelFromPoints(lifetimePoints) {
        const CURVE_MULTIPLIER = 1.3;
        const CURVE_EXPONENT = 1.55;
        const MAX_LEVEL = 99;

        function getPointsForLevel(level) {
            if (level <= 1) return 0;
            return Math.floor(CURVE_MULTIPLIER * Math.pow(level, CURVE_EXPONENT));
        }

        let level = 1;
        while (level < MAX_LEVEL) {
            const pointsNeeded = getPointsForLevel(level + 1);
            if (lifetimePoints < pointsNeeded) break;
            level++;
        }

        // Level title
        let title = 'Newcomer';
        if (level >= 99) title = 'Legend';
        else if (level >= 90) title = 'Master';
        else if (level >= 80) title = 'Champion';
        else if (level >= 70) title = 'Expert';
        else if (level >= 60) title = 'Veteran';
        else if (level >= 50) title = 'Dedicated';
        else if (level >= 40) title = 'Committed';
        else if (level >= 30) title = 'Consistent';
        else if (level >= 20) title = 'Growing';
        else if (level >= 10) title = 'Rising';
        else if (level >= 5) title = 'Beginner';

        return { level, title };
    }

    /**
     * Render personal bests grid
     */
    function renderUserProfilePBs(personalBests) {
        const section = document.getElementById('user-profile-pbs-section');
        const grid = document.getElementById('user-profile-pbs-grid');

        if (!personalBests || personalBests.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        // Sort: prioritize big compound lifts first, then by weight
        const priorityExercises = ['bench press', 'squat', 'deadlift', 'overhead press', 'barbell row'];
        const sorted = [...personalBests].sort((a, b) => {
            const aIdx = priorityExercises.findIndex(e => a.exercise_name.toLowerCase().includes(e));
            const bIdx = priorityExercises.findIndex(e => b.exercise_name.toLowerCase().includes(e));
            if (aIdx !== -1 && bIdx === -1) return -1;
            if (aIdx === -1 && bIdx !== -1) return 1;
            if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
            return (b.best_weight_kg || 0) - (a.best_weight_kg || 0);
        });

        // Show up to 6 PBs
        grid.innerHTML = sorted.slice(0, 6).map(pb => {
            const weight = pb.best_weight_kg ? `${Number(pb.best_weight_kg).toFixed(1)}kg` : '-';
            const reps = pb.best_weight_reps ? `${pb.best_weight_reps} reps` : '';
            const exerciseName = formatExerciseName(pb.exercise_name);

            return `
                <div class="up-pb-card">
                    <div class="up-pb-exercise">${exerciseName}</div>
                    <div class="up-pb-weight">${weight}</div>
                    ${reps ? `<div class="up-pb-reps">${reps}</div>` : ''}
                </div>
            `;
        }).join('');
    }

    /**
     * Format exercise name for display (capitalize, abbreviate)
     */
    function formatExerciseName(name) {
        if (!name) return '';
        return name.split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    }

    /**
     * Render badges/milestones for a user profile
     */
    function renderUserProfileBadges(milestones, pointsData) {
        const section = document.getElementById('user-profile-badges-section');
        const grid = document.getElementById('user-profile-badges-grid');

        // Build badge list from milestones and points data
        const badges = [];

        // Workout count badges
        const workoutCount = pointsData?.total_workouts_logged || 0;
        const workoutThresholds = [
            { value: 1, emoji: '🎉', label: 'First Workout' },
            { value: 5, emoji: '💪', label: '5 Workouts' },
            { value: 10, emoji: '🔥', label: '10 Workouts' },
            { value: 25, emoji: '🌟', label: '25 Workouts' },
            { value: 50, emoji: '🏆', label: '50 Workouts' },
            { value: 100, emoji: '👑', label: '100 Workouts' }
        ];
        workoutThresholds.forEach(t => {
            badges.push({
                emoji: t.emoji,
                label: t.label,
                earned: workoutCount >= t.value
            });
        });

        // Streak badges
        const streak = pointsData?.longest_streak || pointsData?.current_streak || 0;
        const streakThresholds = [
            { value: 7, emoji: '⚡', label: '7-Day Streak' },
            { value: 14, emoji: '⚡', label: '14-Day Streak' },
            { value: 30, emoji: '🔥', label: '30-Day Streak' },
            { value: 100, emoji: '💎', label: '100-Day Streak' }
        ];
        streakThresholds.forEach(t => {
            badges.push({
                emoji: t.emoji,
                label: t.label,
                earned: streak >= t.value
            });
        });

        // Milestone-based badges
        if (milestones && milestones.length > 0) {
            const milestoneTypes = new Set(milestones.map(m => m.milestone_type));
            if (milestoneTypes.has('pr_weight')) {
                badges.push({ emoji: '🏅', label: 'PR Crusher', earned: true });
            }
        }

        // Meal badges
        const mealCount = pointsData?.total_meals_logged || 0;
        if (mealCount >= 1) badges.push({ emoji: '🥗', label: 'First Meal', earned: true });
        if (mealCount >= 50) badges.push({ emoji: '🍽️', label: '50 Meals', earned: true });
        if (mealCount >= 100) badges.push({ emoji: '👨‍🍳', label: '100 Meals', earned: true });

        // Filter to only show earned badges
        const earnedBadges = badges.filter(b => b.earned);

        if (earnedBadges.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        grid.innerHTML = earnedBadges.slice(0, 9).map(b => `
            <div class="up-badge-card earned">
                <div class="up-badge-emoji">${b.emoji}</div>
                <div class="up-badge-label">${b.label}</div>
            </div>
        `).join('');
    }

    /**
     * Load stories/posts for a specific user (including expired ones for their profile)
     */
    async function loadUserProfileStories(userId) {
        try {
            const { data, error } = await window.supabaseClient
                .from('stories')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(30);

            if (error) throw error;
            return data || [];
        } catch (err) {
            console.error('Error loading user stories:', err);
            return [];
        }
    }

    /**
     * Render post thumbnails grid (Instagram-style 3-column grid)
     */
    function renderUserProfilePosts(stories) {
        const grid = document.getElementById('user-profile-posts-grid');
        const emptyState = document.getElementById('user-profile-posts-empty');

        if (!stories || stories.length === 0) {
            grid.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        grid.innerHTML = stories.map(story => {
            const storyId = story.id;
            const isImage = story.media_type === 'image' || story.media_type === 'video';
            const isCardType = ['workout_card', 'nutrition_card', 'level_up_card'].includes(story.media_type);

            if (isImage && story.media_url) {
                const thumb = story.thumbnail_url || story.media_url;
                return `
                    <div class="up-post-thumb" onclick="openFeedPostViewer('${storyId}')">
                        <img src="${thumb}" loading="lazy" onerror="this.parentElement.style.background='linear-gradient(135deg, var(--primary), var(--secondary))'; this.style.display='none';">
                        ${story.media_type === 'video' ? '<div style="position:absolute; top:6px; right:6px;"><svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:white; filter:drop-shadow(0 1px 2px rgba(0,0,0,0.5));"><path d="M8 5v14l11-7z"/></svg></div>' : ''}
                    </div>
                `;
            } else if (isCardType) {
                const typeEmoji = story.media_type === 'workout_card' ? '💪'
                    : story.media_type === 'nutrition_card' ? '🥗'
                    : '⭐';
                return `
                    <div class="up-post-card-thumb" onclick="openFeedPostViewer('${storyId}')">
                        <span>${typeEmoji}</span>
                    </div>
                `;
            }

            return `
                <div class="up-post-thumb" style="background: linear-gradient(135deg, #e2e8f0, #f1f5f9);">
                    <div style="display:flex; align-items:center; justify-content:center; height:100%; font-size:1.5rem;">📷</div>
                </div>
            `;
        }).join('');
    }
    </script>

<!-- AI Assistant Logic -->
<script>
(function() {
    // Chat state
    let aiChatHistory = [];
    let aiPendingActions = [];
    let aiIsLoading = false;

    // Build schedule from a custom program object
    function buildScheduleFromProgram(program) {
        const schedule = [];
        if (program && program.weekly_schedule && program.weekly_schedule.length === 7) {
            program.weekly_schedule.forEach((item, i) => {
                if (!item.workout || item.workout.type === 'rest') {
                    schedule.push({ name: 'Rest', dayIndex: i, exercises: [] });
                } else {
                    schedule.push({
                        name: item.workout.name || item.workout.subcategory || 'Workout',
                        dayIndex: i,
                        exercises: item.workout.exercises || []
                    });
                }
            });
        }
        return schedule;
    }

    // Gather the user's weekly workout schedule (tries DOM, cache, then DB)
    async function gatherWeekSchedule() {
        const schedule = [];

        // Try reading from the weekly calendar DOM (works when Movement tab has been visited)
        const grid = document.getElementById('weekly-calendar');
        if (grid) {
            const tags = grid.querySelectorAll('.cal-workout-tag');
            if (tags.length >= 7) {
                tags.forEach((tag, i) => {
                    const text = tag.textContent.replace('🔄', '').trim();
                    schedule.push({ name: text, dayIndex: i, exercises: [] });
                });
                return schedule.slice(0, 7);
            }
        }

        // Fallback: try to build schedule from the active custom program cache
        const cachedProgram = window.activeCustomProgramCache;
        const fromCache = buildScheduleFromProgram(cachedProgram);
        if (fromCache.length === 7) return fromCache;

        // Fallback: actively fetch the custom program from DB
        try {
            const user = window.currentUser;
            const db = window.dbHelpers;
            if (user && db && db.customPrograms) {
                const activeProgram = await db.customPrograms.getActive(user.id);
                if (activeProgram) {
                    window.activeCustomProgramCache = activeProgram;
                    const fromDb = buildScheduleFromProgram(activeProgram);
                    if (fromDb.length === 7) return fromDb;
                }
            }
        } catch (e) {
            console.warn('AI: Failed to fetch custom program:', e);
        }

        // Final fallback: return empty schedule
        for (let i = 0; i < 7; i++) {
            schedule.push({ name: 'Schedule not loaded', dayIndex: i, exercises: [] });
        }
        return schedule;
    }

    // Gather all user context data for the AI
    async function gatherUserContext() {
        const user = window.currentUser;
        if (!user) return {};

        const db = window.dbHelpers;
        const context = {};

        // Profile
        context.profile = { name: user.user_metadata?.name || user.email?.split('@')[0] || 'User' };

        const twoWeeksAgo = new Date(Date.now() - 14 * 86400000).toISOString().split('T')[0];
        const sevenDaysAgo = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
        const todayStr = new Date().toISOString().split('T')[0];

        // Run all data fetches in parallel for speed
        const [quizResult, factsResult, nutritionResult, mealsResult, workoutsResult, weighInsResult, replacementsResult, wearableResult, aiMealPlanResult] = await Promise.allSettled([
            // Quiz results
            db.quizResults.getLatest(user.id),
            // User facts
            db.userFacts.get(user.id),
            // Daily nutrition (last 14 days)
            db.nutrition.getRange(user.id, twoWeeksAgo, todayStr),
            // Recent meals (last 7 days)
            (async () => {
                const { data } = await window.supabaseClient
                    .from('meal_logs').select('*').eq('user_id', user.id)
                    .gte('meal_date', sevenDaysAgo).order('meal_date', { ascending: false }).limit(50);
                return data;
            })(),
            // Recent workout history (last 14 days)
            (async () => {
                const { data } = await window.supabaseClient
                    .from('workouts').select('*').eq('user_id', user.id).eq('workout_type', 'history')
                    .gte('workout_date', twoWeeksAgo).order('workout_date', { ascending: false }).limit(100);
                return data;
            })(),
            // Weigh-ins (last 14 days)
            (async () => {
                const { data } = await window.supabaseClient
                    .from('daily_weigh_ins').select('*').eq('user_id', user.id)
                    .gte('weigh_in_date', twoWeeksAgo).order('weigh_in_date', { ascending: true });
                return data;
            })(),
            // Active replacements
            db.workoutReplacements.getActive(user.id),
            // Wearable data (Fitbit, Oura, Strava - last 7 days)
            (async () => {
                const wearables = {};
                const tables = [
                    { key: 'fitbitActivity', table: 'fitbit_activity', dateCol: 'date' },
                    { key: 'ouraSleep', table: 'oura_sleep', dateCol: 'date' },
                    { key: 'stravaActivities', table: 'strava_activities', dateCol: 'start_date' }
                ];
                await Promise.allSettled(tables.map(async (t) => {
                    try {
                        const { data } = await window.supabaseClient
                            .from(t.table).select('*').eq('user_id', user.id)
                            .gte(t.dateCol, sevenDaysAgo).order(t.dateCol, { ascending: false }).limit(10);
                        if (data && data.length > 0) wearables[t.key] = data;
                    } catch (e) { /* table may not exist */ }
                }));
                return wearables;
            })(),
            // Check if user has a tailored meal plan
            (async () => {
                try {
                    const { data } = await window.supabaseClient
                        .from('ai_generated_meal_plans')
                        .select('id, plan_name, status, created_at')
                        .eq('user_id', user.id)
                        .eq('status', 'active')
                        .limit(1)
                        .maybeSingle();
                    return data;
                } catch (e) {
                    // Table may not exist yet
                    return localStorage.getItem('ai_meal_plan') ? { plan_name: 'Local plan', status: 'active' } : null;
                }
            })()
        ]);

        context.quizResults = quizResult.status === 'fulfilled' ? (quizResult.value || {}) : {};
        context.facts = factsResult.status === 'fulfilled' ? (factsResult.value || {}) : {};
        context.dailyNutrition = nutritionResult.status === 'fulfilled' ? (nutritionResult.value || []) : [];
        context.mealLogs = mealsResult.status === 'fulfilled' ? (mealsResult.value || []) : [];
        context.workoutHistory = workoutsResult.status === 'fulfilled' ? (workoutsResult.value || []) : [];
        context.weighIns = weighInsResult.status === 'fulfilled' ? (weighInsResult.value || []) : [];
        context.activeReplacements = replacementsResult.status === 'fulfilled' ? (replacementsResult.value || []) : [];
        context.wearables = wearableResult.status === 'fulfilled' ? (wearableResult.value || {}) : {};
        context.hasAiMealPlan = aiMealPlanResult.status === 'fulfilled' && !!aiMealPlanResult.value;

        // Adaptive calorie recommendation
        try {
            if (typeof analyzeAdaptiveAdjustment === 'function' && context.quizResults.calorie_goal) {
                const adaptiveResult = analyzeAdaptiveAdjustment(
                    context.dailyNutrition,
                    context.weighIns,
                    context.quizResults.calorie_goal,
                    context.quizResults.goal_weight || context.quizResults.weight
                );
                if (adaptiveResult) {
                    context.adaptiveResult = {
                        eligible: adaptiveResult.eligible,
                        suggestion: adaptiveResult.suggestion || null,
                        currentCalorieGoal: context.quizResults.calorie_goal,
                        newCalorieGoal: adaptiveResult.suggestion?.direction === 'increase'
                            ? context.quizResults.calorie_goal + (adaptiveResult.suggestion?.amount || 0)
                            : adaptiveResult.suggestion?.direction === 'decrease'
                            ? context.quizResults.calorie_goal - (adaptiveResult.suggestion?.amount || 0)
                            : context.quizResults.calorie_goal
                    };
                }
            }
        } catch (e) {
            console.warn('AI: Failed to compute adaptive adjustment:', e);
        }

        // Workout schedule (this week) - async, may fetch from DB
        context.weekSchedule = await gatherWeekSchedule();

        // Today info
        const today = new Date();
        context.todayDayIndex = (today.getDay() + 6) % 7; // Monday=0
        context.todayDate = today.toISOString().split('T')[0];

        return context;
    }

    // Simple markdown-to-HTML conversion
    function mdToHtml(text) {
        if (!text) return '';
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/^- (.*)/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/^(.*)$/, '<p>$1</p>')
            .replace(/<p><\/p>/g, '');
    }

    // Add a message to the chat UI
    function addAiMessage(text, role) {
        const container = document.getElementById('ai-assistant-messages');
        if (!container) return;
        container.style.display = 'block';

        const msgDiv = document.createElement('div');
        msgDiv.className = `ai-msg ai-msg-${role === 'user' ? 'user' : 'bot'}`;

        const bubble = document.createElement('div');
        bubble.className = 'ai-msg-bubble';
        bubble.innerHTML = role === 'user' ? text : mdToHtml(text);

        msgDiv.appendChild(bubble);
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;

        // Show expand button
        const expandBtn = document.getElementById('ai-assistant-expand-btn');
        if (expandBtn) expandBtn.style.display = 'block';
    }

    // Show typing indicator
    function showTypingIndicator() {
        const container = document.getElementById('ai-assistant-messages');
        if (!container) return;

        const indicator = document.createElement('div');
        indicator.className = 'ai-msg ai-msg-bot';
        indicator.id = 'ai-typing';
        indicator.innerHTML = '<div class="ai-typing-indicator"><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div></div>';
        container.appendChild(indicator);
        container.scrollTop = container.scrollHeight;
    }

    function removeTypingIndicator() {
        const el = document.getElementById('ai-typing');
        if (el) el.remove();
    }

    // Render action confirmation cards
    function renderActions(actions) {
        if (!actions || actions.length === 0) return;

        aiPendingActions = actions;
        const container = document.getElementById('ai-assistant-actions');
        if (!container) return;
        container.style.display = 'block';

        const actionIcons = {
            swap_workouts: '🔄',
            replace_workout: '🔄',
            make_rest_day: '😴',
            update_calorie_goal: '🔥',
            update_macro_goals: '📊',
            create_workout: '💪',
            generate_meal_plan: '🥗'
        };

        let html = '';
        actions.forEach((action) => {
            const icon = actionIcons[action.type] || '⚡';
            html += `<div class="ai-action-card">
                <div class="ai-action-title">${icon} ${action.description || action.type}</div>
            </div>`;
        });

        html += `<div class="ai-action-btns">
            <button class="ai-action-confirm accept" onclick="window._aiExecuteActions()">Confirm</button>
            <button class="ai-action-confirm decline" onclick="window._aiDeclineActions()">No thanks</button>
        </div>`;

        container.innerHTML = html;
    }

    // Helper to calculate start date for a replacement
    function calcReplacementStartDate(dayIndex) {
        const today = new Date();
        const todayDayIdx = (today.getDay() + 6) % 7;
        let daysUntil = dayIndex - todayDayIdx;
        if (daysUntil < 0) daysUntil += 7;
        const startDate = new Date(today);
        startDate.setDate(today.getDate() + daysUntil);
        return startDate.toISOString().split('T')[0];
    }

    // Execute confirmed actions
    async function executeActions() {
        const user = window.currentUser;
        if (!user) {
            addAiMessage('You need to be logged in to apply changes.', 'bot');
            return;
        }
        if (aiPendingActions.length === 0) {
            addAiMessage('No actions to apply.', 'bot');
            return;
        }

        const db = window.dbHelpers;
        if (!db) {
            addAiMessage('System error: database helpers not available. Please refresh the page.', 'bot');
            return;
        }

        const actionsContainer = document.getElementById('ai-assistant-actions');
        if (actionsContainer) {
            actionsContainer.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--text-muted); font-size: 0.85rem;">Applying changes...</div>';
        }

        let successCount = 0;
        let errors = [];

        for (const action of aiPendingActions) {
            try {
                console.log('AI executing action:', JSON.stringify(action));

                switch (action.type) {
                    case 'swap_workouts': {
                        const d1 = parseInt(action.day1_index);
                        const d2 = parseInt(action.day2_index);
                        if (isNaN(d1) || isNaN(d2) || d1 < 0 || d1 > 6 || d2 < 0 || d2 > 6) {
                            throw new Error('Invalid day indices: ' + action.day1_index + ', ' + action.day2_index);
                        }

                        const day1Workout = action.day1_workout || action.day1_name || 'Workout';
                        const day2Workout = action.day2_workout || action.day2_name || 'Workout';

                        // Replace day1 with day2's workout
                        console.log('AI: Deleting existing replacement for day', d1);
                        await db.workoutReplacements.deleteForDay(user.id, d1);
                        console.log('AI: Creating replacement for day', d1, '→', day2Workout);
                        await db.workoutReplacements.create(user.id, {
                            dayOfWeek: d1,
                            workout: { name: day2Workout, type: 'swap' },
                            durationWeeks: 1,
                            startDate: calcReplacementStartDate(d1)
                        });

                        // Replace day2 with day1's workout
                        console.log('AI: Deleting existing replacement for day', d2);
                        await db.workoutReplacements.deleteForDay(user.id, d2);
                        console.log('AI: Creating replacement for day', d2, '→', day1Workout);
                        await db.workoutReplacements.create(user.id, {
                            dayOfWeek: d2,
                            workout: { name: day1Workout, type: 'swap' },
                            durationWeeks: 1,
                            startDate: calcReplacementStartDate(d2)
                        });
                        successCount++;
                        break;
                    }

                    case 'replace_workout': {
                        const dayIdx = parseInt(action.day_index);
                        if (isNaN(dayIdx) || dayIdx < 0 || dayIdx > 6) {
                            throw new Error('Invalid day index: ' + action.day_index);
                        }
                        if (!action.new_workout_name) {
                            throw new Error('Missing new_workout_name');
                        }

                        await db.workoutReplacements.deleteForDay(user.id, dayIdx);
                        await db.workoutReplacements.create(user.id, {
                            dayOfWeek: dayIdx,
                            workout: { name: action.new_workout_name, type: action.new_workout_type || 'custom' },
                            durationWeeks: parseInt(action.duration_weeks) || 1,
                            startDate: calcReplacementStartDate(dayIdx)
                        });
                        successCount++;
                        break;
                    }

                    case 'make_rest_day': {
                        const dayIdx = parseInt(action.day_index);
                        if (isNaN(dayIdx) || dayIdx < 0 || dayIdx > 6) {
                            throw new Error('Invalid day index: ' + action.day_index);
                        }

                        await db.workoutReplacements.deleteForDay(user.id, dayIdx);
                        await db.workoutReplacements.create(user.id, {
                            dayOfWeek: dayIdx,
                            workout: { name: 'Rest Day', type: 'rest' },
                            durationWeeks: 1,
                            startDate: calcReplacementStartDate(dayIdx)
                        });
                        successCount++;
                        break;
                    }

                    case 'update_calorie_goal': {
                        if (!action.new_calorie_goal || isNaN(parseInt(action.new_calorie_goal))) {
                            throw new Error('Invalid calorie goal: ' + action.new_calorie_goal);
                        }
                        const todayStr = new Date().toISOString().split('T')[0];
                        // Fetch existing goals first so we don't null-out macros
                        let existingGoals = {};
                        try {
                            const existing = await db.nutrition.getTodayGoals(user.id);
                            if (existing) existingGoals = existing;
                        } catch (e) { /* no existing entry */ }

                        await db.nutrition.updateGoals(user.id, todayStr, {
                            calorie_goal: parseInt(action.new_calorie_goal),
                            protein_goal_g: existingGoals.protein_goal_g || undefined,
                            carbs_goal_g: existingGoals.carbs_goal_g || undefined,
                            fat_goal_g: existingGoals.fat_goal_g || undefined
                        });
                        successCount++;
                        break;
                    }

                    case 'update_macro_goals': {
                        const todayStr = new Date().toISOString().split('T')[0];
                        // Fetch existing goals first so we only update specified fields
                        let existingGoals = {};
                        try {
                            const existing = await db.nutrition.getTodayGoals(user.id);
                            if (existing) existingGoals = existing;
                        } catch (e) { /* no existing entry */ }

                        await db.nutrition.updateGoals(user.id, todayStr, {
                            calorie_goal: action.new_calorie_goal ? parseInt(action.new_calorie_goal) : (existingGoals.calorie_goal || undefined),
                            protein_goal_g: action.protein_g ? parseInt(action.protein_g) : (existingGoals.protein_goal_g || undefined),
                            carbs_goal_g: action.carbs_g ? parseInt(action.carbs_g) : (existingGoals.carbs_goal_g || undefined),
                            fat_goal_g: action.fat_g ? parseInt(action.fat_g) : (existingGoals.fat_goal_g || undefined)
                        });
                        successCount++;
                        break;
                    }

                    case 'create_workout': {
                        if (!action.name) throw new Error('Missing workout name');
                        if (!action.exercises || !Array.isArray(action.exercises) || action.exercises.length === 0) {
                            throw new Error('Missing or empty exercises array');
                        }
                        await db.workouts.saveCustomWorkout(user.id, action.name, {
                            name: action.name,
                            exercises: action.exercises,
                            source: 'ai_assistant'
                        });
                        successCount++;
                        break;
                    }

                    case 'generate_meal_plan': {
                        // Trigger meal plan generation
                        addAiMessage('Starting your tailored meal plan generation! Head to the **Meals** tab and tap **Your Meal Plan** to watch it come to life.', 'bot');

                        // Navigate to meals tab and trigger generation
                        if (typeof switchAppTab === 'function') {
                            switchAppTab('meals');
                        }
                        // Show the meal plan store section and start generation
                        setTimeout(() => {
                            const pill = document.getElementById('browse-plans-pill');
                            if (pill) {
                                switchWeek('meal-plan-store', pill);
                            }
                            setTimeout(() => {
                                requestAiMealPlan();
                            }, 300);
                        }, 300);

                        successCount++;
                        break;
                    }

                    default:
                        console.warn('Unknown AI action type:', action.type);
                        errors.push('Unknown action: ' + action.type);
                }
            } catch (err) {
                console.error('Error executing AI action:', action.type, err);
                const errMsg = err?.message || err?.details || (typeof err === 'string' ? err : 'unknown error');
                errors.push(action.type + ': ' + errMsg);
            }
        }

        // Clear pending
        aiPendingActions = [];
        if (actionsContainer) {
            actionsContainer.style.display = 'none';
            actionsContainer.innerHTML = '';
        }

        if (errors.length === 0 && successCount > 0) {
            addAiMessage('Done! I\'ve made those changes for you. Your schedule has been updated.', 'bot');
        } else if (successCount > 0) {
            addAiMessage('Partially done - some changes were applied but there were issues with: ' + errors.join('; '), 'bot');
        } else {
            addAiMessage('Sorry, something went wrong applying those changes.\n\n**Error:** ' + errors.join('; '), 'bot');
        }

        // Refresh the calendar views
        try {
            if (typeof loadActiveReplacements === 'function') await loadActiveReplacements();
            if (typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();
            if (typeof renderMonthlyCalendar === 'function') renderMonthlyCalendar();
        } catch (e) {
            console.warn('Could not refresh calendar:', e);
        }
    }

    function declineActions() {
        aiPendingActions = [];
        const container = document.getElementById('ai-assistant-actions');
        if (container) {
            container.style.display = 'none';
            container.innerHTML = '';
        }
        addAiMessage('No worries! Let me know if you need anything else.', 'bot');
    }

    // Main send function
    async function sendMessage() {
        if (aiIsLoading) return;

        const input = document.getElementById('ai-assistant-input');
        if (!input) return;
        const text = input.value.trim();
        if (!text) return;

        input.value = '';
        aiIsLoading = true;

        // Disable send button
        const sendBtn = document.getElementById('ai-assistant-send-btn');
        if (sendBtn) sendBtn.style.opacity = '0.5';

        // Show user message
        addAiMessage(text, 'user');
        showTypingIndicator();

        // Add to history
        aiChatHistory.push({ role: 'user', text: text });

        try {
            // Gather context
            const userData = await gatherUserContext();

            // Call the edge function
            const response = await fetch('/.netlify/functions/home-ai-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: text,
                    userData: userData,
                    chatHistory: aiChatHistory.slice(-20)
                })
            });

            removeTypingIndicator();

            if (!response.ok) {
                const errText = await response.text();
                console.error('AI response error:', response.status, errText);
                throw new Error('AI request failed: ' + response.status);
            }

            const data = await response.json();

            if (data.error) {
                console.error('AI returned error:', data.error, data.details);
                addAiMessage('Sorry, I ran into an issue. Please try again!', 'bot');
            } else {
                // Show the reply
                addAiMessage(data.reply, 'bot');

                // Add to history
                aiChatHistory.push({ role: 'bot', text: data.reply });

                // Show actions if any
                if (data.actions && data.actions.length > 0) {
                    renderActions(data.actions);
                }
            }
        } catch (err) {
            console.error('AI Assistant error:', err);
            removeTypingIndicator();
            addAiMessage('Sorry, I couldn\'t connect right now. Please try again in a moment.', 'bot');
        }

        aiIsLoading = false;
        if (sendBtn) sendBtn.style.opacity = '1';
    }

    // Toggle expand/collapse
    function toggleExpand() {
        const messages = document.getElementById('ai-assistant-messages');
        if (!messages) return;
        if (messages.style.display === 'none') {
            messages.style.display = 'block';
        } else {
            messages.style.display = 'none';
        }
    }

    // Expose functions globally
    window.sendAiAssistantMessage = sendMessage;
    window.toggleAiAssistantExpand = toggleExpand;
    window._aiExecuteActions = executeActions;
    window._aiDeclineActions = declineActions;
})();
</script>

</body>
</html>



