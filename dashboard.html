<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>Balance</title>
<meta name="description" content="Your fitness pet adventure — track workouts, raise your FitGotchi, and level up.">

<!-- Open Graph Tags -->
<meta property="og:title" content="Balance Dashboard">
<meta property="og:description" content="Access your personalized protocol and track your progress.">
<meta property="og:image" content="https://plantbased-balance.org/assets/Logo_dots.jpg">
<meta property="og:type" content="website">

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link rel="preconnect" href="https://f005.backblazeb2.com" crossorigin/>
<link rel="dns-prefetch" href="https://f005.backblazeb2.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="manifest.json" rel="manifest"/>
<link rel="apple-touch-icon" href="assets/Logo_dots.jpg">
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" defer></script>
<script>
  // Only register the service worker on web — not inside the Capacitor native shell.
  // On native, FCM handles push notifications directly. A service worker in the
  // WebView would create a competing web-push subscription that can't deliver
  // when the app is backgrounded, and may prevent the native FCM token from
  // being the sole subscription in the database.
  if ('serviceWorker' in navigator &&
      !(window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform())) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW Registered!', reg))
      .catch(err => console.log('SW Failed:', err));
  } else if (window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform()) {
    console.log('[SW] Skipped service worker registration on native (FCM handles push)');
  }
</script>

<!-- CRITICAL: Admin view-as localStorage isolation — runs BEFORE any other localStorage reads -->
<script>
(function() {
    var ADMIN_BACKUP_KEY = '_admin_ls_backup';
    var isViewAs = new URLSearchParams(window.location.search).get('view_as');

    // All user-specific localStorage keys that must be isolated
    var USER_KEYS = [
        'userProfile', 'dashboardInitialized',
        'fitgotchi_model_src', 'fitgotchi_camera_orbit', 'fitgotchi_fov', 'fitgotchi_scale',
        'fitgotchi_level', 'fitgotchi_rank', 'fitgotchi_xp_text', 'fitgotchi_xp_percent', 'fitgotchi_streak',
        'profile_photo', 'userGender', 'userThemePreference', 'dietaryPreference',
        'pbb_water_goal_ml', 'weighInDoneCardDismissedDate', 'quizDoneCardDismissedDate',
        'dailyQuizLessonToday', 'progressPhotoDoneCardDismissedDate', 'mealTipCardDismissedDate',
        'workoutTrendCardDismissedDate', 'movementTrendCardDismissedDate', 'myCurrentWorkout',
        'myCurrentWorkoutId', 'weightUnitPreference', 'lastWellnessCheck', 'pbb_points_data',
        'pbb_points_level', 'onboardingComplete', 'program_start_date',
        'battleStats', 'unallocatedStatPoints', 'previousLifetimePoints', 'pendingLevelUpCelebration',
        'selectedBackground', 'cachedNutritionStreak', 'cachedNutritionData', 'myChatStats', 'plant_based_learning_progress',
        'customPBSlots', 'pbSlotsMigratedV2'
    ];

    if (isViewAs) {
        // ENTERING view-as mode: backup admin's localStorage, then clear
        // Only create backup if one doesn't already exist — prevents overwriting
        // the admin's original data when navigating between viewed users
        if (!localStorage.getItem(ADMIN_BACKUP_KEY)) {
            var backup = {};
            USER_KEYS.forEach(function(k) {
                var v = localStorage.getItem(k);
                if (v !== null) backup[k] = v;
            });
            localStorage.setItem(ADMIN_BACKUP_KEY, JSON.stringify(backup));
        }
        USER_KEYS.forEach(function(k) { localStorage.removeItem(k); });
        sessionStorage.clear();
    } else if (localStorage.getItem(ADMIN_BACKUP_KEY)) {
        // RETURNING from view-as mode: restore admin's localStorage
        try {
            var backup = JSON.parse(localStorage.getItem(ADMIN_BACKUP_KEY));
            // Clear any viewed-user data that may have been written
            USER_KEYS.forEach(function(k) { localStorage.removeItem(k); });
            // Restore admin's original values
            Object.keys(backup).forEach(function(k) {
                localStorage.setItem(k, backup[k]);
            });
        } catch (e) { /* ignore parse errors */ }
        localStorage.removeItem(ADMIN_BACKUP_KEY);
    }
})();
</script>

<!-- CRITICAL: Hide loading overlay for returning users and restore cached FitGotchi state -->
<script>
(function() {
    // If the user has already completed their first dashboard load,
    // hide the loading overlay instantly so it doesn't flash on page reloads
    // (e.g. when returning from native camera on mobile).
    var isReturning = localStorage.getItem('dashboardInitialized') === 'true';
    if (isReturning) {
        var style = document.createElement('style');
        style.textContent = '.login-loading-overlay { display: none !important; }';
        document.head.appendChild(style);
    }

    // For returning users, preload their actual character model instead of the baby
    var cachedModel = localStorage.getItem('fitgotchi_model_src');
    if (isReturning && cachedModel) {
        var preload = document.createElement('link');
        preload.rel = 'preload';
        preload.href = cachedModel;
        preload.as = 'fetch';
        preload.crossOrigin = '';
        document.head.appendChild(preload);
        // Mark that we have a cached model so the baby preload can be skipped
        window._fitgotchiCachedModel = cachedModel;
    }
})();
</script>

<!-- CRITICAL: Early theme application to prevent flash of default theme -->
<script>
(function() {
    // Immediately apply saved theme from localStorage before page renders
    const savedTheme = localStorage.getItem('userThemePreference');
    if (!savedTheme || savedTheme === 'default') return; // Default is already in CSS

    // Minimal theme definitions for instant application
    const EARLY_THEMES = {
        'flower-garden': {'--primary':'#D98B9C','--primary-light':'#F4B4C4','--secondary':'#B4A7D6','--secondary-light':'#D0C8E8','--accent-green':'#FFF8F5','--bg':'#FFFBF9','--surface':'#ffffff','--text-main':'#4A3F44','--text-muted':'#8B7D82','--chat-bg-user':'#D98B9C','--chat-text-user':'#ffffff','--chat-bg-coach':'#FFF8F5','--chat-text-coach':'#4A3F44','--chat-border-coach':'#F4B4C4'},
        'antigravity-light': {'--primary':'#4f46e5','--primary-light':'#6366f1','--secondary':'#0891b2','--secondary-light':'#22D3EE','--accent-green':'#eff6ff','--bg':'#ffffff','--surface':'#f8fafc','--text-main':'#0f172a','--text-muted':'#64748b','--chat-bg-user':'#4f46e5','--chat-text-user':'#ffffff','--chat-bg-coach':'#f1f5f9','--chat-text-coach':'#0f172a','--chat-border-coach':'#e2e8f0'},
        'ocean': {'--primary':'#0369a1','--primary-light':'#0ea5e9','--secondary':'#db2777','--secondary-light':'#F472B6','--accent-green':'#f0f9ff','--bg':'#f0f9ff','--surface':'#ffffff','--text-main':'#082f49','--text-muted':'#64748b','--chat-bg-user':'#0369a1','--chat-text-user':'#ffffff','--chat-bg-coach':'#f1f5f9','--chat-text-coach':'#082f49','--chat-border-coach':'#e0f2fe'},
        'sunset': {'--primary':'#9d174d','--primary-light':'#be123c','--secondary':'#ea580c','--secondary-light':'#FB923C','--accent-green':'#fff1f2','--bg':'#fff1f2','--surface':'#ffffff','--text-main':'#500724','--text-muted':'#9d174d','--chat-bg-user':'#9d174d','--chat-text-user':'#ffffff','--chat-bg-coach':'#fff5f5','--chat-text-coach':'#500724','--chat-border-coach':'#ffe4e6'},
        'cycle-pink': {'--primary':'#D81B60','--primary-light':'#F06292','--secondary':'#AB47BC','--secondary-light':'#CE93D8','--accent-green':'#FCE4EC','--bg':'#FCE4EC','--surface':'#ffffff','--text-main':'#880E4F','--text-muted':'#AD1457','--chat-bg-user':'#D81B60','--chat-text-user':'#ffffff','--chat-bg-coach':'#F8BBD0','--chat-text-coach':'#880E4F','--chat-border-coach':'#F48FB1'},
        'midnight': {'--primary':'#0f172a','--primary-light':'#1e293b','--secondary':'#fbbf24','--secondary-light':'#FDE68A','--accent-green':'#334155','--bg':'#020617','--surface':'#1e293b','--text-main':'#f8fafc','--text-muted':'#94a3b8','--chat-bg-user':'#3b82f6','--chat-text-user':'#ffffff','--chat-bg-coach':'#1e293b','--chat-text-coach':'#f8fafc','--chat-border-coach':'#334155'},
        'lavender': {'--primary':'#6b21a8','--primary-light':'#7e22ce','--secondary':'#fcd34d','--secondary-light':'#FEF08A','--accent-green':'#faf5ff','--bg':'#faf5ff','--surface':'#ffffff','--text-main':'#4c1d95','--text-muted':'#9333ea','--chat-bg-user':'#6b21a8','--chat-text-user':'#ffffff','--chat-bg-coach':'#f3e8ff','--chat-text-coach':'#4c1d95','--chat-border-coach':'#e9d5ff'},
        'matcha': {'--primary':'#3f6212','--primary-light':'#4d7c0f','--secondary':'#a3e635','--secondary-light':'#D9F99D','--accent-green':'#f7fee7','--bg':'#f7fee7','--surface':'#ffffff','--text-main':'#1a2e05','--text-muted':'#4d7c0f','--chat-bg-user':'#3f6212','--chat-text-user':'#ffffff','--chat-bg-coach':'#ecfccb','--chat-text-coach':'#1a2e05','--chat-border-coach':'#d9f99d'},
        'monochrome': {'--primary':'#1a1a1a','--primary-light':'#333333','--secondary':'#666666','--secondary-light':'#A3A3A3','--accent-green':'#f5f5f5','--bg':'#ffffff','--surface':'#fafafa','--text-main':'#1a1a1a','--text-muted':'#737373','--chat-bg-user':'#1a1a1a','--chat-text-user':'#ffffff','--chat-bg-coach':'#f5f5f5','--chat-text-coach':'#1a1a1a','--chat-border-coach':'#e5e5e5'},
        'dbz-warrior': {'--primary':'#FF6B00','--primary-light':'#FF8C00','--secondary':'#FFD700','--secondary-light':'#FDE68A','--accent-green':'#FFF8E7','--bg':'#FFFAF0','--surface':'#ffffff','--text-main':'#1a1a1a','--text-muted':'#8B4513','--chat-bg-user':'#FF6B00','--chat-text-user':'#ffffff','--chat-bg-coach':'#FFF8E7','--chat-text-coach':'#1a1a1a','--chat-border-coach':'#FFD700'},
        'dbz-vegeta': {'--primary':'#0047AB','--primary-light':'#1E90FF','--secondary':'#FFD700','--secondary-light':'#FDE68A','--accent-green':'#F0F8FF','--bg':'#F5F9FF','--surface':'#ffffff','--text-main':'#0a1628','--text-muted':'#4a5568','--chat-bg-user':'#0047AB','--chat-text-user':'#ffffff','--chat-bg-coach':'#F0F8FF','--chat-text-coach':'#0a1628','--chat-border-coach':'#87CEEB'},
        'sailor-moon': {'--primary':'#FF69B4','--primary-light':'#FFB6C1','--secondary':'#FFD700','--secondary-light':'#FDE68A','--accent-green':'#FFF0F5','--bg':'#FFF5FA','--surface':'#ffffff','--text-main':'#1a1a1a','--text-muted':'#8B4789','--chat-bg-user':'#FF69B4','--chat-text-user':'#ffffff','--chat-bg-coach':'#FFF0F5','--chat-text-coach':'#1a1a1a','--chat-border-coach':'#FFD700'},
        'sailor-venus': {'--primary':'#FFA500','--primary-light':'#FFB84D','--secondary':'#FFD700','--secondary-light':'#FDE68A','--accent-green':'#FFF8DC','--bg':'#FFFAF0','--surface':'#ffffff','--text-main':'#1a1a1a','--text-muted':'#B8860B','--chat-bg-user':'#FFA500','--chat-text-user':'#ffffff','--chat-bg-coach':'#FFF8DC','--chat-text-coach':'#1a1a1a','--chat-border-coach':'#FFD700'}
    };

    const theme = EARLY_THEMES[savedTheme];
    if (theme) {
        const root = document.documentElement;
        for (const [key, value] of Object.entries(theme)) {
            root.style.setProperty(key, value);
        }
        console.log('✅ Early theme applied:', savedTheme);
    }
})();
</script>

<!-- Supabase & Auth Guard -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="lib/supabase.js?v=3"></script>
<script>
// ── Native OAuth warm-start callback ──────────────────────────────
// When the app is already running and the user returns from Google
// OAuth via the com.fitgotchi.app://login-callback deep link,
// MainActivity.injectOAuthTokens() calls this function.  We set the
// Supabase session and reload so auth-guard picks up the new session.
window._handleOAuthCallback = async function(fragment) {
    try {
        var params = new URLSearchParams(fragment);
        var accessToken  = params.get('access_token');
        var refreshToken = params.get('refresh_token');
        if (accessToken && refreshToken) {
            var result = await window.supabaseClient.auth.setSession({
                access_token:  accessToken,
                refresh_token: refreshToken,
            });
            if (!result.error) {
                // Reload so auth-guard and dashboard init run with a valid session
                window.location.replace('/dashboard.html');
            } else {
                console.error('OAuth setSession error on dashboard:', result.error);
            }
        }
    } catch (e) {
        console.error('OAuth callback error on dashboard:', e);
    }
};
</script>
<script src="lib/auth-guard.js?v=3"></script>
<script src="lib/migrate-localstorage.js"></script>
<script src="lib/stories.js"></script>
<script src="lib/ai-opponents.js"></script>
<script src="lib/games.js"></script>
<script src="lib/nutrition-calculator.js"></script>
<script src="lib/native-health.js"></script>
<script src="lib/native-push.js?v=25"></script>
<script src="lib/platform.js"></script>
<script src="lib/native-iap.js"></script>
<!-- 2D SVG Avatar system (reserved for future use) -->
<!-- <script src="lib/avatar.js"></script> -->
<!-- <link rel="stylesheet" href="lib/avatar.css"> -->
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.1.0/model-viewer.min.js"></script>
<!-- Preload onboarding 3D models so they display instantly in the wizard -->
<!-- Baby model preload only for first-time users (returning users preload their cached model above) -->
<script>
if (!window._fitgotchiCachedModel) {
    // First-time user: preload baby model + all onboarding story models
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb" as="fetch" crossorigin>');
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/arny.glb" as="fetch" crossorigin>');
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/goku.glb" as="fetch" crossorigin>');
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/optimus.glb" as="fetch" crossorigin>');
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/steve_irwin.glb" as="fetch" crossorigin>');
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/Shannon.png" as="image" crossorigin>');
} else if (localStorage.getItem('onboardingComplete') !== 'true') {
    // Returning user who hasn't completed onboarding yet: still preload story models
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/arny.glb" as="fetch" crossorigin>');
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/goku.glb" as="fetch" crossorigin>');
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/optimus.glb" as="fetch" crossorigin>');
    document.write('<link rel="preload" href="https://f005.backblazeb2.com/file/shannonsvideos/steve_irwin.glb" as="fetch" crossorigin>');
}
</script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">

<!-- Early stub definitions to prevent "undefined" errors before main scripts load -->
<script>
// Stub for userCycleData - will be overwritten with real data later
var userCycleData = {
    lastPeriod: null,
    cycleLength: 28,
    mood: null,
    noPeriodMode: false,
    symptoms: [],
    logs: {},
    dailyCheckIn: null
};

// Stub for switchAppTab - queues calls until real function loads
var _switchAppTabQueue = [];
var _switchAppTabReady = false;
function switchAppTab(tabName, btn) {
    if (_switchAppTabReady && typeof _switchAppTabReal === 'function') {
        return _switchAppTabReal(tabName, btn);
    }
    // Queue the call for when the real function is ready
    _switchAppTabQueue.push({ tabName, btn });
}

// Stub for syncQuizDataToDb - safe no-op until real function loads
var _syncQuizDataToDbReal = null;
async function syncQuizDataToDb() {
    if (typeof _syncQuizDataToDbReal === 'function') {
        return await _syncQuizDataToDbReal();
    }
    // Real function not loaded yet, silently skip
    console.log('syncQuizDataToDb: waiting for initialization...');
}

// Stub for loadProfileData - safe no-op until real function loads
var _loadProfileDataReal = null;
async function loadProfileData() {
    if (typeof _loadProfileDataReal === 'function') {
        return await _loadProfileDataReal();
    }
    // Real function not loaded yet, silently skip
    console.log('loadProfileData: waiting for initialization...');
}

// Stub for applyAppTheme - safe no-op until real function loads
var _applyAppThemeReal = null;
async function applyAppTheme(themeKey) {
    if (typeof _applyAppThemeReal === 'function') {
        return await _applyAppThemeReal(themeKey);
    }
    // Real function not loaded yet, silently skip
    console.log('applyAppTheme: waiting for initialization with theme:', themeKey);
}
</script>

<link rel="stylesheet" href="css/dashboard/dashboard-style-1.css">

</head>
<body>
<!-- Login Loading Overlay -->
<div id="login-loading-overlay" class="login-loading-overlay">
    <div id="login-loading-text" class="login-loading-text">Loading your dashboard...</div>
    <div class="login-loading-bar-track">
        <div id="login-loading-bar" class="login-loading-bar-fill"></div>
    </div>
</div>

<!-- Learning Mascot Character (Mini Tamagotchi) -->
<div class="learn-mascot" id="learnMascot">
    <div class="learn-mascot-speech" id="learnMascotSpeech">You got this!</div>
    <div class="learn-mascot-avatar" id="learnMascotAvatar" onclick="window.LearningMascot?.tapped()">
        <model-viewer
            id="mascot-model"
            src="https://f005.backblazeb2.com/file/shannonsvideos/level_1_good_final.glb"
            camera-orbit="0deg 85deg 2.5m"
            field-of-view="30deg"
            disable-zoom
            disable-pan
            auto-rotate
            rotation-per-second="30deg"
            shadow-intensity="0"
            exposure="1.2"
            style="width: 100%; height: 100%; pointer-events: none; --poster-color: transparent;"
            interaction-prompt="none">
        </model-viewer>
    </div>
</div>

<div class="container">
<!-- DASHBOARD VIEW (HOME) -->
<div id="view-dashboard" class="app-view">
    <div class="app-header">
        <div class="app-logo">Home</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div id="tamagotchi-streak-container" class="streak-header-widget">
                <span style="font-size: 0.85rem;">🔥</span>
                <span id="tamagotchi-streak" class="streak-header-count">0</span>
            </div>
            <div class="coin-header-widget" onclick="openCoinShop()">
                <span class="coin-emoji">🪙</span>
                <span class="coin-amount coin-balance-sync">0</span>
                <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
            </div>
            <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
        </div>
    </div>
    <div class="dashboard-welcome">
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <span id="daily-progress-counter" class="welcome-text" style="display: none; color: white; font-weight: 700;">Day 1 of 28</span>
        </div>
        <!-- Tamagotchi Widget (Modern Header View) -->
        <div id="tamagotchi-widget-container" style="background: #1a1a2e; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 0; overflow: hidden; margin: 0; height: 420px; position: relative;">
            <!-- Room floor with perspective depth (hidden when static bg is active) -->
            <div id="tamagotchi-floor" style="position: absolute; bottom: 0; left: 0; right: 0; height: 55%; background: linear-gradient(180deg, transparent 0%, rgba(30,40,60,0.3) 20%, rgba(40,55,80,0.6) 50%, rgba(50,70,100,0.8) 80%, rgba(60,85,120,0.95) 100%); transform: perspective(500px) rotateX(25deg); transform-origin: bottom center; pointer-events: none; z-index: 1; display: none;"></div>
            <!-- Dynamic Background (DBZ Style) -->
            <div id="tamagotchi-dynamic-bg" class="dynamic-bg-container" style="display: none;">
                <div id="bg-layer-back" class="bg-layer bg-layer-back"></div>
                <div id="bg-layer-mid" class="bg-layer bg-layer-mid"></div>
                <div id="bg-layer-front" class="bg-layer bg-layer-front"></div>
                <div id="rain-overlay" class="rain-overlay"></div>
                <div id="cloud-layer" class="cloud-layer"></div>
            </div>
            <!-- Static gym background image -->
            <div id="tamagotchi-static-bg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; display: none;"></div>
            <!-- 3D Background Environment - part of the scene with camera sync -->
            <model-viewer
                id="tamagotchi-bg-model"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; display: none; pointer-events: none; background: transparent;"
                camera-orbit="0deg 85deg 8.0m"
                camera-target="0m -0.1m 0m"
                field-of-view="16deg"
                min-field-of-view="5deg"
                max-field-of-view="120deg"
                shadow-intensity="0.8"
                exposure="1.0"
                environment-image="neutral"
                interaction-prompt="none"
                disable-zoom
                disable-pan>
            </model-viewer>
            <!-- Character model - starts with visible background, goes transparent after load so 3D environment shows through -->
            <!-- src is set dynamically below to avoid baby model flash for returning users -->
            <model-viewer
                id="tamagotchi-model"
                camera-controls
                disable-zoom
                disable-pan
                auto-rotate
                loading="eager"
                rotation-intensity="0.5"
                shadow-intensity="1.5"
                shadow-softness="0.8"
                exposure="0.9"
                environment-image="neutral"
                camera-orbit="0deg 85deg 22m"
                field-of-view="55deg"
                min-field-of-view="20deg"
                max-field-of-view="120deg"
                style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 3; --poster-color: #1a1a2e; touch-action: pan-y; background: #1a1a2e;"
                interaction-prompt="none">
            </model-viewer>
            <script>
            // Set model src from cache (returning users) or default to baby (new users).
            // Runs before model-viewer custom element registers, so the correct model loads from the start.
            (function() {
                var mv = document.getElementById('tamagotchi-model');
                if (!mv) return;

                var cachedModel = window._fitgotchiCachedModel || localStorage.getItem('fitgotchi_model_src');
                var cachedOrbit = localStorage.getItem('fitgotchi_camera_orbit');
                var cachedFov = localStorage.getItem('fitgotchi_fov');
                var cachedScale = localStorage.getItem('fitgotchi_scale');
                var isReturning = localStorage.getItem('dashboardInitialized') === 'true';

                if (isReturning && cachedModel) {
                    mv.setAttribute('src', cachedModel);
                    if (cachedOrbit) mv.setAttribute('camera-orbit', cachedOrbit);
                    if (cachedFov) mv.setAttribute('field-of-view', cachedFov);
                    if (cachedScale) {
                        mv.style.transform = cachedScale;
                        mv.style.transformOrigin = 'center center';
                    }
                } else {
                    mv.setAttribute('src', 'https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb');
                }

                // After model loads, add class to make background transparent so 3D environment shows through.
                // Keeping it opaque during load ensures Safari users see a dark bg instead of a blank void.
                mv.addEventListener('load', function() {
                    mv.classList.add('model-loaded');
                });
            })();
            </script>

            <!-- Fallback: only shown if model-viewer script fails to register or model errors -->
            <div id="tamagotchi-fallback" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:4; background:#1a1a2e; justify-content:center; align-items:center; flex-direction:column; text-align:center; color:white; padding:20px;">
                <div style="font-size:64px; margin-bottom:12px;">🐣</div>
                <div style="font-size:1.1rem; font-weight:700; margin-bottom:6px;">Your FitGotchi</div>
                <div id="tamagotchi-fallback-msg" style="font-size:0.8rem; color:rgba(255,255,255,0.6);">Loading your character...</div>
            </div>
            <script>
            // Fallback detection — waits patiently for big GLB models to load.
            // No load timeout: models can be large and take 1-2 min on slow connections.
            // Only shows fallback if model-viewer script itself is blocked, or after
            // repeated fetch errors (not slow loads).
            (function() {
                var mv = document.getElementById('tamagotchi-model');
                var fb = document.getElementById('tamagotchi-fallback');
                if (!mv || !fb) return;

                var loaded = false;
                var fallbackShown = false;
                var errorRetries = 0;
                var maxErrorRetries = 5;

                // Show loading animation (pulsing egg) while model downloads
                fb.style.display = 'flex';

                function showFallback(msg) {
                    if (fallbackShown) return;
                    fallbackShown = true;
                    var msgEl = document.getElementById('tamagotchi-fallback-msg');
                    if (msgEl && msg) msgEl.textContent = msg;
                    fb.style.display = 'flex';
                    mv.style.display = 'none';
                }

                function hideLoading() {
                    if (fallbackShown) return;
                    fb.style.display = 'none';
                    mv.style.display = '';
                }

                // On error, silently retry (same URL, no cache-bust so SW cache works)
                function retryOnError() {
                    if (loaded || fallbackShown) return;
                    errorRetries++;
                    if (errorRetries > maxErrorRetries) {
                        showFallback('Could not load your character. Check your connection and restart the app.');
                        return;
                    }
                    // Exponential backoff: 3s, 6s, 12s, 24s, 48s
                    var delay = 3000 * Math.pow(2, errorRetries - 1);
                    setTimeout(function() {
                        if (loaded || fallbackShown) return;
                        var src = mv.getAttribute('src');
                        if (src) {
                            // Re-set same src to trigger a fresh load attempt
                            mv.removeAttribute('src');
                            // Small delay so model-viewer registers the change
                            setTimeout(function() { mv.setAttribute('src', src); }, 50);
                        }
                    }, delay);
                }

                // Listen for successful load
                mv.addEventListener('load', function() {
                    loaded = true;
                    hideLoading();
                });

                // Listen for explicit errors (e.g. GLB fetch failure) — retry silently
                mv.addEventListener('error', function() {
                    if (!loaded) retryOnError();
                });

                // Check if model-viewer custom element registered (script loaded).
                // If the ES module script failed (e.g. blocked by privacy settings),
                // the custom element won't be defined and model-viewer is inert.
                var ceCheckTimeout = setTimeout(function() {
                    if (!customElements.get('model-viewer')) {
                        showFallback('3D viewer could not load. Please restart the app.');
                    }
                }, 15000);

                customElements.whenDefined('model-viewer').then(function() {
                    clearTimeout(ceCheckTimeout);
                });

                // No load timeout — we wait patiently for the model to finish downloading.
                // The service worker caches models after first successful load,
                // so subsequent app opens will be near-instant.
            })();
            </script>

            <!-- Level Up Celebration Overlay (appears inside Tamagotchi widget) -->
            <div id="tamagotchi-levelup-overlay" class="tamagotchi-levelup-overlay">
                <!-- Burst effect, sparkles, and stars will be dynamically injected here -->
            </div>

            <!-- Level Up Banner (appears at top of Tamagotchi during celebration) -->
            <div id="levelup-banner" class="levelup-banner" style="display: none;">
                <div class="levelup-banner-text">
                    <div class="levelup-banner-title">LEVEL UP!</div>
                    <div class="levelup-banner-level">
                        <span class="star-icon">⭐</span>
                        <span id="levelup-banner-number">2</span>
                        <span class="star-icon">⭐</span>
                    </div>
                    <div id="levelup-banner-rank" class="levelup-banner-rank">Newcomer</div>
                    <!-- Unlocked move display (shown if a move was unlocked) -->
                    <div id="levelup-unlocked-container" class="levelup-unlocked-move" style="display: none;">
                        <div class="levelup-unlocked-label">New Move Unlocked!</div>
                        <div id="levelup-unlocked-name" class="levelup-unlocked-name">
                            <span id="levelup-unlocked-icon" class="levelup-unlocked-icon">🎬</span>
                            <span id="levelup-unlocked-text">Victory</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Arena Trigger Button -->
            <div class="arena-trigger-btn" onclick="event.stopPropagation(); showArenaInviteModal();" title="Arena Mode">
                🗺️
            </div>

            <!-- Battle Trigger Button -->
            <div class="battle-trigger-btn" onclick="event.stopPropagation(); startBattle();" title="Battle Mode">
                🥊
            </div>

            <!-- Animation Selector Button -->
            <div class="animation-trigger-btn" onclick="showAnimationSelector()" title="Unlocks">
                🎬
            </div>

            <!-- Battle Overlay -->
            <div id="battle-mode-overlay" class="battle-overlay">
                <div class="battle-text">BATTLE!</div>
            </div>

            <!-- Battle HP Bars (shown during battle) -->
            <div id="battle-hp-container" class="battle-hp-container">
                <div class="battle-hp-box player">
                    <div class="battle-hp-name">YOU</div>
                    <div class="battle-hp-bar-bg">
                        <div id="battle-hp-player" class="battle-hp-bar-fill player" style="width: 100%;"></div>
                    </div>
                    <div id="battle-hp-player-text" class="battle-hp-text">500 / 500</div>
                </div>
                <div class="battle-hp-box enemy">
                    <div class="battle-hp-name">OPPONENT</div>
                    <div class="battle-hp-bar-bg">
                        <div id="battle-hp-enemy" class="battle-hp-bar-fill enemy" style="width: 100%;"></div>
                    </div>
                    <div id="battle-hp-enemy-text" class="battle-hp-text">500 / 500</div>
                </div>
            </div>

            <!-- Battle Mana Bar (shown during battle) -->
            <div id="battle-mana-container" class="battle-mana-container">
                <div class="battle-mana-label">SPECIAL <span id="battle-mana-pct">0%</span></div>
                <div class="battle-mana-bar-bg">
                    <div id="battle-mana-fill" class="battle-mana-bar-fill" style="width: 0%;"></div>
                </div>
            </div>

            <!-- Battle Action Buttons -->
            <div id="battle-action-container" class="battle-action-container">
                <!-- Block button (appears before incoming attacks) -->
                <button id="battle-btn-block" class="battle-action-btn battle-block-btn" style="display:none;">
                    <span class="action-btn-icon">🛡️</span>
                    <span class="action-btn-label">BLOCK</span>
                </button>
                <!-- Fire button (appears when super is charged) -->
                <button id="battle-btn-fire" class="battle-action-btn battle-fire-btn" style="display:none;">
                    <span class="action-btn-icon">🔥</span>
                    <span class="action-btn-label">FIRE!</span>
                </button>
                <!-- Bash button (always visible during battle) -->
                <button id="battle-btn-bash" class="battle-bash-btn">
                    <span class="bash-icon">👊</span>
                    <span class="bash-label">BASH!</span>
                    <div class="bash-progress-ring">
                        <svg viewBox="0 0 60 60">
                            <circle cx="30" cy="30" r="26" class="bash-ring-bg"/>
                            <circle cx="30" cy="30" r="26" class="bash-ring-fill" id="bash-ring-fill"/>
                        </svg>
                    </div>
                </button>
            </div>
        </div>

        <!-- Tamagotchi Stats Bar (Below Character) -->
        <div id="tamagotchi-stats-bar" style="background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; margin: 0; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
            <!-- Level & XP Section -->
            <div style="display: flex; align-items: center; gap: 14px;">
                <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 8px 14px; min-width: 60px; text-align: center;">
                    <div style="color: #888; font-size: 0.55rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Level</div>
                    <div id="tamagotchi-level" style="color: #fff; font-size: 1.6rem; font-weight: 900; line-height: 1; font-family: 'Outfit', sans-serif;">1</div>
                </div>
                <div style="flex: 1;">
                    <div id="tamagotchi-xp-text" style="color: rgba(255,255,255,0.8); font-size: 0.7rem; font-weight: 600; margin-bottom: 5px; letter-spacing: 0.3px;">0 / 8 XP to Level 2</div>
                    <div style="width: 120px; height: 7px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
                        <div id="tamagotchi-xp-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary-light)); transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);"></div>
                    </div>
                </div>
            </div>

            <!-- Rank Section -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="tamagotchi-rank" style="color: var(--secondary); font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;">NEWCOMER</div>
            </div>
        </div>

        <!-- Restore cached stats for returning users to prevent flash of default values -->
        <script>
        (function() {
            if (localStorage.getItem('dashboardInitialized') !== 'true') return;
            var lvl = localStorage.getItem('fitgotchi_level');
            var rank = localStorage.getItem('fitgotchi_rank');
            var xpText = localStorage.getItem('fitgotchi_xp_text');
            var xpPct = localStorage.getItem('fitgotchi_xp_percent');
            var streak = localStorage.getItem('fitgotchi_streak');
            if (lvl) { var el = document.getElementById('tamagotchi-level'); if (el) el.textContent = lvl; }
            if (rank) { var el = document.getElementById('tamagotchi-rank'); if (el) el.textContent = rank; }
            if (xpText) { var el = document.getElementById('tamagotchi-xp-text'); if (el) el.textContent = xpText; }
            if (xpPct) { var el = document.getElementById('tamagotchi-xp-bar'); if (el) el.style.width = xpPct; }
            if (streak) { var el = document.getElementById('tamagotchi-streak'); if (el) el.textContent = streak; }
        })();
        </script>

        <!-- Battle Stats Row (STR / HP / MANA) -->
        <div id="battle-stats-row" class="battle-stats-row" style="border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; padding-bottom: 10px; margin-bottom: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
            <div class="battle-stat str" onclick="showStatTooltip('str')" title="Strength - Increases attack damage">
                <div class="battle-stat-icon">⚔️</div>
                <div class="battle-stat-info">
                    <div class="battle-stat-label">
                        <span class="battle-stat-name">STR</span>
                        <span class="battle-stat-value" id="stat-str-value">0</span>
                    </div>
                    <div class="battle-stat-bar">
                        <div class="battle-stat-fill" id="stat-str-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="battle-stat hp" onclick="showStatTooltip('hp')" title="Health Points - Increases battle HP">
                <div class="battle-stat-icon">❤️</div>
                <div class="battle-stat-info">
                    <div class="battle-stat-label">
                        <span class="battle-stat-name">HP</span>
                        <span class="battle-stat-value" id="stat-hp-value">0</span>
                    </div>
                    <div class="battle-stat-bar">
                        <div class="battle-stat-fill" id="stat-hp-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="battle-stat mana" onclick="showStatTooltip('mana')" title="Mana - Faster special move charge">
                <div class="battle-stat-icon">🔮</div>
                <div class="battle-stat-info">
                    <div class="battle-stat-label">
                        <span class="battle-stat-name">MANA</span>
                        <span class="battle-stat-value" id="stat-mana-value">0</span>
                    </div>
                    <div class="battle-stat-bar">
                        <div class="battle-stat-fill" id="stat-mana-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Duplicate Install Banner Removed -->

    <!-- Hidden inputs for camera -->
    <input type="file" id="story-camera-input" accept="image/*,video/*" capture style="display:none;" onchange="handleStoryFileSelect(event)">
    <input type="file" id="meal-camera-input" accept="image/*" capture="environment" style="display:none;" onchange="handleMealPhotoSelect(event)">
    <!-- Hidden stories carousel (kept for compatibility but not displayed) -->
    <div id="stories-carousel-container" style="display: none;">
        <div id="stories-carousel" style="display: inline-flex; gap: 15px;">
            <div class="story-ring add-story-btn" onclick="openStoryCamera()" style="display: inline-block; text-align: center; cursor: pointer;"></div>
        </div>
    </div>

    <!-- Friends Pill Widget -->
    <div id="home-friends-pill" onclick="openHomeFriendsModal()" style="margin: 12px 25px 14px; display: flex; align-items: center; gap: 10px; padding: 10px 16px; background: white; border-radius: 40px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #f1f5f9; transition: transform 0.15s;">
        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center;">
            <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: white;"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        </div>
        <div style="flex: 1;">
            <span style="font-weight: 700; font-size: 0.9rem; color: var(--text-main);">Friends</span>
            <span id="home-friends-pill-count" style="font-size: 0.8rem; color: var(--text-muted); margin-left: 6px;">0</span>
        </div>
        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #94a3b8;"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </div>

    <!-- Friends Modal (Home Page) -->
    <div id="home-friends-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10007; align-items: flex-end; justify-content: center; backdrop-filter: blur(3px);" onclick="if(event.target===this) closeHomeFriendsModal();">
        <div style="background: white; border-radius: 20px 20px 0 0; max-width: 500px; width: 100%; max-height: 70vh; overflow: hidden; animation: slideUpModal 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 16px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main);">Friends</h3>
                    <span id="home-friends-modal-count" style="background: var(--primary); color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 10px;">0</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button onclick="closeHomeFriendsModal(); openAddFriendModal();" style="background: linear-gradient(135deg, var(--primary), #10b981); color: white; border: none; padding: 6px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; cursor: pointer;">+ Add</button>
                    <button onclick="closeHomeFriendsModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; line-height: 1;">&times;</button>
                </div>
            </div>
            <!-- Friends List -->
            <div id="home-friends-modal-list" style="overflow-y: auto; max-height: calc(70vh - 60px); padding: 8px 0;">
                <div style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Card -->
    <div id="ai-assistant-card" style="margin: 15px 25px; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border: 1px solid #e2e8f0;">
        <!-- Header -->
        <div style="padding: 14px 18px 10px; display: flex; align-items: center; gap: 10px;">
            <div style="width: 34px; height: 34px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: white;"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 700; font-size: 0.9rem; color: var(--text-main);">FITGotchi AI</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">Ask me anything or tell me what to change</div>
            </div>
            <button id="ai-assistant-expand-btn" onclick="toggleAiAssistantExpand()" style="background: none; border: none; padding: 4px; cursor: pointer; color: #94a3b8; display: none;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/></svg>
            </button>
        </div>
        <!-- Messages area (hidden until conversation starts) -->
        <div id="ai-assistant-messages" style="display: none; max-height: 320px; overflow-y: auto; padding: 0 18px 10px; scroll-behavior: smooth;">
        </div>
        <!-- Action confirmation area -->
        <div id="ai-assistant-actions" style="display: none; padding: 0 18px 10px;">
        </div>
        <!-- Input area -->
        <div style="padding: 8px 14px 12px; display: flex; gap: 8px; align-items: center; border-top: 1px solid #f1f5f9;">
            <input type="text" id="ai-assistant-input" placeholder="e.g. Create me a meal plan, swap workouts..." style="flex: 1; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 0.88rem; outline: none; background: #f8fafc; color: var(--text-main); transition: border-color 0.2s;" onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e2e8f0'" onkeypress="if(event.key==='Enter') sendAiAssistantMessage()">
            <button id="ai-assistant-send-btn" onclick="sendAiAssistantMessage()" style="width: 38px; height: 38px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: opacity 0.2s;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <!-- Daily Weigh-In Card (disappears after completion) -->
    <div id="daily-weigh-in-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 20px; color: white; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>

        <div style="position: relative; z-index: 1;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 700;">Daily Weigh-In</h3>
                    <p style="margin: 0; font-size: 0.85rem; opacity: 0.9;">Track your progress, earn XP!</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                    +1 XP
                </div>
            </div>

            <div id="weigh-in-input-section" style="display: flex; gap: 10px; align-items: center;">
                <div style="flex: 1; position: relative;">
                    <input type="number" id="weigh-in-weight-input" placeholder="Enter weight" step="0.1" min="20" max="500" style="width: 100%; padding: 12px 50px 12px 15px; border: none; border-radius: 10px; font-size: 1rem; background: rgba(255,255,255,0.95); color: #333; box-sizing: border-box;">
                    <span id="weigh-in-unit-label" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.9rem; font-weight: 500;">kg</span>
                </div>
                <button onclick="submitDailyWeighIn()" style="background: white; color: #667eea; border: none; padding: 12px 20px; border-radius: 10px; font-weight: 700; font-size: 0.95rem; cursor: pointer; white-space: nowrap; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                    Log It
                </button>
            </div>

            <div id="weigh-in-success-section" style="display: none; text-align: center; padding: 10px 0;">
                <div style="font-size: 2rem; margin-bottom: 8px;">+1 XP</div>
                <p style="margin: 0; font-weight: 600;">Weigh-in complete!</p>
            </div>
        </div>
    </div>

    <!-- Daily Weigh-In Completed Card -->
    <div id="daily-weigh-in-done-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 16px 20px; color: white; align-items: center; gap: 15px; position: relative;">
        <button onclick="dismissWeighInDoneCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0;">&#x2715;</button>
        <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">&#x2705;</div>
        <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 1rem;">Weigh-In Complete!</div>
            <div style="font-size: 0.82rem; opacity: 0.9; margin-top: 2px;">+1 XP earned. Come back tomorrow!</div>
        </div>
    </div>

    <!-- Weekly Progress Photo Card (shows on Mondays) -->
    <div id="weekly-progress-photo-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); border-radius: 16px; padding: 20px; color: white; position: relative; overflow: hidden; cursor: pointer;">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        <input type="file" id="progress-photo-input" accept="image/*" capture="environment" style="display:none;">
        <div style="position: relative; z-index: 1;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 700;">Weekly Progress Photo</h3>
                    <p style="margin: 0; font-size: 0.85rem; opacity: 0.9;">Snap a pic to track your transformation!</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                    +15 XP
                </div>
            </div>
            <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px;">
                <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">📸</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.95rem;">Take your weekly photo</div>
                    <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 2px;">Every Monday - track your journey</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: rgba(255,255,255,0.7);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
            </div>
        </div>
    </div>

    <!-- Weekly Progress Photo Upload Loading -->
    <div id="weekly-progress-photo-uploading" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); border-radius: 16px; padding: 20px; color: white; text-align: center;">
        <div style="font-size: 2rem; margin-bottom: 8px;">📸</div>
        <p style="margin: 0; font-weight: 600;">Uploading your progress photo...</p>
    </div>

    <!-- Weekly Progress Photo Completed Card -->
    <div id="weekly-progress-photo-done-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); border-radius: 16px; padding: 16px 20px; color: white; align-items: center; gap: 15px; position: relative;">
        <button onclick="dismissProgressPhotoDoneCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0;">&#x2715;</button>
        <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">&#x2705;</div>
        <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 1rem;">Progress Photo Saved!</div>
            <div style="font-size: 0.82rem; opacity: 0.9; margin-top: 2px;">+15 XP earned. See you next Monday!</div>
        </div>
    </div>

    <!-- Mood Check-In Card (3x daily: morning, afternoon, evening) -->
    <div id="mood-checkin-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%); border-radius: 16px; padding: 18px 20px; color: white; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        <div style="position: relative; z-index: 1;">
            <!-- Header with progress dots -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px;">
                <div>
                    <h3 id="mood-checkin-title" style="margin: 0 0 4px 0; font-size: 1.05rem; font-weight: 700;">How are you feeling?</h3>
                    <p id="mood-checkin-subtitle" style="margin: 0; font-size: 0.8rem; opacity: 0.85;">Quick mood check — 3 taps</p>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                    <div id="mood-dot-morning" style="width: 10px; height: 10px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.6); background: transparent; transition: all 0.3s;" title="Morning"></div>
                    <div id="mood-dot-afternoon" style="width: 10px; height: 10px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.6); background: transparent; transition: all 0.3s;" title="Afternoon"></div>
                    <div id="mood-dot-evening" style="width: 10px; height: 10px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.6); background: transparent; transition: all 0.3s;" title="Evening"></div>
                </div>
            </div>

            <!-- Mood selection -->
            <div id="mood-checkin-form" style="display: block;">
                <!-- Step 1: Mood -->
                <div id="mood-step-mood" style="margin-bottom: 14px;">
                    <div style="font-weight: 600; font-size: 0.82rem; margin-bottom: 8px; opacity: 0.95;">Mood</div>
                    <div style="display: flex; justify-content: space-between; gap: 6px;">
                        <button onclick="selectMoodEmoji('mood',1,this)" class="mood-emoji-btn" data-group="mood" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">😫</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Awful</div>
                        </button>
                        <button onclick="selectMoodEmoji('mood',2,this)" class="mood-emoji-btn" data-group="mood" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">😕</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Low</div>
                        </button>
                        <button onclick="selectMoodEmoji('mood',3,this)" class="mood-emoji-btn" data-group="mood" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">😐</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Okay</div>
                        </button>
                        <button onclick="selectMoodEmoji('mood',4,this)" class="mood-emoji-btn" data-group="mood" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">🙂</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Good</div>
                        </button>
                        <button onclick="selectMoodEmoji('mood',5,this)" class="mood-emoji-btn" data-group="mood" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">😁</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Great</div>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Energy -->
                <div id="mood-step-energy" style="margin-bottom: 14px;">
                    <div style="font-weight: 600; font-size: 0.82rem; margin-bottom: 8px; opacity: 0.95;">Energy</div>
                    <div style="display: flex; justify-content: space-between; gap: 6px;">
                        <button onclick="selectMoodEmoji('energy',1,this)" class="mood-emoji-btn" data-group="energy" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">🪫</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Dead</div>
                        </button>
                        <button onclick="selectMoodEmoji('energy',2,this)" class="mood-emoji-btn" data-group="energy" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">😴</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Tired</div>
                        </button>
                        <button onclick="selectMoodEmoji('energy',3,this)" class="mood-emoji-btn" data-group="energy" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">🙂</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Normal</div>
                        </button>
                        <button onclick="selectMoodEmoji('energy',4,this)" class="mood-emoji-btn" data-group="energy" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">💪</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Good</div>
                        </button>
                        <button onclick="selectMoodEmoji('energy',5,this)" class="mood-emoji-btn" data-group="energy" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">⚡</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Wired</div>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Stress -->
                <div id="mood-step-stress" style="margin-bottom: 14px;">
                    <div style="font-weight: 600; font-size: 0.82rem; margin-bottom: 8px; opacity: 0.95;">Stress</div>
                    <div style="display: flex; justify-content: space-between; gap: 6px;">
                        <button onclick="selectMoodEmoji('stress',1,this)" class="mood-emoji-btn" data-group="stress" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">😌</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Chill</div>
                        </button>
                        <button onclick="selectMoodEmoji('stress',2,this)" class="mood-emoji-btn" data-group="stress" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">🙂</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Easy</div>
                        </button>
                        <button onclick="selectMoodEmoji('stress',3,this)" class="mood-emoji-btn" data-group="stress" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">😐</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Some</div>
                        </button>
                        <button onclick="selectMoodEmoji('stress',4,this)" class="mood-emoji-btn" data-group="stress" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">😰</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">High</div>
                        </button>
                        <button onclick="selectMoodEmoji('stress',5,this)" class="mood-emoji-btn" data-group="stress" style="flex: 1; background: rgba(255,255,255,0.12); border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: all 0.2s; text-align: center;">
                            <div style="font-size: 1.5rem;">🤯</div>
                            <div style="font-size: 0.6rem; color: white; opacity: 0.7; margin-top: 2px;">Max</div>
                        </button>
                    </div>
                </div>

                <!-- Submit button (hidden until all 3 selected) -->
                <button id="mood-checkin-submit" onclick="submitMoodCheckin()" style="display: none; width: 100%; background: white; color: #a855f7; border: none; padding: 12px; border-radius: 10px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: transform 0.2s;">
                    Log Check-In
                </button>
            </div>

            <!-- Success state -->
            <div id="mood-checkin-success" style="display: none; text-align: center; padding: 6px 0;">
                <div style="font-size: 1.6rem; margin-bottom: 6px;">+1 XP</div>
                <p id="mood-checkin-success-text" style="margin: 0; font-weight: 600; font-size: 0.9rem;">All 3 check-ins done! Nice one.</p>
            </div>
        </div>
    </div>

    <!-- Mood Check-In Done Card -->
    <div id="mood-checkin-done-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%); border-radius: 16px; padding: 14px 20px; color: white; align-items: center; gap: 12px; position: relative;">
        <button onclick="dismissMoodCheckinDoneCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0;">&#x2715;</button>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 38px; height: 38px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">&#x2705;</div>
            <div style="flex: 1;">
                <div style="font-weight: 700; font-size: 0.95rem;">Mood Check-Ins Complete!</div>
                <div id="mood-done-summary" style="font-size: 0.78rem; opacity: 0.9; margin-top: 2px;">+1 XP earned. See you tomorrow!</div>
            </div>
        </div>
    </div>

    <!-- Fitness Diary Card (appears daily from 6 PM) -->
    <div id="fitness-diary-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%); border-radius: 16px; padding: 20px; color: white; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>

        <div style="position: relative; z-index: 1;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 700;">Fitness Diary</h3>
                    <p style="margin: 0; font-size: 0.85rem; opacity: 0.9;">Quick daily reflection on your fitness journey</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                    +1 XP
                </div>
            </div>

            <!-- Collapsed state (tap to expand) -->
            <div id="fitness-diary-collapsed" onclick="expandFitnessDiary()" style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">&#x1F4D3;</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 0.95rem;">How was your day?</div>
                    <div style="font-size: 0.8rem; opacity: 0.85; margin-top: 2px;">Tap to write your diary — takes 30 seconds</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: rgba(255,255,255,0.7);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
            </div>

            <!-- Expanded form (hidden until tapped) -->
            <div id="fitness-diary-form" style="display: none;">
                <!-- Q1: How did your day feel? -->
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px;">How did today feel overall?</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="wcheckin-chip" data-group="day_rating" data-value="crushed_it" onclick="selectFitnessDiaryOption('day_rating','crushed_it',this)" style="background: rgba(255,255,255,0.15); border: 2px solid transparent; color: white; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">Crushed it</button>
                        <button class="wcheckin-chip" data-group="day_rating" data-value="pretty_good" onclick="selectFitnessDiaryOption('day_rating','pretty_good',this)" style="background: rgba(255,255,255,0.15); border: 2px solid transparent; color: white; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">Pretty good</button>
                        <button class="wcheckin-chip" data-group="day_rating" data-value="meh" onclick="selectFitnessDiaryOption('day_rating','meh',this)" style="background: rgba(255,255,255,0.15); border: 2px solid transparent; color: white; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">Meh</button>
                        <button class="wcheckin-chip" data-group="day_rating" data-value="rough" onclick="selectFitnessDiaryOption('day_rating','rough',this)" style="background: rgba(255,255,255,0.15); border: 2px solid transparent; color: white; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">Rough</button>
                    </div>
                </div>

                <!-- Q2: Today's highlight -->
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px;">Best thing you did for your health today?</div>
                    <input type="text" id="diary-highlight" placeholder="e.g. Got my steps in, ate well, trained legs..." style="width: 100%; padding: 10px 14px; border: none; border-radius: 10px; font-size: 0.88rem; background: rgba(255,255,255,0.95); color: #333; box-sizing: border-box;">
                </div>

                <!-- Q3: What was hardest -->
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px;">What was hardest today?</div>
                    <input type="text" id="diary-struggle" placeholder="e.g. Cravings, low energy, skipped workout..." style="width: 100%; padding: 10px 14px; border: none; border-radius: 10px; font-size: 0.88rem; background: rgba(255,255,255,0.95); color: #333; box-sizing: border-box;">
                </div>

                <!-- Q4: Energy level -->
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px;">How's your energy right now?</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="wcheckin-chip" data-group="energy_level" data-value="on_fire" onclick="selectFitnessDiaryOption('energy_level','on_fire',this)" style="background: rgba(255,255,255,0.15); border: 2px solid transparent; color: white; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">On fire</button>
                        <button class="wcheckin-chip" data-group="energy_level" data-value="steady" onclick="selectFitnessDiaryOption('energy_level','steady',this)" style="background: rgba(255,255,255,0.15); border: 2px solid transparent; color: white; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">Steady</button>
                        <button class="wcheckin-chip" data-group="energy_level" data-value="low" onclick="selectFitnessDiaryOption('energy_level','low',this)" style="background: rgba(255,255,255,0.15); border: 2px solid transparent; color: white; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">Low</button>
                        <button class="wcheckin-chip" data-group="energy_level" data-value="running_on_empty" onclick="selectFitnessDiaryOption('energy_level','running_on_empty',this)" style="background: rgba(255,255,255,0.15); border: 2px solid transparent; color: white; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">Running on empty</button>
                    </div>
                </div>

                <!-- Q5: Anything else? -->
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px;">Anything else on your mind?</div>
                    <input type="text" id="diary-note" placeholder="Optional — how you're feeling, goals for tomorrow..." style="width: 100%; padding: 10px 14px; border: none; border-radius: 10px; font-size: 0.88rem; background: rgba(255,255,255,0.95); color: #333; box-sizing: border-box;">
                </div>

                <button onclick="submitFitnessDiary()" style="width: 100%; background: white; color: #6366f1; border: none; padding: 14px; border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                    Save Diary Entry
                </button>
            </div>

            <!-- Success state -->
            <div id="fitness-diary-success" style="display: none; text-align: center; padding: 10px 0;">
                <div style="font-size: 2rem; margin-bottom: 8px;">+1 XP</div>
                <p style="margin: 0; font-weight: 600;">Diary entry saved! Nice work today.</p>
            </div>
        </div>
    </div>

    <!-- Fitness Diary Completed Card -->
    <div id="fitness-diary-done-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%); border-radius: 16px; padding: 16px 20px; color: white; align-items: center; gap: 15px; position: relative;">
        <button onclick="dismissFitnessDiaryDoneCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0;">&#x2715;</button>
        <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">&#x2705;</div>
        <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 1rem;">Fitness Diary Done!</div>
            <div style="font-size: 0.82rem; opacity: 0.9; margin-top: 2px;">+1 XP earned. Come back tomorrow!</div>
        </div>
    </div>

    <!-- Daily Quiz Card (disappears after completion) -->
    <div id="daily-quiz-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); border-radius: 16px; padding: 20px; color: white; position: relative; overflow: hidden; cursor: pointer;">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        <div style="position: relative; z-index: 1;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; font-weight: 700;">Daily Quiz</h3>
                    <p id="daily-quiz-subtitle" style="margin: 0; font-size: 0.85rem; opacity: 0.9;">Complete a lesson, earn bonus XP!</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                    +5 XP
                </div>
            </div>
            <div id="daily-quiz-lesson-info" style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px;">
                <div id="daily-quiz-icon" style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;"></div>
                <div style="flex: 1;">
                    <div id="daily-quiz-lesson-title" style="font-weight: 600; font-size: 0.95rem;"></div>
                    <div id="daily-quiz-lesson-context" style="font-size: 0.8rem; opacity: 0.85; margin-top: 2px;"></div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: rgba(255,255,255,0.7);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
            </div>
        </div>
    </div>

    <!-- Daily Quiz Completed Card -->
    <div id="daily-quiz-done-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 16px; padding: 16px 20px; color: white; align-items: center; gap: 15px; position: relative;">
        <button onclick="dismissQuizDoneCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0;">&#x2715;</button>
        <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">&#x2705;</div>
        <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 1rem;">Daily Quiz Complete!</div>
            <div style="font-size: 0.82rem; opacity: 0.9; margin-top: 2px;">+5 XP earned. Come back tomorrow!</div>
        </div>
    </div>

    <!-- Daily Meal Tip Card -->
    <div id="daily-meal-tip-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 18px 20px; color: white; position: relative; overflow: hidden; cursor: pointer;" onclick="openWeeklyTrendsPage()">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        <button onclick="event.stopPropagation(); dismissMealTipCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0; z-index: 2;">&#x2715;</button>
        <div style="position: relative; z-index: 1;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0;">🥗</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 4px;">Meal Insight</div>
                    <div id="daily-meal-tip-text" style="font-size: 0.82rem; opacity: 0.95; line-height: 1.4;">Loading your latest meal pattern...</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 10px; gap: 6px; font-size: 0.78rem; opacity: 0.8;">
                <span>View all trends</span>
                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: rgba(255,255,255,0.8);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
            </div>
        </div>
    </div>

    <!-- Daily Workout Trend Card -->
    <div id="daily-workout-trend-card" style="display: none; margin: 15px 25px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 16px; padding: 18px 20px; color: white; position: relative; overflow: hidden; cursor: pointer;" onclick="switchAppTab('movement-tab', this)">
        <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        <button onclick="event.stopPropagation(); dismissWorkoutTrendCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0; z-index: 2;">&#x2715;</button>
        <div style="position: relative; z-index: 1;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0;">💪</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 4px;">Workout Trend</div>
                    <div id="daily-workout-trend-text" style="font-size: 0.82rem; opacity: 0.95; line-height: 1.4;">Loading your workout stats...</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 10px; gap: 6px; font-size: 0.78rem; opacity: 0.8;">
                <span>Open Movement Studio</span>
                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: rgba(255,255,255,0.8);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
            </div>
        </div>
    </div>

    <script src="js/dashboard/dashboard-script-1-daily_weighin_card_logic.js"></script>


    <script>
    // ===== FITBIT INTEGRATION LOGIC =====

    /**
     * Check Fitbit connection status and load data
     */
    async function initFitbitDashboard() {
        if (!window.currentUser) return;

        try {
            const response = await fetch(`/api/fitbit/data?user_id=${window.currentUser.id}`);
            const data = await response.json();

            if (data.connected) {
                // Update settings button
                const btn = document.getElementById('fitbit-connect-btn');
                const statusText = document.getElementById('fitbit-status-text');
                if (btn) {
                    btn.textContent = 'Disconnect';
                    btn.style.background = '#ef4444';
                }
                if (statusText) statusText.textContent = 'Connected and syncing';
            } else {
                // Reset settings button
                const btn = document.getElementById('fitbit-connect-btn');
                const statusText = document.getElementById('fitbit-status-text');
                if (btn) {
                    btn.textContent = 'Connect';
                    btn.style.background = '#00B0B9';
                }
                if (statusText) statusText.textContent = 'Sync steps, sleep & heart rate';
            }
        } catch (err) {
            console.warn('Fitbit init error:', err);
        }
    }

    /**
     * Update the Fitbit display cards with data
     */
    function updateFitbitDisplay(data) {
        // Today's activity
        const todayActivity = data.activity && data.activity[0];
        if (todayActivity) {
            const stepsEl = document.getElementById('fitbit-steps');
            const activeMinsEl = document.getElementById('fitbit-active-mins');
            const caloriesEl = document.getElementById('fitbit-calories');

            if (stepsEl) stepsEl.textContent = (todayActivity.steps || 0).toLocaleString();
            if (activeMinsEl) activeMinsEl.textContent = (todayActivity.active_minutes || 0) + ' min';
            if (caloriesEl) caloriesEl.textContent = (todayActivity.calories_burned || 0).toLocaleString();
        }

        // Today's sleep
        const todaySleep = data.sleep && data.sleep[0];
        if (todaySleep) {
            const sleepEl = document.getElementById('fitbit-sleep');
            if (sleepEl) {
                const hours = Math.floor((todaySleep.duration_minutes || 0) / 60);
                const mins = (todaySleep.duration_minutes || 0) % 60;
                sleepEl.textContent = hours + 'h ' + mins + 'm';
            }
        }

        // Today's heart rate
        const todayHR = data.heart_rate && data.heart_rate[0];
        if (todayHR && todayHR.resting_heart_rate) {
            const hrEl = document.getElementById('fitbit-heart-rate');
            if (hrEl) hrEl.textContent = todayHR.resting_heart_rate;
        }

        // Last sync time
        if (data.last_sync) {
            const syncEl = document.getElementById('fitbit-last-sync');
            if (syncEl) {
                const syncDate = new Date(data.last_sync);
                const now = new Date();
                const diffMins = Math.floor((now - syncDate) / 60000);
                let timeAgo;
                if (diffMins < 1) timeAgo = 'Just now';
                else if (diffMins < 60) timeAgo = diffMins + 'm ago';
                else if (diffMins < 1440) timeAgo = Math.floor(diffMins / 60) + 'h ago';
                else timeAgo = Math.floor(diffMins / 1440) + 'd ago';
                syncEl.textContent = 'Last synced ' + timeAgo;
            }
        }
    }

    /**
     * Connect or disconnect Fitbit
     */
    function toggleFitbitConnection() {
        if (!window.currentUser) return;

        const btn = document.getElementById('fitbit-connect-btn');
        if (btn && btn.textContent.trim() === 'Disconnect') {
            // Disconnect
            if (confirm('Disconnect your Fitbit? Your synced data will remain.')) {
                btn.textContent = '...';
                btn.disabled = true;
                fetch('/api/fitbit/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.id }),
                }).then(() => {
                    btn.textContent = 'Connect';
                    btn.style.background = '#00B0B9';
                    btn.disabled = false;
                    const statusText = document.getElementById('fitbit-status-text');
                    if (statusText) statusText.textContent = 'Sync steps, sleep & heart rate';
                    const card = document.getElementById('fitbit-dashboard-card');
                    if (card) card.style.display = 'none';
                }).catch(() => {
                    btn.textContent = 'Disconnect';
                    btn.disabled = false;
                    alert('Failed to disconnect. Please try again.');
                });
            }
        } else {
            // Connect - redirect to Fitbit OAuth
            window.location.href = '/api/fitbit/auth?user_id=' + window.currentUser.id;
        }
    }

    /**
     * Manual sync button
     */
    function syncFitbitNow() {
        if (!window.currentUser) return;

        const btn = document.getElementById('fitbit-sync-btn');
        if (btn) {
            btn.style.opacity = '0.5';
            btn.style.pointerEvents = 'none';
        }

        fetch('/api/fitbit/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: window.currentUser.id }),
        }).then(r => r.json()).then(() => {
            // Refresh display
            return fetch('/api/fitbit/data?user_id=' + window.currentUser.id);
        }).then(r => r.json()).then(data => {
            if (data.connected) updateFitbitDisplay(data);
            // Refresh challenge progress (steps/sleep challenges may use Fitbit data)
            if (typeof refreshChallengeProgress === 'function') refreshChallengeProgress();
        }).catch(err => {
            console.warn('Fitbit sync error:', err);
        }).finally(() => {
            if (btn) {
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }
        });
    }

    /**
     * Handle Fitbit OAuth redirect results
     */
    function checkFitbitOAuthResult() {
        const params = new URLSearchParams(window.location.search);
        const fitbitResult = params.get('fitbit');

        if (fitbitResult) {
            // Clean URL
            const cleanUrl = window.location.pathname;
            window.history.replaceState({}, '', cleanUrl);

            if (fitbitResult === 'connected') {
                // Show success message
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:14px 24px; border-radius:12px; font-weight:600; z-index:99999; box-shadow:0 4px 12px rgba(0,0,0,0.15); font-size:0.9rem;';
                toast.textContent = 'Fitbit connected! Syncing your data...';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);

                // Refresh Fitbit data
                setTimeout(() => initFitbitDashboard(), 2000);
            } else if (fitbitResult === 'denied') {
                alert('Fitbit connection was cancelled. You can connect anytime from Settings.');
            } else if (fitbitResult === 'error') {
                alert('There was a problem connecting to Fitbit. Please try again.');
            }
        }
    }

    // Make functions globally available
    window.toggleFitbitConnection = toggleFitbitConnection;
    window.syncFitbitNow = syncFitbitNow;
    window.initFitbitDashboard = initFitbitDashboard;

    // Check OAuth result on page load
    checkFitbitOAuthResult();
    </script>

    <script>
    // ===== WHOOP INTEGRATION LOGIC =====

    async function initWhoopDashboard() {
        if (!window.currentUser) return;
        try {
            const response = await fetch(`/api/whoop/data?user_id=${window.currentUser.id}`);
            const data = await response.json();
            if (data.connected) {
                const card = document.getElementById('whoop-dashboard-card');
                if (card) card.style.display = 'block';
                const btn = document.getElementById('whoop-connect-btn');
                const statusText = document.getElementById('whoop-status-text');
                if (btn) { btn.textContent = 'Disconnect'; btn.style.background = '#ef4444'; }
                if (statusText) statusText.textContent = 'Connected and syncing';
                updateWhoopDisplay(data);
            } else {
                const card = document.getElementById('whoop-dashboard-card');
                if (card) card.style.display = 'none';
                const btn = document.getElementById('whoop-connect-btn');
                const statusText = document.getElementById('whoop-status-text');
                if (btn) { btn.textContent = 'Connect'; btn.style.background = '#1a1a1a'; }
                if (statusText) statusText.textContent = 'Sync recovery, strain & sleep';
            }
        } catch (err) { console.warn('WHOOP init error:', err); }
    }

    function updateWhoopDisplay(data) {
        const todayRecovery = data.recovery && data.recovery[0];
        if (todayRecovery) {
            const recEl = document.getElementById('whoop-recovery');
            const hrEl = document.getElementById('whoop-resting-hr');
            const hrvEl = document.getElementById('whoop-hrv');
            if (recEl) recEl.textContent = (todayRecovery.recovery_score || 0) + '%';
            if (hrEl && todayRecovery.resting_heart_rate) hrEl.textContent = todayRecovery.resting_heart_rate;
            if (hrvEl && todayRecovery.hrv_rmssd) hrvEl.textContent = Math.round(todayRecovery.hrv_rmssd);
        }
        const todaySleep = data.sleep && data.sleep[0];
        if (todaySleep) {
            const sleepEl = document.getElementById('whoop-sleep');
            if (sleepEl) {
                const hours = Math.floor((todaySleep.duration_minutes || 0) / 60);
                const mins = (todaySleep.duration_minutes || 0) % 60;
                sleepEl.textContent = hours + 'h ' + mins + 'm';
            }
        }
        const todayWorkout = data.workouts && data.workouts[0];
        if (todayWorkout) {
            const strainEl = document.getElementById('whoop-strain');
            if (strainEl) strainEl.textContent = (todayWorkout.strain || 0).toFixed(1);
        }
        if (data.last_sync) {
            const syncEl = document.getElementById('whoop-last-sync');
            if (syncEl) syncEl.textContent = 'Last synced ' + formatTimeAgo(data.last_sync);
        }
    }

    function toggleWhoopConnection() {
        if (!window.currentUser) return;
        const btn = document.getElementById('whoop-connect-btn');
        if (btn && btn.textContent.trim() === 'Disconnect') {
            if (confirm('Disconnect your WHOOP? Your synced data will remain.')) {
                btn.textContent = '...'; btn.disabled = true;
                fetch('/api/whoop/disconnect', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.id }),
                }).then(() => {
                    btn.textContent = 'Connect'; btn.style.background = '#1a1a1a'; btn.disabled = false;
                    document.getElementById('whoop-status-text').textContent = 'Sync recovery, strain & sleep';
                    const card = document.getElementById('whoop-dashboard-card');
                    if (card) card.style.display = 'none';
                }).catch(() => { btn.textContent = 'Disconnect'; btn.disabled = false; alert('Failed to disconnect.'); });
            }
        } else {
            window.location.href = '/api/whoop/auth?user_id=' + window.currentUser.id;
        }
    }

    function syncWhoopNow() {
        if (!window.currentUser) return;
        const btn = document.getElementById('whoop-sync-btn');
        if (btn) { btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; }
        fetch('/api/whoop/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: window.currentUser.id }) })
            .then(r => r.json()).then(() => fetch('/api/whoop/data?user_id=' + window.currentUser.id))
            .then(r => r.json()).then(data => {
                if (data.connected) updateWhoopDisplay(data);
                // Refresh challenge progress (sleep challenge uses WHOOP data)
                if (typeof refreshChallengeProgress === 'function') refreshChallengeProgress();
            })
            .catch(err => console.warn('WHOOP sync error:', err))
            .finally(() => { if (btn) { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; } });
    }

    function checkWhoopOAuthResult() {
        const params = new URLSearchParams(window.location.search);
        const result = params.get('whoop');
        if (result) {
            window.history.replaceState({}, '', window.location.pathname);
            if (result === 'connected') {
                showWearableToast('WHOOP connected! Syncing your data...');
                setTimeout(() => initWhoopDashboard(), 2000);
            } else if (result === 'denied') {
                alert('WHOOP connection was cancelled. You can connect anytime from Settings.');
            } else if (result === 'error') {
                alert('There was a problem connecting to WHOOP. Please try again.');
            }
        }
    }

    window.toggleWhoopConnection = toggleWhoopConnection;
    window.syncWhoopNow = syncWhoopNow;
    window.initWhoopDashboard = initWhoopDashboard;
    checkWhoopOAuthResult();
    </script>

    <script>
    // ===== OURA RING INTEGRATION LOGIC =====

    async function initOuraDashboard() {
        if (!window.currentUser) return;
        try {
            const response = await fetch(`/api/oura/data?user_id=${window.currentUser.id}`);
            const data = await response.json();
            if (data.connected) {
                const card = document.getElementById('oura-dashboard-card');
                if (card) card.style.display = 'block';
                const btn = document.getElementById('oura-connect-btn');
                const statusText = document.getElementById('oura-status-text');
                if (btn) { btn.textContent = 'Disconnect'; btn.style.background = '#ef4444'; }
                if (statusText) statusText.textContent = 'Connected and syncing';
                updateOuraDisplay(data);
            } else {
                const card = document.getElementById('oura-dashboard-card');
                if (card) card.style.display = 'none';
                const btn = document.getElementById('oura-connect-btn');
                const statusText = document.getElementById('oura-status-text');
                if (btn) { btn.textContent = 'Connect'; btn.style.background = '#c4a862'; }
                if (statusText) statusText.textContent = 'Sync readiness, sleep & activity';
            }
        } catch (err) { console.warn('Oura init error:', err); }
    }

    function updateOuraDisplay(data) {
        const todayActivity = data.activity && data.activity[0];
        if (todayActivity) {
            const stepsEl = document.getElementById('oura-steps');
            const caloriesEl = document.getElementById('oura-calories');
            if (stepsEl) stepsEl.textContent = (todayActivity.steps || 0).toLocaleString();
            if (caloriesEl) caloriesEl.textContent = (todayActivity.active_calories || 0).toLocaleString();
        }
        const todaySleep = data.sleep && data.sleep[0];
        if (todaySleep) {
            const sleepEl = document.getElementById('oura-sleep');
            const scoreEl = document.getElementById('oura-sleep-score');
            if (sleepEl) {
                const hours = Math.floor((todaySleep.total_sleep_minutes || 0) / 60);
                const mins = (todaySleep.total_sleep_minutes || 0) % 60;
                sleepEl.textContent = hours + 'h ' + mins + 'm';
            }
            if (scoreEl && todaySleep.sleep_score) scoreEl.textContent = todaySleep.sleep_score;
        }
        const todayReadiness = data.readiness && data.readiness[0];
        if (todayReadiness && todayReadiness.readiness_score) {
            const readyEl = document.getElementById('oura-readiness');
            if (readyEl) readyEl.textContent = todayReadiness.readiness_score;
        }
        if (data.last_sync) {
            const syncEl = document.getElementById('oura-last-sync');
            if (syncEl) syncEl.textContent = 'Last synced ' + formatTimeAgo(data.last_sync);
        }
    }

    function toggleOuraConnection() {
        if (!window.currentUser) return;
        const btn = document.getElementById('oura-connect-btn');
        if (btn && btn.textContent.trim() === 'Disconnect') {
            if (confirm('Disconnect your Oura Ring? Your synced data will remain.')) {
                btn.textContent = '...'; btn.disabled = true;
                fetch('/api/oura/disconnect', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.id }),
                }).then(() => {
                    btn.textContent = 'Connect'; btn.style.background = '#c4a862'; btn.disabled = false;
                    document.getElementById('oura-status-text').textContent = 'Sync readiness, sleep & activity';
                    const card = document.getElementById('oura-dashboard-card');
                    if (card) card.style.display = 'none';
                }).catch(() => { btn.textContent = 'Disconnect'; btn.disabled = false; alert('Failed to disconnect.'); });
            }
        } else {
            window.location.href = '/api/oura/auth?user_id=' + window.currentUser.id;
        }
    }

    function syncOuraNow() {
        if (!window.currentUser) return;
        const btn = document.getElementById('oura-sync-btn');
        if (btn) { btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; }
        fetch('/api/oura/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: window.currentUser.id }) })
            .then(r => r.json()).then(() => fetch('/api/oura/data?user_id=' + window.currentUser.id))
            .then(r => r.json()).then(data => {
                if (data.connected) updateOuraDisplay(data);
                // Refresh challenge progress (sleep + steps challenges use Oura data)
                if (typeof refreshChallengeProgress === 'function') refreshChallengeProgress();
            })
            .catch(err => console.warn('Oura sync error:', err))
            .finally(() => { if (btn) { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; } });
    }

    function checkOuraOAuthResult() {
        const params = new URLSearchParams(window.location.search);
        const result = params.get('oura');
        if (result) {
            window.history.replaceState({}, '', window.location.pathname);
            if (result === 'connected') {
                showWearableToast('Oura Ring connected! Syncing your data...');
                setTimeout(() => initOuraDashboard(), 2000);
            } else if (result === 'denied') {
                alert('Oura connection was cancelled. You can connect anytime from Settings.');
            } else if (result === 'error') {
                alert('There was a problem connecting to Oura. Please try again.');
            }
        }
    }

    window.toggleOuraConnection = toggleOuraConnection;
    window.syncOuraNow = syncOuraNow;
    window.initOuraDashboard = initOuraDashboard;
    checkOuraOAuthResult();
    </script>

    <script>
    // ===== STRAVA INTEGRATION LOGIC =====

    async function initStravaDashboard() {
        if (!window.currentUser) return;
        try {
            const response = await fetch(`/api/strava/data?user_id=${window.currentUser.id}`);
            const data = await response.json();
            if (data.connected) {
                const card = document.getElementById('strava-dashboard-card');
                if (card) card.style.display = 'block';
                const btn = document.getElementById('strava-connect-btn');
                const statusText = document.getElementById('strava-status-text');
                if (btn) { btn.textContent = 'Disconnect'; btn.style.background = '#ef4444'; }
                if (statusText) statusText.textContent = 'Connected and syncing';
                updateStravaDisplay(data);
            } else {
                const card = document.getElementById('strava-dashboard-card');
                if (card) card.style.display = 'none';
                const btn = document.getElementById('strava-connect-btn');
                const statusText = document.getElementById('strava-status-text');
                if (btn) { btn.textContent = 'Connect'; btn.style.background = '#FC4C02'; }
                if (statusText) statusText.textContent = 'Sync workouts, runs & rides';
            }
        } catch (err) { console.warn('Strava init error:', err); }
    }

    function updateStravaDisplay(data) {
        const latest = data.activities && data.activities[0];
        if (latest) {
            const nameEl = document.getElementById('strava-activity-name');
            const typeEl = document.getElementById('strava-activity-type');
            const distEl = document.getElementById('strava-distance');
            const durEl = document.getElementById('strava-duration');
            const hrEl = document.getElementById('strava-heart-rate');
            const calEl = document.getElementById('strava-calories');
            const elevEl = document.getElementById('strava-elevation');

            if (nameEl) nameEl.textContent = latest.name || 'Activity';
            if (typeEl) typeEl.textContent = latest.sport_type || '';

            // Distance: convert meters to km or miles
            if (distEl) {
                const km = ((latest.distance_meters || 0) / 1000).toFixed(1);
                distEl.textContent = km + ' km';
            }
            // Duration: convert seconds to h:mm
            if (durEl) {
                const totalMins = Math.round((latest.moving_time_seconds || 0) / 60);
                const hours = Math.floor(totalMins / 60);
                const mins = totalMins % 60;
                durEl.textContent = hours > 0 ? hours + 'h ' + mins + 'm' : mins + 'm';
            }
            if (hrEl && latest.avg_heart_rate) hrEl.textContent = latest.avg_heart_rate;
            if (calEl) calEl.textContent = (latest.calories || 0).toLocaleString();
            if (elevEl) elevEl.textContent = Math.round(latest.total_elevation_gain || 0) + 'm';
        }
        if (data.last_sync) {
            const syncEl = document.getElementById('strava-last-sync');
            if (syncEl) syncEl.textContent = 'Last synced ' + formatTimeAgo(data.last_sync);
        }
    }

    function toggleStravaConnection() {
        if (!window.currentUser) return;
        const btn = document.getElementById('strava-connect-btn');
        if (btn && btn.textContent.trim() === 'Disconnect') {
            if (confirm('Disconnect your Strava? Your synced data will remain.')) {
                btn.textContent = '...'; btn.disabled = true;
                fetch('/api/strava/disconnect', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.id }),
                }).then(() => {
                    btn.textContent = 'Connect'; btn.style.background = '#FC4C02'; btn.disabled = false;
                    document.getElementById('strava-status-text').textContent = 'Sync workouts, runs & rides';
                    const card = document.getElementById('strava-dashboard-card');
                    if (card) card.style.display = 'none';
                }).catch(() => { btn.textContent = 'Disconnect'; btn.disabled = false; alert('Failed to disconnect.'); });
            }
        } else {
            window.location.href = '/api/strava/auth?user_id=' + window.currentUser.id;
        }
    }

    function syncStravaNow() {
        if (!window.currentUser) return;
        const btn = document.getElementById('strava-sync-btn');
        if (btn) { btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; }
        fetch('/api/strava/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: window.currentUser.id }) })
            .then(r => r.json()).then(() => fetch('/api/strava/data?user_id=' + window.currentUser.id))
            .then(r => r.json()).then(data => { if (data.connected) updateStravaDisplay(data); })
            .catch(err => console.warn('Strava sync error:', err))
            .finally(() => { if (btn) { btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; } });
    }

    function checkStravaOAuthResult() {
        const params = new URLSearchParams(window.location.search);
        const result = params.get('strava');
        if (result) {
            window.history.replaceState({}, '', window.location.pathname);
            if (result === 'connected') {
                showWearableToast('Strava connected! Syncing your data...');
                setTimeout(() => initStravaDashboard(), 2000);
            } else if (result === 'denied') {
                alert('Strava connection was cancelled. You can connect anytime from Settings.');
            } else if (result === 'error') {
                alert('There was a problem connecting to Strava. Please try again.');
            }
        }
    }

    window.toggleStravaConnection = toggleStravaConnection;
    window.syncStravaNow = syncStravaNow;
    window.initStravaDashboard = initStravaDashboard;
    checkStravaOAuthResult();
    </script>

    <script>
    // ===== SPOTIFY INTEGRATION =====
    (function() {
        let spotifyConnected = false;

        async function initSpotifyDashboard() {
            if (!window.currentUser) return;
            try {
                const res  = await fetch(`/api/spotify/data?user_id=${window.currentUser.id}`);
                const data = await res.json();
                updateSpotifyDisplay(data);
            } catch (err) {
                console.warn('Spotify data fetch error:', err);
            }
        }

        function updateSpotifyDisplay(data) {
            spotifyConnected = !!data.connected;
            const btn  = document.getElementById('spotify-connect-btn');
            const text = document.getElementById('spotify-status-text');
            if (!btn) return;

            if (data.connected) {
                btn.textContent  = 'Disconnect';
                btn.style.background = '#ef4444';
                if (text) {
                    const name = data.display_name ? `${data.display_name} · ` : '';
                    const sync = data.last_sync ? formatTimeAgo(data.last_sync) : 'never';
                    text.textContent = `${name}Last sync: ${sync}`;
                }
            } else {
                btn.textContent  = 'Connect';
                btn.style.background = '#1DB954';
                if (text) text.textContent = 'Sync listening habits & music data';
            }
        }

        async function toggleSpotifyConnection() {
            if (!window.currentUser) return;

            if (spotifyConnected) {
                if (!confirm('Disconnect Spotify? Your listening history will be kept.')) return;
                const btn = document.getElementById('spotify-connect-btn');
                btn.disabled = true; btn.textContent = 'Disconnecting...';
                try {
                    await fetch('/api/spotify/disconnect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: window.currentUser.id }),
                    });
                    updateSpotifyDisplay({ connected: false });
                } catch (err) {
                    console.error('Spotify disconnect error:', err);
                    alert('Failed to disconnect. Please try again.');
                } finally {
                    btn.disabled = false;
                }
            } else {
                window.location.href = `/api/spotify/auth?user_id=${window.currentUser.id}`;
            }
        }

        function checkSpotifyOAuthResult() {
            const params = new URLSearchParams(window.location.search);
            const result = params.get('spotify');
            if (result) {
                window.history.replaceState({}, '', window.location.pathname);
                if (result === 'connected') {
                    showWearableToast('Spotify connected! Syncing your listening data...');
                    setTimeout(() => initSpotifyDashboard(), 2000);
                } else if (result === 'denied') {
                    alert('Spotify connection was cancelled. You can connect anytime from Settings.');
                } else if (result === 'error') {
                    alert('There was a problem connecting to Spotify. Please try again.');
                }
            }
        }

        window.toggleSpotifyConnection = toggleSpotifyConnection;
        window.initSpotifyDashboard    = initSpotifyDashboard;
        initSpotifyDashboard();
        checkSpotifyOAuthResult();
    })();
    </script>

    <!-- Spotify mini player moved to global scope (before bottom-nav) for cross-tab visibility -->

    <!-- ===== SPOTIFY FULL PLAYER OVERLAY (removed — tap bar opens Spotify app) ===== -->
    <div id="spotify-full-player" style="display:none;"><!-- removed -->
    </div>

    <script>
    // ===== SPOTIFY NOW PLAYING LOGIC =====
    (function() {
        let _pollInterval  = null;
        let _lastTrackId   = null;
        let _progressTimer = null;
        let _progressMs    = 0;
        let _durationMs    = 1;

        function formatTime(ms) {
            const s   = Math.floor(ms / 1000);
            const min = Math.floor(s / 60);
            const sec = s % 60;
            return `${min}:${sec.toString().padStart(2, '0')}`;
        }

        function setProgressBars(currentMs, totalMs) {
            const pct  = Math.min((currentMs / totalMs) * 100, 100);
            const bar  = document.getElementById('snp-progress');
            if (bar) bar.style.width = pct + '%';
        }

        function updateWorkoutSpotifyBar(data) {
            const bar = document.getElementById('workout-spotify-bar');
            if (!bar) return;
            const workoutView = document.getElementById('view-active-workout');
            const isWorkoutActive = workoutView && workoutView.style.display !== 'none';

            if (!isWorkoutActive || !data || !data.playing || !data.track) {
                bar.style.display = 'none';
                return;
            }

            const { track } = data;
            bar.style.display = 'block';

            const wsTrack = document.getElementById('ws-track');
            const wsArtist = document.getElementById('ws-artist');
            if (wsTrack) wsTrack.textContent = track.name;
            if (wsArtist) wsArtist.textContent = track.artist;

            const wsImg = document.getElementById('ws-art');
            const wsPlaceholder = document.getElementById('ws-art-placeholder');
            if (track.album_art) {
                if (wsImg) { wsImg.src = track.album_art; wsImg.style.display = 'block'; }
                if (wsPlaceholder) wsPlaceholder.style.display = 'none';
            } else {
                if (wsImg) wsImg.style.display = 'none';
                if (wsPlaceholder) wsPlaceholder.style.display = 'flex';
            }

            const wsPlay = document.getElementById('ws-play-icon');
            const wsPause = document.getElementById('ws-pause-icon');
            if (wsPlay) wsPlay.style.display = data.playing ? 'none' : 'block';
            if (wsPause) wsPause.style.display = data.playing ? 'block' : 'none';
        }

        // Check if any calorie tracker / meal flow modal is active
        // Exposed globally so other script blocks can use it
        window.isMealFlowActive = function() {
            const camModal = document.getElementById('unified-camera-modal');
            if (camModal && camModal.style.display !== 'none' && camModal.style.display !== '') return true;
            const previewModal = document.getElementById('meal-preview-modal');
            if (previewModal && previewModal.style.display !== 'none' && previewModal.style.display !== '') return true;
            const inputModal = document.getElementById('meal-input-modal');
            if (inputModal && inputModal.classList.contains('visible')) return true;
            return false;
        };
        var isMealFlowActive = window.isMealFlowActive;

        function updatePlayerUI(data) {
            const widget = document.getElementById('spotify-now-playing');
            if (!widget) return;

            // Also update workout Spotify bar
            updateWorkoutSpotifyBar(data);

            if (!data || !data.playing || !data.track) {
                widget.style.display = 'none';
                clearInterval(_progressTimer);
                window._snpPlaying = false;
                return;
            }

            const { track } = data;
            window._snpPlaying      = data.playing;
            window._snpTrackUrl     = track.spotify_url || null;
            window._snpCurrentTrack = track;

            // Show mini widget (but not while any calorie tracker modal is open)
            if (isMealFlowActive()) {
                widget.style.display = 'none';
            } else {
                widget.style.display = 'block';
            }

            // Mini player: track name & artist
            const miniTrack  = document.getElementById('snp-track');
            const miniArtist = document.getElementById('snp-artist');
            if (miniTrack)  miniTrack.textContent  = track.name;
            if (miniArtist) miniArtist.textContent = track.artist;

            // Mini player: album art
            const img         = document.getElementById('snp-art');
            const placeholder = document.getElementById('snp-art-placeholder');
            if (track.album_art) {
                if (img) { img.src = track.album_art; img.style.display = 'block'; }
                if (placeholder) placeholder.style.display = 'none';
            } else {
                if (img) img.style.display = 'none';
                if (placeholder) placeholder.style.display = 'flex';
            }

            // Mini play/pause icons
            const mpp  = document.getElementById('snp-play-icon');
            const mppi = document.getElementById('snp-pause-icon');
            if (mpp)  mpp.style.display  = data.playing ? 'none' : 'block';
            if (mppi) mppi.style.display = data.playing ? 'block' : 'none';

            // Progress tracking — reset only when track changes
            if (track.id !== _lastTrackId) {
                _lastTrackId = track.id;
                clearInterval(_progressTimer);
                _progressMs  = track.progress_ms || 0;
                _durationMs  = track.duration_ms || 1;
                setProgressBars(_progressMs, _durationMs);

                if (data.playing) {
                    _progressTimer = setInterval(() => {
                        _progressMs += 1000;
                        if (_progressMs >= _durationMs) clearInterval(_progressTimer);
                        setProgressBars(_progressMs, _durationMs);
                    }, 1000);
                }
            }
        }

        async function pollNowPlaying() {
            if (!window.currentUser) return;
            try {
                const res  = await fetch(`/api/spotify/now-playing?user_id=${window.currentUser.id}`);
                if (!res.ok) return;
                const data = await res.json();
                if (!data.connected) return;
                updatePlayerUI(data);
            } catch (_) { /* silent fail */ }
        }

        function startNowPlayingPolling() {
            if (_pollInterval) return;
            pollNowPlaying();
            _pollInterval = setInterval(pollNowPlaying, 15000);
        }

        function tryStart() {
            if (window.currentUser) startNowPlayingPolling();
            else setTimeout(tryStart, 1000);
        }
        tryStart();

        // ── Open in Spotify (native app URI → web fallback) ─────────────────

        window.openInSpotify = function() {
            const track = window._snpCurrentTrack;
            const webUrl = window._snpTrackUrl || 'https://open.spotify.com';
            if (track && track.spotify_uri) {
                window.location.href = track.spotify_uri;
                setTimeout(() => { window.open(webUrl, '_blank'); }, 1500);
            } else {
                window.open(webUrl, '_blank');
            }
        };

        window.spotifyPlayerControl = async function(action, uri) {
            if (!window.currentUser) return;
            try {
                const body = { user_id: window.currentUser.id, action };
                if (uri) body.uri = uri;

                const res = await fetch('/api/spotify/player', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (res.status === 403) {
                    alert('Playback controls require Spotify Premium.');
                    return;
                }
                setTimeout(pollNowPlaying, 600);
            } catch (err) {
                console.warn('Spotify player control error:', err);
            }
        };

        // ── Track bottom-nav visibility so mini player repositions itself ──────
        function syncMiniPlayerBottom() {
            const player = document.getElementById('spotify-now-playing');
            if (!player) return;
            const nav = document.querySelector('.bottom-nav');
            const navHidden = !nav || nav.style.display === 'none';
            player.style.bottom = navHidden ? '16px' : '72px';
        }
        const _navEl = document.querySelector('.bottom-nav');
        if (_navEl) {
            new MutationObserver(syncMiniPlayerBottom)
                .observe(_navEl, { attributes: true, attributeFilter: ['style'] });
        }
    })();

    // Global function to sync workout Spotify bar on demand (called when workout view opens/closes)
    window.syncWorkoutSpotifyBar = function() {
        const bar = document.getElementById('workout-spotify-bar');
        if (!bar) return;
        const workoutView = document.getElementById('view-active-workout');
        const isWorkoutActive = workoutView && workoutView.style.display !== 'none';

        if (!isWorkoutActive || !window._snpPlaying || !window._snpCurrentTrack) {
            bar.style.display = 'none';
            return;
        }

        const track = window._snpCurrentTrack;
        bar.style.display = 'block';

        const wsTrack = document.getElementById('ws-track');
        const wsArtist = document.getElementById('ws-artist');
        if (wsTrack) wsTrack.textContent = track.name;
        if (wsArtist) wsArtist.textContent = track.artist;

        const wsImg = document.getElementById('ws-art');
        const wsPlaceholder = document.getElementById('ws-art-placeholder');
        if (track.album_art) {
            if (wsImg) { wsImg.src = track.album_art; wsImg.style.display = 'block'; }
            if (wsPlaceholder) wsPlaceholder.style.display = 'none';
        } else {
            if (wsImg) wsImg.style.display = 'none';
            if (wsPlaceholder) wsPlaceholder.style.display = 'flex';
        }

        const wsPlay = document.getElementById('ws-play-icon');
        const wsPause = document.getElementById('ws-pause-icon');
        if (wsPlay) wsPlay.style.display = window._snpPlaying ? 'none' : 'block';
        if (wsPause) wsPause.style.display = window._snpPlaying ? 'block' : 'none';
    };
    </script>

    <script>
    // ===== WEATHER BACKGROUND DATA COLLECTION =====
    // Fetches today's weather via Open-Meteo (no API key) and stores in weather_logs for analytics.
    // No UI card — data is used for correlating mood, sleep, workouts, and energy with weather.
    (function() {
        const WMO_LABELS = {
            0:'Clear sky', 1:'Mainly clear', 2:'Partly cloudy', 3:'Overcast',
            45:'Fog', 48:'Icy fog', 51:'Light drizzle', 53:'Drizzle', 55:'Heavy drizzle',
            61:'Light rain', 63:'Rain', 65:'Heavy rain', 71:'Light snow', 73:'Snow',
            75:'Heavy snow', 77:'Snow grains', 80:'Light showers', 81:'Showers',
            82:'Heavy showers', 85:'Snow showers', 86:'Heavy snow showers',
            95:'Thunderstorm', 96:'Thunderstorm+hail', 99:'Thunderstorm+heavy hail',
        };

        async function fetchAndStoreWeather() {
            if (!window.currentUser) return;
            if (sessionStorage.getItem('weather_fetched')) return;
            if (!navigator.geolocation) return;

            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const { latitude: lat, longitude: lon } = pos.coords;
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
                        `&current=temperature_2m,apparent_temperature,weather_code,is_day,` +
                        `relative_humidity_2m,precipitation,wind_speed_10m,uv_index` +
                        `&timezone=auto&forecast_days=1`;

                    const res  = await fetch(url);
                    if (!res.ok) return;
                    const data = await res.json();
                    const c    = data.current;
                    const tz   = data.timezone || null;
                    const today = getLocalDateString();
                    const code  = c.weather_code ?? null;

                    const row = {
                        user_id:          window.currentUser.id,
                        log_date:         today,
                        temp_c:           c.temperature_2m           ?? null,
                        feels_like_c:     c.apparent_temperature      ?? null,
                        weather_code:     code,
                        condition:        WMO_LABELS[code] || null,
                        is_day:           c.is_day === 1,
                        humidity_pct:     Math.round(c.relative_humidity_2m) || null,
                        precipitation_mm: c.precipitation             ?? null,
                        wind_speed_kmh:   c.wind_speed_10m            ?? null,
                        uv_index:         c.uv_index                  ?? null,
                        latitude:         parseFloat(lat.toFixed(6)),
                        longitude:        parseFloat(lon.toFixed(6)),
                        timezone:         tz,
                        fetched_at:       new Date().toISOString(),
                    };

                    sessionStorage.setItem('weather_fetched', '1');
                    await supabaseClient.from('weather_logs').upsert(row, { onConflict: 'user_id,log_date' });
                } catch (err) {
                    console.warn('Weather fetch error:', err);
                }
            }, () => {}, { timeout: 8000, maximumAge: 3600000 });
        }

        // Allow permissions modal to re-trigger weather fetch after location is granted
        window.requestWeatherLocation = function() {
            sessionStorage.removeItem('weather_fetched');
            fetchAndStoreWeather();
        };

        // Delay to allow currentUser to be set after auth.
        // On native apps with first-time permissions pending, skip the automatic
        // weather fetch — it would trigger a standalone OS location dialog that
        // races with the grouped permissions modal. The modal's close handler
        // calls requestWeatherLocation() after the user grants location there.
        setTimeout(function() {
            if (typeof isNativeApp === 'function' && isNativeApp() &&
                !localStorage.getItem('native_permissions_requested')) {
                return;
            }
            fetchAndStoreWeather();
        }, 3000);
    })();
    </script>

    <script>
    // ===== SHARED WEARABLE HELPERS =====

    function formatTimeAgo(dateStr) {
        const syncDate = new Date(dateStr);
        const now = new Date();
        const diffMins = Math.floor((now - syncDate) / 60000);
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return diffMins + 'm ago';
        if (diffMins < 1440) return Math.floor(diffMins / 60) + 'h ago';
        return Math.floor(diffMins / 1440) + 'd ago';
    }

    function showWearableToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:14px 24px; border-radius:12px; font-weight:600; z-index:99999; box-shadow:0 4px 12px rgba(0,0,0,0.15); font-size:0.9rem;';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Initialize all wearable dashboards on page load
    function initAllWearableDashboards() {
        if (typeof initWhoopDashboard === 'function') initWhoopDashboard();
        if (typeof initOuraDashboard === 'function') initOuraDashboard();
        if (typeof initStravaDashboard === 'function') initStravaDashboard();
        if (typeof initSpotifyDashboard === 'function') initSpotifyDashboard();
    }

    // Call after user is loaded (piggyback on Fitbit init timing)
    if (window.currentUser) {
        initAllWearableDashboards();
    } else {
        // Wait for user to be set, then init
        const _origInitFitbit = window.initFitbitDashboard;
        window.initFitbitDashboard = function() {
            if (_origInitFitbit) _origInitFitbit();
            initAllWearableDashboards();
        };
    }
    </script>

    <script>
    // ===== YOUR PERFORMANCE CARD LOGIC =====

    /**
     * Opens the progress view from the home page performance card
     */
    function openProgressFromHome() {
        window._progressViewOrigin = 'home';
        // Use hideAllAppViews if available, otherwise manual hide
        if (typeof hideAllAppViews === 'function') {
            hideAllAppViews();
        }

        const viewEl = document.getElementById('view-progress');
        if (viewEl) {
            viewEl.style.display = 'block';
            viewEl.scrollTop = 0;
            window.scrollTo(0, 0);
        }

        // Hide bottom nav for full-screen progress view
        const bottomNav = document.querySelector('.bottom-nav');
        if (bottomNav) {
            bottomNav.style.display = 'none';
        }

        // Initialize progress data
        if (typeof initProgressView === 'function') {
            initProgressView();
        }

        // Push navigation state for back button support
        if (typeof pushNavigationState === 'function') {
            pushNavigationState('view-progress', () => closeProgressFromHome());
        }
    }

    function closeProgressFromHome() {
        const viewEl = document.getElementById('view-progress');
        if (viewEl) {
            viewEl.style.display = 'none';
        }
        switchAppTab('dashboard');
    }

    /**
     * Load performance card data (workouts this week, body weight, sleep)
     */
    async function initPerformanceCard() {
        if (!window.currentUser) return;

        const userId = window.currentUser.id;

        // --- Workouts this week ---
        try {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0=Sun, 1=Mon...
            const mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            const monday = new Date(now);
            monday.setDate(now.getDate() - mondayOffset);
            const mondayStr = getLocalDateString(monday);

            const { data: weekWorkouts, error } = await supabaseClient
                .from('workouts')
                .select('workout_date')
                .eq('user_id', userId)
                .eq('workout_type', 'history')
                .gte('workout_date', mondayStr);

            if (!error && weekWorkouts) {
                const uniqueDates = new Set(weekWorkouts.map(w => w.workout_date));
                const count = uniqueDates.size;
                const el = document.getElementById('perf-workouts-value');
                if (el) el.textContent = count;
            }
        } catch (e) {
            console.warn('Performance card - workouts error:', e);
        }

        // --- Body Weight ---
        try {
            const recentWeighIns = await db.weighIns.getRecent(userId, 7);

            if (recentWeighIns && recentWeighIns.length > 0) {
                const latest = recentWeighIns[0];
                const preferLbs = localStorage.getItem('weightUnitPreference') === 'lbs';
                let displayWeight;
                let unit;

                if (preferLbs) {
                    displayWeight = (latest.weight_kg * 2.20462).toFixed(0);
                    unit = 'lbs';
                } else {
                    displayWeight = parseFloat(latest.weight_kg).toFixed(1);
                    unit = 'kg';
                }

                const weightEl = document.getElementById('perf-weight-value');
                if (weightEl) weightEl.textContent = displayWeight;

                const subEl = document.getElementById('perf-weight-sub');
                if (subEl) {
                    if (recentWeighIns.length >= 2) {
                        const prev = recentWeighIns[1];
                        const diff = preferLbs
                            ? ((latest.weight_kg - prev.weight_kg) * 2.20462).toFixed(1)
                            : (latest.weight_kg - prev.weight_kg).toFixed(1);
                        const sign = diff > 0 ? '+' : '';
                        subEl.textContent = sign + diff + ' ' + unit;
                        subEl.style.color = diff < 0 ? '#10b981' : diff > 0 ? '#ef4444' : '#8b5cf6';
                    } else {
                        subEl.textContent = unit;
                    }
                }
            }
        } catch (e) {
            console.warn('Performance card - weight error:', e);
        }

        // --- Sleep (from wearable data if available) ---
        try {
            // Check each wearable source for sleep data
            let sleepFound = false;

            // Try Fitbit
            if (!sleepFound) {
                try {
                    const resp = await fetch('/api/fitbit/data?user_id=' + userId);
                    const data = await resp.json();
                    if (data.connected && data.sleep && data.sleep[0]) {
                        const mins = data.sleep[0].duration_minutes || 0;
                        const hours = Math.floor(mins / 60);
                        const m = mins % 60;
                        const sleepEl = document.getElementById('perf-sleep-value');
                        if (sleepEl) sleepEl.innerHTML = hours + '<span style="font-size:0.8rem;font-weight:600;">h</span> ' + m + '<span style="font-size:0.8rem;font-weight:600;">m</span>';
                        sleepFound = true;
                    }
                } catch (e) { /* not connected */ }
            }

            // Try WHOOP
            if (!sleepFound) {
                try {
                    const resp = await fetch('/api/whoop/data?user_id=' + userId);
                    const data = await resp.json();
                    if (data.connected && data.sleep && data.sleep[0]) {
                        const mins = data.sleep[0].duration_minutes || 0;
                        const hours = Math.floor(mins / 60);
                        const m = mins % 60;
                        const sleepEl = document.getElementById('perf-sleep-value');
                        if (sleepEl) sleepEl.innerHTML = hours + '<span style="font-size:0.8rem;font-weight:600;">h</span> ' + m + '<span style="font-size:0.8rem;font-weight:600;">m</span>';
                        sleepFound = true;
                    }
                } catch (e) { /* not connected */ }
            }

            // Try Oura
            if (!sleepFound) {
                try {
                    const resp = await fetch('/api/oura/data?user_id=' + userId);
                    const data = await resp.json();
                    if (data.connected && data.sleep && data.sleep[0]) {
                        const mins = data.sleep[0].total_sleep_minutes || 0;
                        const hours = Math.floor(mins / 60);
                        const m = mins % 60;
                        const sleepEl = document.getElementById('perf-sleep-value');
                        if (sleepEl) sleepEl.innerHTML = hours + '<span style="font-size:0.8rem;font-weight:600;">h</span> ' + m + '<span style="font-size:0.8rem;font-weight:600;">m</span>';
                        sleepFound = true;
                    }
                } catch (e) { /* not connected */ }
            }

            if (!sleepFound) {
                const subEl = document.getElementById('perf-sleep-sub');
                if (subEl) subEl.textContent = 'connect device';
            }
        } catch (e) {
            console.warn('Performance card - sleep error:', e);
        }

        // --- Body Fat % from latest weigh-in ---
        try {
            const latest = await db.weighIns.getLatest(userId);
            if (latest && latest.body_fat_pct) {
                const bfEl = document.getElementById('perf-bf-sub');
                if (bfEl) {
                    bfEl.textContent = latest.body_fat_pct.toFixed(1) + '% BF';
                    bfEl.style.display = 'block';
                }
            }
        } catch (e) {
            console.warn('Performance card - body fat error:', e);
        }

        // --- Fitbit performance card (dedicated card above Your Progress) ---
        try {
            const connectedEl  = document.getElementById('fitbit-perf-connected');
            const disconnectedEl = document.getElementById('fitbit-perf-disconnected');

            // Always show the disconnected prompt first so the card is never invisible
            if (disconnectedEl) disconnectedEl.style.display = 'flex';

            const resp = await fetch('/api/fitbit/data?user_id=' + userId);
            if (resp.ok) {
                const data = await resp.json();
                if (data.connected) {
                    const activity = data.activity && data.activity[0];
                    const hr = data.heart_rate && data.heart_rate[0];

                    // Switch to connected view
                    if (disconnectedEl) disconnectedEl.style.display = 'none';
                    if (connectedEl) connectedEl.style.display = 'block';

                    const stepsEl = document.getElementById('fitbit-perf-steps');
                    if (stepsEl && activity && activity.steps != null) {
                        stepsEl.textContent = (activity.steps || 0).toLocaleString();
                    }

                    const calsEl = document.getElementById('fitbit-perf-cals');
                    if (calsEl && activity && activity.calories_burned) {
                        calsEl.textContent = Math.round(activity.calories_burned).toLocaleString();
                    }

                    const hrEl = document.getElementById('fitbit-perf-hr');
                    if (hrEl && hr && hr.resting_heart_rate) {
                        hrEl.textContent = hr.resting_heart_rate + ' bpm';
                    }

                    const activeEl = document.getElementById('fitbit-perf-active');
                    if (activeEl && activity && activity.active_minutes != null) {
                        activeEl.textContent = activity.active_minutes + ' min';
                    }

                    const syncLabel = document.getElementById('fitbit-perf-sync-label');
                    if (syncLabel && data.last_sync) {
                        const mins = Math.round((Date.now() - new Date(data.last_sync)) / 60000);
                        syncLabel.textContent = mins < 60 ? mins + 'm ago' : Math.round(mins/60) + 'h ago';
                    }
                }
            }
        } catch (e) {
            // On error still show disconnected prompt so card is visible
            const disconnectedEl = document.getElementById('fitbit-perf-disconnected');
            if (disconnectedEl) disconnectedEl.style.display = 'flex';
            console.warn('Performance card - Fitbit error:', e);
        }
    }

    window.initPerformanceCard = initPerformanceCard;
    window.openProgressFromHome = openProgressFromHome;
    window.closeProgressFromHome = closeProgressFromHome;
    </script>

    <script src="js/dashboard/dashboard-script-2-activity_insights_view.js"></script>


    <script>
    // ===== DAILY QUIZ CARD LOGIC =====

    /**
     * Check if user has completed their daily quiz and show/hide card accordingly.
     * Uses learning system state exposed via window functions.
     */
    async function checkAndShowDailyQuizCard() {
        if (!window.currentUser) return;

        // Don't show if onboarding wizard is active
        if (window._onboardingWizardPending) return;
        const wizard = document.getElementById('onboarding-wizard');
        if (wizard && wizard.style.display !== 'none') return;

        const card = document.getElementById('daily-quiz-card');
        const doneCard = document.getElementById('daily-quiz-done-card');
        if (!card || !doneCard) return;

        try {
            // Ensure learning progress is loaded before checking
            if (typeof window._ensureLearningProgressLoaded === 'function') {
                await window._ensureLearningProgressLoaded();
            }

            // Check if daily quiz already completed today (uses learning-inline.js exposed fn)
            if (typeof window._isDailyQuizCompletedToday === 'function' && window._isDailyQuizCompletedToday()) {
                card.style.display = 'none';
                var d = new Date();
                var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                doneCard.style.display = localStorage.getItem('quizDoneCardDismissedDate') === today ? 'none' : 'flex';
                return;
            }

            // Find a random available lesson from any category (uses learning-inline.js exposed fn)
            if (typeof window._getRandomAvailableLesson !== 'function') {
                card.style.display = 'none';
                doneCard.style.display = 'none';
                return;
            }

            // Check if we already picked a daily quiz lesson for today
            var d2 = new Date();
            var todayStr = d2.getFullYear() + '-' + String(d2.getMonth()+1).padStart(2,'0') + '-' + String(d2.getDate()).padStart(2,'0');
            var savedQuizLesson = null;
            try {
                var saved = JSON.parse(localStorage.getItem('dailyQuizLessonToday') || 'null');
                if (saved && saved.date === todayStr && saved.lessonId) {
                    // Use the saved lesson if it hasn't been completed yet
                    if (typeof window._getLessonById === 'function') {
                        var savedLesson = window._getLessonById(saved.lessonId);
                        if (savedLesson) {
                            savedQuizLesson = savedLesson;
                        }
                    }
                }
            } catch (e) { /* ignore parse errors */ }

            var lesson, unit, module;
            if (savedQuizLesson) {
                // Check if the saved lesson was already completed (e.g., via regular learning path)
                if (typeof window._isLessonCompleted === 'function' && window._isLessonCompleted(savedQuizLesson.lesson.id)) {
                    // Lesson was completed outside daily quiz flow — treat daily quiz as done
                    card.style.display = 'none';
                    doneCard.style.display = 'none';
                    return;
                }
                lesson = savedQuizLesson.lesson;
                unit = savedQuizLesson.unit;
                module = savedQuizLesson.module;
            } else {
                const nextLesson = window._getRandomAvailableLesson();
                if (!nextLesson) {
                    // All lessons completed
                    card.style.display = 'none';
                    doneCard.style.display = 'none';
                    return;
                }
                lesson = nextLesson.lesson;
                unit = nextLesson.unit;
                module = nextLesson.module;
                // Save today's daily quiz lesson so it stays consistent
                localStorage.setItem('dailyQuizLessonToday', JSON.stringify({ date: todayStr, lessonId: lesson.id }));
            }

            const moduleEmojis = { body: '💪', fuel: '🥗', mind: '🧠', longevity: '⏳', workouts: '🏋️', hormones: '🧪' };

            // Populate card content
            document.getElementById('daily-quiz-icon').textContent = moduleEmojis[module.id] || '📚';
            document.getElementById('daily-quiz-lesson-title').textContent = lesson.title;
            document.getElementById('daily-quiz-lesson-context').textContent = module.title + ' \u2022 ' + unit.title;

            card.onclick = function() {
                // Switch to learning tab and start the daily quiz
                if (typeof switchAppTab === 'function') {
                    const learningNav = document.querySelectorAll('.nav-item')[3];
                    switchAppTab('learning', learningNav);
                    // Wait for learning to init, then start the daily quiz
                    // Use polling instead of fixed timeout to handle slow DB calls
                    var attempts = 0;
                    var waitForInit = setInterval(function() {
                        attempts++;
                        if (typeof window.startDailyQuiz === 'function' && !window._learningInitInProgress) {
                            clearInterval(waitForInit);
                            window.startDailyQuiz(lesson.id);
                        } else if (attempts > 20) { // 4 second max wait
                            clearInterval(waitForInit);
                            if (typeof window.startDailyQuiz === 'function') {
                                window.startDailyQuiz(lesson.id);
                            }
                        }
                    }, 200);
                }
            };

            card.style.display = 'block';
            doneCard.style.display = 'none';

        } catch (error) {
            console.error('Error checking daily quiz status:', error);
        }
    }

    window.checkAndShowDailyQuizCard = checkAndShowDailyQuizCard;

    function dismissQuizDoneCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('quizDoneCardDismissedDate', today);
        document.getElementById('daily-quiz-done-card').style.display = 'none';
    }
    window.dismissQuizDoneCard = dismissQuizDoneCard;

    /**
     * Called after daily quiz is completed to update dashboard card
     */
    window.refreshDailyQuizCard = function() {
        const card = document.getElementById('daily-quiz-card');
        const doneCard = document.getElementById('daily-quiz-done-card');
        if (card) {
            card.style.transition = 'opacity 0.5s, transform 0.5s';
            card.style.opacity = '0';
            card.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                card.style.display = 'none';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
                if (doneCard) doneCard.style.display = 'flex';
            }, 500);
        }
    };
    </script>

    <script>
    // ===== WEEKLY PROGRESS PHOTO CARD LOGIC =====

    /**
     * Check if it's Monday and user hasn't uploaded a progress photo this week.
     * Shows the card only on Mondays (or any day the user hasn't done it that week).
     */
    async function checkAndShowProgressPhotoCard() {
        if (!window.currentUser) return;
        if (window._onboardingWizardPending) return;
        const wizard = document.getElementById('onboarding-wizard');
        if (wizard && wizard.style.display !== 'none') return;

        const card = document.getElementById('weekly-progress-photo-card');
        const doneCard = document.getElementById('weekly-progress-photo-done-card');
        const uploadingCard = document.getElementById('weekly-progress-photo-uploading');
        if (!card || !doneCard) return;

        try {
            // Only show on Mondays (day 1)
            const today = new Date();
            if (today.getDay() !== 1) {
                card.style.display = 'none';
                doneCard.style.display = 'none';
                if (uploadingCard) uploadingCard.style.display = 'none';
                return;
            }

            // Check if user already uploaded this week
            const thisWeeksPhoto = await db.progressPhotos.getThisWeeksPhoto(window.currentUser.id);

            if (thisWeeksPhoto) {
                // Already done this week
                card.style.display = 'none';
                if (uploadingCard) uploadingCard.style.display = 'none';
                var d = new Date();
                var todayStr = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                doneCard.style.display = localStorage.getItem('progressPhotoDoneCardDismissedDate') === todayStr ? 'none' : 'flex';
            } else {
                // Show the upload card
                card.style.display = 'block';
                doneCard.style.display = 'none';
                if (uploadingCard) uploadingCard.style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking progress photo status:', error);
        }
    }

    /**
     * Handle progress photo file selection and upload
     */
    async function handleProgressPhotoSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const card = document.getElementById('weekly-progress-photo-card');
        const uploadingCard = document.getElementById('weekly-progress-photo-uploading');
        const doneCard = document.getElementById('weekly-progress-photo-done-card');

        try {
            // Show uploading state
            if (card) card.style.display = 'none';
            if (uploadingCard) uploadingCard.style.display = 'block';

            const userId = window.currentUser?.id;

            if (!userId) {
                throw new Error('User not authenticated');
            }

            // Upload photo to B2
            const formData = new FormData();
            formData.append('file', file);
            formData.append('userId', userId);

            const uploadResponse = await fetch('/api/upload-progress-photo', {
                method: 'POST',
                body: formData
            });

            if (!uploadResponse.ok) {
                const errorData = await uploadResponse.json();
                throw new Error(errorData.error || 'Failed to upload photo');
            }

            const uploadData = await uploadResponse.json();

            // Save to database
            await db.progressPhotos.save(userId, uploadData.url, uploadData.fileName);

            // Award 15 XP (add to lifetime_points for leveling)
            try {
                const { data: currentPoints } = await supabaseClient
                    .from('user_points')
                    .select('lifetime_points')
                    .eq('user_id', userId)
                    .maybeSingle();

                if (currentPoints) {
                    await supabaseClient
                        .from('user_points')
                        .update({ lifetime_points: (currentPoints.lifetime_points || 0) + 15 })
                        .eq('user_id', userId);
                } else {
                    await supabaseClient
                        .from('user_points')
                        .insert({ user_id: userId, lifetime_points: 15, current_points: 0 });
                }

                if (typeof triggerXPBarRainbow === 'function') triggerXPBarRainbow();
                if (typeof refreshLevelDisplay === 'function') refreshLevelDisplay();
            } catch (xpError) {
                console.log('XP award skipped:', xpError);
            }

            // Show success - transition to done card
            if (uploadingCard) uploadingCard.style.display = 'none';
            if (doneCard) doneCard.style.display = 'flex';

            // Refresh points display if visible
            if (typeof refreshPointsDisplay === 'function') {
                refreshPointsDisplay();
            }

            console.log('Progress photo uploaded successfully!');

        } catch (error) {
            console.error('Error uploading progress photo:', error);
            if (uploadingCard) uploadingCard.style.display = 'none';
            if (card) card.style.display = 'block';
            alert('Failed to upload progress photo. Please try again.');
        }

        // Reset file input so same file can be re-selected
        event.target.value = '';
    }

    function dismissProgressPhotoDoneCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('progressPhotoDoneCardDismissedDate', today);
        document.getElementById('weekly-progress-photo-done-card').style.display = 'none';
    }

    // Set up event listeners
    (function() {
        // Card click opens getUserMedia camera instead of file input (which opens gallery in Capacitor WebView)
        var photoCard = document.getElementById('weekly-progress-photo-card');
        var photoInput = document.getElementById('progress-photo-input');
        if (photoCard) {
            photoCard.onclick = function() {
                openWorkoutCamera(function(file) {
                    handleProgressPhotoCaptureFromFile(file);
                }, 'Take your progress photo');
            };
        }
        // Keep file input handler as legacy fallback
        if (photoInput) {
            photoInput.onchange = handleProgressPhotoSelect;
        }
    })();

    // Handle progress photo from a File object (from getUserMedia camera modal)
    async function handleProgressPhotoCaptureFromFile(file) {
        if (!file) return;

        var card = document.getElementById('weekly-progress-photo-card');
        var uploadingCard = document.getElementById('weekly-progress-photo-uploading');
        var doneCard = document.getElementById('weekly-progress-photo-done-card');

        try {
            if (card) card.style.display = 'none';
            if (uploadingCard) uploadingCard.style.display = 'block';

            var userId = window.currentUser?.id;
            if (!userId) throw new Error('User not authenticated');

            var formData = new FormData();
            formData.append('file', file);
            formData.append('userId', userId);

            var uploadResponse = await fetch('/api/upload-progress-photo', {
                method: 'POST',
                body: formData
            });

            if (!uploadResponse.ok) {
                var errorData = await uploadResponse.json();
                throw new Error(errorData.error || 'Failed to upload photo');
            }

            var uploadData = await uploadResponse.json();
            await db.progressPhotos.save(userId, uploadData.url, uploadData.fileName);

            try {
                var { data: currentPoints } = await supabaseClient
                    .from('user_points')
                    .select('lifetime_points')
                    .eq('user_id', userId)
                    .maybeSingle();

                if (currentPoints) {
                    await supabaseClient
                        .from('user_points')
                        .update({ lifetime_points: (currentPoints.lifetime_points || 0) + 15 })
                        .eq('user_id', userId);
                } else {
                    await supabaseClient
                        .from('user_points')
                        .insert({ user_id: userId, lifetime_points: 15, current_points: 0 });
                }

                if (typeof triggerXPBarRainbow === 'function') triggerXPBarRainbow();
                if (typeof refreshLevelDisplay === 'function') refreshLevelDisplay();
            } catch (xpError) {
                console.log('XP award skipped:', xpError);
            }

            if (uploadingCard) uploadingCard.style.display = 'none';
            if (doneCard) doneCard.style.display = 'flex';

            if (typeof refreshPointsDisplay === 'function') refreshPointsDisplay();
            console.log('Progress photo uploaded successfully!');

        } catch (error) {
            console.error('Error uploading progress photo:', error);
            if (uploadingCard) uploadingCard.style.display = 'none';
            if (card) card.style.display = 'block';
            alert('Failed to upload progress photo. Please try again.');
        }
    }
    window.handleProgressPhotoCaptureFromFile = handleProgressPhotoCaptureFromFile;

    // Make functions globally available
    window.dismissProgressPhotoDoneCard = dismissProgressPhotoDoneCard;
    window.checkAndShowProgressPhotoCard = checkAndShowProgressPhotoCard;
    </script>

    <script>
    // ===== DAILY MEAL TIP CARD LOGIC =====

    /**
     * Check and show the daily meal tip card with the most recent meal pattern insight.
     * Shows one insight per day, dismissible. Reappears next day with a new insight.
     */
    async function checkAndShowMealTipCard() {
        if (!window.currentUser) return;
        if (window._onboardingWizardPending) return;
        const wizard = document.getElementById('onboarding-wizard');
        if (wizard && wizard.style.display !== 'none') return;

        const card = document.getElementById('daily-meal-tip-card');
        if (!card) return;

        // Check if dismissed today
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        if (localStorage.getItem('mealTipCardDismissedDate') === today) {
            card.style.display = 'none';
            return;
        }

        try {
            const session = await window.authHelpers?.getSession();
            if (!session?.user) { card.style.display = 'none'; return; }

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);

            const { data: meals, error } = await window.supabaseClient
                .from('meal_logs')
                .select('meal_date, meal_time, meal_type, calories, protein_g, carbs_g, fat_g, fiber_g, micronutrients')
                .eq('user_id', window.currentUser.id)
                .gte('meal_date', getLocalDateString(sevenDaysAgo))
                .order('meal_date', { ascending: true });

            if (error || !meals || meals.length < 3) {
                card.style.display = 'none';
                return;
            }

            // Reuse the existing analyzeMealPatterns function
            var insights = [];
            if (typeof analyzeMealPatterns === 'function') {
                insights = analyzeMealPatterns(meals);
            }

            if (!insights || insights.length === 0) {
                card.style.display = 'none';
                return;
            }

            // Pick one insight for today (rotate by day-of-year so it changes daily)
            var dayOfYear = Math.floor((d - new Date(d.getFullYear(), 0, 0)) / 86400000);
            var insightIndex = dayOfYear % insights.length;
            var tip = insights[insightIndex];

            // Strip HTML tags for the card (keep it clean)
            var tipText = tip.text.replace(/<strong>/g, '').replace(/<\/strong>/g, '');
            document.getElementById('daily-meal-tip-text').textContent = tipText;

            card.style.display = 'block';
        } catch (err) {
            console.error('Error in checkAndShowMealTipCard:', err);
            card.style.display = 'none';
        }
    }

    function dismissMealTipCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('mealTipCardDismissedDate', today);
        var card = document.getElementById('daily-meal-tip-card');
        if (card) {
            card.style.transition = 'opacity 0.4s, transform 0.4s';
            card.style.opacity = '0';
            card.style.transform = 'translateY(-15px)';
            setTimeout(function() { card.style.display = 'none'; card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }, 400);
        }
    }

    window.checkAndShowMealTipCard = checkAndShowMealTipCard;
    window.dismissMealTipCard = dismissMealTipCard;
    </script>

    <script>
    // ===== DAILY WORKOUT TREND CARD LOGIC =====

    /**
     * Check and show the daily workout trend card on the home screen.
     * Analyzes recent workout history and shows a summary insight.
     */
    async function checkAndShowWorkoutTrendCard() {
        if (!window.currentUser) return;
        if (window._onboardingWizardPending) return;
        const wizard = document.getElementById('onboarding-wizard');
        if (wizard && wizard.style.display !== 'none') return;

        const card = document.getElementById('daily-workout-trend-card');
        if (!card) return;

        // Check if dismissed today
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        if (localStorage.getItem('workoutTrendCardDismissedDate') === today) {
            card.style.display = 'none';
            return;
        }

        try {
            var workoutData = await _getWorkoutTrendData();
            if (!workoutData) {
                card.style.display = 'none';
                return;
            }

            var textEl = document.getElementById('daily-workout-trend-text');
            if (textEl) textEl.textContent = workoutData.insight;
            card.style.display = 'block';
        } catch (err) {
            console.error('Error in checkAndShowWorkoutTrendCard:', err);
            card.style.display = 'none';
        }
    }

    /**
     * Load and show workout trend in the Movement tab card.
     */
    async function loadMovementTrendCard() {
        var card = document.getElementById('movement-workout-trend-card');
        if (!card) return;

        // Check if dismissed today
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        if (localStorage.getItem('movementTrendCardDismissedDate') === today) {
            card.style.display = 'none';
            return;
        }

        try {
            var workoutData = await _getWorkoutTrendData();
            if (!workoutData) {
                card.style.display = 'none';
                return;
            }

            // Update Movement tab trend stats
            var weekEl = document.getElementById('movement-trend-week-count');
            var totalEl = document.getElementById('movement-trend-total-count');
            var streakEl = document.getElementById('movement-trend-streak');
            var insightEl = document.getElementById('movement-trend-insight');

            if (weekEl) weekEl.textContent = workoutData.thisWeekCount;
            if (totalEl) totalEl.textContent = workoutData.totalCount;
            if (streakEl) streakEl.textContent = workoutData.weekStreak;
            if (insightEl) insightEl.textContent = workoutData.insight;

            card.style.display = 'block';
        } catch (err) {
            console.error('Error loading movement trend card:', err);
            card.style.display = 'none';
        }
    }

    /**
     * Get workout trend data from history. Shared between home and movement tab.
     */
    async function _getWorkoutTrendData() {
        if (!window.currentUser) return null;

        try {
            // Get workout history (last 60 days worth)
            var history = await dbHelpers.workouts.getHistory(window.currentUser.id, 500);
            if (!history || history.length === 0) return null;

            // Get unique workout dates
            var uniqueDates = [];
            var dateSet = {};
            history.forEach(function(w) {
                if (w.workout_date && !dateSet[w.workout_date]) {
                    dateSet[w.workout_date] = true;
                    uniqueDates.push(w.workout_date);
                }
            });

            uniqueDates.sort(function(a, b) { return new Date(b) - new Date(a); });

            var totalCount = uniqueDates.length;
            if (totalCount === 0) return null;

            // This week's workouts (Mon-Sun)
            var now = new Date();
            var dayOfWeek = now.getDay(); // 0=Sun, 1=Mon...
            var mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            var monday = new Date(now);
            monday.setDate(monday.getDate() - mondayOffset);
            monday.setHours(0, 0, 0, 0);

            var thisWeekCount = 0;
            uniqueDates.forEach(function(dateStr) {
                var dateObj = new Date(dateStr + 'T12:00:00');
                if (dateObj >= monday) thisWeekCount++;
            });

            // Calculate week streak (consecutive weeks with at least 1 workout)
            var weekStreak = 0;
            var checkWeekStart = new Date(monday);

            for (var w = 0; w < 52; w++) {
                var weekStart = new Date(checkWeekStart);
                weekStart.setDate(weekStart.getDate() - (w * 7));
                var weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);

                var hasWorkout = uniqueDates.some(function(dateStr) {
                    var dateObj = new Date(dateStr + 'T12:00:00');
                    return dateObj >= weekStart && dateObj < weekEnd;
                });

                if (hasWorkout) {
                    weekStreak++;
                } else {
                    break;
                }
            }

            // Last week's workouts for comparison
            var lastMonday = new Date(monday);
            lastMonday.setDate(lastMonday.getDate() - 7);
            var lastWeekCount = 0;
            uniqueDates.forEach(function(dateStr) {
                var dateObj = new Date(dateStr + 'T12:00:00');
                if (dateObj >= lastMonday && dateObj < monday) lastWeekCount++;
            });

            // Generate insight
            var insight = '';
            if (thisWeekCount === 0 && lastWeekCount > 0) {
                insight = 'No workouts logged this week yet. Last week you hit ' + lastWeekCount + ' session' + (lastWeekCount !== 1 ? 's' : '') + ' \u2014 keep the momentum going!';
            } else if (thisWeekCount > lastWeekCount && lastWeekCount > 0) {
                insight = 'You\'re ahead of last week! ' + thisWeekCount + ' workout' + (thisWeekCount !== 1 ? 's' : '') + ' so far vs ' + lastWeekCount + ' last week. Keep pushing!';
            } else if (thisWeekCount === lastWeekCount && thisWeekCount > 0) {
                insight = 'Matching last week\'s pace with ' + thisWeekCount + ' workout' + (thisWeekCount !== 1 ? 's' : '') + '. Consistency is key!';
            } else if (thisWeekCount > 0 && lastWeekCount === 0) {
                insight = 'Great start! ' + thisWeekCount + ' workout' + (thisWeekCount !== 1 ? 's' : '') + ' this week. You\'re building a solid habit!';
            } else if (thisWeekCount > 0) {
                insight = thisWeekCount + ' workout' + (thisWeekCount !== 1 ? 's' : '') + ' this week. ' + (weekStreak > 1 ? weekStreak + '-week streak \u2014 you\'re on fire!' : 'Keep it up!');
            } else {
                insight = 'Start your week strong \u2014 your ' + totalCount + ' total workout' + (totalCount !== 1 ? 's' : '') + ' show you\'ve got what it takes!';
            }

            return {
                thisWeekCount: thisWeekCount,
                lastWeekCount: lastWeekCount,
                totalCount: totalCount,
                weekStreak: weekStreak,
                insight: insight
            };
        } catch (err) {
            console.error('Error computing workout trend data:', err);
            return null;
        }
    }

    function dismissWorkoutTrendCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('workoutTrendCardDismissedDate', today);
        var card = document.getElementById('daily-workout-trend-card');
        if (card) {
            card.style.transition = 'opacity 0.4s, transform 0.4s';
            card.style.opacity = '0';
            card.style.transform = 'translateY(-15px)';
            setTimeout(function() { card.style.display = 'none'; card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }, 400);
        }
    }

    function dismissMovementTrendCard() {
        var d = new Date();
        var today = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        localStorage.setItem('movementTrendCardDismissedDate', today);
        var card = document.getElementById('movement-workout-trend-card');
        if (card) {
            card.style.transition = 'opacity 0.4s, transform 0.4s';
            card.style.opacity = '0';
            card.style.transform = 'translateY(-15px)';
            setTimeout(function() { card.style.display = 'none'; card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }, 400);
        }
    }

    window.checkAndShowWorkoutTrendCard = checkAndShowWorkoutTrendCard;
    window.loadMovementTrendCard = loadMovementTrendCard;
    window.dismissWorkoutTrendCard = dismissWorkoutTrendCard;
    window.dismissMovementTrendCard = dismissMovementTrendCard;
    </script>

    <div style="padding: 0 25px;">
        <!-- Calorie Counter Widget -->
        <div class="calorie-widget-card">
            <div class="calorie-widget-header">
                <h3 style="margin: 0; font-size: 1.1rem;">Today's Nutrition</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="camera-btn-widget" onclick="openMealCameraDirect('widget')" title="Take a photo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </button>
                    <button class="camera-btn-widget" onclick="openMealTextInput('widget')" title="Type your meal">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                            <path d="M2 2l7.586 7.586"></path>
                            <circle cx="11" cy="11" r="2"></circle>
                        </svg>
                    </button>
                    <button class="camera-btn-widget" onclick="openRecentMealsModal()" title="Recent meals">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="calorie-widget-content">
                <!-- Calories Progress -->
                <div class="calorie-progress-main">
                    <div class="calorie-numbers">
                        <span class="calorie-current" id="widget-calories-current">0</span>
                        <span class="calorie-separator">/</span>
                        <span class="calorie-goal" id="widget-calories-goal">2000</span>
                        <span class="calorie-unit">kcal</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="widget-calories-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Macros Grid -->
                <div class="macros-grid">
                    <div class="macro-item">
                        <div class="macro-label">Protein</div>
                        <div class="macro-value"><span id="widget-protein">0</span>g / <span id="widget-protein-goal">50</span>g</div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-protein" id="widget-protein-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-label">Carbs</div>
                        <div class="macro-value"><span id="widget-carbs">0</span>g / <span id="widget-carbs-goal">250</span>g</div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-carbs" id="widget-carbs-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="macro-item">
                        <div class="macro-label">Fat</div>
                        <div class="macro-value"><span id="widget-fat">0</span>g / <span id="widget-fat-goal">70</span>g</div>
                        <div class="progress-bar-small">
                            <div class="progress-fill-fat" id="widget-fat-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="calorie-widget-footer">
                    <button class="view-details-btn" onclick="switchAppTab('meals', this); setTimeout(() => switchWeek('calorie-tracker', document.querySelector('.pill-btn')), 100)">
                        View Details →
                    </button>
                </div>
            </div>
        </div>

        <!-- Avatar Companion Widget - Disabled for now -->

        <!-- Today's Priority Section - Only shown when user has meal plan -->
        <div id="todays-priority-section">
            <h3 style="margin-bottom: 15px; margin-top: 30px;">Today's Priority</h3>

            <!-- Cycle Sync Injection Container -->
            <div id="today-meals-container"></div>
            <!-- Quick Action Card -->
             <div class="card" onclick="switchAppTab('meals', this);" style="cursor: pointer;">
                <div class="card-body" style="max-height: none; padding: 25px; opacity: 1; display: flex; align-items: center; gap: 20px;">
                    <div style="background: var(--accent-green); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">🌿</div>
                    <div>
                        <h4 id="dashboard-current-phase-title" style="margin: 0 0 5px 0; border: none; padding: 0;">Current Phase</h4>
                        <p id="dashboard-current-phase-name" style="margin: 0; font-weight: 500; color: var(--primary);">Week 1: The Flush</p>
                        <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">View today's menu &rarr;</p>
                    </div>
                </div>
             </div>
        </div>



        <!-- WHOOP Activity Card (hidden until connected) -->
        <div id="whoop-dashboard-card" style="display: none; margin: 20px 0 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#1a1a1a;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    WHOOP
                </h3>
                <button onclick="syncWhoopNow()" id="whoop-sync-btn" style="background: none; border: none; color: #1a1a1a; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" style="width:14px; height:14px; fill:#1a1a1a;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    Sync
                </button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <!-- Recovery -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">💚</div>
                    <div id="whoop-recovery" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Recovery</div>
                </div>
                <!-- Sleep -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">😴</div>
                    <div id="whoop-sleep" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Sleep</div>
                </div>
                <!-- Resting HR -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">❤️</div>
                    <div id="whoop-resting-hr" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">RHR</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <!-- HRV -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #EFF6FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">📊</div>
                    <div>
                        <div id="whoop-hrv" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">HRV (ms)</div>
                    </div>
                </div>
                <!-- Strain -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #FFF7ED; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">🔥</div>
                    <div>
                        <div id="whoop-strain" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Strain</div>
                    </div>
                </div>
            </div>
            <div id="whoop-last-sync" style="text-align: right; font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; padding-right: 4px;"></div>
        </div>

        <!-- Oura Ring Activity Card (hidden until connected) -->
        <div id="oura-dashboard-card" style="display: none; margin: 20px 0 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#c4a862;"><circle cx="12" cy="12" r="9" stroke="#c4a862" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="5" stroke="#c4a862" stroke-width="1.5" fill="none"/></svg>
                    Oura
                </h3>
                <button onclick="syncOuraNow()" id="oura-sync-btn" style="background: none; border: none; color: #c4a862; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" style="width:14px; height:14px; fill:#c4a862;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    Sync
                </button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <!-- Steps -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">👟</div>
                    <div id="oura-steps" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Steps</div>
                </div>
                <!-- Sleep -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">😴</div>
                    <div id="oura-sleep" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Sleep</div>
                </div>
                <!-- Readiness -->
                <div style="background: white; border-radius: 14px; padding: 16px 14px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">🎯</div>
                    <div id="oura-readiness" style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.2;">--</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Ready</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <!-- Sleep Score -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #F0F0FF; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">💤</div>
                    <div>
                        <div id="oura-sleep-score" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Sleep Score</div>
                    </div>
                </div>
                <!-- Calories -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #F0FDF4; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">⚡</div>
                    <div>
                        <div id="oura-calories" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Active Cal</div>
                    </div>
                </div>
            </div>
            <div id="oura-last-sync" style="text-align: right; font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; padding-right: 4px;"></div>
        </div>

        <!-- Strava Activity Card (hidden until connected) -->
        <div id="strava-dashboard-card" style="display: none; margin: 20px 0 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#FC4C02;"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                    Strava
                </h3>
                <button onclick="syncStravaNow()" id="strava-sync-btn" style="background: none; border: none; color: #FC4C02; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <svg viewBox="0 0 24 24" style="width:14px; height:14px; fill:#FC4C02;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    Sync
                </button>
            </div>
            <div id="strava-latest-activity" style="background: white; border-radius: 14px; padding: 16px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div id="strava-activity-name" style="font-weight: 700; color: var(--text-main);">No recent activity</div>
                    <div id="strava-activity-type" style="font-size: 0.7rem; background: #FFF4ED; color: #FC4C02; padding: 2px 8px; border-radius: 6px; font-weight: 600;"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div style="text-align: center;">
                        <div id="strava-distance" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Distance</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="strava-duration" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Time</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="strava-heart-rate" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Avg HR</div>
                    </div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <!-- Calories -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #FFF7ED; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">🔥</div>
                    <div>
                        <div id="strava-calories" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Calories</div>
                    </div>
                </div>
                <!-- Elevation -->
                <div style="background: white; border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <div style="width: 36px; height: 36px; background: #F0FDF4; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">⛰️</div>
                    <div>
                        <div id="strava-elevation" style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);">--</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">Elevation</div>
                    </div>
                </div>
            </div>
            <div id="strava-last-sync" style="text-align: right; font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; padding-right: 4px;"></div>
        </div>


        <!-- Live Challenges Section -->
        <div style="margin: 20px 0 15px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-green); padding-bottom: 8px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h3 style="margin: 0;">Monthly Rares</h3>
                <span style="background: linear-gradient(135deg, #f59e0b, #f97316); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; letter-spacing: 1px;">LIMITED</span>
            </div>
            <button onclick="openRareRewardsModal()" style="background: none; border: none; color: var(--primary); font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; text-decoration: underline;">
                View Collection &rarr;
            </button>
        </div>

        <div id="rare-challenges-preview" style="display: flex; gap: 12px; overflow-x: auto; padding: 5px 5px 15px 5px; margin-bottom: 20px; scrollbar-width: none; -ms-overflow-style: none;">
            <style>#rare-challenges-preview::-webkit-scrollbar { display: none; }</style>
            <!-- Featured monthly rare card rendered dynamically by renderFeaturedRareCard() -->
        </div>

        <div id="home-challenges-container" style="margin: 20px 0 15px 0;">
            <!-- Empty state: Start a Challenge card -->
            <div id="home-challenges-empty" onclick="openChallengeTypePicker()" style="cursor: pointer; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(124,58,237,0.2); background: linear-gradient(135deg, #7c3aed 0%, #6366f1 100%);">
                <div style="padding: 18px 20px; display: flex; align-items: center; gap: 14px;">
                    <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.4rem;">🏆</div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; font-size: 0.95rem; color: white; margin-bottom: 3px;">Start a Challenge</div>
                        <div style="font-size: 0.78rem; color: rgba(255,255,255,0.7);">Challenge friends, pick a mode & win rare drops</div>
                    </div>
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: rgba(255,255,255,0.5); flex-shrink: 0;"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
                </div>
            </div>
            <!-- Active challenge cards rendered here by loadHomeChallenges() -->
            <div id="home-challenges-list"></div>
        </div>

        <!-- Activity Insights Card -->
        <div id="fitbit-performance-card" onclick="openInsightsView()" style="cursor: pointer; margin: 0 0 14px 0; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,176,185,0.2);">
            <!-- Connected state (tracker synced) -->
            <div id="fitbit-perf-connected" style="display: none; background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);">
                <!-- Header -->
                <div style="padding: 14px 18px 0; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 9px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: white;"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
                        </div>
                        <div style="font-weight: 700; font-size: 0.95rem; color: white;">Activity Insights</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div id="fitbit-perf-sync-label" style="font-size: 0.65rem; color: rgba(255,255,255,0.55); font-weight: 500;"></div>
                        <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: rgba(255,255,255,0.5);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
                    </div>
                </div>
                <!-- Stats row -->
                <div style="padding: 12px 18px 16px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px;">
                    <div style="text-align: center; padding: 10px 4px; background: rgba(255,255,255,0.15); border-radius: 13px;">
                        <div style="font-size: 1.2rem; margin-bottom: 2px;">👟</div>
                        <div id="fitbit-perf-steps" style="font-size: 1.3rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                        <div style="font-size: 0.62rem; color: rgba(255,255,255,0.8); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Steps</div>
                    </div>
                    <div style="text-align: center; padding: 10px 4px; background: rgba(255,255,255,0.15); border-radius: 13px;">
                        <div style="font-size: 1.2rem; margin-bottom: 2px;">⚡</div>
                        <div id="fitbit-perf-cals" style="font-size: 1.3rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                        <div style="font-size: 0.62rem; color: rgba(255,255,255,0.8); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Cals Burned</div>
                    </div>
                    <div style="text-align: center; padding: 10px 4px; background: rgba(255,255,255,0.15); border-radius: 13px;">
                        <div style="font-size: 1.2rem; margin-bottom: 2px;">❤️</div>
                        <div id="fitbit-perf-hr" style="font-size: 1.3rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                        <div style="font-size: 0.62rem; color: rgba(255,255,255,0.8); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Resting HR</div>
                    </div>
                    <div style="text-align: center; padding: 10px 4px; background: rgba(255,255,255,0.15); border-radius: 13px;">
                        <div style="font-size: 1.2rem; margin-bottom: 2px;">🏃</div>
                        <div id="fitbit-perf-active" style="font-size: 1.3rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                        <div style="font-size: 0.62rem; color: rgba(255,255,255,0.8); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Active Min</div>
                    </div>
                </div>
            </div>
            <!-- No-tracker state — always tappable to open insights -->
            <div id="fitbit-perf-disconnected" style="display: flex; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 16px 18px; align-items: center; justify-content: space-between; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 10px; min-width: 0;">
                    <div style="width: 34px; height: 34px; flex-shrink: 0; background: rgba(255,255,255,0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;">📊</div>
                    <div>
                        <div style="font-size: 0.88rem; font-weight: 700; color: white; margin-bottom: 2px;">Activity Insights</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.55);">Workout trends, strength &amp; sleep correlation</div>
                    </div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: rgba(255,255,255,0.5); flex-shrink: 0;"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
            </div>
        </div>

        <!-- Your Progress Card -->
        <div id="performance-card" style="margin: 20px 0 15px 0; background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%); border-radius: 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(245,158,11,0.25); cursor: pointer;" onclick="openProgressFromHome()">
            <!-- Header -->
            <div style="padding: 16px 20px 0; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 34px; height: 34px; background: rgba(255,255,255,0.25); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: white;"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
                    </div>
                    <div style="font-weight: 700; font-size: 1rem; color: white;">Your Progress</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: rgba(255,255,255,0.6);"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
            </div>
            <!-- Stats Grid -->
            <div style="padding: 14px 20px 18px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                <!-- Workouts This Week -->
                <div style="text-align: center; padding: 12px 6px; background: rgba(255,255,255,0.2); border-radius: 14px;">
                    <div style="font-size: 1.4rem; margin-bottom: 2px;">💪</div>
                    <div id="perf-workouts-value" style="font-size: 1.4rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                    <div style="font-size: 0.68rem; color: rgba(255,255,255,0.85); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Workouts</div>
                    <div id="perf-workouts-sub" style="font-size: 0.65rem; color: rgba(255,255,255,0.7); font-weight: 600; margin-top: 1px;">this week</div>
                </div>
                <!-- Body Weight -->
                <div style="text-align: center; padding: 12px 6px; background: rgba(255,255,255,0.2); border-radius: 14px;">
                    <div style="font-size: 1.4rem; margin-bottom: 2px;">&#9878;</div>
                    <div id="perf-weight-value" style="font-size: 1.4rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                    <div style="font-size: 0.68rem; color: rgba(255,255,255,0.85); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Weight</div>
                    <div id="perf-weight-sub" style="font-size: 0.65rem; color: rgba(255,255,255,0.7); font-weight: 600; margin-top: 1px;">--</div>
                    <div id="perf-bf-sub" style="display:none; font-size: 0.65rem; color: rgba(255,255,255,0.85); font-weight: 700; margin-top: 2px; background: rgba(255,255,255,0.15); border-radius: 6px; padding: 1px 5px;"></div>
                </div>
                <!-- Sleep -->
                <div style="text-align: center; padding: 12px 6px; background: rgba(255,255,255,0.2); border-radius: 14px;">
                    <div style="font-size: 1.4rem; margin-bottom: 2px;">😴</div>
                    <div id="perf-sleep-value" style="font-size: 1.4rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                    <div style="font-size: 0.68rem; color: rgba(255,255,255,0.85); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px;">Sleep</div>
                    <div id="perf-sleep-sub" style="font-size: 0.65rem; color: rgba(255,255,255,0.7); font-weight: 600; margin-top: 1px;">last night</div>
                </div>
            </div>

            <!-- Fitbit data row (shown when Versa 3 / Fitbit is connected) -->
            <div id="perf-fitbit-row" style="display: none; padding: 0 20px 16px; display: none;">
                <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                    <!-- Calories Burned -->
                    <div style="text-align: center; padding: 9px 4px; background: rgba(255,255,255,0.15); border-radius: 12px;">
                        <div style="font-size: 1.1rem; margin-bottom: 1px;">⚡</div>
                        <div id="perf-fitbit-cals" style="font-size: 1.05rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                        <div style="font-size: 0.63rem; color: rgba(255,255,255,0.8); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 1px;">Cals Burned</div>
                    </div>
                    <!-- Resting Heart Rate -->
                    <div style="text-align: center; padding: 9px 4px; background: rgba(255,255,255,0.15); border-radius: 12px;">
                        <div style="font-size: 1.1rem; margin-bottom: 1px;">❤️</div>
                        <div id="perf-fitbit-hr" style="font-size: 1.05rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                        <div style="font-size: 0.63rem; color: rgba(255,255,255,0.8); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 1px;">Resting HR</div>
                    </div>
                    <!-- Active Minutes -->
                    <div style="text-align: center; padding: 9px 4px; background: rgba(255,255,255,0.15); border-radius: 12px;">
                        <div style="font-size: 1.1rem; margin-bottom: 1px;">🏃</div>
                        <div id="perf-fitbit-active" style="font-size: 1.05rem; font-weight: 800; color: white; line-height: 1.2;">--</div>
                        <div style="font-size: 0.63rem; color: rgba(255,255,255,0.8); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 1px;">Active Min</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 6px;">
                    <span style="font-size: 0.62rem; color: rgba(255,255,255,0.5); font-weight: 500;">via Fitbit Versa</span>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- MEALS VIEW (Contains Week Tabs) -->
<div id="view-meals" class="app-view" style="display:none;">
    <div class="app-header">
        <div class="app-logo">Meals</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="coin-header-widget" onclick="openCoinShop()">
                <span class="coin-emoji">🪙</span>
                <span class="coin-amount coin-balance-sync">0</span>
                <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
            </div>
            <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
        </div>
    </div>
    
    <!-- Week Pills Navigation -->
    <div class="week-scroller" id="meals-nav-pills">
        <button class="pill-btn active" onclick="switchWeek('today', this)">Today</button>
        <button class="pill-btn" onclick="switchWeek('calorie-tracker', this)" style="background: var(--accent-green); color: var(--primary); font-weight: 600; border-color: rgba(4, 106, 56, 0.2);">📸 Calorie Tracker</button>
        <button class="pill-btn" onclick="switchWeek('week1', this)">Week 1</button>
        <button class="pill-btn" onclick="switchWeek('week2', this)">Week 2</button>
        <button class="pill-btn" onclick="switchWeek('week3', this)">Week 3</button>
        <button class="pill-btn" onclick="switchWeek('week4', this)">Week 4</button>
        <button class="pill-btn" onclick="switchWeek('dining', this)">Dining Out</button>
        <button class="pill-btn" onclick="switchWeek('shopping', this)" style="background: var(--accent-green); color: var(--primary); font-weight: 600; border-color: rgba(4, 106, 56, 0.2);">🛒 Shopping List</button>
    </div>

    <!-- Container for Week Content -->
    <div id="meals-content-container">
        <!-- Today's Meals View -->
        <div class="view-section active" id="today">
            <div id="today-meals-content">
                <!-- Current day's meals will be injected here -->
                <div style="text-align:center; padding:40px; color:var(--text-muted);">
                    <p>Loading your meals for today...</p>
                </div>
            </div>
        </div>

        <!-- Your Tailored Meal Plan View -->
        <div class="view-section" id="meal-plan-store" style="display: none;">
            <div id="ai-meal-plan-container">
                <!-- State 1: No plan yet - CTA to generate -->
                <div id="ai-plan-empty" style="padding: 30px 20px; text-align: center;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(123,168,131,0.15), rgba(99,102,241,0.15)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2.2rem;">
                        🥗
                    </div>
                    <h2 style="margin: 0 0 10px; font-family: 'Playfair Display'; color: var(--primary); font-size: 1.5rem;">Your Tailored Meal Plan</h2>
                    <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 25px; line-height: 1.6;">Get a personalized weekly meal plan tailored to your goals, dietary preferences and nutritional targets. Generate a fresh plan each week with meal photos!</p>
                    <button onclick="requestAiMealPlan()" style="background: linear-gradient(135deg, var(--primary) 0%, #10b981 100%); color: white; border: none; padding: 14px 32px; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(123,168,131,0.3);">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        Generate My Meal Plan
                    </button>
                    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 15px;">Or ask your FITGotchi coach: "Create me a meal plan"</p>
                </div>

                <!-- State 2: Generating -->
                <div id="ai-plan-generating" style="display: none; padding: 40px 20px; text-align: center;">
                    <div class="learning-spinner" style="margin: 0 auto 20px;"></div>
                    <h3 style="margin: 0 0 10px; color: var(--text-main);">Creating Your Meal Plan...</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem;" id="ai-plan-gen-status">Analyzing your goals and preferences...</p>
                    <div style="max-width: 300px; margin: 20px auto 0;">
                        <div style="height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden;">
                            <div id="ai-plan-gen-progress" style="height: 100%; background: linear-gradient(90deg, var(--primary), #10b981); width: 10%; transition: width 0.5s ease; border-radius: 2px;"></div>
                        </div>
                    </div>
                </div>

                <!-- State 3: Plan loaded - week navigation + meals -->
                <div id="ai-plan-loaded" style="display: none;">
                    <!-- Plan Header -->
                    <div id="ai-plan-header" style="padding: 20px; background: linear-gradient(135deg, rgba(123,168,131,0.08), rgba(99,102,241,0.05)); border-bottom: 1px solid #f1f5f9;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 id="ai-plan-name" style="margin: 0 0 4px; font-family: 'Playfair Display'; color: var(--primary); font-size: 1.3rem;">Your Meal Plan</h2>
                                <p id="ai-plan-desc" style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">Tailored to your goals</p>
                            </div>
                            <button onclick="regenerateAiMealPlan()" style="background: none; border: 1px solid var(--primary); color: var(--primary); padding: 6px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                                Regenerate
                            </button>
                        </div>
                    </div>

                    <!-- Week Tabs (dynamically rendered based on generated weeks) -->
                    <div class="week-scroller" id="ai-plan-week-tabs" style="padding: 10px 15px;">
                        <!-- Tabs rendered by renderAiPlanWeekTabs() -->
                    </div>

                    <!-- Day Tabs -->
                    <div class="sub-nav" id="ai-plan-day-tabs" style="padding: 0 15px;">
                        <button class="sub-btn active" onclick="switchAiPlanDay(0, this)">Mon</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(1, this)">Tue</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(2, this)">Wed</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(3, this)">Thu</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(4, this)">Fri</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(5, this)">Sat</button>
                        <button class="sub-btn" onclick="switchAiPlanDay(6, this)">Sun</button>
                    </div>

                    <!-- Daily Nutrition Summary -->
                    <div id="ai-plan-day-nutrition" style="padding: 10px 15px;">
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <div class="ai-plan-macro-pill" id="ai-day-cal" style="background: #f1f5f9; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: var(--text-main);">0 cal</div>
                            <div class="ai-plan-macro-pill" style="background: rgba(59,130,246,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: #3b82f6;" id="ai-day-protein">0g protein</div>
                            <div class="ai-plan-macro-pill" style="background: rgba(245,158,11,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: #f59e0b;" id="ai-day-carbs">0g carbs</div>
                            <div class="ai-plan-macro-pill" style="background: rgba(239,68,68,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: #ef4444;" id="ai-day-fat">0g fat</div>
                        </div>
                    </div>

                    <!-- Meals List for the Day -->
                    <div id="ai-plan-meals-list" style="padding: 0 15px 20px;">
                        <!-- Meal cards rendered dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Calorie Tracker View -->
        <div class="view-section" id="calorie-tracker">
            <div style="padding: 25px;">
                <!-- Log Meal Buttons - Camera and Text -->
                <div style="text-align: center; margin: 0 0 25px 0; display: flex; justify-content: center; gap: 16px;">
                    <button class="meal-icon-btn" onclick="openMealCameraDirect('tracker')" title="Take a photo">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                    </button>
                    <button class="meal-icon-btn" onclick="openMealTextInput('tracker')" title="Type your meal">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                            <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                            <path d="M2 2l7.586 7.586"></path>
                            <circle cx="11" cy="11" r="2"></circle>
                        </svg>
                    </button>
                    <button class="meal-icon-btn" onclick="openRecentMealsModal()" title="Recent meals">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </button>
                </div>

                <!-- Daily Summary Card -->
                <div class="calorie-tracker-summary">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 0 0 20px 0;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: var(--text-main);">Daily Nutrition Tracker</h2>
                        <div class="streak-inline" id="streak-inline-section">
                            <span class="streak-inline-flame">&#x1F525;</span>
                            <span class="streak-inline-count" id="streak-inline-count">0</span>
                        </div>
                    </div>

                    <!-- Calorie Progress Large (Tri-color macro ring) -->
                    <div class="calorie-progress-large">
                        <div class="calorie-circle">
                            <svg class="calorie-circle-svg" viewBox="0 0 200 200" id="calorie-circle-svg">
                                <circle class="calorie-circle-bg" cx="100" cy="100" r="90" fill="none" stroke="#f0f0f0" stroke-width="12"/>
                            </svg>
                            <div class="calorie-circle-text">
                                <div class="calorie-circle-numbers">
                                    <span class="calorie-circle-current" id="tracker-calories-current">0</span>
                                    <span class="calorie-circle-separator">/</span>
                                    <span class="calorie-circle-goal" id="tracker-calories-goal">2000</span>
                                </div>
                                <div class="calorie-circle-label">calories</div>
                            </div>
                        </div>
                    </div>

                    <!-- Macro Ring Legend -->
                    <div class="macro-ring-legend" id="macro-ring-legend">
                        <div class="macro-ring-legend-item"><span class="macro-ring-dot" style="background: #3b82f6;"></span><span class="macro-ring-label">Protein</span><span class="macro-ring-pct" id="macro-ring-protein-pct">--</span></div>
                        <div class="macro-ring-legend-item"><span class="macro-ring-dot" style="background: #f59e0b;"></span><span class="macro-ring-label">Carbs</span><span class="macro-ring-pct" id="macro-ring-carbs-pct">--</span></div>
                        <div class="macro-ring-legend-item"><span class="macro-ring-dot" style="background: #ef4444;"></span><span class="macro-ring-label">Fat</span><span class="macro-ring-pct" id="macro-ring-fat-pct">--</span></div>
                    </div>

                    <!-- Macros Progress Bars -->
                    <div class="macros-detail-grid">
                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Protein</span>
                                <span class="macro-detail-value"><span id="tracker-protein">0</span> / <span id="tracker-protein-goal">50</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-protein" id="tracker-protein-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Carbs</span>
                                <span class="macro-detail-value"><span id="tracker-carbs">0</span> / <span id="tracker-carbs-goal">250</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-carbs" id="tracker-carbs-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Fat</span>
                                <span class="macro-detail-value"><span id="tracker-fat">0</span> / <span id="tracker-fat-goal">70</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-fat" id="tracker-fat-bar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="macro-detail-item">
                            <div class="macro-detail-header">
                                <span class="macro-detail-name">Fiber</span>
                                <span class="macro-detail-value"><span id="tracker-fiber">0</span> / <span id="tracker-fiber-goal">25</span>g</span>
                            </div>
                            <div class="progress-bar-medium">
                                <div class="progress-fill-fiber" id="tracker-fiber-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Micronutrients Section -->
                    <div class="tracker-micro-section">
                        <div class="tracker-micro-header">Micronutrients</div>
                        <div class="tracker-micro-grid" id="tracker-micro-grid">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <!-- Hydration Circle (inside daily tracker card) -->
                    <div class="hydration-circle-container" id="hydration-section">
                        <div class="hydration-circle-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#0284c7"><path d="M12 2c0 0-8 9.5-8 14a8 8 0 0 0 16 0C20 11.5 12 2 12 2z"/></svg>
                            Hydration
                        </div>
                        <div id="hydration-goal-display" style="font-size:0.72rem; color:#0369a1; font-weight:600; margin-bottom:10px;">Goal: 2,000 ml</div>
                        <div class="hydration-circle-wrap" id="hydration-circle-tap" onclick="addHydrationGlass()">
                            <svg class="hydration-circle-svg" viewBox="0 0 100 100">
                                <circle class="hydration-circle-bg" cx="50" cy="50" r="42"/>
                                <circle class="hydration-circle-fill" id="hydration-circle-fill" cx="50" cy="50" r="42"
                                    stroke-dasharray="264" stroke-dashoffset="264"/>
                            </svg>
                            <div class="hydration-cup-icon">
                                <svg class="hydration-cup-svg" viewBox="0 0 24 24" id="hydration-cup-svg">
                                    <path d="M18 8h2a2 2 0 0 1 2 2v2a4 4 0 0 1-4 4h-.5M6 2h12l-1.5 16.5a2 2 0 0 1-2 1.5H9.5a2 2 0 0 1-2-1.5L6 2z"/>
                                </svg>
                                <span class="hydration-cup-count" id="hydration-cup-count">0/8</span>
                            </div>
                        </div>
                        <div class="hydration-circle-label" id="hydration-circle-label">0 / 2,000 ml</div>
                        <div class="hydration-circle-hint" id="hydration-circle-hint">Tap to add 250ml</div>
                    </div>
                </div>

                <!-- Today's Meals List -->
                <h3 style="margin: 25px 0 15px 0;">Today's Meals</h3>
                <div id="meals-log-list">
                    <div class="empty-state">
                        <p style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
                            📸 No meals logged yet today.<br>
                            <span style="font-size: 0.9rem;">Take a photo of your meal to get started!</span>
                        </p>
                    </div>
                </div>

                <!-- Log Your Day Button -->
                <div id="daily-log-bonus-section" style="margin: 25px 0; text-align: center;">
                    <button id="daily-log-btn" onclick="openDailyScorePopup()" style="
                        width: 100%;
                        padding: 16px 24px;
                        background: linear-gradient(135deg, var(--primary) 0%, #065f3a 100%);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        box-shadow: 0 4px 12px rgba(4, 106, 56, 0.3);
                        transition: transform 0.15s ease, box-shadow 0.15s ease;
                    ">
                        <span style="font-size: 1.3rem;">&#x2705;</span>
                        <span>Log Your Meals for the Day</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 20px; font-size: 0.85rem;">+2 pts</span>
                    </button>
                    <p id="daily-log-hint" style="margin: 8px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">
                        Hit within 20% of your calorie &amp; macro goals to earn 2 bonus points
                    </p>
                </div>

                <!-- Daily Score Popup Modal -->
                <div class="score-popup-overlay" id="score-popup-overlay" style="display: none;" onclick="closeDailyScorePopup(event)">
                    <div class="score-popup-modal" onclick="event.stopPropagation()">
                        <button class="score-popup-close" onclick="closeDailyScorePopup()">&times;</button>
                        <div class="score-popup-header">Daily Score</div>
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 20px 0;">
                            <div class="nutrition-score-ring">
                                <svg viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="42" fill="none" stroke="#bbf7d0" stroke-width="8"/>
                                    <circle id="popup-score-circle" cx="50" cy="50" r="42" fill="none" stroke="var(--primary)" stroke-width="8" stroke-linecap="round"
                                        style="stroke-dasharray: 264; stroke-dashoffset: 264; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.6s ease;"/>
                                </svg>
                                <div class="nutrition-score-value" id="popup-score-value">--</div>
                            </div>
                            <div style="text-align: center; margin-top: 10px;">
                                <div style="font-size: 1.4rem; font-weight: 700; color: var(--text-main);" id="popup-score-grade">Track meals to see score</div>
                            </div>
                        </div>
                        <div class="score-breakdown" id="popup-score-breakdown">
                            <div class="score-breakdown-item"><span class="score-dot" style="background: var(--primary);"></span> Calories</div>
                            <div class="score-breakdown-item"><span class="score-dot" style="background: #3b82f6;"></span> Protein</div>
                            <div class="score-breakdown-item"><span class="score-dot" style="background: #f59e0b;"></span> Carbs</div>
                            <div class="score-breakdown-item"><span class="score-dot" style="background: #ef4444;"></span> Fat</div>
                        </div>
                        <!-- Calorie Projection (MFP-style "If every day were like today...") -->
                        <div id="popup-calorie-projection" class="calorie-projection-section" style="display: none;">
                            <div class="calorie-projection-inner">
                                <div class="calorie-projection-text" id="projection-text"></div>
                                <div class="calorie-projection-weight">
                                    <span class="calorie-projection-value" id="projection-weight-value">--</span>
                                    <span class="calorie-projection-unit" id="projection-weight-unit">kg</span>
                                </div>
                                <div class="calorie-projection-subtext">in 5 weeks</div>
                            </div>
                        </div>

                        <button id="popup-claim-btn" onclick="claimDailyNutritionBonus()" style="
                            width: 100%;
                            padding: 14px 24px;
                            background: linear-gradient(135deg, var(--primary) 0%, #065f3a 100%);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 10px;
                            margin-top: 20px;
                            box-shadow: 0 4px 12px rgba(4, 106, 56, 0.3);
                        ">
                            <span style="font-size: 1.3rem;">&#x2705;</span>
                            <span>Claim Daily Bonus</span>
                            <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 20px; font-size: 0.85rem;">+2 pts</span>
                        </button>
                        <p id="popup-claim-hint" style="margin: 8px 0 0 0; font-size: 0.8rem; color: var(--text-muted); text-align: center;">
                            Hit within 20% of your calorie &amp; macro goals to earn 2 bonus points
                        </p>
                        <button id="popup-finish-day-btn" onclick="finishDayWithoutBonus()" style="
                            display: none;
                            width: 100%;
                            padding: 12px 24px;
                            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 0.95rem;
                            font-weight: 600;
                            cursor: pointer;
                            align-items: center;
                            justify-content: center;
                            gap: 10px;
                            margin-top: 10px;
                        ">
                            <span>Log Your Meals for the Day Anyway</span>
                        </button>
                        <p id="popup-finish-hint" style="display: none; margin: 6px 0 0 0; font-size: 0.75rem; color: var(--text-muted); text-align: center;">
                            This logs your meals without the bonus points
                        </p>
                    </div>
                </div>

                <!-- Weekly Trends Button -->
                <button class="weekly-trends-btn" onclick="openWeeklyTrendsPage()">
                    <span class="weekly-trends-btn-left">
                        <span style="font-size: 1.3rem;">📊</span>
                        <span>Weekly Trends</span>
                    </span>
                    <span class="weekly-trends-btn-arrow">&#x203A;</span>
                </button>

                <!-- Daily Nutrition Score (hidden - now shown as popup) -->
                <div class="nutrition-score-card" id="nutrition-score-section" style="display: none;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                        <div class="nutrition-score-ring">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="42" fill="none" stroke="#bbf7d0" stroke-width="8"/>
                                <circle id="nutrition-score-circle" cx="50" cy="50" r="42" fill="none" stroke="var(--primary)" stroke-width="8" stroke-linecap="round"
                                    style="stroke-dasharray: 264; stroke-dashoffset: 264; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.6s ease;"/>
                            </svg>
                            <div class="nutrition-score-value" id="nutrition-score-value">--</div>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-size: 1rem; font-weight: 700; color: var(--text-main);">Daily Score</div>
                            <div class="nutrition-score-label" id="nutrition-score-grade">Track meals to see score</div>
                        </div>
                    </div>
                    <div class="score-breakdown" id="score-breakdown">
                        <div class="score-breakdown-item"><span class="score-dot" style="background: var(--primary);"></span> Calories</div>
                        <div class="score-breakdown-item"><span class="score-dot" style="background: #3b82f6;"></span> Protein</div>
                        <div class="score-breakdown-item"><span class="score-dot" style="background: #f59e0b;"></span> Carbs</div>
                        <div class="score-breakdown-item"><span class="score-dot" style="background: #ef4444;"></span> Fat</div>
                    </div>
                    <!-- Share Nutrition Card Button -->
                    <button id="share-nutrition-btn" onclick="shareNutritionToFeed()" style="display:flex; align-items:center; justify-content:center; gap:6px; width:100%; margin-top:12px; padding:10px 16px; background:linear-gradient(135deg, rgba(99,102,241,0.15), rgba(129,140,248,0.15)); border:1px solid rgba(99,102,241,0.25); border-radius:10px; color:var(--text-main); font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s;">
                        <span style="font-size:1rem;">🥗</span>
                        <span style="font-size:0.85rem;">Share Nutrition</span>
                    </button>
                </div>

                <!-- Streak Tracker (hidden - now inline in header) -->
                <div class="streak-tracker-card" id="streak-tracker-section" style="display: none;">
                    <div class="streak-header">
                        <div class="streak-flame">
                            <span style="font-size: 1.8rem;">&#x1F525;</span>
                            <div>
                                <div class="streak-count" id="streak-count">0</div>
                                <div class="streak-label">Day Streak</div>
                            </div>
                        </div>
                        <div class="streak-next-bonus" id="streak-next-bonus">Loading...</div>
                    </div>
                    <div class="streak-days-grid" id="streak-days-grid">
                        <!-- 7 day dots rendered by JS -->
                    </div>
                    <div class="streak-progress-bar">
                        <div class="streak-progress-fill" id="streak-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 6px;">
                        <span style="font-size: 0.72rem; color: #92400e;">Current</span>
                        <span style="font-size: 0.72rem; color: #92400e;" id="streak-target-label">Next: 7-day (5 pts)</span>
                    </div>
                </div>

                <!-- Weekly trends, meal patterns, meal journal moved to Weekly Trends page -->

                <!-- Cycle-Synced Nutrition Tips -->
                <div class="cycle-nutrition-card" id="cycle-nutrition-section" style="display: none;">
                    <div class="cycle-nutrition-header">
                        <span id="cycle-nutrition-icon" style="font-size: 1.5rem;"></span>
                        <div>
                            <div class="cycle-nutrition-phase" id="cycle-nutrition-phase">Loading...</div>
                            <div style="font-size: 0.78rem; color: var(--text-muted);">Nutrition tips for your cycle phase</div>
                        </div>
                    </div>
                    <div class="cycle-tip-list" id="cycle-tip-list">
                        <!-- Rendered by JS -->
                    </div>
                </div>

                <!-- Smart Suggestions removed -->
                <!-- Hydration moved inside daily tracker card above -->

                <!-- Score History, Meal Prep Score, Nutrition Badges, Social Comparison removed -->

            </div>
        </div>

        <!-- Week views will be injected/shown here -->

    <!-- Weekly Trends Page (full-screen overlay) -->
    <div class="weekly-trends-page" id="weekly-trends-page">
        <div class="weekly-trends-page-header">
            <span class="weekly-trends-page-title">Weekly Trends</span>
        </div>
        <div class="weekly-trends-page-content">
            <!-- Weekly Summary -->
            <div class="weekly-metrics-card" style="padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border: 1px solid #dee2e6; margin-bottom: 20px;">
                <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                    Weekly Summary
                </h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Total Calories</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><span id="weekly-total-calories">0</span></div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Daily Average</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><span id="weekly-avg-calories">0</span></div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Days Logged</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);"><span id="weekly-days-logged">0</span>/7</div>
                    </div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 12px;">Last 7 Days</div>
                    <div id="weekly-daily-breakdown">
                        <p style="text-align: center; color: var(--text-muted); padding: 20px 0;">Loading weekly data...</p>
                    </div>
                </div>
            </div>

            <!-- Weekly Meals (Photo Journal) -->
            <div class="meal-journal-card" id="meal-journal-section">
                <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: var(--text-main);">Weekly Meals</h3>
                <p style="margin: 0; font-size: 0.78rem; color: var(--text-muted);">Your recent meals at a glance</p>
                <div class="journal-timeline" id="journal-timeline">
                    <p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Loading your meal photos...</p>
                </div>
            </div>

            <!-- Weekly Trends (Multi-Week History) -->
            <div class="multi-week-card" id="multi-week-section">
                <div class="multi-week-header">
                    <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-main);">Weekly Trends</h3>
                    <div class="multi-week-nav" id="multi-week-nav">
                        <button class="active" onclick="loadMultiWeekData(4)">4 Weeks</button>
                        <button onclick="loadMultiWeekData(8)">8 Weeks</button>
                    </div>
                </div>
                <div id="multi-week-sparklines">
                    <p style="text-align: center; color: var(--text-muted); padding: 20px 0; font-size: 0.85rem;">Loading trend data...</p>
                </div>
                <div class="week-compare-grid" id="week-compare-grid">
                    <!-- Comparison stats rendered by JS -->
                </div>
            </div>

            <!-- Meal Pattern Analysis -->
            <div class="meal-pattern-card" id="meal-pattern-section">
                <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: var(--text-main);">Meal Patterns</h3>
                <p style="margin: 0 0 14px 0; font-size: 0.78rem; color: var(--text-muted);">Insights from your last 7 days</p>
                <div id="meal-pattern-insights">
                    <p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Log more meals to see patterns</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Adaptive Calorie Adjustment Confirmation Modal -->
    <div class="adaptive-modal-overlay" id="adaptive-modal-overlay">
        <div class="adaptive-modal">
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px;">
                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: white;"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                </div>
                <span id="adaptive-modal-icon" style="font-size: 1.5rem;"></span>
            </div>
            <div class="adaptive-modal-title" id="adaptive-modal-title">Adjust Your Calories?</div>
            <div class="adaptive-modal-body" id="adaptive-modal-body">
                Based on your tracking data and weight trends, I'd suggest updating your daily calorie goal.
            </div>
            <div class="adaptive-modal-change">
                <span class="adaptive-modal-old" id="adaptive-modal-old">2000 kcal</span>
                <span class="adaptive-modal-arrow">&#x2192;</span>
                <span class="adaptive-modal-new" id="adaptive-modal-new">1850 kcal</span>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0 0 16px 0;">
                Your macros (protein, carbs, fat) will be recalculated proportionally.
            </p>
            <button class="adaptive-modal-confirm" onclick="confirmAdaptiveAdjustment()">Yes, update my goals</button>
            <button class="adaptive-modal-cancel" onclick="closeAdaptiveModal()">Not right now</button>
        </div>
    </div>

<!-- START HERE -->
    <!-- Protocol Section Removed -->

<script src="js/dashboard/dashboard-script-3-1_get_user_data.js"></script>


<!-- SMOOTHIE BOOKLOAD -->
<div class="view-section" id="smoothies">
    <div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
        <div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Adrenal Rescue</div>
        <h1 style="margin-bottom: 15px;">The Balance Smoothie Guide</h1>
        <p style="font-size: 1.1rem; color: #555;">Delicious, grounding recipes to stop the jitters and stabilize blood sugar.</p>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
        <!-- Recipes (Extracted from old bonuses) -->
        <div style="background: #fffdf0; border:1px solid #efe5c0; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_berry_blast.png" alt="Berry Blast" style="width:100%; height:180px; object-fit:cover; background:#e0dbe9;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">1. Cortisol-Control Berry Blast</h4>
                <div style="display:inline-block; background:#e0dbe9; color:#4a3b69; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Antioxidant Shield</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 cup frozen wild blueberries</li>
                    <li>1 handful spinach</li>
                    <li>1/4 avocado</li>
                    <li>1 scoop vanilla pea protein</li>
                    <li>1 tbsp chia seeds</li>
                    <li>1.5 cups almond milk</li>
                </ul>
            </div>
        </div>

        <div style="background: #f4f8f5; border:1px solid #dbece0; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_zen_green.png" alt="Zen Green" style="width:100%; height:180px; object-fit:cover; background:#dbece0;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">2. The "Zen Green" Rescue</h4>
                <div style="display:inline-block; background:#dbece0; color:#2d4a3e; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Cooling & Hydrating</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 cucumber, 1/2 pear</li>
                    <li>1 inch fresh ginger</li>
                    <li>Squeeze of lime</li>
                    <li>1 tbsp hemp seeds</li>
                    <li>Coconut water base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fdf6f6; border:1px solid #eadddd; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_cacao_calm.png" alt="Cacao Calm" style="width:100%; height:180px; object-fit:cover; background:#eadddd;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">3. Cacao "Night Calm"</h4>
                <div style="display:inline-block; background:#eadddd; color:#5c4242; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Serotonin Boost</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 frozen banana</li>
                    <li>1 tbsp raw cacao powder</li>
                    <li>1 tbsp almond butter</li>
                    <li>Pinch sea salt</li>
                    <li>Oat milk base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fffbef; border:1px solid #efeac0; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_golden_turmeric.png" alt="Golden Turmeric" style="width:100%; height:180px; object-fit:cover; background:#efeac0;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">4. Golden Anti-Inflammatory</h4>
                <div style="display:inline-block; background:#efeac0; color:#7a6b28; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Joint Relief</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 cup frozen mango</li>
                    <li>1 tsp turmeric + pinch pepper</li>
                    <li>1 scoop unflavored protein</li>
                    <li>1 tsp flax oil</li>
                    <li>Coconut milk base</li>
                </ul>
            </div>
        </div>

        <!-- Additional recipes to reach 10+ -->
        <div style="background: #f0fdf4; border:1px solid #dcfce7; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_avocado_lime.png" alt="Avocado Lime" style="width:100%; height:180px; object-fit:cover; background:#dcfce7;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">5. Creamy Avocado Lime</h4>
                <div style="display:inline-block; background:#dcfce7; color:#166534; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Healthy Fats</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 ripe avocado</li>
                    <li>Zest & juice of 1 lime</li>
                    <li>1 serving vanilla protein</li>
                    <li>Handful of spinach</li>
                    <li>Unsweetened cashew milk</li>
                </ul>
            </div>
        </div>

        <div style="background: #fdf2f8; border:1px solid #fce7f3; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_cherry_sleep.png" alt="Cherry Sleep" style="width:100%; height:180px; object-fit:cover; background:#fce7f3;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">6. Cherry Chamomile Sleep</h4>
                <div style="display:inline-block; background:#fce7f3; color:#9d174d; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Natural Melatonin</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 cup frozen tart cherries</li>
                    <li>1/2 cup chamomile tea (chilled)</li>
                    <li>1 tbsp almond butter</li>
                    <li>1 tsp honey (optional)</li>
                    <li>Almond milk base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fff7ed; border:1px solid #ffedd5; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_pumpkin_pie.png" alt="Pumpkin Pie" style="width:100%; height:180px; object-fit:cover; background:#ffedd5;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">7. Pumpkin Pie Protein</h4>
                <div style="display:inline-block; background:#ffedd5; color:#9a3412; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Zinc & Magnesium</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/2 cup pumpkin pure</li>
                    <li>1 frozen banana</li>
                    <li>1 tsp pumpkin spice</li>
                    <li>1 tbsp pumpkin seeds</li>
                    <li>Vanilla protein & oat milk</li>
                </ul>
            </div>
        </div>

        <div style="background: #f0fdfa; border:1px solid #ccfbf1; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_matcha_mint.png" alt="Matcha Mint" style="width:100%; height:180px; object-fit:cover; background:#ccfbf1;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">8. Matcha Mint Energy</h4>
                <div style="display:inline-block; background:#ccfbf1; color:#115e59; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">L-Theanine Focus</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 tsp matcha powder</li>
                    <li>Fresh mint leaves</li>
                    <li>1/2 frozen banana</li>
                    <li>Vanilla protein</li>
                    <li>Coconut milk base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fff1f2; border:1px solid #ffe4e6; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_beet_berry.png" alt="Beet Berry" style="width:100%; height:180px; object-fit:cover; background:#ffe4e6;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">9. Beet & Berry Detox</h4>
                <div style="display:inline-block; background:#ffe4e6; color:#be123c; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Liver Support</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1/4 raw beet (peeled)</li>
                    <li>1 cup mixed berries</li>
                    <li>1/2 lemon (juiced)</li>
                    <li>1 tsp flax seeds</li>
                    <li>Coconut water base</li>
                </ul>
            </div>
        </div>

        <div style="background: #fffbeb; border:1px solid #fef3c7; border-radius:12px; overflow: hidden;">
            <img src="/assets/smoothie_banana_nut.png" alt="Banana Bread" style="width:100%; height:180px; object-fit:cover; background:#fef3c7;">
            <div style="padding:20px;">
                <h4 style="color:var(--primary); margin:0 0 10px 0; font-size:1.1rem;">10. Banana Nut Pre-Workout</h4>
                <div style="display:inline-block; background:#fef3c7; color:#92400e; padding:4px 10px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-bottom:15px; text-transform:uppercase;">Sustained Fuel</div>
                <ul style="margin:0; padding-left:20px; font-size:0.9rem; color:#4a5568;">
                    <li>1 large frozen banana</li>
                    <li>1/4 cup rolled oats</li>
                    <li>1 tbsp walnut butter</li>
                    <li>Dash of cinnamon</li>
                    <li>Almond milk base</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Print Button -->
    <div style="margin-top: 50px; text-align: center;">
         <p style="color:var(--text-muted);">Prefer a printed copy?</p>
         <a href="adrenal_smoothie_guide.html" target="_blank" style="text-decoration:none;"><button style="background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-size:1rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='var(--primary)'">Download Printable Guide</button></a>
    </div>
</div>

<!-- MOVEMENT STUDIO SECTION -->
<div class="view-section" id="movement-archive">
    <div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); color: white;">
        <div style="font-family:'Inter'; text-transform:uppercase; color:#99f6e4; font-weight:600; letter-spacing:1px; margin-bottom:10px;">Body & Mind Connection</div>
        <h1 style="margin-bottom: 15px; color: white;">Movement Studio</h1>
        <p style="font-size: 1.1rem; color: #ccfbf1;">Gentle exercises designed to support hormone balance without spiking cortisol.</p>
    </div>

    <!-- MAIN PLAYER STAGE -->
    <div id="video-stage" style="display:none; margin-bottom:30px; background:black; border-radius:15px; overflow:hidden; aspect-ratio:16/9; position:relative;">
        <div id="video-placeholder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; background:#1e293b;">
            <div style="font-size:3rem; margin-bottom:20px;">??</div>
            <div id="video-title-display" style="color:white; font-size:1.2rem; font-weight:600;">Select a Workout</div>
            <p id="video-desc-display" style="color:#94a3b8; margin-top:10px;">Duration: -- min</p>
        </div>
        <button onclick="closeVideoStage()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem;">&times;</button>
    </div>

    <!-- EXERCISE DATABASE GRID -->
    <h3 style="color:var(--primary); margin: 30px 0 20px 0;">Featured Sessions</h3>
    
    <!-- EXERCISE TRACKER & DATABASE (Trainerize Style) -->
    <div id="tracker-interface" style="max-width: 800px; margin: 0 auto;">
        
        <!-- Tab Switcher -->
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:30px; border-bottom:1px solid #e2e8f0; padding-bottom:15px;">
            <button onclick="switchTrackerView('workout')" id="btn-workout" style="border:none; background:none; font-weight:700; color:var(--primary); border-bottom:3px solid var(--primary); padding-bottom:5px; cursor:pointer;">Today's Workout</button>
            <button onclick="switchTrackerView('library')" id="btn-library" style="border:none; background:none; font-weight:600; color:#94a3b8; border-bottom:3px solid transparent; padding-bottom:5px; cursor:pointer;">Exercise Library</button>
        </div>

        <!-- VIEW 1: TODAY'S WORKOUT -->
        <div id="view-workout">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
               <h3 style="margin:0; color:var(--primary); display:flex; align-items:center; gap:10px;">
                   <span>??</span> Today's Session
               </h3>
               <button onclick="saveWorkout()" style="background:var(--secondary); color:white; border:none; padding:10px 25px; border-radius:30px; font-weight:600; cursor:pointer; box-shadow:0 4px 10px rgba(16, 185, 129, 0.2);">
                   ? Complete
               </button>
            </div>

            <!-- Dynamic Workout List -->
            <div id="workout-list">
                <!-- Exercises injected here -->
            </div>
            
            <button onclick="switchTrackerView('library')" style="width:100%; padding:15px; border:2px dashed #cbd5e0; color:#64748b; background:transparent; border-radius:12px; font-weight:600; cursor:pointer; margin-top:20px; transition:all 0.2s; touch-action: manipulation; user-select: none; min-height: 50px;" onmouseover="this.style.borderColor='var(--primary)'; this.style.color='var(--primary)'" onmouseout="this.style.borderColor='#cbd5e0'; this.style.color='#64748b'">
                + Add Exercise
            </button>
        </div>

        <!-- VIEW 2: EXERCISE LIBRARY (DB) -->
        <div id="view-library" style="display:none;">
            <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px;">
                <h4 style="margin:0 0 10px 0; color:#334155;">Search Exercise Library</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="db-search-input" placeholder="e.g. Squat, Lunge, Plank..." style="flex:1; padding:12px; border:1px solid #cbd5e0; border-radius:8px; outline:none;" onkeyup="if(event.key === 'Enter') loadExerciseLibrary(this.value)">
                    <button onclick="loadExerciseLibrary(document.getElementById('db-search-input').value)" style="background:var(--primary); color:white; border:none; padding:0 25px; border-radius:8px; cursor:pointer; font-weight:600;">Search</button>
                </div>
                <div style="margin-top:10px; font-size:0.8rem; color:#64748b;">
                    Browse 1700+ exercise videos from our library. All videos hosted on Google Drive.
                </div>
            </div>

            <div id="library-results" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:15px;">
                <!-- Search Results -->
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">
                    Use the search bar above to browse 1300+ exercises.
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div id="exercise-video-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:black; width:90%; max-width:500px; aspect-ratio:16/9; position:relative; border-radius:12px; overflow:hidden;">
             <button onclick="closeExerciseModal()" style="position:absolute; top:10px; right:10px; z-index:10; background:rgba(0,0,0,0.5); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer;">&times;</button>
             <iframe id="modal-video-frame" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
    </div>
</div>

<!-- DINING OUT GUIDE -->
<div class="view-section" id="dining">
    <div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
        <div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">The Vegan Socialite</div>
        <h1 style="margin-bottom: 15px;">Restaurant Cheat Sheet</h1>
        <p style="font-size: 1.1rem; color: #555;">Never worry about what to order. Use these cheat codes to stay on track mentre dining out.</p>
    </div>

    <div class="card">
        <div class="card-body" style="opacity: 1; max-height: none; padding: 30px;">
            <h3 style="color:var(--secondary); text-transform:uppercase; letter-spacing:1px; font-size:1rem; margin-top:0;">General Dining Rules</h3>
            <ul style="margin-bottom:30px;">
                <li><strong>Protein First:</strong> Always scan for the protein options (Tofu, Beans, Lentils).</li>
                <li><strong>Sauce on Side:</strong> Most hidden oils and sugars are in the dressing.</li>
                <li><strong>Hydrate:</strong> Order sparkling water with lime immediately to settle in.</li>
            </ul>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:25px;">
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Italian</h4>
                    <p><strong>Order:</strong> Grilled vegetable antipasto, Minestrone soup, or simple Marinara pasta with a side of steamed spinach.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Heavy cream sauces (Alfredo) or excessive bread basket grazing.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Mexican</h4>
                    <p><strong>Order:</strong> The Burrito Bowl. Base of black beans and lettuce. Load up on Guacamole (healthy fats!) and Salsa.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Fried chips and heavy cheese quesadillas.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Thai</h4>
                    <p><strong>Order:</strong> Green or Red Curry with Tofu (coconut milk is great for hormones). Papaya Salad (Som Tum).</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Pad Thai (sugar) and deep-fried spring rolls.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Japanese</h4>
                    <p><strong>Order:</strong> Edamame, Miso Soup, Seaweed Salad, Avocado/Cucumber Rolls, Agedashi Tofu.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Tempura (deep fried) and hidden mayo in "spicy" rolls.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">?? Middle Eastern</h4>
                    <p><strong>Order:</strong> Hummus, Baba Ganoush, Falafel (request baked), Tabbouleh, grilled veggie skewers.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Deep-fried pita chips and heavy oil-based tahini swirls.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">?? Indian</h4>
                    <p><strong>Order:</strong> Dal Tadka, Chana Masala, Baingan Bharta (baked eggplant). High fiber and spices.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Heavy cream curries (Korma) or excessive Naan bread.</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">???? Greek</h4>
                    <p><strong>Order:</strong> Giant Beans (Gigantes), Greek Salad (no feta), Stuffed vine leaves (Dolmades).</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Feta-heavy dishes and phyllo pastries (Spanakopita).</p>
                </div>
                <div style="border:1px solid #eee; padding:25px; border-radius:15px; background: #fff;">
                    <h4 style="margin-top:0; color: var(--primary);">?? Fast Casual</h4>
                    <p><strong>Order:</strong> Portobello Mushroom Burger (lettuce wrap), Bean-based Veggie Bowl, sweet potato sides.</p>
                    <p style="font-size: 0.9rem; color: #e53e3e;"><strong>Avoid:</strong> Processed "fake meat" patties and white flour buns.</p>
                </div>
            </div>

            <!-- Print Button -->
            <div style="margin-top: 50px; text-align: center;">
                 <p style="color:var(--text-muted);">Want a pocket guide?</p>
                 <a href="adrenal_dining_guide.html" target="_blank" style="text-decoration:none;"><button style="background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-size:1rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='var(--primary)'">Download Printable Guide</button></a>
            </div>
        </div>
    </div>
</div>








<div class="view-section" id="bonuses">
     <div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
        <div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Exclusive Extras</div>
        <h1 style="margin-bottom: 15px;">Your Protocol Bonuses</h1>
        <p style="font-size: 1.1rem; color: #555;">Tools to support your adrenal recovery journey.</p>
    </div>

    <!-- The content of the original bonuses section (Smoothie, Dining, Acupressure) has been moved to dedicated sections above. -->
    <!-- This section can now be used for other bonuses or removed if no other bonuses are planned. -->
</div>

<div class="view-section" id="week1">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week1', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week1', 'Monday')">Day 1</button><button class="sub-btn" onclick="switchDay('week1', 'Tuesday')">Day 2</button><button class="sub-btn" onclick="switchDay('week1', 'Wednesday')">Day 3</button><button class="sub-btn" onclick="switchDay('week1', 'Thursday')">Day 4</button><button class="sub-btn" onclick="switchDay('week1', 'Friday')">Day 5</button><button class="sub-btn" onclick="switchDay('week1', 'Saturday')">Day 6</button><button class="sub-btn" onclick="switchDay('week1', 'Sunday')">Day 7</button>
</div>
<div class="day-view active" id="week1-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(to right, #eef2f3, #ffffff);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 1</div>
<h1 style="margin-bottom: 15px;">Reset and Debloat</h1>
<p style="font-size: 1.1rem; color: #555;">Flush inflammation with mineral-rich hydration.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>This week reduces the inflammatory load on your adrenal glands. By removing common stressors and flooding your system with minerals (potassium/magnesium), we signal safety to your nervous system, allowing baseline cortisol levels to drop so true restoration can begin.</p>
</div></div>
</div>
<div class="day-view" id="week1-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Stuffed Sweet Potato</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Stuffed Sweet Potato" src="/assets/stuffed_sweet_potato.jpg" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sweet potato 200g</li><li>Quinoa 150g</li><li>Black beans 150g</li><li>Kale 50g</li><li>Tahini 15g</li><li>Lemon juice</li><li>Pumpkin seeds 10g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast:</strong> Bake sweet potato (whole or cubed) until tender (approx 25-30 mins).<br/>
<strong>2. Stuff/Assemble:</strong> Mix cooked quinoa, rinsed black beans, and massaged kale. Stuff into the split potato or arrange in a bowl.<br/>
<strong>3. Serve:</strong> Drizzle with a dressing made of tahini and lemon juice. Top with pumpkin seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Miso Glazed Tempeh</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Miso Glazed Tempeh" src="/assets/miso_glazed_tempeh.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Miso 15g</li><li>Tamari 10ml</li><li>Maple 10ml</li><li>Bok choy 150g</li><li>Cauliflower rice 150g</li><li>Sesame oil</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Whisk miso, tamari, maple syrup, and sesame oil. Cube tempeh and toss in marinade. Let sit for 15-30 mins.<br/>
<strong>2. Cook Tempeh:</strong> Pan-fry tempeh over medium-high heat until golden and caramelized (approx 5-8 mins).<br/>
<strong>3. Sides:</strong> Steam bok choy (3-4 mins). Saut cauliflower rice with a splash of water or oil until tender.<br/>
<strong>4. Serve:</strong> Assemble in a bowl and drizzle with any remaining fresh tahini.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Chamomile Maca Moon Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Chamomile Maca Moon Milk" src="/assets/chamomile_maca_moon_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca 5g</li><li>Cinnamon</li><li>Magnesium</li><li>Chamomile tea</li></ul>
<h4>Preparation</h4>
<p>Steep tea in hot milk. Whisk powders.</p>
</div>
</div>
</div><div class="day-view" id="week1-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Cucumber Mint Green Juice + Tofu Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cucumber Mint Green Juice + Tofu Scramble" src="/assets/cucumber_mint_juice_tofu_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cucumber 200g</li><li>Fresh mint 10g</li><li>Firm tofu 200g</li><li>Asparagus 100g</li><li>Dill 5g</li><li>Olive oil 10ml</li><li>Turmeric 2g</li><li>Black salt 1g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Juice:</strong> Juice cucumber and mint (or blend and strain).<br/>
<strong>2. Scramble:</strong> Crumble firm tofu. Saut in olive oil with turmeric and black salt for 5 mins.<br/>
<strong>3. Veggies:</strong> Steam asparagus until tender-crisp. Chop and mix with tofu and fresh dill.<br/>
<strong>4. Serve:</strong> Plate the scramble with the green juice on the side.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Rainbow Collard Wraps</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Collard Wraps" src="/assets/rainbow_collard_wraps.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Collard greens 6 leaves</li><li>Carrot 100g</li><li>Red lentils 250g</li><li>Avocado 100g</li><li>Bean sprouts 50g</li><li>Tahini 20g</li><li>Garlic 2g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prepare Leaves:</strong> Blanch collard leaves in boiling water for 30 seconds, then plunge into ice water. Pat dry and trim the thick stem spine carefully.<br/>
<strong>2. Make Paste:</strong> Mash red lentils (cooked) with tahini, minced garlic, and a squeeze of lemon until spreadable.<br/>
<strong>3. Assemble:</strong> Spread lentil paste on each leaf. Top with shredded carrot, avocado slices, and bean sprouts.<br/>
<strong>4. Roll:</strong> Fold sides in and roll tightly like a burrito.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Coconut Curry Red Lentil Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Coconut Curry Red Lentil Soup" src="/assets/coconut_curry_red_lentil_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Red lentils 250g</li><li>Light coconut milk 200ml</li><li>Curry paste 20g</li><li>Delicata squash 150g</li><li>Onion/Garlic/Ginger</li><li>Stock 300ml</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Squash:</strong> Toss delicata squash cubes with oil and roast at 200C for 20-25 mins until tender.<br/>
<strong>2. Base:</strong> Saut diced onion, garlic, and ginger until fragrant. Stir in curry paste for 1 minute.<br/>
<strong>3. Simmer:</strong> Add red lentils, coconut milk, and stock. Simmer for 15-20 mins until lentils are soft.<br/>
<strong>4. Serve:</strong> Ladle soup into bowls and top with roasted squash.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Tea" src="/assets/lemon_balm_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lemon balm tea</li><li>Ground flax 5g</li></ul>
<h4>Preparation</h4>
<p>Steep tea. Stir in flax.</p>
</div>
</div>
</div><div class="day-view" id="week1-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Glow Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Glow Bowl" src="/assets/glow_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Baby greens 100g</li><li>Fennel bulb 150g</li><li>White beans 200g</li><li>Artichoke hearts 100g</li><li>Pesto 25g</li><li>Lemon/Oil</li></ul>
<h4>Preparation</h4>
<p>Roast fennel. Arrange greens. Top with beans/artichokes/fennel. Drizzle with pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Zucchini Noodle Pho</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Zucchini Noodle Pho" src="/assets/zucchini_noodle_pho.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 250g</li><li>Veg broth 300ml</li><li>Star anise/Cinnamon</li><li>Tofu 200g</li><li>Edamame 50g</li><li>Shiitake 100g</li><li>Mung sprouts</li><li>Basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Infuse Broth:</strong> Simmer vegetable broth with star anise, cinnamon stick, ginger slices, and onion for 15 mins. Strain if desired.<br/>
<strong>2. Add Veggies:</strong> Add sliced shiitake mushrooms and simmer for 5 mins.<br/>
<strong>3. Finish:</strong> Add tofu cubes and zucchini noodles (zoodles) for just the last 1-2 minutes to warm through without overcooking.<br/>
<strong>4. Serve:</strong> Top with fresh basil, sprouts, and lime.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Golden Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Golden Milk" src="/assets/golden_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Turmeric</li><li>Ginger</li><li>Coconut oil 3g</li><li>Triphala</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Whisk all ingredients in hot milk.</p>
</div>
</div>
</div><div class="day-view" id="week1-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Cucumber Mint Green Juice + Tofu Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cucumber Mint Green Juice + Tofu Scramble" src="/assets/cucumber_mint_juice_tofu_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cucumber 200g</li><li>Fresh mint 10g</li><li>Firm tofu 200g</li><li>Asparagus 100g</li><li>Dill 5g</li><li>Olive oil 10ml</li><li>Turmeric 2g</li><li>Black salt 1g</li></ul>
<h4>Preparation</h4>
<p>Juice cucumber/mint. Saut crumbled tofu with spices. Steam asparagus. Mix tofu with dill/asparagus. Serve with juice.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lemony Quinoa &amp; Chickpea Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemony Quinoa &amp; Chickpea Bowl" src="/assets/lemony_quinoa_chickpea_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Quinoa 150g</li><li>Pumpkin seeds 20g</li><li>Mint &amp; Parsley 10g</li><li>Lemon juice 15ml</li><li>Plant protein 20g</li></ul>
<h4>Preparation</h4>
<p>Assemble bowl. Whisk lemon juice/oil dressing. Drizzle over.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Miso Glazed Tempeh</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Miso Glazed Tempeh" src="/assets/miso_glazed_tempeh.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Miso 15g</li><li>Tamari 10ml</li><li>Maple 10ml</li><li>Bok choy 150g</li><li>Cauliflower rice 150g</li><li>Sesame oil</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p>Marinate/fry tempeh. Steam bok choy. Saut rice. Serve bowl style.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Chamomile Maca Moon Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Chamomile Maca Moon Milk" src="/assets/chamomile_maca_moon_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca 5g</li><li>Cinnamon</li><li>Magnesium</li><li>Chamomile tea</li></ul>
<h4>Preparation</h4>
<p>Steep tea in hot milk. Whisk powders.</p>
</div>
</div>
</div><div class="day-view" id="week1-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Rainbow Collard Wraps</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Collard Wraps" src="/assets/rainbow_collard_wraps.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Collard greens 6 leaves</li><li>Carrot 100g</li><li>Red lentils 250g</li><li>Avocado 100g</li><li>Bean sprouts 50g</li><li>Tahini 20g</li><li>Garlic 2g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prepare Leaves:</strong> Blanch collard leaves in boiling water for 30 seconds, then plunge into ice water. Pat dry and trim the thick stem spine carefully.<br/>
<strong>2. Make Paste:</strong> Mash red lentils (cooked) with tahini, minced garlic, and a squeeze of lemon until spreadable.<br/>
<strong>3. Assemble:</strong> Spread lentil paste on each leaf. Top with shredded carrot, avocado slices, and bean sprouts.<br/>
<strong>4. Roll:</strong> Fold sides in and roll tightly like a burrito.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Coconut Curry Red Lentil Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Coconut Curry Red Lentil Soup" src="/assets/coconut_curry_red_lentil_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Red lentils 250g</li><li>Light coconut milk 200ml</li><li>Curry paste 20g</li><li>Delicata squash 150g</li><li>Onion/Garlic/Ginger</li><li>Stock 300ml</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Squash:</strong> Toss delicata squash cubes with oil and roast at 200C for 20-25 mins until tender.<br/>
<strong>2. Base:</strong> Saut diced onion, garlic, and ginger until fragrant. Stir in curry paste for 1 minute.<br/>
<strong>3. Simmer:</strong> Add red lentils, coconut milk, and stock. Simmer for 15-20 mins until lentils are soft.<br/>
<strong>4. Serve:</strong> Ladle soup into bowls and top with roasted squash.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Tea" src="/assets/lemon_balm_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lemon balm tea</li><li>Ground flax 5g</li></ul>
<h4>Preparation</h4>
<p>Steep tea. Stir in flax.</p>
</div>
</div>
</div><div class="day-view" id="week1-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Cucumber Mint Green Juice + Tofu Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cucumber Mint Green Juice + Tofu Scramble" src="/assets/cucumber_mint_juice_tofu_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cucumber 200g</li><li>Fresh mint 10g</li><li>Firm tofu 200g</li><li>Asparagus 100g</li><li>Dill 5g</li><li>Olive oil 10ml</li><li>Turmeric 2g</li><li>Black salt 1g</li></ul>
<h4>Preparation</h4>
<p>Juice cucumber/mint. Saut crumbled tofu with spices. Steam asparagus. Mix tofu with dill/asparagus. Serve with juice.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Mineral Broth &amp; Edamame</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mineral Broth &amp; Edamame" src="/assets/mineral_broth_edamame.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Edamame 150g</li><li>Miso 15g</li><li>Veg broth 250ml</li><li>Wakame 5g</li><li>Scallions</li></ul>
<h4>Preparation</h4>
<p>Heat broth with miso/wakame. Add edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Glow Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Glow Bowl" src="/assets/glow_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Baby greens 100g</li><li>Fennel bulb 150g</li><li>White beans 200g</li><li>Artichoke hearts 100g</li><li>Pesto 25g</li><li>Lemon/Oil</li></ul>
<h4>Preparation</h4>
<p>Roast fennel. Arrange greens. Top with beans/artichokes/fennel. Drizzle with pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Zucchini Noodle Pho</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Zucchini Noodle Pho" src="/assets/zucchini_noodle_pho.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 250g</li><li>Veg broth 300ml</li><li>Star anise/Cinnamon</li><li>Tofu 200g</li><li>Shiitake 100g</li><li>Mung sprouts</li><li>Basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Infuse Broth:</strong> Simmer vegetable broth with star anise, cinnamon stick, ginger slices, and onion for 15 mins. Strain if desired.<br/>
<strong>2. Add Veggies:</strong> Add sliced shiitake mushrooms and simmer for 5 mins.<br/>
<strong>3. Finish:</strong> Add tofu cubes and zucchini noodles (zoodles) for just the last 1-2 minutes to warm through without overcooking.<br/>
<strong>4. Serve:</strong> Top with fresh basil, sprouts, and lime.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Golden Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Golden Milk" src="/assets/golden_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Turmeric</li><li>Ginger</li><li>Coconut oil 3g</li><li>Triphala</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Whisk all ingredients in hot milk.</p>
</div>
</div>
</div><div class="day-view" id="week1-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Ginger Pear Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Ginger Pear Smoothie" src="/assets/ginger_pear_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pear 170g</li><li>Spinach 50g</li><li>Cucumber 80g</li><li>Pea protein powder 30g</li><li>Ground flaxseed 15g</li><li>Aloe vera juice 30ml</li><li>Almond butter 15g</li><li>Water 100ml</li></ul>
<h4>Preparation</h4>
<p>Blend all ingredients until smooth. Almond butter adds healthy fats.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cranberry Chia Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cranberry Chia Pudding" src="/assets/cranberry_chia_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia seeds 15g</li><li>Pea protein 10g</li><li>Almond milk 100ml</li><li>Cranberries 10g</li><li>Berries 50g</li><li>Brazil nuts 5g</li></ul>
<h4>Preparation</h4>
<p>Soak chia. Top with berries/nuts.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lemony Quinoa &amp; Chickpea Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemony Quinoa &amp; Chickpea Bowl" src="/assets/lemony_quinoa_chickpea_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Quinoa 150g</li><li>Pumpkin seeds 20g</li><li>Mint &amp; Parsley 10g</li><li>Lemon juice 15ml</li><li>Plant protein 20g</li></ul>
<h4>Preparation</h4>
<p>Assemble bowl. Whisk lemon juice/oil dressing. Drizzle over.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Fennel Lime Tonic &amp; Nori</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Lime Tonic &amp; Nori" src="/assets/fennel_lime_tonic_nori.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel bulb 100g</li><li>Lime juice 20ml</li><li>Nori 2g</li></ul>
<h4>Preparation</h4>
<p>Juice fennel. Mix with lime water. Serve with toasted nori.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Miso Glazed Tempeh</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Miso Glazed Tempeh" src="/assets/miso_glazed_tempeh.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Miso 15g</li><li>Tamari 10ml</li><li>Maple 10ml</li><li>Bok choy 150g</li><li>Cauliflower rice 150g</li><li>Sesame oil</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Whisk miso, tamari, maple syrup, and sesame oil. Cube tempeh and toss in marinade. Let sit for 15-30 mins.<br/>
<strong>2. Cook Tempeh:</strong> Pan-fry tempeh over medium-high heat until golden and caramelized (approx 5-8 mins).<br/>
<strong>3. Sides:</strong> Steam bok choy (3-4 mins). Saut cauliflower rice with a splash of water or oil until tender.<br/>
<strong>4. Serve:</strong> Assemble in a bowl and drizzle with any remaining fresh tahini.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Chamomile Maca Moon Milk</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Chamomile Maca Moon Milk" src="/assets/chamomile_maca_moon_milk.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca 5g</li><li>Cinnamon</li><li>Magnesium</li><li>Chamomile tea</li></ul>
<h4>Preparation</h4>
<p>Steep tea in hot milk. Whisk powders.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="week2">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week2', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week2', 'Monday')">Day 8</button><button class="sub-btn" onclick="switchDay('week2', 'Tuesday')">Day 9</button><button class="sub-btn" onclick="switchDay('week2', 'Wednesday')">Day 10</button><button class="sub-btn" onclick="switchDay('week2', 'Thursday')">Day 11</button><button class="sub-btn" onclick="switchDay('week2', 'Friday')">Day 12</button><button class="sub-btn" onclick="switchDay('week2', 'Saturday')">Day 13</button><button class="sub-btn" onclick="switchDay('week2', 'Sunday')">Day 14</button>
</div>
<div class="day-view active" id="week2-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: var(--surface); border: 1px solid var(--chat-border-coach);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 2</div>
<h1 style="margin-bottom: 15px;">Strength &amp; Blood Sugar</h1>
<p style="font-size: 1.1rem; color: #555;">Higher protein and fiber dense carbs.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>Bio-availability is key. We pair protein with slow-burning complex carbs to prevent the blood sugar dips that trigger "panic" cortisol spikes. This steady energy supply keeps your mood stable and your adrenal output calm throughout the day.</p>
</div></div>
</div>
<div class="day-view" id="week2-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Warm Apple Pie Oat Bake</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Warm Apple Pie Oat Bake" src="/assets/warm_apple_pie_oat_bake.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 50g</li><li>Apple 120g</li><li>Cardamom</li><li>Hemp yogurt 80g</li><li>Pear 80g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine rolled oats, chopped apple, cardamom, and a splash of almond milk/water in a baking dish.<br/>
<strong>2. Bake:</strong> Bake at 180C for 20-25 minutes until oats are set and apples are soft.<br/>
<strong>3. Serve:</strong> Top with a dollop of hemp yogurt and fresh pear slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Farro Power Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Farro Power Bowl" src="/assets/farro_power_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Farro 80g</li><li>Tempeh 150g</li><li>Brussels sprouts 100g</li><li>Pomegranate</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prep Components:</strong> Cook farro according to package instructions. Roast halved Brussels sprouts at 200C for 20 mins.<br/>
<strong>2. Tempeh:</strong> Pan-fry tempeh cubes with a splash of tamari until crispy.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, 1 tbsp water, and a drop of maple syrup until smooth.<br/>
<strong>4. Assemble:</strong> Combine farro, sprouts, and tempeh. Top with pomegranate seeds and dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Walnut Crusted Tofu</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Walnut Crusted Tofu" src="/assets/walnut_crusted_tofu.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Walnuts 20g</li><li>Sweet potato 200g</li><li>Green beans</li></ul>
<h4>Preparation</h4>
<p><strong>1. Crust Tofu:</strong> Mix crushed walnuts with spices. Dip pressed tofu slabs in almond milk, then press into walnut mix.<br/>
<strong>2. Bake:</strong> Place tofu and sweet potato wedges on a baking sheet. Bake at 200C for 25-30 minutes until crispy.<br/>
<strong>3. Veggies:</strong> Briefly steam or saut green beans with garlic.<br/>
<strong>4. Serve:</strong> Plate tofu with fries and beans.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Reishi Hot Chocolate</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Reishi Hot Chocolate" src="/assets/reishi_hot_chocolate.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk</li><li>Cacao</li><li>Reishi</li><li>Monk fruit</li></ul>
<h4>Preparation</h4>
<p>Whisk heated ingredients.</p>
</div>
</div>
</div><div class="day-view" id="week2-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Savory Chickpea Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Savory Chickpea Scramble" src="/assets/savory_chickpea_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Tofu 200g</li><li>Spinach 100g</li><li>Pesto 10g</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Scramble Base:</strong> Roughly mash chickpeas and tofu with a fork.<br/>
<strong>2. Saut:</strong> Saut chopped onion and tomatoes in a pan until soft. Add chickpea/tofu mix.<br/>
<strong>3. Season:</strong> Add turmeric, black salt (kala namak), and pepper. Cook 5-7 mins.<br/>
<strong>4. Finish:</strong> Stir in fresh spinach until wilted. Remove from heat and fold in pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Hearty Tempeh Chili</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Hearty Tempeh Chili" src="/assets/hearty_tempeh_chili.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Kidney beans 100g</li><li>Cacao</li><li>Tomatoes 200g</li><li>Chili spices</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Cook onions, garlic, and peppers until soft. Add crumbled tempeh and brown lightly.<br/>
<strong>2. Simmer:</strong> Add kidney beans, crushed tomatoes, chili powder, cumin, and vegetable broth. Simmer for 20-30 mins to thicken.<br/>
<strong>3. Finish:</strong> Stir in raw cacao powder right before serving for depth.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Sheet Pan Lemon Seitan</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sheet Pan Lemon Seitan" src="/assets/sheet_pan_lemon_seitan.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seitan 150g</li><li>Asparagus 150g</li><li>Fennel 100g</li><li>Orange</li></ul>
<h4>Preparation</h4>
<p><strong>1. Toss:</strong> Combine seitan chunks, asparagus spears, and fennel wedges on a sheet pan. Toss with olive oil, lemon juice, dried oregano, and garlic powder.<br/>
<strong>2. Bake:</strong> Roast at 200C for 20 minutes until golden and veggies are tender.<br/>
<strong>3. Serve:</strong> Garnish with fresh orange zest or slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tulsi Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tulsi Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tulsi tea</li><li>Lemon</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Blue Spirulina Smoothie Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Blue Spirulina Smoothie Bowl" src="/assets/blue_spirulina_smoothie_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cauli rice 100g</li><li>Blueberries 150g</li><li>Pea protein</li><li>Spirulina</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p>Blend all. Decoration optional.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Mediterranean Lentil Salad</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mediterranean Lentil Salad" src="/assets/mediterranean_lentil_salad.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 100g</li><li>Eggplant 200g</li><li>Tahini 15g</li><li>Parsley</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Eggplant:</strong> Cube eggplant, toss with oil and salt. Roast at 200C for 25 mins.<br/>
<strong>2. Salad Base:</strong> Combine cooked lentils, roasted eggplant, diced tomatoes, chopped parsley, and cucumber.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, garlic, and a splash of water.<br/>
<strong>4. Serve:</strong> Toss salad with dressing while warm or cold.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Rainbow Sushi Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Sushi Bowl" src="/assets/rainbow_sushi_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Black rice 150g</li><li>Smoked tofu 150g</li><li>Avocado</li><li>Cucumber</li><li>Nori</li></ul>
<h4>Preparation</h4>
<p><strong>1. Rice:</strong> Cook black rice according to package. Stir in a little rice vinegar when done.<br/>
<strong>2. Prep:</strong> Cube smoked tofu. Slice avocado and cucumber. Cut nori into small strips.<br/>
<strong>3. Assemble:</strong> Arrange everything in a bowl.<br/>
<strong>4. Dress:</strong> Drizzle with tamari and sesame oil.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Sage &amp; Lavender Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sage &amp; Lavender Tea" src="/assets/sage_lavender_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sage</li><li>Lavender</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Overnight Buckwheat Groats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Overnight Buckwheat Groats" src="/assets/overnight_buckwheat_groats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Buckwheat 60g</li><li>Almond milk 150ml</li><li>Cacao nibs</li><li>Cherries</li><li>Alhond yogurt</li></ul>
<h4>Preparation</h4>
<p>Soak overnight. Top with cherries/yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Farro Power Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Farro Power Bowl" src="/assets/farro_power_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Farro 80g</li><li>Tempeh 150g</li><li>Brussels sprouts 100g</li><li>Pomegranate</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p><strong>1. Prep Components:</strong> Cook farro according to package instructions. Roast halved Brussels sprouts at 200C for 20 mins.<br/>
<strong>2. Tempeh:</strong> Pan-fry tempeh cubes with a splash of tamari until crispy.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, 1 tbsp water, and a drop of maple syrup until smooth.<br/>
<strong>4. Assemble:</strong> Combine farro, sprouts, and tempeh. Top with pomegranate seeds and dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Walnut Crusted Tofu</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Walnut Crusted Tofu" src="/assets/walnut_crusted_tofu.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Walnuts 20g</li><li>Sweet potato 200g</li><li>Green beans</li></ul>
<h4>Preparation</h4>
<p><strong>1. Crust Tofu:</strong> Mix crushed walnuts with spices. Dip pressed tofu slabs in almond milk, then press into walnut mix.<br/>
<strong>2. Bake:</strong> Place tofu and sweet potato wedges on a baking sheet. Bake at 200C for 25-30 minutes until crispy.<br/>
<strong>3. Veggies:</strong> Briefly steam or saut green beans with garlic.<br/>
<strong>4. Serve:</strong> Plate tofu with fries and beans.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Reishi Hot Chocolate</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Reishi Hot Chocolate" src="/assets/reishi_hot_chocolate.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk</li><li>Cacao</li><li>Reishi</li><li>Monk fruit</li></ul>
<h4>Preparation</h4>
<p>Whisk heated ingredients.</p>
</div>
</div>
</div><div class="day-view" id="week2-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Warm Apple Pie Oat Bake</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Warm Apple Pie Oat Bake" src="/assets/warm_apple_pie_oat_bake.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 50g</li><li>Apple 120g</li><li>Cardamom</li><li>Hemp yogurt 80g</li><li>Pear 80g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine rolled oats, chopped apple, cardamom, and a splash of almond milk/water in a baking dish.<br/>
<strong>2. Bake:</strong> Bake at 180C for 20-25 minutes until oats are set and apples are soft.<br/>
<strong>3. Serve:</strong> Top with a dollop of hemp yogurt and fresh pear slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Hearty Tempeh Chili</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Hearty Tempeh Chili" src="/assets/hearty_tempeh_chili.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh 200g</li><li>Kidney beans 100g</li><li>Cacao</li><li>Tomatoes 200g</li><li>Chili spices</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Cook onions, garlic, and peppers until soft. Add crumbled tempeh and brown lightly.<br/>
<strong>2. Simmer:</strong> Add kidney beans, crushed tomatoes, chili powder, cumin, and vegetable broth. Simmer for 20-30 mins to thicken.<br/>
<strong>3. Finish:</strong> Stir in raw cacao powder right before serving for depth.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Sheet Pan Lemon Seitan</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sheet Pan Lemon Seitan" src="/assets/sheet_pan_lemon_seitan.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seitan 150g</li><li>Asparagus 150g</li><li>Fennel 100g</li><li>Orange</li></ul>
<h4>Preparation</h4>
<p><strong>1. Toss:</strong> Combine seitan chunks, asparagus spears, and fennel wedges on a sheet pan. Toss with olive oil, lemon juice, dried oregano, and garlic powder.<br/>
<strong>2. Bake:</strong> Roast at 200C for 20 minutes until golden and veggies are tender.<br/>
<strong>3. Serve:</strong> Garnish with fresh orange zest or slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tulsi Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tulsi Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tulsi tea</li><li>Lemon</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Savory Chickpea Scramble</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Savory Chickpea Scramble" src="/assets/savory_chickpea_scramble.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 100g</li><li>Tofu 200g</li><li>Spinach 100g</li><li>Pesto 10g</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Scramble Base:</strong> Roughly mash chickpeas and tofu with a fork.<br/>
<strong>2. Saut:</strong> Saut chopped onion and tomatoes in a pan until soft. Add chickpea/tofu mix.<br/>
<strong>3. Season:</strong> Add turmeric, black salt (kala namak), and pepper. Cook 5-7 mins.<br/>
<strong>4. Finish:</strong> Stir in fresh spinach until wilted. Remove from heat and fold in pesto.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Lime Spiced Pepitas &amp; Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lime Spiced Pepitas &amp; Tea" src="/assets/lime_spiced_pepitas_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Pepitas 40g</li><li>Lime zest/juice</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Roast pepitas with spices. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Mediterranean Lentil Salad</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Mediterranean Lentil Salad" src="/assets/mediterranean_lentil_salad.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 100g</li><li>Eggplant 200g</li><li>Tahini 15g</li><li>Parsley</li><li>Tomatoes</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast Eggplant:</strong> Cube eggplant, toss with oil and salt. Roast at 200C for 25 mins.<br/>
<strong>2. Salad Base:</strong> Combine cooked lentils, roasted eggplant, diced tomatoes, chopped parsley, and cucumber.<br/>
<strong>3. Dressing:</strong> Whisk tahini, lemon juice, garlic, and a splash of water.<br/>
<strong>4. Serve:</strong> Toss salad with dressing while warm or cold.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Rainbow Sushi Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rainbow Sushi Bowl" src="/assets/rainbow_sushi_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Black rice 150g</li><li>Smoked tofu 150g</li><li>Avocado</li><li>Cucumber</li><li>Nori</li></ul>
<h4>Preparation</h4>
<p><strong>1. Rice:</strong> Cook black rice according to package. Stir in a little rice vinegar when done.<br/>
<strong>2. Prep:</strong> Cube smoked tofu. Slice avocado and cucumber. Cut nori into small strips.<br/>
<strong>3. Assemble:</strong> Arrange everything in a bowl.<br/>
<strong>4. Dress:</strong> Drizzle with tamari and sesame oil.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Sage &amp; Lavender Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sage &amp; Lavender Tea" src="/assets/sage_lavender_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sage</li><li>Lavender</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week2-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Blue Spirulina Smoothie Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Blue Spirulina Smoothie Bowl" src="/assets/blue_spirulina_smoothie_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>

<h4>Ingredients</h4>
<ul><li>Cauli rice 100g</li><li>Blueberries 150g</li><li>Pea protein</li><li>Spirulina</li><li>Tahini 20g</li></ul>
<h4>Preparation</h4>
<p>Blend all. Decoration optional.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Cinnamon Maca Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cinnamon Maca Latte" src="/assets/cinnamon_maca_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk 200ml</li><li>Maca</li><li>Cinnamon</li><li>Edamame 50g (side)</li></ul>
<h4>Preparation</h4>
<p>Heat milk/spices. Serve with edamame.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Farro Power Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Farro Power Bowl" src="/assets/farro_power_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Farro 80g</li><li>Tempeh 150g</li><li>Brussels sprouts 100g</li><li>Pomegranate</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast sprouts. Fry tempeh. Assemble bowl with tahini dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Cacao Chia Protein Pudding</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cacao Chia Protein Pudding" src="/assets/cacao_chia_protein_pudding.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 15g</li><li>Cacao</li><li>Protein powder</li><li>Raspberries</li></ul>
<h4>Preparation</h4>
<p>Soak chia/powders. Top with raspberries.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Walnut Crusted Tofu</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Walnut Crusted Tofu" src="/assets/walnut_crusted_tofu.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Walnuts 20g</li><li>Sweet potato 200g</li><li>Green beans</li></ul>
<h4>Preparation</h4>
<p>Crust tofu/fry. Roast potato. Saut beans.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Reishi Hot Chocolate</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Reishi Hot Chocolate" src="/assets/reishi_hot_chocolate.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Almond milk</li><li>Cacao</li><li>Reishi</li><li>Monk fruit</li></ul>
<h4>Preparation</h4>
<p>Whisk heated ingredients.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="week3">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week3', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week3', 'Monday')">Day 15</button><button class="sub-btn" onclick="switchDay('week3', 'Tuesday')">Day 16</button><button class="sub-btn" onclick="switchDay('week3', 'Wednesday')">Day 17</button><button class="sub-btn" onclick="switchDay('week3', 'Thursday')">Day 18</button><button class="sub-btn" onclick="switchDay('week3', 'Friday')">Day 19</button><button class="sub-btn" onclick="switchDay('week3', 'Saturday')">Day 20</button><button class="sub-btn" onclick="switchDay('week3', 'Sunday')">Day 21</button>
</div>
<div class="day-view active" id="week3-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(to right, #fbfdef, #ffffff);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 3</div>
<h1 style="margin-bottom: 15px;">Metabolism Boost</h1>
<p style="font-size: 1.1rem; color: #555;">Thermogenic foods and spices.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>We gently support your metabolic rate with warming, nutrient-dense foods rather than stimulants. Selenium and Zinc nourish the thyroidyour adrenals' partner in energy productionensuring you feel energized without the "tired-wired" crash.</p>
</div></div>
</div>
<div class="day-view" id="week3-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Fire Tonic &amp; Lentil Waffles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fire Tonic &amp; Lentil Waffles" src="/assets/fire_tonic_lentil_waffles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tonic: ACV, Ginger, Cayenne</li><li>Lentils 150g</li><li>Chickpea flour 50g</li><li>Kimchi</li><li>Avocado</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tonic:</strong> Mix warm water, apple cider vinegar, grated ginger, and a pinch of cayenne.<br/>
<strong>2. Waffles:</strong> Blend soaked red lentils (or use flour), chickpea flour, water, baking powder, and salt. Cook in a greased waffle iron until crisp.<br/>
<strong>3. Serve:</strong> Drink tonic first. Top waffles with kimchi and sliced avocado.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Thai Basil Zucchini Noodles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Thai Basil Zucchini Noodles" src="/assets/thai_basil_zucchini_noodles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 300g</li><li>Tofu 200g</li><li>Almond butter</li><li>Coconut milk</li><li>Thai basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tofu:</strong> Pan-fry tofu cubes with soy sauce until golden.<br/>
<strong>2. Sauce:</strong> Whisk almond butter, coconut milk, lime juice, ginger, and garlic until creamy.<br/>
<strong>3. Noodles:</strong> Spiralize zucchini. Toss zoodles in the sauce briefly to warm (don't cook too long).<br/>
<strong>4. Serve:</strong> Top with tofu and fresh Thai basil leaves.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p><strong>1. Steaks:</strong> Slice cauliflower into thick "steaks". Brush with oil, turmeric, cumin, and paprika.<br/>
<strong>2. Roast:</strong> Bake at 200C for 25-30 minutes, flipping halfway, until tender and charred.<br/>
<strong>3. Base:</strong> Warm the cooked beluga lentils and massage the kale with lemon.<br/>
<strong>4. Serve:</strong> Place steaks over lentils/kale and drizzle with tahini.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Dandelion Root Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Dandelion Root Latte" src="/assets/dandelion_root_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dandelion root</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p>Heat and whisk.</p>
</div>
</div>
</div><div class="day-view" id="week3-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Carrot Cake Chia Parfait</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Chia Parfait" src="/assets/carrot_cake_chia_parfait.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 30g</li><li>Carrot 100g</li><li>Cashew butter</li><li>Coconut cream</li><li>Walnuts</li></ul>
<h4>Preparation</h4>
<p>Layer chia pudding with grated carrot/cream.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Moroccan Chickpea Stew</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Moroccan Chickpea Stew" src="/assets/moroccan_chickpea_stew.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 200g</li><li>Millet 150g</li><li>Apricots</li><li>Tomatoes</li><li>Spinach</li></ul>
<h4>Preparation</h4>
<p><strong>1. Base:</strong> Saut onion, garlic, and ginger with cumin, cinnamon, and turmeric.<br/>
<strong>2. Simmer:</strong> Add chickpeas, chopped tomatoes, dried apricots, and broth. Simmer for 20 mins.<br/>
<strong>3. Greens:</strong> Stir in spinach at the end to wilt.<br/>
<strong>4. Serve:</strong> Spoon stew over fluffy cooked millet.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Grilled Tofu Tikka</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grilled Tofu Tikka" src="/assets/grilled_tofu_tikka.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Cauli rice 150g</li><li>Cucumber/Mint salad</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Coat tofu in coconut yogurt mixed with tikka spices, lime, and ginger. Let sit for 20+ mins.<br/>
<strong>2. Grill/Bake:</strong> Grill skewers or bake tofu at 220C until edges are charred (approx 20 mins).<br/>
<strong>3. Sides:</strong> Serve with heated cauliflower rice and a cooling cucumber/mint salad.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Holy Basil Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Holy Basil Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fresh basil</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Metabolic Mocha Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Metabolic Mocha Smoothie" src="/assets/metabolic_mocha_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cold brew</li><li>Cacao</li><li>Chili</li><li>Pea protein</li><li>Banana</li></ul>
<h4>Preparation</h4>
<p>Blend.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Charred Broccoli &amp; Bean Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Charred Broccoli &amp; Bean Bowl" src="/assets/charred_broccoli_bean_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Broccoli 200g</li><li>Cannellini beans 150g</li><li>Romesco sauce</li></ul>
<h4>Preparation</h4>
<p><strong>1. Char:</strong> Toss broccoli florets with oil and roast at high heat (220C) or pan-sear until charred/browned.<br/>
<strong>2. Combine:</strong> Mix warm broccoli with cannellini beans.<br/>
<strong>3. Serve:</strong> Toss generously with Romesco sauce (roasted red pepper &amp; almond sauce).</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast cauliflower. Serve over lentils/kale.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Fennel Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Tea" src="/assets/fennel_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel seeds</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Fire Tonic &amp; Lentil Waffles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fire Tonic &amp; Lentil Waffles" src="/assets/fire_tonic_lentil_waffles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tonic: ACV, Ginger, Cayenne</li><li>Lentils 150g</li><li>Chickpea flour 50g</li><li>Kimchi</li><li>Avocado</li></ul>
<h4>Preparation</h4>
<p>Drink tonic. Blend/cook waffles. Top with kimchi/avo.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Sweet Potato Nourish Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Sweet Potato Nourish Bowl" src="/assets/sweet_potato_nourish_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Sweet potato 200g</li><li>Kale</li><li>Quinoa</li><li>Maple Miso dressing</li></ul>
<h4>Preparation</h4>
<p><strong>1. Roast:</strong> Roast sweet potato wedges at 200C until tender.<br/>
<strong>2. Kale:</strong> Remove kale stems and massage leaves with a little olive oil and salt to soften.<br/>
<strong>3. Dressing:</strong> Whisk maple, miso, and apple cider vinegar.<br/>
<strong>4. Serve:</strong> Assemble bowl with quinoa, potato, kale, and drizzle with dressing.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Grilled Tofu Tikka</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grilled Tofu Tikka" src="/assets/grilled_tofu_tikka.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Cauli rice 150g</li><li>Cucumber/Mint salad</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p>Grill marinated tofu. Serve with rice/salad.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Dandelion Root Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Dandelion Root Latte" src="/assets/dandelion_root_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dandelion root</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p>Heat and whisk.</p>
</div>
</div>
</div><div class="day-view" id="week3-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Carrot Cake Chia Parfait</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Chia Parfait" src="/assets/carrot_cake_chia_parfait.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chia 30g</li><li>Carrot 100g</li><li>Cashew butter</li><li>Coconut cream</li><li>Walnuts</li></ul>
<h4>Preparation</h4>
<p>Layer chia pudding with grated carrot/cream.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Thai Basil Zucchini Noodles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Thai Basil Zucchini Noodles" src="/assets/thai_basil_zucchini_noodles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Zoodles 300g</li><li>Tofu 200g</li><li>Almond butter</li><li>Coconut milk</li><li>Thai basil</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tofu:</strong> Pan-fry tofu cubes with soy sauce until golden.<br/>
<strong>2. Sauce:</strong> Whisk almond butter, coconut milk, lime juice, ginger, and garlic until creamy.<br/>
<strong>3. Noodles:</strong> Spiralize zucchini. Toss zoodles in the sauce briefly to warm (don't cook too long).<br/>
<strong>4. Serve:</strong> Top with tofu and fresh Thai basil leaves.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast cauliflower. Serve over lentils/kale.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Holy Basil Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Holy Basil Tea" src="/assets/tulsi_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fresh basil</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Metabolic Mocha Smoothie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Metabolic Mocha Smoothie" src="/assets/metabolic_mocha_smoothie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cold brew</li><li>Cacao</li><li>Chili</li><li>Pea protein</li><li>Banana</li></ul>
<h4>Preparation</h4>
<p>Blend.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Green Apple &amp; Almond Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Green Apple &amp; Almond Butter" src="/assets/green_apple_almond_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Apple</li><li>Almond butter</li></ul>
<h4>Preparation</h4>
<p>Slice and dip.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Moroccan Chickpea Stew</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Moroccan Chickpea Stew" src="/assets/moroccan_chickpea_stew.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Chickpeas 200g</li><li>Millet 150g</li><li>Apricots</li><li>Tomatoes</li><li>Spinach</li></ul>
<h4>Preparation</h4>
<p><strong>1. Base:</strong> Saut onion, garlic, and ginger with cumin, cinnamon, and turmeric.<br/>
<strong>2. Simmer:</strong> Add chickpeas, chopped tomatoes, dried apricots, and broth. Simmer for 20 mins.<br/>
<strong>3. Greens:</strong> Stir in spinach at the end to wilt.<br/>
<strong>4. Serve:</strong> Spoon stew over fluffy cooked millet.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Grilled Tofu Tikka</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grilled Tofu Tikka" src="/assets/grilled_tofu_tikka.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tofu 200g</li><li>Cauli rice 150g</li><li>Cucumber/Mint salad</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Marinate:</strong> Coat tofu in coconut yogurt mixed with tikka spices, lime, and ginger. Let sit for 20+ mins.<br/>
<strong>2. Grill/Bake:</strong> Grill skewers or bake tofu at 220C until edges are charred (approx 20 mins).<br/>
<strong>3. Sides:</strong> Serve with heated cauliflower rice and a cooling cucumber/mint salad.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Fennel Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fennel Tea" src="/assets/fennel_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Fennel seeds</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week3-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Fire Tonic &amp; Lentil Waffles</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Fire Tonic &amp; Lentil Waffles" src="/assets/fire_tonic_lentil_waffles.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tonic: ACV, Ginger, Cayenne</li><li>Lentils 150g</li><li>Chickpea flour 50g</li><li>Kimchi</li><li>Avocado</li></ul>
<h4>Preparation</h4>
<p><strong>1. Tonic:</strong> Mix warm water, apple cider vinegar, grated ginger, and a pinch of cayenne.<br/>
<strong>2. Waffles:</strong> Blend soaked red lentils (or use flour), chickpea flour, water, baking powder, and salt. Cook in a greased waffle iron until crisp.<br/>
<strong>3. Serve:</strong> Drink tonic first. Top waffles with kimchi and sliced avocado.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Grapefruit &amp; Pumpkin Seed Brittle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Grapefruit &amp; Pumpkin Seed Brittle" src="/assets/grapefruit_pumpkin_seed_brittle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Grapefruit</li><li>Pumpkin seeds 20g</li><li>Maple</li><li>Chili</li></ul>
<h4>Preparation</h4>
<p>Bake seeds. Serve with grapefruit.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Charred Broccoli &amp; Bean Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Charred Broccoli &amp; Bean Bowl" src="/assets/charred_broccoli_bean_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Broccoli 200g</li><li>Cannellini beans 150g</li><li>Romesco sauce</li></ul>
<h4>Preparation</h4>
<p><strong>1. Char:</strong> Toss broccoli florets with oil and roast at high heat (220C) or pan-sear until charred/browned.<br/>
<strong>2. Combine:</strong> Mix warm broccoli with cannellini beans.<br/>
<strong>3. Serve:</strong> Toss generously with Romesco sauce (roasted red pepper &amp; almond sauce).</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Rosemary Cacao Truffle</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Rosemary Cacao Truffle" src="/assets/rosemary_cacao_truffle.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao</li><li>Protein</li><li>Coconut oil</li><li>Rosemary</li></ul>
<h4>Preparation</h4>
<p>Mix and chill.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Turmeric Cauliflower Steaks</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Turmeric Cauliflower Steaks" src="/assets/turmeric_cauliflower_steaks.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cauliflower 300g</li><li>Beluga lentils 150g</li><li>Kale</li><li>Tahini</li></ul>
<h4>Preparation</h4>
<p>Roast cauliflower. Serve over lentils/kale.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Dandelion Root Latte</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Dandelion Root Latte" src="/assets/dandelion_root_latte.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dandelion root</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p>Heat and whisk.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="week4">
<div class="sub-nav">
<button class="sub-btn active" onclick="switchDay('week4', 'overview')">Overview</button>
<button class="sub-btn" onclick="switchDay('week4', 'Monday')">Day 22</button><button class="sub-btn" onclick="switchDay('week4', 'Tuesday')">Day 23</button><button class="sub-btn" onclick="switchDay('week4', 'Wednesday')">Day 24</button><button class="sub-btn" onclick="switchDay('week4', 'Thursday')">Day 25</button><button class="sub-btn" onclick="switchDay('week4', 'Friday')">Day 26</button><button class="sub-btn" onclick="switchDay('week4', 'Saturday')">Day 27</button><button class="sub-btn" onclick="switchDay('week4', 'Sunday')">Day 28</button>
</div>
<div class="day-view active" id="week4-overview">
<div class="hero-card" style="padding: 40px; text-align: left; background: linear-gradient(to right, #f7f9fc, #ffffff);">
<div style="font-family:'Inter'; text-transform:uppercase; color:var(--secondary); font-weight:600; letter-spacing:1px; margin-bottom:10px;">Week 4</div>
<h1 style="margin-bottom: 15px;">Hormone Harmony</h1>
<p style="font-size: 1.1rem; color: #555;">Mood stabilizing carbs and magnesium.</p>

</div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Why It Works</div><div class="expand-icon">+</div></div>
<div class="card-body">
<p>Strategic carbohydrates in the evening boost serotonin production, your brain's natural "off switch." Combined with magnesium-rich ingredients, this week prepares your body for deep, restorative sleepthe only time your adrenals truly repair.</p>
</div></div>
</div>
<div class="day-view" id="week4-Monday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Baked Raspberry Almond Oats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Baked Raspberry Almond Oats" src="/assets/baked_raspberry_almond_oats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 60g</li><li>Almonds</li><li>Raspberries</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine oats, baking powder, cinnamon, and almonds.<br/>
<strong>2. Wet:</strong> Mix mashed banana (if using in base) or maple syrup with milk and melted coconut oil. Fold into dry mix.<br/>
<strong>3. Bake:</strong> Stir in raspberries. Pour into ramekin. Bake at 180C for 20-25 mins.<br/>
<strong>4. Serve:</strong> Drizzle with coconut yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Creamy White Bean Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy White Bean Soup" src="/assets/creamy_white_bean_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>White beans 200g</li><li>Rosemary</li><li>Sourdough side</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut onion, garlic, and celery until soft.<br/>
<strong>2. Simmer:</strong> Add white beans (cannellini) and veggie stock. Add a sprig of rosemary. Simmer 15 mins.<br/>
<strong>3. Blend:</strong> Remove rosemary. Blend soup until creamy (add almond milk if needed).<br/>
<strong>4. Serve:</strong> Serve hot with a slice of sourdough.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Smoky Tempeh Pot Pie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Smoky Tempeh Pot Pie" src="/assets/smoky_tempeh_pot_pie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh</li><li>Root veg</li><li>Cassava crust</li></ul>
<h4>Preparation</h4>
<p><strong>1. Filling:</strong> Saut onion, carrots, celery. Add crumbled tempeh. Stir in flour or starch to coat, then pour in broth to create gravy.<br/>
<strong>2. Crust:</strong> Make a simple cassava flour dough (flour, oil, water) or top with mashed potato.<br/>
<strong>3. Bake:</strong> Place filling in dish, top with crust. Bake at 200C for 25-30 mins until bubbling and golden.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tart Cherry Mocktail</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tart Cherry Mocktail" src="/assets/tart_cherry_mocktail.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tart cherry</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Mix.</p>
</div>
</div>
</div><div class="day-view" id="week4-Tuesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Banana Buckwheat Muffins</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Banana Buckwheat Muffins" src="/assets/banana_buckwheat_muffins.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Buckwheat flour 60g</li><li>Banana</li><li>Walnuts</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p><strong>1. Batter:</strong> Mash banana. Whisk with almond milk and a tsp of oil. Stir in buckwheat flour, baking powder, and cinnamon.<br/>
<strong>2. Bake:</strong> Fold in walnuts. Spoon into muffin tin.<br/>
<strong>3. Cook:</strong> Bake at 180C for 20-25 minutes. Let cool slightly.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Cozy Miso Soba Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cozy Miso Soba Bowl" src="/assets/cozy_miso_soba_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Soba noodles</li><li>Miso</li><li>Shiitake</li><li>Tofu 200g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Broth:</strong> Simmer ginger slices, garlic, and shiitake mushrooms in vegetable stock for 10 mins.<br/>
<strong>2. Miso:</strong> Whisk miso with a little hot water separately. Turn off heat and stir into broth (don't boil miso).<br/>
<strong>3. Noodles:</strong> Cook soba noodles, rinse cold. Place in bowl.<br/>
<strong>4. Serve:</strong> Ladle soup over noodles. Top with tofu cubes and scallions.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Gnocchi Sage Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Gnocchi Sage Butter" src="/assets/gnocchi_sage_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Gnocchi</li><li>White beans 150g</li><li>Sage</li><li>Walnuts</li><li>Rocket</li></ul>
<h4>Preparation</h4>
<p><strong>1. Cook Gnocchi:</strong> Boil gnocchi until they float. Drain.<br/>
<strong>2. Sage Sauce:</strong> Heat olive oil or vegan butter in a pan. Fry fresh sage leaves until crisp. Add walnuts.<br/>
<strong>3. Toss:</strong> Add gnocchi to the pan and saut for a few minutes to crisp the outside.<br/>
<strong>4. Serve:</strong> Pile over a bed of fresh rocket.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Valerian</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Valerian" src="/assets/lemon_balm_valerian.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tea</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Wednesday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Berry Chia Jam Toast</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Berry Chia Jam Toast" src="/assets/berry_chia_jam_toast.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seeded bread</li><li>Chia jam</li><li>Tofu scramble side</li></ul>
<h4>Preparation</h4>
<p>Toast bread. Top with jam. Serve with tofu.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lentil Bolognese Squash</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lentil Bolognese Squash" src="/assets/lentil_bolognese_squash.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 200g</li><li>Tomato sauce</li><li>Spaghetti squash</li></ul>
<h4>Preparation</h4>
<p><strong>1. Squash:</strong> Cut squash in half lengthwise, remove seeds. Roast cut-side down at 200C for 40 mins. Scrape out strands.<br/>
<strong>2. Sauce:</strong> Saut onion, carrot, celery. Add lentils, crushed tomatoes, and dried herbs. Simmer 20 mins.<br/>
<strong>3. Serve:</strong> Top squash strands with heavy scoop of bolognese.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Creamy Mushroom Stroganoff</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy Mushroom Stroganoff" src="/assets/creamy_mushroom_stroganoff.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Mushrooms</li><li>Smoked tofu 200g</li><li>Rice noodles</li><li>Cashew cream</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut sliced mushrooms in olive oil until browned. Add garlic and thyme.<br/>
<strong>2. Sauce:</strong> Stir in cashew cream (blended cashews + water), nutritional yeast, and mustard. Simmer to thicken.<br/>
<strong>3. Noodles:</strong> Cook rice noodles. Toss immediately with the sauce.<br/>
<strong>4. Serve:</strong> Top with parsley.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Kava Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Kava Tea" src="/assets/kava_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Kava</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Thursday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Baked Raspberry Almond Oats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Baked Raspberry Almond Oats" src="/assets/baked_raspberry_almond_oats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 60g</li><li>Almonds</li><li>Raspberries</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine oats, baking powder, cinnamon, and almonds.<br/>
<strong>2. Wet:</strong> Mix mashed banana (if using in base) or maple syrup with milk and melted coconut oil. Fold into dry mix.<br/>
<strong>3. Bake:</strong> Stir in raspberries. Pour into ramekin. Bake at 180C for 20-25 mins.<br/>
<strong>4. Serve:</strong> Drizzle with coconut yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Creamy White Bean Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy White Bean Soup" src="/assets/creamy_white_bean_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>White beans 200g</li><li>Rosemary</li><li>Sourdough side</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut onion, garlic, and celery until soft.<br/>
<strong>2. Simmer:</strong> Add white beans (cannellini) and veggie stock. Add a sprig of rosemary. Simmer 15 mins.<br/>
<strong>3. Blend:</strong> Remove rosemary. Blend soup until creamy (add almond milk if needed).<br/>
<strong>4. Serve:</strong> Serve hot with a slice of sourdough.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Smoky Tempeh Pot Pie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Smoky Tempeh Pot Pie" src="/assets/smoky_tempeh_pot_pie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh</li><li>Root veg</li><li>Cassava crust</li></ul>
<h4>Preparation</h4>
<p><strong>1. Filling:</strong> Saut onion, carrots, celery. Add crumbled tempeh. Stir in flour or starch to coat, then pour in broth to create gravy.<br/>
<strong>2. Crust:</strong> Make a simple cassava flour dough (flour, oil, water) or top with mashed potato.<br/>
<strong>3. Bake:</strong> Place filling in dish, top with crust. Bake at 200C for 25-30 mins until bubbling and golden.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tart Cherry Mocktail</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tart Cherry Mocktail" src="/assets/tart_cherry_mocktail.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tart cherry</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Mix.</p>
</div>
</div>
</div><div class="day-view" id="week4-Friday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Banana Buckwheat Muffins</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Banana Buckwheat Muffins" src="/assets/banana_buckwheat_muffins.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Buckwheat flour 60g</li><li>Banana</li><li>Walnuts</li><li>Almond milk</li></ul>
<h4>Preparation</h4>
<p><strong>1. Batter:</strong> Mash banana. Whisk with almond milk and a tsp of oil. Stir in buckwheat flour, baking powder, and cinnamon.<br/>
<strong>2. Bake:</strong> Fold in walnuts. Spoon into muffin tin.<br/>
<strong>3. Cook:</strong> Bake at 180C for 20-25 minutes. Let cool slightly.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Cozy Miso Soba Bowl</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Cozy Miso Soba Bowl" src="/assets/cozy_miso_soba_bowl.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Soba noodles</li><li>Miso</li><li>Shiitake</li><li>Tofu 200g</li></ul>
<h4>Preparation</h4>
<p><strong>1. Broth:</strong> Simmer ginger slices, garlic, and shiitake mushrooms in vegetable stock for 10 mins.<br/>
<strong>2. Miso:</strong> Whisk miso with a little hot water separately. Turn off heat and stir into broth (don't boil miso).<br/>
<strong>3. Noodles:</strong> Cook soba noodles, rinse cold. Place in bowl.<br/>
<strong>4. Serve:</strong> Ladle soup over noodles. Top with tofu cubes and scallions.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Gnocchi Sage Butter</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Gnocchi Sage Butter" src="/assets/gnocchi_sage_butter.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Gnocchi</li><li>White beans 150g</li><li>Sage</li><li>Walnuts</li><li>Rocket</li></ul>
<h4>Preparation</h4>
<p><strong>1. Cook Gnocchi:</strong> Boil gnocchi until they float. Drain.<br/>
<strong>2. Sage Sauce:</strong> Heat olive oil or vegan butter in a pan. Fry fresh sage leaves until crisp. Add walnuts.<br/>
<strong>3. Toss:</strong> Add gnocchi to the pan and saut for a few minutes to crisp the outside.<br/>
<strong>4. Serve:</strong> Pile over a bed of fresh rocket.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Lemon Balm Valerian</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lemon Balm Valerian" src="/assets/lemon_balm_valerian.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tea</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Saturday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Berry Chia Jam Toast</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Berry Chia Jam Toast" src="/assets/berry_chia_jam_toast.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Seeded bread</li><li>Chia jam</li><li>Tofu scramble side</li></ul>
<h4>Preparation</h4>
<p>Toast bread. Top with jam. Serve with tofu.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Carrot Cake Energy Balls</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Carrot Cake Energy Balls" src="/assets/carrot_cake_energy_balls.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Dates</li><li>Carrot</li><li>Walnuts</li><li>Coconut flour</li></ul>
<h4>Preparation</h4>
<p>Blend &amp; roll. Serve with tea.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Lentil Bolognese Squash</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Lentil Bolognese Squash" src="/assets/lentil_bolognese_squash.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Lentils 200g</li><li>Tomato sauce</li><li>Spaghetti squash</li></ul>
<h4>Preparation</h4>
<p><strong>1. Squash:</strong> Cut squash in half lengthwise, remove seeds. Roast cut-side down at 200C for 40 mins. Scrape out strands.<br/>
<strong>2. Sauce:</strong> Saut onion, carrot, celery. Add lentils, crushed tomatoes, and dried herbs. Simmer 20 mins.<br/>
<strong>3. Serve:</strong> Top squash strands with heavy scoop of bolognese.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Creamy Mushroom Stroganoff</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy Mushroom Stroganoff" src="/assets/creamy_mushroom_stroganoff.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Mushrooms</li><li>Smoked tofu 200g</li><li>Rice noodles</li><li>Cashew cream</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut sliced mushrooms in olive oil until browned. Add garlic and thyme.<br/>
<strong>2. Sauce:</strong> Stir in cashew cream (blended cashews + water), nutritional yeast, and mustard. Simmer to thicken.<br/>
<strong>3. Noodles:</strong> Cook rice noodles. Toss immediately with the sauce.<br/>
<strong>4. Serve:</strong> Top with parsley.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Kava Tea</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Kava Tea" src="/assets/kava_tea.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Kava</li></ul>
<h4>Preparation</h4>
<p>Steep.</p>
</div>
</div>
</div><div class="day-view" id="week4-Sunday">
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Breakfast  7:30 AM</div>
<div class="meal-title">Baked Raspberry Almond Oats</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Baked Raspberry Almond Oats" src="/assets/baked_raspberry_almond_oats.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Oats 60g</li><li>Almonds</li><li>Raspberries</li><li>Coconut yogurt</li></ul>
<h4>Preparation</h4>
<p><strong>1. Mix:</strong> Combine oats, baking powder, cinnamon, and almonds.<br/>
<strong>2. Wet:</strong> Mix mashed banana (if using in base) or maple syrup with milk and melted coconut oil. Fold into dry mix.<br/>
<strong>3. Bake:</strong> Stir in raspberries. Pour into ramekin. Bake at 180C for 20-25 mins.<br/>
<strong>4. Serve:</strong> Drizzle with coconut yogurt.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">AM Snack  10:30 AM</div>
<div class="meal-title">Spiced Cacao &amp; Pepitas</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Spiced Cacao &amp; Pepitas" src="/assets/spiced_cacao_pepitas.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Cacao drink</li><li>Pepitas</li></ul>
<h4>Preparation</h4>
<p>Warm drink + seeds.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Lunch  12:30 PM</div>
<div class="meal-title">Creamy White Bean Soup</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Creamy White Bean Soup" src="/assets/creamy_white_bean_soup.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>White beans 200g</li><li>Rosemary</li><li>Sourdough side</li></ul>
<h4>Preparation</h4>
<p><strong>1. Saut:</strong> Saut onion, garlic, and celery until soft.<br/>
<strong>2. Simmer:</strong> Add white beans (cannellini) and veggie stock. Add a sprig of rosemary. Simmer 15 mins.<br/>
<strong>3. Blend:</strong> Remove rosemary. Blend soup until creamy (add almond milk if needed).<br/>
<strong>4. Serve:</strong> Serve hot with a slice of sourdough.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">PM Snack  3:30 PM</div>
<div class="meal-title">Choc Dipped Orange</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Choc Dipped Orange" src="/assets/choc_dipped_orange.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Orange</li><li>Dark choc</li></ul>
<h4>Preparation</h4>
<p>Dip slices.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Dinner  6:30 PM</div>
<div class="meal-title">Smoky Tempeh Pot Pie</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Smoky Tempeh Pot Pie" src="/assets/smoky_tempeh_pot_pie.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tempeh</li><li>Root veg</li><li>Cassava crust</li></ul>
<h4>Preparation</h4>
<p><strong>1. Filling:</strong> Saut onion, carrots, celery. Add crumbled tempeh. Stir in flour or starch to coat, then pour in broth to create gravy.<br/>
<strong>2. Crust:</strong> Make a simple cassava flour dough (flour, oil, water) or top with mashed potato.<br/>
<strong>3. Bake:</strong> Place filling in dish, top with crust. Bake at 200C for 25-30 mins until bubbling and golden.</p>
</div>
</div>
<div class="card">
<div class="card-header" onclick="toggleCard(this)">
<div style="display:flex; align-items:center;">
<div class="meal-icon">🍽️</div>
<div>
<div class="meta">Evening Ritual  8:30 PM</div>
<div class="meal-title">Tart Cherry Mocktail</div>
</div>
</div>
<div class="expand-icon">+</div>
</div>
<div class="card-body">
<img alt="Tart Cherry Mocktail" src="/assets/tart_cherry_mocktail.png" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:20px;"/>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;"><h4 style="margin-bottom: 0; border: none; padding-bottom: 0;">Ingredients</h4></div>
<ul><li>Tart cherry</li><li>Magnesium</li></ul>
<h4>Preparation</h4>
<p>Mix.</p>
</div>
</div>
</div>
</div>
<div class="view-section" id="supplements">
    <h1>Supplement Guide</h1>
    <div style="background: #fff3e0; padding: 20px; border-radius: 12px; border: 1px solid #ffe0b2; margin-bottom: 30px;">
        <h4 style="color: #e65100; margin-bottom: 5px; border: none;">Medical Disclaimer</h4>
        <p style="font-size: 0.9rem; margin: 0; color: #666;">Supplements should be taken under the guidance of a healthcare professional. Dosages listed are general guidelines.</p>
    </div>

    <h3 style="color:var(--secondary); margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">Cortisol Calm (Your Essentials)</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-bottom: 50px;">
        <!-- Ashwagandha -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Ashwagandha" src="/assets/ashwagandha_spp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Stress</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Ashwagandha</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">200mg evening. Lowers cortisol and helps manage stress.</p>
            </div>
        </div>
        <!-- Magnesium -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Magnesium Glycinate" src="/assets/magnesium_glycinate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Sleep</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Magnesium Glycinate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">300-400mg nightly. Aids sleep, reduces cramps and anxiety.</p>
            </div>
        </div>
        <!-- Omega 3 -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Omega 3 DHA/EPA" src="/assets/omega_3_algae_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Inflammation</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Omega 3 DHA/EPA</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">300-600mg DHA + 150mg EPA daily. Supports brain health &amp; reduces hot flashes.</p>
            </div>
        </div>
        <!-- B12 -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Vitamin B12" src="/assets/vitamin_b12_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Essentials</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Vitamin B12</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">1,000 mcg 3x weekly. Supports energy levels and nerve function.</p>
            </div>
        </div>
    </div>


    <h3 style="color:var(--text-muted); margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px;">General Vitality (Optional)</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px;">
        <!-- Iron -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Iron Bisglycinate" src="/assets/iron_bisglycinate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Deficiency Only</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Iron Bisglycinate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">18-25mg every other day (ONLY if deficient). Pair with Vit C for absorption.</p>
            </div>
        </div>
        <!-- Calcium -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Calcium Citrate" src="/assets/calcium_citrate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Bone Health</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Calcium Citrate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">500mg Ca + 2000IU D3 + 90mcg K2. Critical for bone density protection.</p>
            </div>
        </div>
        <!-- Zinc -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Zinc" src="/assets/zinc_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Immunity</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Zinc</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">15mg alternating days. Supports thyroid function. Take with food.</p>
            </div>
        </div>
        <!-- Selenium -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Selenium" src="/assets/selenium_brazil_nut.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Thyroid</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Selenium</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">100mcg (or 1 Brazil nut) alternating days. Key for thyroid conversion.</p>
            </div>
        </div>
        <!-- Iodine -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Iodine (Kelp)" src="/assets/iodine_kelp_granules.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Thyroid</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Iodine (Kelp)</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">150mcg kelp granules (ONLY if deficient). Supports thyroid hormones.</p>
            </div>
        </div>
        <!-- Maca -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Maca" src="/assets/maca_powder.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Hormone Balance</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Maca</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">1 tsp morning (Gelatinized). Adaptogen for mood, energy, and libido.</p>
            </div>
        </div>
        <!-- Flax -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Ground Flax" src="/assets/ground_flax_seeds.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Daily Essential</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Ground Flax</h4>
                <p id="flax-description" style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">1-2 tbsp daily. Rich in lignans to help balance estrogen.</p>
            </div>
        </div>
        <!-- Creatine -->
        <div class="card" style="margin-bottom: 0; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;">
            <div style="height: 180px; overflow: hidden; position: relative;"><img alt="Creatine Monohydrate" src="/assets/creatine_monohydrate_supp.png" style="width: 100%; height: 100%; object-fit: cover;"/></div>
            <div class="card-body" style="padding: 20px; opacity: 1; max-height: none; flex-grow: 1; display: flex; flex-direction: column;">
                <span style="background: #f0f4f8; color: var(--primary-light); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; margin-bottom: 10px; text-transform: uppercase;">Muscle & Brain</span>
                <h4 style="margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;">Creatine Monohydrate</h4>
                <p style="font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 0;">3-5g daily. Vital for vegans: supports muscle retention, bone density, and cognitive function.</p>
            </div>
        </div>
    </div>
</div>
<div class="view-section" id="swaps">
<h1 style="text-align: center; margin-bottom: 20px;">Quick Swaps</h1>
<div class="card">
<div class="card-body active" style="max-height:2000px; padding:0; opacity:1; overflow:hidden;">
<div style="padding: 30px 30px 20px 30px; background: linear-gradient(to bottom, #fdfbf7, #ffffff); border-bottom: 1px solid rgba(0,0,0,0.03);">
<p style="margin: 0; text-align: center; color: var(--text-muted); font-size: 0.95rem;">Flexible options for allergies, dietary preferences, or pantry availability.</p>
</div>
<div style="overflow-x: auto;">
<table style="margin: 0; border: none; border-radius: 0;">
<thead>
<tr style="background: var(--primary);">
<th style="padding: 18px 30px; width: 40%; color: white; font-weight: 500; letter-spacing: 0.5px;">Original Item</th>
<th style="padding: 18px 30px; width: 60%; color: white; font-weight: 500; letter-spacing: 0.5px;">Alternative Options</th>
</tr>
</thead>
<tbody>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Almond Yogurt</td>
<td style="padding: 15px 30px;">Coconut or Oat yogurt</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Ashwagandha</td>
<td style="padding: 15px 30px;">Maca powder or simply skip</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Cassava Flour</td>
<td style="padding: 15px 30px;">Chickpea or Rice flour</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Cauliflower <span style="font-size:0.8em; color:var(--text-muted); font-weight:400;">(Low FODMAP)</span></td>
<td style="padding: 15px 30px;">Zucchini</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Chickpeas <span style="font-size:0.8em; color:var(--text-muted); font-weight:400;">(Low FODMAP)</span></td>
<td style="padding: 15px 30px;">Firm tofu</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Coconut Aminos</td>
<td style="padding: 15px 30px;">Tamari or Soy sauce</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Cooked Lunches</td>
<td style="padding: 15px 30px;">Raw wraps or salads</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Dates</td>
<td style="padding: 15px 30px;">Ripe bananas</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Farro / Barley</td>
<td style="padding: 15px 30px;">Quinoa or Millet</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Garlic</td>
<td style="padding: 15px 30px;">Infused oil (adds flavor without fiber)</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Hemp Hearts</td>
<td style="padding: 15px 30px;">Sunflower, Pumpkin, or Chia seeds</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Jackfruit</td>
<td style="padding: 15px 30px;">Hearts of Palm or Tofu</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Kelp Noodles</td>
<td style="padding: 15px 30px;">Soba, Rice, or Zucchini noodles</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Lupini Beans</td>
<td style="padding: 15px 30px;">Chickpeas or Edamame</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Miso</td>
<td style="padding: 15px 30px;">Vegetable stock cube or paste</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Monk Fruit</td>
<td style="padding: 15px 30px;">Stevia, Maple syrup, or Coconut sugar</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Nutritional Yeast</td>
<td style="padding: 15px 30px;">A small pinch of Miso</td>
</tr>
<tr style="background: #fafafa;">
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Tempeh</td>
<td style="padding: 15px 30px;">Tofu, Seitan, or Chickpeas</td>
</tr>
<tr>
<td style="padding: 15px 30px; font-weight: 600; color: var(--primary);">Tofu</td>
<td style="padding: 15px 30px;">Chickpea tofu, Lupini beans, or Seitan</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="view-section" id="shopping">
<h1>Shopping Lists</h1>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 1 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Asparagus</li><li onclick="this.classList.toggle('checked')">Avocado</li><li onclick="this.classList.toggle('checked')">Baby Greens</li><li onclick="this.classList.toggle('checked')">Basil</li><li onclick="this.classList.toggle('checked')">Bean Sprouts</li><li onclick="this.classList.toggle('checked')">Bok Choy</li><li onclick="this.classList.toggle('checked')">Broccoli</li><li onclick="this.classList.toggle('checked')">Carrots</li><li onclick="this.classList.toggle('checked')">Cauliflower</li><li onclick="this.classList.toggle('checked')">Collard Greens</li><li onclick="this.classList.toggle('checked')">Cucumber</li><li onclick="this.classList.toggle('checked')">Delicata Squash</li><li onclick="this.classList.toggle('checked')">Dill</li><li onclick="this.classList.toggle('checked')">Fennel</li><li onclick="this.classList.toggle('checked')">Garlic</li><li onclick="this.classList.toggle('checked')">Ginger</li><li onclick="this.classList.toggle('checked')">Lemons</li><li onclick="this.classList.toggle('checked')">Limes</li><li onclick="this.classList.toggle('checked')">Mint</li><li onclick="this.classList.toggle('checked')">Mixed Berries</li><li onclick="this.classList.toggle('checked')">Mung Sprouts</li><li onclick="this.classList.toggle('checked')">Onion</li><li onclick="this.classList.toggle('checked')">Parsley</li><li onclick="this.classList.toggle('checked')">Pear</li><li onclick="this.classList.toggle('checked')">Scallions</li><li onclick="this.classList.toggle('checked')">Shiitake Mushrooms</li><li onclick="this.classList.toggle('checked')">Spinach</li><li onclick="this.classList.toggle('checked')">Zucchini</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Almond Butter</li><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Aloe Vera Juice</li><li onclick="this.classList.toggle('checked')">Artichoke Hearts</li><li onclick="this.classList.toggle('checked')">Brazil Nuts</li><li onclick="this.classList.toggle('checked')">Chamomile Tea</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Chickpeas</li><li onclick="this.classList.toggle('checked')">Cinnamon</li><li onclick="this.classList.toggle('checked')">Coconut Milk</li><li onclick="this.classList.toggle('checked')">Coconut Oil</li><li onclick="this.classList.toggle('checked')">Cranberries</li><li onclick="this.classList.toggle('checked')">Curry Paste</li><li onclick="this.classList.toggle('checked')">Edamame</li><li onclick="this.classList.toggle('checked')">Flaxseed</li><li onclick="this.classList.toggle('checked')">Lemon Balm Tea</li><li onclick="this.classList.toggle('checked')">Maca</li><li onclick="this.classList.toggle('checked')">Magnesium</li><li onclick="this.classList.toggle('checked')">Maple Syrup</li><li onclick="this.classList.toggle('checked')">Miso</li><li onclick="this.classList.toggle('checked')">Nori</li><li onclick="this.classList.toggle('checked')">Pea Protein</li><li onclick="this.classList.toggle('checked')">Pesto</li><li onclick="this.classList.toggle('checked')">Pumpkin Seeds</li><li onclick="this.classList.toggle('checked')">Quinoa</li><li onclick="this.classList.toggle('checked')">Red Lentils</li><li onclick="this.classList.toggle('checked')">Sesame Oil</li><li onclick="this.classList.toggle('checked')">Star Anise</li><li onclick="this.classList.toggle('checked')">Tamari</li><li onclick="this.classList.toggle('checked')">Tempeh</li><li onclick="this.classList.toggle('checked')">Tofu (Firm)</li><li onclick="this.classList.toggle('checked')">Triphala</li><li onclick="this.classList.toggle('checked')">Vegetable Broth</li><li onclick="this.classList.toggle('checked')">Wakame</li><li onclick="this.classList.toggle('checked')">White Beans</li></ul></div></div></div></div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 2 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Apples</li><li onclick="this.classList.toggle('checked')">Asparagus</li><li onclick="this.classList.toggle('checked')">Avocado</li><li onclick="this.classList.toggle('checked')">Blueberries</li><li onclick="this.classList.toggle('checked')">Brussels Sprouts</li><li onclick="this.classList.toggle('checked')">Cauliflower</li><li onclick="this.classList.toggle('checked')">Cherries</li><li onclick="this.classList.toggle('checked')">Cucumber</li><li onclick="this.classList.toggle('checked')">Eggplant</li><li onclick="this.classList.toggle('checked')">Fennel</li><li onclick="this.classList.toggle('checked')">Green Beans</li><li onclick="this.classList.toggle('checked')">Limes</li><li onclick="this.classList.toggle('checked')">Onion</li><li onclick="this.classList.toggle('checked')">Orange</li><li onclick="this.classList.toggle('checked')">Pears</li><li onclick="this.classList.toggle('checked')">Pomegranate</li><li onclick="this.classList.toggle('checked')">Raspberries</li><li onclick="this.classList.toggle('checked')">Spinach</li><li onclick="this.classList.toggle('checked')">Sweet Potato</li><li onclick="this.classList.toggle('checked')">Tomatoes</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Black Rice</li><li onclick="this.classList.toggle('checked')">Buckwheat</li><li onclick="this.classList.toggle('checked')">Cacao Powder</li><li onclick="this.classList.toggle('checked')">Cardamom</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Chili Powder</li><li onclick="this.classList.toggle('checked')">Cinnamon</li><li onclick="this.classList.toggle('checked')">Edamame</li><li onclick="this.classList.toggle('checked')">Farro</li><li onclick="this.classList.toggle('checked')">Hemp Yogurt</li><li onclick="this.classList.toggle('checked')">Kidney Beans</li><li onclick="this.classList.toggle('checked')">Lavender Tea</li><li onclick="this.classList.toggle('checked')">Lentils</li><li onclick="this.classList.toggle('checked')">Maca</li><li onclick="this.classList.toggle('checked')">Monk Fruit</li><li onclick="this.classList.toggle('checked')">Nori</li><li onclick="this.classList.toggle('checked')">Oats</li><li onclick="this.classList.toggle('checked')">Pea Protein</li><li onclick="this.classList.toggle('checked')">Pepitas</li><li onclick="this.classList.toggle('checked')">Pesto</li><li onclick="this.classList.toggle('checked')">Reishi</li><li onclick="this.classList.toggle('checked')">Sage</li><li onclick="this.classList.toggle('checked')">Seitan</li><li onclick="this.classList.toggle('checked')">Sesame Oil</li><li onclick="this.classList.toggle('checked')">Smoked Tofu</li><li onclick="this.classList.toggle('checked')">Spirulina</li><li onclick="this.classList.toggle('checked')">Tahini</li><li onclick="this.classList.toggle('checked')">Tamari</li><li onclick="this.classList.toggle('checked')">Tempeh</li><li onclick="this.classList.toggle('checked')">Tulsi Tea</li><li onclick="this.classList.toggle('checked')">Walnuts</li></ul></div></div></div></div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 3 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Apple</li><li onclick="this.classList.toggle('checked')">Apricots</li><li onclick="this.classList.toggle('checked')">Avocado</li><li onclick="this.classList.toggle('checked')">Banana</li><li onclick="this.classList.toggle('checked')">Broccoli</li><li onclick="this.classList.toggle('checked')">Carrot</li><li onclick="this.classList.toggle('checked')">Cauliflower</li><li onclick="this.classList.toggle('checked')">Cucumber</li><li onclick="this.classList.toggle('checked')">Dandelion Root</li><li onclick="this.classList.toggle('checked')">Ginger</li><li onclick="this.classList.toggle('checked')">Grapefruit</li><li onclick="this.classList.toggle('checked')">Holy Basil</li><li onclick="this.classList.toggle('checked')">Kale</li><li onclick="this.classList.toggle('checked')">Mint</li><li onclick="this.classList.toggle('checked')">Rosemary</li><li onclick="this.classList.toggle('checked')">Sweet Potato</li><li onclick="this.classList.toggle('checked')">Thai Basil</li><li onclick="this.classList.toggle('checked')">Tomato</li><li onclick="this.classList.toggle('checked')">Zucchini</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">ACV</li><li onclick="this.classList.toggle('checked')">Almond Butter</li><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Beluga Lentils</li><li onclick="this.classList.toggle('checked')">Cacao Powder</li><li onclick="this.classList.toggle('checked')">Cannellini Beans</li><li onclick="this.classList.toggle('checked')">Cashews (Butter & Whole)</li><li onclick="this.classList.toggle('checked')">Cayenne</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Chickpea Flour</li><li onclick="this.classList.toggle('checked')">Chickpeas</li><li onclick="this.classList.toggle('checked')">Chili Powder</li><li onclick="this.classList.toggle('checked')">Coconut Cream</li><li onclick="this.classList.toggle('checked')">Coconut Milk</li><li onclick="this.classList.toggle('checked')">Coconut Oil</li><li onclick="this.classList.toggle('checked')">Coconut Yogurt</li><li onclick="this.classList.toggle('checked')">Cold Brew Coffee</li><li onclick="this.classList.toggle('checked')">Dandelion Root Powder</li><li onclick="this.classList.toggle('checked')">Fennel Seeds/Tea</li><li onclick="this.classList.toggle('checked')">Kimchi</li><li onclick="this.classList.toggle('checked')">Maple Syrup</li><li onclick="this.classList.toggle('checked')">Millet</li><li onclick="this.classList.toggle('checked')">Miso</li><li onclick="this.classList.toggle('checked')">Pea Protein</li><li onclick="this.classList.toggle('checked')">Pumpkin Seeds</li><li onclick="this.classList.toggle('checked')">Quinoa</li><li onclick="this.classList.toggle('checked')">Romesco Sauce</li><li onclick="this.classList.toggle('checked')">Tahini</li><li onclick="this.classList.toggle('checked')">Tofu</li><li onclick="this.classList.toggle('checked')">Walnuts</li></ul></div></div></div></div>
<div class="card"><div class="card-header" onclick="toggleCard(this)"><div class="meal-title">Week 4 List</div><div class="expand-icon">+</div></div>
<div class="card-body">
<div class="shopping-grid">
<div class="shopping-category">
<h4>Produce</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Banana</li><li onclick="this.classList.toggle('checked')">Carrots</li><li onclick="this.classList.toggle('checked')">Lemon Balm</li><li onclick="this.classList.toggle('checked')">Mushrooms (Shiitake/Button)</li><li onclick="this.classList.toggle('checked')">Orange</li><li onclick="this.classList.toggle('checked')">Raspberries</li><li onclick="this.classList.toggle('checked')">Rocket</li><li onclick="this.classList.toggle('checked')">Root Vegetables</li><li onclick="this.classList.toggle('checked')">Rosemary</li><li onclick="this.classList.toggle('checked')">Sage</li><li onclick="this.classList.toggle('checked')">Squash (Spaghetti)</li><li onclick="this.classList.toggle('checked')">Tart Cherry Juice</li></ul></div>
<div class="shopping-category">
<h4>Pantry & Protein</h4>
<ul class="check-list"><li onclick="this.classList.toggle('checked')">Almond Milk</li><li onclick="this.classList.toggle('checked')">Almonds</li><li onclick="this.classList.toggle('checked')">Buckwheat Flour</li><li onclick="this.classList.toggle('checked')">Cacao Powder</li><li onclick="this.classList.toggle('checked')">Cashews</li><li onclick="this.classList.toggle('checked')">Cassava Flour</li><li onclick="this.classList.toggle('checked')">Chia Seeds</li><li onclick="this.classList.toggle('checked')">Coconut Flour</li><li onclick="this.classList.toggle('checked')">Coconut Yogurt</li><li onclick="this.classList.toggle('checked')">Dark Chocolate</li><li onclick="this.classList.toggle('checked')">Dates</li><li onclick="this.classList.toggle('checked')">Gnocchi</li><li onclick="this.classList.toggle('checked')">Kava Tea</li><li onclick="this.classList.toggle('checked')">Lentils</li><li onclick="this.classList.toggle('checked')">Magnesium</li><li onclick="this.classList.toggle('checked')">Miso</li><li onclick="this.classList.toggle('checked')">Oats</li><li onclick="this.classList.toggle('checked')">Pepitas</li><li onclick="this.classList.toggle('checked')">Rice Noodles</li><li onclick="this.classList.toggle('checked')">Seeded Bread</li><li onclick="this.classList.toggle('checked')">Soba Noodles</li><li onclick="this.classList.toggle('checked')">Sourdough Bread</li><li onclick="this.classList.toggle('checked')">Tart Cherry</li><li onclick="this.classList.toggle('checked')">Tempeh</li><li onclick="this.classList.toggle('checked')">Tofu</li><li onclick="this.classList.toggle('checked')">Tomato Sauce</li><li onclick="this.classList.toggle('checked')">Valerian Tea</li><li onclick="this.classList.toggle('checked')">Walnuts</li><li onclick="this.classList.toggle('checked')">White Beans</li></ul></div></div></div></div>
</div>
<!-- Sleep Protocol Section -->
<div class="view-section" id="sleep">
    <div class="sleep-hero">
        <h1 style="color:white; margin-bottom:10px;">The Adrenal Sleep Architecture</h1>
        <p style="font-size:1.15rem; opacity:0.9; max-width:600px; margin:0 auto;">Use this specific sequence to lower your core body temperature and signal safety to your nervous system.</p>
        
        <div class="glass-effect">
            <span style="font-size:2rem; display:block; margin-bottom:10px;">???</span>
            <strong>Why Temperature Matters:</strong> Deep sleep only occurs when your core temperature drops by 2-3F. Cortisol keeps you hot. This routine forces the drop.
        </div>
    </div>

    <!-- Wind Down Routine -->
    <div class="section-title">
        <div class="section-number">1</div>
        <h2>The Wind Down Routine</h2>
    </div>

    <div style="margin-bottom: 60px;">
        <div class="timeline-item">
            <div class="timeline-time">12:00 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">The Caffeine Hard Stop</span>
                Switch to herbal tea or water. Caffeine has a quarter-life of 12 hours. Drinking it at 2PM means 25% is still active in your brain at 2AM, blocking deep sleep.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">7:00 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">Kitchen Closed</span>
                Finish your last meal 3 hours before bed. Digestion is a thermogenic (heat-producing) process. We need your body cool to initiate sleep.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">8:30 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">The Blue Light Block</span>
                Laptops closed. Phone on 'Night Shift' or 'Eye Comfort' mode. Blue light stimulates the same cortisol receptors as sunlight.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">9:00 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">Thermal Dump Shower</span>
                Take a <strong>warm</strong> shower or bath. When you step out into cool air, your body heat rapidly dissipates. This steep drop mimics the biological signal for sleep onset.
            </div>
        </div>
        <div class="timeline-item">
            <div class="timeline-time">9:45 PM</div>
            <div class="timeline-content">
                <span class="timeline-title">The Brain Dump</span>
                Write down your top 3 'Must Do' items for tomorrow on paper. Get them out of your head so your Reticular Activating System (brain's alarm) can stand down.
            </div>
        </div>
    </div>

    <!-- Adrenal Mocktail Feature -->
    <div class="section-title">
        <div class="section-number">2</div>
        <h2>Your Sleep Cocktail</h2>
    </div>

    <div class="recipe-card">
        <div style="font-size: 5rem; line-height: 1;">??</div>
        <div style="flex-grow:1;">
            <h3 style="color:var(--primary); margin-top:0;">The 'Adrenal Mocktail'</h3>
            <p>Drink this 1 hour before bed instead of wine. It provides the building blocks for melatonin without the blood sugar crash.</p>
            <ul style="margin-bottom:0;">
                <li><strong>1/2 cup Tart Cherry Juice</strong> (Natural source of Melatonin)</li>
                <li><strong>1 scoop Magnesium Glycinate</strong> (The relaxation mineral)</li>
                <li><strong>Pinch of Sea Salt</strong> (Lowers adrenaline)</li>
                <li><strong>Sparkling Water</strong></li>
            </ul>
        </div>
    </div>

    <!-- 3AM Protocol -->
     <div class="section-title">
        <div class="section-number">3</div>
        <h2>The 3 A.M. Emergency Protocol</h2>
    </div>
    
    <div class="rescue-card">
        <h4 style="color:#c53030; margin-top:0; display:flex; align-items:center; gap:10px;">? Woke up wired?</h4>
        <p>This is a liver glycogen crash causing an adrenaline spike. <strong>Do NOT look at the clock.</strong> Looking at the time engages your logical brain and wakefulness.</p>
        <p style="font-weight:600; margin-bottom:5px;">Try this:</p>
        <ol style="margin-top:0; padding-left:20px;">
            <li style="margin-bottom:5px;"><strong>Physiological Sigh:</strong> Two sharp inhales through nose, one long exhale through mouth. Repeat 3 times.</li>
            <li style="margin-bottom:5px;"><strong>Cool the Palm:</strong> Stick a foot or hand out from the covers to dump heat.</li>
            <li><strong>Last Resort:</strong> If awake >20 mins, get up and do a boring task (fold laundry) in dim light until tired.</li>
        </ol>
    </div>

    <!-- Bedroom Setup Checklist -->
    <div class="section-title" style="margin-top:60px;">
        <div class="section-number">4</div>
        <h2>Bedroom Sanctuary Checklist</h2>
    </div>

    <div class="checklist-grid">
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>Temperature Drop</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Set thermostat to 65-68F (18-20C). Cool rooms promote deeper REM cycles.</span>
            </div>
        </div>
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>Total Blackout</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Cover all LEDs (even the TV standby light). Use blackout curtains or a sleep mask.</span>
            </div>
        </div>
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>Phone Quarantine</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Charge your phone in the bathroom or hallway, not on the nightstand.</span>
            </div>
        </div>
        <div class="check-item">
            <div class="check-box"></div>
            <div>
                <strong>White Noise</strong><br>
                <span style="font-size:0.9rem; color:var(--text-muted);">Use a fan or sound machine to mask sudden noises that trigger 'light sleeper' wakeups.</span>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 50px; text-align: center;">
         <p style="color:var(--text-muted);">Prefer a printed copy?</p>
         <a href="adrenal_sleep_guide.html" target="_blank" style="text-decoration:none;"><button style="background:var(--primary); color:white; border:none; padding:12px 25px; border-radius:50px; cursor:pointer; font-size:1rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='var(--primary)'">Download Printable Guide</button></a>
    </div>

        </div> <!-- End meals-content-container -->
    </div> <!-- End view-meals -->

    <!-- Placeholder for moved sections (Movement, Support) - they will be moved here by JS -->
    <!-- Duplicate movement view removed -->

    <!-- INSTALL APP BANNER (Hidden by default) -->
    <!-- INSTALL APP BANNER MOVED TO FOOTER FOR FIXED POSITIONING -->


    <!-- SUPPORT VIEW REMOVED - Coach Chat moved to modal -->

    <!-- ACTIVE WORKOUT PLAYER (Hidden by default) -->
    <div id="view-active-workout-stub" class="app-view" style="display:none; background: #fff; padding-bottom: 0;">
        <!-- Workout Header -->
        <div style="position: sticky; top:0; z-index:100; background:white; border-bottom:1px solid #eee; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <div onclick="quitWorkout()" style="cursor:pointer; color:var(--text-muted);">✕</div>
            <div style="font-weight:700;" id="stub-workout-player-title">Workout</div>
            <div style="font-family:monospace; font-size:1.1rem; color:var(--primary);" id="stub-workout-timer">00:00</div>
        </div>

        <!-- Video Player Stub -->
        <div style="width:100%; height:220px; background:black; display:flex; align-items:center; justify-content:center; position:relative;">
            <div id="stub-workout-video-placeholder" style="color:white; text-align:center;">
                <div style="font-size:3rem;">▶</div>
                <div>Play Video Tutorial</div>
            </div>
            <!-- In real app, proper video tag here -->
        </div>

        <!-- Exercise List -->
        <div id="stub-workout-exercises-list" style="padding: 20px; padding-bottom: 100px;">
            <!-- Dynamic Content Injected Here -->
        </div>

        <!-- Finish Bar -->
        <div style="position: fixed; bottom:0; left:0; width:100%; padding: 20px; background:white; border-top:1px solid #eee; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 50;">
            <button onclick="finishWorkout()" class="btn-primary" style="width:100%; border-radius:30px; touch-action: manipulation; user-select: none; min-height: 56px; cursor: pointer;">FINISH WORKOUT</button>
        </div>
    </div>

    <!-- WORKOUT SUCCESS SCREEN -->
    <div id="view-workout-success-stub" class="app-view" style="display:none; background: var(--primary); color:white; text-align:center; flex-direction:column; align-items:center; justify-content:center; height:100%;">
        <div style="font-size: 5rem; margin-bottom: 20px;">🎉</div>
        <h1 style="font-family: 'Playfair Display'; font-size: 3rem; margin-bottom: 10px;">High Five!</h1>
        <p style="font-size: 1.2rem; opacity: 0.9;">Workout Complete</p>
        <div style="margin-top: 40px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 16px;">
            <div style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Duration</div>
            <div style="font-size: 2rem; font-weight: 700;" id="stub-success-duration">24:00</div>
        </div>
        <button onclick="closeSuccessScreen()" style="margin-top: 50px; background: white; color: var(--primary); border:none; padding: 15px 40px; border-radius: 30px; font-weight: 700; font-size: 1rem; cursor: pointer;">DONE</button>
    </div>

    <style>
        /* Workout Logger Styles */
        .exercise-logger-card {
            border: 1px solid #eee;
            border-radius: 12px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        .exercise-header {
            background: #f8fafc;
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .set-row {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f1f5f9;
            gap: 10px;
        }
        .set-col-label {
            font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; text-align: center;
        }
        .set-input {
            background: #f1f5f9;
            border: 1px solid transparent;
            border-radius: 6px;
            text-align: center;
            padding: 8px;
            width: 100%;
            font-weight: 600;
            color: var(--text-main);
        }
        .set-input:focus { background: white; border-color: var(--primary); outline: none; }
        .set-check {
            width: 35px; height: 35px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: transparent;
            transition: all 0.2s;
        }
        .set-check.completed {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Drop Set Styles */
        .drop-set-toggle {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.6rem;
            font-weight: 800;
            color: #94a3b8;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .drop-set-toggle:hover {
            border-color: #f97316;
            color: #f97316;
        }
        .drop-set-toggle.active {
            background: #f97316;
            border-color: #f97316;
            color: white;
        }
        .drop-set-container {
            display: none;
            padding: 8px 15px 8px 50px;
            background: #fef3e2;
            border-top: 1px dashed #f97316;
        }
        .drop-set-container.visible {
            display: block;
        }
        .drop-set-row {
            display: grid;
            grid-template-columns: 24px 1fr 1fr 24px;
            gap: 8px;
            align-items: center;
            padding: 6px 0;
        }
        .drop-set-row input {
            width: 100%;
            border: none;
            background: white;
            border-radius: 6px;
            padding: 8px 5px;
            text-align: center;
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.85rem;
        }
        .drop-indicator {
            font-size: 0.7rem;
            color: #f97316;
            font-weight: 800;
            text-align: center;
        }
        .drop-add-btn, .drop-remove-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
        }
        .drop-add-btn {
            background: #dcfce7;
            color: #16a34a;
        }
        .drop-remove-btn {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Day Completion Modal */
        .completion-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.5s ease-out;
        }
        .completion-modal {
            background: white;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: popUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 4px solid var(--secondary);
        }
        @keyframes popUp {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .confetti-piece {
            position: absolute;
            width: 10px; height: 10px;
            background: #ffd700;
            top: -10px;
            z-index: 10000;
        }
    </style>

    <!-- DAY COMPLETION MODAL -->
    <div id="day-completion-modal" class="completion-modal-overlay">
        <div class="completion-modal">
            <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce 1s infinite;">??</div>
            <h2 style="color: var(--primary); font-size: 1.8rem; margin: 0 0 10px 0;">Day Complete!</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;" id="completion-text">You have successfully finished Day 1.</p>
            
            <div style="background: #f0fdf4; padding: 15px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #bbf7d0;">
                <div style="font-size: 0.9rem; color: #166534; font-weight: 600;">Cortisol Level: Stabilizing ??</div>
            </div>

            <button onclick="closeCompletionModal()" style="background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-weight: 700; font-size: 1.1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(4, 106, 56, 0.3);">
                CONTINUE
            </button>
        </div>
    </div>


<!-- MOVEMENT VIEW (Shared Main Tab) -->
<div id="movement-tab" class="app-view" style="display:none;">
    <div class="app-header">
        <div class="app-logo">Movement Studio</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="coin-header-widget" onclick="openCoinShop()">
                <span class="coin-emoji">🪙</span>
                <span class="coin-amount coin-balance-sync">0</span>
                <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
            </div>
            <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
        </div>
    </div>
    
    <div style="padding: 25px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
            <div>
                <h1 style="color:var(--primary); margin:0; font-size:2rem; letter-spacing:-1px;">Movement</h1>
            </div>
            <!-- Button Removed -->
        </div>

        <!-- Weekly Workout Trend Card (Movement Tab) -->
        <div id="movement-workout-trend-card" style="display: none; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 16px; padding: 18px 20px; color: white; position: relative; overflow: hidden; margin-bottom: 20px;">
            <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
            <button onclick="dismissMovementTrendCard()" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; padding: 0; z-index: 2;">&#x2715;</button>
            <div style="position: relative; z-index: 1;">
                <div style="font-weight: 700; font-size: 1rem; margin-bottom: 10px;">Your Workout Trend</div>
                <div id="movement-trend-stats" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 10px; text-align: center;">
                        <div id="movement-trend-week-count" style="font-size: 1.4rem; font-weight: 700;">0</div>
                        <div style="font-size: 0.7rem; opacity: 0.85;">This Week</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 10px; text-align: center;">
                        <div id="movement-trend-total-count" style="font-size: 1.4rem; font-weight: 700;">0</div>
                        <div style="font-size: 0.7rem; opacity: 0.85;">All Time</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 10px; text-align: center;">
                        <div id="movement-trend-streak" style="font-size: 1.4rem; font-weight: 700;">0</div>
                        <div style="font-size: 0.7rem; opacity: 0.85;">Week Streak</div>
                    </div>
                </div>
                <div id="movement-trend-insight" style="font-size: 0.82rem; opacity: 0.9; line-height: 1.4;"></div>
            </div>
        </div>

        <!-- Dynamic Grid Container -->
        <div id="movement-grid-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>

        <!-- Weekly Trends Button -->
        <button class="weekly-trends-btn" onclick="openMovementWeeklyTrendsPage()" style="margin-top: 25px;">
            <span class="weekly-trends-btn-left">
                <span style="font-size: 1.3rem;">📊</span>
                <span>Weekly Trends</span>
            </span>
            <span class="weekly-trends-btn-arrow">&#x203A;</span>
        </button>

        <!-- Workout Feedback Insights Card -->
        <div id="workout-insights-card" style="display:none; margin-top:15px; background:white; border-radius:16px; padding:18px 20px; border:1px solid #e2e8f0; box-shadow:0 2px 8px rgba(0,0,0,0.04);">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;">
                <div style="font-weight:700; font-size:1rem; color:var(--text-main); display:flex; align-items:center; gap:8px;">
                    <span style="font-size:1.2rem;">💬</span> Body Feedback
                </div>
                <span id="insights-period" style="font-size:0.75rem; color:var(--text-muted);">Last 30 days</span>
            </div>

            <!-- Average gauges -->
            <div id="insights-gauges" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:14px;">
                <div style="text-align:center; padding:10px 6px; background:#f8fafc; border-radius:10px;">
                    <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:4px;">Feeling</div>
                    <div id="insight-avg-feeling" style="font-size:1.4rem; font-weight:700; color:var(--primary);">-</div>
                    <div id="insight-avg-feeling-emoji" style="font-size:1rem;">-</div>
                </div>
                <div style="text-align:center; padding:10px 6px; background:#f8fafc; border-radius:10px;">
                    <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:4px;">Difficulty</div>
                    <div id="insight-avg-difficulty" style="font-size:1.4rem; font-weight:700; color:#6366f1;">-</div>
                    <div id="insight-avg-difficulty-emoji" style="font-size:1rem;">-</div>
                </div>
                <div style="text-align:center; padding:10px 6px; background:#f8fafc; border-radius:10px;">
                    <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:4px;">Energy</div>
                    <div id="insight-avg-energy" style="font-size:1.4rem; font-weight:700; color:#f59e0b;">-</div>
                    <div id="insight-avg-energy-emoji" style="font-size:1rem;">-</div>
                </div>
            </div>

            <!-- Intensity preference bar -->
            <div id="insights-intensity-bar" style="margin-bottom:10px;">
                <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:6px; font-weight:600;">Next time intensity preference</div>
                <div style="display:flex; height:8px; border-radius:4px; overflow:hidden; background:#f1f5f9;">
                    <div id="insight-bar-lighter" style="background:#60a5fa; height:100%; transition:width 0.3s;" title="Lighter"></div>
                    <div id="insight-bar-perfect" style="background:#22c55e; height:100%; transition:width 0.3s;" title="Same"></div>
                    <div id="insight-bar-harder" style="background:#f97316; height:100%; transition:width 0.3s;" title="Harder"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.65rem; color:var(--text-muted); margin-top:3px;">
                    <span id="insight-lighter-pct">Lighter</span>
                    <span id="insight-perfect-pct">Same</span>
                    <span id="insight-harder-pct">Harder</span>
                </div>
            </div>

            <!-- Alert if overtraining detected -->
            <div id="insights-alert" style="display:none; padding:10px 14px; border-radius:10px; background:#fef3c7; border:1px solid #fbbf24; margin-top:10px;">
                <div style="font-size:0.85rem; font-weight:600; color:#92400e;" id="insights-alert-text"></div>
            </div>

            <!-- Recent ratings -->
            <div id="insights-recent" style="margin-top:12px;"></div>
        </div>
    </div>
</div>

<!-- Movement Weekly Trends Page (full-screen overlay) -->
<div class="weekly-trends-page" id="movement-weekly-trends-page">
    <div class="weekly-trends-page-header">
        <span class="weekly-trends-page-title">Movement Trends</span>
    </div>
    <div class="weekly-trends-page-content">
        <!-- Weekly Summary -->
        <div class="weekly-metrics-card" style="padding: 20px; background: linear-gradient(135deg, #f0f0ff 0%, #e8e0f0 100%); border-radius: 12px; border: 1px solid #d4d0e0; margin-bottom: 20px;">
            <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                Weekly Summary
            </h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Workouts</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1;"><span id="mvmt-weekly-workouts">0</span></div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Total Exercises</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1;"><span id="mvmt-weekly-exercises">0</span></div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Active Days</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #6366f1;"><span id="mvmt-weekly-active-days">0</span>/7</div>
                </div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 12px;">Last 7 Days</div>
                <div id="mvmt-weekly-daily-breakdown">
                    <p style="text-align: center; color: var(--text-muted); padding: 20px 0;">Loading workout data...</p>
                </div>
            </div>
        </div>

        <!-- Workout Journal -->
        <div class="meal-journal-card" id="mvmt-workout-journal-section">
            <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: var(--text-main);">Workout Journal</h3>
            <p style="margin: 0; font-size: 0.78rem; color: var(--text-muted);">Your recent workouts at a glance</p>
            <div class="journal-timeline" id="mvmt-workout-journal-timeline" style="gap: 10px;">
                <p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Loading your workouts...</p>
            </div>
        </div>

        <!-- Multi-Week Trends -->
        <div class="multi-week-card" id="mvmt-multi-week-section">
            <div class="multi-week-header">
                <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-main);">Weekly Trends</h3>
                <div class="multi-week-nav" id="mvmt-multi-week-nav">
                    <button class="active" onclick="loadMovementMultiWeekData(4)">4 Weeks</button>
                    <button onclick="loadMovementMultiWeekData(8)">8 Weeks</button>
                </div>
            </div>
            <div id="mvmt-multi-week-sparklines">
                <p style="text-align: center; color: var(--text-muted); padding: 20px 0; font-size: 0.85rem;">Loading trend data...</p>
            </div>
            <div class="week-compare-grid" id="mvmt-week-compare-grid">
            </div>
        </div>

        <!-- Workout Pattern Analysis -->
        <div class="meal-pattern-card" id="mvmt-workout-pattern-section">
            <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: var(--text-main);">Workout Patterns</h3>
            <p style="margin: 0 0 14px 0; font-size: 0.78rem; color: var(--text-muted);">Insights from your last 7 days</p>
            <div id="mvmt-workout-pattern-insights">
                <p style="text-align: center; color: var(--text-muted); padding: 12px 0; font-size: 0.85rem;">Log more workouts to see patterns</p>
            </div>
        </div>
    </div>
</div>

<!-- MOVED CHECK-IN MODAL TO BODY ROOT -->

<style>
    .checkin-btn.selected {
        border-color: var(--primary) !important;
        background: #f0fdf4 !important;
        color: var(--primary);
    }
</style>





<script>
let customWorkoutSelection = [];

function openWorkoutBuilder() {
    customWorkoutSelection = []; // Reset on open
    document.getElementById('builder-search').value = '';
    filterExerciseLibrary('');
    updateBuilderUI();
    hideAllAppViews();
    document.getElementById('view-workout-builder').style.display = 'block';
    document.querySelector('.bottom-nav').style.display = 'none';

    // Push navigation state for Android back button
    if (typeof pushNavigationState === 'function') {
        pushNavigationState('view-workout-builder', () => switchAppTab('movement-tab'));
    }
}

// Initialize filter state
if (typeof window.activeFilters === 'undefined') {
    window.activeFilters = {
        workoutType: [],
        equipment: [],
        muscle: []
    };
}

// Toggle filter chip
function toggleFilter(category, value) {
    const filters = window.activeFilters[category];
    const index = filters.indexOf(value);

    // Find the button element
    const btn = document.querySelector(`.filter-chip[data-category="${category}"][data-value="${value}"]`);

    if (index > -1) {
        // Remove filter
        filters.splice(index, 1);
        btn.style.background = 'white';
        btn.style.color = '#64748b';
        btn.style.borderColor = '#e2e8f0';
    } else {
        // Add filter
        filters.push(value);
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--primary)';
    }

    // Show/hide clear button
    const hasActiveFilters = Object.values(window.activeFilters).some(arr => arr.length > 0);
    document.getElementById('clear-filters-btn').style.display = hasActiveFilters ? 'block' : 'none';

    // Re-run filter
    filterExerciseLibrary(document.getElementById('builder-search').value);
}

// Clear all filters
function clearAllFilters() {
    window.activeFilters = {
        workoutType: [],
        equipment: [],
        muscle: []
    };

    // Reset all filter chip styles
    document.querySelectorAll('.filter-chip').forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#64748b';
        btn.style.borderColor = '#e2e8f0';
    });

    // Hide clear button
    document.getElementById('clear-filters-btn').style.display = 'none';

    // Re-run filter
    filterExerciseLibrary(document.getElementById('builder-search').value);
}

// Toggle filter section expand/collapse
function toggleFilterSection(sectionId) {
    const content = document.getElementById(`filter-content-${sectionId}`);
    const chevron = document.getElementById(`chevron-${sectionId}`);

    if (content.style.display === 'none') {
        content.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
    }
}

// Check if exercise matches category filter
function matchesFilter(exerciseName) {
    const nameLower = exerciseName.toLowerCase();

    // Check workout type filters
    if (window.activeFilters.workoutType.length > 0) {
        const matchesWorkoutType = window.activeFilters.workoutType.some(type => {
            if (type === 'yoga') return nameLower.includes('yoga');
            if (type === 'pilates') return nameLower.includes('pilates');
            if (type === 'cardio') return nameLower.includes('sprint') || nameLower.includes('run') || nameLower.includes('jump') || nameLower.includes('hop') || nameLower.includes('burpee');
            if (type === 'stretch') return nameLower.includes('stretch') || nameLower.includes('foam roller');
            return false;
        });
        if (!matchesWorkoutType) return false;
    }

    // Check equipment filters
    if (window.activeFilters.equipment.length > 0) {
        const matchesEquipment = window.activeFilters.equipment.some(equip => {
            if (equip === 'dumbbell') return nameLower.includes('dumbbell');
            if (equip === 'barbell') return nameLower.includes('barbell');
            if (equip === 'cable') return nameLower.includes('cable');
            if (equip === 'band') return nameLower.includes('band') || nameLower.includes('miniband');
            if (equip === 'kettlebell') return nameLower.includes('kettlebell');
            if (equip === 'machine') return nameLower.includes('machine');
            if (equip === 'bodyweight') {
                // Bodyweight = doesn't contain any equipment keywords
                return !nameLower.includes('dumbbell') &&
                       !nameLower.includes('barbell') &&
                       !nameLower.includes('cable') &&
                       !nameLower.includes('band') &&
                       !nameLower.includes('kettlebell') &&
                       !nameLower.includes('machine') &&
                       !nameLower.includes('ball') &&
                       !nameLower.includes('trx') &&
                       !nameLower.includes('sled');
            }
            return false;
        });
        if (!matchesEquipment) return false;
    }

    // Check muscle group filters
    if (window.activeFilters.muscle.length > 0) {
        const matchesMuscle = window.activeFilters.muscle.some(muscle => {
            if (muscle === 'chest') return nameLower.includes('chest') || nameLower.includes('pec') || (nameLower.includes('press') && (nameLower.includes('bench') || nameLower.includes('floor')));
            if (muscle === 'back') return nameLower.includes('back') || nameLower.includes('lat') || nameLower.includes('row') || nameLower.includes('pull up') || nameLower.includes('pullup');
            if (muscle === 'shoulders') return nameLower.includes('shoulder') || nameLower.includes('delt') || nameLower.includes('raise') || nameLower.includes('overhead press');
            if (muscle === 'arms') return nameLower.includes('bicep') || nameLower.includes('tricep') || nameLower.includes('curl') || nameLower.includes('extension') && !nameLower.includes('leg') && !nameLower.includes('back');
            if (muscle === 'core') return nameLower.includes('ab') || nameLower.includes('core') || nameLower.includes('crunch') || nameLower.includes('plank') || nameLower.includes('oblique');
            if (muscle === 'legs') return nameLower.includes('squat') || nameLower.includes('lunge') || nameLower.includes('leg') || nameLower.includes('quad') || nameLower.includes('hamstring') || nameLower.includes('calf');
            if (muscle === 'glutes') return nameLower.includes('glute') || nameLower.includes('hip') || nameLower.includes('kickback');
            return false;
        });
        if (!matchesMuscle) return false;
    }

    return true;
}

function filterExerciseLibrary(query) {
    const list = document.getElementById('builder-library-list');
    if (!list) {
        console.error("Builder library list element not found!");
        return;
    }
    list.innerHTML = '';

    // Safety check for library loading
    if (typeof EXERCISE_VIDEOS === 'undefined') {
        list.innerHTML = `
            <div style="padding:20px; text-align:center; color:red; background:#fee2e2; border-radius:12px;">
                <strong>Error: Exercise Library Not Loaded</strong><br>
                <div style="font-size:0.8rem; margin-top:5px;">Please verify 'exercise_videos.js' file exists and is in the same folder.</div>
            </div>`;
        return;
    }

    // Global or scoped state for pagination
    if(typeof window.builderLimit === 'undefined') window.builderLimit = 50;

    const terms = query.toLowerCase().split(' ').filter(t => t);

    const allKeys = Object.keys(EXERCISE_VIDEOS);
    if (allKeys.length === 0) {
        list.innerHTML = '<div style="padding:20px; text-align:center;">Library is empty.</div>';
        return;
    }

    // 1. Gather Matches (search query + category filters)
    const matchedKeys = [];
    for (let key of allKeys) {
        const keyLower = key.toLowerCase();

        // Check search query
        let matchesQuery = true;
        if (terms.length > 0) {
            for (let term of terms) {
                if (!keyLower.includes(term)) {
                    matchesQuery = false;
                    break;
                }
            }
        }

        // Check category filters
        const matchesCategories = matchesFilter(key);

        if (matchesQuery && matchesCategories) {
            matchedKeys.push(key);
        }
    }

    // 2. Sort by relevance score if there's a search query
    if (terms.length > 0) {
        matchedKeys.sort((a, b) => {
            const scoreA = scoreExerciseMatch(a, terms, query);
            const scoreB = scoreExerciseMatch(b, terms, query);
            return scoreB - scoreA;
        });
    }

    // 3. Render Selection
    const keysToRender = matchedKeys.slice(0, window.builderLimit);

    keysToRender.forEach(key => {
        const isSelected = customWorkoutSelection.includes(key);
        const div = document.createElement('div');
        div.style.cssText = `background:white; border:1px solid ${isSelected ? 'var(--primary)' : '#f1f5f9'}; padding:15px; border-radius:16px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; min-height:60px;`;
        if(isSelected) div.style.background = '#f0fdf4';

        div.innerHTML = `
            <div style="font-weight:600; font-size:0.95rem; color:var(--text-main); flex:1; padding-right:10px;">${key}</div>
            <button onclick="toggleBuilderItem(this, '${key.replace(/'/g, "\\'")}')" style="width:32px; height:32px; border-radius:50%; border:none; background:${isSelected ? 'var(--primary)' : '#f1f5f9'}; color:${isSelected ? 'white' : '#94a3b8'}; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                ${isSelected ? '✓' : '+'}
            </button>
        `;
        list.appendChild(div);
    });

    // 4. Load More Button
    if (matchedKeys.length > window.builderLimit) {
        const moreDiv = document.createElement('div');
        moreDiv.innerHTML = `<button onclick="window.builderLimit += 50; filterExerciseLibrary(document.getElementById('builder-search').value)" style="width:100%; padding:15px; border:none; background:#f1f5f9; color:var(--text-muted); font-weight:600; border-radius:12px; cursor:pointer;">Load More (${matchedKeys.length - window.builderLimit} remaining)</button>`;
        list.appendChild(moreDiv);
    }

    if (matchedKeys.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted);">No exercises found</div>';
    }
}

// Ensure limit reset on open
const originalOpenBuilder = window.openWorkoutBuilder;
window.openWorkoutBuilder = function() {
    window.builderLimit = 50;
    if(originalOpenBuilder) originalOpenBuilder(); // Recursion risk if defined by name? 
    // Wait, openWorkoutBuilder is defined above. We should edit it directly or just resetting global var here is risky.
    // Better: Update openWorkoutBuilder in a separate chunk or rely on the input handler resetting it?
    // Let's simple check: if query length < previous query? No.
    // I'll just Replace openWorkoutBuilder in a separate edit or use MultiReplace.
};

function toggleBuilderItem(btn, key) {
    const index = customWorkoutSelection.indexOf(key);
    const parent = btn.parentElement;
    
    if (index > -1) {
        customWorkoutSelection.splice(index, 1);
        parent.style.borderColor = '#f1f5f9';
        parent.style.background = 'white';
        btn.style.background = '#f1f5f9';
        btn.style.color = '#94a3b8';
        btn.innerHTML = '+';
    } else {
        customWorkoutSelection.push(key);
        parent.style.borderColor = 'var(--primary)';
        parent.style.background = '#f0fdf4';
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        btn.innerHTML = '✓';
    }
    updateBuilderUI();
}

function updateBuilderUI() {
    const floatAction = document.getElementById('builder-floating-action');
    const countSpan = document.getElementById('builder-count');
    
    if (customWorkoutSelection.length > 0) {
        floatAction.style.display = 'block';
        countSpan.innerText = customWorkoutSelection.length;
    } else {
        floatAction.style.display = 'none';
    }
}

async function startCustomBuilderWorkout() {
    if (customWorkoutSelection.length === 0) return;

    // Prompt for workout name
    const workoutName = prompt("Name your workout:");
    if (!workoutName) return; // User cancelled

    // Auto-save the workout to database
    const user = window.currentUser;
    if (user) {
        try {
            const savedWorkout = await dbHelpers.workouts.saveCustomWorkout(user.id, workoutName, {
                exercises: customWorkoutSelection,
                date: new Date().toISOString()
            });
            // Track the workout ID so any added exercises get saved back
            window.currentCustomWorkoutId = savedWorkout?.id || null;
            window.currentWorkoutName = workoutName;
            // Refresh the cache
            const savedWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
            window.savedWorkoutsCache = savedWorkouts;
            // Preload workout history for previous stats and volume tracking
            const rawHistory1 = await dbHelpers.workouts.getHistory(user.id);
            window.workoutHistoryCache = normalizeHistoryCache(rawHistory1);
        } catch(e) {
            console.error("Failed to auto-save workout:", e);
            window.currentCustomWorkoutId = null;
        }
    }

    // Preload personal bests for all exercises in this workout
    if (user) {
        try {
            window.personalBestsCache = await dbHelpers.personalBests.getForExercises(user.id, customWorkoutSelection);
        } catch(e) { console.error("Failed to load personal bests", e); window.personalBestsCache = {}; }
    }

    // Construct a dynamic workout object
    const customWorkout = {
        title: workoutName,
        name: workoutName,
        description: 'Your personalized session',
        exercises: customWorkoutSelection.map(key => ({
            name: key,
            sets: 3,
            reps: '12',
            videoUrl: '', // Will be looked up
            desc: ''
        }))
    };

    // Hijack the player
    document.getElementById('workout-player-title').innerText = customWorkout.title;
    document.getElementById('workout-player-goal').innerText = customWorkout.description;
    
    const list = document.getElementById('workout-exercises-list');
    list.innerHTML = '';
    
    customWorkout.exercises.forEach((ex, idx) => {
        const card = document.createElement('div');
        card.className = 'exercise-logger-card'; // Required for addWorkoutSet to find parent
        card.setAttribute('data-exercise-name', ex.name);
        card.setAttribute('data-is-user-added', 'false');
        card.style.cssText = "background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9;";

        const videoUrl = findVideoMatch(ex.name);
        const previousSummaryHtml = formatPreviousWorkoutSummary(ex.name);
        const previousSummary = getPreviousWorkoutSummary(ex.name);
        const escapedName = ex.name.replace(/'/g, "\\'");

        card.innerHTML = `
            <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <h3 style="margin: 0 0 5px 0; font-size: 1.05rem; font-weight: 700; color: var(--text-main);">${ex.name}</h3>
                <div style="color: var(--text-muted); font-size: 0.85rem;">Custom Exercise</div>
                ${previousSummaryHtml}
            </div>

            ${videoUrl ? `
            <div data-video-container style="position: relative; width: 100%; padding-top: 56.25%; background: black; cursor: pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width: 30px; height: 30px; fill: var(--primary); margin-left: 3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            <!-- Volume Tracker -->
            <div class="volume-display" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-bottom: 1px solid #fef08a;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #ca8a04;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    <span style="font-size: 0.75rem; font-weight: 700; color: #a16207; text-transform: uppercase;">Volume</span>
                </div>
                <div style="text-align: right;">
                    <div class="volume-value" style="font-size: 1rem; font-weight: 800; color: #854d0e;">0 kg</div>
                    <div class="volume-comparison" style="font-size: 0.7rem; font-weight: 600;">${previousSummary && previousSummary.totalVolume > 0 ? `<span style="color: #94a3b8;">Last: ${previousSummary.totalVolume.toLocaleString()} kg — beat it!</span>` : '<span style="color: #94a3b8;">Enter weight & reps</span>'}</div>
                </div>
                <div class="volume-progress-container" style="display: ${previousSummary && previousSummary.totalVolume > 0 ? 'block' : 'none'}; margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span class="volume-target-label" style="font-size: 0.65rem; font-weight: 600; color: #a16207;">Target: ${previousSummary && previousSummary.totalVolume > 0 ? previousSummary.totalVolume.toLocaleString() + ' kg' : '—'}</span>
                        <span class="volume-percentage" style="font-size: 0.65rem; font-weight: 700; color: #a16207;">0%</span>
                    </div>
                    <div style="height: 6px; background: #fef08a; border-radius: 3px; overflow: hidden;">
                        <div class="volume-progress-bar" style="height: 100%; width: 0%; background: #ca8a04; border-radius: 3px; transition: width 0.3s ease, background 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr 32px 32px; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div><div></div><div></div>
            </div>

            <div class="sets-list-container">
                ${(() => {
                    const numSets = previousSummary && previousSummary.setCount > 0 ? previousSummary.setCount : ex.sets;
                    return Array.from({length: numSets}, (_, setIdx) => {
                        const prevSet = previousSummary && previousSummary.sets[setIdx] ? previousSummary.sets[setIdx] : null;
                        const prefillKg = prevSet && prevSet.kg && prevSet.kg !== '0' && prevSet.kg !== '' ? prevSet.kg : '';
                        const prefillReps = prevSet && prevSet.reps ? prevSet.reps : '';
                        const hasPrefill = prefillKg || prefillReps;
                        return `
                        <div class="set-wrapper"${hasPrefill ? ' data-prefilled="true"' : ''}>
                            <div class="workout-set-row" style="display: grid; grid-template-columns: 40px 1fr 1fr 1fr 32px 32px; gap: 8px; align-items: center; padding: 10px 15px; border-top: 1px solid #f8fafc;">
                                <div class="set-number" style="font-weight: 800; color: #94a3b8; font-size: 0.85rem; text-align: center;">${setIdx + 1}</div>
                                <input type="text" class="input-time" placeholder="-" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="time" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                                <input type="text" class="input-reps" placeholder="Reps" value="${prefillReps}" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="reps" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                                <input type="text" class="input-kg" placeholder="Kg" value="${prefillKg}" data-exercise="${ex.name}" data-set="${setIdx + 1}" data-field="weight" style="width:100%; border: none; background: #f8fafc; border-radius: 8px; padding: 10px 5px; text-align: center; font-weight: 700; color: var(--text-main); font-size: 0.9rem;">
                                <button class="drop-set-toggle" onclick="toggleDropSet(this)" title="Toggle Drop Set">DS</button>
                                <button class="delete-set-btn" onclick="deleteSetRow(this)" title="Delete Set" style="width:32px; height:32px; border:none; background:transparent; color:#ef4444; cursor:pointer; border-radius:8px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;"><svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:currentColor;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                            </div>
                            <div class="drop-set-container">
                                <div class="drop-set-inputs">
                                    <div class="drop-set-row">
                                        <div class="drop-indicator">↓1</div>
                                        <input type="text" class="drop-reps" placeholder="Reps">
                                        <input type="text" class="drop-kg" placeholder="Kg">
                                        <button class="drop-add-btn" onclick="addDropRow(this)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                })()}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${ex.name.replace(/'/g, "\\'")}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>
        `;
        list.appendChild(card);

        // Setup volume tracking for this card
        setupVolumeTracking(card);
    });

    hideAllAppViews();
    document.getElementById('view-active-workout').style.display = 'block';
    startWorkoutTimer();

    // Push navigation state for Android back button
    pushNavigationState('view-active-workout', () => quitWorkout());

    // Show total volume popup and tracker
    showLastVolumePopup();

    // Show workout Spotify bar if music is playing
    if (typeof syncWorkoutSpotifyBar === 'function') syncWorkoutSpotifyBar();
}
</script>

<!-- YOUR WORKOUTS VIEW -->
<div id="view-your-workouts" class="app-view" style="display:none; min-height: 100vh; height: auto; background: #f8fafc; z-index: 100000; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; overflow-y: auto; overflow-x: hidden;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; padding-top: calc(15px + env(safe-area-inset-top, 0px)); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Your Workouts</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 20px;">
        <!-- My Programs Section -->
        <div id="your-programs-section" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 1rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2rem;">📅</span> My Programs
                </h3>
                <button onclick="closeYourWorkouts(); openProgramBuilder();" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 50px; font-weight: 600; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: white;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    Build Program
                </button>
            </div>
            <div id="your-programs-list" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Saved programs will be rendered here -->
            </div>
            <div id="your-programs-empty" style="display: none; text-align: center; padding: 25px 20px; color: var(--text-muted); background: white; border-radius: 16px; border: 2px dashed #e2e8f0;">
                <p style="margin: 0 0 12px 0; font-size: 0.9rem;">Create your own workout program</p>
                <p style="margin: 0 0 15px 0; font-size: 0.8rem; color: #94a3b8;">Choose workouts for each day, set your duration (4, 6, or 8 weeks), and follow your personalized plan!</p>
            </div>
        </div>

        <!-- Custom Workouts Section -->
        <div id="your-workouts-custom-section" style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; font-size: 1rem; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2rem;">🛠️</span> Custom Workouts
                </h3>
                <button onclick="closeYourWorkouts(); openWorkoutBuilder();" style="background: #f1f5f9; color: var(--text-main); border: none; padding: 8px 16px; border-radius: 50px; font-weight: 600; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--text-main);"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    New
                </button>
            </div>
            <div id="your-workouts-list" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Saved workouts will be rendered here -->
            </div>
            <div id="your-workouts-empty" style="display: none; text-align: center; padding: 25px 20px; color: var(--text-muted); background: white; border-radius: 16px; border: 2px dashed #e2e8f0;">
                <p style="margin: 0; font-size: 0.85rem;">Build single workouts from 1800+ exercises</p>
            </div>
        </div>

    </div>
</div>

<script>
function openYourWorkouts() {
    console.log('openYourWorkouts: Starting...');

    try {
        // First, hide all other views
        hideAllAppViews();

        // Get the view element
        const viewEl = document.getElementById('view-your-workouts');
        if (!viewEl) {
            console.error('openYourWorkouts: view-your-workouts element not found!');
            return;
        }

        // Show the view with explicit styles to ensure visibility
        viewEl.style.display = 'block';
        viewEl.style.visibility = 'visible';
        viewEl.style.opacity = '1';
        viewEl.scrollTop = 0; // Scroll to top of view
        window.scrollTo(0, 0); // Also scroll main window
        console.log('openYourWorkouts: View displayed');

        // Hide bottom nav safely
        const bottomNav = document.querySelector('.bottom-nav');
        if (bottomNav) {
            bottomNav.style.display = 'none';
        }

        // Hide any open modals/overlays that might be covering the view
        // Skip the onboarding wizard — closing it without setting completion flags causes it to re-trigger
        document.querySelectorAll('.modal-overlay, .onboarding-overlay, .completion-modal-overlay').forEach(el => {
            if (el.id === 'onboarding-wizard') return;
            el.style.display = 'none';
            el.classList.remove('active');
        });

        // Render library immediately (doesn't need database)
        const libraryContainer = document.getElementById('your-workouts-library-list');
        if (libraryContainer) {
            try {
                renderYourWorkoutsLibrary(libraryContainer);
                console.log('openYourWorkouts: Library rendered');
            } catch(libErr) {
                console.error('openYourWorkouts: Failed to render library', libErr);
                libraryContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Could not load workout library</div>';
            }
        }

        // Then load async data (custom workouts and programs)
        renderYourWorkoutsList().catch(err => {
            console.error('openYourWorkouts: Failed to render workouts list', err);
        });

        renderYourProgramsList().catch(err => {
            console.error('openYourWorkouts: Failed to render programs list', err);
        });

        // Push navigation state
        if (typeof pushNavigationState === 'function') {
            pushNavigationState('view-your-workouts', () => closeYourWorkouts());
        }

        console.log('openYourWorkouts: Complete');
    } catch(err) {
        console.error('openYourWorkouts: Error occurred', err);
        // Even if there's an error, try to show the view
        const viewEl = document.getElementById('view-your-workouts');
        if (viewEl) {
            viewEl.style.display = 'block';
        }
    }
}

function closeYourWorkouts() {
    document.getElementById('view-your-workouts').style.display = 'none';
    switchAppTab('movement-tab');
}

// Track where the progress view was opened from ('home' or 'movement')
window._progressViewOrigin = 'movement';

function openProgressFromMovement() {
    window._progressViewOrigin = 'movement';
    hideAllAppViews();

    const viewEl = document.getElementById('view-progress');
    if (viewEl) {
        viewEl.style.display = 'block';
        viewEl.scrollTop = 0;
        window.scrollTo(0, 0);
    }

    // Hide bottom nav
    const bottomNav = document.querySelector('.bottom-nav');
    if (bottomNav) {
        bottomNav.style.display = 'none';
    }

    // Initialize progress data
    if (typeof initProgressView === 'function') {
        initProgressView();
    }

    // Push navigation state for back button support
    if (typeof pushNavigationState === 'function') {
        pushNavigationState('view-progress', () => closeProgressView());
    }
}

function closeProgressView() {
    const viewEl = document.getElementById('view-progress');
    if (viewEl) {
        viewEl.style.display = 'none';
    }
    // Navigate back to wherever Progress was opened from
    if (window._progressViewOrigin === 'home') {
        switchAppTab('dashboard');
    } else {
        switchAppTab('movement-tab');
    }
}

async function renderYourWorkoutsList() {
    console.log('renderYourWorkoutsList: Starting...');
    const listContainer = document.getElementById('your-workouts-list');
    const emptyState = document.getElementById('your-workouts-empty');

    if (!listContainer) {
        console.error('renderYourWorkoutsList: listContainer not found');
        return;
    }

    try {
        const user = window.currentUser;
        if (!user) {
            console.log('renderYourWorkoutsList: No user logged in');
            // Show empty state when not logged in
            if (listContainer) listContainer.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        // Try to use cached workouts first, then fetch if needed
        let savedWorkouts = window.savedWorkoutsCache;

        if (!savedWorkouts && typeof dbHelpers !== 'undefined' && dbHelpers.workouts) {
            console.log('renderYourWorkoutsList: Fetching from database...');
            savedWorkouts = await dbHelpers.workouts.getCustomWorkouts(user.id);
            window.savedWorkoutsCache = savedWorkouts;
        }

        console.log('renderYourWorkoutsList: Found', savedWorkouts?.length || 0, 'workouts');

        // Render Custom Workouts
        if (!savedWorkouts || savedWorkouts.length === 0) {
            if (listContainer) listContainer.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
        } else {
            if (listContainer) listContainer.style.display = 'flex';
            if (emptyState) emptyState.style.display = 'none';

            listContainer.innerHTML = savedWorkouts.map(w => {
                const name = w.template_name || 'Untitled Workout';
                const exercises = w.template_data?.exercises || [];
                const date = new Date(w.created_at || Date.now()).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                return `
                <div onclick="startSavedWorkout('${w.id}')" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), #22c55e); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 1.2rem; flex-shrink: 0;">
                        ${name.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; color: var(--text-main); font-size: 0.95rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${exercises.length} exercises • Saved ${date}</div>
                    </div>
                    <div style="color: var(--primary); font-weight: 600; font-size: 0.8rem;">Start →</div>
                </div>
                `;
            }).join('');
            console.log('renderYourWorkoutsList: Rendered', savedWorkouts.length, 'workout cards');
        }

    } catch(err) {
        console.error('renderYourWorkoutsList: Error loading workouts:', err);
        if (listContainer) listContainer.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
    }
}

async function renderYourProgramsList() {
    console.log('renderYourProgramsList: Starting...');
    const listContainer = document.getElementById('your-programs-list');
    const emptyState = document.getElementById('your-programs-empty');

    if (!listContainer) {
        console.error('renderYourProgramsList: listContainer not found');
        return;
    }

    try {
        const user = window.currentUser;
        if (!user) {
            console.log('renderYourProgramsList: No user logged in');
            if (listContainer) listContainer.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
            return;
        }

        // Fetch programs from database
        let programs = [];
        if (typeof dbHelpers !== 'undefined' && dbHelpers.customPrograms) {
            console.log('renderYourProgramsList: Fetching from database...');
            programs = await dbHelpers.customPrograms.getAll(user.id);
            window.savedProgramsCache = programs;
        }

        console.log('renderYourProgramsList: Found', programs?.length || 0, 'programs');

        if (!programs || programs.length === 0) {
            if (listContainer) listContainer.style.display = 'none';
            if (emptyState) emptyState.style.display = 'block';
        } else {
            if (listContainer) listContainer.style.display = 'flex';
            if (emptyState) emptyState.style.display = 'none';

            listContainer.innerHTML = programs.map(p => {
                const name = p.program_name || 'Untitled Program';
                const duration = p.duration_weeks || 4;
                const isActive = p.is_active;
                const schedule = p.weekly_schedule || [];
                const workoutDays = schedule.filter(s => s.workout && s.workout.type !== 'rest').length;

                // Calculate progress if active
                let progressHtml = '';
                if (isActive && p.start_date) {
                    const startDate = new Date(p.start_date);
                    const today = new Date();
                    const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                    const weeksElapsed = Math.floor((today - startDate) / msPerWeek) + 1;
                    const progress = Math.min(100, Math.round((weeksElapsed / duration) * 100));
                    progressHtml = `
                        <div style="margin-top: 8px; background: #e2e8f0; border-radius: 4px; height: 4px; overflow: hidden;">
                            <div style="background: var(--primary); height: 100%; width: ${progress}%;"></div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">Week ${Math.min(weeksElapsed, duration)} of ${duration}</div>
                    `;
                }

                return `
                <div onclick="viewProgramDetails('${p.id}')" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: ${isActive ? '2px solid var(--primary)' : '1px solid #f1f5f9'}; ${isActive ? 'border-left: 4px solid var(--primary);' : ''}">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: ${isActive ? 'linear-gradient(135deg, var(--primary), #22c55e)' : 'linear-gradient(135deg, #64748b, #94a3b8)'}; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 1rem; flex-shrink: 0;">
                            ${duration}w
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="font-weight: 700; color: var(--text-main); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                                ${isActive ? '<span style="background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; font-weight: 700;">ACTIVE</span>' : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${workoutDays} workout days • ${duration} weeks</div>
                            ${progressHtml}
                        </div>
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #94a3b8; flex-shrink: 0;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </div>
                </div>
                `;
            }).join('');
            console.log('renderYourProgramsList: Rendered', programs.length, 'program cards');
        }

    } catch(err) {
        console.error('renderYourProgramsList: Error loading programs:', err);
        if (listContainer) listContainer.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
    }
}

async function viewProgramDetails(programId) {
    // Show program details with options to activate, edit, or delete
    try {
        const user = window.currentUser;
        if (!user) return;

        const programs = window.savedProgramsCache || await dbHelpers.customPrograms.getAll(user.id);
        const program = programs.find(p => p.id === programId);
        if (!program) return;

        const schedule = program.weekly_schedule || [];
        const scheduleText = schedule.map(s => {
            if (!s.workout) return `${s.day}: Not set`;
            if (s.workout.type === 'rest') return `${s.day}: Rest Day`;
            return `${s.day}: ${s.workout.name}`;
        }).join('\n');

        const action = prompt(
            `${program.program_name}\n` +
            `Duration: ${program.duration_weeks} weeks\n` +
            `Status: ${program.is_active ? 'Active' : 'Inactive'}\n\n` +
            `Weekly Schedule:\n${scheduleText}\n\n` +
            `Options:\n` +
            `1 = ${program.is_active ? 'Deactivate' : 'Activate'}\n` +
            `2 = Delete\n` +
            `Cancel = Close`,
            ''
        );

        if (action === '1') {
            if (program.is_active) {
                await dbHelpers.customPrograms.deactivate(programId);
                alert('Program deactivated. Your calendar will use the default schedule.');
            } else {
                await dbHelpers.customPrograms.activate(user.id, programId);
                alert(`Program "${program.program_name}" activated! Your ${program.duration_weeks}-week program starts today.`);
            }
            renderYourProgramsList();
            if (typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();
            if (typeof renderMovementView === 'function') renderMovementView();
        } else if (action === '2') {
            if (confirm(`Are you sure you want to delete "${program.program_name}"? This cannot be undone.`)) {
                await dbHelpers.customPrograms.delete(programId);
                alert('Program deleted.');
                renderYourProgramsList();
                if (typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();
                if (typeof renderMovementView === 'function') renderMovementView();
            }
        }
    } catch (err) {
        console.error('viewProgramDetails: Error', err);
        alert('An error occurred. Please try again.');
    }
}

function renderYourWorkoutsLibrary(container) {
    console.log('renderYourWorkoutsLibrary: Starting...');
    if (typeof WORKOUT_LIBRARY === 'undefined') {
        console.warn('renderYourWorkoutsLibrary: WORKOUT_LIBRARY is undefined');
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Workout library not available</div>';
        return;
    }

    const categories = Object.keys(WORKOUT_LIBRARY);
    const categoryIcons = {
        'gym': '🏋️',
        'yoga': '🧘',
        'bodyweight': '💪',
        'home': '🏠',
        'cardio': '🏃',
        'hiit': '⚡'
    };

    container.innerHTML = categories.map(categoryKey => {
        const category = WORKOUT_LIBRARY[categoryKey];
        const icon = categoryIcons[categoryKey] || category.icon || '💪';
        const name = category.name || categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1);

        // Count total workouts in category
        let totalWorkouts = 0;
        if (category.subcategories) {
            Object.values(category.subcategories).forEach(sub => {
                if (sub.workouts) totalWorkouts += sub.workouts.length;
            });
        }

        return `
        <div onclick="openLibraryCategory('${categoryKey}')" style="background: white; border-radius: 16px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b, #ef4444); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                ${icon}
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 700; color: var(--text-main); font-size: 0.95rem; margin-bottom: 2px;">${name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">${totalWorkouts} workouts available</div>
            </div>
            <div style="color: #f59e0b; font-weight: 600; font-size: 0.8rem;">Browse →</div>
        </div>
        `;
    }).join('');
    console.log('renderYourWorkoutsLibrary: Rendered', categories.length, 'categories');
}

function viewWorkoutHistoryDetail(date) {
    // Navigate to progress view (now inside Movement tab)
    closeYourWorkouts();
    setTimeout(() => { if(typeof openProgressFromMovement === 'function') openProgressFromMovement(); }, 100);
}

</script>

<!-- WORKOUT OVERVIEW VIEW -->
<div id="view-workout-overview" class="app-view" style="display:none; height: 100vh; background: white; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; padding-top: calc(15px + env(safe-area-inset-top, 0px)); display: flex; align-items: center; justify-content: space-between;">
        <div style="width: 40px;"></div>
        <div id="overview-header-title" style="font-weight: 700; color: var(--text-main);">Workout Overview</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 20px;">
        <div id="overview-hero-card" style="border-radius: 20px; overflow: hidden; margin-bottom: 25px; position: relative; height: 200px; background: #f1f5f9;">
            <img id="overview-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
            <div style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);"></div>
            <div style="position: absolute; bottom: 20px; left: 20px; color: white;">
                <h1 id="overview-title" style="margin: 0; font-size: 1.8rem;">Workout Name</h1>
                <div id="overview-meta" style="opacity: 0.9; font-size: 0.9rem;">22 mins  6 Exercises</div>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.1rem;">Equipment Needed</h3>
            <div id="overview-equipment" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <!-- Equipment Badges -->
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h3 style="margin: 0 0 10px 0; font-size: 1.1rem;">Instructions</h3>
            <p id="overview-instructions" style="color: var(--text-muted); line-height: 1.5; font-size: 0.95rem;"></p>
        </div>

        <div>
            <h3 style="margin: 0 0 15px 0; font-size: 1.1rem;">Exercise List</h3>
            <div id="overview-exercise-list">
                <!-- Exercises List -->
            </div>
        </div>
        
        <div style="height: 100px;"></div>
    </div>


</div>

<!-- ACTIVE WORKOUT PLAYER VIEW -->
<div id="view-active-workout" class="app-view" style="display:none; height: 100vh; background: #f8fafc; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    
    <!-- Top Nav Bar -->
    <div style="position: sticky; top: 0; z-index: 100; background: black; color: white; padding: 15px 20px; padding-top: calc(15px + env(safe-area-inset-top, 0px)); display: flex; align-items: center; justify-content: space-between;">
        <div onclick="quitWorkout()" style="font-weight: 600; cursor: pointer; color: #FF4444; padding: 10px; touch-action: manipulation; user-select: none;">Cancel</div>
        <div style="text-align: center;">
            <div id="workout-timer" style="font-family: monospace; font-size: 1.2rem; font-weight: 700; color: white;">00:00</div>
        </div>
        <div onclick="finishWorkout()" style="font-weight: 600; cursor: pointer; color: #44FF44; padding: 10px; touch-action: manipulation; user-select: none;">Save</div>
    </div>

    <!-- Total Workout Volume Bar -->
    <div id="total-volume-bar" style="display:none; position:sticky; top:0; z-index:99; padding:10px 20px; background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom:1px solid #334155;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div style="display:flex; align-items:center; gap:6px;">
                <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:#facc15;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                <span style="font-size:0.7rem; font-weight:800; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px;">Total Volume</span>
            </div>
            <span id="total-volume-value" style="font-size:1.1rem; font-weight:900; color:white;">0 kg</span>
        </div>
        <div id="total-volume-progress-wrap" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:3px;">
                <span id="total-volume-target-label" style="font-size:0.6rem; font-weight:600; color:#64748b;">Target: 0 kg</span>
                <span id="total-volume-diff" style="font-size:0.65rem; font-weight:700; color:#94a3b8;"></span>
            </div>
            <div style="height:5px; background:#334155; border-radius:3px; overflow:hidden;">
                <div id="total-volume-progress-bar" style="height:100%; width:0%; background:#facc15; border-radius:3px; transition:width 0.3s ease, background 0.3s ease;"></div>
            </div>
        </div>
    </div>

    <!-- Last Volume Popup Overlay -->
    <div id="last-volume-popup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:600; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;" onclick="dismissVolumePopup()">
        <div style="background:white; border-radius:20px; padding:30px 25px; max-width:320px; width:85%; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:slideInUp 0.3s ease;" onclick="event.stopPropagation()">
            <div style="font-size:2.5rem; margin-bottom:10px;">&#x1F4AA;</div>
            <h3 style="margin:0 0 8px 0; font-size:1.1rem; font-weight:800; color:#1e293b;">Last Workout Volume</h3>
            <div id="popup-last-volume" style="font-size:2rem; font-weight:900; color:var(--primary); margin:10px 0;"></div>
            <p style="font-size:0.85rem; color:#64748b; margin:0 0 20px 0; line-height:1.4;">Can you beat it today? Every rep counts!</p>
            <button onclick="dismissVolumePopup()" style="background:var(--primary); color:white; border:none; padding:12px 30px; border-radius:12px; font-weight:700; font-size:0.9rem; cursor:pointer; width:100%;">Let's Go!</button>
        </div>
    </div>

    <!-- Workout Spotify Mini Bar (fixed at bottom of workout view) -->
    <div id="workout-spotify-bar" style="display:none; position:fixed; bottom:0; left:0; width:100%; z-index:101; background:rgba(18,18,18,0.97); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); padding:10px 16px; padding-bottom:calc(10px + env(safe-area-inset-bottom, 0px)); border-top:1px solid rgba(255,255,255,0.08); box-shadow:0 -4px 20px rgba(0,0,0,0.3);">
        <div style="display:flex; align-items:center; gap:10px; max-width:600px; margin:0 auto;">
            <!-- Album art -->
            <div onclick="openInSpotify()" style="flex-shrink:0; cursor:pointer;">
                <img id="ws-art" src="" alt="" style="width:40px; height:40px; border-radius:6px; object-fit:cover; background:#333;" onerror="this.style.display='none'">
                <div id="ws-art-placeholder" style="display:none; width:40px; height:40px; border-radius:6px; background:#1DB954; align-items:center; justify-content:center;">
                    <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                </div>
            </div>
            <!-- Track info -->
            <div onclick="openInSpotify()" style="flex:1; min-width:0; cursor:pointer;">
                <div id="ws-track" style="font-weight:600; font-size:0.8rem; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                <div id="ws-artist" style="font-size:0.7rem; color:rgba(255,255,255,0.55); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:1px;"></div>
            </div>
            <!-- Controls -->
            <div style="display:flex; align-items:center; gap:2px; flex-shrink:0;">
                <button onclick="spotifyPlayerControl('previous')" style="background:none; border:none; color:white; cursor:pointer; padding:8px; border-radius:50%; display:flex; align-items:center; justify-content:center; opacity:0.7;">
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor;"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
                </button>
                <button id="ws-playpause" onclick="spotifyPlayerControl(window._snpPlaying ? 'pause' : 'play')" style="background:#1DB954; border:none; color:white; cursor:pointer; padding:8px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <svg id="ws-play-icon" viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor;"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="ws-pause-icon" viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor; display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button onclick="spotifyPlayerControl('next')" style="background:none; border:none; color:white; cursor:pointer; padding:8px; border-radius:50%; display:flex; align-items:center; justify-content:center; opacity:0.7;">
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor;"><path d="M6 18l8.5-6L6 6v12zm2-8.14 4.97 3.14L8 16.14V9.86zM16 6h2v12h-2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div style="padding: 15px; padding-bottom: 120px;">
        <h1 id="workout-player-title" style="margin: 0 0 5px 0; font-size: 1.3rem; line-height: 1.2;">Workout Title</h1>
        <p id="workout-player-goal" style="font-size: 0.85rem; color: var(--text-muted); margin: 0 0 20px 0; line-height: 1.4;"></p>

        <div id="workout-exercises-list">
            <!-- Dynamic Content Injected Here via JS -->
        </div>

        <!-- Quick Entry Button -->
        <div style="margin-top: 20px;">
            <button onclick="openBulkEntryModal()" style="width: 100%; background: var(--primary); border: none; color: white; font-weight: 700; font-size: 0.95rem; padding: 18px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(123, 168, 131, 0.3);">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
                Quick Entry
            </button>
        </div>

        <!-- Add Exercise Button -->
        <div style="margin-top: 12px;">
            <button onclick="openAddExerciseModal()" style="width: 100%; background: transparent; border: 2px dashed var(--primary); color: var(--primary); font-weight: 700; font-size: 0.95rem; padding: 18px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Add Exercise
            </button>
        </div>

        <!-- Create Custom Exercise Button -->
        <div style="margin-top: 10px; padding-bottom: 40px;">
            <button onclick="openCreateCustomExerciseModal('workout')" style="width: 100%; background: transparent; border: 2px dashed #4ade80; color: var(--primary); font-weight: 700; font-size: 0.95rem; padding: 16px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                </svg>
                Create Your Own Exercise
            </button>
        </div>
    </div>
</div>

</div>

<!-- ADD EXERCISE MODAL -->
<div id="add-exercise-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 600; overflow-y: auto;">
    <div style="background: white; min-height: 100%; max-width: 600px; margin: 0 auto; position: relative;">
        <!-- Modal Header -->
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; padding-top: calc(15px + env(safe-area-inset-top, 0px)); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div onclick="closeAddExerciseModal()" style="font-weight: 600; cursor: pointer; color: var(--text-muted); padding: 10px;">Cancel</div>
            <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Add Exercise</div>
            <div style="width: 60px;"></div>
        </div>

        <!-- Search Box -->
        <div style="padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
            <input type="text" id="add-exercise-search" placeholder="Search exercises..." oninput="searchExercisesForAdd(this.value)" style="width: 100%; padding: 12px 15px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; background: white; box-sizing: border-box;">

            <!-- Create Your Own Button -->
            <div onclick="closeAddExerciseModal(); openCreateCustomExerciseModal('workout');" style="margin-top: 10px; padding: 12px 15px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 1px solid #bbf7d0; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                <div style="width: 36px; height: 36px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;">
                        <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--primary); font-size: 0.9rem;">Create Your Own Exercise</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Record a video and add it to your library</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--primary);">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>

        <!-- Exercise Results -->
        <div id="add-exercise-results" style="padding: 15px 20px; padding-bottom: 100px;">
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                Type to search for exercises from your library
            </div>
        </div>
    </div>
</div>

<!-- CREATE CUSTOM EXERCISE MODAL -->
<div id="create-custom-exercise-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 650; overflow-y: auto;">
    <div style="background: white; min-height: 100%; max-width: 600px; margin: 0 auto; position: relative;">
        <!-- Modal Header -->
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div onclick="closeCreateCustomExerciseModal()" style="font-weight: 600; cursor: pointer; color: var(--text-muted); padding: 10px;">Cancel</div>
            <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Create Exercise</div>
            <div onclick="saveCustomExercise()" id="save-custom-exercise-btn" style="font-weight: 600; cursor: pointer; color: var(--primary); padding: 10px;">Save</div>
        </div>

        <div style="padding: 20px;">
            <!-- Exercise Name -->
            <div style="margin-bottom: 20px;">
                <label style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: block; margin-bottom: 8px;">Exercise Name *</label>
                <input type="text" id="custom-exercise-name" placeholder="e.g. Bulgarian Split Squat with Pulse" style="width: 100%; padding: 14px 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; box-sizing: border-box; font-family: inherit;" oninput="validateCustomExerciseForm()">
            </div>

            <!-- Description -->
            <div style="margin-bottom: 20px;">
                <label style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: block; margin-bottom: 8px;">Description</label>
                <textarea id="custom-exercise-desc" placeholder="Brief description or form cues..." style="width: 100%; padding: 14px 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; min-height: 70px; resize: vertical; box-sizing: border-box; font-family: inherit;"></textarea>
            </div>

            <!-- Muscle Group & Equipment Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <div>
                    <label style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: block; margin-bottom: 8px;">Muscle Group</label>
                    <select id="custom-exercise-muscle" style="width: 100%; padding: 14px 10px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem; background: white; color: var(--text-main); font-family: inherit;">
                        <option value="chest">Chest</option>
                        <option value="back">Back</option>
                        <option value="legs">Legs</option>
                        <option value="shoulders">Shoulders</option>
                        <option value="arms">Arms</option>
                        <option value="core">Core</option>
                        <option value="glutes">Glutes</option>
                        <option value="full_body">Full Body</option>
                        <option value="other" selected>Other</option>
                    </select>
                </div>
                <div>
                    <label style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: block; margin-bottom: 8px;">Equipment</label>
                    <select id="custom-exercise-equipment" style="width: 100%; padding: 14px 10px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem; background: white; color: var(--text-main); font-family: inherit;">
                        <option value="bodyweight">Bodyweight</option>
                        <option value="barbell">Barbell</option>
                        <option value="dumbbell">Dumbbell</option>
                        <option value="cable">Cable</option>
                        <option value="machine">Machine</option>
                        <option value="band">Band</option>
                        <option value="kettlebell">Kettlebell</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Default Sets & Reps Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                <div>
                    <label style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: block; margin-bottom: 8px;">Default Sets</label>
                    <input type="number" id="custom-exercise-sets" value="3" min="1" max="10" style="width: 100%; padding: 14px 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; text-align: center; box-sizing: border-box; font-family: inherit;">
                </div>
                <div>
                    <label style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: block; margin-bottom: 8px;">Default Reps</label>
                    <input type="text" id="custom-exercise-reps" value="8-12" placeholder="e.g. 8-12" style="width: 100%; padding: 14px 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; text-align: center; box-sizing: border-box; font-family: inherit;">
                </div>
            </div>

            <!-- Video Recording Section -->
            <div style="background: #f8fafc; border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                <label style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: block; margin-bottom: 12px;">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--primary);">
                            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                        </svg>
                        Record Exercise Video
                    </span>
                </label>

                <!-- Video Preview (hidden until recorded/selected) -->
                <div id="custom-exercise-video-preview" style="display: none; margin-bottom: 15px; border-radius: 12px; overflow: hidden; background: black; position: relative;">
                    <video id="custom-exercise-video-playback" style="width: 100%; max-height: 300px; object-fit: contain;" playsinline controls></video>
                    <button onclick="removeCustomExerciseVideo()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">×</button>
                </div>

                <!-- Camera/Recording Area (shown when actively recording) -->
                <div id="custom-exercise-camera-container" style="display: none; margin-bottom: 15px; border-radius: 12px; overflow: hidden; background: black; position: relative;">
                    <video id="custom-exercise-camera-feed" style="width: 100%; max-height: 400px; object-fit: cover;" autoplay playsinline muted></video>
                    <div id="custom-exercise-recording-indicator" style="display: none; position: absolute; top: 12px; left: 12px; background: #ef4444; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 5px;">
                        <div style="width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse 1s infinite;"></div>
                        REC <span id="custom-exercise-rec-timer">0:00</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div id="custom-exercise-video-actions" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Record Button -->
                    <button id="custom-exercise-record-btn" onclick="startCustomExerciseRecording()" style="width: 100%; background: linear-gradient(135deg, var(--primary), #4ade80); border: none; color: white; font-weight: 700; font-size: 0.95rem; padding: 16px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: currentColor;">
                            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                        </svg>
                        Record Video
                    </button>

                    <!-- Stop Recording Button (hidden by default) -->
                    <button id="custom-exercise-stop-btn" onclick="stopCustomExerciseRecording()" style="display: none; width: 100%; background: #ef4444; border: none; color: white; font-weight: 700; font-size: 0.95rem; padding: 16px; border-radius: 12px; cursor: pointer; display: none; align-items: center; justify-content: center; gap: 8px;">
                        <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: currentColor;">
                            <path d="M6 6h12v12H6z"/>
                        </svg>
                        Stop Recording
                    </button>

                    <!-- Or upload from gallery -->
                    <div style="text-align: center; color: var(--text-muted); font-size: 0.85rem;">or</div>

                    <label style="width: 100%; background: white; border: 2px dashed #e2e8f0; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; padding: 14px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; text-align: center; box-sizing: border-box;">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                            <path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/>
                        </svg>
                        Upload from Gallery
                        <input type="file" id="custom-exercise-file-input" accept="video/*" onchange="handleCustomExerciseFileSelect(event)" style="display: none;">
                    </label>
                </div>

                <p style="color: #94a3b8; font-size: 0.8rem; margin: 12px 0 0 0; line-height: 1.4;">
                    Video is optional. You can always add one later.
                </p>
            </div>

            <!-- My Custom Exercises List -->
            <div id="my-custom-exercises-section" style="margin-top: 30px; display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1rem; font-weight: 700; color: var(--text-main);">My Custom Exercises</h3>
                    <span id="custom-exercises-count" style="font-size: 0.8rem; color: var(--text-muted);"></span>
                </div>
                <div id="my-custom-exercises-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BULK ENTRY MODAL -->
<div id="bulk-entry-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 600; overflow-y: auto;">
    <div style="background: white; min-height: 100%; max-width: 600px; margin: 0 auto; position: relative;">
        <!-- Modal Header -->
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div onclick="closeBulkEntryModal()" style="font-weight: 600; cursor: pointer; color: var(--text-muted); padding: 10px;">Cancel</div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Quick Entry</span>
                <div onclick="showQuickEntryTutorial()" style="width: 22px; height: 22px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.75rem; font-weight: 700; color: var(--text-muted);">?</div>
            </div>
            <div onclick="processBulkEntry()" style="font-weight: 600; cursor: pointer; color: var(--primary); padding: 10px;">Add</div>
        </div>

        <!-- Input Section -->
        <div style="padding: 20px;">
            <div style="background: #f8fafc; border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                <label style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; display: block; margin-bottom: 10px;">
                    Type your sets in one go:
                </label>
                <textarea id="bulk-entry-input" placeholder="e.g. bench press 30 40 60&#10;or: 3 sets squat 80kg 8 reps" style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; font-family: inherit; resize: vertical; box-sizing: border-box;" oninput="previewBulkEntry()"></textarea>
            </div>

            <!-- Preview Section -->
            <div id="bulk-entry-preview" style="display: none;">
                <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 12px;">Preview:</div>
                <div id="bulk-entry-preview-content" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;"></div>
            </div>
        </div>
    </div>
</div>

<!-- QUICK ENTRY TUTORIAL MODAL -->
<div id="quick-entry-tutorial-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 700; display: none; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;">
    <div style="background: white; border-radius: 24px; max-width: 400px; width: 100%; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
        <div style="background: linear-gradient(135deg, var(--primary), #4ade80); padding: 25px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 10px;">✍️</div>
            <h2 style="color: white; margin: 0; font-family: 'Playfair Display', serif; font-size: 1.5rem;">Quick Entry</h2>
            <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0 0; font-size: 0.95rem;">Log your sets in seconds</p>
        </div>
        <div style="padding: 25px;">
            <p style="color: var(--text-main); font-size: 0.95rem; margin: 0 0 20px 0; line-height: 1.5;">
                Just type the exercise name followed by your weights. We'll create all the sets for you!
            </p>
            <div style="background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                <div style="font-weight: 700; color: var(--text-main); font-size: 0.8rem; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Try typing:</div>
                <div style="font-family: monospace; background: white; padding: 12px; border-radius: 8px; color: var(--text-main); font-size: 0.95rem; border: 1px solid #e2e8f0;">
                    bench press 30 40 60
                </div>
                <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 10px; text-align: center;">
                    Creates 3 sets at 30kg, 40kg, 60kg
                </div>
            </div>
            <div style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                <strong>Other formats:</strong><br>
                <span style="font-family: monospace;">squat 80x8 x3</span> — same weight, 3 sets<br>
                <span style="font-family: monospace;">row 60x10 70x8 80x6</span> — weight x reps
            </div>
        </div>
        <div style="padding: 0 25px 25px 25px;">
            <button onclick="closeQuickEntryTutorial()" style="width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer;">
                Got it!
            </button>
        </div>
    </div>
</div>

<!-- WORKOUT SUCCESS VIEW -->
<div id="view-workout-success" class="app-view" style="display:none; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 500; background: var(--primary); color: white; overflow-y: auto;">
    <div style="padding: 20px; text-align: center; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column;">

        <!-- Header Section - Compact -->
        <div id="workout-capture-area" style="background: var(--primary); padding: 20px 15px; border-radius: 16px;">
            <div style="font-size: 3rem; margin-bottom: 10px;">🙌</div>
            <h1 style="font-family: 'Playfair Display'; font-size: 2rem; margin: 0; color: white;">High Five!</h1>
            <p style="font-size: 1rem; opacity: 0.9; margin-top: 5px;">Workout Completed</p>
        </div>

        <!-- Personal Bests - Right under header -->
        <div id="success-improvements" style="display: none; margin: 15px 0; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 16px;"></div>

        <!-- Milestones Container -->
        <div id="success-milestones" style="display: none; margin: 10px 0;"></div>

        <!-- Stats Row - Duration & Workout Count side by side -->
        <div style="display: flex; gap: 12px; margin: 15px 0;">
            <div style="flex: 1; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Duration</div>
                <div id="success-duration" style="font-size: 1.8rem; font-weight: 700; font-family: monospace; margin-top: 5px;">00:00</div>
            </div>
            <div id="success-workout-count-container" style="display: none; flex: 1; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Total Workouts</div>
                <div id="success-workout-count" style="font-size: 1.8rem; font-weight: 700; margin-top: 5px;">0</div>
            </div>
        </div>

        <!-- Earn Points by Sharing Section -->
        <div id="share-section-combined" style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 16px; margin: 10px 0; position: relative;">
            <button onclick="this.parentElement.style.display='none'; localStorage.setItem('share_section_dismissed','true');" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.25); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: white; line-height: 1;">×</button>
            <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; padding-right: 20px;">Share Your Workout</div>
            <p style="font-size: 0.85rem; opacity: 0.85; margin-bottom: 15px;">Earn up to 2 XP! Share to your feed and your group chat.</p>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button id="share-workout-card-btn" onclick="shareWorkoutCardToFeed()" style="width: 100%; background: linear-gradient(135deg, #ffffff, #f0fdf4); color: var(--primary); padding: 14px 15px; border-radius: 12px; font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 1.3rem;">💪</span>
                    <span style="font-size: 0.95rem;">Share Workout Card (+1 XP)</span>
                </button>
                <button id="share-workout-groupchat-btn" onclick="shareWorkoutToGroupChat()" style="width: 100%; background: linear-gradient(135deg, #ffffff, #eff6ff); color: #2563eb; padding: 14px 15px; border-radius: 12px; font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 1.3rem;">💬</span>
                    <span style="font-size: 0.95rem;">Share to Group Chat (+1 XP)</span>
                </button>
                <button onclick="shareWorkoutToStory()" style="width: 100%; background: rgba(255,255,255,0.15); color: white; padding: 12px 15px; border-radius: 12px; font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 1.1rem;">📸</span>
                    <span style="font-size: 0.85rem;">Post Photo Only (+1 XP)</span>
                </button>
            </div>
        </div>

        <!-- XP Awarded Confirmation (shown after sharing) -->
        <div id="workout-points-awarded" style="display: none; background: rgba(68, 255, 68, 0.2); padding: 12px 20px; border-radius: 14px; margin: 10px 0; border: 2px solid rgba(68, 255, 68, 0.5);">
            <div id="workout-points-text" style="font-size: 1.1rem; font-weight: 700;">+1 XP Earned!</div>
            <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 3px;">Workout photo posted</div>
        </div>

        <!-- Small spacer before DONE button -->
        <div style="min-height: 20px;"></div>

        <!-- DONE Button - Always visible at bottom -->
        <div style="padding: 15px 0 100px 0;">
            <button onclick="closeSuccessScreen()" style="background: white; color: var(--primary); border: none; padding: 16px 60px; border-radius: 50px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.2); width: 100%; max-width: 280px;">
                DONE
            </button>
        </div>
    </div>
</div>

<!-- POST-WORKOUT RATING MODAL (Simplified) -->
<div id="workout-rating-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:600; overflow-y:auto; padding:20px 10px;">
    <div style="background:white; width:100%; max-width:420px; margin:60px auto 20px; border-radius:24px; overflow:hidden; box-shadow:0 25px 50px rgba(0,0,0,0.3);">
        <!-- Header -->
        <div style="padding:24px 20px 16px; text-align:center; background:linear-gradient(135deg, var(--primary), #4ade80); color:white;">
            <h2 style="margin:0; font-family:'Playfair Display',serif; font-size:1.5rem;">How Was That?</h2>
            <p id="rating-workout-name" style="margin:5px 0 0; opacity:0.9; font-size:0.9rem;">Rate your workout</p>
        </div>

        <div style="padding:28px 24px;">
            <!-- Difficulty Slider -->
            <div style="margin-bottom:28px;">
                <div style="font-weight:700; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:14px;">How was your workout?</div>
                <input type="range" id="rating-difficulty-slider" min="1" max="5" value="3" step="1" style="width:100%; height:8px; -webkit-appearance:none; appearance:none; background:linear-gradient(to right, #60a5fa, #f97316); border-radius:4px; outline:none; cursor:pointer;" oninput="updateSliderLabel('difficulty')">
                <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:0.8rem; font-weight:600;">
                    <span style="color:#60a5fa;">Easy</span>
                    <span style="color:#f97316;">Hard</span>
                </div>
            </div>

            <!-- Energy Slider -->
            <div style="margin-bottom:28px;">
                <div style="font-weight:700; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); margin-bottom:14px;">How are you feeling?</div>
                <input type="range" id="rating-energy-slider" min="1" max="5" value="3" step="1" style="width:100%; height:8px; -webkit-appearance:none; appearance:none; background:linear-gradient(to right, #94a3b8, #22c55e); border-radius:4px; outline:none; cursor:pointer;" oninput="updateSliderLabel('energy')">
                <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:0.8rem; font-weight:600;">
                    <span style="color:#94a3b8;">Tired</span>
                    <span style="color:#22c55e;">Full of Energy</span>
                </div>
            </div>

            <!-- Buttons -->
            <div style="display:flex; gap:10px;">
                <button onclick="skipWorkoutRating()" style="flex:1; padding:14px; border-radius:14px; border:2px solid #e2e8f0; background:white; color:var(--text-muted); font-weight:600; font-size:0.95rem; cursor:pointer;">
                    Skip
                </button>
                <button id="save-rating-btn" onclick="saveWorkoutRating()" style="flex:2; padding:14px; border-radius:14px; border:none; background:var(--primary); color:white; font-weight:700; font-size:0.95rem; cursor:pointer;">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Slider thumb styling */
    #workout-rating-modal input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--primary);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        margin-top: -10px;
    }
    #workout-rating-modal input[type="range"]::-moz-range-thumb {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--primary);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
    }
    #workout-rating-modal input[type="range"]::-webkit-slider-runnable-track {
        height: 8px;
        border-radius: 4px;
    }
    #workout-rating-modal input[type="range"]::-moz-range-track {
        height: 8px;
        border-radius: 4px;
    }
</style>

<!-- LOG ACTIVITY VIEW -->
<div id="view-log-activity" class="app-view" style="display:none; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 500; background: var(--bg); color: var(--text-main); overflow-y: auto;">
    <div style="padding: 0 20px 120px 20px; max-width: 500px; margin: 0 auto;">

        <!-- Header -->
        <div style="display: flex; align-items: center; padding: 16px 0; gap: 12px; position: sticky; top: 0; background: var(--bg); z-index: 10;">
            <div style="width: 40px;"></div>
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0; flex: 1; text-align: center;">Log Activity</h2>
            <div style="width: 40px;"></div>
        </div>

        <!-- Activity Type Grid -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Activity Type</div>
            <div id="activity-type-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
        </div>

        <!-- Custom Label -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px;">Session Name <span style="font-weight:400; text-transform:none;">(optional)</span></div>
            <input id="activity-label-input" type="text" placeholder="e.g. Morning Boxing, Barry's Bootcamp" style="width: 100%; padding: 14px 16px; border-radius: 14px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 1rem; box-sizing: border-box; outline: none;" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='var(--border)'">
        </div>

        <!-- Duration -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Duration</div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; background: var(--card-bg); border-radius: 16px; padding: 16px; border: 2px solid var(--border);">
                <button onclick="adjustActivityDuration(-5)" style="width: 44px; height: 44px; border-radius: 50%; background: var(--border); border: none; font-size: 1.3rem; cursor: pointer; color: var(--text-main); font-weight: 700;">−</button>
                <div style="text-align: center; min-width: 80px;">
                    <div id="activity-duration-display" style="font-size: 2rem; font-weight: 800; font-family: monospace;">30</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">minutes</div>
                </div>
                <button onclick="adjustActivityDuration(5)" style="width: 44px; height: 44px; border-radius: 50%; background: var(--border); border: none; font-size: 1.3rem; cursor: pointer; color: var(--text-main); font-weight: 700;">+</button>
            </div>
        </div>

        <!-- Intensity -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Intensity</div>
            <div id="activity-intensity-row" style="display: flex; gap: 8px;">
                <button onclick="selectActivityIntensity('light')" class="intensity-btn" data-intensity="light" style="flex: 1; padding: 14px 8px; border-radius: 14px; border: 2px solid var(--border); background: var(--card-bg); cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 1.2rem;">🚶</div>
                    <div style="font-weight: 700; font-size: 0.85rem; margin-top: 4px; color: var(--text-main);">Light</div>
                </button>
                <button onclick="selectActivityIntensity('moderate')" class="intensity-btn" data-intensity="moderate" style="flex: 1; padding: 14px 8px; border-radius: 14px; border: 2px solid #0ea5e9; background: rgba(14,165,233,0.1); cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 1.2rem;">🏃</div>
                    <div style="font-weight: 700; font-size: 0.85rem; margin-top: 4px; color: var(--text-main);">Moderate</div>
                </button>
                <button onclick="selectActivityIntensity('vigorous')" class="intensity-btn" data-intensity="vigorous" style="flex: 1; padding: 14px 8px; border-radius: 14px; border: 2px solid var(--border); background: var(--card-bg); cursor: pointer; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 1.2rem;">🔥</div>
                    <div style="font-weight: 700; font-size: 0.85rem; margin-top: 4px; color: var(--text-main);">Vigorous</div>
                </button>
            </div>
        </div>

        <!-- Estimated Calories -->
        <div style="margin-bottom: 24px; background: linear-gradient(135deg, #0c4a6e, #0284c7); border-radius: 16px; padding: 20px; color: white; text-align: center;">
            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Estimated Burn</div>
            <div style="display: flex; align-items: baseline; justify-content: center; gap: 4px; margin-top: 6px;">
                <span id="activity-calories-display" style="font-size: 2.2rem; font-weight: 800;">0</span>
                <span style="font-size: 1rem; opacity: 0.8;">kcal</span>
            </div>
        </div>

        <!-- Photo Section -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Venue Photo</div>
            <div id="activity-photo-preview" style="display: none; margin-bottom: 12px; border-radius: 16px; overflow: hidden; position: relative;">
                <img id="activity-photo-img" src="" style="width: 100%; max-height: 250px; object-fit: cover;">
                <button onclick="removeActivityPhoto()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.1rem;">×</button>
            </div>
            <button id="activity-photo-btn" onclick="captureActivityPhoto()" style="width: 100%; padding: 16px; border-radius: 14px; border: 2px dashed var(--border); background: var(--card-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--text-main);">
                <span style="font-size: 1.3rem;">📸</span>
                <span style="font-weight: 600;">Add venue photo for XP</span>
            </button>
            <input id="activity-photo-input" type="file" accept="image/*" capture="environment" style="display: none;" onchange="handleActivityPhotoCapture(this)">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; text-align: center;">Photos of gyms, courts, pools, treadmills = XP. Outdoor scenery = no XP.</div>
        </div>

        <!-- Notes -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px;">Notes <span style="font-weight:400; text-transform:none;">(optional)</span></div>
            <textarea id="activity-notes-input" placeholder="How was your session?" rows="3" style="width: 100%; padding: 14px 16px; border-radius: 14px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 1rem; box-sizing: border-box; resize: none; outline: none; font-family: inherit;" onfocus="this.style.borderColor='#0ea5e9'" onblur="this.style.borderColor='var(--border)'"></textarea>
        </div>

        <!-- Save Button -->
        <button id="activity-save-btn" onclick="saveActivity()" style="width: 100%; padding: 18px; border-radius: 16px; background: linear-gradient(135deg, #0ea5e9, #06b6d4); color: white; border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer; box-shadow: 0 8px 20px rgba(14,165,233,0.3);">
            Log Activity
        </button>
    </div>
</div>

<!-- ACTIVITY SUCCESS VIEW -->
<div id="view-activity-success" class="app-view" style="display:none; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 500; background: linear-gradient(135deg, #0c4a6e, #0284c7, #0ea5e9); color: white; overflow-y: auto;">
    <div style="padding: 20px; text-align: center; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column;">

        <!-- Header -->
        <div style="padding: 30px 15px 20px;">
            <div id="activity-success-emoji" style="font-size: 3.5rem; margin-bottom: 10px;">🏃</div>
            <h1 style="font-family: 'Playfair Display', serif; font-size: 2rem; margin: 0; color: white;">Activity Logged!</h1>
            <p id="activity-success-label" style="font-size: 1rem; opacity: 0.9; margin-top: 5px;">Great work</p>
        </div>

        <!-- Stats -->
        <div style="display: flex; gap: 10px; margin: 15px 0;">
            <div style="flex: 1; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Duration</div>
                <div id="activity-success-duration" style="font-size: 1.6rem; font-weight: 700; margin-top: 5px;">30 min</div>
            </div>
            <div style="flex: 1; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Calories</div>
                <div id="activity-success-calories" style="font-size: 1.6rem; font-weight: 700; margin-top: 5px;">0 kcal</div>
            </div>
            <div style="flex: 1; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 14px;">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Intensity</div>
                <div id="activity-success-intensity" style="font-size: 1.6rem; font-weight: 700; margin-top: 5px;">🏃</div>
            </div>
        </div>

        <!-- Share Section -->
        <div id="activity-share-section" style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 16px; margin: 15px 0;">
            <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 10px;">Share to Feed</div>
            <button id="activity-share-btn" onclick="shareActivityCardToFeed()" style="width: 100%; background: white; color: #0284c7; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem;">
                <span style="font-size: 1.2rem;">📤</span>
                <span id="activity-share-btn-text">Share Activity Card</span>
            </button>
        </div>

        <!-- XP Status -->
        <div id="activity-xp-status" style="display: none; padding: 12px 20px; border-radius: 14px; margin: 10px 0;"></div>

        <!-- No XP hint -->
        <div id="activity-no-xp-hint" style="display: none; background: rgba(255,255,255,0.1); padding: 12px 20px; border-radius: 14px; margin: 10px 0;">
            <div style="font-size: 0.85rem; opacity: 0.85;">💡 Take a photo of your venue next time to earn XP!</div>
        </div>

        <!-- Done Button -->
        <div style="padding: 15px 0 100px 0; margin-top: 10px;">
            <button onclick="closeActivitySuccess()" style="background: white; color: #0284c7; border: none; padding: 16px 60px; border-radius: 50px; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.2); width: 100%; max-width: 280px;">
                DONE
            </button>
        </div>
    </div>
</div>

<!-- QUICK SHARE TO GROUP CHAT MODAL -->
<div id="quick-share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); z-index: 2000; overflow-y: auto; padding: 20px 10px;">
    <div style="background: white; width: 100%; max-width: 480px; margin: 0 auto; border-radius: 28px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative;">
        <!-- Header -->
        <div style="padding: 22px 25px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, var(--primary), #4ade80); position: sticky; top: 0; z-index: 10;">
            <div style="font-weight: 800; color: white; font-size: 1.25rem; font-family: 'Playfair Display', serif;">Share Your Win</div>
            <div onclick="closeQuickShareModal()" style="color: white; cursor: pointer; font-size: 1.8rem; line-height: 1; padding: 5px;">&times;</div>
        </div>

        <div style="padding-bottom: 30px;">
            <!-- Win Preview -->
            <div id="quick-share-preview" style="padding: 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border: 1px solid #edf2f7;">
                    <div id="quick-share-badge" style="font-size: 2.5rem; margin-bottom: 12px;">🏆</div>
                    <div id="quick-share-message" style="font-size: 1.1rem; font-weight: 700; color: var(--text-main); line-height: 1.4;"></div>
                    <div id="quick-share-detail" style="font-size: 0.9rem; color: var(--text-muted); margin-top: 8px;"></div>
                </div>
            </div>

            <!-- Lift Selection -->
            <div id="lift-selection-section" style="display: none; padding: 20px; border-bottom: 1px solid #f1f5f9;">
                <div style="font-weight: 700; color: var(--text-main); margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="dumbbell" size="18" style="color: var(--primary);"></i> What do you want to share?
                </div>
                <div id="lift-selection-list" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <!-- Lifts populated here -->
                </div>
                <div id="multi-select-hint" style="display: none; margin-top: 12px; padding: 10px 14px; background: #f0fdf4; border-radius: 10px; font-size: 0.85rem; color: #166534; text-align: center;">
                    <strong>Tip:</strong> Tap multiple sets to share them together
                </div>
            </div>

            <!-- External Share Options -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9;">
                <div style="font-weight: 700; color: var(--text-main); margin-bottom: 15px; font-size: 1rem;">Share externally:</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <button onclick="shareWinToMessenger()" style="padding: 14px; background: #0084FF; color: white; border: none; border-radius: 16px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(0,132,255,0.25);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.36 2 2 6.13 2 11.7c0 2.91 1.19 5.44 3.14 7.17.16.14.26.34.29.54l.05 1.78c.04.59.64.96 1.17.72l1.98-.87c.17-.07.36-.09.53-.05.86.23 1.81.35 2.84.35 5.64 0 10-4.13 10-9.7C22 6.13 17.64 2 12 2zm5.89 7.58l-2.88 4.57c-.46.73-1.44.93-2.16.44l-2.29-1.72c-.19-.14-.45-.14-.64 0l-3.09 2.34c-.41.31-.95-.18-.68-.62l2.88-4.57c.46-.73 1.44-.93 2.16-.44l2.29 1.72.19.14.45.14.64 0l3.09-2.34c.41-.31.95.18.68.62z"/></svg> Messenger
                    </button>
                    <button onclick="shareWinToWhatsApp()" style="padding: 14px; background: #25D366; color: white; border: none; border-radius: 16px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(37,211,102,0.25);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> WhatsApp
                    </button>
                    <button onclick="copyWinMessage()" style="grid-column: span 2; padding: 14px; background: #f1f5f9; color: var(--text-main); border: 1px solid #e2e8f0; border-radius: 16px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> Copy Message
                    </button>
                </div>
            </div>

            <!-- Group Chat Selection -->
            <div style="padding: 20px;">
                <div style="font-weight: 700; color: var(--text-main); margin-bottom: 20px; font-size: 1rem;">Or share to a group chat:</div>
                <div id="quick-share-chats-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Chats will be loaded here -->
                </div>
                <div id="quick-share-no-chats" style="display: none; text-align: center; padding: 40px; color: var(--text-muted); background: #f8fafc; border-radius: 20px; border: 1px dashed #cbd5e0;">
                    <div style="font-size: 2.5rem; margin-bottom: 12px;">💬</div>
                    <p style="font-weight: 500;">No group chats yet!</p>
                    <button onclick="closeQuickShareModal(); goToGroupChatsToShare();" style="background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: 700; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 12px rgba(123, 168, 131, 0.3);">
                        Create a Chat
                    </button>
                </div>
            </div>

            <!-- Footer Action -->
            <div style="padding: 0 20px 20px 20px; text-align: center;">
                <button onclick="closeQuickShareModal()" style="width: 100%; padding: 16px; background: white; color: var(--text-muted); border: 1px solid #e2e8f0; border-radius: 50px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s;">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<!-- INTERVAL TIMER / STOPWATCH VIEW -->
<div id="view-interval-timer" class="app-view" style="display:none; height: 100vh; position: fixed; top: 0; left: 0; width: 100%; z-index: 500; background: var(--bg); overflow-y: auto;">
    <div style="padding: 0 20px 120px 20px; max-width: 500px; margin: 0 auto;">

        <!-- Header -->
        <div style="display: flex; align-items: center; justify-content: center; padding: calc(16px + env(safe-area-inset-top, 0px)) 0 16px 0; position: sticky; top: 0; background: var(--bg); z-index: 10;">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0; text-align: center;">Interval Timer</h2>
        </div>

        <!-- Setup Section (shown before timer starts) -->
        <div id="interval-timer-setup">
            <!-- Natural Language Input -->
            <div style="margin-bottom: 24px;">
                <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px;">Describe your timer</div>
                <input id="interval-timer-input" type="text" placeholder='e.g. "40/20 x6" or "30 on 10 off 8 rounds"'
                    style="width: 100%; padding: 16px 18px; border-radius: 16px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 1.1rem; box-sizing: border-box; outline: none; font-weight: 600;"
                    onfocus="this.style.borderColor='#f59e0b'" onblur="this.style.borderColor='var(--border)'"
                    onkeydown="if(event.key==='Enter') parseAndPreviewTimer()">
                <div style="font-size: 0.78rem; color: var(--text-muted); margin-top: 8px; line-height: 1.5;">
                    Try: <span onclick="document.getElementById('interval-timer-input').value='40/20 x6'; parseAndPreviewTimer();" style="color:#f59e0b; cursor:pointer; font-weight:600;">40/20 x6</span> &middot;
                    <span onclick="document.getElementById('interval-timer-input').value='30 on 15 off 10 rounds'; parseAndPreviewTimer();" style="color:#f59e0b; cursor:pointer; font-weight:600;">30 on 15 off 10 rounds</span> &middot;
                    <span onclick="document.getElementById('interval-timer-input').value='tabata'; parseAndPreviewTimer();" style="color:#f59e0b; cursor:pointer; font-weight:600;">tabata</span> &middot;
                    <span onclick="document.getElementById('interval-timer-input').value='EMOM 10 min'; parseAndPreviewTimer();" style="color:#f59e0b; cursor:pointer; font-weight:600;">EMOM 10 min</span>
                </div>
            </div>

            <!-- Preview Card (hidden until parsed) -->
            <div id="interval-timer-preview" style="display:none; margin-bottom: 24px;">
                <div style="background: linear-gradient(135deg, #451a03, #78350f); border-radius: 20px; padding: 24px; color: white;">
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div id="interval-preview-title" style="font-size: 1.3rem; font-weight: 800; margin-bottom: 4px;">40s Work / 20s Rest</div>
                        <div id="interval-preview-subtitle" style="font-size: 0.85rem; opacity: 0.8;">6 rounds &middot; 6:00 total</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; text-align: center;">
                            <div id="interval-preview-work" style="font-size: 1.6rem; font-weight: 800;">40s</div>
                            <div style="font-size: 0.7rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px;">Work</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; text-align: center;">
                            <div id="interval-preview-rest" style="font-size: 1.6rem; font-weight: 800;">20s</div>
                            <div style="font-size: 0.7rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px;">Rest</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; text-align: center;">
                            <div id="interval-preview-rounds" style="font-size: 1.6rem; font-weight: 800;">6</div>
                            <div style="font-size: 0.7rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px;">Rounds</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Adjust Section -->
            <div id="interval-timer-manual" style="display:none; margin-bottom: 24px;">
                <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Adjust</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <!-- Work time -->
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">Work (s)</div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <button onclick="adjustIntervalValue('work', -5)" style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); border: none; font-size: 1rem; cursor: pointer; color: var(--text-main); font-weight: 700;">-</button>
                            <input id="interval-work-input" type="number" value="40" min="5" max="300" style="width: 100%; text-align: center; padding: 8px 2px; border-radius: 10px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 1.1rem; font-weight: 700; box-sizing: border-box; outline: none;" onchange="updateIntervalPreview()">
                            <button onclick="adjustIntervalValue('work', 5)" style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); border: none; font-size: 1rem; cursor: pointer; color: var(--text-main); font-weight: 700;">+</button>
                        </div>
                    </div>
                    <!-- Rest time -->
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">Rest (s)</div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <button onclick="adjustIntervalValue('rest', -5)" style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); border: none; font-size: 1rem; cursor: pointer; color: var(--text-main); font-weight: 700;">-</button>
                            <input id="interval-rest-input" type="number" value="20" min="0" max="300" style="width: 100%; text-align: center; padding: 8px 2px; border-radius: 10px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 1.1rem; font-weight: 700; box-sizing: border-box; outline: none;" onchange="updateIntervalPreview()">
                            <button onclick="adjustIntervalValue('rest', 5)" style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); border: none; font-size: 1rem; cursor: pointer; color: var(--text-main); font-weight: 700;">+</button>
                        </div>
                    </div>
                    <!-- Rounds -->
                    <div style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">Rounds</div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <button onclick="adjustIntervalValue('rounds', -1)" style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); border: none; font-size: 1rem; cursor: pointer; color: var(--text-main); font-weight: 700;">-</button>
                            <input id="interval-rounds-input" type="number" value="6" min="1" max="100" style="width: 100%; text-align: center; padding: 8px 2px; border-radius: 10px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 1.1rem; font-weight: 700; box-sizing: border-box; outline: none;" onchange="updateIntervalPreview()">
                            <button onclick="adjustIntervalValue('rounds', 1)" style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); border: none; font-size: 1rem; cursor: pointer; color: var(--text-main); font-weight: 700;">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Start Button -->
            <button id="interval-start-btn" onclick="startIntervalTimer()" style="display:none; width: 100%; padding: 18px; border-radius: 16px; background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; border: none; font-size: 1.2rem; font-weight: 800; cursor: pointer; box-shadow: 0 8px 20px rgba(245,158,11,0.3); letter-spacing: 0.5px;">
                Start Timer
            </button>

            <!-- Recent Presets -->
            <div id="interval-recent-presets" style="margin-top: 30px;">
                <div style="font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px;">Quick Presets</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div onclick="loadIntervalPreset(20, 10, 8, 'Tabata')" style="cursor: pointer; background: var(--card-bg); border: 2px solid var(--border); border-radius: 14px; padding: 14px; text-align: center; transition: all 0.2s;">
                        <div style="font-weight: 800; color: var(--text-main); font-size: 1rem;">Tabata</div>
                        <div style="font-size: 0.78rem; color: var(--text-muted); margin-top: 4px;">20/10 x 8</div>
                    </div>
                    <div onclick="loadIntervalPreset(40, 20, 6, '40/20')" style="cursor: pointer; background: var(--card-bg); border: 2px solid var(--border); border-radius: 14px; padding: 14px; text-align: center; transition: all 0.2s;">
                        <div style="font-weight: 800; color: var(--text-main); font-size: 1rem;">40/20</div>
                        <div style="font-size: 0.78rem; color: var(--text-muted); margin-top: 4px;">40/20 x 6</div>
                    </div>
                    <div onclick="loadIntervalPreset(30, 30, 10, '30/30')" style="cursor: pointer; background: var(--card-bg); border: 2px solid var(--border); border-radius: 14px; padding: 14px; text-align: center; transition: all 0.2s;">
                        <div style="font-weight: 800; color: var(--text-main); font-size: 1rem;">30/30</div>
                        <div style="font-size: 0.78rem; color: var(--text-muted); margin-top: 4px;">30/30 x 10</div>
                    </div>
                    <div onclick="loadIntervalPreset(45, 15, 8, '45/15')" style="cursor: pointer; background: var(--card-bg); border: 2px solid var(--border); border-radius: 14px; padding: 14px; text-align: center; transition: all 0.2s;">
                        <div style="font-weight: 800; color: var(--text-main); font-size: 1rem;">45/15</div>
                        <div style="font-size: 0.78rem; color: var(--text-muted); margin-top: 4px;">45/15 x 8</div>
                    </div>
                    <div onclick="loadIntervalPreset(60, 0, 10, 'EMOM')" style="cursor: pointer; background: var(--card-bg); border: 2px solid var(--border); border-radius: 14px; padding: 14px; text-align: center; transition: all 0.2s;">
                        <div style="font-weight: 800; color: var(--text-main); font-size: 1rem;">EMOM</div>
                        <div style="font-size: 0.78rem; color: var(--text-muted); margin-top: 4px;">60s x 10 min</div>
                    </div>
                    <div onclick="loadIntervalPreset(50, 10, 5, '50/10')" style="cursor: pointer; background: var(--card-bg); border: 2px solid var(--border); border-radius: 14px; padding: 14px; text-align: center; transition: all 0.2s;">
                        <div style="font-weight: 800; color: var(--text-main); font-size: 1rem;">50/10</div>
                        <div style="font-size: 0.78rem; color: var(--text-muted); margin-top: 4px;">50/10 x 5</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Timer Section (hidden until timer starts) -->
        <div id="interval-timer-active" style="display:none;">
            <!-- Timer Ring -->
            <div style="display: flex; justify-content: center; margin: 20px 0 30px;">
                <div style="position: relative; width: 260px; height: 260px;">
                    <svg viewBox="0 0 260 260" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                        <circle cx="130" cy="130" r="115" fill="none" stroke="#e2e8f0" stroke-width="12"/>
                        <circle id="interval-timer-ring" cx="130" cy="130" r="115" fill="none"
                            stroke="#f59e0b" stroke-width="12"
                            stroke-linecap="round"
                            stroke-dasharray="722.57"
                            stroke-dashoffset="0"
                            style="transition: stroke-dashoffset 0.3s linear, stroke 0.3s ease;"/>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div id="interval-timer-phase" style="font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-bottom: 4px;">WORK</div>
                        <div id="interval-timer-display" style="font-size: 4rem; font-weight: 800; color: var(--text-main); font-family: monospace; line-height: 1;">00:40</div>
                        <div id="interval-timer-round" style="font-size: 0.9rem; color: var(--text-muted); margin-top: 6px; font-weight: 600;">Round 1 / 6</div>
                    </div>
                </div>
            </div>

            <!-- Phase indicator dots -->
            <div id="interval-round-dots" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 30px; flex-wrap: wrap; max-width: 300px; margin-left: auto; margin-right: auto;"></div>

            <!-- Controls -->
            <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 20px;">
                <button id="interval-pause-btn" onclick="togglePauseIntervalTimer()" style="flex: 1; max-width: 180px; padding: 16px; border-radius: 16px; background: #f59e0b; color: white; border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer;">
                    Pause
                </button>
                <button onclick="resetIntervalTimer()" style="flex: 1; max-width: 180px; padding: 16px; border-radius: 16px; background: var(--border); color: var(--text-main); border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer;">
                    Reset
                </button>
            </div>

            <!-- Skip round -->
            <div style="text-align: center;">
                <button onclick="skipIntervalPhase()" style="padding: 10px 24px; border-radius: 12px; background: transparent; color: var(--text-muted); border: 1px solid var(--border); font-size: 0.85rem; font-weight: 600; cursor: pointer;">
                    Skip &raquo;
                </button>
            </div>
        </div>

        <!-- Completed Section (hidden until done) -->
        <div id="interval-timer-done" style="display:none; text-align: center; padding-top: 60px;">
            <div style="font-size: 4rem; margin-bottom: 16px;">&#127881;</div>
            <div style="font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin-bottom: 8px;">Done!</div>
            <div id="interval-done-summary" style="font-size: 1rem; color: var(--text-muted); margin-bottom: 40px;">6 rounds completed &middot; 6:00</div>
            <button onclick="resetIntervalTimer()" style="padding: 16px 40px; border-radius: 16px; background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer; margin-bottom: 12px;">
                Go Again
            </button>
            <br>
            <button onclick="closeIntervalTimer()" style="padding: 14px 40px; border-radius: 16px; background: var(--border); color: var(--text-main); border: none; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 8px;">
                Back to Movement
            </button>
        </div>
    </div>
</div>

<!-- WORKOUT LIBRARY CATEGORIES VIEW -->
<div id="view-workout-library" class="app-view" style="display:none; height: 100vh; background: white; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Workout Library</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;">
            Choose your workout style and browse our complete library of professionally designed workouts.
        </p>

        <div id="library-categories-grid" style="display: grid; gap: 15px;">
            <!-- Categories will be dynamically inserted here -->
        </div>

        <!-- Create Custom Exercise Section -->
        <div style="margin-top: 30px; padding-top: 25px; border-top: 2px solid #f1f5f9;">
            <div onclick="openCreateCustomExerciseModal('library')" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px solid #bbf7d0; border-radius: 16px; padding: 20px; cursor: pointer; display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), #4ade80); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg viewBox="0 0 24 24" style="width: 26px; height: 26px; fill: white;">
                        <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--text-main); font-size: 1.05rem; margin-bottom: 4px;">Create Custom Exercise</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;">Record your own exercise with video and add it to your personal library</div>
                </div>
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--primary);">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </div>
        </div>
    </div>
</div>

<!-- PRE-BUILT PROGRAMS VIEW -->
<div id="view-prebuilt-programs" class="app-view" style="display:none; height: 100vh; background: white; z-index: 500; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Pre-built Programs</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;">
            Choose from our professionally designed workout programs tailored to your equipment and goals.
        </p>

        <div id="prebuilt-programs-grid" style="display: grid; gap: 20px;">
            <!-- Programs will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- WORKOUT LIBRARY SUBCATEGORIES VIEW -->
<div id="view-workout-subcategories" class="app-view" style="display:none; height: 100vh; background: white; z-index: 501; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div id="subcategory-header-title" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Category</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p id="subcategory-description" style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;"></p>

        <div id="subcategories-grid" style="display: grid; gap: 15px;">
            <!-- Subcategories will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- WORKOUT LIBRARY WORKOUTS LIST VIEW -->
<div id="view-workout-list" class="app-view" style="display:none; height: 100vh; background: white; z-index: 502; position: fixed; top: 0; left: 0; width: 100%; overflow-y: auto;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <div style="width: 40px;"></div>
        <div id="workout-list-header-title" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Workouts</div>
        <div style="width: 40px;"></div>
    </div>

    <div style="padding: 25px; padding-bottom: 100px;">
        <p id="workout-list-description" style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;"></p>

        <div id="workouts-list" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Workouts will be dynamically inserted here -->
        </div>
    </div>
</div>

<style>
.exercise-logger-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

/* Yoga exercise card styles */
.yoga-exercise-card {
    border: 2px solid #dcfce7;
}

.yoga-exercise-card .yoga-timer-section {
    background: linear-gradient(180deg, #ffffff 0%, #f0fdf4 100%);
}

.yoga-timer-section button:active {
    transform: scale(0.95);
}

.yoga-timer-section button:hover {
    opacity: 0.9;
}

.library-category-card {
    background: white;
    border: 2px solid #f1f5f9;
    border-radius: 16px;
    padding: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 20px;
}

.library-category-card:hover {
    border-color: var(--primary);
    background: #f0fdf4;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.library-category-icon {
    font-size: 2.5rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8fafc;
    border-radius: 12px;
}

.library-category-card:hover .library-category-icon {
    background: white;
}

.workout-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.workout-card:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transform: translateY(-1px);
}

.workout-difficulty-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.difficulty-beginner {
    background: #d1fae5;
    color: #065f46;
}

.difficulty-intermediate {
    background: #fed7aa;
    color: #9a3412;
}

.difficulty-advanced {
    background: #fecaca;
    color: #991b1b;
}
</style>

    <!-- ===== SPOTIFY NOW PLAYING MINI PLAYER (global scope for cross-tab visibility) ===== -->
    <div id="spotify-now-playing" style="
        display: none;
        position: fixed;
        bottom: 72px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 32px);
        max-width: 420px;
        background: rgba(18, 18, 18, 0.96);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        border: 1px solid rgba(255,255,255,0.08);
        padding: 12px 14px;
        z-index: 100001;
        color: white;
        font-family: inherit;
        transition: none;
        touch-action: none;
    ">
        <!-- Drag handle -->
        <div style="display:flex; justify-content:center; padding:0 0 6px 0; cursor:grab;">
            <div style="width:32px; height:4px; border-radius:2px; background:rgba(255,255,255,0.25);"></div>
        </div>
        <!-- Clickable left area opens Spotify -->
        <div style="display:flex; align-items:center; gap:12px;">
            <div onclick="openInSpotify()" style="display:flex; align-items:center; gap:12px; flex:1; min-width:0; cursor:pointer;">
                <!-- Album art -->
                <div style="position:relative; flex-shrink:0;">
                    <img id="snp-art" src="" alt="" style="width:48px; height:48px; border-radius:8px; object-fit:cover; background:#333;" onerror="this.style.display='none'">
                    <div id="snp-art-placeholder" style="display:none; width:48px; height:48px; border-radius:8px; background:#1DB954; align-items:center; justify-content:center;">
                        <svg viewBox="0 0 24 24" style="width:24px; height:24px; fill:white;"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                    </div>
                </div>
                <!-- Track info + Spotify link hint -->
                <div style="flex:1; min-width:0;">
                    <div id="snp-track" style="font-weight:600; font-size:0.85rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
                    <div id="snp-artist" style="font-size:0.75rem; color:rgba(255,255,255,0.6); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:1px;"></div>
                </div>
                <!-- External link icon -->
                <svg viewBox="0 0 24 24" style="width:15px; height:15px; fill:rgba(255,255,255,0.35); flex-shrink:0; margin-right:4px;"><path d="M19 19H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
            </div>
            <!-- Controls (separate — don't open full player) -->
            <div style="display:flex; align-items:center; gap:2px; flex-shrink:0;">
                <button id="snp-prev" onclick="spotifyPlayerControl('previous')" title="Previous" style="background:none; border:none; color:white; cursor:pointer; padding:8px; border-radius:50%; display:flex; align-items:center; justify-content:center; opacity:0.8;">
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor;"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
                </button>
                <button id="snp-playpause" onclick="spotifyPlayerControl(window._snpPlaying ? 'pause' : 'play')" title="Play/Pause" style="background:#1DB954; border:none; color:white; cursor:pointer; padding:8px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <svg id="snp-play-icon" viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor;"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="snp-pause-icon" viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor; display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button id="snp-next" onclick="spotifyPlayerControl('next')" title="Next" style="background:none; border:none; color:white; cursor:pointer; padding:8px; border-radius:50%; display:flex; align-items:center; justify-content:center; opacity:0.8;">
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor;"><path d="M6 18l8.5-6L6 6v12zm2-8.14 4.97 3.14L8 16.14V9.86zM16 6h2v12h-2z"/></svg>
                </button>
            </div>
        </div>
        <!-- Progress bar -->
        <div style="margin-top:10px; background:rgba(255,255,255,0.15); border-radius:2px; height:3px; overflow:hidden;">
            <div id="snp-progress" style="height:100%; background:#1DB954; width:0%; transition:width 1s linear; border-radius:2px;"></div>
        </div>
    </div>

    <!-- Spotify mini player drag-to-reposition -->
    <script>
    (function() {
        const bar = document.getElementById('spotify-now-playing');
        if (!bar) return;

        let dragging = false;
        let startY = 0;
        let startBottom = 0;
        let moved = false;
        const MIN_BOTTOM = 72;  // above bottom nav

        function getBottom() {
            return parseInt(bar.style.bottom) || MIN_BOTTOM;
        }

        function clampBottom(b) {
            const maxBottom = window.innerHeight - bar.offsetHeight - 10;
            return Math.max(MIN_BOTTOM, Math.min(b, maxBottom));
        }

        // Restore saved position whenever the bar becomes visible
        function restoreSavedPosition() {
            try {
                const saved = localStorage.getItem('spotify-mini-bottom');
                if (saved) bar.style.bottom = saved;
            } catch(_) {}
        }

        // Patch updatePlayerUI's display toggle so we restore position after it shows the bar
        const _origUpdatePlayerUI = window.updatePlayerUI || null;
        const displayProp = Object.getOwnPropertyDescriptor(CSSStyleDeclaration.prototype, 'display');
        // Use a simpler approach: poll for display changes instead of MutationObserver
        let _lastDisplay = bar.style.display;
        setInterval(function() {
            const cur = bar.style.display;
            if (cur !== 'none' && _lastDisplay === 'none') restoreSavedPosition();
            _lastDisplay = cur;
        }, 500);

        bar.addEventListener('touchstart', function(e) {
            // Don't hijack button taps — only drag from the bar area itself
            if (e.target.closest('button')) return;
            dragging = true;
            moved = false;
            startY = e.touches[0].clientY;
            startBottom = getBottom();
            bar.style.transition = 'none';
        }, { passive: true });

        bar.addEventListener('touchmove', function(e) {
            if (!dragging) return;
            const dy = startY - e.touches[0].clientY;
            if (Math.abs(dy) > 5) moved = true;
            if (!moved) return;
            e.preventDefault();
            bar.style.bottom = clampBottom(startBottom + dy) + 'px';
        }, { passive: false });

        bar.addEventListener('touchend', function() {
            if (!dragging) return;
            dragging = false;
            // Save position so it persists while music plays
            try { localStorage.setItem('spotify-mini-bottom', bar.style.bottom); } catch(_) {}
        }, { passive: true });

        // Suppress onclick/openInSpotify when user was dragging
        bar.addEventListener('click', function(e) {
            if (moved) { e.stopPropagation(); e.preventDefault(); moved = false; }
        }, true);
    })();
    </script>

    <!-- Bottom Navigation (Moved Outside Container) -->
    <nav class="bottom-nav" style="z-index: 9999 !important; position: fixed; bottom: 0; left: 0; width: 100%;">
        <button class="nav-item active" onclick="switchAppTab('dashboard', this)">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('meals', this)">
            <svg viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>
            <span>Nutrition</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('movement-tab', this)">
            <svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 16.29 22 18.43 19.86 19.86 21.29 21.29 19.86l-1.43-1.43L21.29 17l-1.43-1.43L18.43 17l-3.57-3.57z"/></svg>
            <span>Movement</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('learning', this)">
            <svg viewBox="0 0 24 24"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/></svg>
            <span>Learn</span>
        </button>
        <button class="nav-item" id="nav-cycle-btn" onclick="switchAppTab('cycle', this)">
           <svg id="nav-cycle-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.22-7.52-3.22 3.22 7.52 3.22-7.52z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
           <span id="nav-cycle-label">Cycle</span>
        </button>
        <button class="nav-item" onclick="switchAppTab('friends', this)" style="position: relative;">
            <svg viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/></svg>
            <span>Feed</span>
            <div id="feed-nav-badge" style="display: none; position: absolute; top: 2px; right: calc(50% - 18px); width: 16px; height: 16px; background: #ef4444; color: white; font-size: 0.6rem; font-weight: 700; border-radius: 50%; align-items: center; justify-content: center;"></div>
        </button>
     </nav>

    <!-- FRIENDS VIEW (now primarily a Feed view) -->
    <div id="view-friends" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc;">
        <!-- Header -->
        <div style="padding: 20px 25px; padding-top: calc(20px + env(safe-area-inset-top, 0px)); background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
            <div>
                <h2 style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.5rem;">Feed</h2>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <!-- Coin Balance Widget -->
                <div class="coin-header-widget" onclick="openCoinShop()">
                    <span class="coin-emoji">🪙</span>
                    <span class="coin-amount coin-balance-sync">0</span>
                    <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
                </div>
                <!-- Message Inbox Icon (now holds Group Chats + Friends) -->
                <div onclick="openFeedMessagesPanel()" style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-muted);"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                    <div id="message-inbox-badge" style="display: none; position: absolute; top: -2px; right: -2px; width: 18px; height: 18px; background: #ef4444; color: white; font-size: 0.65rem; font-weight: 700; border-radius: 50%; align-items: center; justify-content: center;"></div>
                </div>
                <!-- Add Friend Button -->
                <div onclick="openAddFriendModal()" style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-muted);"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <!-- New Post Button -->
                <button onclick="openStoryCamera()" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: none;" stroke="white" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    Post
                </button>
            </div>
        </div>

        <!-- Referral Banner -->
        <div id="friends-referral-banner" style="margin: 15px; padding: 20px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 16px; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2); position: relative;">
            <button onclick="this.parentElement.style.display='none'; localStorage.setItem('referral_banner_dismissed','true');" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.25); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: white; line-height: 1;">×</button>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-right: 20px;">
                <div style="font-size: 2rem;">🎁</div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.1rem; color: white; margin-bottom: 4px;">You BOTH Get 1 Week Double XP!</div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.9);">Invite friends and you each get 1 week double XP when they join</div>
                </div>
            </div>
            <button onclick="openShareReferralModal()" style="width: 100%; background: white; color: #059669; border: none; padding: 12px; border-radius: 10px; font-size: 0.95rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #059669;"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                Share Your Link
            </button>
        </div>

        <!-- Points incentive for posting -->
        <div id="feed-post-incentive" style="margin: 0 15px 12px 15px; padding: 10px 14px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 10px; display: flex; align-items: center; gap: 10px; border: 1px solid #fcd34d; position: relative;">
            <button onclick="this.parentElement.style.display='none'; localStorage.setItem('feed_incentive_dismissed','true');" style="position: absolute; top: 6px; right: 6px; background: rgba(146,64,14,0.15); border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #92400e; line-height: 1;">×</button>
            <span style="font-size: 1.2rem;">+1</span>
            <span style="font-size: 0.8rem; color: #92400e; font-weight: 600; padding-right: 16px;">Post a workout photo to earn 1 XP!</span>
        </div>

        <!-- Challenge a Friend Banner -->
        <div style="margin: 0 15px 12px; padding: 14px 16px; background: linear-gradient(135deg, #1a1a2e 0%, #2e1a0e 50%, #3d2e0a 100%); border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 20px rgba(245,158,11,0.1); cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255,255,255,0.08);" onclick="openGameChallengeModal()">
            <div style="width: 44px; height: 44px; background: rgba(251,191,36,0.15); border: 1px solid rgba(251,191,36,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">🎮</div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 800; font-size: 0.95rem; color: #fbbf24; margin-bottom: 2px; text-shadow: 0 0 15px rgba(251,191,36,0.3);">Challenge a Friend</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Chess, Checkers, Connect 4 & more - bet coins!</div>
            </div>
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: rgba(251,191,36,0.6); flex-shrink: 0;"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
        </div>

        <!-- Active Games Container (populated dynamically) -->
        <div id="active-games-container" style="display: none;"></div>

        <!-- Friends Feed - Full photo feed grid -->
        <div id="friends-feed-section" style="padding: 0;">
            <div id="friends-photo-feed" style="display: flex; flex-direction: column; gap: 0; padding: 0;">
                <!-- Feed posts will be loaded here -->
            </div>
            <div id="friends-feed-empty" style="display: none; text-align: center; padding: 40px 20px;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">📸</div>
                <div style="font-size: 0.95rem; color: var(--text-main); font-weight: 600; margin-bottom: 5px;">No posts yet</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">Be the first to share a workout photo!</div>
                <button onclick="openStoryCamera()" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 10px 24px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; cursor: pointer;">
                    Share a Post
                </button>
            </div>
        </div>


        <!-- Hidden stories carousel (kept for compatibility) -->
        <div id="friends-stories-section" style="display: none;">
            <div id="friends-stories-carousel" style="display: flex; gap: 15px;">
                <div class="story-ring add-story-btn" onclick="openStoryCamera()" style="display: inline-block; text-align: center; cursor: pointer; flex-shrink: 0;"></div>
            </div>
        </div>

        <!-- Group Chats & Friends - now hidden, accessible via messages panel -->
        <div id="friends-messaging-section" style="display: none;">
            <div id="group-chats-container" style="display: flex; flex-direction: column; gap: 12px;">
                <div id="group-chats-empty" style="text-align: center; padding: 30px 20px; background: white; border-radius: 12px; border: 1px solid #f1f5f9;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">💬</div>
                    <div style="font-size: 0.95rem; color: var(--text-main); font-weight: 600; margin-bottom: 5px;">No group chats yet</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">Start a group chat to share wins with friends!</div>
                    <button onclick="openCreateGroupChatModal()" style="background: linear-gradient(135deg, var(--primary), #10b981); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer;">
                        Create Your First Group
                    </button>
                </div>
            </div>
            <div id="friends-cards-container" style="display: flex; flex-direction: column; gap: 2px; background: white; border-radius: 12px; overflow: hidden; border: 1px solid #f1f5f9;">
                <div onclick="openCoachChatFromFriends()" style="display: flex; align-items: center; padding: 12px 16px; cursor: pointer; background: linear-gradient(90deg, rgba(123,168,131,0.08) 0%, transparent 100%); border-bottom: 1px solid #f1f5f9;">
                    <div style="position: relative; margin-right: 12px;">
                        <div style="width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--primary);">
                            <img src="assets/coach_shannon.jpg" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<span style=\'color: white; font-size: 1.4rem; font-weight: 700;\'>S</span>'">
                        </div>
                        <div style="position: absolute; bottom: 2px; right: 2px; width: 14px; height: 14px; background: #22c55e; border-radius: 50%; border: 2px solid white;"></div>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">Coach Shannon</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);"><span style="color: var(--primary); font-weight: 500;">Your wellness guide</span></div>
                    </div>
                    <div style="width: 36px; height: 36px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--text-muted);"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                    </div>
                </div>
                <div id="friends-cards-list"></div>
            </div>
        </div>
    </div>

    <!-- USER PROFILE VIEW (View another user's profile from the feed) -->
    <div id="view-user-profile" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc; overflow-x: hidden;">
        <!-- Header -->
        <div style="padding: 16px 20px; background: white; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 10;">
            <h2 id="user-profile-header-name" style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.3rem; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Profile</h2>
        </div>

        <!-- Profile Top Section: Photo, Name, Level, Strength -->
        <div id="user-profile-top" style="background: white; padding: 24px 20px 20px; text-align: center; border-bottom: 1px solid #f1f5f9;">
            <div id="user-profile-avatar" style="width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; margin: 0 auto 14px; overflow: hidden; border: 3px solid var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <span style="font-size: 2.2rem; color: white; font-weight: 700;">?</span>
            </div>
            <h2 id="user-profile-name" style="margin: 0 0 4px; font-size: 1.3rem; font-weight: 700; color: var(--text-main);"></h2>
            <div id="user-profile-level-badge" style="display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 5px 14px; border-radius: 20px; margin-bottom: 12px; border: 1px solid #fcd34d;">
                <span style="font-size: 0.8rem; font-weight: 700; color: #92400e;">Lv. <span id="user-profile-level">1</span></span>
                <span style="font-size: 0.75rem; color: #a16207; font-weight: 600;" id="user-profile-level-title">Newcomer</span>
            </div>
            <!-- Stats row: Workouts, Streak, Points -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
                <div style="text-align: center;">
                    <div id="user-profile-workouts" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">0</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Workouts</div>
                </div>
                <div style="text-align: center;">
                    <div id="user-profile-streak" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">0</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Day Streak</div>
                </div>
                <div style="text-align: center;">
                    <div id="user-profile-points" style="font-size: 1.2rem; font-weight: 800; color: var(--text-main);">0</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">XP</div>
                </div>
            </div>
        </div>

        <!-- Tamagotchi / FitGotchi Section -->
        <div id="user-profile-tamagotchi-section" style="padding: 0 20px 10px; display: none;">
            <div style="background: #1a1a2e; border-radius: 16px; overflow: hidden; height: 260px; position: relative;">
                <model-viewer
                    id="user-profile-tamagotchi-model"
                    camera-controls
                    disable-zoom
                    disable-pan
                    auto-rotate
                    rotation-intensity="0.5"
                    shadow-intensity="1.5"
                    shadow-softness="0.8"
                    exposure="0.9"
                    environment-image="neutral"
                    camera-orbit="0deg 85deg 22m"
                    field-of-view="55deg"
                    min-field-of-view="20deg"
                    max-field-of-view="120deg"
                    style="width: 100%; height: 100%; --poster-color: #1a1a2e; touch-action: pan-y;"
                    interaction-prompt="none">
                </model-viewer>
                <!-- Fallback -->
                <div id="user-profile-tamagotchi-fallback" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:4; background:#1a1a2e; justify-content:center; align-items:center; flex-direction:column; text-align:center; color:white; padding:20px;">
                    <div style="font-size:48px; margin-bottom:8px;">🐣</div>
                    <div style="font-size:0.9rem; font-weight:600;">FitGotchi</div>
                </div>
            </div>
        </div>

        <!-- Personal Bests Section -->
        <div id="user-profile-pbs-section" style="padding: 20px; display: none;">
            <h3 style="margin: 0 0 14px; font-size: 1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">🏋️</span> Personal Bests
            </h3>
            <div id="user-profile-pbs-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                <!-- PB cards rendered dynamically -->
            </div>
        </div>

        <!-- Badges / Milestones Section -->
        <div id="user-profile-badges-section" style="padding: 0 20px 20px; display: none;">
            <h3 style="margin: 0 0 14px; font-size: 1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">🏅</span> Badges
            </h3>
            <div id="user-profile-badges-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <!-- Badge cards rendered dynamically -->
            </div>
        </div>

        <!-- Posts Section -->
        <div id="user-profile-posts-section" style="padding: 0 20px 20px;">
            <h3 style="margin: 0 0 14px; font-size: 1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">📸</span> Posts
            </h3>
            <div id="user-profile-posts-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; border-radius: 12px; overflow: hidden;">
                <!-- Post thumbnails rendered dynamically -->
            </div>
            <div id="user-profile-posts-empty" style="display: none; text-align: center; padding: 30px 20px; background: white; border-radius: 12px; border: 1px solid #f1f5f9;">
                <div style="font-size: 2rem; margin-bottom: 8px;">📷</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">No posts yet</div>
            </div>
        </div>
    </div>

    <!-- MESSAGES PANEL (Slide-over for Group Chats + Friends) -->
    <div id="feed-messages-panel" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10006; backdrop-filter: blur(3px);">
        <div id="feed-messages-panel-content" style="position: absolute; right: 0; top: 0; bottom: 0; width: 100%; max-width: 400px; background: white; box-shadow: -5px 0 20px rgba(0,0,0,0.15); overflow-y: auto; animation: slideInFromRight 0.3s ease-out;">
            <!-- Panel Header -->
            <div style="padding: 20px; padding-top: calc(15px + env(safe-area-inset-top, 0px)); border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: white; z-index: 5;">
                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-main);">Messages</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div onclick="openAddFriendModal(); closeFeedMessagesPanel();" style="width: 36px; height: 36px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: white;"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <button onclick="closeFeedMessagesPanel()" style="background: none; border: none; font-size: 1.8rem; color: #94a3b8; cursor: pointer; line-height: 1; padding: 4px;">&times;</button>
                </div>
            </div>

            <!-- Group Chats in Panel -->
            <div style="padding: 15px 20px 5px 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-main); font-weight: 600;">Group Chats</h4>
                    <button onclick="openCreateGroupChatModal(); closeFeedMessagesPanel();" style="background: linear-gradient(135deg, var(--primary) 0%, #10b981 100%); color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; cursor: pointer;">+ New</button>
                </div>
                <div id="panel-group-chats" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                    <!-- Group chats loaded here -->
                    <div style="text-align: center; padding: 15px; color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                </div>
            </div>

            <div style="height: 1px; background: #f1f5f9; margin: 0 20px;"></div>

            <!-- Friends List in Panel -->
            <div style="padding: 15px 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-main); font-weight: 600;">Friends</h4>
                    <span id="panel-friends-count" style="font-size: 0.75rem; color: var(--text-muted);">0 friends</span>
                </div>

                <!-- Coach Shannon -->
                <div onclick="openCoachChatFromFriends(); closeFeedMessagesPanel();" style="display: flex; align-items: center; padding: 10px 0; cursor: pointer; border-bottom: 1px solid #f1f5f9;">
                    <div style="position: relative; margin-right: 12px;">
                        <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--primary);">
                            <img src="assets/coach_shannon.jpg" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<span style=\'color: white; font-size: 1.1rem; font-weight: 700;\'>S</span>'">
                        </div>
                        <div style="position: absolute; bottom: 1px; right: 1px; width: 12px; height: 12px; background: #22c55e; border-radius: 50%; border: 2px solid white;"></div>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-main); font-size: 0.9rem;">Coach Shannon</div>
                        <div style="font-size: 0.75rem; color: var(--primary); font-weight: 500;">Your wellness guide</div>
                    </div>
                    <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--text-muted);"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                </div>

                <!-- Friends list -->
                <div id="panel-friends-list" style="display: flex; flex-direction: column;">
                    <!-- Friends loaded here -->
                    <div style="text-align: center; padding: 15px; color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <style>
    @keyframes slideInFromRight {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    </style>

    <!-- Direct Message Modal -->
    <div id="direct-message-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10007; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
                <div id="dm-profile-link" onclick="if(currentDMRecipient) { closeDirectMessageModal(); viewUserProfile(currentDMRecipient.id, currentDMRecipient.name, currentDMRecipient.photo); }" style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;" title="View profile">
                    <div id="dm-recipient-photo" style="width: 44px; height: 44px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; overflow: hidden;"></div>
                    <div>
                        <div id="dm-recipient-name" style="font-weight: 700; color: var(--text-main);"></div>
                        <div id="dm-recipient-status" style="font-size: 0.8rem; color: var(--text-muted);"></div>
                    </div>
                </div>
                <button onclick="closeDirectMessageModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">×</button>
            </div>
            <!-- Messages -->
            <div id="dm-messages-container" style="height: 300px; overflow-y: auto; padding: 15px; background: #f8fafc;">
                <!-- Messages will be loaded here -->
            </div>
            <!-- Input -->
            <div style="padding: 15px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <input type="text" id="dm-input" placeholder="Type a message..." style="flex: 1; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 24px; font-size: 0.95rem; outline: none;" onkeypress="if(event.key==='Enter') sendDirectMessage()">
                <button onclick="sendDirectMessage()" style="width: 44px; height: 44px; background: var(--primary); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Coach Chat Modal -->
    <div id="coach-chat-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10007; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
                <div style="width: 44px; height: 44px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; overflow: hidden;">
                    <span style="font-size: 1.2rem;">S</span>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--text-main);">Shannon</div>
                    <div id="coach-modal-status" style="font-size: 0.8rem; color: var(--primary); font-weight: 600;">Coach</div>
                </div>
                <button onclick="closeCoachChatModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">×</button>
            </div>
            <!-- Messages -->
            <div id="chat-messages-container" style="height: 300px; overflow-y: auto; padding: 15px; background: #f8fafc;">
                <!-- Intro Message -->
                <div style="display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 15px; max-width: 85%;">
                    <div style="background: white; padding: 12px 16px; border-radius: 0 16px 16px 16px; border: 1px solid #e2e8f0; color: var(--text-main);">
                        <p style="margin: 0; font-size: 0.9rem; line-height: 1.5;">Hey! I'm Shannon. Send me a message any time - I'll get a notification and reply as soon as I can!</p>
                    </div>
                    <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 4px; margin-left: 2px;">Shannon</div>
                </div>
            </div>
            <!-- Input -->
            <div style="padding: 15px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <input type="text" id="coach-chat-input" placeholder="Message Shannon..." style="flex: 1; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 24px; font-size: 0.95rem; outline: none;" onkeypress="if(event.key==='Enter') submitCoachMessage()">
                <button onclick="submitCoachMessage()" style="width: 44px; height: 44px; background: var(--primary); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Message Selector Modal (Choose who to message) -->
    <div id="message-selector-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10007; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-main);">New Message</h3>
                <button onclick="closeMessageSelectorModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">&times;</button>
            </div>
            <!-- Friend List -->
            <div id="message-selector-list" style="max-height: 400px; overflow-y: auto; padding: 10px;">
                <!-- Friends will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Rare Rewards Collection Modal -->
    <div id="rare-rewards-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10009; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <div class="modal-content" style="width: 95%; max-width: 600px; max-height: 90vh; background: white; border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <div style="padding: 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to right, #ffffff, var(--accent-green));">
                <div>
                    <h2 style="margin: 0; font-family: 'Playfair Display'; color: var(--primary);">Rare Drops</h2>
                    <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">Win these by completing Monthly Challenges</p>
                </div>
                <button onclick="closeRareRewardsModal()" style="background: #f1f5f9; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 20px; height: 20px; stroke: #64748b;" fill="none" viewBox="0 0 24 24" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 25px;">
                <!-- 3D Preview Stage -->
                <div id="rare-preview-stage" style="width: 100%; height: 300px; background: radial-gradient(circle, #f8fafc 0%, #e2e8f0 100%); border-radius: 16px; margin-bottom: 25px; position: relative;">
                    <div id="rare-preview-loading" style="display: none; position: absolute; inset: 0; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); z-index: 2; border-radius: 16px;">
                        <div class="learning-spinner"></div>
                    </div>
                    <model-viewer id="rare-reward-viewer"
                                  camera-controls
                                  auto-rotate
                                  rotation-per-second="30deg"
                                  shadow-intensity="1"
                                  environment-image="neutral"
                                  style="width: 100%; height: 100%;"
                                  loading="eager">
                    </model-viewer>
                </div>

                <div id="rare-info-panel" style="text-align: center; margin-bottom: 25px; display: none;">
                    <h3 id="rare-reward-name" style="margin: 0; color: var(--primary);">Character Name</h3>
                    <p id="rare-reward-desc" style="margin: 5px 0; font-size: 0.9rem; color: var(--text-muted);">Description</p>
                    <div id="rare-reward-status" style="display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;">LOCKED</div>
                </div>

                <div id="rares-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <!-- Rares will be injected here -->
                </div>
            </div>
            
            <div style="padding: 20px; background: #f8fafc; border-top: 1px solid #f1f5f9;">
                <button onclick="closeRareRewardsModal(); switchAppTab('dashboard');" style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">Back to Challenges</button>
            </div>
        </div>
    </div>

    <!-- Badge Collection Modal -->
    <div id="badge-collection-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 10010; align-items: center; justify-content: center; backdrop-filter: blur(12px);">
        <div style="width: 95%; max-width: 440px; max-height: 85vh; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 60px rgba(0,0,0,0.6);">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <div>
                    <h2 style="margin: 0; font-size: 1.2rem; font-weight: 800; color: white;">🏅 Badge Collection</h2>
                    <p style="margin: 4px 0 0 0; font-size: 0.72rem; color: rgba(255,255,255,0.4);">Earn badges through gameplay achievements</p>
                </div>
                <button onclick="closeBadgeModal()" style="background: rgba(255,255,255,0.08); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 18px; height: 18px; stroke: rgba(255,255,255,0.5);" fill="none" viewBox="0 0 24 24" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <!-- Badge Grid Content -->
            <div id="badge-grid-content" style="flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch;">
            </div>
            <!-- Footer -->
            <div style="padding: 14px 20px; border-top: 1px solid rgba(255,255,255,0.08); flex-shrink: 0;">
                <button onclick="closeBadgeModal()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 12px; font-size: 0.85rem; font-weight: 700; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(59,130,246,0.3);">Close</button>
            </div>
        </div>
    </div>

    <!-- Challenge Type Picker Modal -->
    <div id="challenge-type-picker" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10009; align-items: center; justify-content: center; backdrop-filter: blur(6px);">
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border-radius: 24px; max-width: 420px; width: 92%; max-height: 85vh; display: flex; flex-direction: column; animation: fadeInScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(124,58,237,0.15);">
            <!-- Header -->
            <div style="text-align: center; padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;">
                <h3 style="margin: 0 0 4px; font-size: 1.3rem; font-weight: 800; color: #c084fc; text-shadow: 0 0 20px rgba(192,132,252,0.3);">🏆 Choose Challenge</h3>
                <p style="margin: 0; font-size: 0.8rem; color: rgba(255,255,255,0.6);">Pick a mode, invite friends & bet coins</p>
            </div>
            <!-- Type Grid -->
            <div style="padding: 16px; overflow-y: auto; flex: 1; min-height: 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div onclick="selectChallengeType('xp')" class="challenge-type-card" style="cursor: pointer; background: rgba(124,58,237,0.15); border: 1px solid rgba(124,58,237,0.3); border-radius: 16px; padding: 16px; text-align: center; transition: all 0.2s;">
                        <div style="font-size: 1.8rem; margin-bottom: 6px;">⚡</div>
                        <div style="font-weight: 700; color: white; font-size: 0.88rem; margin-bottom: 3px;">Level Up</div>
                        <div style="font-size: 0.68rem; color: rgba(255,255,255,0.5);">Most XP earned wins</div>
                    </div>
                    <div onclick="selectChallengeType('workouts')" class="challenge-type-card" style="cursor: pointer; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); border-radius: 16px; padding: 16px; text-align: center; transition: all 0.2s;">
                        <div style="font-size: 1.8rem; margin-bottom: 6px;">💪</div>
                        <div style="font-weight: 700; color: white; font-size: 0.88rem; margin-bottom: 3px;">Workout</div>
                        <div style="font-size: 0.68rem; color: rgba(255,255,255,0.5);">Most workouts logged</div>
                    </div>
                    <div onclick="selectChallengeType('volume')" class="challenge-type-card" style="cursor: pointer; background: rgba(251,146,60,0.15); border: 1px solid rgba(251,146,60,0.3); border-radius: 16px; padding: 16px; text-align: center; transition: all 0.2s;">
                        <div style="font-size: 1.8rem; margin-bottom: 6px;">🏋️</div>
                        <div style="font-weight: 700; color: white; font-size: 0.88rem; margin-bottom: 3px;">Volume</div>
                        <div style="font-size: 0.68rem; color: rgba(255,255,255,0.5);">Most total kg lifted</div>
                    </div>
                    <div onclick="selectChallengeType('calories')" class="challenge-type-card" style="cursor: pointer; background: rgba(74,222,128,0.15); border: 1px solid rgba(74,222,128,0.3); border-radius: 16px; padding: 16px; text-align: center; transition: all 0.2s;">
                        <div style="font-size: 1.8rem; margin-bottom: 6px;">🍎</div>
                        <div style="font-weight: 700; color: white; font-size: 0.88rem; margin-bottom: 3px;">Calories</div>
                        <div style="font-size: 0.68rem; color: rgba(255,255,255,0.5);">Most days hitting goal</div>
                    </div>
                    <div onclick="selectChallengeType('steps')" class="challenge-type-card" style="cursor: pointer; background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); border-radius: 16px; padding: 16px; text-align: center; transition: all 0.2s;">
                        <div style="font-size: 1.8rem; margin-bottom: 6px;">👟</div>
                        <div style="font-weight: 700; color: white; font-size: 0.88rem; margin-bottom: 3px;">Steps</div>
                        <div style="font-size: 0.68rem; color: rgba(255,255,255,0.5);">Most total steps</div>
                    </div>
                    <div onclick="selectChallengeType('streak')" class="challenge-type-card" style="cursor: pointer; background: rgba(251,191,36,0.15); border: 1px solid rgba(251,191,36,0.3); border-radius: 16px; padding: 16px; text-align: center; transition: all 0.2s;">
                        <div style="font-size: 1.8rem; margin-bottom: 6px;">🔥</div>
                        <div style="font-weight: 700; color: white; font-size: 0.88rem; margin-bottom: 3px;">Streak</div>
                        <div style="font-size: 0.68rem; color: rgba(255,255,255,0.5);">Longest streak kept</div>
                    </div>
                    <div onclick="selectChallengeType('sleep')" class="challenge-type-card" style="cursor: pointer; background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3); border-radius: 16px; padding: 16px; text-align: center; transition: all 0.2s;">
                        <div style="font-size: 1.8rem; margin-bottom: 6px;">😴</div>
                        <div style="font-weight: 700; color: white; font-size: 0.88rem; margin-bottom: 3px;">Sleep</div>
                        <div style="font-size: 0.68rem; color: rgba(255,255,255,0.5);">Most hours slept</div>
                    </div>
                    <div onclick="selectChallengeType('water')" class="challenge-type-card" style="cursor: pointer; background: rgba(14,165,233,0.15); border: 1px solid rgba(14,165,233,0.3); border-radius: 16px; padding: 16px; text-align: center; transition: all 0.2s;">
                        <div style="font-size: 1.8rem; margin-bottom: 6px;">💧</div>
                        <div style="font-weight: 700; color: white; font-size: 0.88rem; margin-bottom: 3px;">Water</div>
                        <div style="font-size: 0.68rem; color: rgba(255,255,255,0.5);">Most days hitting goal</div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div style="padding: 12px 16px 16px; border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;">
                <button onclick="closeChallengeTypePicker()" style="width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; background: transparent; color: rgba(255,255,255,0.7); font-size: 0.85rem; font-weight: 600; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Create Challenge Modal -->
    <div id="create-challenge-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10009; align-items: center; justify-content: center; backdrop-filter: blur(6px);">
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border-radius: 24px; max-width: 420px; width: 92%; max-height: 85vh; display: flex; flex-direction: column; animation: fadeInScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(59,130,246,0.15);">
            <!-- Header -->
            <div style="text-align: center; padding: 24px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;">
                <h3 style="margin: 0 0 4px; font-size: 1.3rem; font-weight: 800; color: #60a5fa; text-shadow: 0 0 20px rgba(96,165,250,0.3);">🏆 Create Challenge</h3>
                <p id="create-challenge-subtitle" style="margin: 0; font-size: 0.8rem; color: rgba(255,255,255,0.6);">30-day XP battle with friends</p>
                <div id="create-challenge-type-badge" style="display: none; margin-top: 8px;"><span style="display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; background: rgba(124,58,237,0.3); color: #c084fc;"></span></div>
            </div>
            <input type="hidden" id="challenge-type-input" value="xp">
            <!-- Content -->
            <div style="padding: 16px; overflow-y: auto; flex: 1; min-height: 0;">
                <!-- Featured Rare Preview (shown when opening from featured card) -->
                <div id="challenge-rare-preview" style="display: none; text-align: center; margin-bottom: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 16px;">
                    <model-viewer id="challenge-rare-viewer" style="width: 280px; height: 280px; margin: 0 auto; --poster-color: transparent;" auto-rotate camera-controls interaction-prompt="none" shadow-intensity="0.5"></model-viewer>
                    <div id="challenge-rare-name" style="font-size: 1.1rem; font-weight: 800; color: white; margin-top: 8px;">Character Name</div>
                    <div id="challenge-rare-tier-badge" style="display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; letter-spacing: 1.5px; margin-top: 6px; color: white;">TIER</div>
                    <div style="margin-top: 8px; font-size: 0.75rem; color: #4ade80; font-weight: 700;">GUARANTEED DROP</div>
                </div>
                <!-- Random Rare Drop Info (shown for generic challenges) -->
                <div id="challenge-random-drop-info" style="display: none; background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.2); border-radius: 14px; padding: 14px; margin-bottom: 16px; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 6px;">🎲</div>
                    <div style="font-weight: 700; color: #c084fc; font-size: 0.9rem; margin-bottom: 4px;">Random Rare Drop</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 8px;">Winner receives a random rare skin!</div>
                    <div style="display: flex; justify-content: center; gap: 6px; flex-wrap: wrap;">
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; background: rgba(107,114,128,0.3); color: #9ca3af;">COMMON 53%</span>
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; background: rgba(59,130,246,0.3); color: #60a5fa;">RARE 26%</span>
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; background: rgba(168,85,247,0.3); color: #c084fc;">EPIC 16%</span>
                        <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; background: rgba(251,191,36,0.3); color: #fbbf24;">LEGENDARY 5%</span>
                    </div>
                </div>
                <!-- How It Works -->
                <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2); border-radius: 14px; padding: 14px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: #93c5fd; font-size: 0.8rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">How It Works</div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <span style="color: #60a5fa; font-weight: 700; font-size: 0.8rem; min-width: 18px;">1.</span>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Choose your wager (min. <strong style="color: #fbbf24;">1,000 Coins</strong>). Everyone pays in.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <span style="color: #60a5fa; font-weight: 700; font-size: 0.8rem; min-width: 18px;">2.</span>
                            <span id="challenge-how-step2" style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Earn <strong style="color: #4ade80;">double XP</strong> on everything for 30 days.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <span style="color: #60a5fa; font-weight: 700; font-size: 0.8rem; min-width: 18px;">3.</span>
                            <span id="challenge-how-step3" style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Most <strong style="color: #c084fc;">XP</strong> at the end wins.</span>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <span style="color: #60a5fa; font-weight: 700; font-size: 0.8rem; min-width: 18px;">4.</span>
                            <span style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Winner gets <strong style="color: #fbbf24;">rare drops</strong> — 3D skins &amp; badges.</span>
                        </div>
                    </div>
                </div>

                <!-- Challenge Name -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Challenge Name</label>
                    <input type="text" id="challenge-name-input" placeholder="e.g., February Grind" style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.9rem; color: white; box-sizing: border-box;">
                </div>

                <!-- Duration (fixed 30 days, shown as info) -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Duration</label>
                    <div style="padding: 10px 12px; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.9rem; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8);">30 days</div>
                    <input type="hidden" id="challenge-duration-select" value="30">
                </div>

                <!-- Start Date -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Start Date</label>
                    <input type="date" id="challenge-start-date" style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.9rem; color: white; box-sizing: border-box; color-scheme: dark;">
                </div>

                <!-- Select Friends -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 600; color: rgba(255,255,255,0.6); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Invite Friends (min. 1)</label>
                    <div id="challenge-friends-list" style="max-height: 180px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; background: rgba(255,255,255,0.04);">
                        <!-- Friends will be loaded here -->
                        <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">Loading friends...</div>
                    </div>
                    <div style="margin-top: 6px; font-size: 0.75rem; color: rgba(255,255,255,0.4);">
                        <span id="challenge-selected-count">0</span> friend(s) selected
                    </div>
                </div>

                <!-- Wager Amount Picker -->
                <div id="challenge-wager-section" style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.75rem; color: rgba(255,255,255,0.6); font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Wager Coins</span>
                        <span style="font-size: 0.7rem; color: rgba(255,255,255,0.4);">Balance: 🪙 <span class="coin-balance-sync">0</span></span>
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                        <button type="button" onclick="window._setCreateChallengeBet(1000, this)" class="create-challenge-bet-btn active" style="flex: 1; min-width: 55px; padding: 9px 4px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; color: white; font-weight: 700; font-size: 0.78rem; cursor: pointer;">🪙 1K</button>
                        <button type="button" onclick="window._setCreateChallengeBet(2500, this)" class="create-challenge-bet-btn" style="flex: 1; min-width: 55px; padding: 9px 4px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.78rem; cursor: pointer;">🪙 2.5K</button>
                        <button type="button" onclick="window._setCreateChallengeBet(5000, this)" class="create-challenge-bet-btn" style="flex: 1; min-width: 55px; padding: 9px 4px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.78rem; cursor: pointer;">🪙 5K</button>
                        <button type="button" onclick="window._setCreateChallengeBet(10000, this)" class="create-challenge-bet-btn" style="flex: 1; min-width: 55px; padding: 9px 4px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-weight: 700; font-size: 0.78rem; cursor: pointer;">🪙 10K</button>
                    </div>
                    <input type="number" id="create-challenge-custom-bet" placeholder="Or enter custom amount..." min="1000" step="500" style="width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-size: 0.85rem; box-sizing: border-box;" oninput="window._setCreateChallengeBet(parseInt(this.value) || 0)">
                </div>

                <!-- Entry Fee Info -->
                <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.2); border-radius: 12px; padding: 12px 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3rem;">🪙</span>
                    <div>
                        <div style="font-weight: 700; color: #fbbf24; font-size: 0.85rem;" id="create-challenge-fee-display">1,000 Coins entry fee</div>
                        <div style="font-size: 0.72rem; color: rgba(251,191,36,0.7);">Deducted when you and your friends join</div>
                    </div>
                </div>

                <!-- Prize Info -->
                <div style="background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.2); border-radius: 12px; padding: 12px 14px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.3rem;">✨</span>
                    <div>
                        <div style="font-weight: 700; color: #c084fc; font-size: 0.85rem;">Winner Gets Rare Drops!</div>
                        <div style="font-size: 0.72rem; color: rgba(192,132,252,0.7);">Exclusive 3D skins &amp; badges</div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div style="padding: 12px 16px 16px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; flex-shrink: 0;">
                <button onclick="closeCreateChallengeModal()" style="flex: 1; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; background: transparent; color: rgba(255,255,255,0.7); font-size: 0.85rem; font-weight: 600; cursor: pointer;">Cancel</button>
                <button onclick="createChallenge()" id="create-challenge-btn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 12px; font-size: 0.85rem; font-weight: 700; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(59,130,246,0.4);">Create Challenge</button>
            </div>
        </div>
    </div>

    <!-- Rare Skin Unlock Celebration Modal -->
    <div id="rare-unlock-celebration" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10020; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <div style="text-align: center; max-width: 380px; width: 92%; animation: fadeInScale 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <!-- Sparkle burst background -->
            <div id="unlock-sparkles" style="position: absolute; inset: 0; pointer-events: none; overflow: hidden;"></div>

            <!-- Victory text -->
            <div style="font-size: 1rem; font-weight: 700; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 8px;">Challenge Complete</div>
            <div id="unlock-result-text" style="font-size: 1.8rem; font-weight: 900; color: #4ade80; margin-bottom: 6px; text-shadow: 0 0 30px rgba(74,222,128,0.5);">YOU WON!</div>

            <!-- 3D Model Reveal -->
            <div style="position: relative; margin: 20px auto;">
                <div id="unlock-glow-ring" style="position: absolute; inset: -20px; border-radius: 50%; background: radial-gradient(circle, rgba(251,191,36,0.3) 0%, transparent 70%); animation: pulseGlow 2s ease-in-out infinite;"></div>
                <model-viewer id="unlock-rare-viewer" style="width: 200px; height: 200px; margin: 0 auto; position: relative; z-index: 2; --poster-color: transparent;" auto-rotate camera-controls interaction-prompt="none" shadow-intensity="0.8" auto-rotate-delay="0" rotation-per-second="40deg"></model-viewer>
            </div>

            <!-- Rare info -->
            <div id="unlock-tier-badge" style="display: inline-block; padding: 4px 14px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; letter-spacing: 2px; color: white; margin-bottom: 10px;">LEGENDARY</div>
            <div id="unlock-rare-name" style="font-size: 1.6rem; font-weight: 900; color: white; margin-bottom: 4px;">Character Name</div>
            <div id="unlock-rare-desc" style="font-size: 0.85rem; color: rgba(255,255,255,0.5); margin-bottom: 24px;">Description</div>

            <!-- NEW badge -->
            <div style="display: inline-flex; align-items: center; gap: 6px; background: rgba(74,222,128,0.15); border: 1px solid rgba(74,222,128,0.3); border-radius: 10px; padding: 8px 16px; margin-bottom: 24px;">
                <span style="font-size: 1.2rem;">🎉</span>
                <span style="color: #4ade80; font-weight: 700; font-size: 0.85rem;">NEW RARE SKIN UNLOCKED!</span>
            </div>

            <!-- Action buttons -->
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="equipUnlockedRare()" id="unlock-equip-btn" style="padding: 14px 28px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 14px; color: white; font-weight: 700; font-size: 0.9rem; cursor: pointer; box-shadow: 0 4px 20px rgba(59,130,246,0.4); transition: transform 0.2s;">Equip Now</button>
                <button onclick="closeUnlockCelebration()" style="padding: 14px 28px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 14px; color: rgba(255,255,255,0.7); font-weight: 600; font-size: 0.9rem; cursor: pointer;">Later</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulseGlow {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.15); opacity: 1; }
        }
        @keyframes sparkleFloat {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(-120px) rotate(360deg) scale(0); opacity: 0; }
        }
        @keyframes slideReveal {
            0% { transform: scale(0.3) rotateY(180deg); opacity: 0; }
            60% { transform: scale(1.1) rotateY(10deg); opacity: 1; }
            100% { transform: scale(1) rotateY(0deg); opacity: 1; }
        }
    </style>

    <!-- Challenge Leaderboard View -->
    <div id="challenge-leaderboard-modal" style="display: none; position: fixed; inset: 0; background: #f0f7ff; z-index: 10009; overflow-y: auto;">
        <!-- Header -->
        <div style="background: white; padding: calc(15px + env(safe-area-inset-top, 0px)) 20px 15px 20px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10;">
            <h3 id="challenge-leaderboard-title" style="margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main);">Challenge</h3>
        </div>

        <!-- Podium Section -->
        <div style="background: linear-gradient(180deg, #e0f2fe 0%, #f0f7ff 100%); padding: 20px 15px 30px;">
            <!-- Days Remaining -->
            <div id="challenge-days-remaining" style="text-align: center; margin-bottom: 20px; font-size: 0.9rem; color: #0369a1; font-weight: 600;">
                -- days remaining
            </div>

            <!-- Podium -->
            <div id="challenge-podium" style="display: flex; justify-content: center; align-items: flex-end; gap: 8px; height: 200px;">
                <!-- 2nd Place -->
                <div id="podium-2nd" style="text-align: center; width: 100px;">
                    <div id="podium-2nd-name" style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 5px;">--</div>
                    <div id="podium-2nd-photo" style="width: 50px; height: 50px; border-radius: 50%; background: #e2e8f0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #94a3b8;">
                        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #94a3b8;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div style="background: #bfdbfe; border-radius: 8px 8px 0 0; padding: 15px 10px; height: 80px; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #1e40af;">2</div>
                        <div id="podium-2nd-pts" style="font-size: 0.75rem; font-weight: 600; color: #1e40af;">0 PTS</div>
                    </div>
                </div>

                <!-- 1st Place -->
                <div id="podium-1st" style="text-align: center; width: 110px;">
                    <div id="podium-1st-name" style="font-weight: 700; font-size: 0.9rem; color: var(--text-main); margin-bottom: 5px;">--</div>
                    <div id="podium-1st-photo" style="width: 60px; height: 60px; border-radius: 50%; background: #e2e8f0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #fbbf24;">
                        <svg viewBox="0 0 24 24" style="width: 28px; height: 28px; fill: #94a3b8;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div style="background: #93c5fd; border-radius: 8px 8px 0 0; padding: 15px 10px; height: 110px; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: #1e40af;">1</div>
                        <div id="podium-1st-pts" style="font-size: 0.85rem; font-weight: 600; color: #1e40af;">0 PTS</div>
                    </div>
                </div>

                <!-- 3rd Place -->
                <div id="podium-3rd" style="text-align: center; width: 100px;">
                    <div id="podium-3rd-name" style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 5px;">--</div>
                    <div id="podium-3rd-photo" style="width: 50px; height: 50px; border-radius: 50%; background: #e2e8f0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #d97706;">
                        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #94a3b8;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div style="background: #dbeafe; border-radius: 8px 8px 0 0; padding: 15px 10px; height: 60px; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: #1e40af;">3</div>
                        <div id="podium-3rd-pts" style="font-size: 0.75rem; font-weight: 600; color: #1e40af;">0 PTS</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Graph -->
        <div style="background: white; margin: 15px; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <h4 style="margin: 0 0 15px; font-size: 0.95rem; font-weight: 600; color: var(--text-main);">Progress Over Time</h4>
            <div id="challenge-graph-container" style="height: 200px; position: relative;">
                <canvas id="challenge-progress-chart"></canvas>
            </div>
        </div>

        <!-- Full Rankings List -->
        <div style="background: white; margin: 0 15px 15px; border-radius: 16px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
            <h4 style="margin: 0 0 15px; font-size: 0.95rem; font-weight: 600; color: var(--text-main);">Full Rankings</h4>
            <div id="challenge-full-rankings">
                <!-- Rankings will be loaded here -->
            </div>
        </div>

        <!-- Leave Challenge Button -->
        <div style="padding: 15px; text-align: center;">
            <button onclick="leaveCurrentChallenge()" style="background: none; border: none; color: #ef4444; font-size: 0.9rem; cursor: pointer; text-decoration: underline;">
                Leave Challenge
            </button>
        </div>
    </div>

    <!-- Challenge Buy-In Modal (Coins) - Battle Mode Style -->
    <div id="challenge-pass-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10010; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="challenge-buyin-modal">
            <div class="challenge-buyin-header">
                <h2>🏆 Challenge Mode</h2>
                <p>Bet coins &amp; earn double XP for 30 days</p>
            </div>
            <div class="challenge-buyin-body">
                <!-- Rare Reward Info (dynamically shown) -->
                <div id="challenge-pass-rare-info" style="display: none;"></div>

                <!-- Locked Entry Fee Display -->
                <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.2); border-radius: 12px; padding: 12px 14px; margin-bottom: 12px; text-align: center;">
                    <div id="challenge-pass-fee-info" style="font-weight: 700; color: #fbbf24; font-size: 1rem;">🪙 1,000 Coins entry fee</div>
                    <div style="font-size: 0.7rem; color: rgba(251,191,36,0.6); margin-top: 2px;">Matches the challenger's entry fee</div>
                </div>

                <!-- Benefits -->
                <div class="challenge-buyin-benefits">
                    <div class="challenge-buyin-benefit">
                        <span class="check">✓</span>
                        <span class="text">Double XP on all activities for 30 days</span>
                    </div>
                    <div class="challenge-buyin-benefit">
                        <span class="check">✓</span>
                        <span class="text">Winner gets exclusive rare drops</span>
                    </div>
                    <div class="challenge-buyin-benefit">
                        <span class="check">✓</span>
                        <span class="text">All participants get a reward</span>
                    </div>
                </div>

                <!-- Coin Bet Picker (hidden — accepter must match creator's fee) -->
                <div class="challenge-bet-picker" style="padding: 10px 0 14px; display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.8rem; color: rgba(255,255,255,0.6); font-weight: 600;">WAGER COINS (min. 1,000)</span>
                        <span style="font-size: 0.75rem; color: rgba(255,255,255,0.4);">Balance: 🪙 <span id="challenge-modal-coin-balance">0</span></span>
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <button onclick="window._setChallengeBet(1000, this)" class="challenge-bet-btn active">🪙 1K</button>
                        <button onclick="window._setChallengeBet(2500, this)" class="challenge-bet-btn">🪙 2.5K</button>
                        <button onclick="window._setChallengeBet(5000, this)" class="challenge-bet-btn">🪙 5K</button>
                        <button onclick="window._setChallengeBet(10000, this)" class="challenge-bet-btn">🪙 10K</button>
                    </div>
                    <div style="margin-top: 8px;">
                        <input type="number" id="challenge-custom-bet" placeholder="Or enter custom amount (min 1,000)..." min="1000" step="500" style="width: 100%; padding: 8px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: white; font-size: 0.85rem; box-sizing: border-box;" oninput="window._setChallengeBet(parseInt(this.value) || 0)">
                    </div>
                </div>
            </div>
            <div class="challenge-buyin-footer">
                <button id="buy-challenge-pass-btn" onclick="spendCoinsToJoinChallenge()" class="challenge-buyin-join-btn">
                    Spend 🪙 1,000 Coins &amp; Join
                </button>
                <button onclick="openCoinShop(); closeChallengePassModal();" class="challenge-buyin-secondary-btn">
                    Need more coins? Buy here
                </button>
                <button onclick="closeChallengePassModal()" class="challenge-buyin-cancel">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Coin Shop Modal -->
    <div id="coin-shop-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10010; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 24px; max-width: 420px; width: 92%; padding: 0; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); padding: 20px; text-align: center; position: relative;">
                <button onclick="closeCoinShop()" style="position: absolute; top: 12px; right: 16px; background: none; border: none; font-size: 1.5rem; color: rgba(255,255,255,0.8); cursor: pointer;">&times;</button>
                <span style="font-size: 2.5rem;">🪙</span>
                <h3 style="margin: 8px 0 4px; font-size: 1.3rem; font-weight: 700; color: white; font-family: 'Montserrat', sans-serif;">Coin Shop</h3>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.9);">Your balance: <strong id="coin-shop-balance">0</strong> coins</div>
            </div>
            <!-- Packs -->
            <div style="padding: 20px; display: flex; flex-direction: column; gap: 10px;">
                <!-- Starter -->
                <div onclick="buyCoinPack('starter')" class="coin-pack-option" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">500 Coins</div>
                        <div style="font-size: 0.78rem; color: var(--text-muted);">Starter Pack</div>
                    </div>
                    <div style="background: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;">$4.99</div>
                </div>
                <!-- Popular -->
                <div onclick="buyCoinPack('popular')" class="coin-pack-option" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #fffbeb; border: 2px solid #fbbf24; border-radius: 12px; cursor: pointer; transition: all 0.2s; position: relative;">
                    <div style="position: absolute; top: -8px; right: 12px; background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700;">BEST VALUE</div>
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">1,200 Coins</div>
                        <div style="font-size: 0.78rem; color: #f59e0b; font-weight: 600;">+20% bonus</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;">$9.99</div>
                </div>
                <!-- Pro -->
                <div onclick="buyCoinPack('pro')" class="coin-pack-option" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">2,800 Coins</div>
                        <div style="font-size: 0.78rem; color: #16a34a; font-weight: 600;">+40% bonus</div>
                    </div>
                    <div style="background: #16a34a; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;">$19.99</div>
                </div>
                <!-- Ultimate -->
                <div onclick="buyCoinPack('ultimate')" class="coin-pack-option" style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: linear-gradient(135deg, #eff6ff, #e0e7ff); border: 2px solid #818cf8; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <div>
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1rem;">8,000 Coins</div>
                        <div style="font-size: 0.78rem; color: #6366f1; font-weight: 600;">+60% bonus</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #6366f1, #7c3aed); color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 0.9rem;">$49.99</div>
                </div>
            </div>
            <!-- Restore Purchases (native only) -->
            <div id="restore-purchases-row" style="display: none; padding: 0 20px 10px; text-align: center;">
                <button onclick="restoreIAPPurchases()" style="background: none; border: none; color: var(--primary); font-size: 0.82rem; cursor: pointer; text-decoration: underline; font-weight: 600;">Restore Purchases</button>
            </div>
            <!-- What coins are for -->
            <div style="padding: 0 20px 20px;">
                <div style="background: #f8fafc; border-radius: 10px; padding: 12px 14px;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px;">SPEND COINS ON</div>
                    <div style="display: flex; gap: 12px; font-size: 0.78rem; color: var(--text-main); flex-wrap: wrap;">
                        <span>🏆 Challenges</span>
                        <span>⚔️ Battle Bets</span>
                        <span>🎭 Characters</span>
                        <span>✨ Cosmetics</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Chat Modal -->
    <div id="group-chat-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10010; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 85vh; overflow: hidden; animation: fadeInScale 0.3s ease-out; display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px;">
                <div id="gc-chat-icon" style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #10b981); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">💬</div>
                <div style="flex: 1;">
                    <div id="gc-chat-name" style="font-weight: 700; color: var(--text-main);"></div>
                    <div id="gc-chat-members" style="font-size: 0.8rem; color: var(--text-muted);"></div>
                </div>
                <button onclick="closeGroupChatModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">×</button>
            </div>
            <!-- Messages -->
            <div id="gc-messages-container" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; min-height: 300px; max-height: 400px;">
                <!-- Messages will be loaded here -->
            </div>
            <!-- Share Win Button -->
            <div style="padding: 10px 15px; background: #f1f5f9; border-top: 1px solid #e2e8f0;">
                <button onclick="openShareWinInChat()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #f59e0b, #eab308); color: white; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 1.1rem;">🎉</span> Share a Win
                </button>
            </div>
            <!-- Input -->
            <div style="padding: 15px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <input type="text" id="gc-message-input" placeholder="Type a message..." style="flex: 1; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 24px; font-size: 0.95rem; outline: none;" onkeypress="if(event.key==='Enter') sendGroupChatMessage()">
                <button onclick="sendGroupChatMessage()" style="width: 44px; height: 44px; background: var(--primary); border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: white;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Create Group Chat Modal -->
    <div id="create-group-chat-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10011; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 85vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between;">
                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-main);">New Group Chat</h3>
                <button onclick="closeCreateGroupChatModal()" style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">&times;</button>
            </div>
            <!-- Content -->
            <div style="padding: 20px; overflow-y: auto; max-height: calc(85vh - 140px);">
                <!-- Group Name -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px;">Group Name</label>
                    <input type="text" id="new-group-name" placeholder="e.g., Workout Squad" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; box-sizing: border-box;">
                </div>

                <!-- Select Friends -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px;">Add Friends</label>
                    <div id="group-friends-list" style="max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px;">
                        <!-- Friends will be loaded here -->
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading friends...</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                        <span id="group-selected-count">0</span> friend(s) selected
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div style="padding: 15px 20px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <button onclick="closeCreateGroupChatModal()" style="flex: 1; padding: 12px; background: #f1f5f9; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); cursor: pointer;">Cancel</button>
                <button onclick="createGroupChat()" id="create-group-btn" style="flex: 1; padding: 12px; background: var(--primary); border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; color: white; cursor: pointer;">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Share Win in Chat Modal -->
    <div id="share-win-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10012; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 85vh; overflow: hidden; animation: fadeInScale 0.3s ease-out;">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);">
                <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: white; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.3rem;">🎉</span> Share a Win
                </h3>
                <button onclick="closeShareWinModal()" style="background: rgba(255,255,255,0.2); border: none; font-size: 1.2rem; color: white; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <!-- Content -->
            <div style="padding: 20px; overflow-y: auto; max-height: calc(85vh - 140px);">
                <!-- Win Type Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 12px;">What type of win?</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="selectWinType('workout_complete')" id="win-type-workout" class="win-type-btn" style="padding: 16px; background: #dcfce7; border: 2px solid var(--primary); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.8rem; margin-bottom: 6px;">💪</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Workout Done</div>
                        </button>
                        <button onclick="selectWinType('personal_best')" id="win-type-pb" class="win-type-btn" style="padding: 16px; background: #f1f5f9; border: 2px solid transparent; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.8rem; margin-bottom: 6px;">🏆</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Personal Best</div>
                        </button>
                        <button onclick="selectWinType('milestone')" id="win-type-milestone" class="win-type-btn" style="padding: 16px; background: #f1f5f9; border: 2px solid transparent; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.8rem; margin-bottom: 6px;">🌟</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Milestone</div>
                        </button>
                        <button onclick="selectWinType('custom')" id="win-type-custom" class="win-type-btn" style="padding: 16px; background: #f1f5f9; border: 2px solid transparent; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.8rem; margin-bottom: 6px;">✨</div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Other Win</div>
                        </button>
                    </div>
                </div>

                <!-- Workout Details (shown for workout_complete and personal_best) -->
                <div id="win-workout-details" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px;">Details (optional)</label>
                    <input type="text" id="win-workout-name" placeholder="e.g., Upper Body Strength" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; box-sizing: border-box; margin-bottom: 10px;">
                    <input type="text" id="win-improvement" placeholder="e.g., +5kg on bench press" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; box-sizing: border-box;">
                </div>

                <!-- Message -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px;">Your Message</label>
                    <textarea id="win-message-input" placeholder="Tell the group about your win!" rows="3" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; box-sizing: border-box; resize: none; font-family: inherit;"></textarea>
                </div>

                <!-- Quick Messages -->
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <button onclick="setWinMessage('Just crushed my workout! 💪')" style="padding: 8px 12px; background: #f1f5f9; border: none; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); cursor: pointer;">Just crushed it! 💪</button>
                    <button onclick="setWinMessage('New personal best! 🏆')" style="padding: 8px 12px; background: #f1f5f9; border: none; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); cursor: pointer;">New PB! 🏆</button>
                    <button onclick="setWinMessage('Feeling stronger! 🌟')" style="padding: 8px 12px; background: #f1f5f9; border: none; border-radius: 20px; font-size: 0.8rem; color: var(--text-muted); cursor: pointer;">Feeling strong! 🌟</button>
                </div>
            </div>
            <!-- Footer -->
            <div style="padding: 15px 20px; border-top: 1px solid #f1f5f9; display: flex; gap: 10px;">
                <button onclick="closeShareWinModal()" style="flex: 1; padding: 12px; background: #f1f5f9; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); cursor: pointer;">Cancel</button>
                <button onclick="sendWinToChat()" id="submit-win-btn" style="flex: 2; padding: 12px; background: linear-gradient(135deg, #f59e0b, #eab308); border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>Share to Group</span>
                    <span style="font-size: 1.1rem;">🎉</span>
                </button>
                <button onclick="shareWinExternally()" id="external-win-share-btn" title="Share card externally" style="width: 50px; padding: 12px; background: #0084FF; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: white;"><path d="M12 2C6.477 2 2 6.145 2 11.258c0 2.908 1.462 5.501 3.753 7.216V22l3.363-1.846c.854.237 1.762.365 2.701.365 5.523 0 10-4.145 10-9.258C22 6.145 17.523 2 12 2zm1.066 11.968l-2.585-2.754-5.044 2.754 5.548-5.89 2.663 2.754 4.965-2.754-5.547 5.89z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- PROGRESS / ANALYTICS VIEW -->
    <!-- ===== ACTIVITY INSIGHTS VIEW ===== -->
    <div id="view-insights" class="app-view" style="display:none; min-height: 100vh; height: auto; background: #f8fafc; z-index: 100000; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; overflow-y: auto; overflow-x: hidden;">
        <!-- Header -->
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; padding-top: calc(15px + env(safe-area-inset-top, 0px)); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Activity Insights</div>
        </div>

        <!-- Loading State -->
        <div id="insights-loading" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 2rem; margin-bottom: 10px;">📊</div>
            <div style="color: var(--text-muted);">Loading insights...</div>
        </div>

        <!-- Main Content -->
        <div id="insights-main-content" style="display: none; padding-bottom: 40px;">

            <!-- Strength Progress -->
            <div style="padding: 20px 20px 0;">
                <div style="background: white; border-radius: 20px; padding: 20px; box-shadow: var(--card-shadow);">
                    <div style="display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 4px;">
                        <h3 style="margin: 0; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">Strength Progress</h3>
                        <span id="insights-strength-count" style="font-size: 0.8rem; color: #10b981; font-weight: 700;"></span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">Exercises where you've increased weight</div>
                    <div id="insights-strength-progress" style="width: 100%;"></div>
                </div>
            </div>

            <!-- Correlations -->
            <div style="padding: 20px 20px 0;">
                <div style="background: white; border-radius: 20px; padding: 20px; box-shadow: var(--card-shadow);">
                    <h3 style="margin: 0 0 16px 0; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">Correlations</h3>
                    <div id="insights-correlations-container">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Sleep & Recovery -->
            <div style="padding: 20px 20px 0;">
                <div style="background: white; border-radius: 20px; padding: 20px; box-shadow: var(--card-shadow);">
                    <h3 style="margin: 0 0 16px 0; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">Sleep &amp; Recovery</h3>
                    <div id="insights-sleep-container">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Energy Balance / Real BMR -->
            <div style="padding: 20px 20px 0;">
                <div style="background: white; border-radius: 20px; padding: 20px; box-shadow: var(--card-shadow);">
                    <h3 style="margin: 0 0 4px 0; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">Energy Balance</h3>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">Your real numbers vs estimates</div>
                    <div id="insights-energy-balance-container">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">Needs 10+ days of nutrition tracking + weigh-ins to calculate</div>
                    </div>
                </div>
            </div>

            <!-- Mood & Energy Trends -->
            <div style="padding: 20px 20px 0;">
                <div style="background: white; border-radius: 20px; padding: 20px; box-shadow: var(--card-shadow);">
                    <h3 style="margin: 0 0 4px 0; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">Mood &amp; Energy</h3>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">Last 7 days from your check-ins</div>
                    <div id="insights-mood-container">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">Start logging mood check-ins to see trends</div>
                    </div>
                </div>
            </div>

            <!-- Connect a Tracker (shown when no wearable synced) -->
            <div id="insights-connect-section" style="padding: 20px; display: none;">
                <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 20px; padding: 20px;">
                    <div style="color: white; font-weight: 700; font-size: 1rem; margin-bottom: 6px;">Unlock Deeper Insights</div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 0.8rem; margin-bottom: 16px;">Connect a fitness tracker to correlate sleep, heart rate &amp; calories with your workouts.</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="event.stopPropagation(); toggleFitbitConnection()" style="background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.25); color: white; padding: 8px 14px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">Fitbit</button>
                        <button onclick="event.stopPropagation(); toggleWhoopConnection()" style="background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.25); color: white; padding: 8px 14px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">WHOOP</button>
                        <button onclick="event.stopPropagation(); toggleOuraConnection()" style="background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.25); color: white; padding: 8px 14px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">Oura</button>
                        <button onclick="event.stopPropagation(); toggleStravaConnection()" style="background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.25); color: white; padding: 8px 14px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">Strava</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-progress" class="app-view" style="display:none; min-height: 100vh; height: auto; background: #f8fafc; z-index: 100000; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; overflow-y: auto; overflow-x: hidden;">
        <!-- Header with back button -->
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 20px; padding-top: calc(15px + env(safe-area-inset-top, 0px)); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <div style="width: 40px;"></div>
            <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Your Progress</div>
            <div style="width: 40px;"></div>
        </div>

        <!-- Progress Content Container -->
        <div id="progress-content" style="padding: 0;">
            <!-- Loading State -->
            <div id="progress-loading" style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 2rem; margin-bottom: 10px;">📊</div>
                <div style="color: var(--text-muted);">Loading your progress...</div>
            </div>

            <!-- Main Content (Hidden Initially) -->
            <div id="progress-main-content" style="display: none;">

                <!-- Exercise Progress Selection Top -->
                <div style="padding: 20px 20px 10px 20px;">
                    <div style="background: white; padding: 20px; border-radius: 20px; box-shadow: var(--card-shadow); border: 1px solid var(--accent-green); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -10px; right: -10px; font-size: 4rem; opacity: 0.05; transform: rotate(15deg);">📊</div>
                        <h3 style="font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 12px 0;">Track Progress</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="flex: 1; position: relative;">
                                <select id="exercise-selection-dropdown" onchange="if(this.value) showExerciseDetailChart(this.value, window.currentUser.id)" style="width: 100%; padding: 14px 16px; border-radius: 12px; border: 1.5px solid #e2e8f0; font-size: 0.95rem; font-family: inherit; appearance: none; background: white; cursor: pointer; color: var(--text-main);">
                                    <option value="">Select an exercise...</option>
                                    <!-- Populated by JS -->
                                </select>
                                <div style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-muted);">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.75rem; color: var(--text-muted);">Select any exercise to view your strength history</div>
                    </div>
                </div>

                <!-- Personal Bests Section -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">
                        <span style="color: #f59e0b;">🏆</span> Personal Bests
                    </h3>
                    <div id="personal-bests-container">
                        <!-- Recent PBs will appear here -->
                        <div id="recent-pbs-list" style="display: none; margin-bottom: 15px;">
                            <!-- Populated by JS - shows recent PB achievements -->
                        </div>
                        <!-- All-time PBs grid -->
                        <div id="personal-bests-list" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <!-- Populated by JS -->
                            <div style="grid-column: span 2; text-align: center; padding: 30px 20px; color: var(--text-muted);">
                                <div style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;">🏋️</div>
                                <div style="font-size: 0.9rem;">Complete workouts with weights to track your personal bests!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Body Weight Graph -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">
                        <span style="color: #7BA883;">&#9878;</span> Body Weight
                    </h3>
                    <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow);">
                        <div id="bodyweight-graph">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Progress Photos Timeline -->
                <div style="padding: 20px 20px 10px 20px;">
                    <h3 style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 15px 0;">
                        <span style="color: #ec4899;">📸</span> Progress Photos
                    </h3>
                    <div id="progress-photos-container" style="background: white; padding: 20px; border-radius: 16px; box-shadow: var(--card-shadow);">
                        <!-- Populated by JS -->
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- EXERCISE CHART MODAL -->
    <div id="exercise-chart-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 20px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <!-- Modal Header -->
            <div style="padding: 20px 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; border-radius: 20px 20px 0 0; z-index: 1;">
                <h3 id="exercise-chart-title" style="margin: 0; font-family: 'Playfair Display'; color: var(--primary); font-size: 1.3rem;">Exercise Progress</h3>
                <button onclick="closeExerciseChartModal()" style="background: transparent; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 5px; line-height: 1;">&times;</button>
            </div>

            <!-- Modal Content -->
            <div id="exercise-chart-content">
                <!-- Chart will be rendered here -->
            </div>
        </div>
    </div>

    <!-- LEARNING / EDUCATION VIEW -->
    <div id="view-learning" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc;">
        <!-- Header -->
        <div style="padding: 20px 25px; padding-top: calc(20px + env(safe-area-inset-top, 0px)); background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
            <div>
                <h2 style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.5rem;">Learn</h2>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="coin-header-widget" onclick="openCoinShop()">
                    <span class="coin-emoji">🪙</span>
                    <span class="coin-amount coin-balance-sync">0</span>
                    <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
                </div>
                <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
            </div>
        </div>

        <!-- Learning Content Container -->
        <div id="learning-content" style="padding: 0;">
            <!-- Content rendered by learning.js -->
            <div style="text-align: center; padding: 60px 20px;">
                <div class="learning-spinner"></div>
                <div style="color: var(--text-muted); margin-top: 15px;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- CALENDAR / CYCLE VIEW -->
    <!-- CYCLE / HORMONE HUB VIEW -->
    <div id="view-cycle" class="app-view" style="display:none; padding-bottom: 90px; background: #f8fafc;">
        <!-- Header -->
        <div style="padding: 20px 25px; padding-top: calc(20px + env(safe-area-inset-top, 0px)); background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
            <div>
                <h2 style="margin:0; font-family:'Playfair Display'; color:var(--primary); font-size: 1.5rem;">Hormone Hub</h2>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="coin-header-widget" onclick="openCoinShop()">
                    <span class="coin-emoji">🪙</span>
                    <span class="coin-amount coin-balance-sync">0</span>
                    <button class="coin-buy-btn" onclick="event.stopPropagation(); openCoinShop()">+</button>
                </div>
                <div class="profile-icon" onclick="switchAppTab('profile', this)">S</div>
            </div>
        </div>

        <!-- Cycle Wheel / Hero Card -->
        <div style="padding: 25px;">
            <div id="cycle-hero-card" class="card" style="background: linear-gradient(135deg, var(--bg) 0%, var(--accent-green) 100%); border: 1px solid var(--secondary); box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1); overflow: visible;">
                <div class="card-body active" style="opacity:1; max-height:none; padding: 30px 25px; text-align: center;">

                    <!-- Phase Indicator Ring (CSS Only) -->
                    <div style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--secondary); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; position: relative; background: white; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);">
                         <!-- Dynamic progress border would go here -->
                         <div style="font-size: 2.5rem;">🌸</div>
                         <div style="position: absolute; bottom: -10px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">Day <span id="cycle-day-display">--</span></div>
                    </div>

                    <h2 id="cycle-phase-name" style="color: var(--primary); margin: 0 0 10px 0; font-family: 'Playfair Display'; font-size: 1.8rem;">Loading...</h2>
                    <p id="cycle-phase-desc" style="color: var(--text-main); font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px;">Tracking your cycle helps predict your energy.</p>

                    <!-- Phase Tags -->
                    <div id="cycle-phase-tags" style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Cycle Sync Check-in Button -->
            <div id="check-in-prompt-card" onclick="openCheckInModal()" style="margin-top: 20px; background: white; border: 1px solid var(--primary); color: var(--primary); padding: 20px; border-radius: 16px; font-weight: 600; text-align: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div style="font-size: 1.5rem;">✨</div>
                <div style="text-align: left;">
                    <div style="font-size: 1.05rem; color: var(--primary);">Daily Check-in</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 400;">Unlock your daily cycle sync</div>
                </div>
                <div style="margin-left: auto; background: var(--primary); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">→</div>
            </div>
            
            <!-- Check-in Completed State (Hidden by default) -->
            <div id="check-in-completed-card" style="display: none; margin-top: 20px; background: #F0FDF4; border: 1px solid #BBF7D0; color: #166534; padding: 20px; border-radius: 16px; text-align: center;">
                <div style="font-size: 1.5rem; margin-bottom: 5px;">✅</div>
                <div style="font-weight: 700;">Cycle Sync Active!</div>
                <div style="font-size: 0.85rem; margin-top: 5px;">Your dashboard has been updated.</div>
            </div>

        </div>

        <!-- Weekly/Monthly Calendar -->
        <div style="padding: 0 25px 25px 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--primary); margin: 0; font-size: 1.1rem;">Your Predictions</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="calendar-view-toggle" id="calendar-view-toggle">
                        <button class="toggle-btn active" data-view="weekly" onclick="switchCalendarView('weekly')">Week</button>
                        <button class="toggle-btn" data-view="monthly" onclick="switchCalendarView('monthly')">Month</button>
                    </div>
                    <span onclick="switchAppTab('profile')" style="font-size: 0.8rem; color: var(--secondary); cursor: pointer; font-weight: 600;">Edit Dates</span>
                </div>
            </div>

            <div id="weekly-calendar" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Calendar rows inserted via JS -->
            </div>

            <div id="monthly-calendar" style="display: none;">
                <!-- Monthly calendar grid inserted via JS -->
            </div>
        </div>
    </div>

    <style>
        .mood-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mood-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .calendar-day-row {
            display: flex;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid #eee;
        }
        .calendar-day-row.is-today {
            border: 2px solid var(--secondary);
            background: #fffbf0;
        }
        .cal-date-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 45px;
            border-right: 1px solid #eee;
            padding-right: 15px;
        }
        .cal-day-name { font-size: 0.75em; color: #888; text-transform: uppercase; font-weight: 700; }
        .cal-day-num { font-weight: 700; font-size: 1.25em; color: var(--primary); }
        
        .cal-context {
            flex: 1;
        }
        .cal-workout-tag {
            background: var(--surface);
            color: var(--primary);
            font-size: 0.85em;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
            border: 1px solid #eee;
        }
        .cal-phase-dot {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px;
        }
        
        .cycle-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .cycle-settings input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
        }

        /* Calendar View Toggle */
        .calendar-view-toggle {
            display: flex;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 3px;
        }
        .calendar-view-toggle .toggle-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            font-size: 0.8rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .calendar-view-toggle .toggle-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Monthly Calendar Grid */
        .monthly-calendar-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #eee;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .monthly-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-bottom: 1px solid #eee;
        }
        .monthly-calendar-header .month-nav-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
            color: var(--primary);
            border-radius: 6px;
            transition: background 0.2s;
        }
        .monthly-calendar-header .month-nav-btn:hover {
            background: #eee;
        }
        .monthly-calendar-header .month-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
        }
        .monthly-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #fafafa;
            border-bottom: 1px solid #eee;
        }
        .monthly-calendar-weekdays span {
            padding: 10px 5px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
        }
        .monthly-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #f1f5f9;
        }
        .monthly-day-cell {
            background: white;
            min-height: 65px;
            padding: 6px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        .monthly-day-cell:hover {
            background: #fefce8;
        }
        .monthly-day-cell.other-month {
            background: #fafafa;
            color: #cbd5e1;
        }
        .monthly-day-cell.other-month:hover {
            background: #f5f5f5;
        }
        .monthly-day-cell.is-today {
            background: #fffbeb;
            border: 2px solid var(--secondary);
        }
        .monthly-day-num {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 4px;
        }
        .monthly-day-cell.other-month .monthly-day-num {
            color: #cbd5e1;
        }
        .monthly-phase-indicator {
            position: absolute;
            bottom: 4px;
            left: 4px;
            right: 4px;
            height: 4px;
            border-radius: 2px;
        }
        .monthly-workout-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary);
            display: inline-block;
            margin-top: 2px;
        }
        .monthly-day-workout {
            font-size: 0.6rem;
            color: #64748b;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 2px;
        }
    </style>

    <!-- PROFILE VIEW -->
    <div id="view-profile" class="app-view" style="display:none; padding-bottom: 80px;">
        <div class="app-header">
            <div class="app-logo">Your Profile</div>
            <div style="width:35px;"></div> <!-- Spacer -->
        </div>

        <div class="profile-header">
            <!-- Robust Profile Photo: Text S is background, IMG overlays it -->
            <div class="profile-photo-container" style="display:flex; align-items:center; justify-content:center; background:var(--accent-green); overflow:hidden;">
                <span id="profile-default-initial" style="font-size:3rem; font-weight:700; color:var(--primary);">S</span>
                <img src="" class="profile-photo" id="profile-photo-img" style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:50%; object-fit:cover;" onerror="this.style.opacity=0" onload="this.style.opacity=1">
                
                <label for="profile-photo-input" class="photo-edit-btn">
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:white;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                </label>
                <input type="file" id="profile-photo-input" accept="image/*" style="display:none;" onchange="handlePhotoUpload(this)">
            </div>
            <h2 class="profile-name-large" id="profile-name-display">Shannon</h2>
            <div class="profile-email" id="profile-email-display">Loading...</div>
        </div>

        <!-- Basic Stats Row -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; padding: 0 25px; margin-bottom: 25px;">
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Age</div>
                <div id="profile-age-display" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">34</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Weight</div>
                <div id="profile-weight-display" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">68 kg</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Goal</div>
                <div id="profile-goal-display" style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">Fat Loss</div>
            </div>
        </div>

        <!-- Professional Protocol Settings -->
        <div class="settings-card" style="margin: 0 25px 25px 25px; background: white; border-radius: 16px; border: 1px solid #f1f5f9; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
            <div style="background: #f8fafc; padding: 15px 20px; border-bottom: 1px solid #e2e8f0;">
                <h3 style="margin:0; font-size: 0.95rem; color: var(--text-main); display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                    <span>🧬</span> Metabolic Protocol
                </h3>
            </div>
            <div style="padding: 0;">
                <!-- Energy Level - Read Only -->
                <div class="setting-row" style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div id="profile-type-label" style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Energy Level</div>
                        <div id="profile-type-desc" style="font-size: 0.8rem; color: var(--text-muted);">From your onboarding quiz</div>
                    </div>
                    <div id="profile-type-display" style="font-weight: 700; color: var(--primary);"></div>
                </div>

                <!-- Equipment - Read Only, updated via daily check-in -->
                <div class="setting-row" style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                     <div>
                        <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Equipment Access</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Updated via daily check-in</div>
                    </div>
                    <div id="profile-equipment-display" style="font-weight: 700; color: var(--primary);">No Equipment</div>
                </div>

                <!-- Dietary Preference -->
                <div class="setting-row" style="padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                     <div>
                        <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-main);">Dietary Preference</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">From your onboarding setup</div>
                    </div>
                    <div id="profile-diet-display" style="font-weight: 700; color: var(--primary);">Not set</div>
                </div>

            </div>
        </div>

        <!-- Hidden inputs for cycle tracking (used by existing JavaScript) -->
        <input type="date" id="last-period-input-profile" style="display:none;">
        <input type="number" id="cycle-length-input-profile" value="28" style="display:none;">
        <input type="checkbox" id="no-period-toggle-profile" style="display:none;">

        <div style="text-align:center; margin-top:20px;">
            <button id="btn-edit-profile" onclick="toggleProfileEditMode()" style="background:#f1f5f9; color:var(--text-main); border:none; padding:10px 24px; border-radius:30px; font-weight:600; font-size:0.9rem; cursor:pointer; display:inline-flex; align-items:center; gap:8px;">
                <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:currentColor;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                Edit Profile
            </button>
            <button id="btn-save-profile" onclick="saveProfileChanges()" style="background:var(--primary); color:white; border:none; padding:10px 24px; border-radius:30px; font-weight:600; font-size:0.9rem; cursor:pointer; display:none; align-items:center; gap:8px;">
                Save Changes
            </button>
        </div>

        <!-- Manual Quiz/Check-in Triggers -->
        <div style="margin-top:30px; padding:20px; background:#f8fafc; border-radius:12px;">
            <h3 style="margin:0 0 15px 0; font-size:1rem; color:var(--text-main);">Health Tools</h3>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button onclick="initOnboardingWizard()" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>🌸</span> Restart Onboarding Setup
                </button>
                <button onclick="recalculateCalories()" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>🔄</span> Recalculate My Calories
                </button>
                <button onclick="openCycleTrackingModal()" style="background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>🌸</span> Cycle Tracking
                </button>
                <button id="settings-allocate-stats-btn" onclick="showStatAllocationModal()" style="display:none; background:white; color:var(--primary); border:1px solid var(--primary); padding:12px 20px; border-radius:8px; font-weight:600; font-size:0.9rem; cursor:pointer; align-items:center; justify-content:center; gap:8px;">
                    <span>⚔️</span> Allocate Battle Stats
                </button>
            </div>
        </div>

        <!-- APP SETTINGS -->
        <h3 style="padding: 0 25px; margin-bottom: 20px; display:flex; align-items:center; gap:10px;">
            <!-- Regular Settings Gear Icon -->
            <svg id="settings-icon-gear" class="settings-icon-gear" viewBox="0 0 24 24" style="width:24px; height:24px; fill:var(--text-main);"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.73,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            <!-- Dragon Ball Icon (for DBZ themes) -->
            <img id="settings-icon-dragonball" class="settings-icon-dragonball" src="assets/dragon-ball.svg" alt="Dragon Ball" style="width:24px; height:24px; vertical-align:middle;" />
            <!-- Sailor Moon Icon (for Sailor Moon themes) -->
            <img id="settings-icon-sailormoon" class="settings-icon-sailormoon" src="assets/sailor-moon.svg" alt="Sailor Moon" style="width:24px; height:24px; vertical-align:middle;" />
            Settings
        </h3>
        <div style="padding: 0 25px; margin-bottom: 30px;">
            <div style="background:white; border-radius:12px; border:1px solid #f1f5f9; overflow:hidden;">
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>Color Theme</div>
                     <select id="theme-selector" onchange="applyAppTheme(this.value)" style="border:1px solid #e2e8f0; padding:5px 10px; border-radius:8px; color:var(--primary); font-weight:600; outline:none; background:transparent; font-family: 'Inter', sans-serif; cursor: pointer;">
                         <option value="default">Forest (Original)</option>
                         <option value="antigravity-light">Antigravity Light</option>
                         <option value="ocean">Ocean Calm</option>
                         <option value="sunset">Sunset Glow</option>
                         <option value="cycle-pink" class="female-only-theme">Cycle Harmony</option>
                         <option value="flower-garden" class="female-only-theme">Flower Garden</option>
                         <option value="sailor-moon" class="female-only-theme">Moon Princess</option>
                         <option value="sailor-venus" class="female-only-theme">Goddess of Love</option>
                         <option value="monochrome">Monochrome</option>
                         <option value="dbz-warrior" class="male-only-theme">Super Saiyan</option>
                         <option value="dbz-vegeta" class="male-only-theme">Saiyan Prince</option>
                     </select>
                     <script>
                         // Initialize theme selector with saved value immediately
                         (function() {
                             var savedTheme = localStorage.getItem('userThemePreference') || 'default';
                             var selector = document.getElementById('theme-selector');
                             if (selector) selector.value = savedTheme;
                         })();
                     </script>
                 </div>
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>Units</div>
                     <div style="font-size:0.9rem; font-weight:700; color:var(--primary); cursor:pointer;" onclick="alert('Units toggled (Simulation)')">Metric (kg)</div>
                 </div>
                 <!-- Meal Timing & Reminders Settings -->
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9;">
                     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; cursor:pointer;" onclick="toggleMealReminderSection(event)">
                         <div>
                             <div>Meal Timing Reminders</div>
                             <div style="font-size:0.75rem; color:var(--text-muted);">Your FitGotchi will remind you when it's time to eat</div>
                         </div>
                         <label class="toggle-switch" style="display:inline-block; width:40px; height:24px; position:relative;">
                             <input type="checkbox" id="meal-reminders-toggle" onchange="toggleMealReminders(this.checked)">
                             <span style="position:absolute; inset:0; background:#ccc; border-radius:24px; transition:0.3s;" class="slider"></span>
                             <span style="position:absolute; top:2px; left:2px; width:20px; height:20px; background:white; border-radius:50%; transition:0.3s;" class="knob"></span>
                         </label>
                     </div>
                     <!-- Notification permission status -->
                     <div id="notification-status-banner" style="display:none; margin-top:8px; padding:8px 12px; border-radius:8px; font-size:0.78rem; display:none;"></div>
                     <!-- Reminder Time Settings (shown when reminders enabled) -->
                     <div id="meal-reminder-times" style="display:none; margin-top:12px; padding:12px; background:#f8f9fa; border-radius:10px;">
                         <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                             <label style="font-size:0.9rem; display:flex; align-items:center; gap:8px;">
                                 <input type="checkbox" id="breakfast-reminder-check" checked>
                                 <span>Breakfast</span>
                             </label>
                             <input type="time" id="breakfast-reminder-time" value="08:00" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px; font-size:0.85rem;">
                         </div>
                         <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                             <label style="font-size:0.9rem; display:flex; align-items:center; gap:8px;">
                                 <input type="checkbox" id="lunch-reminder-check" checked>
                                 <span>Lunch</span>
                             </label>
                             <input type="time" id="lunch-reminder-time" value="12:30" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px; font-size:0.85rem;">
                         </div>
                         <div style="display:flex; align-items:center; justify-content:space-between;">
                             <label style="font-size:0.9rem; display:flex; align-items:center; gap:8px;">
                                 <input type="checkbox" id="dinner-reminder-check" checked>
                                 <span>Dinner</span>
                             </label>
                             <input type="time" id="dinner-reminder-time" value="18:30" style="padding:6px 10px; border:1px solid #ddd; border-radius:6px; font-size:0.85rem;">
                         </div>
                         <!-- Save Reminders Button -->
                         <button id="save-meal-reminders-btn" onclick="saveAndConfirmMealReminders()" style="margin-top:12px; width:100%; padding:10px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                             <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:white;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                             Save Reminders
                         </button>
                         <!-- Active Reminders Status (persists on reload so you always know what's set) -->
                         <div id="active-reminders-status" style="display:none; margin-top:10px; padding:10px 12px; background:linear-gradient(135deg, #e0f2f1, #e8f5e9); border-radius:8px; border:1px solid #a5d6a7;">
                             <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                                 <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:#22c55e; flex-shrink:0;"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                                 <span style="font-size:0.82rem; font-weight:600; color:#2e7d32;">Notifications On</span>
                             </div>
                             <div id="active-reminders-list" style="font-size:0.78rem; color:#558b2f; line-height:1.5;"></div>
                         </div>
                         <div style="margin:10px 0 0 0; padding:8px 10px; background:linear-gradient(135deg, #e8f5e9, #f1f8e9); border-radius:8px; border:1px solid #c8e6c9;">
                             <p style="margin:0 0 4px 0; font-size:0.8rem; font-weight:600; color:#2e7d32;">+1 XP Bonus for On-Time Meals!</p>
                             <p style="margin:0; font-size:0.72rem; color:#558b2f;">Log your meal within 30 minutes of your scheduled time to earn bonus XP. Your FitGotchi will send you a push notification when it's time to eat.</p>
                         </div>
                     </div>
                 </div>
                 <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>
                         <div>Add Friend</div>
                         <div style="font-size:0.75rem; color:var(--text-muted);">Search and connect with friends</div>
                     </div>
                     <button onclick="openAddFriendModal()" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px;">
                         <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:white;"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                         Add
                     </button>
                 </div>
                 <div style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                     <div>
                         <div>Invite a Friend</div>
                         <div style="font-size:0.75rem; color:var(--text-muted);">You both get 1 week double XP</div>
                     </div>
                     <button onclick="openShareReferralModal()" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px;">
                         <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:white;"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                         Share
                     </button>
                 </div>
                <!-- Fitbit Connection -->
                <div id="settings-fitbit-connect" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:#00B0B9;"><circle cx="12" cy="4" r="2.5"/><circle cx="12" cy="9.5" r="2.5"/><circle cx="12" cy="15" r="2"/><circle cx="12" cy="19.5" r="1.5"/><circle cx="7" cy="9.5" r="1.5"/><circle cx="17" cy="9.5" r="1.5"/></svg>
                            Fitbit
                        </div>
                        <div id="fitbit-status-text" style="font-size:0.75rem; color:var(--text-muted);">Sync steps, sleep & heart rate</div>
                    </div>
                    <button id="fitbit-connect-btn" onclick="toggleFitbitConnection()" style="padding:8px 16px; border-radius:8px; border:none; background:#00B0B9; color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Connect
                    </button>
                </div>
                <!-- WHOOP Connection -->
                <div id="settings-whoop-connect" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:#1a1a1a;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            WHOOP
                        </div>
                        <div id="whoop-status-text" style="font-size:0.75rem; color:var(--text-muted);">Sync recovery, strain & sleep</div>
                    </div>
                    <button id="whoop-connect-btn" onclick="toggleWhoopConnection()" style="padding:8px 16px; border-radius:8px; border:none; background:#1a1a1a; color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Connect
                    </button>
                </div>
                <!-- Oura Ring Connection -->
                <div id="settings-oura-connect" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:#c4a862;"><circle cx="12" cy="12" r="9" stroke="#c4a862" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="5" stroke="#c4a862" stroke-width="1.5" fill="none"/></svg>
                            Oura Ring
                        </div>
                        <div id="oura-status-text" style="font-size:0.75rem; color:var(--text-muted);">Sync readiness, sleep & activity</div>
                    </div>
                    <button id="oura-connect-btn" onclick="toggleOuraConnection()" style="padding:8px 16px; border-radius:8px; border:none; background:#c4a862; color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Connect
                    </button>
                </div>
                <!-- Strava Connection -->
                <div id="settings-strava-connect" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:#FC4C02;"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
                            Strava
                        </div>
                        <div id="strava-status-text" style="font-size:0.75rem; color:var(--text-muted);">Sync workouts, runs & rides</div>
                    </div>
                    <button id="strava-connect-btn" onclick="toggleStravaConnection()" style="padding:8px 16px; border-radius:8px; border:none; background:#FC4C02; color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Connect
                    </button>
                </div>
                <!-- Spotify Connection -->
                <div id="settings-spotify-connect" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:#1DB954;"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                            Spotify
                        </div>
                        <div id="spotify-status-text" style="font-size:0.75rem; color:var(--text-muted);">Sync listening habits & music data</div>
                    </div>
                    <button id="spotify-connect-btn" onclick="toggleSpotifyConnection()" style="padding:8px 16px; border-radius:8px; border:none; background:#1DB954; color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Connect
                    </button>
                </div>
                <!-- Download App (hidden if already installed as PWA) -->
                <div id="settings-download-app" style="padding:15px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div>Download App</div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">Install for the best experience</div>
                    </div>
                    <button class="pwa-install-btn" onclick="installPWA(this)" data-original-text="Install" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:6px; min-width:90px; justify-content:center;">
                        Install
                    </button>
                </div>
                <!-- Admin Board (only visible to admins) -->
                <div id="admin-board-setting" style="padding:15px; border-top:1px solid #f1f5f9; display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div>Admin Board</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">Manage users and view analytics</div>
                        </div>
                        <button onclick="window.location.href='/admin-dashboard.html'" style="padding:8px 16px; border-radius:8px; border:none; background:var(--primary); color:white; font-weight:600; cursor:pointer;">
                            Open
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Download App Button (above logout) -->
        <div id="profile-download-app-btn" style="padding: 0 25px; margin-top: 30px;">
            <button class="pwa-install-btn" onclick="installPWA(this)" data-original-text="DOWNLOAD APP" style="width:100%; padding:15px; border-radius:12px; font-weight:700; background:linear-gradient(135deg, #046A38, #06a94d); color:white; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition: transform 0.2s, box-shadow 0.2s; box-shadow:0 4px 15px rgba(4,106,56,0.25);" onmouseover="this.style.transform='scale(1.01)'; this.style.boxShadow='0 6px 20px rgba(4,106,56,0.35)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(4,106,56,0.25)'">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                DOWNLOAD APP
            </button>
        </div>

        <!-- Delete Account Button -->
        <div style="padding: 0 25px; margin-top: 12px; margin-bottom: 12px;">
            <button onclick="handleDeleteAccount()" style="width:100%; padding:15px; border-radius:12px; font-weight:700; background:#991b1b; color:white; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition: background 0.2s;" onmouseover="this.style.background='#7f1d1d'" onmouseout="this.style.background='#991b1b'">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                DELETE ACCOUNT
            </button>
        </div>

        <!-- Logout Button -->
        <div style="padding: 0 25px; margin-top: 12px; margin-bottom: 40px;">
            <button onclick="handleLogout()" style="width:100%; padding:15px; border-radius:12px; font-weight:700; background:#ef4444; color:white; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition: background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                LOG OUT
            </button>
        </div>

        </div>

    <!-- EDIT PROFILE MODAL -->

    <script src="js/dashboard/dashboard-script-4-symptoms_list_removed_symptoms.js"></script>


    </div> 
</div> <!-- End Main Container (Moved) -->

<script src="js/dashboard/dashboard-script-5-initialize_stripe_for_inapp_pu.js"></script>

<!-- Image Modal HTML -->
<div class="image-modal-overlay" id="imageModal" onclick="closeImageModal()">
<div class="close-modal-btn"></div>
<img alt="Full size meal" class="image-modal-content" id="modalImage" onclick="event.stopPropagation()" src=""/>
</div>

<!-- Meal Detail Popup -->
<div class="meal-detail-popup" id="mealDetailPopup" onclick="closeMealDetailPopup()">
    <div class="meal-detail-container" onclick="event.stopPropagation()">
        <div id="mealDetailPhotoSection"></div>
        <div class="meal-detail-content">
            <div class="meal-detail-header">
                <div class="meal-detail-time" id="mealDetailTime"></div>
                <div class="meal-detail-foods" id="mealDetailFoods"></div>
            </div>
            <div class="meal-detail-calories">
                <div class="meal-detail-calories-value" id="mealDetailCalories"></div>
                <div class="meal-detail-calories-label">calories</div>
            </div>
            <div class="meal-detail-macros">
                <div class="meal-detail-macro protein">
                    <div class="meal-detail-macro-value" id="mealDetailProtein"></div>
                    <div class="meal-detail-macro-label">Protein</div>
                </div>
                <div class="meal-detail-macro carbs">
                    <div class="meal-detail-macro-value" id="mealDetailCarbs"></div>
                    <div class="meal-detail-macro-label">Carbs</div>
                </div>
                <div class="meal-detail-macro fat">
                    <div class="meal-detail-macro-value" id="mealDetailFat"></div>
                    <div class="meal-detail-macro-label">Fat</div>
                </div>
            </div>
            <div class="meal-detail-items" id="mealDetailItems"></div>
            <button class="meal-detail-edit-btn" id="mealDetailEditBtn" onclick="openEditItemsModal()">
                ✏️ Edit Items
            </button>
        </div>
    </div>
</div>

<!-- Food Items Modal (Edit or Add mode) -->
<div class="edit-items-modal" id="editItemsModal" onclick="closeFoodItemsModal()">
    <div class="edit-items-container" onclick="event.stopPropagation()">
        <div class="edit-items-header">
            <h3 id="foodItemsModalTitle">Edit Food</h3>
            <button class="edit-items-close" onclick="closeFoodItemsModal()">&times;</button>
        </div>
        <div class="edit-items-list" id="editItemsList"></div>
        <div class="edit-items-add">
            <input type="text" id="newItemInput" placeholder="Food item (e.g., 'oats' or 'chicken breast')" onkeypress="if(event.key==='Enter')addNewItem()">
            <input type="text" id="newItemPortionInput" placeholder="Amount (e.g., 200g)" onkeypress="if(event.key==='Enter')addNewItem()" style="max-width:120px;">
            <button onclick="addNewItem()">+ Add</button>
        </div>
        <div class="edit-items-actions">
            <button class="edit-items-cancel" onclick="closeFoodItemsModal()">Cancel</button>
            <button class="edit-items-recalculate" onclick="handleFoodItemsSubmit()" id="recalculateBtn">
                <span class="recalc-text" id="foodItemsSubmitText">🔄 Recalculate</span>
                <span class="recalc-loading" style="display:none;">Processing...</span>
            </button>
        </div>
    </div>
</div>

<script>
// Image Modal Logic
document.addEventListener('DOMContentLoaded', function() {
    const mealImages = document.querySelectorAll('.card-body img');
    mealImages.forEach(img => {
        img.addEventListener('click', function(e) {
            e.stopPropagation(); 
            openImageModal(this.src, this.alt);
        });
    });
});

function openImageModal(src, alt) {
    const modal = document.getElementById('imageModal');
    const img = document.getElementById('modalImage');
    img.src = src;
    img.alt = alt || 'Meal Image';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden'; 
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.classList.remove('active');
    document.body.style.overflow = ''; 
    setTimeout(() => {
        document.getElementById('modalImage').src = '';
    }, 300); 
}

// Close on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") {
        closeImageModal();
    }
});

function showSupportTab(tab, btn) {
    // 1. Toggle Buttons
    const container = btn.parentElement;
    container.querySelectorAll('button').forEach(b => {
        b.classList.remove('active');
        b.style.background = 'transparent';
        b.style.color = '#718096';
    });
    btn.classList.add('active');
    btn.style.background = 'white';
    btn.style.color = 'var(--primary)';

    // 2. Toggle Content
    const chat = document.getElementById('support-chat');
    const comm = document.getElementById('support-community');
    const refl = document.getElementById('support-reflections');

    if (tab === 'chat') {
        chat.style.display = 'flex';
        comm.style.display = 'none';
        refl.style.display = 'none';
        // Scroll to bottom of chat messages after a short delay to ensure content is rendered
        setTimeout(() => {
            const chatContainer = document.getElementById('chat-messages-container');
            if (chatContainer) {
                const rect = chatContainer.getBoundingClientRect();
                const absoluteBottom = rect.bottom + window.pageYOffset;
                window.scrollTo({
                    top: absoluteBottom - window.innerHeight + 100, // 100px buffer for input box
                    behavior: 'smooth'
                });
            }
        }, 100);
    } else if (tab === 'community') {
        chat.style.display = 'none';
        comm.style.display = 'flex';
        refl.style.display = 'none';
        loadCommunityFeed(); // Refresh feed when opening
    } else if (tab === 'reflections') {
        chat.style.display = 'none';
        comm.style.display = 'none';
        refl.style.display = 'flex';
        loadAllReflections(); // Load reflections when opening
    }
}

// Helper function to scroll to bottom of chat messages
function scrollToBottomOfChat() {
    const chatContainer = document.getElementById('chat-messages-container');
    if (chatContainer) {
        // Check if container is inside a modal (has overflow-y: auto)
        const modal = document.getElementById('coach-chat-modal');
        if (modal && modal.style.display === 'flex') {
            // Scroll the container within the modal
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } else {
            // Legacy full-page scroll
            const rect = chatContainer.getBoundingClientRect();
            const absoluteBottom = rect.bottom + window.pageYOffset;
            window.scrollTo({
                top: absoluteBottom - window.innerHeight + 100,
                behavior: 'smooth'
            });
        }
    }
}

// Consolidated Chat Logic (Old versions removed)


// Old chat logic removed.

// --- COMMUNITY CHAT LOGIC (HUMAN REFERRAL NETWORK ONLY) ---

function loadCommunityFeed() {
    let messages = [];
    try { messages = JSON.parse(localStorage.getItem('community_chat_history') || '[]'); } catch(e) {}
    if(messages.length === 0) {
        const sysMsg = {
            id: 'sys_' + Date.now(),
            isSystem: true,
            text: `Community group started`,
            timestamp: Date.now()
        };
        messages.push(sysMsg);
        localStorage.setItem('community_chat_history', JSON.stringify(messages));
    }
    renderChat(messages);
}

function renderChat(messages) {
    const container = document.getElementById('community-chat-stream');
    if(!container) return;

    // 1. Build a single massive string instead of touching the DOM repeatedly
    let fullHtml = '';

    messages.forEach((msg, msgIndex) => {
        const isMe = !msg.authorId || msg.authorId === 'current-user';

        // For other users, show their avatar and name
        let avatarHtml = '';
        let authorName = '';
        if(!isMe && msg.authorName) {
             // Use user's profile photo if available, otherwise use initials
             if (msg.authorAvatar) {
                 avatarHtml = `<img src="${msg.authorAvatar}" style="width:32px; height:32px; border-radius:50%; flex-shrink:0; align-self:flex-end; margin-bottom:5px; object-fit:cover;">`;
             } else {
                 const initials = msg.authorName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                 avatarHtml = `<div style="width:32px; height:32px; border-radius:50%; flex-shrink:0; align-self:flex-end; margin-bottom:5px; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:0.75rem; font-weight:600;">${initials}</div>`;
             }
             authorName = msg.authorName;
        }

        const bBg = isMe ? 'var(--chat-bg-user)' : 'var(--chat-bg-coach)';
        const bText = isMe ? 'var(--chat-text-user)' : 'var(--chat-text-coach)';
        const bRadius = isMe ? '18px 18px 0 18px' : '18px 18px 18px 0';
        const bBorder = isMe ? 'none' : '1px solid var(--chat-border-coach)';
        const alignStyle = isMe ? "justify-content: flex-end;" : "justify-content: flex-start;";

        // Emoji reactions (keeping for human interactions)
        let reactionsHtml = '';
        if (msg.reactions && msg.reactions.length > 0) {
            const reactionCounts = {};
            msg.reactions.forEach(r => {
                reactionCounts[r.emoji] = (reactionCounts[r.emoji] || 0) + 1;
            });
            reactionsHtml = '<div style="display:flex; gap:4px; margin-top:4px; margin-left:10px; flex-wrap:wrap;">';
            Object.entries(reactionCounts).forEach(([emoji, count]) => {
                reactionsHtml += `<span style="font-size:0.85rem; background:#f1f5f9; padding:2px 6px; border-radius:10px; border:1px solid #e2e8f0;">${emoji} ${count > 1 ? count : ''}</span>`;
            });
            reactionsHtml += '</div>';
        }

        let messageHtml = '';
        if (msg.isSystem) {
            messageHtml = `<div style="text-align:center; margin: 20px 0; color:#94a3b8; font-size:0.8rem; font-weight:600; text-transform:uppercase; letter-spacing:1px;">${msg.text}</div>`;
        } else {
            messageHtml = `
            <div style="display:flex; ${alignStyle} margin-bottom: 12px; gap: 8px;">
                ${(!isMe && authorName) ? avatarHtml : ''}
                <div style="display:flex; flex-direction:column; max-width:75%; ${isMe ? 'align-items:flex-end;' : 'align-items:flex-start;'}">
                    ${(!isMe && authorName) ? `<div style="font-size:0.7rem; color:var(--text-muted); margin-left:10px; margin-bottom:2px;">${authorName}</div>` : ''}
                    <div>
                        <div style="padding: 10px 15px; font-size: 0.95rem; line-height: 1.4; background: ${bBg}; color: ${bText}; border-radius: ${bRadius}; border: ${bBorder}; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                            ${msg.text}
                        </div>
                        ${reactionsHtml}
                    </div>
                </div>
            </div>`;
        }

        // Append to string, NOT DOM
        fullHtml += messageHtml;
    });

    // 2. Update DOM exactly once
    container.innerHTML = fullHtml;
    container.scrollTop = container.scrollHeight;
}

</script>

<!-- COACH DASHBOARD STYLES -->
<style>
    /* Coach Dashboard Specific Styles */
    #view-coach-dashboard {
        display: none; /* Hidden by default */
        position: fixed;
        inset: 0;
        background: #f8fafc;
        z-index: 10000;
        overflow-y: auto;
        font-family: 'Inter', sans-serif;
    }

    .coach-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        min-height: 100vh;
    }

    /* Sidebar */
    .coach-sidebar {
        background: #0f172a;
        color: white;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .coach-logo {
        font-family: 'Playfair Display', serif;
        font-size: 1.5rem;
        margin-bottom: 40px;
        color: var(--secondary);
    }

    .coach-nav-item {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #94a3b8;
        transition: all 0.2s;
    }

    .coach-nav-item:hover, .coach-nav-item.active {
        background: rgba(255,255,255,0.1);
        color: white;
    }

    /* Main Content */
    .coach-main {
        padding: 30px;
        overflow-y: auto;
    }

    .coach-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .coach-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1e293b;
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
    }

    .d-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }

    .d-card h3 {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: #334155;
        border-bottom: 1px solid #f1f5f9;
        padding-bottom: 10px;
    }

    /* Compliance Snapshots */
    .compliance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 10px;
    }
    
    .compliance-dot {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
        position: relative;
    }
    .status-warning { background: #F59E0B; }
    .status-danger { background: #EF4444; }
    .status-good { background: #10B981; }

    /* Activity Feed */
    .activity-item {
        display: flex;
        gap: 15px;
        padding: 12px 0;
        border-bottom: 1px solid #f1f5f9;
    }
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Mobile Responsive adjustment for Coach View */
    @media (max-width: 768px) {
        .coach-layout { grid-template-columns: 1fr; }
        .coach-sidebar { display: none; } /* Add a mobile toggler later if needed, assume desktop for "Command Center" initially */
        .dashboard-grid { grid-template-columns: 1fr; }
    }
</style>

<!-- COACH DASHBOARD HTML -->
<div id="view-coach-dashboard-REMOVED" style="display:none !important;">
    <div class="coach-layout">
        <!-- Sidebar -->
        <div class="coach-sidebar">
            <div class="coach-logo">Shannon (Coach)</div>
            <div class="coach-nav-item active" onclick="showCoachSection('overview')">
                <span>🏠</span> Overview
            </div>
            <div class="coach-nav-item" onclick="showCoachSection('clients')">
                <span>👥</span> Clients
            </div>
            <div class="coach-nav-item" onclick="showCoachSection('messages')">
                <span>💬</span> Messages <span class="badge" style="background:red; padding:2px 6px; border-radius:10px; font-size:0.7rem;">3</span>
            </div>
            <div class="coach-nav-item" onclick="showCoachSection('calendar')">
                <span>📅</span> User Calendar
            </div>
             <div style="margin-top:auto;">
                <div class="coach-nav-item" onclick="toggleCoachMode(false)">
                    <span>🚪</span> Exit Coach Mode
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="coach-main">
            <!-- SECTION: OVERVIEW -->
            <div id="coach-sec-overview">
                <div class="coach-header">
                    <div>
                        <div class="coach-title">Command Center</div>
                        <div style="color:#64748b;">Welcome back, Shannon. Here is what's happening today.</div>
                    </div>
                    <button class="app-btn" style="width: auto; padding: 10px 20px;">+ Quick Add</button>
                </div>

                <div class="dashboard-grid">
                    <!-- Left Col -->
                    <div>
                        <!-- Compliance -->
                        <div class="d-card">
                            <h3>Compliance Snapshots</h3>
                            <div class="compliance-grid" id="compliance-container">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="d-card">
                            <h3>Recent Activity</h3>
                            <div id="activity-feed-container">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Col -->
                    <div>
                        <!-- Pending Requests -->
                        <div class="d-card">
                            <h3>Pending Requests (3)</h3>
                            <div class="activity-item">
                                <div class="activity-icon" style="background:#FEF3C7; color:#D97706;">??</div>
                                <div>
                                    <div style="font-weight:600;">Consultation Form</div>
                                    <div style="font-size:0.85rem; color:#64748b;">New Client Application</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon" style="background:#DBEAFE; color:#2563EB;">??</div>
                                <div>
                                    <div style="font-weight:600;">Payment Failed</div>
                                    <div style="font-size:0.85rem; color:#64748b;">Sarah J. - Subscription</div>
                                </div>
                            </div>
                        </div>

                        <!-- Daily Schedule -->
                        <div class="d-card">
                            <h3>Daily Schedule</h3>
                            <div class="activity-item">
                                <div style="font-weight:bold; color:var(--primary); width:50px;">09:00</div>
                                <div>Check-in Review</div>
                            </div>
                            <div class="activity-item">
                                <div style="font-weight:bold; color:var(--primary); width:50px;">14:30</div>
                                <div>Call with Jessica</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: CLIENTS (Deep Dive) -->
            <div id="coach-sec-clients" style="display:none;">
                <div class="coach-header">
                    <div class="coach-title">Client Profiles</div>
                    <input type="text" placeholder="Search clients..." style="padding:10px; border-radius:8px; border:1px solid #ccc;">
                </div>
                <!-- Simple Client List for Selection -->
                <div class="d-card" id="client-list-view">
                    <h3>All Clients</h3>
                    <div id="coach-client-list"></div>
                </div>

                <!-- SINGLE CLIENT VIEW (Hidden by default) -->
                <div id="single-client-view" style="display:none;">
                    <button onclick="closeClientProfile()" style="margin-bottom:20px; background:none; border:none; color:#64748b; cursor:pointer;">? Back to List</button>
                    
                    <div class="d-card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; gap:20px; align-items:center;">
                            <div id="sc-avatar" style="width:60px; height:60px; background:var(--primary); border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-size:1.5rem;">SJ</div>
                            <div>
                                <h2 id="sc-name" style="margin:0; font-size:1.5rem;">Sarah Jenkins</h2>
                                <div id="sc-status" style="color:#64748b;">Active  Wk 3  Cortisol Reset</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="app-btn" style="width:auto; background:var(--secondary);" onclick="openAsClient()">Open App as Client</button>
                            <button class="app-btn" style="width:auto;">Message</button>
                        </div>
                    </div>

                    <!-- Client Tabs -->
                    <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #e2e8f0;">
                        <div class="coach-nav-item active" style="color:var(--primary); border-bottom:2px solid var(--primary); border-radius:0;">Dash</div>
                        <div class="coach-nav-item" style="color:#64748b;">Progress</div>
                        <div class="coach-nav-item" style="color:#64748b;">Training</div>
                        <div class="coach-nav-item" style="color:#64748b;">Nutrition</div>
                        <div class="coach-nav-item" style="color:#64748b;">Notes ??</div>
                    </div>

                    <div class="dashboard-grid">
                        <!-- Stats Tiles -->
                        <div style="grid-column: 1 / -1; display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:20px;">
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">WEIGHT</div>
                                <div style="font-size:1.5rem; font-weight:bold;">64.5kg</div>
                                <div style="color:green; font-size:0.8rem;">? 0.5kg</div>
                            </div>
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">BODY FAT</div>
                                <div style="font-size:1.5rem; font-weight:bold;">22%</div>
                                <div style="color:green; font-size:0.8rem;">? 1.2%</div>
                            </div>
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">RHR</div>
                                <div style="font-size:1.5rem; font-weight:bold;">58</div>
                                <div style="color:green; font-size:0.8rem;">? 4 bpm</div>
                            </div>
                            <div class="d-card" style="margin:0; text-align:center;">
                                <div style="font-size:0.8rem; color:#64748b;">KCALS</div>
                                <div style="font-size:1.5rem; font-weight:bold;">1850</div>
                                <div style="color:orange; font-size:0.8rem;">Avg</div>
                            </div>
                        </div>

                        <!-- Left: Photos & Badges -->
                        <div class="d-card">
                            <h3>Progress Photos</h3>
                            <div style="display:flex; gap:10px;">
                                <div style="flex:1; background:#f1f5f9; aspect-ratio:3/4; display:flex; align-items:center; justify-content:center; border-radius:8px;">Front</div>
                                <div style="flex:1; background:#f1f5f9; aspect-ratio:3/4; display:flex; align-items:center; justify-content:center; border-radius:8px;">Side</div>
                            </div>
                        </div>

                        <!-- Right: Trainer Notes -->
                        <div class="d-card">
                            <h3>Trainer Notes ??</h3>
                            <textarea style="width:100%; height:150px; border:1px solid #e2e8f0; border-radius:8px; padding:10px;" placeholder="Private notes about this client..."></textarea>
                            <button class="app-btn" style="width:auto; margin-top:10px;">Save Note</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Other sections (Calendar, Messages) placeholders -->
            <div id="coach-sec-messages" style="display:none;">
                <div class="coach-header"><div class="coach-title">Messages</div></div>
                <div class="d-card">
                     <p>Message Center Implementation Pending...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// COACH MODE LOGIC

// Real clients loaded from Supabase
let REAL_CLIENTS = [];

// Primary toggleCoachMode defined below in AI section

async function initCoachDashboard() {
    console.log('🎛️ Initializing Coach Dashboard...');
    await loadRealClients();
    renderComplianceGrid();
    renderActivityFeed();
    renderClientList();
}

async function loadRealClients() {
    try {
        // Fetch all users from Supabase
        const users = await dbHelpers.users.getAll();
        
        REAL_CLIENTS = await Promise.all(users.map(async (user) => {
            // Get last check-in to determine status
            let status = 'good';
            let lastAct = 'No recent activity';
            
            try {
                // Get their most recent conversation
                const history = await dbHelpers.conversations.getHistory(user.id, 'coach', 1);
                if (history && history.length > 0) {
                    const lastMsg = history[history.length - 1];
                    const msgDate = new Date(lastMsg.timestamp);
                    const daysDiff = Math.floor((Date.now() - msgDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff === 0) lastAct = 'Messaged today';
                    else if (daysDiff === 1) lastAct = 'Messaged yesterday';
                    else if (daysDiff < 7) lastAct = `Messaged ${daysDiff} days ago`;
                    else lastAct = `Inactive ${daysDiff} days`;
                    
                    // Set status based on activity
                    if (daysDiff > 7) status = 'danger';
                    else if (daysDiff > 3) status = 'warning';
                }
            } catch (e) { console.warn('Could not get activity for user', user.id); }
            
            // Calculate program day
            let programDay = 0;
            if (user.program_start_date) {
                const start = new Date(user.program_start_date);
                programDay = Math.ceil((Date.now() - start) / (1000 * 60 * 60 * 24));
            }
            
            // Get initials for avatar
            const name = user.name || user.email?.split('@')[0] || 'User';
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            return {
                id: user.id,
                name: name,
                email: user.email,
                status: status,
                avatar: initials,
                lastAct: lastAct,
                programDay: programDay,
                startDate: user.program_start_date,
                profile: user.profile || 'Standard',
                lastLogin: user.last_login
            };
        }));
        
        console.log(`✅ Loaded ${REAL_CLIENTS.length} clients from database`);
    } catch (error) {
        console.error('Failed to load clients:', error);
        REAL_CLIENTS = [];
    }
}

function renderComplianceGrid() {
    const container = document.getElementById('compliance-container');
    if (REAL_CLIENTS.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-style:italic;">No clients found</div>';
        return;
    }
    container.innerHTML = REAL_CLIENTS.map(c => `
        <div class="compliance-dot status-${c.status}" onclick="openClientProfile('${c.id}')" title="${c.name} - ${c.lastAct}">
            ${c.avatar}
        </div>
    `).join('');
}

function renderActivityFeed() {
    const container = document.getElementById('activity-feed-container');
    
    // Build activity from real clients
    const activities = REAL_CLIENTS
        .filter(c => c.lastAct && c.lastAct !== 'No recent activity')
        .slice(0, 5)
        .map(c => ({
            name: c.name,
            action: c.lastAct,
            icon: c.status === 'good' ? '✅' : c.status === 'warning' ? '⚠️' : '🔴'
        }));
    
    if (activities.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-style:italic;">No recent activity</div>';
        return;
    }
    
    container.innerHTML = activities.map(a => `
        <div class="activity-item">
            <div class="activity-icon">${a.icon}</div>
            <div>
                <div style="font-weight:600;">${a.name}</div>
                <div style="font-size:0.85rem; color:#64748b;">${a.action}</div>
            </div>
        </div>
    `).join('');
}

function showCoachSection(secId) {
    // Hide all
    ['overview', 'clients', 'messages'].forEach(id => {
        const el = document.getElementById('coach-sec-' + id);
        if(el) el.style.display = 'none';
    });
    
    // Show selected
    document.getElementById('coach-sec-' + secId).style.display = 'block';
}

function renderClientList() {
    const container = document.getElementById('coach-client-list');
    
    if (REAL_CLIENTS.length === 0) {
        container.innerHTML = '<div style="padding:20px; color:#64748b; font-style:italic;">No clients registered yet.</div>';
        return;
    }
    
    container.innerHTML = REAL_CLIENTS.map(c => `
        <div class="activity-item" style="cursor:pointer;" onclick="openClientProfile('${c.id}')">
            <div class="activity-icon" style="background:${c.status === 'danger' ? '#FEE2E2' : c.status === 'warning' ? '#FEF3C7' : '#F1F5F9'}">${c.avatar}</div>
            <div style="flex:1;">
                <div style="font-weight:600;">${c.name}</div>
                <div style="font-size:0.85rem; color:#64748b;">${c.email || ''}</div>
                <div style="font-size:0.75rem; color:#94a3b8; margin-top:2px;">Day ${c.programDay || '?'} • ${c.lastAct}</div>
            </div>
            <div style="color:var(--primary);">→</div>
        </div>
    `).join('');
}

async function openClientProfile(clientId) {
    document.getElementById('client-list-view').style.display = 'none';
    document.getElementById('single-client-view').style.display = 'block';
    
    const client = REAL_CLIENTS.find(c => c.id === clientId);
    if (!client) {
        console.error('Client not found:', clientId);
        return;
    }
    
    // Update header
    document.getElementById('sc-name').innerText = client.name;
    document.getElementById('sc-avatar').innerText = client.avatar;
    document.getElementById('sc-status').innerHTML = `
        <span style="color:${client.status === 'good' ? 'green' : client.status === 'warning' ? 'orange' : 'red'};">●</span>
        Day ${client.programDay || '?'} • ${client.profile} • ${client.email}
    `;
    
    // Try to get more detailed stats
    try {
        // Get their full chat history
        const chatHistory = await dbHelpers.conversations.getHistory(clientId, 'coach', 50);
        
        // Update the stats grid
        const statsGrid = document.querySelector('#single-client-view .dashboard-grid > div:first-child');
        if (statsGrid) {
            statsGrid.innerHTML = `
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">PROGRAM DAY</div>
                    <div style="font-size:1.5rem; font-weight:bold;">${client.programDay || '-'}</div>
                    <div style="color:var(--primary); font-size:0.8rem;">of 28</div>
                </div>
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">MESSAGES</div>
                    <div style="font-size:1.5rem; font-weight:bold;">${chatHistory.length}</div>
                    <div style="color:#64748b; font-size:0.8rem;">Total</div>
                </div>
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">LAST ACTIVE</div>
                    <div style="font-size:1rem; font-weight:bold;">${client.lastAct}</div>
                </div>
                <div class="d-card" style="margin:0; text-align:center;">
                    <div style="font-size:0.8rem; color:#64748b;">PROFILE</div>
                    <div style="font-size:1rem; font-weight:bold;">${client.profile}</div>
                </div>
            `;
        }
        
        // Add chat history viewer
        renderClientChatHistory(chatHistory);
        
    } catch (error) {
        console.error('Failed to load client details:', error);
    }
}

function renderClientChatHistory(history) {
    // Find or create chat history container
    let container = document.getElementById('client-chat-history');
    if (!container) {
        // Create container if it doesn't exist
        const singleView = document.getElementById('single-client-view');
        const existingGrid = singleView.querySelector('.dashboard-grid');
        
        const chatCard = document.createElement('div');
        chatCard.className = 'd-card';
        chatCard.style.gridColumn = '1 / -1';
        chatCard.innerHTML = `
            <h3>💬 Conversation History</h3>
            <div id="client-chat-history" style="max-height:400px; overflow-y:auto; padding:10px; background:#f8fafc; border-radius:12px;"></div>
        `;
        existingGrid.appendChild(chatCard);
        container = document.getElementById('client-chat-history');
    }
    
    if (history.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-style:italic; padding:10px;">No messages yet.</div>';
        return;
    }
    
    container.innerHTML = history.map(msg => {
        const isUser = msg.role === 'user';
        const time = msg.brisbane_time || new Date(msg.timestamp).toLocaleString();
        return `
            <div style="display:flex; gap:10px; margin-bottom:12px; ${isUser ? 'justify-content:flex-end;' : ''}">
                ${!isUser ? '<div style="width:32px; height:32px; background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; flex-shrink:0;">🤖</div>' : ''}
                <div style="max-width:70%; ${isUser ? 'background:#064e3b; color:white;' : 'background:white; border:1px solid #e2e8f0;'} padding:10px 14px; border-radius:16px;">
                    <div style="font-size:0.9rem; white-space:pre-wrap;">${msg.message_text}</div>
                    <div style="font-size:0.7rem; ${isUser ? 'color:rgba(255,255,255,0.7);' : 'color:#94a3b8;'} margin-top:5px;">${time}</div>
                </div>
                ${isUser ? '<div style="width:32px; height:32px; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; flex-shrink:0;">👤</div>' : ''}
            </div>
        `;
    }).join('');
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function closeClientProfile() {
    document.getElementById('single-client-view').style.display = 'none';
    document.getElementById('client-list-view').style.display = 'block';
}

function openAsClient() {
    // Switch to normal dashboard view
    toggleCoachMode(false);
    // Ideally we would load the specific client's data into the view
    // For "Current User", it's already there.
    // For others, we'd need to mock swap the data, but for this task we'll just close the coach view
    // and show the "Current" view as a demo of the "Open" functionality.
}

</script>

<!-- CHECK-IN MODAL (Moved to root) -->
<div id="checkin-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10005; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
    <div style="background:white; width:90%; max-width:400px; border-radius:24px; padding:30px; position:relative; animation: slideUp 0.3s ease-out;">
        <h2 style="color:var(--primary); margin:0 0 10px 0; text-align:center;">Daily Check-in</h2>
        <p style="text-align:center; color:#64748b; margin-bottom:25px; font-size:0.95rem;">Let's customize your session for today.</p>

        <!-- Step 1: Energy -->
        <div style="margin-bottom:20px;">
            <label style="display:block; font-weight:600; margin-bottom:10px; color:var(--text-main);">How is your energy?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="selectEnergy('high')" id="btn-energy-high" class="checkin-btn" style="padding:15px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer; transition:all 0.2s;">
                    <div style="font-size:1.5rem;">⚡</div>
                    <div style="font-weight:600; margin-top:5px;">High</div>
                </button>
                <button onclick="selectEnergy('low')" id="btn-energy-low" class="checkin-btn" style="padding:15px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer; transition:all 0.2s;">
                    <div style="font-size:1.5rem;">🪫</div>
                    <div style="font-weight:600; margin-top:5px;">Low</div>
                </button>
            </div>
        </div>

        <!-- Step 2: Equipment -->
        <div style="margin-bottom:30px;">
            <label style="display:block; font-weight:600; margin-bottom:10px; color:var(--text-main);">Equipment Access?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <button onclick="selectEquipment('none')" id="btn-eq-none" class="checkin-btn" style="padding:10px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer;">
                    <span style="font-size:1.2rem;">🧘</span><br><span style="font-size:0.8rem; font-weight:600;">None</span>
                </button>
                <button onclick="selectEquipment('dumbbells')" id="btn-eq-dumbbells" class="checkin-btn" style="padding:10px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer;">
                    <span style="font-size:1.2rem;">🏋️</span><br><span style="font-size:0.8rem; font-weight:600;">Dumbbells</span>
                </button>
                <button onclick="selectEquipment('gym')" id="btn-eq-gym" class="checkin-btn" style="padding:10px; border:2px solid #e2e8f0; border-radius:12px; background:white; cursor:pointer;">
                    <span style="font-size:1.2rem;">🏢</span><br><span style="font-size:0.8rem; font-weight:600;">Gym</span>
                </button>
            </div>
        </div>

        <button onclick="submitCheckIn()" style="width:100%; background:var(--primary); color:white; border:none; padding:16px; border-radius:50px; font-weight:700; font-size:1rem; cursor:pointer;">Build My Workout</button>
    </div>
</div>


<!-- Cycle Tracking Modal -->
<div class="onboarding-overlay" id="cycle-tracking-modal" style="display:none; z-index:12000;">
    <div class="onboarding-modal" style="max-width: 450px; padding: 0; overflow: hidden;">

        <!-- HEADER -->
        <div style="padding: 25px 25px 0 25px; text-align: center; position:relative;">
            <div onclick="closeCycleTrackingModal()" style="position:absolute; top:15px; right:15px; width:30px; height:30px; line-height:30px; background:#f1f5f9; border-radius:50%; cursor:pointer; font-size:1.2rem; color:#64748b; font-weight:bold;">&times;</div>
            <h2 style="margin:0; color:var(--primary);">Cycle Tracking</h2>
        </div>

        <!-- CONTENT -->
        <div style="padding: 25px;">
            <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🌸</div>
            <h3 style="text-align:center; margin-bottom:10px;">Cycle Syncing</h3>
            <p style="text-align:center; color:#666; margin-bottom:25px;">We tailor your daily movement to match your hormonal phase.</p>

            <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">When was your last period?</label>
                <input type="date" id="cycle-modal-period-date" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
            </div>

            <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Cycle Length (Days)</label>
                <input type="number" id="cycle-modal-cycle-length" value="28" min="21" max="35" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
            </div>

            <div style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:20px;">
                <input type="checkbox" id="cycle-modal-wellness-toggle">
                <label for="cycle-modal-wellness-toggle" style="font-size:0.9rem; color:#64748b;">I don't have a period (Wellness Mode)</label>
            </div>

            <button onclick="saveCycleTrackingData()" style="width:100%; background:var(--primary); color:white; border:none; padding:16px; border-radius:50px; font-weight:700; font-size:1rem; cursor:pointer;">Save Changes</button>
        </div>
    </div>
</div>

<!-- Recalculate Calories Wizard Modal -->
<div class="onboarding-overlay" id="recalculate-calories-wizard" style="display:none; z-index:200000;">
    <div class="onboarding-modal wizard-container" style="max-width: 450px; max-height: 90vh; padding: 0; overflow: hidden; display: flex; flex-direction: column;">

        <!-- HEADER -->
        <div class="wizard-header" style="padding: 25px 25px 0 25px; text-align: center; position:relative; flex-shrink: 0;">
            <div onclick="closeRecalculateWizard()" style="position:absolute; top:15px; right:15px; width:30px; height:30px; line-height:30px; background:#f1f5f9; border-radius:50%; cursor:pointer; font-size:1.2rem; color:#64748b; font-weight:bold;">&times;</div>
            <div class="recalc-wizard-progress" style="display:flex; justify-content:center; gap:6px; margin-bottom:15px;">
                <div class="dot active"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <h2 id="recalc-wizard-title" style="margin:0; color:var(--primary);">Update Your Goals</h2>
        </div>

        <!-- CONTENT SLIDES -->
        <div class="wizard-content" style="flex: 1; padding: 25px; overflow-y: auto; min-height: 0;">

            <!-- SLIDE 1: SEX SELECTION -->
            <div class="recalc-wizard-slide active" id="recalc-slide-1">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🔄</div>
                <h3 style="text-align:center; margin-bottom:10px;">Let's Update Your Profile</h3>
                <p style="text-align:center; color:#666; margin-bottom:30px;">Select your program:</p>

                <div style="display:flex; flex-direction:column; gap:15px; max-width:300px; margin:0 auto;">
                    <button type="button" id="recalc-gender-btn-female" onclick="selectRecalcGender('female')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">🌸</span>
                        <span>For Her</span>
                    </button>

                    <button type="button" id="recalc-gender-btn-male" onclick="selectRecalcGender('male')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">💪</span>
                        <span>For Him</span>
                    </button>
                </div>

                <input type="hidden" id="recalc-wizard-gender" value="">
            </div>

            <!-- SLIDE 2: ESSENTIAL DATA -->
            <div class="recalc-wizard-slide" id="recalc-slide-2" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">📋</div>
                <h3 style="text-align:center; margin-bottom:10px;">Your Details</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">Update your information to recalculate your goals.</p>

                <!-- Age -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Age</label>
                    <input type="number" id="recalc-wizard-age" class="wizard-input" placeholder="25" min="18" max="100" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Height & Weight -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Height (cm)</label>
                        <input type="number" id="recalc-wizard-height" class="wizard-input" placeholder="170" min="100" max="250" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Weight (kg)</label>
                        <input type="number" id="recalc-wizard-weight" class="wizard-input" placeholder="70" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                </div>

                <!-- Goal Weight -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Goal Weight (kg)</label>
                    <input type="number" id="recalc-wizard-goal-weight" class="wizard-input" placeholder="65" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Activity Level -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Activity Level</label>
                    <select id="recalc-wizard-activity-level" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="sedentary">Sedentary (Little or no exercise)</option>
                        <option value="light">Lightly Active (Exercise 1-3 days/week)</option>
                        <option value="moderate">Moderately Active (Exercise 3-5 days/week)</option>
                        <option value="very">Very Active (Exercise 6-7 days/week)</option>
                    </select>
                </div>

                <!-- Primary Goal -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">What's your primary goal?</label>
                    <select id="recalc-wizard-goal-type" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select your goal</option>
                        <option value="Flat">Lose weight / Get lean</option>
                        <option value="Athletic">Get toned / Maintain fitness</option>
                        <option value="Body Builder">Build muscle / Gain strength</option>
                    </select>
                </div>
            </div>

            <!-- SLIDE 3: CONFIRMATION -->
            <div class="recalc-wizard-slide" id="recalc-slide-3" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">✨</div>
                <h3 style="text-align:center; margin-bottom:10px;">Your New Goals</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">Here are your updated daily targets:</p>

                <div id="recalc-results" style="background:#f0fdf4; border:1px solid #bbf7d0; padding:20px; border-radius:12px; margin-bottom:20px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                        <div style="text-align:center; padding:15px; background:white; border-radius:10px;">
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px;">Daily Calories</div>
                            <div id="recalc-result-calories" style="font-size:1.5rem; font-weight:700; color:var(--primary);">--</div>
                        </div>
                        <div style="text-align:center; padding:15px; background:white; border-radius:10px;">
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px;">Protein</div>
                            <div id="recalc-result-protein" style="font-size:1.5rem; font-weight:700; color:var(--primary);">--</div>
                        </div>
                        <div style="text-align:center; padding:15px; background:white; border-radius:10px;">
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px;">Carbs</div>
                            <div id="recalc-result-carbs" style="font-size:1.5rem; font-weight:700; color:var(--primary);">--</div>
                        </div>
                        <div style="text-align:center; padding:15px; background:white; border-radius:10px;">
                            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px;">Fat</div>
                            <div id="recalc-result-fat" style="font-size:1.5rem; font-weight:700; color:var(--primary);">--</div>
                        </div>
                    </div>
                </div>

                <div style="background:rgba(72,134,75,0.1); border-radius:10px; padding:12px; text-align:center;">
                    <p style="margin:0; font-size:0.85rem; color:#1a4d2e;">
                        <strong>📊 Based on your profile:</strong><br>
                        <span id="recalc-summary-text">Your goals have been personalized for your journey.</span>
                    </p>
                </div>
            </div>

        </div>

        <!-- FOOTER WITH BUTTONS -->
        <div class="wizard-footer" style="padding: 0 25px 25px 25px; flex-shrink: 0;">
            <div style="display:flex; gap:10px;">
                <button id="recalc-btn-back" onclick="recalcWizardBack()" style="flex:1; padding:14px; border-radius:50px; border:2px solid var(--primary); background:white; color:var(--primary); font-weight:700; cursor:pointer; display:none;">Back</button>
                <button id="recalc-btn-next" onclick="recalcWizardNext()" style="flex:2; padding:14px; border-radius:50px; border:none; background:var(--primary); color:white; font-weight:700; cursor:pointer;">Next</button>
            </div>
        </div>

    </div>
</div>

<!-- Onboarding Modal -->
<!-- ONBOARDING WIZARD -->
<!-- ============================================ -->
<!-- FITGOTCHI STORY ONBOARDING OVERLAY           -->
<!-- ============================================ -->
<div id="fitgotchi-story-overlay">
    <!-- Binary awakening screen (Phase 0 - black screen before Arny appears) -->
    <div class="story-binary-screen" id="story-binary-screen">
        <div class="story-binary-text" id="story-binary-text"></div>
    </div>

    <!-- Ambient particles -->
    <div class="story-particles" id="story-particles"></div>

    <!-- Loading indicator (shown while model loads) -->
    <div class="story-loading" id="story-loading">
        <div style="font-size: 2rem; margin-bottom: 8px;">💪</div>
        <div>Getting ready<span class="story-loading-dots"></span></div>
    </div>

    <!-- Shannon card (shown first before binary screen) -->
    <div class="story-shannon-card" id="story-shannon-card">
        <img src="https://f005.backblazeb2.com/file/shannonsvideos/Shannon.png" alt="Shannon Birch" class="story-shannon-photo">
        <div class="story-shannon-text">
            Designed by <strong>Shannon Birch</strong>
            <span>I designed this to help you become the fittest version of yourself</span>
        </div>
        <div class="story-shannon-tap" id="story-shannon-tap" style="display:none;">Tap to continue</div>
    </div>

    <!-- Arny 3D model -->
    <div class="story-model-container" id="story-model-container" style="opacity: 0; transition: opacity 0.6s ease;">
        <model-viewer
            id="story-arny-model"
            src="https://f005.backblazeb2.com/file/shannonsvideos/arny.glb"
            loading="eager"
            camera-controls
            disable-zoom
            disable-pan
            auto-rotate
            rotation-intensity="0.6"
            shadow-intensity="1"
            exposure="0.9"
            camera-orbit="10deg 80deg 18m"
            field-of-view="32deg"
            style="width: 100%; height: 100%; --poster-color: transparent;"
            interaction-prompt="none">
        </model-viewer>
    </div>

    <!-- Pre-loaded showcase character models (load in background, swap visibility for instant display) -->
    <div class="story-preload-models" id="story-preload-models">
        <model-viewer class="story-preload-viewer" id="story-preload-0"
            src="https://f005.backblazeb2.com/file/shannonsvideos/goku.glb"
            loading="eager" camera-controls disable-zoom disable-pan auto-rotate shadow-intensity="1" exposure="0.9"
            camera-orbit="180deg 75deg 20m" field-of-view="30deg"
            style="width:100%;height:100%;--poster-color:transparent;" interaction-prompt="none">
        </model-viewer>
        <model-viewer class="story-preload-viewer" id="story-preload-1"
            src="https://f005.backblazeb2.com/file/shannonsvideos/steve_irwin.glb"
            loading="eager" camera-controls disable-zoom disable-pan auto-rotate shadow-intensity="1" exposure="0.9"
            camera-orbit="180deg 75deg 20m" field-of-view="30deg"
            style="width:100%;height:100%;--poster-color:transparent;" interaction-prompt="none">
        </model-viewer>
        <model-viewer class="story-preload-viewer" id="story-preload-2"
            src="https://f005.backblazeb2.com/file/shannonsvideos/optimus.glb"
            loading="eager" camera-controls disable-zoom disable-pan auto-rotate shadow-intensity="1" exposure="0.9"
            camera-orbit="180deg 75deg 20m" field-of-view="30deg"
            style="width:100%;height:100%;--poster-color:transparent;" interaction-prompt="none">
        </model-viewer>
    </div>

    <!-- Character name label (shown during rare showcase) -->
    <div class="story-character-label" id="story-character-label">
        <span class="story-char-name"></span>
        <span class="story-char-tier"></span>
    </div>

    <!-- Speech bubble area -->
    <div class="story-speech-area" id="story-speech-area">
        <div class="story-bubble" id="story-bubble"></div>
        <div class="story-tap-prompt" id="story-tap-prompt" style="display:none;">Tap to continue</div>
    </div>
</div>

<div class="onboarding-overlay" id="onboarding-wizard" style="display:none; z-index:12000;">
    <div class="wizard-particles" id="wizard-particles"></div>
    <div class="onboarding-modal wizard-container" style="max-width: 450px; max-height: 90vh; padding: 0; overflow: hidden; display: flex; flex-direction: column;">

        <!-- HEADER -->
        <div class="wizard-header" style="padding: 25px 25px 0 25px; text-align: center; position:relative; flex-shrink: 0;">
            <div onclick="closeWizardManually()" style="position:absolute; top:15px; right:15px; width:30px; height:30px; line-height:30px; background:#f1f5f9; border-radius:50%; cursor:pointer; font-size:1.2rem; color:#64748b; font-weight:bold;">&times;</div>
            <div class="wizard-progress" style="display:flex; justify-content:center; gap:6px; margin-bottom:15px;">
                <div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <h2 id="wizard-title" style="margin:0; color:var(--primary);">Let's Align Your Body</h2>
        </div>

        <!-- CONTENT SLIDES -->
        <div class="wizard-content" style="flex: 1; padding: 25px; overflow-y: auto; min-height: 0;">

            <!-- SLIDE 1: GENDER SELECTION -->
            <div class="wizard-slide slide-active" id="slide-1">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🌟</div>
                <h3 style="text-align:center; margin-bottom:10px;">Welcome to Your Journey</h3>
                <p style="text-align:center; color:#666; margin-bottom:30px;">Select your program to get started:</p>

                <div style="display:flex; flex-direction:column; gap:15px; max-width:300px; margin:0 auto;">
                    <button type="button" id="gender-btn-female" onclick="selectGender('female')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">🌸</span>
                        <span>For Her</span>
                    </button>

                    <button type="button" id="gender-btn-male" onclick="selectGender('male')" class="gender-select-btn" style="
                        display:flex; align-items:center; justify-content:center; gap:15px;
                        padding:20px 30px; border-radius:16px; border:2px solid #e2e8f0;
                        background:white; cursor:pointer; transition:all 0.3s ease;
                        font-size:1.1rem; font-weight:600; color:#334155;
                    ">
                        <span style="font-size:2rem;">💪</span>
                        <span>For Him</span>
                    </button>
                </div>

                <input type="hidden" id="wizard-gender" value="">
            </div>

            <!-- SLIDE 2: ESSENTIAL DATA COLLECTION -->
            <div class="wizard-slide" id="slide-2" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">📋</div>
                <h3 style="text-align:center; margin-bottom:10px;">Let's Get Started</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">We need a few details to personalize your program.</p>

                <!-- Name -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">What's your name?</label>
                    <input type="text" id="wizard-name" class="wizard-input" placeholder="Enter your name" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Age -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Age</label>
                    <input type="number" id="wizard-age" class="wizard-input" placeholder="25" min="18" max="100" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Height & Weight -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Height (cm)</label>
                        <input type="number" id="wizard-height" class="wizard-input" placeholder="170" min="100" max="250" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                    <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Weight (kg)</label>
                        <input type="number" id="wizard-weight" class="wizard-input" placeholder="70" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                    </div>
                </div>

                <!-- Goal Weight -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Goal Weight (kg)</label>
                    <input type="number" id="wizard-goal-weight" class="wizard-input" placeholder="65" min="30" max="300" step="0.1" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <!-- Primary Goal -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">What's your primary goal?</label>
                    <select id="wizard-goal-type" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select your goal</option>
                        <option value="Flat">Lose weight / Get lean</option>
                        <option value="Athletic">Get toned / Maintain fitness</option>
                        <option value="Body Builder">Build muscle / Gain strength</option>
                    </select>
                </div>

                <!-- Equipment Access -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Where do you train?</label>
                    <select id="wizard-equipment" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="gym">Full Gym Access</option>
                        <option value="dumbbells">Dumbbells (or Dumbbells + Bands)</option>
                        <option value="bands">Resistance Bands Only</option>
                        <option value="none">Just a Mat (No Equipment)</option>
                        <option value="yoga_only">Yoga / Stretching Only</option>
                    </select>
                </div>

                <!-- Activity Level -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Activity Level</label>
                    <select id="wizard-activity-level" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="sedentary">Sedentary (Little or no exercise)</option>
                        <option value="light">Lightly Active (Exercise 1-3 days/week)</option>
                        <option value="moderate">Moderately Active (Exercise 3-5 days/week)</option>
                        <option value="very">Very Active (Exercise 6-7 days/week)</option>
                    </select>
                </div>

                <!-- Energy Level -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Energy Status</label>
                    <select id="wizard-energy-level" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select</option>
                        <option value="low">Low Energy (Often tired)</option>
                        <option value="normal">Normal Energy</option>
                        <option value="high">High Energy</option>
                    </select>
                </div>

                <!-- Dietary Preference -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-top:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Dietary Preference</label>
                    <select id="wizard-dietary-preference" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                        <option value="">Select your diet</option>
                        <option value="omnivore">Omnivore (I eat everything)</option>
                        <option value="pescatarian">Pescatarian (Fish, no meat)</option>
                        <option value="vegetarian">Vegetarian (No meat or fish)</option>
                        <option value="vegan">Vegan (100% plant-based)</option>
                        <option value="flexitarian">Flexitarian (Mostly plant-based)</option>
                    </select>
                </div>
            </div>

            <!-- SLIDE 3: CYCLE SETUP (females only) -->
            <div class="wizard-slide" id="slide-3" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🌸</div>
                <h3 style="text-align:center; margin-bottom:10px;">Cycle Syncing</h3>
                <p style="text-align:center; color:#666; margin-bottom:25px;">We tailor your daily movement to match your hormonal phase.</p>

                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">When was your last period?</label>
                    <input type="date" id="wizard-period-date" class="wizard-input" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;">
                </div>

                <div class="wizard-option" style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:20px;">
                    <input type="checkbox" id="wizard-wellness-toggle" onchange="toggleWizardPeriodInput()">
                    <label for="wizard-wellness-toggle" style="font-size:0.9rem; color:#64748b;">I don't have a period (Wellness Mode)</label>
                </div>

                <!-- NEW QUESTION 1: Cycle Sync Preference -->
                <div class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:12px; font-size:0.9rem;">Do you want to sync your workouts with your cycle?</label>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:white; transition: all 0.2s ease;">
                            <input type="radio" name="wizard-cycle-sync" value="yes" onchange="togglePeriodEnergyQuestion()" style="margin:0;">
                            <span style="font-size:0.9rem;">Yes, sync my workouts</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:white; transition: all 0.2s ease;">
                            <input type="radio" name="wizard-cycle-sync" value="no" onchange="togglePeriodEnergyQuestion()" style="margin:0;">
                            <span style="font-size:0.9rem;">No, standard recommendations</span>
                        </label>
                    </div>
                </div>

                <!-- NEW QUESTION 2: Period Energy Response (Conditional) -->
                <div id="period-energy-section" class="wizard-input-group" style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; display:none;">
                    <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">How does your body respond during your period?</label>
                    <p style="font-size:0.8rem; color:#64748b; margin-bottom:12px;">We'll automatically adjust your workouts during menstruation (days 1-5).</p>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:white; transition: all 0.2s ease;">
                            <input type="radio" name="wizard-period-energy" value="high" style="margin:0;">
                            <span style="font-size:0.9rem;">High Energy - I can push hard</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:white; transition: all 0.2s ease;">
                            <input type="radio" name="wizard-period-energy" value="low" style="margin:0;">
                            <span style="font-size:0.9rem;">Low Energy/Tired - I need gentler workouts</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- SLIDE 4: WORKOUT FREQUENCY & DAYS -->
            <div class="wizard-slide" id="slide-4" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">🏋️</div>
                <h3 style="text-align:center; margin-bottom:10px;">Design Your Training Week</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">How many days per week do you want to train?</p>

                <!-- Frequency Selector -->
                <div style="display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-bottom:20px;">
                    <button type="button" onclick="selectTrainingFrequency(2)" class="freq-btn" data-freq="2" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">2</button>
                    <button type="button" onclick="selectTrainingFrequency(3)" class="freq-btn" data-freq="3" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">3</button>
                    <button type="button" onclick="selectTrainingFrequency(4)" class="freq-btn" data-freq="4" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">4</button>
                    <button type="button" onclick="selectTrainingFrequency(5)" class="freq-btn" data-freq="5" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">5</button>
                    <button type="button" onclick="selectTrainingFrequency(6)" class="freq-btn" data-freq="6" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">6</button>
                    <button type="button" onclick="selectTrainingFrequency(7)" class="freq-btn" data-freq="7" style="width:45px; height:45px; border-radius:50%; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:18px; font-weight:700; cursor:pointer;">7</button>
                </div>
                <p id="freq-tip" style="text-align:center; color:#48864B; font-size:13px; min-height:35px; padding:8px; background:rgba(72,134,75,0.1); border-radius:8px; margin-bottom:20px;">Select how many days you want to train</p>

                <!-- Day Selector -->
                <p style="text-align:center; color:#666; margin-bottom:10px; font-weight:600;">Which days work for you?</p>
                <div style="display:flex; justify-content:center; gap:6px; flex-wrap:wrap; margin-bottom:15px;">
                    <button type="button" onclick="toggleTrainingDay('monday')" class="day-btn" data-day="monday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Mon</button>
                    <button type="button" onclick="toggleTrainingDay('tuesday')" class="day-btn" data-day="tuesday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Tue</button>
                    <button type="button" onclick="toggleTrainingDay('wednesday')" class="day-btn" data-day="wednesday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Wed</button>
                    <button type="button" onclick="toggleTrainingDay('thursday')" class="day-btn" data-day="thursday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Thu</button>
                    <button type="button" onclick="toggleTrainingDay('friday')" class="day-btn" data-day="friday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Fri</button>
                    <button type="button" onclick="toggleTrainingDay('saturday')" class="day-btn" data-day="saturday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Sat</button>
                    <button type="button" onclick="toggleTrainingDay('sunday')" class="day-btn" data-day="sunday" style="width:42px; height:42px; border-radius:8px; border:2px solid #48864B; background:#fff; color:#1a4d2e; font-size:11px; font-weight:700; cursor:pointer;">Sun</button>
                </div>
                <p id="days-counter" style="text-align:center; color:#64748b; font-size:12px;">Select your training days</p>

                <!-- Recovery Toggle -->
                <div style="margin-top:20px; background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="checkbox" id="wizard-recovery-days" checked style="width:18px; height:18px;">
                        <span style="font-size:0.9rem;">Add yoga & recovery on rest days</span>
                    </label>
                </div>

                <input type="hidden" id="wizard-training-frequency" value="">
                <input type="hidden" id="wizard-training-days" value="">
            </div>

            <!-- SLIDE 5: SPLIT PREFERENCE (gym users only) -->
            <div class="wizard-slide" id="slide-5" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">💪</div>
                <h3 style="text-align:center; margin-bottom:10px;">Choose Your Training Split</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">How do you want to structure your workouts?</p>

                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button type="button" onclick="selectSplitPreference('full_body')" class="split-btn" data-split="full_body" style="text-align:left; padding:15px; border-radius:12px; border:2px solid #e2e8f0; background:#fff; cursor:pointer;">
                        <div style="font-weight:700; color:#1a4d2e;">Full Body</div>
                        <div style="font-size:12px; color:#666;">Train all muscle groups each session</div>
                        <div style="font-size:11px; color:#48864B; margin-top:4px;">Best for: 2-3 days/week</div>
                    </button>
                    <button type="button" onclick="selectSplitPreference('ppl')" class="split-btn" data-split="ppl" style="text-align:left; padding:15px; border-radius:12px; border:2px solid #e2e8f0; background:#fff; cursor:pointer;">
                        <div style="font-weight:700; color:#1a4d2e;">Push / Pull / Legs</div>
                        <div style="font-size:12px; color:#666;">Split by movement patterns</div>
                        <div style="font-size:11px; color:#48864B; margin-top:4px;">Best for: 3-6 days/week</div>
                    </button>
                    <button type="button" onclick="selectSplitPreference('upper_lower')" class="split-btn" data-split="upper_lower" style="text-align:left; padding:15px; border-radius:12px; border:2px solid #e2e8f0; background:#fff; cursor:pointer;">
                        <div style="font-weight:700; color:#1a4d2e;">Upper / Lower</div>
                        <div style="font-size:12px; color:#666;">Alternate upper and lower body</div>
                        <div style="font-size:11px; color:#48864B; margin-top:4px;">Best for: 4 days/week</div>
                    </button>
                    <button type="button" onclick="selectSplitPreference('bro_split')" class="split-btn" data-split="bro_split" style="text-align:left; padding:15px; border-radius:12px; border:2px solid #e2e8f0; background:#fff; cursor:pointer;">
                        <div style="font-weight:700; color:#1a4d2e;">Bro Split</div>
                        <div style="font-size:12px; color:#666;">One muscle group per day</div>
                        <div style="font-size:11px; color:#48864B; margin-top:4px;">Best for: 5-6 days/week</div>
                    </button>
                </div>

                <input type="hidden" id="wizard-split-preference" value="">
            </div>

            <!-- SLIDE 6: CALENDAR PREVIEW -->
            <div class="wizard-slide" id="slide-6" style="display:none;">
                <div style="text-align:center; margin-bottom:20px; font-size:3rem;">📅</div>
                <h3 style="text-align:center; margin-bottom:10px;">Your Workout Week</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Here's your personalized schedule</p>

                <div id="wizard-calendar-preview" style="background:#fff; border-radius:12px; padding:15px; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                    <!-- Dynamically populated -->
                </div>

                <div style="background:rgba(72,134,75,0.1); border-radius:10px; padding:12px; margin-top:15px; text-align:center;">
                    <p style="margin:0; font-size:13px; color:#1a4d2e;">
                        <strong>📈 48-Week Program:</strong> Each workout evolves over time - you'll never do the same workout twice in a row!
                    </p>
                </div>
            </div>

            <!-- SLIDE 7: MEET YOUR FITGOTCHI -->
            <div class="wizard-slide" id="slide-7" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🐣</div>
                <h3 style="text-align:center; margin-bottom:10px;">Meet Your FitGotchi</h3>
                <p style="text-align:center; color:#666; margin-bottom:15px;">Your personal fitness companion that grows with you!</p>

                <!-- FitGotchi 3D Preview -->
                <div style="width: 100%; height: 320px; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); border-radius: 12px; overflow: hidden; margin-bottom: 15px; position: relative;">
                    <model-viewer
                        id="wizard-fitgotchi-preview"
                        data-lazy-src="https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb"
                        loading="lazy"
                        camera-controls
                        disable-zoom
                        disable-pan
                        auto-rotate
                        rotation-intensity="0.5"
                        shadow-intensity="1"
                        exposure="0.9"
                        camera-orbit="0deg 85deg 20m"
                        field-of-view="30deg"
                        style="width: 100%; height: 100%; --poster-color: transparent;"
                        interaction-prompt="none">
                    </model-viewer>
                </div>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:12px; border:1px solid #bbf7d0; border-radius:10px;">
                        <span style="font-size:1.3rem;">💪</span>
                        <div><strong>Levels up with you</strong><br><span style="font-size:0.8rem; color:#166534;">Earn XP and watch your character evolve through 99 levels</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #fef3c7, #fde68a); padding:12px; border:1px solid #fcd34d; border-radius:10px;">
                        <span style="font-size:1.3rem;">🎨</span>
                        <div><strong>Customize everything</strong><br><span style="font-size:0.8rem; color:#92400e;">Hair, outfit & skin tone - make it yours</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #e0e7ff, #c7d2fe); padding:12px; border:1px solid #a5b4fc; border-radius:10px;">
                        <span style="font-size:1.3rem;">✨</span>
                        <div><strong>Unlock rare skins</strong><br><span style="font-size:0.8rem; color:#4338ca;">Win legendary characters like Arny in challenges</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 8: EASY CALORIE TRACKING -->
            <div class="wizard-slide" id="slide-8" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">📸</div>
                <h3 style="text-align:center; margin-bottom:10px;">Easy Calorie Tracking</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">The easiest way to track your nutrition</p>

                <!-- Hero Feature -->
                <div style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:20px; border-radius:16px; border:1px solid #bbf7d0; text-align:center; margin-bottom:15px;">
                    <div style="font-size:3rem; margin-bottom:10px;">🤳</div>
                    <p style="margin:0; font-size:1rem; font-weight:700; color:#166534;">Snap a photo. AI does the rest.</p>
                    <p style="margin:5px 0 0; font-size:0.85rem; color:#166534;">Our AI recognizes your food and logs calories, protein, carbs & fat instantly.</p>
                </div>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:10px 12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📊</span>
                        <div><strong>Track macros</strong><br><span style="font-size:0.8rem; color:#666;">Personalized calorie & macro targets based on your goals</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:10px 12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🥗</span>
                        <div><strong>Meal plans & recipes</strong><br><span style="font-size:0.8rem; color:#666;">Browse meals, smoothies & snacks tailored to your diet</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 9: YOUR HYDRATION GOAL -->
            <div class="wizard-slide" id="slide-9" style="display:none;">
                <div style="text-align:center; margin-bottom:10px; font-size:3rem;">💧</div>
                <h3 style="text-align:center; margin-bottom:6px;">Your Hydration Goal</h3>
                <p style="text-align:center; color:#666; margin-bottom:18px; font-size:0.88rem;">We calculated your ideal daily water intake based on your body weight and activity level.</p>

                <!-- Recommended Goal Display -->
                <div style="background:linear-gradient(135deg, #e0f2fe, #bae6fd); padding:18px; border-radius:16px; border:1px solid #7dd3fc; text-align:center; margin-bottom:18px;">
                    <p style="margin:0 0 4px; font-size:0.8rem; color:#0369a1; font-weight:600;">Your Recommended Daily Intake</p>
                    <div id="wizard-water-recommended" style="font-size:1.6rem; font-weight:800; color:#0c4a6e;">2,100 ml</div>
                    <p id="wizard-water-formula-note" style="margin:4px 0 0; font-size:0.72rem; color:#0369a1;">Based on your weight &times; 33ml/kg + activity adjustment</p>
                </div>

                <!-- Adjustable Goal -->
                <div style="background:#f8fafc; padding:16px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:14px;">
                    <label style="display:block; font-weight:600; margin-bottom:10px; font-size:0.88rem; text-align:center;">Set Your Daily Goal</label>
                    <div style="display:flex; align-items:center; justify-content:center; gap:14px;">
                        <button type="button" onclick="adjustWaterGoal(-250)" style="width:40px; height:40px; border-radius:50%; border:2px solid #0284c7; background:white; color:#0284c7; font-size:1.3rem; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1;">−</button>
                        <div style="text-align:center; min-width:100px;">
                            <div id="wizard-water-goal" style="font-size:1.8rem; font-weight:800; color:#0c4a6e;">2,100</div>
                            <div style="font-size:0.75rem; color:#64748b; font-weight:600;">ml / day</div>
                        </div>
                        <button type="button" onclick="adjustWaterGoal(250)" style="width:40px; height:40px; border-radius:50%; border:2px solid #0284c7; background:white; color:#0284c7; font-size:1.3rem; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1;">+</button>
                    </div>
                    <input type="hidden" id="wizard-water-goal-ml" value="2100">
                </div>

                <!-- Glass Size Selection -->
                <div style="background:#f8fafc; padding:16px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:14px;">
                    <label style="display:block; font-weight:600; margin-bottom:10px; font-size:0.88rem; text-align:center;">What size is your cup/bottle?</label>
                    <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                        <button type="button" onclick="selectGlassSize(200)" class="glass-size-btn" data-size="200" style="padding:8px 14px; border-radius:10px; border:2px solid #e2e8f0; background:white; font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; color:#334155;">200ml</button>
                        <button type="button" onclick="selectGlassSize(250)" class="glass-size-btn active" data-size="250" style="padding:8px 14px; border-radius:10px; border:2px solid #0284c7; background:#e0f2fe; font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; color:#0c4a6e;">250ml</button>
                        <button type="button" onclick="selectGlassSize(350)" class="glass-size-btn" data-size="350" style="padding:8px 14px; border-radius:10px; border:2px solid #e2e8f0; background:white; font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; color:#334155;">350ml</button>
                        <button type="button" onclick="selectGlassSize(500)" class="glass-size-btn" data-size="500" style="padding:8px 14px; border-radius:10px; border:2px solid #e2e8f0; background:white; font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; color:#334155;">500ml</button>
                    </div>
                    <input type="hidden" id="wizard-glass-size" value="250">
                </div>

                <!-- Glass Count Preview -->
                <div style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:14px; border-radius:12px; border:1px solid #bbf7d0; text-align:center;">
                    <p style="margin:0; font-size:0.88rem; color:#166534; font-weight:600;">
                        That's <span id="wizard-glass-count" style="font-size:1.1rem; font-weight:800;">8</span> cups per day
                    </p>
                    <p style="margin:4px 0 0; font-size:0.75rem; color:#166534;">Tap the hydration circle in the Nutrition tab to log each cup</p>
                </div>
            </div>

            <!-- SLIDE 10: TRACK YOUR WORKOUTS -->
            <div class="wizard-slide" id="slide-10" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🏋️</div>
                <h3 style="text-align:center; margin-bottom:10px;">Track Your Workouts</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Every rep counts. We track it all.</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📝</span>
                        <div><strong>Log sets, reps & weight</strong><br><span style="font-size:0.8rem; color:#666;">Quick input during your workout with rest timers</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📈</span>
                        <div><strong>Volume & progress charts</strong><br><span style="font-size:0.8rem; color:#666;">See your total volume climb week over week</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🏅</span>
                        <div><strong>Personal bests</strong><br><span style="font-size:0.8rem; color:#666;">We automatically detect and celebrate your PBs</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📋</span>
                        <div><strong>Workout history</strong><br><span style="font-size:0.8rem; color:#666;">Full log of every session with max weights tracked</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 11: BUILD & BROWSE WORKOUTS -->
            <div class="wizard-slide" id="slide-11" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🔨</div>
                <h3 style="text-align:center; margin-bottom:10px;">Build & Browse Workouts</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Your gym, your rules.</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:12px; border:1px solid #bbf7d0; border-radius:10px;">
                        <span style="font-size:1.3rem;">🏗️</span>
                        <div><strong>Workout Builder</strong><br><span style="font-size:0.8rem; color:#166534;">Create custom workouts with any exercises you want</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #e0e7ff, #c7d2fe); padding:12px; border:1px solid #a5b4fc; border-radius:10px;">
                        <span style="font-size:1.3rem;">📚</span>
                        <div><strong>Program Library</strong><br><span style="font-size:0.8rem; color:#4338ca;">Hundreds of prebuilt programs for every level & goal</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #fef3c7, #fde68a); padding:12px; border:1px solid #fcd34d; border-radius:10px;">
                        <span style="font-size:1.3rem;">🔄</span>
                        <div><strong>48-week progressive programs</strong><br><span style="font-size:0.8rem; color:#92400e;">Workouts evolve over time - never do the same one twice</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 12: LEARN & LEVEL UP -->
            <div class="wizard-slide" id="slide-12" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🧠</div>
                <h3 style="text-align:center; margin-bottom:10px;">Learn & Level Up</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Duolingo-style fitness education</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">📖</span>
                        <div><strong>Bite-sized lessons</strong><br><span style="font-size:0.8rem; color:#666;">Learn nutrition, training & recovery in fun modules</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🧩</span>
                        <div><strong>Interactive quizzes</strong><br><span style="font-size:0.8rem; color:#666;">Test your knowledge and earn XP for correct answers</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🏆</span>
                        <div><strong>Master modules</strong><br><span style="font-size:0.8rem; color:#666;">Complete all lessons to become a fitness expert</span></div>
                    </li>
                </ul>

                <div style="background:rgba(72,134,75,0.1); border-radius:10px; padding:10px; margin-top:12px; text-align:center;">
                    <p style="margin:0; font-size:0.8rem; color:#1a4d2e;"><strong>Tip:</strong> Quiz your friends in Quiz Battles and wager coins!</p>
                </div>
            </div>

            <!-- SLIDE 13: YOUR FEED -->
            <div class="wizard-slide" id="slide-13" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">📱</div>
                <h3 style="text-align:center; margin-bottom:10px;">Your Feed</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Share your wins and cheer on your friends</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:12px; border:1px solid #bbf7d0; border-radius:10px;">
                        <span style="font-size:1.3rem;">💪</span>
                        <div><strong>Share workouts to the feed</strong><br><span style="font-size:0.8rem; color:#166534;">Post your workout card with a gym selfie and earn <strong>2 XP</strong></span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">👀</span>
                        <div><strong>See what friends are up to</strong><br><span style="font-size:0.8rem; color:#666;">React to posts, leave comments, stay motivated together</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🔥</span>
                        <div><strong>Workout cards</strong><br><span style="font-size:0.8rem; color:#666;">Auto-generated cards showing your exercises, volume & PBs</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 14: CHALLENGE YOUR FRIENDS -->
            <div class="wizard-slide" id="slide-14" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">⚔️</div>
                <h3 style="text-align:center; margin-bottom:10px;">Challenge Your Friends</h3>
                <p style="text-align:center; color:#666; margin-bottom:15px;">Compete, battle & win rare rewards</p>

                <!-- Arny 3D Preview -->
                <div style="width: 100%; height: 240px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%); border-radius: 12px; overflow: hidden; margin-bottom: 12px; position: relative;">
                    <model-viewer
                        id="wizard-arny-preview"
                        data-lazy-src="https://f005.backblazeb2.com/file/shannonsvideos/arny.glb"
                        loading="lazy"
                        camera-controls
                        disable-zoom
                        disable-pan
                        auto-rotate
                        rotation-intensity="0.8"
                        shadow-intensity="1"
                        exposure="0.9"
                        camera-orbit="0deg 85deg 20m"
                        field-of-view="30deg"
                        style="width: 100%; height: 100%; --poster-color: transparent;"
                        interaction-prompt="none">
                    </model-viewer>
                    <div style="position:absolute; bottom:6px; left:10px; background:rgba(0,0,0,0.6); color:#fbbf24; padding:3px 10px; border-radius:8px; font-size:0.75rem; font-weight:700;">LEGENDARY: Arny</div>
                </div>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:8px;">
                    <li style="display:flex; align-items:center; gap:10px; background:white; padding:10px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.2rem;">🐲</span>
                        <div><strong>FitGotchi Battles</strong><br><span style="font-size:0.8rem; color:#666;">Battle friends' characters & wager coins</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:10px; background:white; padding:10px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.2rem;">⚡</span>
                        <div><strong>Quiz Battles</strong><br><span style="font-size:0.8rem; color:#666;">Live head-to-head fitness quizzes</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:10px; background:white; padding:10px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.2rem;">🎯</span>
                        <div><strong>30-Day Challenges</strong><br><span style="font-size:0.8rem; color:#666;">Compete on leaderboards & win rare skins</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:10px; background:white; padding:10px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.2rem;">✨</span>
                        <div><strong>Win rare characters</strong><br><span style="font-size:0.8rem; color:#666;">Arny, Goku, Optimus & more - 11 to collect!</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 15: COINS -->
            <div class="wizard-slide" id="slide-15" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🪙</div>
                <h3 style="text-align:center; margin-bottom:10px;">Coins</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Your in-app currency for battles, bets & rewards</p>

                <ul class="wizard-list" style="list-style:none; padding:0; display:flex; flex-direction:column; gap:10px;">
                    <li style="display:flex; align-items:center; gap:12px; background:linear-gradient(135deg, #fef3c7, #fde68a); padding:12px; border:1px solid #fcd34d; border-radius:10px;">
                        <span style="font-size:1.3rem;">💰</span>
                        <div><strong>Bet on battles</strong><br><span style="font-size:0.8rem; color:#92400e;">Wager coins on FitGotchi & Quiz Battles - winner takes all!</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🎯</span>
                        <div><strong>Enter challenges</strong><br><span style="font-size:0.8rem; color:#666;">Use coins to enter monthly challenges for rare rewards</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🛒</span>
                        <div><strong>Buy coin packs</strong><br><span style="font-size:0.8rem; color:#666;">Starter (500) to Ultimate (8,000) packs available</span></div>
                    </li>
                    <li style="display:flex; align-items:center; gap:12px; background:white; padding:12px; border:1px solid #eee; border-radius:10px;">
                        <span style="font-size:1.3rem;">🎭</span>
                        <div><strong>Unlock cosmetics</strong><br><span style="font-size:0.8rem; color:#666;">Spend coins on character customizations & backgrounds</span></div>
                    </li>
                </ul>
            </div>

            <!-- SLIDE 16: ALL WAYS TO EARN XP -->
            <div class="wizard-slide" id="slide-16" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">⭐</div>
                <h3 style="text-align:center; margin-bottom:10px;">All Ways to Earn XP</h3>
                <p style="text-align:center; color:#666; margin-bottom:15px;">Every point levels up your FitGotchi!</p>

                <div style="display:flex; flex-direction:column; gap:8px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:10px 14px; border-radius:10px; border:1px solid #bbf7d0;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">📸</span> <span style="font-size:0.85rem; font-weight:600; color:#166534;">Log a meal photo</span></span>
                        <span style="font-weight:700; color:#166534; font-size:0.9rem;">+1 XP</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:10px 14px; border-radius:10px; border:1px solid #bbf7d0;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">💪</span> <span style="font-size:0.85rem; font-weight:600; color:#166534;">Complete a workout</span></span>
                        <span style="font-weight:700; color:#166534; font-size:0.9rem;">+1 XP</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #e0e7ff, #c7d2fe); padding:10px 14px; border-radius:10px; border:1px solid #a5b4fc;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">📱</span> <span style="font-size:0.85rem; font-weight:600; color:#4338ca;">Share to feed</span></span>
                        <span style="font-weight:700; color:#4338ca; font-size:0.9rem;">+2 XP</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #e0e7ff, #c7d2fe); padding:10px 14px; border-radius:10px; border:1px solid #a5b4fc;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">👥</span> <span style="font-size:0.85rem; font-weight:600; color:#4338ca;">Share to group chat</span></span>
                        <span style="font-weight:700; color:#4338ca; font-size:0.9rem;">+1 XP</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #fef3c7, #fde68a); padding:10px 14px; border-radius:10px; border:1px solid #fcd34d;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">🔥</span> <span style="font-size:0.85rem; font-weight:600; color:#92400e;">Streak bonuses</span></span>
                        <span style="font-weight:700; color:#92400e; font-size:0.9rem;">+bonus</span>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #fce7f3, #fbcfe8); padding:10px 14px; border-radius:10px; border:1px solid #f9a8d4;">
                        <span style="display:flex; align-items:center; gap:8px;"><span style="font-size:1.1rem;">🤝</span> <span style="font-size:0.85rem; font-weight:600; color:#be185d;">Refer a friend</span></span>
                        <span style="font-weight:700; color:#be185d; font-size:0.9rem;">2x XP (7 days!)</span>
                    </div>
                </div>
            </div>

            <!-- SLIDE 17: DESIGN YOUR CHARACTER -->
            <div class="wizard-slide" id="slide-17" style="display:none;">
                <div style="text-align:center; margin-bottom:10px; font-size:3rem;">✨</div>
                <h3 style="text-align:center; margin-bottom:8px;">Design Your Character</h3>
                <p style="text-align:center; color:#666; margin-bottom:15px;">Make your FitGotchi your own!</p>

                <!-- Character Preview -->
                <div id="wizard-character-preview" style="width: 100%; height: 360px; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); border-radius: 12px; overflow: hidden; margin-bottom: 15px; position: relative;">
                    <model-viewer
                        id="wizard-preview-model"
                        data-lazy-src="https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb"
                        loading="lazy"
                        camera-controls
                        disable-zoom
                        disable-pan
                        auto-rotate
                        rotation-intensity="0.5"
                        shadow-intensity="1"
                        exposure="0.9"
                        camera-orbit="0deg 85deg 20m"
                        field-of-view="30deg"
                        style="width: 100%; height: 100%; --poster-color: transparent;"
                        interaction-prompt="none">
                    </model-viewer>
                </div>

                <!-- Color Options (hair, pants, skin ONLY) -->
                <div id="wizard-color-options" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
                    <!-- Hair Color -->
                    <div class="color-option-group" style="margin-bottom: 15px;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Hair Color</label>
                        <div id="wizard-hair-colors" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                    </div>

                    <!-- Shorts/Pants Color -->
                    <div class="color-option-group" style="margin-bottom: 15px;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Shorts Color</label>
                        <div id="wizard-pants-colors" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                    </div>

                    <!-- Skin Tone -->
                    <div class="color-option-group" style="margin-bottom: 10px;">
                        <label style="display:block; font-weight:600; margin-bottom:8px; font-size:0.9rem;">Skin Tone</label>
                        <div id="wizard-skin-colors" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                    </div>
                </div>
            </div>

            <!-- SLIDE 17: SET YOUR PROFILE PICTURE -->
            <div class="wizard-slide" id="slide-18" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">📸</div>
                <h3 style="text-align:center; margin-bottom:10px;">Set Your Profile Picture</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">This is how your friends will see you in the feed & battles</p>

                <!-- Profile Photo Preview -->
                <div style="display:flex; flex-direction:column; align-items:center; gap:20px; margin-bottom:20px;">
                    <div id="wizard-profile-photo-container" style="width:150px; height:150px; border-radius:50%; background:linear-gradient(135deg, #e2e8f0, #cbd5e1); display:flex; align-items:center; justify-content:center; overflow:hidden; border:4px solid var(--primary); box-shadow:0 8px 24px rgba(4,106,56,0.2); cursor:pointer;" onclick="document.getElementById('wizard-profile-photo-input').click()">
                        <div id="wizard-profile-photo-placeholder" style="text-align:center;">
                            <div style="font-size:3rem; margin-bottom:4px;">👤</div>
                            <span style="font-size:0.75rem; color:#64748b; font-weight:600;">Tap to add</span>
                        </div>
                        <img id="wizard-profile-photo-img" style="width:100%; height:100%; object-fit:cover; display:none;" alt="Profile">
                    </div>
                    <input type="file" id="wizard-profile-photo-input" accept="image/*" style="display:none;" onchange="handleWizardProfilePhoto(this)">

                    <button type="button" onclick="document.getElementById('wizard-profile-photo-input').click()" style="padding:12px 28px; border-radius:25px; border:2px solid var(--primary); background:white; color:var(--primary); font-weight:700; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; gap:8px;">
                        <span>📷</span> Choose Photo
                    </button>
                </div>

                <p style="text-align:center; color:#94a3b8; font-size:0.8rem;">You can skip this and add one later from your profile</p>
            </div>

            <!-- SLIDE 19: INVITE YOUR FRIENDS -->
            <div class="wizard-slide" id="slide-19" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">🤝</div>
                <h3 style="text-align:center; margin-bottom:10px;">Invite Your Friends</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">Everything's better with friends! You BOTH get <strong style="color:var(--primary);">1 week double XP</strong></p>

                <!-- Referral Code Display -->
                <div style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:20px; border-radius:16px; border:1px solid #bbf7d0; text-align:center; margin-bottom:15px;">
                    <p style="margin:0 0 8px; font-size:0.85rem; color:#166534; font-weight:600;">Your Referral Code</p>
                    <div id="wizard-referral-code" style="font-size:1.8rem; font-weight:800; letter-spacing:4px; color:#1a4d2e; font-family:monospace; padding:8px; background:white; border-radius:10px; border:2px dashed #48864B;">
                        Loading...
                    </div>
                </div>

                <!-- Share Buttons -->
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button type="button" onclick="wizardShareWhatsApp()" style="flex:1; padding:12px; border-radius:12px; border:none; background:#25D366; color:white; font-weight:700; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                        <span>WhatsApp</span>
                    </button>
                    <button type="button" onclick="wizardShareSMS()" style="flex:1; padding:12px; border-radius:12px; border:none; background:#3b82f6; color:white; font-weight:700; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                        <span>SMS</span>
                    </button>
                    <button type="button" onclick="wizardCopyLink()" style="flex:1; padding:12px; border-radius:12px; border:none; background:#64748b; color:white; font-weight:700; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                        <span>Copy Link</span>
                    </button>
                </div>

                <p style="text-align:center; color:#64748b; font-size:0.8rem;">You can always share your code later from the Friends tab</p>
            </div>

            <!-- SLIDE 20: BUILT BY SHANNON -->
            <div class="wizard-slide" id="slide-20" style="display:none;">
                <div style="text-align:center; margin-bottom:15px; font-size:3rem;">💚</div>
                <h3 style="text-align:center; margin-bottom:10px;">Built by Shannon</h3>
                <p style="text-align:center; color:#666; margin-bottom:20px;">This app was designed and built by your coach, Shannon. If you have any suggestions, feedback, or ideas to make it even better — I'd love to hear from you!</p>

                <div style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:20px; border-radius:16px; border:1px solid #bbf7d0; margin-bottom:20px;">
                    <p style="margin:0 0 12px; font-weight:700; color:#166534; font-size:1rem;">How to message your coach:</p>
                    <div style="display:flex; align-items:flex-start; gap:12px; margin-bottom:12px;">
                        <div style="width:28px; height:28px; min-width:28px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:0.85rem;">1</div>
                        <p style="margin:0; color:#334155; font-size:0.9rem; line-height:1.5;">Tap the <strong>Friends</strong> tab at the bottom of your screen</p>
                    </div>
                    <div style="display:flex; align-items:flex-start; gap:12px; margin-bottom:12px;">
                        <div style="width:28px; height:28px; min-width:28px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:0.85rem;">2</div>
                        <p style="margin:0; color:#334155; font-size:0.9rem; line-height:1.5;">Tap <strong>Coach Shannon</strong> at the top of your friends list</p>
                    </div>
                    <div style="display:flex; align-items:flex-start; gap:12px;">
                        <div style="width:28px; height:28px; min-width:28px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:0.85rem;">3</div>
                        <p style="margin:0; color:#334155; font-size:0.9rem; line-height:1.5;">Send me a message — I'll get back to you with guidance!</p>
                    </div>
                </div>

                <p style="text-align:center; color:#64748b; font-size:0.85rem;">Your feedback helps make this app better for everyone. Don't be shy!</p>
            </div>

            <!-- SLIDE 21: MEET YOUR AI + YOU'RE ALL SET -->
            <div class="wizard-slide" id="slide-21" style="display:none; text-align:center;">
                <div style="font-size:3rem; margin-bottom:12px;">🤖✨</div>
                <h3 style="margin-bottom:6px;">Meet Your AI Coach</h3>
                <p style="color:#64748b; margin-bottom:16px; font-size:0.9rem;">Your FitGotchi has a built-in AI that can do <em>a lot</em>. Just ask it anything:</p>

                <div style="display:flex; flex-direction:column; gap:8px; text-align:left; margin-bottom:16px;">
                    <div style="display:flex; align-items:center; gap:10px; background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:10px 14px; border-radius:10px; border:1px solid #bbf7d0;">
                        <span style="font-size:1.1rem; flex-shrink:0;">🏋️</span>
                        <span style="font-size:0.82rem; color:#166534;"><strong>Build workouts</strong> — "Build me a push day" (1800+ exercises with video demos)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; background:linear-gradient(135deg, #eff6ff, #dbeafe); padding:10px 14px; border-radius:10px; border:1px solid #bfdbfe;">
                        <span style="font-size:1.1rem; flex-shrink:0;">🍽️</span>
                        <span style="font-size:0.82rem; color:#1e40af;"><strong>Meal plans</strong> — "Make me a meal plan" (full week, tailored to your macros)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; background:linear-gradient(135deg, #fef3c7, #fde68a); padding:10px 14px; border-radius:10px; border:1px solid #fcd34d;">
                        <span style="font-size:1.1rem; flex-shrink:0;">⚔️</span>
                        <span style="font-size:0.82rem; color:#92400e;"><strong>Challenges</strong> — "Race Jake to a 100kg bench" (leaderboards + coin bets)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; background:linear-gradient(135deg, #fce7f3, #fbcfe8); padding:10px 14px; border-radius:10px; border:1px solid #f9a8d4;">
                        <span style="font-size:1.1rem; flex-shrink:0;">⚡</span>
                        <span style="font-size:0.82rem; color:#be185d;"><strong>Quick log</strong> — "I weigh 80kg" / "Ran 5k" / "Had 8 waters" (instant, no forms)</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; background:linear-gradient(135deg, #f5f3ff, #ede9fe); padding:10px 14px; border-radius:10px; border:1px solid #c4b5fd;">
                        <span style="font-size:1.1rem; flex-shrink:0;">🔧</span>
                        <span style="font-size:0.82rem; color:#6d28d9;"><strong>Build anything</strong> — trackers, checklists, quizzes, personal challenges</span>
                    </div>
                </div>

                <div id="wizard-hormone-goal" style="background:var(--secondary); color:white; padding:12px 18px; border-radius:12px; display:inline-block; font-weight:600; margin-bottom:12px; font-size:0.9rem;">
                    You're all set! 🚀
                </div>

                <p style="color:#94a3b8; font-size:0.8rem; margin:0;">Tap the chat bubble anytime to talk to your AI coach</p>
            </div>

        </div>

        <!-- FOOTER -->
        <div class="wizard-footer" style="padding: 25px; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; flex-shrink: 0;">
            <button class="wizard-btn secondary" id="wizard-back" onclick="wizardPrev()" style="background:transparent; border:none; color:#64748b; font-weight:600; cursor:pointer; visibility:hidden;">Back</button>
            <button class="wizard-btn primary" id="wizard-next" onclick="wizardNext()" style="background:var(--primary); color:white; border:none; padding:12px 30px; border-radius:25px; font-weight:700; cursor:pointer; box-shadow:0 4px 10px rgba(4,106,56,0.2);">Next &rarr;</button>
        </div>
    </div>
</div>

<link rel="stylesheet" href="css/dashboard/dashboard-style-2.css">


<script>
// --- COACH CHAT - DIRECT MESSAGING ---
const COACH_EMAILS = ['shannon@plantbased-balance.org', 'shannonbirch@cocospersonaltraining.com'];
window._coachUserId = null;

// Look up coach user ID by email
async function getCoachUserId() {
    if (window._coachUserId) return window._coachUserId;

    for (const email of COACH_EMAILS) {
        try {
            const { data } = await window.supabaseClient
                .from('users')
                .select('id')
                .eq('email', email)
                .maybeSingle();

            if (data && data.id) {
                window._coachUserId = data.id;
                return window._coachUserId;
            }
        } catch (e) {
            console.warn('Could not look up coach by email:', email, e);
        }
    }

    // Fallback: get first admin user
    try {
        const { data } = await window.supabaseClient
            .from('admin_users')
            .select('user_id')
            .limit(1)
            .maybeSingle();

        if (data && data.user_id) {
            window._coachUserId = data.user_id;
            return window._coachUserId;
        }
    } catch (e) {
        console.warn('Could not look up admin user:', e);
    }

    return null;
}

// Send a push notification to a user when they receive a DM
async function sendDMNotification(recipientId, messageText) {
    try {
        const profile = await window.getUserProfile();
        const senderName = profile?.name || 'Someone';

        const resp = await fetch('/.netlify/functions/send-dm-notification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                recipientId: recipientId,
                senderName: senderName,
                messageText: messageText
            })
        });

        const result = await resp.json().catch(() => ({}));
        console.log('[PushNotif] send-dm-notification response:', resp.status, result);

        if (!resp.ok) {
            console.error('[PushNotif] Server error:', result.error || resp.statusText);
        } else if (result.sent === 0) {
            console.warn('[PushNotif] No push subscriptions found for recipient', recipientId);
        }
    } catch (error) {
        console.error('[PushNotif] Error sending DM notification:', error);
    }
}

window.submitCoachMessage = async function() {
    const input = document.getElementById('coach-chat-input');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;

    input.value = '';

    // Render user message immediately
    const container = document.getElementById('chat-messages-container');
    if (container) {
        const rowDiv = document.createElement('div');
        rowDiv.style.cssText = "display: flex; justify-content: flex-end; align-items: flex-end; margin-bottom: 20px; animation: fadeIn 0.3s ease;";
        rowDiv.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: flex-end; max-width: 80%;">
                <div style="background: var(--chat-bg-user); color: var(--chat-text-user); padding: 12px 18px; border-radius: 18px 18px 0 18px; font-size: 1rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;">${text}</div>
                <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-right: 5px;">You  Just now</span>
            </div>
            <img src="https://ui-avatars.com/api/?name=You&background=cbd5e1&color=fff" style="width: 36px; height: 36px; border-radius: 50%; margin-left: 10px; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        `;
        container.appendChild(rowDiv);
        scrollToBottomOfChat();
    }

    // Send as a direct message (nudge) to the coach
    const coachId = await getCoachUserId();
    if (!coachId) {
        console.error('Could not find coach user ID');
        return;
    }

    try {
        const { error } = await window.supabaseClient
            .from('nudges')
            .insert({
                sender_id: window.currentUser.id,
                receiver_id: coachId,
                message: text
            });

        if (error) throw error;

        // Push notification is sent automatically by the database trigger
        // on the nudges table (nudge_push_trigger.sql)
    } catch (error) {
        console.error('Error sending message to coach:', error);
    }
};
</script>


<script>
    // Onboarding is now fully handled by checkAndTriggerOnboarding() -> initOnboardingWizard()
    // which runs during the auth callback. No separate page-load trigger needed.

    // Run community feed initialization
    if(document.readyState === 'complete') {
        loadCommunityFeed();
    } else {
        window.addEventListener('load', () => {
            loadCommunityFeed();
        });
    }
</script>

<script>
// --- PWA INSTALL BANNER LOGIC ---
let deferredPrompt;
let installBannerDismissed = localStorage.getItem('pwa_banner_dismissed_v2') === 'true';

// Detect if running as installed PWA or inside an APK (TWA/WebView)
const isInstalledPWA = (function() {
    // Standard PWA detection
    if (window.matchMedia('(display-mode: standalone)').matches) return true;
    if (window.matchMedia('(display-mode: fullscreen)').matches) return true;
    if (window.navigator.standalone) return true; // iOS
    // TWA (Trusted Web Activity) detection
    if (document.referrer.includes('android-app://')) return true;
    // Android WebView detection (APK wrapper)
    if (/; wv\)/.test(navigator.userAgent || '')) return true;
    return false;
})();

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    console.log("Install Prompt Captured");
    // Update any buttons that were showing "waiting" state
    document.querySelectorAll('.pwa-install-btn').forEach(btn => {
        btn.disabled = false;
        if (btn.dataset.originalText) {
            btn.innerHTML = btn.dataset.originalText;
        }
    });
});

window.addEventListener('load', () => {
    if (isInstalledPWA) {
        // App is already installed — show "already installed" state everywhere
        const banner = document.getElementById('pwa-install-banner');
        if (banner) banner.style.display = 'none';

        const settingsDownload = document.getElementById('settings-download-app');
        if (settingsDownload) {
            const btn = settingsDownload.querySelector('button');
            if (btn) {
                btn.onclick = null;
                btn.style.background = '#6b7280';
                btn.style.cursor = 'default';
                btn.innerHTML = '&#10003; Installed';
            }
            const subtitle = settingsDownload.querySelector('div > div:last-child');
            if (subtitle) subtitle.textContent = 'Already installed on your phone';
        }

        const profileDownload = document.getElementById('profile-download-app-btn');
        if (profileDownload) {
            const btn = profileDownload.querySelector('button');
            if (btn) {
                btn.onclick = null;
                btn.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
                btn.style.cursor = 'default';
                btn.style.boxShadow = 'none';
                btn.onmouseover = null;
                btn.onmouseout = null;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> ALREADY INSTALLED';
            }
        }
    } else if (!installBannerDismissed) {
        showPwaBanner();
    }

    // Make Coach Bubble Draggable
    initDraggableBubble();
});

function showPwaBanner() {
    const banner = document.getElementById('pwa-install-banner');
    if(banner) {
        banner.style.display = 'flex';
        document.body.style.transition = 'padding-top 0.3s ease';
        document.body.style.paddingTop = banner.offsetHeight + 'px';
    }
}

window.installPWA = async function(clickedBtn) {
    // If already installed, just show the message
    if (isInstalledPWA) {
        if (clickedBtn) {
            clickedBtn.innerHTML = '&#10003; Already Installed';
            clickedBtn.disabled = true;
        }
        return;
    }

    if (deferredPrompt) {
        // Show installing feedback immediately
        if (clickedBtn) {
            clickedBtn.dataset.originalText = clickedBtn.innerHTML;
            clickedBtn.innerHTML = 'Installing...';
            clickedBtn.disabled = true;
        }

        try {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                // Successfully accepted install
                if (clickedBtn) {
                    clickedBtn.innerHTML = '&#10003; Installed!';
                }
                dismissInstall();
                // Update all other install buttons
                document.querySelectorAll('.pwa-install-btn').forEach(btn => {
                    btn.innerHTML = '&#10003; Installed!';
                    btn.disabled = true;
                });
            } else {
                // User dismissed — restore button
                if (clickedBtn) {
                    clickedBtn.innerHTML = clickedBtn.dataset.originalText || 'Install';
                    clickedBtn.disabled = false;
                }
            }
        } catch(err) {
            console.error('Install error:', err);
            if (clickedBtn) {
                clickedBtn.innerHTML = clickedBtn.dataset.originalText || 'Install';
                clickedBtn.disabled = false;
            }
        }
        deferredPrompt = null;
    } else {
        // No deferred prompt available
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
            // Show iOS-specific instructions
            if (clickedBtn) {
                clickedBtn.innerHTML = 'Use Share → Add to Home Screen';
                clickedBtn.style.fontSize = '0.7rem';
                setTimeout(() => {
                    clickedBtn.innerHTML = clickedBtn.dataset.originalText || 'Install';
                    clickedBtn.style.fontSize = '';
                }, 4000);
            }
        } else {
            // Android/Desktop — prompt may not have fired yet, or browser doesn't support it
            if (clickedBtn) {
                clickedBtn.dataset.originalText = clickedBtn.dataset.originalText || clickedBtn.innerHTML;
                clickedBtn.innerHTML = 'Installing...';
                clickedBtn.disabled = true;
                // Wait a moment for the prompt to potentially arrive
                setTimeout(() => {
                    if (deferredPrompt) {
                        // Prompt arrived, retry
                        window.installPWA(clickedBtn);
                    } else {
                        clickedBtn.innerHTML = 'Use browser menu → Install';
                        clickedBtn.style.fontSize = '0.7rem';
                        setTimeout(() => {
                            clickedBtn.innerHTML = clickedBtn.dataset.originalText || 'Install';
                            clickedBtn.style.fontSize = '';
                            clickedBtn.disabled = false;
                        }, 4000);
                    }
                }, 1500);
            }
        }
    }
};

window.dismissInstall = function() {
    const banner = document.getElementById('pwa-install-banner');
    if(banner) {
        banner.style.display = 'none';
        document.body.style.paddingTop = '0';
    }
    localStorage.setItem('pwa_banner_dismissed_v2', 'true');
};

function initDraggableBubble() {
    const bubble = document.getElementById('coach-floating-btn');
    if(!bubble) return;
    
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;
    const moveThreshold = 5; // Pixels to satisfy 'drag'

    const handleStart = (e) => {
        if(e.target.closest('.notification-badge')) return; // Don't drag if clicking badge
        isDragging = false; // Assume click first
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        startX = clientX;
        startY = clientY;
        
        const rect = bubble.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;

        // Remove transition during drag
        bubble.style.transition = 'none';
    };

    const handleMove = (e) => {
        e.preventDefault(); // Prevent scrolling
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        const dx = clientX - startX;
        const dy = clientY - startY;

        if (Math.abs(dx) > moveThreshold || Math.abs(dy) > moveThreshold) {
            isDragging = true;
        }

        if (isDragging) {
             bubble.style.right = 'auto';
             bubble.style.bottom = 'auto';
             bubble.style.left = (initialLeft + dx) + 'px';
             bubble.style.top = (initialTop + dy) + 'px';
        }
    };

    const handleEnd = (e) => {
        bubble.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        // Snap to nearest edge logic could go here, but free floating is fine for now
    };

    bubble.addEventListener('mousedown', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', handleEnd);
    
    bubble.addEventListener('touchstart', handleStart, {passive: false});
    window.addEventListener('touchmove', handleMove, {passive: false});
    window.addEventListener('touchend', handleEnd);
}


window.installPWA = async function() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            dismissInstall();
        }
        deferredPrompt = null;
    } else {
        // User requested "No instructions, just download".
        // If we are here, the browser hasn't fired the event yet or doesn't support it (iOS).
        // specific check for iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
             alert("On iOS, please tap 'Share' then 'Add to Home Screen' manually."); 
        } else {
             console.log("Install prompt not ready yet.");
             // Try to force it? No API for that.
             alert("App installation is getting ready. Please try again in a moment.");
        }
    }
};

window.dismissInstall = function() {
    const banner = document.getElementById('pwa-install-banner');
    if(banner) {
        banner.style.display = 'none';
        document.body.style.paddingTop = '0';
    }
    localStorage.setItem('pwa_banner_dismissed_v2', 'true');
};
</script>

<script src="js/dashboard/dashboard-script-6-ai_coach_draft_mode_logic_auth.js"></script>


<!-- VIDEO MODAL (Ensured Existence) -->
<!-- VIDEO MODAL (Improved) -->
<div id="video-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10010; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <!-- Close Button (Top Right) -->
    <div onclick="closeVideoModal()" style="position: absolute; top: 25px; right: 25px; width: 45px; height: 45px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; z-index: 10011;">
        <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: white;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </div>

    <div style="width:100%; max-width:900px; position:relative; padding: 20px;">
        <div style="background:black; width:100%; aspect-ratio:16/9; border-radius:24px; overflow:hidden; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); position:relative;">

            <!-- Native Video (Backblaze B2) -->
            <video id="video-direct" style="width:100%; height:100%; display:none; object-fit:cover;" controls playsinline crossorigin="anonymous"></video>

            <!-- Poster Overlay -->
            <div id="video-poster" onclick="playVideo()" style="position:absolute; inset:0; background-size:cover; background-position:center; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:10; background-color: #0f172a;">
                 <div style="width:70px; height:70px; background:rgba(0,0,0,0.6); border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid rgba(255,255,255,0.8); backdrop-filter:blur(4px); transition: transform 0.2s;">
                      <svg viewBox="0 0 24 24" style="width:34px; height:34px; fill:white; margin-left:4px;"><path d="M8 5v14l11-7z"/></svg>
                 </div>
            </div>

        </div>
        
        <div style="margin-top:25px; text-align:center;">
             <h3 id="video-modal-title" style="color:white; margin:0; font-size:1.1rem; font-weight:600; opacity:0.9; letter-spacing: 0.5px;">Exercise Video</h3>
        </div>
    </div>
</div>

<!-- DBZ Character Decorations (Male Only) -->
<div id="dbz-decorations" style="display:none;">
    <img src="assets/goku-ssj.webp" alt="Goku Super Saiyan" class="dbz-character-corner" id="dbz-goku" />
    <img src="assets/vegeta-ssj.webp" alt="Vegeta Super Saiyan" class="dbz-character-corner" id="dbz-vegeta" style="display:none;" />
    <img src="assets/dbz-lightning.svg" alt="Lightning" class="dbz-lightning-left" />
    <img src="assets/dbz-lightning.svg" alt="Lightning" class="dbz-lightning-right" />
</div>

<!-- Flower Garden Decorations (Female users only) -->
<div id="flower-decorations" style="display:none;">
    <img src="assets/flower-cherry-blossom.svg" alt="Cherry Blossom" class="flower-corner flower-top-right" />
    <img src="assets/flower-rose.svg" alt="Rose" class="flower-corner flower-bottom-left" />
    <img src="assets/flower-peony.svg" alt="Peony" class="flower-corner flower-top-left" />
    <img src="assets/flower-daisy.svg" alt="Daisy" class="flower-corner flower-bottom-right" />
</div>

<!-- Sailor Moon Character Decorations (Female Only) -->
<div id="sailor-decorations" style="display:none;">
    <img src="assets/sailor-moon-character.svg" alt="Sailor Moon" class="sailor-character-corner" id="sailor-moon-character" />
    <img src="assets/sailor-venus-character.svg" alt="Sailor Venus" class="sailor-character-corner" id="sailor-venus-character" style="display:none;" />
    <img src="assets/sailor-star.svg" alt="Star" class="sailor-star-left" />
    <img src="assets/sailor-star.svg" alt="Star" class="sailor-star-right" />
    <img src="assets/sailor-heart.svg" alt="Heart" class="sailor-heart-float" />
</div>

<!-- PWA INSTALL BANNER (Fixed Floating) -->
<!-- PWA INSTALL BANNER (Moved to TOP) -->
<div id="pwa-install-banner" style="display:none; position:fixed; top:0; left:0; width:100%; background:#046A38 !important; color:white; font-size:0.9rem; padding:12px 20px; z-index:99999; box-shadow:0 4px 15px rgba(0,0,0,0.2); align-items:center; justify-content:space-between;">
    <div style="display:flex; align-items:center; gap:12px;">
        <span style="font-size:1.2rem;">📲</span>
        <span style="font-weight:600;">Install App for Best Experience</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="dismissInstall()" style="background:transparent; border:1px solid rgba(255,255,255,0.4); color:white; padding:6px 12px; border-radius:20px; font-size:70%; font-weight:600; cursor:pointer;">LATER</button>
        <button class="pwa-install-btn" onclick="installPWA(this)" data-original-text="INSTALL" style="background:white; color:var(--primary); border:none; padding:6px 16px; border-radius:20px; font-size:0.8rem; font-weight:700; box-shadow:0 2px 10px rgba(0,0,0,0.1); cursor:pointer; min-width:80px;">INSTALL</button>
    </div>
</div>

<script src="exercise_videos.js"></script>
<script src="workout_library.js"></script>
<script src="workout_library_extended.js"></script>
<script>
// Merge extended library into main library
if (typeof WORKOUT_LIBRARY !== 'undefined' && typeof WORKOUT_LIBRARY_EXTENDED !== 'undefined') {
    // Merge yoga, bodyweight, and home libraries
    WORKOUT_LIBRARY.yoga = WORKOUT_LIBRARY_EXTENDED.yoga;
    WORKOUT_LIBRARY.bodyweight = WORKOUT_LIBRARY_EXTENDED.bodyweight;
    WORKOUT_LIBRARY.home = WORKOUT_LIBRARY_EXTENDED.home;
}
</script>
<script src="js/dashboard/dashboard-script-7-video_logic.js"></script>


<script>
// --- COACH CHAT ENHANCEMENTS ---

// 1. Office Hours Config (Brisbane Time)
const COACH_CONFIG = {
    timezone: 'Australia/Brisbane',
    startHour: 7,    // 7 AM
    endHour: 20,     // 8 PM
    endMin: 30       // :30
};

function getCoachState() {
    try {
        const now = new Date();
        const bneTimeStr = now.toLocaleString("en-US", {timeZone: COACH_CONFIG.timezone});
        const bneTime = new Date(bneTimeStr);
        
        const totalMins = bneTime.getHours() * 60 + bneTime.getMinutes();
        const startMins = COACH_CONFIG.startHour * 60;
        const endMins = COACH_CONFIG.endHour * 60 + COACH_CONFIG.endMin;
        
        const isOnline = totalMins >= startMins && totalMins < endMins;
        return { isOnline, totalMins };
    } catch(e) {
        return { isOnline: true }; // Fail-safe
    }
}

function updateCoachUI() {
    const { isOnline } = getCoachState();
    const headerStatus = document.getElementById('coach-header-status-text');

    const color = isOnline ? '#22c55e' : '#94a3b8'; // Green vs Slate
    const text = isOnline ? 'Active Now' : 'Offline (Back 7am)';

    if(headerStatus) {
        headerStatus.innerText = text;
        headerStatus.style.color = isOnline ? 'var(--primary)' : '#64748b';
    }

    // Also update the coach modal status
    const modalStatus = document.getElementById('coach-modal-status');
    if (modalStatus) {
        modalStatus.innerText = isOnline ? 'Coach - Active Now' : 'Coach - Offline';
        modalStatus.style.color = isOnline ? 'var(--primary)' : '#64748b';
    }
}

// Coach chat now uses direct messaging - no AI trigger needed

// 3. Daily Greeting
// Daily greeting removed - coach now responds only when user messages
async function checkCoachGreeting() {
    // Function kept for compatibility but no longer sends automated greetings
    return;
}

// 4. Bubble Interaction
function openCoachChat() {
    openCoachChatModal();
}

// 5. Push Notifications - Subscribe ALL users to server push
async function requestNotificationPermission() {
    // On native apps, push notifications are handled by FCM via NativePush.init()
    // Web push subscriptions from a WebView don't deliver when the app is closed
    if (typeof isNativeApp === 'function' && isNativeApp()) {
        console.log('[Push] Native app detected — skipping web push (FCM handles this)');
        return;
    }

    if (!('Notification' in window) || !('serviceWorker' in navigator)) {
        console.log('Push notifications not supported');
        return;
    }

    // Check if permission already granted
    if (Notification.permission === 'granted') {
        // Auto-subscribe to push if permission already granted
        await subscribeUserToPush();
        return;
    }

    // Only request if not already denied
    if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted');
            await subscribeUserToPush();
        }
    }
}

// Subscribe user to server push notifications (for receiving DMs, etc.)
async function subscribeUserToPush() {
    try {
        if (!window.currentUser) return;

        const registration = await navigator.serviceWorker.ready;

        // Check if already subscribed
        let subscription = await registration.pushManager.getSubscription();

        if (!subscription) {
            // Subscribe to push
            subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });
        }

        // Save subscription to database
        const subscriptionJson = subscription.toJSON();
        const isAdmin = await db.pushSubscriptions.isAdmin();

        await db.pushSubscriptions.subscribe({
            endpoint: subscriptionJson.endpoint,
            keys: {
                p256dh: subscriptionJson.keys.p256dh,
                auth: subscriptionJson.keys.auth
            }
        }, isAdmin);

        console.log('User subscribed to push notifications');
    } catch (error) {
        console.error('Failed to subscribe to push notifications:', error);
    }
}


// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updateCoachUI();
    setInterval(updateCoachUI, 1000); // Check every second for visibility toggle
    // Don't request notification permission here — it fires before login/onboarding,
    // causing the browser dialog to overlap the onboarding wizard for new users.
    // On native apps, notifications are handled by the native permissions modal.
    // On web, we defer until the user is logged in and onboarding is complete.
});

// Immediate
updateCoachUI();

// 5. Welcome Modal Logic (REMOVED - Using original onboarding-modal instead)
// setTimeout(() => { ... }, 1000);
</script>
<!-- WORKOUT BUILDER VIEW -->
<div id="view-workout-builder" class="app-view" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:500; overflow-y:auto; padding-bottom: 100px;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: calc(15px + env(safe-area-inset-top, 0px)) 20px 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: center;">
        <div style="font-weight: 700; font-size: 1.2rem;">Build Workout</div>
    </div>

    <div style="padding: 20px;">
        <div style="position:relative; margin-bottom: 20px;">
            <input type="text" id="builder-search" placeholder="Search 1800+ exercises..." onkeyup="filterExerciseLibrary(this.value)"
                   style="width:100%; padding:15px 15px 15px 45px; border-radius:16px; border:1px solid #e2e8f0; font-size:1rem; background: #f8fafc;">
            <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:#94a3b8; position:absolute; left:15px; top:50%; transform:translateY(-50%);"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </div>

        <!-- Exercise Filters -->
        <div style="margin-bottom: 20px;">
            <!-- Workout Type Filter -->
            <div style="margin-bottom: 8px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                <div onclick="toggleFilterSection('workoutType')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: #334155;">Workout Type</div>
                    <svg id="chevron-workoutType" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #64748b; transition: transform 0.2s;">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
                <div id="filter-content-workoutType" style="display: none; padding: 12px; background: white;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="toggleFilter('workoutType', 'yoga')" class="filter-chip" data-category="workoutType" data-value="yoga" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Yoga</button>
                        <button onclick="toggleFilter('workoutType', 'pilates')" class="filter-chip" data-category="workoutType" data-value="pilates" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Pilates</button>
                        <button onclick="toggleFilter('workoutType', 'cardio')" class="filter-chip" data-category="workoutType" data-value="cardio" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Cardio</button>
                        <button onclick="toggleFilter('workoutType', 'stretch')" class="filter-chip" data-category="workoutType" data-value="stretch" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Stretch</button>
                    </div>
                </div>
            </div>

            <!-- Equipment Filter -->
            <div style="margin-bottom: 8px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                <div onclick="toggleFilterSection('equipment')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: #334155;">Equipment</div>
                    <svg id="chevron-equipment" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #64748b; transition: transform 0.2s;">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
                <div id="filter-content-equipment" style="display: none; padding: 12px; background: white;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="toggleFilter('equipment', 'bodyweight')" class="filter-chip" data-category="equipment" data-value="bodyweight" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Bodyweight</button>
                        <button onclick="toggleFilter('equipment', 'dumbbell')" class="filter-chip" data-category="equipment" data-value="dumbbell" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Dumbbell</button>
                        <button onclick="toggleFilter('equipment', 'barbell')" class="filter-chip" data-category="equipment" data-value="barbell" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Barbell</button>
                        <button onclick="toggleFilter('equipment', 'cable')" class="filter-chip" data-category="equipment" data-value="cable" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Cable</button>
                        <button onclick="toggleFilter('equipment', 'band')" class="filter-chip" data-category="equipment" data-value="band" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Band</button>
                        <button onclick="toggleFilter('equipment', 'kettlebell')" class="filter-chip" data-category="equipment" data-value="kettlebell" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Kettlebell</button>
                        <button onclick="toggleFilter('equipment', 'machine')" class="filter-chip" data-category="equipment" data-value="machine" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Machine</button>
                    </div>
                </div>
            </div>

            <!-- Muscle Group Filter -->
            <div style="margin-bottom: 8px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                <div onclick="toggleFilterSection('muscle')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;">
                    <div style="font-size: 0.85rem; font-weight: 700; color: #334155;">Muscle Group</div>
                    <svg id="chevron-muscle" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #64748b; transition: transform 0.2s;">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                </div>
                <div id="filter-content-muscle" style="display: none; padding: 12px; background: white;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="toggleFilter('muscle', 'chest')" class="filter-chip" data-category="muscle" data-value="chest" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Chest</button>
                        <button onclick="toggleFilter('muscle', 'back')" class="filter-chip" data-category="muscle" data-value="back" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Back</button>
                        <button onclick="toggleFilter('muscle', 'shoulders')" class="filter-chip" data-category="muscle" data-value="shoulders" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Shoulders</button>
                        <button onclick="toggleFilter('muscle', 'arms')" class="filter-chip" data-category="muscle" data-value="arms" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Arms</button>
                        <button onclick="toggleFilter('muscle', 'core')" class="filter-chip" data-category="muscle" data-value="core" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Core</button>
                        <button onclick="toggleFilter('muscle', 'legs')" class="filter-chip" data-category="muscle" data-value="legs" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Legs</button>
                        <button onclick="toggleFilter('muscle', 'glutes')" class="filter-chip" data-category="muscle" data-value="glutes" style="padding: 8px 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Glutes</button>
                    </div>
                </div>
            </div>

            <!-- Clear Filters Button -->
            <div id="clear-filters-btn" style="display: none; margin-top: 12px;">
                <button onclick="clearAllFilters()" style="width: 100%; padding: 10px; border-radius: 12px; border: 1.5px solid #ef4444; background: #fef2f2; color: #ef4444; font-size: 0.85rem; font-weight: 700; cursor: pointer;">Clear All Filters</button>
            </div>
        </div>

        <div id="builder-library-list" style="display:flex; flex-direction:column; gap:10px;">
            <!-- Dynamic Content -->
        </div>
    </div>
    
    <div id="builder-floating-action" style="position:fixed; bottom:0; left:0; right:0; width:100%; padding:20px; display:none; z-index: 1000; background: white; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); pointer-events: auto;">
        <div style="display:flex; gap:10px;">
            <button onclick="saveCustomBuilderWorkout()" style="flex:1; background:white; color:var(--primary); border:2px solid var(--primary); padding:18px; border-radius:50px; font-weight:800; box-shadow:0 10px 25px rgba(0,0,0,0.05); font-size: 1.1rem; cursor:pointer; min-height:56px; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1); -webkit-touch-callout: none; user-select: none; position: relative;">
                SAVE
            </button>
            <button onclick="startCustomBuilderWorkout()" style="flex:2; background:var(--primary); color:white; padding:18px; border-radius:50px; font-weight:800; border:none; box-shadow:0 10px 25px rgba(4,106,56,0.3); font-size: 1.1rem; cursor:pointer; min-height:56px; touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1); -webkit-touch-callout: none; user-select: none; position: relative;">
                START (<span id="builder-count">0</span>)
            </button>
        </div>
    </div>
    
    <script>
    async function saveCustomBuilderWorkout() {
        if (customWorkoutSelection.length === 0) return;
        const name = prompt("Name your workout:");
        if(!name) return;
        
        try {
            const user = window.currentUser;
            if(user) {
                 await dbHelpers.workouts.saveCustomWorkout(user.id, name, { 
                     exercises: customWorkoutSelection,
                     date: new Date().toISOString()
                 });
                 alert("Workout saved! You can find it in the Movement tab.");
                 switchAppTab('movement-tab');
                 renderMovementView(); // refresh list
            }
        } catch(e) {
            console.error("Failed to save workout:", e);
            alert("Failed to save workout. Please try again.");
        }
    }
    </script>
</div>
<script>
    async function startSavedWorkout(id) {
        // Use cache populated by renderMovementView
        const saved = window.savedWorkoutsCache || [];
        const workout = saved.find(w => w.id === id);
        if(!workout) return;

        // Track current custom workout ID so we can update it later with added exercises
        window.currentCustomWorkoutId = id;
        window.currentWorkoutName = workout.template_name || 'Custom Workout';

        // Preload workout history for previous stats and volume tracking
        const user = window.currentUser;
        if (user) {
            try {
                const rawHistory3 = await dbHelpers.workouts.getHistory(user.id);
                window.workoutHistoryCache = normalizeHistoryCache(rawHistory3);
            } catch(e) {
                console.error("Failed to load workout history", e);
            }
        }

        // Preload personal bests
        const exerciseNames = workout.template_data?.exercises || [];
        if (user) {
            try {
                window.personalBestsCache = await dbHelpers.personalBests.getForExercises(user.id, exerciseNames);
            } catch(e) { console.error("Failed to load personal bests", e); window.personalBestsCache = {}; }
        }

        // Map DB format to Player format
        // workout.template_data.exercises is array of strings (names)

        const customWorkout = {
            title: workout.template_name || 'Custom Workout',
            name: workout.template_name || 'Custom Workout',
            description: 'Saved Session • ' + new Date(workout.created_at || new Date()).toLocaleDateString(),
            exercises: exerciseNames.map(key => ({
                name: key,
                sets: 3,
                reps: '12',
                videoUrl: '',
                desc: ''
            }))
        };

        // Hijack the player
        document.getElementById('workout-player-title').innerText = customWorkout.title;
        document.getElementById('workout-player-goal').innerText = customWorkout.description;

        const list = document.getElementById('workout-exercises-list');
        list.innerHTML = '';

        customWorkout.exercises.forEach((ex, idx) => {
            const card = document.createElement('div');
            card.className = 'exercise-logger-card';
            card.setAttribute('data-exercise-name', ex.name);
            card.setAttribute('data-is-user-added', 'false');
            card.style.cssText = "background:white; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:25px; overflow:hidden; border:1px solid #f1f5f9;";
            const videoUrl = findVideoMatch(ex.name);
            const previousSummaryHtml = formatPreviousWorkoutSummary(ex.name);
            const previousSummary = getPreviousWorkoutSummary(ex.name);
            const escapedName = ex.name.replace(/'/g, "\\'");
            const numSets = previousSummary && previousSummary.setCount > 0 ? previousSummary.setCount : 3;
            const setsHtml = Array.from({length: numSets}, (_, i) => {
                const prevSet = previousSummary && previousSummary.sets[i] ? previousSummary.sets[i] : null;
                return getSetRowHtml(ex.name, i + 1, false, prevSet);
            }).join('');

            card.innerHTML = `
            <div style="padding:15px; background:#f8fafc; border-bottom:1px solid #e2e8f0;">
                <h3 style="margin:0 0 5px 0; font-size:1.05rem; font-weight:700; color:var(--text-main);">${ex.name}</h3>
                <div style="font-size:0.8rem; color:var(--text-muted);">Target: ${numSets} Sets x 12 Reps</div>
                ${previousSummaryHtml}
            </div>

            ${videoUrl ? `
            <div data-video-container style="position:relative; width:100%; padding-top:56.25%; background:black; cursor:pointer;" onclick="playInlineVideo(event, '${videoUrl}')">
                <video style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;" preload="metadata" muted playsinline>
                    <source src="${videoUrl}" type="video/mp4">
                </video>
                <div class="inline-play-overlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:60px; height:60px; background:rgba(255,255,255,0.9); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
                    <svg viewBox="0 0 24 24" style="width:30px; height:30px; fill:var(--primary); margin-left:3px;">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>` : ''}

            ${getVolumeDisplayHtml(ex.name)}

            <div style="display:grid; grid-template-columns:40px 1fr 1fr 1fr 32px 32px; gap:8px; padding:10px 15px 0 15px; font-size:0.7rem; color:#94a3b8; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; text-align:center;">
                <div>Set</div><div>Time</div><div>Reps</div><div>Kg</div><div></div><div></div>
            </div>

            <div class="sets-list-container">
                ${setsHtml}
            </div>

            <div style="padding:15px; border-top:1px solid #f8fafc;">
                <button onclick="addWorkoutSet(this, '${escapedName}', false)" style="width:100%; background:transparent; border:2px dashed #e2e8f0; color:#94a3b8; font-weight:700; font-size:0.8rem; padding:12px; border-radius:12px; cursor:pointer;">+ ADD SET</button>
            </div>`;
            list.appendChild(card);

            // Setup volume tracking for this card
            setupVolumeTracking(card);
        });

        hideAllAppViews();
        document.getElementById('view-active-workout').style.display = 'block';
        window.activeWorkoutSessions = customWorkout;

        // Start the workout timer
        startWorkoutTimer();

        // Push navigation state for Android back button
        pushNavigationState('view-active-workout', () => quitWorkout());

        // Show total volume popup and tracker
        showLastVolumePopup();

        // Show workout Spotify bar if music is playing
        if (typeof syncWorkoutSpotifyBar === 'function') syncWorkoutSpotifyBar();
    }

    async function showWorkoutHistoryDetail(dateStr) {
        // Fetch workout history for this specific date
        const user = window.currentUser;
        if (!user) return;

        try {
            const { data, error } = await window.supabaseClient
                .from('workouts')
                .select('exercise_name, set_number, reps, weight_kg, time_duration')
                .eq('user_id', user.id)
                .eq('workout_type', 'history')
                .eq('workout_date', dateStr)
                .order('exercise_name')
                .order('set_number');

            if (error) throw error;
            if (!data || data.length === 0) {
                alert('No workout data found for this date.');
                return;
            }

            // Group by exercise
            const exercises = {};
            data.forEach(row => {
                if (!exercises[row.exercise_name]) {
                    exercises[row.exercise_name] = [];
                }
                exercises[row.exercise_name].push(row);
            });

            // Format date for display
            const dateObj = new Date(dateStr + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            // Build modal content
            let content = `
            <div class="workout-summary-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;" onclick="if(event.target === this) this.remove();">
                <div style="background:white; border-radius:24px; max-width:400px; width:100%; max-height:80vh; overflow-y:auto; box-shadow:0 25px 50px rgba(0,0,0,0.25);">
                    <div style="padding:25px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2 style="margin:0 0 5px 0; font-size:1.3rem; color:var(--text-main);">Workout Summary</h2>
                            <div style="font-size:0.85rem; color:var(--text-muted);">${formattedDate}</div>
                        </div>
                        <button onclick="this.closest('.workout-summary-modal').remove()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
                    </div>
                    <div style="padding:20px;">
            `;

            Object.entries(exercises).forEach(([name, sets]) => {
                content += `
                    <div style="margin-bottom:20px;">
                        <h4 style="margin:0 0 10px 0; font-size:0.95rem; color:var(--primary);">${name}</h4>
                        <div style="background:#f8fafc; border-radius:12px; padding:10px;">
                `;
                sets.forEach(set => {
                    const weightDisplay = set.weight_kg ? `${set.weight_kg} kg` : '-';
                    const repsDisplay = set.reps || '-';
                    const timeDisplay = set.time_duration || '';
                    content += `
                        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #e2e8f0; font-size:0.85rem;">
                            <span style="color:var(--text-muted);">Set ${set.set_number}</span>
                            <span style="color:var(--text-main);">${weightDisplay} × ${repsDisplay} reps${timeDisplay ? ' • ' + timeDisplay : ''}</span>
                        </div>
                    `;
                });
                content += `
                        </div>
                    </div>
                `;
            });

            content += `
                    </div>
                </div>
            </div>
            `;

            document.body.insertAdjacentHTML('beforeend', content);
        } catch (err) {
            console.error('Failed to load workout history detail:', err);
            alert('Failed to load workout details.');
        }
    }
</script>

<!-- Check-in modal functions - must be defined before modal HTML -->
<script>
// checkInProgress will be defined later, use window reference for safety
if (typeof window.checkInProgress === 'undefined') {
    window.checkInProgress = { flow: null, symptoms: [], mood: null, energy: null, fluid: null, equipment: null, recovery: null };
}

function selectCheckInOption(category, value, el) {
    window.checkInProgress[category] = value;
    const options = document.querySelectorAll('.check-in-chip[data-group="' + category + '"]');
    options.forEach(function(opt) { opt.classList.remove('selected'); });
    el.classList.add('selected');
}

function toggleCheckInOption(category, value, el) {
    if (!window.checkInProgress[category]) window.checkInProgress[category] = [];
    var idx = window.checkInProgress[category].indexOf(value);
    if (idx > -1) {
        window.checkInProgress[category].splice(idx, 1);
        el.classList.remove('selected');
    } else {
        window.checkInProgress[category].push(value);
        el.classList.add('selected');
    }
}

function openCheckInModal() {
    if (typeof applyGenderSpecificUI === 'function') {
        applyGenderSpecificUI();
    }
    document.getElementById('check-in-modal').style.display = 'flex';
}

function closeCheckInModal() {
    document.getElementById('check-in-modal').style.display = 'none';
}

// Full implementation of submitDailyCycleSync
async function submitDailyCycleSync() {
    try {
        // 1. Save Log locally
        const today = getLocalDateString();
        if (typeof userCycleData === 'undefined') {
            window.userCycleData = JSON.parse(localStorage.getItem('userCycleData') || '{}');
        }
        if (!userCycleData.logs) userCycleData.logs = {};

        // Clone to avoid ref issues and add timestamp for priority comparisons
        userCycleData.logs[today] = JSON.parse(JSON.stringify(window.checkInProgress));
        userCycleData.logs[today].timestamp = new Date().toISOString();

        // Update userCycleData.symptoms from check-in
        userCycleData.symptoms = window.checkInProgress.symptoms || [];

        // Persist to localStorage
        localStorage.setItem('userCycleData', JSON.stringify(userCycleData));

        // 2. Save to Supabase
        if (window.currentUser && typeof dbHelpers !== 'undefined') {
            try {
                await dbHelpers.checkins.upsert(window.currentUser.id, today, {
                    energy: window.checkInProgress.energy || null,
                    equipment: window.checkInProgress.equipment || null,
                    additional_data: {
                        symptoms: window.checkInProgress.symptoms || [],
                        mood: window.checkInProgress.mood || null,
                        flow: window.checkInProgress.flow || null,
                        fluid: window.checkInProgress.fluid || null,
                        recovery: window.checkInProgress.recovery || null
                    }
                });
                console.log('✅ Check-in saved to Supabase');
            } catch (e) {
                console.error('Failed to save check-in to DB:', e);
            }
        }

        // Mark check-in as completed for today
        localStorage.setItem('lastWellnessCheck', new Date().toDateString());

        // Save equipment selection
        if (window.checkInProgress.equipment && window.currentUser && typeof dbHelpers !== 'undefined') {
            try {
                await window.supabaseClient.from('quiz_results')
                    .update({ equipment_access: window.checkInProgress.equipment })
                    .eq('user_id', window.currentUser.id);

                const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                userProfile.equipment_access = window.checkInProgress.equipment;
                userProfile.gym_access = (window.checkInProgress.equipment === 'gym');
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                if (window.userProfile) {
                    window.userProfile.equipment_access = window.checkInProgress.equipment;
                    window.userProfile.gym_access = (window.checkInProgress.equipment === 'gym');
                }
                console.log('✅ Equipment access saved:', window.checkInProgress.equipment);
            } catch (e) {
                console.warn('Failed to save equipment access:', e);
            }
        }

        // Update Active Symptoms display
        const symptomsDisplay = document.getElementById('profile-symptoms-display');
        if (symptomsDisplay) {
            const symptoms = window.checkInProgress.symptoms || [];
            if (symptoms.length > 0) {
                const formattedSymptoms = symptoms.map(s =>
                    s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
                ).join(', ');
                symptomsDisplay.textContent = formattedSymptoms;
            } else {
                symptomsDisplay.textContent = 'None';
            }
        }

        // Trigger Cycle Sync Engine
        if (typeof applyCycleSync === 'function') applyCycleSync(window.checkInProgress);

        // Handle rest-indicating conditions - show yoga recommendation popup
        // IMPORTANT: Check this BEFORE refreshing views, as view refreshes may interfere
        const isMale = (typeof isMaleUser === 'function' && isMaleUser());
        const symptoms = window.checkInProgress.symptoms || [];
        let yogaPopupReason = null;

        // Debug logging for yoga popup trigger
        console.log('🧘 Yoga popup check:', {
            energy: window.checkInProgress.energy,
            recovery: window.checkInProgress.recovery,
            symptoms: symptoms,
            isMale: isMale
        });

        // Check for conditions that should trigger yoga recommendation
        if (window.checkInProgress.energy === 'low') {
            yogaPopupReason = 'low_energy';
        } else if (isMale && window.checkInProgress.recovery === 'tired') {
            yogaPopupReason = 'tired';
        } else if (isMale && window.checkInProgress.recovery === 'moderate') {
            yogaPopupReason = 'fatigued';
        } else if (isMale && symptoms.includes('muscle_soreness')) {
            yogaPopupReason = 'muscle_soreness';
        } else if (symptoms.includes('back_pain')) {
            yogaPopupReason = 'back_pain';
        } else if (!isMale && symptoms.includes('cramps')) {
            yogaPopupReason = 'cramps';
        }

        if (yogaPopupReason) {
            console.log('🧘 Triggering yoga popup with reason:', yogaPopupReason);
            // Close the check-in modal first so the yoga popup is visible
            closeCheckInModal();
            if (typeof showLowEnergyYogaPopup === 'function') showLowEnergyYogaPopup(yogaPopupReason);
            return;
        } else {
            console.log('🧘 No yoga popup needed');
        }

        // Close & Refresh views (only if no yoga popup shown)
        closeCheckInModal();
        if (typeof initCycleView === 'function') initCycleView();
        if (typeof renderWeeklyCalendar === 'function') renderWeeklyCalendar();
        if (typeof renderMovementView === 'function') renderMovementView();

        // Clear any workout override
        localStorage.removeItem('todayWorkoutOverride');
        if (userCycleData.logs && userCycleData.logs[today]) {
            delete userCycleData.logs[today].workoutOverride;
            localStorage.setItem('userCycleData', JSON.stringify(userCycleData));
        }

        if (typeof switchAppTab === 'function') switchAppTab('dashboard');
        if (typeof showCycleSyncBanner === 'function') showCycleSyncBanner();

    } catch (err) {
        console.error('Error in submitDailyCycleSync:', err);
        alert('There was an error saving your check-in. Please try again.');
    }
}

// Expose to global scope
window.selectCheckInOption = selectCheckInOption;
window.toggleCheckInOption = toggleCheckInOption;
window.openCheckInModal = openCheckInModal;
window.closeCheckInModal = closeCheckInModal;
window.submitDailyCycleSync = submitDailyCycleSync;
</script>

<!-- Check-in modal removed -->
<div id="check-in-modal" style="display:none;"></div>

<style>
    @keyframes fadeInScale {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
</style>

<!-- DAILY WEIGH-IN PROMPT MODAL (First login of day) -->
<div id="weigh-in-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center; padding:15px;">
    <div class="modal-content" style="background: white; width: 100%; border-radius: 24px; padding: 0; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: fadeInScale 0.2s ease-out;">

        <!-- Header -->
        <div style="padding: 25px 25px 20px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 24px 24px 0 0; color: white; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
            <div style="position: relative; z-index: 1;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">⚖️</div>
                <h3 style="margin: 0 0 5px 0; font-family: 'Playfair Display'; font-size: 1.5rem;">Daily Weigh-In</h3>
                <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Start your day by tracking your progress</p>
            </div>
        </div>

        <!-- Content -->
        <div style="padding: 25px;">
            <div id="weigh-in-modal-input-section">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 12px; font-size: 0.95rem;">Enter today's weight</label>
                <div style="position: relative; margin-bottom: 20px;">
                    <input type="number" id="weigh-in-modal-input" placeholder="Enter weight" step="0.1" min="20" max="500" style="width: 100%; padding: 16px 60px 16px 20px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1.1rem; box-sizing: border-box; transition: border-color 0.2s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'">
                    <span id="weigh-in-modal-unit-label" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #666; font-size: 1rem; font-weight: 600;">kg</span>
                </div>
                <p id="weigh-in-modal-last-weight" style="margin: 0 0 16px 0; font-size: 0.85rem; color: var(--text-muted); text-align: center;"></p>

                <!-- Body Fat Calliper Section (optional) -->
                <div id="weigh-in-bf-section" style="margin-bottom: 18px;">
                    <button onclick="toggleBFSection()" id="weigh-in-bf-toggle" style="width: 100%; background: #f8f4ff; border: 1.5px dashed #a78bfa; border-radius: 12px; padding: 10px 14px; font-size: 0.88rem; font-weight: 600; color: #7c3aed; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 8px; transition: background 0.2s;">
                        <span style="font-size: 1rem;">📏</span>
                        <span>Also measure body fat % (callipers)</span>
                        <svg id="weigh-in-bf-chevron" viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #a78bfa; margin-left: auto; transition: transform 0.2s;"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>
                    </button>

                    <div id="weigh-in-bf-inputs" style="display: none; padding: 14px 2px 0;">

                        <!-- Measurement site diagram -->
                        <div style="display: flex; gap: 12px; margin-bottom: 14px; align-items: flex-start;">
                            <!-- SVG body diagram -->
                            <div style="flex-shrink: 0;">
                                <!-- Male diagram (default, shown when sex=male) -->
                                <svg id="bf-diagram-male" viewBox="0 0 110 260" width="90" height="208" style="display: block;">
                                    <!-- Head -->
                                    <ellipse cx="55" cy="22" rx="14" ry="16" fill="#ddd6fe" stroke="#a78bfa" stroke-width="1.5"/>
                                    <!-- Neck -->
                                    <rect x="49" y="36" width="12" height="10" rx="3" fill="#ddd6fe" stroke="#a78bfa" stroke-width="1.5"/>
                                    <!-- Torso -->
                                    <path d="M30 46 Q24 50 22 70 L20 140 L90 140 L88 70 Q86 50 80 46 Z" fill="#ddd6fe" stroke="#a78bfa" stroke-width="1.5"/>
                                    <!-- Left arm -->
                                    <path d="M30 46 Q18 55 15 90 L18 95 Q22 70 35 58 Z" fill="#ddd6fe" stroke="#a78bfa" stroke-width="1.5"/>
                                    <!-- Right arm -->
                                    <path d="M80 46 Q92 55 95 90 L92 95 Q88 70 75 58 Z" fill="#ddd6fe" stroke="#a78bfa" stroke-width="1.5"/>
                                    <!-- Left leg -->
                                    <path d="M20 140 L18 225 L40 225 L45 140 Z" fill="#ddd6fe" stroke="#a78bfa" stroke-width="1.5"/>
                                    <!-- Right leg -->
                                    <path d="M65 140 L70 225 L92 225 L90 140 Z" fill="#ddd6fe" stroke="#a78bfa" stroke-width="1.5"/>
                                    <!-- Site 1: Chest (right pec, diagonal) -->
                                    <circle cx="72" cy="68" r="9" fill="#f59e0b" stroke="white" stroke-width="2"/>
                                    <text x="72" y="72" text-anchor="middle" fill="white" font-size="9" font-weight="bold">1</text>
                                    <!-- Site 2: Abdomen (2cm right of navel) -->
                                    <circle cx="67" cy="108" r="9" fill="#f59e0b" stroke="white" stroke-width="2"/>
                                    <text x="67" y="112" text-anchor="middle" fill="white" font-size="9" font-weight="bold">2</text>
                                    <!-- Site 3: Thigh (anterior midline, right leg) -->
                                    <circle cx="75" cy="175" r="9" fill="#f59e0b" stroke="white" stroke-width="2"/>
                                    <text x="75" y="179" text-anchor="middle" fill="white" font-size="9" font-weight="bold">3</text>
                                </svg>
                                <!-- Female diagram (hidden by default) -->
                                <svg id="bf-diagram-female" viewBox="0 0 110 260" width="90" height="208" style="display: none;">
                                    <!-- Head -->
                                    <ellipse cx="55" cy="22" rx="14" ry="16" fill="#fbcfe8" stroke="#ec4899" stroke-width="1.5"/>
                                    <!-- Neck -->
                                    <rect x="49" y="36" width="12" height="10" rx="3" fill="#fbcfe8" stroke="#ec4899" stroke-width="1.5"/>
                                    <!-- Torso (slightly wider hips) -->
                                    <path d="M32 46 Q26 52 24 70 L20 140 L90 140 L86 70 Q84 52 78 46 Z" fill="#fbcfe8" stroke="#ec4899" stroke-width="1.5"/>
                                    <!-- Left arm -->
                                    <path d="M32 46 Q18 55 14 90 L17 95 Q22 70 36 58 Z" fill="#fbcfe8" stroke="#ec4899" stroke-width="1.5"/>
                                    <!-- Right arm -->
                                    <path d="M78 46 Q92 55 96 90 L93 95 Q88 70 74 58 Z" fill="#fbcfe8" stroke="#ec4899" stroke-width="1.5"/>
                                    <!-- Left leg -->
                                    <path d="M20 140 L18 225 L40 225 L45 140 Z" fill="#fbcfe8" stroke="#ec4899" stroke-width="1.5"/>
                                    <!-- Right leg -->
                                    <path d="M65 140 L70 225 L92 225 L90 140 Z" fill="#fbcfe8" stroke="#ec4899" stroke-width="1.5"/>
                                    <!-- Site 1: Tricep (posterior upper arm - shown on right arm back) -->
                                    <circle cx="94" cy="72" r="9" fill="#ec4899" stroke="white" stroke-width="2"/>
                                    <text x="94" y="76" text-anchor="middle" fill="white" font-size="9" font-weight="bold">1</text>
                                    <!-- Site 2: Suprailiac (just above right hip bone) -->
                                    <circle cx="83" cy="128" r="9" fill="#ec4899" stroke="white" stroke-width="2"/>
                                    <text x="83" y="132" text-anchor="middle" fill="white" font-size="9" font-weight="bold">2</text>
                                    <!-- Site 3: Thigh (anterior midline, right leg) -->
                                    <circle cx="75" cy="175" r="9" fill="#ec4899" stroke="white" stroke-width="2"/>
                                    <text x="75" y="179" text-anchor="middle" fill="white" font-size="9" font-weight="bold">3</text>
                                </svg>
                            </div>

                            <!-- Site descriptions -->
                            <div style="flex: 1; font-size: 0.78rem; color: #4b5563; line-height: 1.5;">
                                <!-- Male site descriptions -->
                                <div id="bf-sites-male">
                                    <div style="margin-bottom: 8px;"><span style="display: inline-block; background: #f59e0b; color: white; border-radius: 50%; width: 16px; height: 16px; text-align: center; line-height: 16px; font-size: 0.7rem; font-weight: 700; margin-right: 4px;">1</span><strong>Chest</strong> — Diagonal fold, halfway between your right nipple and armpit fold</div>
                                    <div style="margin-bottom: 8px;"><span style="display: inline-block; background: #f59e0b; color: white; border-radius: 50%; width: 16px; height: 16px; text-align: center; line-height: 16px; font-size: 0.7rem; font-weight: 700; margin-right: 4px;">2</span><strong>Abdomen</strong> — Vertical fold, 2 cm to the right of your navel</div>
                                    <div><span style="display: inline-block; background: #f59e0b; color: white; border-radius: 50%; width: 16px; height: 16px; text-align: center; line-height: 16px; font-size: 0.7rem; font-weight: 700; margin-right: 4px;">3</span><strong>Thigh</strong> — Vertical fold on the front of your thigh, halfway between your hip crease and top of knee</div>
                                </div>
                                <!-- Female site descriptions -->
                                <div id="bf-sites-female" style="display: none;">
                                    <div style="margin-bottom: 8px;"><span style="display: inline-block; background: #ec4899; color: white; border-radius: 50%; width: 16px; height: 16px; text-align: center; line-height: 16px; font-size: 0.7rem; font-weight: 700; margin-right: 4px;">1</span><strong>Tricep</strong> — Vertical fold on the back of your upper arm, halfway between shoulder and elbow</div>
                                    <div style="margin-bottom: 8px;"><span style="display: inline-block; background: #ec4899; color: white; border-radius: 50%; width: 16px; height: 16px; text-align: center; line-height: 16px; font-size: 0.7rem; font-weight: 700; margin-right: 4px;">2</span><strong>Suprailiac</strong> — Diagonal fold just above your right hip bone, at the front side</div>
                                    <div><span style="display: inline-block; background: #ec4899; color: white; border-radius: 50%; width: 16px; height: 16px; text-align: center; line-height: 16px; font-size: 0.7rem; font-weight: 700; margin-right: 4px;">3</span><strong>Thigh</strong> — Vertical fold on the front of your thigh, halfway between your hip crease and top of knee</div>
                                </div>
                                <p style="margin: 8px 0 0; font-size: 0.72rem; color: #9ca3af; font-style: italic;">Pinch firmly, pull skin from muscle, measure within 2 sec</p>
                            </div>
                        </div>

                        <!-- Measurement inputs -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div>
                                <label id="bf-label-1" style="display: block; font-size: 0.72rem; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Site 1 (mm)</label>
                                <input type="number" id="bf-input-1" min="1" max="80" step="0.5" placeholder="e.g. 12" oninput="recalcBF()" style="width: 100%; padding: 9px 8px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; text-align: center; box-sizing: border-box;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='#e5e7eb'">
                            </div>
                            <div>
                                <label id="bf-label-2" style="display: block; font-size: 0.72rem; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Site 2 (mm)</label>
                                <input type="number" id="bf-input-2" min="1" max="80" step="0.5" placeholder="e.g. 18" oninput="recalcBF()" style="width: 100%; padding: 9px 8px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; text-align: center; box-sizing: border-box;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='#e5e7eb'">
                            </div>
                            <div>
                                <label id="bf-label-3" style="display: block; font-size: 0.72rem; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Site 3 (mm)</label>
                                <input type="number" id="bf-input-3" min="1" max="80" step="0.5" placeholder="e.g. 22" oninput="recalcBF()" style="width: 100%; padding: 9px 8px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; text-align: center; box-sizing: border-box;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='#e5e7eb'">
                            </div>
                        </div>

                        <!-- Live BF% result -->
                        <div id="bf-result-row" style="display: none; background: linear-gradient(135deg, #f3e8ff, #ede9fe); border-radius: 10px; padding: 10px 14px; text-align: center;">
                            <span style="font-size: 0.8rem; color: #7c3aed; font-weight: 600;">Estimated Body Fat: </span>
                            <span id="bf-result-value" style="font-size: 1.15rem; font-weight: 800; color: #6d28d9;"></span>
                            <span style="font-size: 0.8rem; color: #7c3aed; font-weight: 600;"> %</span>
                            <div id="bf-result-category" style="font-size: 0.72rem; color: #8b5cf6; margin-top: 2px;"></div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="closeWeighInModal()" style="flex: 1; background: #f1f5f9; color: var(--text-main); border: none; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.2s;">
                        Skip
                    </button>
                    <button onclick="submitWeighInModal()" style="flex: 2; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        Log It (+1 XP)
                    </button>
                </div>
            </div>

            <div id="weigh-in-modal-success-section" style="display: none; text-align: center; padding: 20px 0;">
                <div style="font-size: 3rem; margin-bottom: 15px;">🎉</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #667eea; margin-bottom: 8px;">+1 XP</div>
                <p style="margin: 0; font-weight: 600; color: var(--text-main);">Weigh-in complete!</p>
                <p style="margin: 10px 0 0 0; font-size: 0.85rem; color: var(--text-muted);">Keep up the great consistency!</p>
            </div>
        </div>
    </div>
</div>

<script>
// ===== DAILY WEIGH-IN MODAL LOGIC (First Login of Day) =====

/**
 * Check if this is the first login of the day and show weigh-in modal
 */
async function checkAndShowWeighInModal() {
    if (!window.currentUser) return;

    // Don't show weigh-in if onboarding wizard is active or pending
    if (window._onboardingWizardPending) return;
    const wizard = document.getElementById('onboarding-wizard');
    if (wizard && wizard.style.display !== 'none') return;

    // Check if we've already prompted today
    const lastPromptDate = localStorage.getItem('lastWeighInPromptDate');
    const today = new Date().toDateString();

    if (lastPromptDate === today) {
        // Already prompted today, don't show again
        return;
    }

    try {
        // Check if user has already weighed in today
        const todaysWeighIn = await db.weighIns.getTodaysWeighIn(window.currentUser.id);

        if (todaysWeighIn) {
            // Already weighed in today, mark as prompted and don't show modal
            localStorage.setItem('lastWeighInPromptDate', today);
            return;
        }

        // Show the weigh-in modal
        openWeighInModal();

    } catch (error) {
        console.error('Error checking weigh-in for modal:', error);
    }
}

/**
 * Open the daily weigh-in modal
 */
async function openWeighInModal() {
    const modal = document.getElementById('weigh-in-modal');
    const inputSection = document.getElementById('weigh-in-modal-input-section');
    const successSection = document.getElementById('weigh-in-modal-success-section');
    const input = document.getElementById('weigh-in-modal-input');
    const unitLabel = document.getElementById('weigh-in-modal-unit-label');
    const lastWeightText = document.getElementById('weigh-in-modal-last-weight');

    if (!modal) return;

    // Reset modal state
    if (inputSection) inputSection.style.display = 'block';
    if (successSection) successSection.style.display = 'none';
    if (input) input.value = '';

    // Reset calliper section
    const bfInputs = document.getElementById('weigh-in-bf-inputs');
    const bfChevron = document.getElementById('weigh-in-bf-chevron');
    const bfResultRow = document.getElementById('bf-result-row');
    if (bfInputs) bfInputs.style.display = 'none';
    if (bfChevron) bfChevron.style.transform = '';
    if (bfResultRow) bfResultRow.style.display = 'none';
    ['bf-input-1','bf-input-2','bf-input-3'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });

    // Set unit preference
    const preferLbs = localStorage.getItem('weightUnitPreference') === 'lbs';
    if (unitLabel) {
        unitLabel.textContent = preferLbs ? 'lbs' : 'kg';
    }
    if (input) {
        input.step = preferLbs ? '1' : '0.1';
    }

    // Show last known weight as reference
    try {
        const latestWeighIn = await db.weighIns.getLatest(window.currentUser.id);
        if (latestWeighIn && lastWeightText) {
            const displayWeight = preferLbs
                ? (latestWeighIn.weight_kg * 2.20462).toFixed(1) + ' lbs'
                : latestWeighIn.weight_kg.toFixed(1) + ' kg';
            lastWeightText.textContent = `Last weigh-in: ${displayWeight}`;
            lastWeightText.style.display = 'block';
        } else if (lastWeightText) {
            lastWeightText.style.display = 'none';
        }
    } catch (e) {
        if (lastWeightText) lastWeightText.style.display = 'none';
    }

    // Show modal
    modal.style.display = 'flex';
}

/**
 * Close the weigh-in modal
 */
function closeWeighInModal() {
    const modal = document.getElementById('weigh-in-modal');
    if (modal) modal.style.display = 'none';

    // Mark as prompted today even if skipped
    localStorage.setItem('lastWeighInPromptDate', new Date().toDateString());

    // Keep the dashboard card visible so user can still weigh in from the home screen
}

/**
 * Submit weight from the modal
 */
async function submitWeighInModal() {
    if (!window.currentUser) {
        alert('Please log in to track your weight.');
        return;
    }

    const input = document.getElementById('weigh-in-modal-input');
    const inputSection = document.getElementById('weigh-in-modal-input-section');
    const successSection = document.getElementById('weigh-in-modal-success-section');
    const modal = document.getElementById('weigh-in-modal');

    let weightValue = parseFloat(input?.value);

    if (!weightValue || weightValue < 20 || weightValue > 500) {
        alert('Please enter a valid weight.');
        return;
    }

    // Convert lbs to kg if needed
    const preferLbs = localStorage.getItem('weightUnitPreference') === 'lbs';
    if (preferLbs) {
        weightValue = weightValue * 0.453592;
    }

    // Capture body fat % if calliper section was used
    let bodyFatPct = null;
    const bfResult = document.getElementById('bf-result-value');
    const bfInputsVisible = document.getElementById('weigh-in-bf-inputs')?.style.display !== 'none';
    if (bfInputsVisible && bfResult && bfResult.textContent) {
        const parsed = parseFloat(bfResult.textContent);
        if (!isNaN(parsed) && parsed > 1 && parsed < 60) {
            bodyFatPct = parsed;
        }
    }

    try {
        // Log the weigh-in (with optional body fat %)
        await db.weighIns.log(window.currentUser.id, weightValue, null, bodyFatPct);

        // Award 1 XP
        try {
            const { data: currentPoints } = await supabaseClient
                .from('user_points')
                .select('lifetime_points')
                .eq('user_id', window.currentUser.id)
                .maybeSingle();

            if (currentPoints) {
                await supabaseClient
                    .from('user_points')
                    .update({ lifetime_points: (currentPoints.lifetime_points || 0) + 1 })
                    .eq('user_id', window.currentUser.id);
            } else {
                await supabaseClient
                    .from('user_points')
                    .insert({ user_id: window.currentUser.id, lifetime_points: 1, current_points: 0 });
            }

            if (typeof triggerXPBarRainbow === 'function') triggerXPBarRainbow();
            if (typeof refreshLevelDisplay === 'function') refreshLevelDisplay();
        } catch (xpError) {
            console.log('XP award skipped:', xpError);
        }

        // Update user's current weight in profile
        try {
            await db.users.update(window.currentUser.id, { weight: weightValue });
        } catch (updateError) {
            console.log('Profile weight update skipped:', updateError);
        }

        // Show success animation
        if (inputSection) inputSection.style.display = 'none';
        if (successSection) successSection.style.display = 'block';

        // Mark as prompted today
        localStorage.setItem('lastWeighInPromptDate', new Date().toDateString());

        // Hide the card on dashboard since already logged
        const card = document.getElementById('daily-weigh-in-card');
        if (card) card.style.display = 'none';

        // Close modal after showing success
        setTimeout(() => {
            if (modal) modal.style.display = 'none';
            // Reset for next use
            if (inputSection) inputSection.style.display = 'block';
            if (successSection) successSection.style.display = 'none';
            if (input) input.value = '';
        }, 2000);

        // Refresh points display
        if (typeof refreshPointsDisplay === 'function') {
            refreshPointsDisplay();
        }

    } catch (error) {
        console.error('Error logging weigh-in from modal:', error);
        alert('Failed to log weigh-in. Please try again.');
    }
}

// ===== BODY FAT CALLIPER HELPERS =====

/**
 * Toggle the body fat calliper section in the weigh-in modal.
 * Adapts the diagram and labels to the user's sex.
 */
function toggleBFSection() {
    const inputs = document.getElementById('weigh-in-bf-inputs');
    const chevron = document.getElementById('weigh-in-bf-chevron');
    if (!inputs) return;

    const isOpen = inputs.style.display !== 'none';
    inputs.style.display = isOpen ? 'none' : 'block';
    if (chevron) chevron.style.transform = isOpen ? '' : 'rotate(180deg)';

    if (!isOpen) {
        // Detect sex from session profile (set during login)
        let sex = 'male';
        try {
            const profile = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
            sex = (profile.sex || '').toLowerCase().includes('f') ? 'female' : 'male';
        } catch (e) {}

        const maleDiagram  = document.getElementById('bf-diagram-male');
        const femaleDiagram = document.getElementById('bf-diagram-female');
        const maleSites    = document.getElementById('bf-sites-male');
        const femaleSites  = document.getElementById('bf-sites-female');
        const label1 = document.getElementById('bf-label-1');
        const label2 = document.getElementById('bf-label-2');
        const label3 = document.getElementById('bf-label-3');

        if (sex === 'female') {
            if (maleDiagram)  maleDiagram.style.display  = 'none';
            if (femaleDiagram) femaleDiagram.style.display = 'block';
            if (maleSites)    maleSites.style.display    = 'none';
            if (femaleSites)  femaleSites.style.display  = 'block';
            if (label1) label1.textContent = 'Tricep (mm)';
            if (label2) label2.textContent = 'Suprailiac (mm)';
            if (label3) label3.textContent = 'Thigh (mm)';
        } else {
            if (maleDiagram)  maleDiagram.style.display  = 'block';
            if (femaleDiagram) femaleDiagram.style.display = 'none';
            if (maleSites)    maleSites.style.display    = 'block';
            if (femaleSites)  femaleSites.style.display  = 'none';
            if (label1) label1.textContent = 'Chest (mm)';
            if (label2) label2.textContent = 'Abdomen (mm)';
            if (label3) label3.textContent = 'Thigh (mm)';
        }

        // Store sex on window for recalcBF()
        window._bfSex = sex;
    }
}

/**
 * Recalculate body fat % from the 3 skinfold inputs using Jackson-Pollock 3-site formula.
 * Male:   D = 1.10938 − (0.0008267×S) + (0.0000016×S²) − (0.0002574×age)
 * Female: D = 1.0994921 − (0.0009929×S) + (0.0000023×S²) − (0.0001392×age)
 * BF% = (4.95/D − 4.50) × 100
 */
function recalcBF() {
    const s1 = parseFloat(document.getElementById('bf-input-1')?.value) || 0;
    const s2 = parseFloat(document.getElementById('bf-input-2')?.value) || 0;
    const s3 = parseFloat(document.getElementById('bf-input-3')?.value) || 0;
    const resultRow = document.getElementById('bf-result-row');
    const resultVal = document.getElementById('bf-result-value');
    const resultCat = document.getElementById('bf-result-category');

    if (!s1 || !s2 || !s3) {
        if (resultRow) resultRow.style.display = 'none';
        return;
    }

    // Get age from session profile
    let age = 30;
    try {
        const profile = JSON.parse(sessionStorage.getItem('userProfile') || '{}');
        age = parseInt(profile.age) || 30;
    } catch (e) {}

    const S = s1 + s2 + s3;
    const sex = window._bfSex || 'male';
    let D;
    if (sex === 'female') {
        D = 1.0994921 - (0.0009929 * S) + (0.0000023 * S * S) - (0.0001392 * age);
    } else {
        D = 1.10938 - (0.0008267 * S) + (0.0000016 * S * S) - (0.0002574 * age);
    }

    const bf = ((4.95 / D) - 4.50) * 100;
    if (!isFinite(bf) || bf < 1 || bf > 60) {
        if (resultRow) resultRow.style.display = 'none';
        return;
    }

    if (resultVal) resultVal.textContent = bf.toFixed(1);
    if (resultRow) resultRow.style.display = 'block';

    // Category label (ACE classifications, male/female aware)
    if (resultCat) {
        let cat = '';
        if (sex === 'female') {
            if (bf < 14) cat = 'Essential fat';
            else if (bf < 21) cat = 'Athletic';
            else if (bf < 25) cat = 'Fitness';
            else if (bf < 32) cat = 'Average';
            else cat = 'Obese range';
        } else {
            if (bf < 6)  cat = 'Essential fat';
            else if (bf < 14) cat = 'Athletic';
            else if (bf < 18) cat = 'Fitness';
            else if (bf < 25) cat = 'Average';
            else cat = 'Obese range';
        }
        resultCat.textContent = cat;
    }
}

window.toggleBFSection = toggleBFSection;
window.recalcBF = recalcBF;

// Make functions globally available
window.checkAndShowWeighInModal = checkAndShowWeighInModal;
window.openWeighInModal = openWeighInModal;
window.closeWeighInModal = closeWeighInModal;
window.submitWeighInModal = submitWeighInModal;
</script>

<!-- Share Referral Modal -->
<div id="share-referral-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10006; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
    <div style="background:white; border-radius:20px; max-width:500px; width:90%; max-height:85vh; overflow-y:auto; animation:fadeInScale 0.3s ease-out; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <!-- Header -->
        <div style="padding:24px 24px 20px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; justify-content:space-between;">
            <div>
                <h2 style="margin:0 0 4px 0; font-size:1.5rem; color:var(--text-main);">Share Your Invite Link</h2>
                <p style="margin:0; font-size:0.875rem; color:#64748b;">You BOTH get 1 week double XP when they join!</p>
            </div>
            <button onclick="closeShareReferralModal()" style="background:none; border:none; font-size:1.8rem; color:#94a3b8; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:all 0.2s;">×</button>
        </div>

        <!-- Content -->
        <div style="padding:24px;">
            <!-- Referral Code Display -->
            <div style="margin-bottom:24px;">
                <label style="display:block; font-size:0.875rem; font-weight:600; color:var(--text-main); margin-bottom:8px;">Your Referral Code</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <div id="referral-code-display" style="flex:1; padding:14px; background:#f8fafc; border:2px solid #e2e8f0; border-radius:12px; font-family:monospace; font-size:1.1rem; font-weight:700; color:var(--primary); text-align:center; letter-spacing:2px;">
                        Loading...
                    </div>
                    <button onclick="copyReferralCode()" style="padding:14px 20px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; white-space:nowrap; transition:all 0.2s;">
                        Copy
                    </button>
                </div>
            </div>

            <!-- Share Options -->
            <div style="margin-bottom:16px;">
                <label style="display:block; font-size:0.875rem; font-weight:600; color:var(--text-main); margin-bottom:12px;">Share via</label>
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                    <!-- WhatsApp -->
                    <button onclick="shareViaWhatsApp()" style="padding:14px; background:#25D366; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                        WhatsApp
                    </button>

                    <!-- Facebook Messenger -->
                    <button onclick="shareViaFacebook()" style="padding:14px; background:#1877F2; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </button>

                    <!-- SMS -->
                    <button onclick="shareViaSMS()" style="padding:14px; background:#22c55e; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s; grid-column:span 2;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 11H7V9h2v2zm4 0h-2V9h2v2zm4 0h-2V9h2v2z"/>
                        </svg>
                        SMS
                    </button>
                </div>
            </div>

            <!-- Info -->
            <div style="padding:16px; background:#f0fdf4; border:2px solid #bbf7d0; border-radius:12px; margin-top:20px;">
                <div style="display:flex; gap:12px; align-items:start;">
                    <div style="font-size:1.5rem; flex-shrink:0;">💡</div>
                    <div style="font-size:0.875rem; color:#15803d; line-height:1.5;">
                        <strong>How it works:</strong> When your friend signs up using your code, you BOTH automatically get 1 week of double XP! The more friends you invite, the more weeks of 2x XP you earn. Share away!
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Friend Modal -->
<div id="add-friend-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10006; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
    <div style="background:white; border-radius:20px; max-width:500px; width:90%; max-height:85vh; overflow-y:auto; animation:fadeInScale 0.3s ease-out; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <!-- Header -->
        <div style="padding:24px 24px 20px; border-bottom:1px solid #f1f5f9; display:flex; align-items:center; justify-content:space-between;">
            <div>
                <h2 style="margin:0 0 4px 0; font-size:1.5rem; color:var(--text-main);">Add Friends</h2>
                <p style="margin:0; font-size:0.875rem; color:#64748b;">Search by name or email</p>
            </div>
            <button onclick="closeAddFriendModal()" style="background:none; border:none; font-size:1.8rem; color:#94a3b8; cursor:pointer; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:all 0.2s;">×</button>
        </div>

        <!-- Tab Switcher -->
        <div style="padding:16px 24px; border-bottom:1px solid #f1f5f9;">
            <div style="display:flex; background:#f1f5f9; padding:4px; border-radius:10px;">
                <button id="friend-tab-search" onclick="showFriendTab('search')" style="flex:1; padding:10px; border:none; background:white; color:var(--primary); font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s;">Search</button>
                <button id="friend-tab-requests" onclick="showFriendTab('requests')" style="flex:1; padding:10px; border:none; background:transparent; color:#64748b; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s;">Requests <span id="friend-request-badge" style="display:none; background:#ef4444; color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px; margin-left:4px;">0</span></button>
                <button id="friend-tab-friends" onclick="showFriendTab('friends')" style="flex:1; padding:10px; border:none; background:transparent; color:#64748b; font-weight:600; border-radius:8px; cursor:pointer; transition:all 0.2s;">Friends</button>
            </div>
        </div>

        <!-- Search Tab Content -->
        <div id="friend-search-content" style="padding:24px;">
            <!-- Search Input -->
            <div style="margin-bottom:20px;">
                <div style="display:flex; gap:8px; align-items:center;">
                    <input type="text" id="friend-search-input" placeholder="Search by name or email..." oninput="debouncedFriendSearch()" style="flex:1; padding:14px 16px; background:#f8fafc; border:2px solid #e2e8f0; border-radius:12px; font-size:1rem; outline:none; transition:all 0.2s;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#e2e8f0'">
                    <button onclick="searchForFriends()" style="padding:14px 20px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; transition:all 0.2s;">
                        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Search Results -->
            <div id="friend-search-results" style="min-height:100px;">
                <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <p style="margin:0; font-size:0.95rem;">Search for friends by their name or email address</p>
                </div>
            </div>
        </div>

        <!-- Requests Tab Content -->
        <div id="friend-requests-content" style="display:none; padding:24px;">
            <div id="friend-requests-list" style="min-height:100px;">
                <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                        <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <p style="margin:0; font-size:0.95rem;">No pending friend requests</p>
                </div>
            </div>
        </div>

        <!-- Friends List Tab Content -->
        <div id="friend-list-content" style="display:none; padding:24px;">
            <div id="friends-list" style="min-height:100px;">
                <div style="text-align:center; padding:40px 20px; color:#94a3b8;">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#cbd5e1; margin-bottom:12px;">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                    <p style="margin:0; font-size:0.95rem;">No friends yet. Start by adding some!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Story Camera Modal (Instagram-style) -->
<div id="story-camera-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10008; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Camera Preview -->
    <video id="camera-preview" autoplay playsinline style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0;"></video>

    <!-- Captured Preview (shown after capture) -->
    <div id="captured-preview" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:11;">
        <img id="captured-photo" style="width:100%; height:100%; object-fit:cover; display:none;">
        <video id="captured-video" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover; display:none;"></video>
    </div>

    <!-- Close Button -->
    <button onclick="closeCameraModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:12;">
        &times;
    </button>

    <!-- Post Button (shown after capture) -->
    <button id="post-story-btn" onclick="postCapturedStory()" style="display:none; position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:12px 30px; border:none; border-radius:25px; font-weight:600; font-size:1rem; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.5); z-index:12;">
        Post
    </button>

    <!-- Retake Button (shown after capture) -->
    <button id="retake-btn" onclick="retakePhoto()" style="display:none; position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:12px 24px; border:none; border-radius:25px; font-weight:600; font-size:1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:12;">
        Retake
    </button>

    <!-- Camera Controls -->
    <div id="camera-controls" style="position:absolute; bottom:40px; left:0; right:0; display:flex; justify-content:center; align-items:center; z-index:10;">
        <!-- Single Capture Button (Tap = Photo, Hold = Video) -->
        <button id="camera-capture-btn"
                onmousedown="handleCameraButtonDown()"
                onmouseup="handleCameraButtonUp()"
                onmouseleave="handleCameraButtonUp()"
                ontouchstart="handleCameraButtonDown()"
                ontouchend="handleCameraButtonUp()"
                style="width:70px; height:70px; background:white; border:5px solid rgba(255,255,255,0.8); border-radius:50%; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3); transition:all 0.2s;">
        </button>
    </div>

    <!-- Recording Indicator -->
    <div id="recording-indicator" style="position:absolute; top:20px; left:20px; background:rgba(239,68,68,0.9); color:white; padding:8px 16px; border-radius:20px; font-weight:600; display:none; z-index:10;">
        ⏺ Recording...
    </div>
</div>

<!-- Story Choice Modal (Photo or Video?) -->
<div id="story-choice-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10010; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <div style="width:90%; max-width:400px; background:white; border-radius:20px; overflow:hidden; text-align:center;">
        <!-- Header -->
        <div style="padding:30px 20px 20px 20px;">
            <h3 style="margin:0 0 10px 0; color:var(--primary); font-size:1.5rem;">Create a Post</h3>
            <p style="margin:0; color:var(--text-muted); font-size:0.9rem;">Choose what you'd like to share</p>
        </div>

        <!-- Choice Buttons -->
        <div style="padding:0 20px 30px 20px; display:flex; flex-direction:column; gap:12px;">
            <button onclick="openNativeCamera('photo')" style="width:100%; padding:20px; background:linear-gradient(135deg, var(--primary), var(--secondary)); color:white; border:none; border-radius:15px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.15); transition:transform 0.2s; display:flex; align-items:center; justify-content:center; gap:10px;">
                <svg viewBox="0 0 24 24" style="width:24px; height:24px; fill:white;">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                Take Photo
            </button>

            <button onclick="openNativeCamera('video')" style="width:100%; padding:20px; background:linear-gradient(135deg, #8b5cf6, #ec4899); color:white; border:none; border-radius:15px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.15); transition:transform 0.2s; display:flex; align-items:center; justify-content:center; gap:10px;">
                <svg viewBox="0 0 24 24" style="width:24px; height:24px; fill:white;">
                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                </svg>
                Record Video
            </button>

            <button onclick="closeChoiceModal()" style="width:100%; padding:16px; background:rgba(0,0,0,0.05); color:var(--text-muted); border:none; border-radius:15px; font-weight:600; font-size:1rem; cursor:pointer; transition:background 0.2s;">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Story Preview Modal (After Native Camera Capture) -->
<div id="story-preview-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10011; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Preview Content -->
    <img id="story-preview-photo" style="width:100%; height:100%; object-fit:contain; display:none; position:absolute; top:0; left:0;">
    <video id="story-preview-video-player" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:contain; display:none; position:absolute; top:0; left:0;"></video>

    <!-- Text Overlay Preview (user-added text) -->
    <div id="story-text-overlay-preview" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; font-size:1.5rem; font-weight:700; text-align:center; text-shadow:2px 2px 4px rgba(0,0,0,0.8); padding:10px 20px; max-width:80%; word-wrap:break-word; z-index:11; pointer-events:none;">
    </div>

    <!-- Close Button -->
    <button onclick="closePreviewModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:12; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Add Text Button -->
    <button id="add-text-btn" onclick="showTextEditor()" style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.5); border:none; color:white; padding:10px 20px; border-radius:20px; font-weight:600; cursor:pointer; z-index:12; backdrop-filter:blur(10px); display:flex; align-items:center; gap:8px;">
        <svg viewBox="0 0 24 24" style="width:20px; height:20px; fill:white;">
            <path d="M5 4v3h5.5v12h3V7H19V4z"/>
        </svg>
        Add Text
    </button>

    <!-- Text Editor Overlay -->
    <div id="text-editor-overlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:13; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
        <textarea id="story-text-input" placeholder="Type your text..." maxlength="100" style="width:90%; max-width:400px; background:transparent; border:none; color:white; font-size:1.5rem; font-weight:700; text-align:center; resize:none; outline:none; font-family:inherit; min-height:100px; text-shadow:2px 2px 4px rgba(0,0,0,0.8);"></textarea>
        <div style="display:flex; gap:15px; margin-top:30px;">
            <button onclick="cancelTextEditor()" style="padding:12px 30px; background:rgba(255,255,255,0.2); color:white; border:none; border-radius:25px; font-weight:600; cursor:pointer; backdrop-filter:blur(10px);">
                Cancel
            </button>
            <button onclick="saveTextOverlay()" style="padding:12px 30px; background:var(--primary); color:white; border:none; border-radius:25px; font-weight:600; cursor:pointer;">
                Done
            </button>
        </div>
    </div>

    <!-- Post Button -->
    <button id="preview-post-btn" onclick="postCapturedStory()" style="position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:14px 35px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.6); z-index:12; transition:transform 0.2s;">
        Post
    </button>

    <!-- Retake Button -->
    <button onclick="retakeFromPreview()" style="position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:14px 28px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:12; transition:transform 0.2s;">
        Retake
    </button>
</div>

<!-- Meal Photo Preview Modal (After Native Camera Capture) -->
<div id="meal-preview-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10012; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Photo Preview -->
    <img id="meal-preview-photo" style="width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0;">

    <!-- Close Button -->
    <button onclick="closeMealPreviewModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:13; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Food Description Input -->
    <div style="position:absolute; bottom:110px; left:20px; right:20px; z-index:13;">
        <div id="meal-photo-type-row" style="display:flex; gap:8px; max-width:500px; margin:0 auto 10px auto;">
            <button class="meal-photo-type-pill active" data-type="breakfast" onclick="selectPhotoMealType('breakfast')">Breakfast</button>
            <button class="meal-photo-type-pill" data-type="lunch" onclick="selectPhotoMealType('lunch')">Lunch</button>
            <button class="meal-photo-type-pill" data-type="dinner" onclick="selectPhotoMealType('dinner')">Dinner</button>
            <button class="meal-photo-type-pill" data-type="snack" onclick="selectPhotoMealType('snack')">Snack</button>
        </div>
        <input type="text" id="meal-photo-description" placeholder="What did you have? e.g. 200g oats, 100ml milk" style="width:100%; max-width:500px; margin:0 auto; display:block; background:rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.3); border-radius:15px; color:white; padding:14px 20px; font-size:1rem; backdrop-filter:blur(10px); font-family:inherit; outline:none; box-sizing:border-box;" />
    </div>

    <!-- Analyze Button -->
    <button onclick="useMealPhoto()" style="position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:14px 35px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.6); z-index:13; transition:transform 0.2s;">
        Analyze Meal
    </button>

    <!-- Retake Button -->
    <button onclick="retakeMealPhotoFromPreview()" style="position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:14px 28px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:13; transition:transform 0.2s;">
        Retake
    </button>
</div>

<!-- ===== NATIVE PERMISSIONS REQUEST MODAL ===== -->
<div class="permissions-overlay" id="native-permissions-modal" style="display:none;">
    <div class="permissions-modal">
        <div style="text-align:center; font-size:2.5rem; margin-bottom:10px;">🔐</div>
        <h2>Enable App Features</h2>
        <p class="perm-subtitle">Balance works best with these permissions. You can change these any time in your device settings.</p>

        <!-- Camera -->
        <div class="perm-card" id="perm-card-camera">
            <div class="perm-card-icon" style="background:#dbeafe;">📷</div>
            <div class="perm-card-info">
                <h4>Camera</h4>
                <p>Take meal photos, progress pics &amp; scan barcodes</p>
            </div>
            <button class="perm-card-btn" id="perm-btn-camera" onclick="requestPermCamera()">Allow</button>
        </div>

        <!-- Microphone -->
        <div class="perm-card" id="perm-card-mic">
            <div class="perm-card-icon" style="background:#fce7f3;">🎙️</div>
            <div class="perm-card-info">
                <h4>Microphone</h4>
                <p>Voice-log your meals hands-free</p>
            </div>
            <button class="perm-card-btn" id="perm-btn-mic" onclick="requestPermMic()">Allow</button>
        </div>

        <!-- Health Data -->
        <div class="perm-card" id="perm-card-health">
            <div class="perm-card-icon" style="background:#dcfce7;">❤️</div>
            <div class="perm-card-info">
                <h4>Health Data</h4>
                <p>Sync steps, heart rate, sleep &amp; workouts</p>
            </div>
            <button class="perm-card-btn" id="perm-btn-health" onclick="requestPermHealth()">Allow</button>
        </div>

        <!-- Location -->
        <div class="perm-card" id="perm-card-location">
            <div class="perm-card-icon" style="background:#e0f2fe;">📍</div>
            <div class="perm-card-info">
                <h4>Location</h4>
                <p>Local weather conditions on your dashboard</p>
            </div>
            <button class="perm-card-btn" id="perm-btn-location" onclick="requestPermLocation()">Allow</button>
        </div>

        <!-- Notifications -->
        <div class="perm-card" id="perm-card-notif">
            <div class="perm-card-icon" style="background:#fef3c7;">🔔</div>
            <div class="perm-card-info">
                <h4>Notifications</h4>
                <p>Meal reminders, coach messages &amp; FitGotchi alerts</p>
            </div>
            <button class="perm-card-btn" id="perm-btn-notif" onclick="requestPermNotif()">Allow</button>
        </div>

        <button class="perm-continue-btn" onclick="closePermissionsModal()">Continue</button>
        <button class="perm-skip-btn" onclick="closePermissionsModal()">I'll do this later</button>
    </div>
</div>

<!-- Generic Camera Modal (getUserMedia camera for photos - used by workout, story, activity, progress, meal) -->
<div id="workout-camera-modal" style="display:none; position:fixed; inset:0; background:#000; z-index:10014; flex-direction:column;">
    <!-- Close button -->
    <button onclick="closeWorkoutCamera()" style="position:absolute; top:52px; right:16px; background:rgba(0,0,0,0.5); border:none; color:white; width:48px; height:48px; border-radius:50%; font-size:1.8rem; cursor:pointer; z-index:5; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center;">&times;</button>
    <!-- Label (dynamic - updated by openWorkoutCamera) -->
    <div style="position:absolute; top:52px; left:0; right:0; z-index:4; text-align:center; pointer-events:none;">
        <span id="generic-camera-label" style="background:rgba(0,0,0,0.5); color:#fff; padding:8px 20px; border-radius:20px; font-size:0.9rem; font-weight:600; backdrop-filter:blur(10px);">Take a photo</span>
    </div>
    <!-- Live camera feed -->
    <style>
        #workout-camera-video::-webkit-media-controls,
        #workout-camera-video::-webkit-media-controls-start-playback-button,
        #workout-camera-video::-webkit-media-controls-panel,
        #workout-camera-video::-webkit-media-controls-overlay-play-button {
            display: none !important;
            -webkit-appearance: none;
        }
    </style>
    <video id="workout-camera-video" autoplay playsinline webkit-playsinline muted style="width:100%; height:100%; object-fit:cover; background:#000; opacity:0; transition:opacity 0.15s ease;"></video>
    <canvas id="workout-camera-canvas" style="display:none;"></canvas>
    <!-- Bottom controls -->
    <div style="position:absolute; bottom:0; left:0; right:0; z-index:3; padding:20px 20px 40px; background:linear-gradient(transparent, rgba(0,0,0,0.8) 40%);">
        <div style="display:flex; align-items:center; justify-content:center; gap:24px;">
            <!-- Spacer -->
            <div style="width:50px;"></div>
            <!-- Capture button -->
            <button onclick="captureWorkoutPhoto()" style="width:72px; height:72px; border-radius:50%; border:4px solid white; background:rgba(255,255,255,0.2); cursor:pointer; backdrop-filter:blur(10px); position:relative; transition:transform 0.15s;" id="workout-capture-btn">
                <div style="width:56px; height:56px; border-radius:50%; background:white; margin:auto; transition:transform 0.15s;"></div>
            </button>
            <!-- Flip camera -->
            <button onclick="flipWorkoutCamera()" style="background:rgba(255,255,255,0.15); border:none; color:#fff; width:50px; height:50px; border-radius:50%; cursor:pointer; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center;" title="Flip camera">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 16V7a2 2 0 00-2-2H6"></path>
                    <polyline points="14 5 20 5 20 11"></polyline>
                    <path d="M4 8v9a2 2 0 002 2h12"></path>
                    <polyline points="10 19 4 19 4 13"></polyline>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Unified Camera Modal (Photo + Barcode) -->
<div id="unified-camera-modal" style="display:none; position:fixed; inset:0; background:#000; z-index:10013; flex-direction:column;">
    <!-- Close button -->
    <button onclick="closeUnifiedCamera()" style="position:absolute; top:52px; right:16px; background:rgba(0,0,0,0.5); border:none; color:white; width:48px; height:48px; border-radius:50%; font-size:1.8rem; cursor:pointer; z-index:5; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center;">&times;</button>
    <!-- Barcode detected banner (hidden by default) -->
    <div id="barcode-detected-banner" style="display:none; position:absolute; top:0; left:0; right:0; z-index:4; padding:14px 20px; background:linear-gradient(135deg, #22c55e, #16a34a); color:#fff; text-align:center; animation:fadeInUp 0.3s ease-out;">
        <div style="font-weight:700; font-size:1rem;" id="barcode-detected-name">Product found!</div>
        <div style="font-size:0.85rem; opacity:0.9; margin-top:2px;" id="barcode-detected-detail"></div>
        <button onclick="showBarcodeResult()" style="margin-top:8px; background:rgba(255,255,255,0.25); color:#fff; border:none; border-radius:20px; padding:8px 24px; font-weight:600; font-size:0.9rem; cursor:pointer; backdrop-filter:blur(5px);">View & Log Product</button>
    </div>
    <!-- Live camera feed -->
    <style>
        /* Hide default Android WebView play button overlay on camera video */
        #unified-camera-video::-webkit-media-controls,
        #unified-camera-video::-webkit-media-controls-start-playback-button,
        #unified-camera-video::-webkit-media-controls-panel,
        #unified-camera-video::-webkit-media-controls-overlay-play-button {
            display: none !important;
            -webkit-appearance: none;
        }
    </style>
    <video id="unified-camera-video" autoplay playsinline webkit-playsinline muted style="width:100%; height:100%; object-fit:cover; background:#000; opacity:0; transition:opacity 0.15s ease;"></video>
    <!-- Hidden canvas for photo capture -->
    <canvas id="unified-camera-canvas" style="display:none;"></canvas>
    <!-- Hidden element for html5-qrcode barcode scanning -->
    <div id="barcode-reader" style="position:absolute; top:0; left:0; width:1px; height:1px; overflow:hidden; opacity:0;"></div>
    <!-- Bottom controls -->
    <div style="position:absolute; bottom:0; left:0; right:0; z-index:3; padding:20px; background:linear-gradient(transparent, rgba(0,0,0,0.8) 40%);">
        <!-- Food description input -->
        <div style="margin-bottom:14px;">
            <input type="text" id="unified-camera-description" placeholder="What is this? (optional)" style="width:100%; max-width:500px; margin:0 auto; display:block; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2); border-radius:15px; color:white; padding:12px 18px; font-size:0.95rem; backdrop-filter:blur(10px); font-family:inherit; outline:none; box-sizing:border-box;" />
        </div>
        <!-- Capture + barcode manual row -->
        <div style="display:flex; align-items:center; justify-content:center; gap:16px;">
            <!-- Manual barcode button -->
            <button onclick="showManualBarcodeEntry()" id="manual-barcode-btn" style="background:rgba(255,255,255,0.15); border:none; color:#fff; width:50px; height:50px; border-radius:50%; cursor:pointer; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center;" title="Type barcode">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                    <line x1="6" y1="8" x2="6" y2="16"></line>
                    <line x1="10" y1="8" x2="10" y2="16"></line>
                    <line x1="14" y1="8" x2="14" y2="16"></line>
                    <line x1="18" y1="8" x2="18" y2="16"></line>
                </svg>
            </button>
            <!-- Capture photo button -->
            <button onclick="captureUnifiedPhoto()" style="width:72px; height:72px; border-radius:50%; border:4px solid white; background:rgba(255,255,255,0.2); cursor:pointer; backdrop-filter:blur(10px); position:relative; transition:transform 0.15s;" id="unified-capture-btn">
                <div style="width:56px; height:56px; border-radius:50%; background:white; margin:auto; transition:transform 0.15s;"></div>
            </button>
            <!-- Flip camera button -->
            <button onclick="flipUnifiedCamera()" style="background:rgba(255,255,255,0.15); border:none; color:#fff; width:50px; height:50px; border-radius:50%; cursor:pointer; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center;" title="Flip camera">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 16V7a2 2 0 00-2-2H6"></path>
                    <polyline points="14 5 20 5 20 11"></polyline>
                    <path d="M4 8v9a2 2 0 002 2h12"></path>
                    <polyline points="10 19 4 19 4 13"></polyline>
                </svg>
            </button>
        </div>
        <!-- Manual barcode input (hidden by default) -->
        <div id="manual-barcode-row" style="display:none; margin-top:12px; gap:10px; align-items:center;">
            <input type="text" id="barcode-manual-input" inputmode="numeric" pattern="[0-9]*" placeholder="Enter barcode number..." style="flex:1; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2); border-radius:12px; color:#fff; padding:12px 16px; font-size:1rem; font-family:inherit; outline:none;" />
            <button onclick="lookupManualBarcode()" style="background:var(--primary); color:#fff; border:none; border-radius:12px; padding:12px 20px; font-weight:600; cursor:pointer; white-space:nowrap;">Look Up</button>
        </div>
        <!-- Scanning indicator -->
        <div style="text-align:center; margin-top:10px;">
            <span id="barcode-scan-status" style="color:rgba(255,255,255,0.5); font-size:0.8rem;">Scanning for barcodes automatically...</span>
        </div>
    </div>
</div>

<!-- Barcode Result Modal -->
<div id="barcode-result-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:10014; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
    <div style="background:var(--card-bg, #1e1e2e); border-radius:20px; max-width:420px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <!-- Product header -->
        <div style="padding:24px 24px 16px;">
            <div style="display:flex; align-items:flex-start; gap:16px;">
                <img id="barcode-product-image" src="" alt="" style="width:80px; height:80px; border-radius:12px; object-fit:cover; background:#2a2a3e; display:none;" />
                <div style="flex:1; min-width:0;">
                    <h3 id="barcode-product-name" style="margin:0 0 4px; color:var(--text-main, #fff); font-size:1.15rem; line-height:1.3;"></h3>
                    <p id="barcode-product-brand" style="margin:0; color:var(--text-muted, #888); font-size:0.9rem;"></p>
                    <p id="barcode-product-quantity" style="margin:4px 0 0; color:var(--text-muted, #888); font-size:0.85rem;"></p>
                </div>
            </div>
        </div>
        <!-- Amount selector (servings or custom g/ml) -->
        <div id="barcode-serving-section" style="padding:0 24px 16px;">
            <!-- Mode toggle -->
            <div style="display:flex; gap:0; margin-bottom:10px; background:rgba(255,255,255,0.06); border-radius:10px; overflow:hidden;">
                <button id="barcode-mode-servings" onclick="setBarcodeAmountMode('servings')" style="flex:1; padding:9px 0; border:none; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s; background:var(--primary); color:#fff;">Servings</button>
                <button id="barcode-mode-custom" onclick="setBarcodeAmountMode('custom')" style="flex:1; padding:9px 0; border:none; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s; background:transparent; color:var(--text-muted, #888);">Custom (g/ml)</button>
            </div>
            <!-- Servings row -->
            <div id="barcode-servings-row" style="display:flex; align-items:center; gap:12px;">
                <button onclick="adjustBarcodeServings(-0.5)" style="background:rgba(255,255,255,0.1); border:none; color:#fff; width:36px; height:36px; border-radius:50%; font-size:1.2rem; cursor:pointer;">&minus;</button>
                <span id="barcode-servings-display" style="color:#fff; font-size:1.1rem; font-weight:600; min-width:30px; text-align:center;">1</span>
                <button onclick="adjustBarcodeServings(0.5)" style="background:rgba(255,255,255,0.1); border:none; color:#fff; width:36px; height:36px; border-radius:50%; font-size:1.2rem; cursor:pointer;">+</button>
                <span id="barcode-serving-size-label" style="color:var(--text-muted, #888); font-size:0.85rem;"></span>
            </div>
            <!-- Custom amount row -->
            <div id="barcode-custom-row" style="display:none; align-items:center; gap:10px;">
                <input type="number" id="barcode-custom-amount" inputmode="decimal" placeholder="e.g. 150" min="0" step="any" oninput="onBarcodeCustomAmountChange()" style="flex:1; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); border-radius:12px; color:#fff; padding:11px 14px; font-size:1.05rem; font-family:inherit; outline:none; -moz-appearance:textfield;" />
                <span id="barcode-custom-unit" style="color:var(--text-muted, #aaa); font-size:0.95rem; min-width:20px;">g</span>
                <span id="barcode-custom-hint" style="color:var(--text-muted, #666); font-size:0.8rem; white-space:nowrap;"></span>
            </div>
        </div>
        <!-- Nutrition breakdown -->
        <div style="padding:0 24px 16px;">
            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
                <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:14px; text-align:center;">
                    <div id="barcode-calories" style="font-size:1.5rem; font-weight:700; color:#22c55e;">0</div>
                    <div style="font-size:0.75rem; color:var(--text-muted, #888); margin-top:2px;">Calories</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:14px; text-align:center;">
                    <div id="barcode-protein" style="font-size:1.5rem; font-weight:700; color:#3b82f6;">0g</div>
                    <div style="font-size:0.75rem; color:var(--text-muted, #888); margin-top:2px;">Protein</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:14px; text-align:center;">
                    <div id="barcode-carbs" style="font-size:1.5rem; font-weight:700; color:#f59e0b;">0g</div>
                    <div style="font-size:0.75rem; color:var(--text-muted, #888); margin-top:2px;">Carbs</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:14px; text-align:center;">
                    <div id="barcode-fat" style="font-size:1.5rem; font-weight:700; color:#ef4444;">0g</div>
                    <div style="font-size:0.75rem; color:var(--text-muted, #888); margin-top:2px;">Fat</div>
                </div>
            </div>
            <!-- Extra nutrients -->
            <div id="barcode-extra-nutrients" style="margin-top:10px; display:grid; grid-template-columns:repeat(3,1fr); gap:8px;"></div>
        </div>
        <!-- Action buttons -->
        <div style="padding:0 24px 24px; display:flex; gap:12px;">
            <button onclick="closeBarcodeResult()" style="flex:1; background:rgba(255,255,255,0.1); color:#fff; border:none; border-radius:14px; padding:14px; font-weight:600; font-size:1rem; cursor:pointer;">Cancel</button>
            <button onclick="logBarcodeAsMeal()" style="flex:2; background:var(--primary); color:#fff; border:none; border-radius:14px; padding:14px; font-weight:600; font-size:1rem; cursor:pointer; box-shadow:0 4px 15px rgba(123,168,131,0.3);">Log Meal</button>
        </div>
    </div>
</div>

<!-- Meal Input Modal (Photo/Text/Voice selector) -->
<div id="meal-input-modal" class="meal-input-modal">
    <div class="meal-input-container">
        <!-- Header -->
        <div class="meal-input-header">
            <h3>Log a Meal</h3>
            <button class="meal-input-close" onclick="closeMealInputModal()">&times;</button>
        </div>

        <!-- Meal Type Selector -->
        <div class="meal-type-selector">
            <button class="meal-type-btn active" data-type="breakfast" onclick="selectMealType('breakfast')">
                <span class="meal-type-emoji">🌅</span>
                <span class="meal-type-label">Breakfast</span>
            </button>
            <button class="meal-type-btn" data-type="lunch" onclick="selectMealType('lunch')">
                <span class="meal-type-emoji">☀️</span>
                <span class="meal-type-label">Lunch</span>
            </button>
            <button class="meal-type-btn" data-type="dinner" onclick="selectMealType('dinner')">
                <span class="meal-type-emoji">🌙</span>
                <span class="meal-type-label">Dinner</span>
            </button>
            <button class="meal-type-btn" data-type="snack" onclick="selectMealType('snack')">
                <span class="meal-type-emoji">🍎</span>
                <span class="meal-type-label">Snack</span>
            </button>
        </div>

        <!-- Input Method Buttons -->
        <div class="meal-input-methods" id="meal-input-methods">
            <button class="input-method-btn" onclick="selectInputMethod('photo')">
                <div class="input-method-icon photo">📸</div>
                <div class="input-method-info">
                    <div class="input-method-title">Take a Photo</div>
                    <div class="input-method-desc">Snap your meal for instant analysis</div>
                </div>
            </button>
            <button class="input-method-btn" onclick="selectInputMethod('text')">
                <div class="input-method-icon text">📝</div>
                <div class="input-method-info">
                    <div class="input-method-title">Type It In</div>
                    <div class="input-method-desc">Describe what you ate</div>
                </div>
            </button>
            <button class="input-method-btn" onclick="selectInputMethod('voice')">
                <div class="input-method-icon voice">🎤</div>
                <div class="input-method-info">
                    <div class="input-method-title">Voice Input</div>
                    <div class="input-method-desc">Say what you had</div>
                </div>
            </button>
        </div>

        <!-- Text Input Section (hidden by default) -->
        <div class="meal-text-section" id="meal-text-section">
            <textarea
                id="meal-text-input"
                class="meal-text-input"
                placeholder="What did you eat? Be as specific as you can about portions..."
                maxlength="500"
            ></textarea>
            <div class="meal-text-examples">
                <p>Examples:</p>
                <ul>
                    <li>"2 scrambled eggs, 2 slices whole wheat toast with butter, orange juice"</li>
                    <li>"Large bowl of oatmeal with banana and almonds"</li>
                    <li>"Chipotle burrito bowl with chicken, rice, beans, guac"</li>
                </ul>
            </div>
        </div>

        <!-- Voice Input Section (hidden by default) -->
        <div class="meal-voice-section" id="meal-voice-section">
            <p class="voice-status" id="voice-status">Tap the microphone and describe your meal</p>
            <button class="voice-record-btn" id="voice-record-btn" onclick="toggleVoiceRecording()">
                🎤
            </button>
            <div class="voice-transcript-wrapper">
                <div class="voice-transcript empty" id="voice-transcript">
                    Your spoken words will appear here...
                </div>
                <button class="voice-transcript-delete" id="voice-transcript-delete" onclick="clearVoiceTranscript()" style="display: none;">
                    Delete
                </button>
            </div>
        </div>

        <!-- Submit Button (for text/voice) -->
        <div class="meal-submit-section" id="meal-submit-section">
            <button class="meal-submit-btn" id="meal-submit-btn" onclick="submitMealDescription()" disabled>
                Analyze My Meal
            </button>
        </div>
    </div>
</div>

<!-- Simple Text Input Modal -->
<div id="meal-text-modal" class="meal-text-modal">
    <div class="meal-text-modal-container">
        <div class="meal-text-modal-header">
            <h3>What did you eat?</h3>
            <button class="meal-text-modal-close" onclick="closeMealTextModal()">&times;</button>
        </div>
        <div class="simple-meal-type-row" id="simple-meal-type-row">
            <button class="simple-meal-type-bubble active" data-type="breakfast" onclick="selectSimpleMealType('breakfast')">Breakfast</button>
            <button class="simple-meal-type-bubble" data-type="lunch" onclick="selectSimpleMealType('lunch')">Lunch</button>
            <button class="simple-meal-type-bubble" data-type="dinner" onclick="selectSimpleMealType('dinner')">Dinner</button>
            <button class="simple-meal-type-bubble" data-type="snack" onclick="selectSimpleMealType('snack')">Snack</button>
        </div>
        <textarea
            id="simple-meal-input"
            class="simple-meal-textarea"
            placeholder="e.g., 2 eggs, toast with butter, orange juice..."
        ></textarea>
        <button class="simple-meal-submit" id="simple-meal-submit" onclick="submitSimpleMealText()" disabled>
            Analyze My Meal
        </button>
    </div>
</div>

<!-- Recent Meals Modal -->
<div id="recent-meals-modal" class="recent-meals-modal" onclick="if(event.target===this)closeRecentMealsModal()">
    <div class="recent-meals-container">
        <div class="recent-meals-header">
            <h3 id="recent-meals-title">Recent Meals</h3>
            <button class="recent-meals-close" onclick="closeRecentMealsModal()">&times;</button>
        </div>
        <div class="recent-meals-list" id="recent-meals-list">
            <div class="recent-meals-empty">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <p>No recent meals yet.<br><span style="font-size: 0.85rem;">Your logged meals will appear here.</span></p>
            </div>
        </div>
        <div class="recent-meal-confirm" id="recent-meal-confirm">
            <div class="recent-meal-confirm-info">
                <div class="recent-meal-confirm-name" id="recent-meal-confirm-name"></div>
                <div class="recent-meal-confirm-macros" id="recent-meal-confirm-macros"></div>
            </div>
            <div class="recent-meal-confirm-btns">
                <button class="recent-meal-btn-photo" onclick="recentMealAddWithPhoto()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    Add with Photo <span class="xp-badge">+1 XP</span>
                </button>
                <button class="recent-meal-btn-quick" onclick="recentMealQuickAdd()">
                    Quick Add (No Photo)
                </button>
            </div>
            <div class="recent-meal-confirm-back">
                <button onclick="showRecentMealsList()">Back to list</button>
            </div>
        </div>
    </div>
</div>

<!-- Workout Photo Preview Modal -->
<div id="workout-preview-modal" style="display:none; position:fixed; inset:0; background:black; z-index:10012; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Photo Preview -->
    <img id="workout-preview-photo" style="width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0;">

    <!-- Close Button -->
    <button onclick="closeWorkoutPreviewModal()" style="position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:13; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Loading Indicator -->
    <div id="workout-photo-loading" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); padding:30px 40px; border-radius:20px; z-index:14; text-align:center;">
        <div style="width:50px; height:50px; border:4px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 15px;"></div>
        <div id="workout-photo-loading-text" style="color:white; font-size:1rem;">Verifying workout...</div>
    </div>

    <!-- Error Message -->
    <div id="workout-photo-error" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(220,38,38,0.9); padding:25px 35px; border-radius:16px; z-index:14; text-align:center; max-width:80%;">
        <div style="color:white; font-size:1rem; font-weight:600;" id="workout-photo-error-text">Error</div>
        <button onclick="document.getElementById('workout-photo-error').style.display='none'" style="margin-top:15px; background:white; color:#dc2626; border:none; padding:10px 25px; border-radius:20px; font-weight:600; cursor:pointer;">OK</button>
    </div>

    <!-- Verify Button -->
    <button onclick="verifyWorkoutPhoto()" id="workout-verify-btn" style="position:absolute; bottom:40px; right:30px; background:var(--primary); color:white; padding:14px 35px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.6); z-index:13; transition:transform 0.2s;">
        Verify Workout
    </button>

    <!-- Cancel Button -->
    <button onclick="closeWorkoutPreviewModal()" style="position:absolute; bottom:40px; left:30px; background:rgba(255,255,255,0.2); color:white; padding:14px 28px; border:none; border-radius:25px; font-weight:600; font-size:1.1rem; cursor:pointer; backdrop-filter:blur(10px); z-index:13; transition:transform 0.2s;">
        Cancel
    </button>
</div>

<!-- Story Upload Modal -->
<div id="story-upload-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10007; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <div style="width:90%; max-width:500px; background:white; border-radius:20px; overflow:hidden;">
        <!-- Header -->
        <div style="padding:20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:var(--primary);">Create a Post</h3>
            <button onclick="closeStoryUploadModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>

        <!-- Preview Area -->
        <div id="story-preview-area" style="padding:30px; text-align:center; min-height:300px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#f8fafc;">
            <div id="story-preview-placeholder" style="color:var(--text-muted);">
                <svg viewBox="0 0 24 24" style="width:80px; height:80px; fill:var(--text-muted); margin-bottom:15px;">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <p style="font-size:0.9rem;">Select a photo or video to share</p>
            </div>
            <img id="story-preview-image" src="" style="display:none; max-width:100%; max-height:400px; border-radius:12px; object-fit:contain;">
            <video id="story-preview-video" controls style="display:none; max-width:100%; max-height:400px; border-radius:12px;"></video>
        </div>

        <!-- Caption Input -->
        <div style="padding:20px; border-top:1px solid #e5e7eb;">
            <textarea id="story-caption-input" placeholder="Add a caption (optional)..." style="width:100%; min-height:60px; padding:12px; border:1px solid #e5e7eb; border-radius:10px; font-size:0.9rem; resize:vertical; font-family:inherit;"></textarea>
        </div>

        <!-- Actions -->
        <div style="padding:0 20px 20px 20px; display:flex; gap:10px;">
            <label for="story-file-input" style="flex:1; padding:14px; background:var(--secondary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; text-align:center; transition:all 0.2s;">
                Choose Photo/Video
            </label>
            <input type="file" id="story-file-input" accept="image/*,video/*" capture="environment" style="display:none;" onchange="handleStoryFileSelect(event)">

            <button id="story-upload-button" onclick="uploadStory()" disabled style="flex:1; padding:14px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; transition:all 0.2s; opacity:0.5;">
                Share Post
            </button>
        </div>
    </div>
</div>

<!-- Story Viewer Modal -->
<div id="story-viewer-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.98); z-index:10008; flex-direction:column; align-items:center; justify-content:center;">
    <!-- Close Button -->
    <button onclick="closeStoryViewer()" style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.5rem; z-index:10009; backdrop-filter:blur(10px);">
        &times;
    </button>

    <!-- Story Header -->
    <div id="story-viewer-header" style="position:absolute; top:0; left:0; right:0; padding:20px; display:flex; align-items:center; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 100%); z-index:10009;">
        <div id="story-user-avatar" onclick="openStoryUserProfile()" style="width:40px; height:40px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:600; overflow:hidden; cursor:pointer;">

        </div>
        <div onclick="openStoryUserProfile()" style="flex:1; cursor:pointer;">
            <div id="story-user-name" style="color:white; font-weight:600; font-size:0.95rem;"></div>
            <div id="story-timestamp" style="color:rgba(255,255,255,0.8); font-size:0.75rem;"></div>
        </div>

        <!-- Delete button (only show for own stories) -->
        <button id="story-delete-button" onclick="deleteCurrentStory()" style="display:none; background:rgba(239,68,68,0.9); border:none; color:white; padding:8px 16px; border-radius:20px; cursor:pointer; font-size:0.85rem; font-weight:600;">
            Delete
        </button>
    </div>

    <!-- Progress Bars -->
    <div id="story-progress-bars" style="position:absolute; top:0; left:0; right:0; padding:15px 20px; display:flex; gap:4px; z-index:10009;">
        <!-- Progress bars will be injected here -->
    </div>

    <!-- Story Content -->
    <div id="story-content-container" style="width:100%; max-width:500px; height:100%; display:flex; align-items:center; justify-content:center; position:relative;">
        <img id="story-image" src="" style="max-width:100%; max-height:100%; object-fit:contain; border-radius:0;">
        <video id="story-video" playsinline style="display:none; max-width:100%; max-height:100%; object-fit:contain; border-radius:0;"></video>
        <div id="story-caption-overlay" style="position:absolute; bottom:60px; left:0; right:0; padding:20px; background:linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%); color:white; font-size:0.9rem; text-align:center; display:none;">
        </div>
    </div>

    <!-- Navigation Areas (tap left/right to navigate) -->
    <div onclick="previousStory()" style="position:absolute; left:0; top:0; bottom:0; width:30%; z-index:10009; cursor:pointer;"></div>
    <div onclick="nextStory()" style="position:absolute; right:0; top:0; bottom:0; width:70%; z-index:10009; cursor:pointer;"></div>

    <!-- Story Viewers List (bottom section - only show for own stories) -->
    <div id="story-viewers-section" style="display:none; position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.9); padding:20px; max-height:40%; overflow-y:auto; z-index:10009;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h4 style="margin:0; color:white; font-size:0.95rem;">Viewers</h4>
            <span id="story-view-count" style="color:rgba(255,255,255,0.7); font-size:0.85rem;"></span>
        </div>
        <div id="story-viewers-list">
            <!-- Viewers will be injected here -->
        </div>
    </div>
</div>

<script src="js/dashboard/dashboard-script-8-progress_analytics_view.js"></script>


<script src="js/dashboard/dashboard-script-9-hormone_hub_superboost_engine.js"></script>


<script src="js/dashboard/dashboard-script-10-points_widget_functions.js"></script>


<script src="js/dashboard/dashboard-script-11-calorie_tracker_functions.js"></script>



<!-- Preference Wizard Modal -->
<div class="pref-wizard-overlay" id="pref-wizard-overlay">
    <div class="pref-wizard-modal">
        <div class="pref-wizard-header">
            <h2 id="pref-wizard-title">Customize Your Plan</h2>
            <p id="pref-wizard-subtitle">Tell us about your preferences</p>
            <div class="pref-wizard-progress">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
            </div>
        </div>
        <div class="pref-wizard-body">
            <!-- Step 1: Diet Type -->
            <div class="pref-wizard-step active" data-step="1">
                <h3>What's your diet preference?</h3>
                <div class="pref-option-grid">
                    <div class="pref-option" data-value="vegan" onclick="selectPrefOption(this, 'diet')">
                        <div class="option-icon">🌱</div>
                        <div class="option-label">Vegan</div>
                        <div class="option-desc">100% plant-based</div>
                    </div>
                    <div class="pref-option" data-value="vegetarian" onclick="selectPrefOption(this, 'diet')">
                        <div class="option-icon">🥚</div>
                        <div class="option-label">Vegetarian</div>
                        <div class="option-desc">Includes eggs & dairy</div>
                    </div>
                    <div class="pref-option" data-value="pescatarian" onclick="selectPrefOption(this, 'diet')">
                        <div class="option-icon">🐟</div>
                        <div class="option-label">Pescatarian</div>
                        <div class="option-desc">Includes fish & seafood</div>
                    </div>
                    <div class="pref-option" data-value="omnivore" onclick="selectPrefOption(this, 'diet')">
                        <div class="option-icon">🍗</div>
                        <div class="option-label">Omnivore</div>
                        <div class="option-desc">All food groups</div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Allergies/Restrictions -->
            <div class="pref-wizard-step" data-step="2">
                <h3>Any allergies or restrictions?</h3>
                <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px; font-size: 0.9rem;">Select all that apply (or skip if none)</p>
                <div class="pref-checkbox-list" style="justify-content: center;">
                    <div class="pref-checkbox" data-value="gluten" onclick="togglePrefCheckbox(this)">🌾 Gluten-Free</div>
                    <div class="pref-checkbox" data-value="dairy" onclick="togglePrefCheckbox(this)">🥛 Dairy-Free</div>
                    <div class="pref-checkbox" data-value="nuts" onclick="togglePrefCheckbox(this)">🥜 Nut-Free</div>
                    <div class="pref-checkbox" data-value="soy" onclick="togglePrefCheckbox(this)">🫘 Soy-Free</div>
                    <div class="pref-checkbox" data-value="eggs" onclick="togglePrefCheckbox(this)">🥚 Egg-Free</div>
                    <div class="pref-checkbox" data-value="fodmap" onclick="togglePrefCheckbox(this)">🍎 Low FODMAP</div>
                </div>
            </div>

            <!-- Step 3: Cooking Preference -->
            <div class="pref-wizard-step" data-step="3">
                <h3>How much time for cooking?</h3>
                <div class="pref-option-grid">
                    <div class="pref-option" data-value="quick" onclick="selectPrefOption(this, 'time')">
                        <div class="option-icon">⚡</div>
                        <div class="option-label">Quick</div>
                        <div class="option-desc">Under 20 mins</div>
                    </div>
                    <div class="pref-option" data-value="moderate" onclick="selectPrefOption(this, 'time')">
                        <div class="option-icon">⏱️</div>
                        <div class="option-label">Moderate</div>
                        <div class="option-desc">20-40 mins</div>
                    </div>
                    <div class="pref-option" data-value="any" onclick="selectPrefOption(this, 'time')" style="grid-column: span 2;">
                        <div class="option-icon">👨‍🍳</div>
                        <div class="option-label">I Love Cooking</div>
                        <div class="option-desc">Any prep time is fine</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="pref-wizard-footer">
            <button class="pref-wizard-btn secondary" id="pref-wizard-back" onclick="prefWizardBack()">Back</button>
            <button class="pref-wizard-btn primary" id="pref-wizard-next" onclick="prefWizardNext()" disabled>Next</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// PREFERENCE WIZARD LOGIC
// ============================================================

let prefWizardState = {
    currentStep: 1,
    totalSteps: 3,
    planSlug: null,
    preferences: {
        diet: null,
        allergies: [],
        cookingTime: null
    }
};

function openPreferenceWizard(planSlug) {
    prefWizardState = {
        currentStep: 1,
        totalSteps: 3,
        planSlug: planSlug,
        preferences: {
            diet: null,
            allergies: [],
            cookingTime: null
        }
    };

    // Update title with plan name
    const planNames = {
        'summer-shred': 'Summer Shred',
        'clean-bulk': 'Clean Bulk',
        'energy-boost': 'Energy Boost',
        'gut-reset': 'Gut Reset',
        'quick-easy': 'Quick & Easy'
    };
    document.getElementById('pref-wizard-title').textContent = planNames[planSlug] || 'Customize Your Plan';

    // Reset UI
    updatePrefWizardStep(1);
    clearPrefSelections();

    // Show modal
    document.getElementById('pref-wizard-overlay').classList.add('active');
}

function closePrefWizard() {
    document.getElementById('pref-wizard-overlay').classList.remove('active');
}

function updatePrefWizardStep(step) {
    prefWizardState.currentStep = step;

    // Update step dots
    document.querySelectorAll('.pref-wizard-progress .step-dot').forEach(dot => {
        const dotStep = parseInt(dot.dataset.step);
        dot.classList.remove('active', 'completed');
        if (dotStep === step) {
            dot.classList.add('active');
        } else if (dotStep < step) {
            dot.classList.add('completed');
        }
    });

    // Update step content
    document.querySelectorAll('.pref-wizard-step').forEach(stepEl => {
        stepEl.classList.remove('active');
        if (parseInt(stepEl.dataset.step) === step) {
            stepEl.classList.add('active');
        }
    });

    // Update buttons
    const backBtn = document.getElementById('pref-wizard-back');
    const nextBtn = document.getElementById('pref-wizard-next');

    backBtn.style.visibility = step === 1 ? 'hidden' : 'visible';
    nextBtn.textContent = step === prefWizardState.totalSteps ? 'Continue to Checkout' : 'Next';

    // Update next button state
    updatePrefNextButton();
}

function updatePrefNextButton() {
    const nextBtn = document.getElementById('pref-wizard-next');
    const step = prefWizardState.currentStep;

    let isValid = false;
    if (step === 1) {
        isValid = prefWizardState.preferences.diet !== null;
    } else if (step === 2) {
        isValid = true; // Allergies are optional
    } else if (step === 3) {
        isValid = prefWizardState.preferences.cookingTime !== null;
    }

    nextBtn.disabled = !isValid;
}

function selectPrefOption(el, type) {
    // Remove selected from siblings
    el.parentElement.querySelectorAll('.pref-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');

    // Store value
    if (type === 'diet') {
        prefWizardState.preferences.diet = el.dataset.value;
    } else if (type === 'time') {
        prefWizardState.preferences.cookingTime = el.dataset.value;
    }

    updatePrefNextButton();
}

function togglePrefCheckbox(el) {
    el.classList.toggle('selected');

    // Update allergies array
    const value = el.dataset.value;
    const idx = prefWizardState.preferences.allergies.indexOf(value);
    if (idx > -1) {
        prefWizardState.preferences.allergies.splice(idx, 1);
    } else {
        prefWizardState.preferences.allergies.push(value);
    }
}

function clearPrefSelections() {
    document.querySelectorAll('.pref-option, .pref-checkbox').forEach(el => el.classList.remove('selected'));
}

function prefWizardBack() {
    if (prefWizardState.currentStep > 1) {
        updatePrefWizardStep(prefWizardState.currentStep - 1);
    }
}

function prefWizardNext() {
    if (prefWizardState.currentStep < prefWizardState.totalSteps) {
        updatePrefWizardStep(prefWizardState.currentStep + 1);
    } else {
        // Complete - proceed to checkout
        completePrefWizard();
    }
}

function completePrefWizard() {
    // Store preferences
    localStorage.setItem('selected_meal_plan', prefWizardState.planSlug);
    localStorage.setItem('user_food_preferences', JSON.stringify(prefWizardState.preferences));

    closePrefWizard();

    // Proceed to Stripe checkout
    initiateMealPlanCheckout(prefWizardState.planSlug, prefWizardState.preferences);
}

async function initiateMealPlanCheckout(planSlug, preferences) {
    // Native app (App Store / Play Store): use IAP
    if (window.Platform && window.Platform.isNative()) {
        try {
            const result = await purchaseMealPlan(planSlug, preferences);
            if (result && !result.cancelled) {
                showToast('Meal plan unlocked!', 'success');
            }
        } catch (error) {
            console.error('IAP meal plan error:', error);
            alert('Purchase failed. Please try again.');
        }
        return;
    }

    // Web (website): use Stripe
    // Show loading state
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'checkout-loading';
    loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10001;';
    loadingDiv.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 16px; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 15px;">🍽️</div>
            <p style="color: var(--primary); font-weight: 600;">Preparing your checkout...</p>
        </div>
    `;
    document.body.appendChild(loadingDiv);

    try {
        // Get user email if logged in
        const userEmail = window.currentUser?.email || localStorage.getItem('user_email') || null;
        const userId = window.currentUser?.id || localStorage.getItem('user_id') || null;

        // Call the Stripe checkout endpoint
        const response = await fetch('/api/create-meal-plan-checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                planSlug: planSlug,
                email: userEmail,
                userId: userId,
                preferences: preferences
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error?.message || 'Failed to create checkout session');
        }

        // Remove loading
        loadingDiv.remove();

        // Redirect to Stripe checkout
        if (data.url) {
            // Direct URL redirect (preferred)
            window.location.href = data.url;
        } else if (data.sessionId) {
            // Use Stripe.js to redirect (fallback)
            const stripe = Stripe(window.STRIPE_PUBLIC_KEY || 'pk_live_your_key');
            await stripe.redirectToCheckout({ sessionId: data.sessionId });
        } else {
            throw new Error('No checkout URL returned');
        }

    } catch (error) {
        loadingDiv.remove();
        console.error('Checkout error:', error);

        // For development/demo: Allow fallback to demo mode
        if (confirm(`Checkout error: ${error.message}\n\nWould you like to continue in demo mode? (This will simulate a purchase)`)) {
            // Demo mode - mark as purchased locally
            let purchased = [];
            try { purchased = JSON.parse(localStorage.getItem('purchased_meal_plans') || '[]'); } catch(e) {}
            if (!purchased.includes(planSlug)) {
                purchased.push(planSlug);
                localStorage.setItem('purchased_meal_plans', JSON.stringify(purchased));
            }
            localStorage.setItem('user_food_preferences', JSON.stringify(preferences));

            alert('Demo purchase successful! Refreshing your meal plan view...');
            initializeMealPlanView();
        }
    }
}

// Close wizard on overlay click
document.getElementById('pref-wizard-overlay')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closePrefWizard();
    }
});
</script>

<!-- PROGRAM BUILDER VIEW - Build Your Own Multi-Week Workout Program -->
<div id="view-program-builder" class="app-view" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#f8fafc; z-index:100001; overflow-y:auto; padding-bottom: 120px;">
    <div style="position: sticky; top: 0; z-index: 100; background: white; padding: calc(15px + env(safe-area-inset-top, 0px)) 20px 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: center;">
        <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main);">Build Your Program</div>
    </div>

    <div style="padding: 20px;">
        <!-- Program Name -->
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 700; color: var(--text-main); margin-bottom: 8px; font-size: 0.9rem;">Program Name</label>
            <input type="text" id="program-name-input" placeholder="e.g., My 6-Week Challenge"
                   style="width: 100%; padding: 15px; border-radius: 16px; border: 1px solid #e2e8f0; font-size: 1rem; background: white;">
        </div>

        <!-- Duration Selection -->
        <div style="margin-bottom: 25px;">
            <label style="display: block; font-weight: 700; color: var(--text-main); margin-bottom: 12px; font-size: 0.9rem;">Program Duration</label>
            <div style="display: flex; gap: 10px;">
                <button onclick="selectProgramDuration(4)" class="duration-btn" data-weeks="4" style="flex: 1; padding: 18px 12px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                    <div style="font-weight: 800; font-size: 1.4rem; color: var(--primary);">4</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">weeks</div>
                </button>
                <button onclick="selectProgramDuration(6)" class="duration-btn" data-weeks="6" style="flex: 1; padding: 18px 12px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                    <div style="font-weight: 800; font-size: 1.4rem; color: var(--primary);">6</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">weeks</div>
                </button>
                <button onclick="selectProgramDuration(8)" class="duration-btn" data-weeks="8" style="flex: 1; padding: 18px 12px; border-radius: 16px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                    <div style="font-weight: 800; font-size: 1.4rem; color: var(--primary);">8</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">weeks</div>
                </button>
            </div>
        </div>

        <!-- Weekly Schedule -->
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 700; color: var(--text-main); margin-bottom: 12px; font-size: 0.9rem;">Weekly Schedule</label>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0 0 15px 0;">Tap each day to assign a workout. This schedule repeats each week.</p>

            <div id="program-weekly-schedule" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Days will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; background: white; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 100;">
        <button onclick="saveProgramBuilder()" id="save-program-btn" style="width: 100%; background: var(--primary); color: white; padding: 18px; border-radius: 50px; font-weight: 800; border: none; font-size: 1.1rem; cursor: pointer; opacity: 0.5;" disabled>
            Save Program
        </button>
    </div>
</div>

<!-- Workout Picker Modal for Program Builder -->
<div id="workout-picker-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100002; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-height: 80vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="font-weight: 700; font-size: 1.1rem;">Select Workout for <span id="picker-day-name">Monday</span></div>
            <button onclick="closeWorkoutPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <!-- Rest Day Option -->
        <div onclick="selectWorkoutForDay('rest', 'Rest Day', null)" style="background: #f1f5f9; border-radius: 16px; padding: 16px; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
                😴
            </div>
            <div>
                <div style="font-weight: 700; color: var(--text-main);">Rest Day</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">Recovery and regeneration</div>
            </div>
        </div>

        <!-- Your Custom Workouts Section -->
        <div id="picker-custom-workouts-section" style="margin-bottom: 15px; display: none;">
            <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">🛠️</span> Your Custom Workouts
            </div>
            <div id="picker-custom-workouts-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Custom workouts will be rendered here -->
            </div>
        </div>

        <!-- Workout Library Section -->
        <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.1rem;">📚</span> Workout Library
        </div>
        <div id="workout-picker-categories" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Categories will be rendered here -->
        </div>
    </div>
</div>

<!-- Workout Subcategory Picker -->
<div id="workout-subcategory-picker" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100003; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-height: 80vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToWorkoutPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;" id="subcategory-picker-title">Select Workout</div>
            <button onclick="closeSubcategoryPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div id="workout-subcategory-list" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Subcategories will be rendered here -->
        </div>
    </div>
</div>

<!-- Calendar Workout Action Modal - Shows when clicking calendar workout -->
<div id="calendar-workout-action-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100002; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="font-weight: 700; font-size: 1.1rem;" id="action-modal-title">Workout Options</div>
            <button onclick="closeCalendarActionModal()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <!-- Current Workout Info -->
        <div id="action-modal-current-workout" style="background: #f8fafc; border-radius: 16px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Currently scheduled:</div>
            <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;" id="action-modal-workout-name">Loading...</div>
        </div>

        <!-- Replacement Active Notice (hidden by default) -->
        <div id="action-modal-replacement-notice" style="display: none; background: #fef3c7; border-radius: 16px; padding: 16px; margin-bottom: 20px; border: 1px solid #f59e0b;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.2rem;">🔄</span>
                <div>
                    <div style="font-weight: 600; color: #92400e; font-size: 0.9rem;">Replacement Active</div>
                    <div style="font-size: 0.85rem; color: #a16207;" id="replacement-notice-text">Ends in X weeks</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <!-- Start Workout Button -->
            <button onclick="startWorkoutFromActionModal()" style="background: var(--primary); color: white; border: none; border-radius: 16px; padding: 18px; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: white;"><path d="M8 5v14l11-7z"/></svg>
                Start Workout
            </button>

            <!-- Replace Workout Button -->
            <button onclick="openReplacementPicker()" style="background: white; color: var(--primary); border: 2px solid var(--primary); border-radius: 16px; padding: 16px; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: var(--primary);"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg>
                Replace This Workout
            </button>

            <!-- Remove Replacement Button (only shown if replacement is active) -->
            <button id="remove-replacement-btn" onclick="removeCurrentReplacement()" style="display: none; background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; border-radius: 16px; padding: 14px; font-weight: 600; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #dc2626;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                Remove Replacement
            </button>
        </div>
    </div>
</div>

<!-- Replacement Workout Picker Modal -->
<div id="replacement-picker-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100003; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; max-height: 85vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToActionModal()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;">Choose Replacement</div>
            <button onclick="closeReplacementPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <!-- Rest Day Option -->
        <div onclick="selectReplacementWorkout('rest', 'Rest Day', null)" style="background: #f1f5f9; border-radius: 16px; padding: 16px; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; background: #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
                😴
            </div>
            <div>
                <div style="font-weight: 700; color: var(--text-main);">Rest Day</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">Take a recovery day</div>
            </div>
        </div>

        <!-- Custom Workouts Section -->
        <div id="replacement-custom-section" style="margin-bottom: 15px; display: none;">
            <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.1rem;">🛠️</span> Your Custom Workouts
            </div>
            <div id="replacement-custom-list" style="display: flex; flex-direction: column; gap: 10px;">
            </div>
        </div>

        <!-- Library Categories Section -->
        <div style="font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.1rem;">📚</span> Workout Library
        </div>
        <div id="replacement-categories" style="display: flex; flex-direction: column; gap: 10px;">
        </div>
    </div>
</div>

<!-- Replacement Subcategory Picker -->
<div id="replacement-subcategory-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100004; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; max-height: 85vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToReplacementPicker()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;" id="replacement-subcategory-title">Select Workout</div>
            <button onclick="closeReplacementSubcategory()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div id="replacement-subcategory-list" style="display: flex; flex-direction: column; gap: 10px;">
        </div>
    </div>
</div>

<!-- Replacement Duration Picker Modal -->
<div id="replacement-duration-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100005; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 24px; width: 90%; max-width: 400px; padding: 24px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-weight: 800; font-size: 1.2rem; color: var(--text-main); margin-bottom: 8px;">How Long?</div>
            <div style="font-size: 0.9rem; color: var(--text-muted);">How many weeks should this replacement last?</div>
        </div>

        <div id="replacement-selected-workout" style="background: #f8fafc; border-radius: 12px; padding: 12px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 0.8rem; color: var(--text-muted);">Replacing with:</div>
            <div style="font-weight: 700; color: var(--text-main);" id="duration-workout-name">Workout Name</div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
            <button onclick="selectReplacementDuration(1)" class="duration-option-btn" data-weeks="1" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">1</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">week</div>
            </button>
            <button onclick="selectReplacementDuration(2)" class="duration-option-btn" data-weeks="2" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">2</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
            <button onclick="selectReplacementDuration(3)" class="duration-option-btn" data-weeks="3" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">3</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
            <button onclick="selectReplacementDuration(4)" class="duration-option-btn" data-weeks="4" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">4</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
            <button onclick="selectReplacementDuration(6)" class="duration-option-btn" data-weeks="6" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">6</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
            <button onclick="selectReplacementDuration(8)" class="duration-option-btn" data-weeks="8" style="padding: 16px 12px; border-radius: 12px; border: 2px solid #e2e8f0; background: white; cursor: pointer; transition: all 0.2s;">
                <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);">8</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">weeks</div>
            </button>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="closeDurationModal()" style="flex: 1; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; background: white; color: var(--text-muted); font-weight: 600; cursor: pointer;">
                Cancel
            </button>
            <button onclick="confirmReplacement()" id="confirm-replacement-btn" style="flex: 2; padding: 14px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: 700; cursor: pointer; opacity: 0.5;" disabled>
                Confirm Replacement
            </button>
        </div>
    </div>
</div>

<!-- Workout Variations List Modal - Shows all variations in a subcategory -->
<div id="workout-variations-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100006; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; max-height: 85vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="closeVariationsModal()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;" id="variations-modal-title">Back Day</div>
            <button onclick="closeAllVariationsModals()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
        <div id="variations-list" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Variations will be rendered here -->
        </div>
    </div>
</div>

<!-- Workout Exercises Modal - Shows exercises in a specific workout -->
<div id="workout-exercises-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100007; justify-content: center; align-items: flex-end;">
    <div style="background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 500px; margin: 0 auto; max-height: 85vh; overflow-y: auto; padding: 20px; padding-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="closeExercisesModal()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div style="font-weight: 700; font-size: 1.1rem;" id="exercises-modal-title">Back 1</div>
            <button onclick="closeAllVariationsModals()" style="width: 36px; height: 36px; border: none; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #64748b;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>

        <!-- Workout Info -->
        <div id="exercises-workout-info" style="background: #f8fafc; border-radius: 12px; padding: 14px; margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
            <div id="exercises-duration" style="font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px;">
                <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--text-muted);"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                <span>45 min</span>
            </div>
            <div id="exercises-difficulty" style="font-size: 0.85rem; color: var(--text-muted);">Intermediate</div>
        </div>

        <!-- Exercise List -->
        <div id="exercises-list" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
            <!-- Exercises will be rendered here -->
        </div>

        <!-- Select Button -->
        <button onclick="selectPreviewedWorkout()" id="select-workout-btn" style="width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--primary); color: white; font-weight: 700; font-size: 1rem; cursor: pointer;">
            Select This Workout
        </button>
    </div>
</div>

<script src="js/dashboard/dashboard-script-12-program_builder_state.js"></script>


    <!-- Tamagotchi Initialization Logic -->
    <script src="js/dashboard/dashboard-script-13.js"></script>


    <!-- Learning System Script -->
    <script src="lib/learning-inline.js"></script>
    <!-- Battle System & Logic Overrides -->
    <script>
    console.log("🔥 LOADING BATTLE SYSTEM OVERRIDES...");

    // Sound System
    const BATTLE_SOUNDS = {
        intro: new Audio('assets/battle_intro.wav'),
        bell: new Audio('assets/bell.wav'),
        whoosh: new Audio('assets/whoosh.wav'),
        hit: new Audio('assets/hit.wav'),
        victory: new Audio('assets/victory.wav')
    };

    function playBattleSound(name) {
        if(BATTLE_SOUNDS[name]) {
            BATTLE_SOUNDS[name].currentTime = 0;
            BATTLE_SOUNDS[name].volume = 0.6;
            BATTLE_SOUNDS[name].play().catch(e => console.log("Audio play failed:", e));
        }
    }

    // (V2 battle logic removed - all battle logic is now in _runBattle below)

    // --- OVERRIDE COLOR APPLICATION ---
    window.applyCharacterColors = async function(modelViewer, modelSrc) {
        if(!modelViewer) return;
        
        // Wait for load
        if(!modelViewer.model) {
            await new Promise(r => modelViewer.addEventListener('load', r, {once:true}));
        }
        const model = modelViewer.model;
        if(!model || !model.materials) return;

        const colors = window.getCharacterColors(); // Uses existing helper which reads localStorage
        const src = (modelSrc || modelViewer.src || "").toLowerCase();

        // Hex to RGB Helper
        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16)/255, g: parseInt(result[2], 16)/255, b: parseInt(result[3], 16)/255 } : null;
        };

        Object.keys(colors).forEach(cat => {
            const hex = colors[cat];
            if(!hex) return;
            const linkColor = hexToRgb(hex);
            if(!linkColor) return;

            let targets = [];
            
            // KEYWORD MATCHING LOGIC
            if (src.includes('baby')) {
                 if(cat==='skin') targets=['tripo_part_new_0.001']; if(cat==='hair') targets=['tripo_part_0.001']; if(cat==='pants') targets=['tripo_part_8.001']; if(cat==='shoes') targets=['tripo_part_3.001'];
            }
            else if (src.includes('level_50_female')) {
                if(cat==='skin') targets=['part_11']; if(cat==='hair') targets=['part_4']; if(cat==='shirt') targets=['part_9']; if(cat==='shoes') targets=['part_9'];
            } 
            else if (src.includes('level_40_female')) {
                 if(cat==='skin') targets=['part_1']; if(cat==='hair') targets=['part_10']; if(cat==='shirt') targets=['part_7']; if(cat==='pants') targets=['part_6']; if(cat==='shoes') targets=['part_2'];
            }
            else if (src.includes('level_30_female')) {
                 if(cat==='skin') targets=['new_0_material']; if(cat==='hair') targets=['new_0_0']; if(cat==='shirt') targets=['part_10']; if(cat==='pants') targets=['part_2']; if(cat==='shoes') targets=['part_1'];
            }
            else if (src.includes('level_20_female')) {
                 if(cat==='skin') targets=['part_11', 'part_8', 'tripo_part_new_0_0']; if(cat==='hair') targets=['part_0', 'tripo_part_8']; if(cat==='shirt') targets=['part_3', 'tripo_part_5']; if(cat==='pants') targets=['tripo_part_4']; if(cat==='shoes') targets=['part_1', 'tripo_part_9'];
            }
            else if (src.includes('level_10_female')) {
                 if(cat==='skin') targets=['part_8.001']; if(cat==='hair') targets=['part_new_0.001', 'part_new.001']; if(cat==='shirt') targets=['part_new_0_0.001']; if(cat==='pants') targets=['part_6.001']; if(cat==='shoes') targets=['part_1.001', 'part_10.001'];
            }
            else if (src.includes('level_1_female')) {
                 if(cat==='skin') targets=['part_new']; if(cat==='hair') targets=['part_2']; if(cat==='shirt') targets=['part_8']; if(cat==='pants') targets=['part_4']; if(cat==='shoes') targets=['part_11'];
            }
            // MALE / REAL MODELS
            else if (src.includes('level_50_real')) {
                 if(cat==='skin') targets=['part_4_material']; if(cat==='hair') targets=['part_1_material']; if(cat==='pants') targets=['new_0_material']; if(cat==='shoes') targets=['part_6_material'];
            }
            else if (src.includes('level_40_real')) {
                 if(cat==='skin') targets=['part_3_material']; if(cat==='hair') targets=['part_5_material']; if(cat==='shirt') targets=['part_10_material']; if(cat==='pants') targets=['part_6_material']; if(cat==='shoes') targets=['part_2_material'];
            }
            else if (src.includes('level_30_real')) {
                 if(cat==='skin') targets=['part_13_material']; if(cat==='hair') targets=['part_4_material']; if(cat==='shirt') targets=['new_0_material']; if(cat==='pants') targets=['part_5_material']; if(cat==='shoes') targets=['part_2_material'];
            }
            else if (src.includes('level_20_real')) {
                 if(cat==='skin') targets=['part_0_material']; if(cat==='hair') targets=['part_12_material']; if(cat==='shirt') targets=['part_6_material']; if(cat==='pants') targets=['part_9_material']; if(cat==='shoes') targets=['part_2_material'];
            }
            else if (src.includes('level_10_real')) {
                 if(cat==='skin') targets=['part_0_material']; if(cat==='hair') targets=['part_5_material']; if(cat==='shirt') targets=['part_12_material']; if(cat==='pants') targets=['part_6_material']; if(cat==='shoes') targets=['part_10_material'];
            }
            else if (src.includes('level_1_good') || src.includes('shazylvl1')) {
                 if(cat==='skin') targets=['part_10_material']; if(cat==='hair') targets=['part_7_material']; if(cat==='shirt') targets=['part_5_material']; if(cat==='pants') targets=['part_6_material']; if(cat==='shoes') targets=['part_9_material'];
            }
            
            // Fallback
            if(targets.length === 0) {
                 if(cat==='skin') targets=['skin', 'body', 'face', 'arm', 'hand'];
                 if(cat==='hair') targets=['hair', 'head'];
                 if(cat==='shirt') targets=['shirt', 'top', 'vest'];
                 if(cat==='pants') targets=['pants', 'shorts', 'leg'];
                 if(cat==='shoes') targets=['shoes', 'boot', 'feet'];
            }

            // Apply
            model.materials.forEach(mat => {
                const matName = (mat.name || "").toLowerCase();
                const matched = targets.some(t => {
                    if(t.startsWith('part_') || t.startsWith('new_')) {
                        // Strict ID match
                        return matName.includes(t);
                    }
                    return matName.includes(t);
                });

                if(matched) {
                    const pbr = mat.pbrMetallicRoughness;
                    pbr.baseColorTexture = null;
                    pbr.setBaseColorFactor([linkColor.r, linkColor.g, linkColor.b, 1]);
                    if(cat==='skin' || cat==='hair') {
                        pbr.setRoughnessFactor(0.9);
                        pbr.setMetallicFactor(0.0);
                    }
                }
            });
        });
    };
    </script>

    <!-- ============================================================
         BACKGROUND INITIALIZATION (separate script to avoid battle errors blocking it)
         ============================================================ -->
    <script>
    (function() {
        function initBackground() {
            const savedBg = localStorage.getItem('selectedBackground') || 'none';
            if (window.selectBackground) {
                window.selectBackground(savedBg);
                return;
            }
            // Fallback if selectBackground not yet available - default to plain dark background
            const container = document.getElementById('tamagotchi-widget-container');
            if (!container) return;
            const ALL_BG = ['tamagotchi-bg-none','tamagotchi-bg-gym','tamagotchi-bg-park','tamagotchi-bg-home','tamagotchi-bg-beach','tamagotchi-bg-mountain','tamagotchi-bg-dojo','tamagotchi-bg-arena'];
            ALL_BG.forEach(t => container.classList.remove(t));
            container.classList.add('tamagotchi-bg-none');
            const staticBg = document.getElementById('tamagotchi-static-bg');
            const bgModel = document.getElementById('tamagotchi-bg-model');
            const floor = document.getElementById('tamagotchi-floor');
            if (staticBg) staticBg.style.display = 'none';
            if (bgModel) bgModel.style.display = 'none';
            if (floor) floor.style.display = 'none';
        }
        // Run after a short delay so models have time to initialize
        setTimeout(initBackground, 2500);
        // Also expose for other code
        window._initBackground = initBackground;
    })();
    </script>

    <!-- ============================================================
         PROGRESSION & BATTLE SYSTEM
         Stats (STR/HP/Mana), Stat Allocation, Battle Overhaul,
         Backgrounds, Move Picker
         ============================================================ -->
    <script src="js/dashboard/dashboard-script-14-stat_system_save_load_display.js"></script>

    <script src="js/dashboard/dashboard-script-15.js"></script>


    <!-- User Profile Page Script -->
    <script>
    // Track which view we came from (so back button returns correctly)
    var _userProfilePreviousView = 'friends';

    /**
     * Open profile from the story viewer (full-screen story view)
     */
    function openStoryUserProfile() {
        // Get current story from the stories module
        if (typeof currentUserStories !== 'undefined' && typeof currentUserStoryIndex !== 'undefined') {
            const story = currentUserStories[currentUserStoryIndex];
            if (story && story.user_id) {
                // Close the story viewer first
                if (typeof closeStoryViewer === 'function') closeStoryViewer();
                viewUserProfile(story.user_id, story.user_name, story.profile_photo);
            }
        }
    }
    window.openStoryUserProfile = openStoryUserProfile;

    /**
     * Open another user's profile from the feed
     * @param {string} userId - The UUID of the user whose profile to view
     * @param {string} [userName] - Optional pre-loaded name
     * @param {string} [userPhoto] - Optional pre-loaded photo URL
     */
    async function viewUserProfile(userId, userName, userPhoto) {
        if (!userId) return;

        // Remember where we came from
        const currentView = document.querySelector('.app-view[style*="display: block"], .app-view[style*="display:block"], .app-view.active');
        if (currentView) {
            _userProfilePreviousView = currentView.id || 'friends';
        }

        // Hide all views, show profile
        hideAllAppViews();
        const profileView = document.getElementById('view-user-profile');
        profileView.style.display = 'block';

        // Hide bottom nav for immersive feel
        document.querySelector('.bottom-nav').style.display = 'none';

        // Set initial data if provided
        const headerName = document.getElementById('user-profile-header-name');
        const nameEl = document.getElementById('user-profile-name');
        const avatarEl = document.getElementById('user-profile-avatar');

        if (userName) {
            headerName.textContent = userName;
            nameEl.textContent = userName;
        } else {
            headerName.textContent = 'Profile';
            nameEl.textContent = 'Loading...';
        }

        if (userPhoto) {
            avatarEl.innerHTML = `<img src="${userPhoto}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
        } else {
            const initial = (userName || '?').charAt(0).toUpperCase();
            avatarEl.innerHTML = `<span style="font-size:2.2rem; color:white; font-weight:700;">${initial}</span>`;
        }

        // Reset sections
        document.getElementById('user-profile-level').textContent = '1';
        document.getElementById('user-profile-level-title').textContent = 'Newcomer';
        document.getElementById('user-profile-workouts').textContent = '0';
        document.getElementById('user-profile-streak').textContent = '0';
        document.getElementById('user-profile-points').textContent = '0';
        document.getElementById('user-profile-tamagotchi-section').style.display = 'none';
        document.getElementById('user-profile-pbs-section').style.display = 'none';
        document.getElementById('user-profile-badges-section').style.display = 'none';
        document.getElementById('user-profile-posts-grid').innerHTML = '';
        document.getElementById('user-profile-posts-empty').style.display = 'none';

        // Scroll to top
        profileView.scrollTop = 0;

        // Load all data in parallel
        try {
            const [userData, pointsData, personalBests, milestones, stories] = await Promise.all([
                db.users.get(userId).catch(() => null),
                db.points.getPoints(userId).catch(() => null),
                db.personalBests.getAll(userId, 20).catch(() => []),
                db.milestones.getAll(userId, 50).catch(() => []),
                loadUserProfileStories(userId).catch(() => [])
            ]);

            // Update user info
            if (userData) {
                headerName.textContent = userData.name || 'User';
                nameEl.textContent = userData.name || 'User';
                if (userData.profile_photo) {
                    avatarEl.innerHTML = `<img src="${userData.profile_photo}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                }
            }

            // Update level & stats
            let userLevel = 1;
            if (pointsData) {
                const levelInfo = calculateLevelFromPoints(pointsData.lifetime_points || 0);
                userLevel = levelInfo.level;
                document.getElementById('user-profile-level').textContent = levelInfo.level;
                document.getElementById('user-profile-level-title').textContent = levelInfo.title;
                document.getElementById('user-profile-workouts').textContent = pointsData.total_workouts_logged || 0;
                document.getElementById('user-profile-streak').textContent = pointsData.current_streak || 0;
                document.getElementById('user-profile-points').textContent = (pointsData.lifetime_points || 0).toLocaleString();
            }

            // Load tamagotchi model based on user level and gender
            try {
                const EVOLUTIONS_MALE = [
                    { level: 1,  src: "https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb" },
                    { level: 5,  src: "https://f005.backblazeb2.com/file/shannonsvideos/level_1_good_final.glb" },
                    { level: 10, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_10_real_final.glb" },
                    { level: 20, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_20_real_final.glb" },
                    { level: 30, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_30_real_final.glb" },
                    { level: 40, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_40_real_final.glb" },
                    { level: 50, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_real_final.glb" }
                ];
                const EVOLUTIONS_FEMALE = [
                    { level: 1,  src: "https://f005.backblazeb2.com/file/shannonsvideos/baby_full_animations.glb" },
                    { level: 5,  src: "https://f005.backblazeb2.com/file/shannonsvideos/level_1_female_final.glb" },
                    { level: 10, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_10_female_final.glb" },
                    { level: 20, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_20_female_final.glb" },
                    { level: 30, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_30_female_final.glb" },
                    { level: 40, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_40_female_final.glb" },
                    { level: 50, src: "https://f005.backblazeb2.com/file/shannonsvideos/level_50_female_final.glb" }
                ];
                const userSex = userData && userData.sex === 'female' ? 'female' : 'male';
                const evolutions = userSex === 'female' ? EVOLUTIONS_FEMALE : EVOLUTIONS_MALE;
                const evo = [...evolutions].reverse().find(e => userLevel >= e.level) || evolutions[0];

                const tamaSection = document.getElementById('user-profile-tamagotchi-section');
                const tamaModel = document.getElementById('user-profile-tamagotchi-model');
                const tamaFallback = document.getElementById('user-profile-tamagotchi-fallback');

                if (tamaSection && tamaModel && evo.src) {
                    tamaSection.style.display = 'block';
                    tamaModel.setAttribute('src', evo.src);
                    tamaFallback.style.display = 'none';
                }
            } catch (tamaErr) {
                console.error('Error loading profile tamagotchi:', tamaErr);
            }

            // Render personal bests
            renderUserProfilePBs(personalBests);

            // Render badges/milestones
            renderUserProfileBadges(milestones, pointsData);

            // Render posts
            renderUserProfilePosts(stories);

        } catch (err) {
            console.error('Error loading user profile:', err);
        }
    }
    window.viewUserProfile = viewUserProfile;

    /**
     * Close the user profile and return to the previous view
     */
    function closeUserProfile() {
        document.getElementById('view-user-profile').style.display = 'none';
        document.querySelector('.bottom-nav').style.display = 'flex';

        // Map view IDs back to their tab names for proper navigation
        const viewToTab = {
            'view-friends': 'friends',
            'friends': 'friends',
            'view-dashboard': 'dashboard',
            'dashboard': 'dashboard',
            'movement-tab': 'movement-tab',
            'view-meals': 'meals',
            'view-profile': 'profile',
            'view-learning': 'learning',
            'view-cycle': 'cycle'
        };

        const tabName = viewToTab[_userProfilePreviousView];
        if (tabName) {
            switchAppTab(tabName);
        } else {
            // Fallback for unknown views
            switchAppTab('friends');
        }
    }
    window.closeUserProfile = closeUserProfile;

    /**
     * Calculate level info from lifetime points (client-side)
     */
    function calculateLevelFromPoints(lifetimePoints) {
        const CURVE_MULTIPLIER = 0.07;
        const CURVE_EXPONENT = 2.4;
        const LINEAR_BONUS = 0.7;
        const MAX_LEVEL = 99;

        function getPointsForLevel(level) {
            if (level <= 1) return 0;
            return Math.floor(CURVE_MULTIPLIER * Math.pow(level, CURVE_EXPONENT) + LINEAR_BONUS * level);
        }

        let level = 1;
        while (level < MAX_LEVEL) {
            const pointsNeeded = getPointsForLevel(level + 1);
            if (lifetimePoints < pointsNeeded) break;
            level++;
        }

        // Level title
        let title = 'Newcomer';
        if (level >= 99) title = 'Legend';
        else if (level >= 90) title = 'Master';
        else if (level >= 80) title = 'Champion';
        else if (level >= 70) title = 'Expert';
        else if (level >= 60) title = 'Veteran';
        else if (level >= 50) title = 'Dedicated';
        else if (level >= 40) title = 'Committed';
        else if (level >= 30) title = 'Consistent';
        else if (level >= 20) title = 'Growing';
        else if (level >= 10) title = 'Rising';
        else if (level >= 5) title = 'Beginner';

        return { level, title };
    }

    /**
     * Render personal bests grid
     */
    function renderUserProfilePBs(personalBests) {
        const section = document.getElementById('user-profile-pbs-section');
        const grid = document.getElementById('user-profile-pbs-grid');

        if (!personalBests || personalBests.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        // Sort: prioritize big compound lifts first, then by weight
        const priorityExercises = ['bench press', 'squat', 'deadlift', 'overhead press', 'barbell row'];
        const sorted = [...personalBests].sort((a, b) => {
            const aIdx = priorityExercises.findIndex(e => a.exercise_name.toLowerCase().includes(e));
            const bIdx = priorityExercises.findIndex(e => b.exercise_name.toLowerCase().includes(e));
            if (aIdx !== -1 && bIdx === -1) return -1;
            if (aIdx === -1 && bIdx !== -1) return 1;
            if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
            return (b.best_weight_kg || 0) - (a.best_weight_kg || 0);
        });

        // Show up to 6 PBs
        grid.innerHTML = sorted.slice(0, 6).map(pb => {
            const weight = pb.best_weight_kg ? `${Number(pb.best_weight_kg).toFixed(1)}kg` : '-';
            const reps = pb.best_weight_reps ? `${pb.best_weight_reps} reps` : '';
            const exerciseName = formatExerciseName(pb.exercise_name);

            return `
                <div class="up-pb-card">
                    <div class="up-pb-exercise">${exerciseName}</div>
                    <div class="up-pb-weight">${weight}</div>
                    ${reps ? `<div class="up-pb-reps">${reps}</div>` : ''}
                </div>
            `;
        }).join('');
    }

    /**
     * Format exercise name for display (capitalize, abbreviate)
     */
    function formatExerciseName(name) {
        if (!name) return '';
        return name.split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    }

    /**
     * Render badges/milestones for a user profile
     */
    function renderUserProfileBadges(milestones, pointsData) {
        const section = document.getElementById('user-profile-badges-section');
        const grid = document.getElementById('user-profile-badges-grid');

        // Build badge list from milestones and points data
        const badges = [];

        // Workout count badges
        const workoutCount = pointsData?.total_workouts_logged || 0;
        const workoutThresholds = [
            { value: 1, emoji: '🎉', label: 'First Workout' },
            { value: 5, emoji: '💪', label: '5 Workouts' },
            { value: 10, emoji: '🔥', label: '10 Workouts' },
            { value: 25, emoji: '🌟', label: '25 Workouts' },
            { value: 50, emoji: '🏆', label: '50 Workouts' },
            { value: 100, emoji: '👑', label: '100 Workouts' }
        ];
        workoutThresholds.forEach(t => {
            badges.push({
                emoji: t.emoji,
                label: t.label,
                earned: workoutCount >= t.value
            });
        });

        // Streak badges
        const streak = pointsData?.longest_streak || pointsData?.current_streak || 0;
        const streakThresholds = [
            { value: 7, emoji: '⚡', label: '7-Day Streak' },
            { value: 14, emoji: '⚡', label: '14-Day Streak' },
            { value: 30, emoji: '🔥', label: '30-Day Streak' },
            { value: 100, emoji: '💎', label: '100-Day Streak' }
        ];
        streakThresholds.forEach(t => {
            badges.push({
                emoji: t.emoji,
                label: t.label,
                earned: streak >= t.value
            });
        });

        // Milestone-based badges
        if (milestones && milestones.length > 0) {
            const milestoneTypes = new Set(milestones.map(m => m.milestone_type));
            if (milestoneTypes.has('pr_weight')) {
                badges.push({ emoji: '🏅', label: 'PR Crusher', earned: true });
            }
        }

        // Meal badges
        const mealCount = pointsData?.total_meals_logged || 0;
        if (mealCount >= 1) badges.push({ emoji: '🥗', label: 'First Meal', earned: true });
        if (mealCount >= 50) badges.push({ emoji: '🍽️', label: '50 Meals', earned: true });
        if (mealCount >= 100) badges.push({ emoji: '👨‍🍳', label: '100 Meals', earned: true });

        // Filter to only show earned badges
        const earnedBadges = badges.filter(b => b.earned);

        if (earnedBadges.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        grid.innerHTML = earnedBadges.slice(0, 9).map(b => `
            <div class="up-badge-card earned">
                <div class="up-badge-emoji">${b.emoji}</div>
                <div class="up-badge-label">${b.label}</div>
            </div>
        `).join('');
    }

    /**
     * Load stories/posts for a specific user (including expired ones for their profile)
     */
    async function loadUserProfileStories(userId) {
        try {
            const { data, error } = await window.supabaseClient
                .from('stories')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(30);

            if (error) throw error;
            return data || [];
        } catch (err) {
            console.error('Error loading user stories:', err);
            return [];
        }
    }

    /**
     * Render post thumbnails grid (Instagram-style 3-column grid)
     */
    function renderUserProfilePosts(stories) {
        const grid = document.getElementById('user-profile-posts-grid');
        const emptyState = document.getElementById('user-profile-posts-empty');

        if (!stories || stories.length === 0) {
            grid.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        grid.innerHTML = stories.map(story => {
            const storyId = story.id;
            const isImage = story.media_type === 'image' || story.media_type === 'video';
            const isCardType = ['workout_card', 'nutrition_card', 'level_up_card'].includes(story.media_type);

            if (isImage && story.media_url) {
                const thumb = story.thumbnail_url || story.media_url;
                return `
                    <div class="up-post-thumb" onclick="openFeedPostViewer('${storyId}')">
                        <img src="${thumb}" loading="lazy" onerror="this.parentElement.style.background='linear-gradient(135deg, var(--primary), var(--secondary))'; this.style.display='none';">
                        ${story.media_type === 'video' ? '<div style="position:absolute; top:6px; right:6px;"><svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:white; filter:drop-shadow(0 1px 2px rgba(0,0,0,0.5));"><path d="M8 5v14l11-7z"/></svg></div>' : ''}
                    </div>
                `;
            } else if (isCardType) {
                const typeEmoji = story.media_type === 'workout_card' ? '💪'
                    : story.media_type === 'nutrition_card' ? '🥗'
                    : '⭐';
                return `
                    <div class="up-post-card-thumb" onclick="openFeedPostViewer('${storyId}')">
                        <span>${typeEmoji}</span>
                    </div>
                `;
            }

            return `
                <div class="up-post-thumb" style="background: linear-gradient(135deg, #e2e8f0, #f1f5f9);">
                    <div style="display:flex; align-items:center; justify-content:center; height:100%; font-size:1.5rem;">📷</div>
                </div>
            `;
        }).join('');
    }
    </script>

<!-- AI Assistant Logic -->
<script src="js/dashboard/dashboard-script-16-chat_state.js"></script>



<!-- Custom Cards System - cards created via FITGotchi AI actions -->
<script>
(function() {
    let customCardsCache = [];

    async function loadMyCards() {
        const user = window.currentUser;
        if (!user) return;
        try {
            const { data, error } = await window.supabaseClient
                .from('custom_cards')
                .select('*')
                .eq('user_id', user.id)
                .eq('is_active', true)
                .order('created_at', { ascending: false });
            if (error) throw error;
            customCardsCache = data || [];
        } catch (e) {
            console.warn('Failed to load custom cards:', e);
            const local = localStorage.getItem('custom_cards');
            customCardsCache = local ? JSON.parse(local) : [];
        }
    }

    async function saveCustomCard(cardType, title, description, cardData) {
        const user = window.currentUser;
        if (!user) return null;
        const record = {
            user_id: user.id, card_type: cardType, title: title,
            description: description || '', card_data: cardData || {}, is_active: true
        };
        try {
            const { data, error } = await window.supabaseClient
                .from('custom_cards').insert(record).select().single();
            if (error) throw error;
            customCardsCache.unshift(data);
            renderDashboardCustomCards();
            return data;
        } catch (e) {
            console.error('Failed to save card:', e);
            const localCards = JSON.parse(localStorage.getItem('custom_cards') || '[]');
            const localCard = { ...record, id: 'local_' + Date.now(), created_at: new Date().toISOString() };
            localCards.unshift(localCard);
            localStorage.setItem('custom_cards', JSON.stringify(localCards));
            customCardsCache.unshift(localCard);
            renderDashboardCustomCards();
            return localCard;
        }
    }

    async function deleteCard(cardId) {
        if (!confirm('Delete this custom card?')) return;
        const user = window.currentUser;
        try {
            if (cardId.startsWith('local_')) {
                const localCards = JSON.parse(localStorage.getItem('custom_cards') || '[]');
                localStorage.setItem('custom_cards', JSON.stringify(localCards.filter(c => c.id !== cardId)));
            } else if (user) {
                await window.supabaseClient.from('custom_cards').delete().eq('id', cardId).eq('user_id', user.id);
            }
            customCardsCache = customCardsCache.filter(c => c.id !== cardId);
            renderDashboardCustomCards();
        } catch (e) { console.error('Failed to delete card:', e); }
    }

    function openCard(cardId) {
        const card = customCardsCache.find(c => c.id === cardId);
        if (!card) return;
        if (card.card_type === 'quiz') playCustomQuiz(card);
        else if (card.card_type === 'checklist') openCustomChecklist(card);
        else if (card.card_type === 'tracker') openCustomTracker(card);
        else if (card.card_type === 'challenge') openCustomChallenge(card);
    }

    function playCustomQuiz(card) {
        const games = card.card_data?.games;
        if (!games || games.length === 0) return;
        if (typeof window.playCustomQuizGames === 'function') {
            window.playCustomQuizGames(card.title, card.card_data);
            return;
        }
        let currentQ = 0, score = 0;

        function showQuestion() {
            if (currentQ >= games.length) { showQuizResult(); return; }
            const game = games[currentQ];
            let html = '';
            const qLabel = `<div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Question ${currentQ + 1} of ${games.length}</div>`;

            if (game.type === 'swipe_true_false') {
                html = `<div style="text-align: center; padding: 20px;">${qLabel}<div style="font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin-bottom: 24px; line-height: 1.4;">${game.question}</div><div style="display: flex; gap: 12px; justify-content: center;"><button onclick="window._quizAnswer(true)" style="flex: 1; max-width: 140px; padding: 14px; background: #10b981; color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 1rem; cursor: pointer;">TRUE</button><button onclick="window._quizAnswer(false)" style="flex: 1; max-width: 140px; padding: 14px; background: #ef4444; color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 1rem; cursor: pointer;">FALSE</button></div></div>`;
            } else if (game.type === 'fill_blank') {
                const btns = game.options.map(opt => `<button onclick="window._quizAnswer('${opt}')" style="padding: 10px 18px; background: #f1f5f9; color: var(--text-main); border: 2px solid #e2e8f0; border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer;">${opt}</button>`).join('');
                html = `<div style="text-align: center; padding: 20px;">${qLabel}<div style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 20px; line-height: 1.4;">${game.sentence}</div><div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">${btns}</div></div>`;
            } else if (game.type === 'tap_all') {
                const opts = game.options.map((opt, i) => `<button data-idx="${i}" data-correct="${opt.correct}" onclick="this.classList.toggle('selected'); this.style.borderColor = this.classList.contains('selected') ? '#8b5cf6' : '#e2e8f0'; this.style.background = this.classList.contains('selected') ? '#ede9fe' : '#f8fafc';" style="padding: 12px 16px; background: #f8fafc; color: var(--text-main); border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.9rem; cursor: pointer; text-align: left;">${opt.text}</button>`).join('');
                html = `<div style="text-align: center; padding: 20px;">${qLabel.replace('</div>', ' — Tap all correct</div>')}<div style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 16px; line-height: 1.4;">${game.question}</div><div id="quiz-tap-options" style="display: flex; flex-direction: column; gap: 8px;">${opts}</div><button onclick="window._quizSubmitTapAll()" style="margin-top: 14px; padding: 12px 28px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer;">Submit</button></div>`;
            } else if (game.type === 'scenario_story') {
                const sopts = game.options.map(opt => `<button onclick="window._quizAnswer(${opt.correct})" style="padding: 12px 16px; background: #f8fafc; color: var(--text-main); border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.9rem; cursor: pointer; text-align: left;">${opt.text}</button>`).join('');
                html = `<div style="text-align: center; padding: 20px;">${qLabel}<div style="font-size: 0.88rem; color: var(--text-muted); margin-bottom: 12px; line-height: 1.4; font-style: italic;">${game.scenario}</div><div style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 16px;">${game.question}</div><div style="display: flex; flex-direction: column; gap: 8px;">${sopts}</div></div>`;
            } else { currentQ++; showQuestion(); return; }

            const modal = document.getElementById('custom-quiz-modal') || createQuizModal();
            document.getElementById('custom-quiz-body').innerHTML = html;
        }

        function createQuizModal() {
            const modal = document.createElement('div');
            modal.id = 'custom-quiz-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `<div style="background: white; border-radius: 20px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; position: relative;"><button onclick="document.getElementById('custom-quiz-modal').remove()" style="position: absolute; top: 12px; right: 14px; background: none; border: none; font-size: 1.3rem; cursor: pointer; color: #94a3b8; z-index: 1;">&#x2715;</button><div id="custom-quiz-body"></div></div>`;
            document.body.appendChild(modal);
            return modal;
        }

        window._quizAnswer = function(answer) {
            const game = games[currentQ];
            let correct = false;
            if (game.type === 'swipe_true_false') correct = answer === game.answer;
            else if (game.type === 'fill_blank') correct = answer === game.answer;
            else if (game.type === 'scenario_story') correct = answer === true;
            if (correct) score++;
            currentQ++;
            showQuestion();
        };

        window._quizSubmitTapAll = function() {
            const btns = document.querySelectorAll('#quiz-tap-options button');
            let allCorrect = true;
            btns.forEach(btn => {
                if (btn.classList.contains('selected') !== (btn.dataset.correct === 'true')) allCorrect = false;
            });
            if (allCorrect) score++;
            currentQ++;
            showQuestion();
        };

        function showQuizResult() {
            const pct = Math.round((score / games.length) * 100);
            const modal = document.getElementById('custom-quiz-modal');
            if (!modal) return;
            document.getElementById('custom-quiz-body').innerHTML = `<div style="text-align: center; padding: 30px 20px;"><div style="font-size: 2.5rem; margin-bottom: 12px;">${pct >= 80 ? '🎉' : pct >= 50 ? '👍' : '📚'}</div><div style="font-size: 1.3rem; font-weight: 800; color: var(--text-main); margin-bottom: 6px;">${score}/${games.length}</div><div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px;">${pct >= 80 ? 'Nailed it!' : pct >= 50 ? 'Good effort!' : 'Keep learning!'}</div><button onclick="document.getElementById('custom-quiz-modal').remove()" style="padding: 12px 28px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 1rem; cursor: pointer;">Done</button></div>`;
        }
        showQuestion();
    }

    function openCustomChecklist(card) {
        const items = card.card_data?.items || [];
        const todayKey = `checklist_${card.id}_${getLocalDateString()}`;
        const checked = JSON.parse(localStorage.getItem(todayKey) || '[]');
        const icon = card.card_data?.icon || '✅';
        const modal = document.createElement('div');
        modal.id = 'custom-checklist-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;';
        const itemsHtml = items.map((item, i) => {
            const text = typeof item === 'string' ? item : item.text;
            const isChecked = checked.includes(i);
            return `<label style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: ${isChecked ? '#f0fdf4' : '#f8fafc'}; border-radius: 12px; cursor: pointer; border: 1px solid ${isChecked ? '#86efac' : '#e2e8f0'};"><input type="checkbox" ${isChecked ? 'checked' : ''} onchange="window._checklistToggle('${todayKey}', ${i}, this.checked)" style="width: 18px; height: 18px; accent-color: #10b981;"><span style="font-size: 0.9rem; color: var(--text-main); ${isChecked ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${text}</span></label>`;
        }).join('');
        modal.innerHTML = `<div style="background: white; border-radius: 20px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; position: relative; padding: 24px 20px;"><button onclick="document.getElementById('custom-checklist-modal').remove()" style="position: absolute; top: 12px; right: 14px; background: none; border: none; font-size: 1.3rem; cursor: pointer; color: #94a3b8;">&#x2715;</button><div style="text-align: center; margin-bottom: 16px;"><span style="font-size: 1.5rem;">${icon}</span><div style="font-weight: 700; font-size: 1.05rem; margin-top: 4px;">${card.title}</div></div><div style="display: flex; flex-direction: column; gap: 10px;">${itemsHtml}</div></div>`;
        document.body.appendChild(modal);
    }

    window._checklistToggle = function(key, index, isChecked) {
        const checked = JSON.parse(localStorage.getItem(key) || '[]');
        if (isChecked && !checked.includes(index)) checked.push(index);
        else if (!isChecked) { const idx = checked.indexOf(index); if (idx >= 0) checked.splice(idx, 1); }
        localStorage.setItem(key, JSON.stringify(checked));
    };

    function openCustomTracker(card) {
        const metrics = card.card_data?.metrics || [];
        const todayKey = `tracker_${card.id}_${getLocalDateString()}`;
        const saved = JSON.parse(localStorage.getItem(todayKey) || '{}');
        const icon = card.card_data?.icon || '📊';
        const modal = document.createElement('div');
        modal.id = 'custom-tracker-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;';
        const metricsHtml = metrics.map(m => {
            if (m.type === 'boolean') {
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: #f8fafc; border-radius: 12px;"><span style="font-weight: 600; font-size: 0.9rem;">${m.name}</span><input type="checkbox" ${saved[m.name] ? 'checked' : ''} data-metric="${m.name}" style="width: 20px; height: 20px; accent-color: #10b981;"></div>`;
            } else if (m.type === 'rating') {
                const stars = [1,2,3,4,5].map(n => `<button data-metric="${m.name}" data-val="${n}" style="width: 36px; height: 36px; border-radius: 50%; border: none; background: ${(saved[m.name] || 0) >= n ? '#fbbf24' : '#e2e8f0'}; font-size: 0.9rem; cursor: pointer; font-weight: 700;">${n}</button>`).join('');
                return `<div style="padding: 12px 14px; background: #f8fafc; border-radius: 12px;"><div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px;">${m.name}</div><div style="display: flex; gap: 6px; justify-content: center;">${stars}</div></div>`;
            } else {
                return `<div style="padding: 12px 14px; background: #f8fafc; border-radius: 12px;"><div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-weight: 600; font-size: 0.9rem;">${m.name}</span>${m.goal ? `<span style="font-size: 0.78rem; color: var(--text-muted);">Goal: ${m.goal} ${m.unit || ''}</span>` : ''}</div><div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;"><input type="number" data-metric="${m.name}" value="${saved[m.name] || ''}" placeholder="0" style="flex: 1; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 1rem; outline: none;">${m.unit ? `<span style="font-size: 0.85rem; color: var(--text-muted);">${m.unit}</span>` : ''}</div></div>`;
            }
        }).join('');
        modal.innerHTML = `<div style="background: white; border-radius: 20px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; position: relative; padding: 24px 20px;"><button onclick="document.getElementById('custom-tracker-modal').remove()" style="position: absolute; top: 12px; right: 14px; background: none; border: none; font-size: 1.3rem; cursor: pointer; color: #94a3b8;">&#x2715;</button><div style="text-align: center; margin-bottom: 16px;"><span style="font-size: 1.5rem;">${icon}</span><div style="font-weight: 700; font-size: 1.05rem; margin-top: 4px;">${card.title}</div></div><div style="display: flex; flex-direction: column; gap: 14px;">${metricsHtml}</div><button onclick="window._trackerSave('${card.id}', '${todayKey}')" style="margin-top: 16px; width: 100%; padding: 14px; background: linear-gradient(135deg, #0ea5e9, #6366f1); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 1rem; cursor: pointer;">Save Today's Log</button></div>`;
        document.body.appendChild(modal);
    }

    window._trackerSave = function(cardId, todayKey) {
        const modal = document.getElementById('custom-tracker-modal');
        if (!modal) return;
        const data = {};
        modal.querySelectorAll('[data-metric]').forEach(el => {
            const name = el.dataset.metric;
            if (el.type === 'checkbox') data[name] = el.checked;
            else if (el.type === 'number') data[name] = parseFloat(el.value) || 0;
            else if (el.dataset.val) {
                const rating = parseInt(el.dataset.val);
                if (el.style.background.includes('fbbf24')) data[name] = Math.max(data[name] || 0, rating);
            }
        });
        localStorage.setItem(todayKey, JSON.stringify(data));
        const user = window.currentUser;
        if (user) {
            window.supabaseClient.from('custom_card_logs').upsert({
                card_id: cardId, user_id: user.id,
                log_date: getLocalDateString(), log_data: data
            }, { onConflict: 'card_id,log_date' }).then(() => {}).catch(() => {});
        }
        modal.remove();
    };

    function openCustomChallenge(card) {
        const data = card.card_data || {};
        const icon = data.icon || '🏆';
        const startKey = `challenge_start_${card.id}`;
        const startDate = localStorage.getItem(startKey);
        let dayNum = 0, started = false;
        if (startDate) { started = true; dayNum = Math.floor((Date.now() - new Date(startDate).getTime()) / 86400000) + 1; }
        const progress = started ? Math.min(Math.round((dayNum / (data.duration_days || 30)) * 100), 100) : 0;
        const modal = document.createElement('div');
        modal.id = 'custom-challenge-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;';
        let rulesHtml = '';
        if (data.rules) data.rules.forEach(r => { rulesHtml += `<div style="font-size: 0.88rem; color: var(--text-main); padding: 4px 0;">&#x2022; ${r}</div>`; });
        const criteriaHtml = data.success_criteria ? `<div style="padding: 12px 14px; background: #f0fdf4; border-radius: 12px; margin-bottom: 14px;"><div style="font-weight: 600; font-size: 0.82rem; color: #16a34a; margin-bottom: 2px;">Success Criteria</div><div style="font-size: 0.85rem; color: var(--text-main);">${data.success_criteria}</div></div>` : '';
        let progressHtml = '';
        if (started) {
            progressHtml = `<div style="margin-bottom: 14px;"><div style="display: flex; justify-content: space-between; font-size: 0.82rem; color: var(--text-muted); margin-bottom: 6px;"><span>Day ${dayNum} of ${data.duration_days || '?'}</span><span>${progress}%</span></div><div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;"><div style="height: 100%; width: ${progress}%; background: linear-gradient(90deg, #f59e0b, #ef4444); border-radius: 4px;"></div></div></div>`;
            if (progress >= 100) progressHtml += `<div style="text-align: center; padding: 12px; background: linear-gradient(135deg, #f59e0b, #ef4444); border-radius: 14px; color: white; font-weight: 700;">Challenge Complete!${data.xp_reward ? ' +' + data.xp_reward + ' XP' : ''}</div>`;
        } else {
            progressHtml = `<button onclick="localStorage.setItem('${startKey}', new Date().toISOString()); document.getElementById('custom-challenge-modal').remove(); window._customCardOpen('${card.id}')" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 1rem; cursor: pointer;">Start Challenge</button>`;
        }
        modal.innerHTML = `<div style="background: white; border-radius: 20px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; position: relative; padding: 24px 20px;"><button onclick="document.getElementById('custom-challenge-modal').remove()" style="position: absolute; top: 12px; right: 14px; background: none; border: none; font-size: 1.3rem; cursor: pointer; color: #94a3b8;">&#x2715;</button><div style="text-align: center; margin-bottom: 16px;"><span style="font-size: 2rem;">${icon}</span><div style="font-weight: 700; font-size: 1.1rem; margin-top: 6px;">${card.title}</div><div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">${data.duration_days || '?'} day challenge</div></div>${rulesHtml ? '<div style="margin-bottom: 14px;">' + rulesHtml + '</div>' : ''}${criteriaHtml}${progressHtml}</div>`;
        document.body.appendChild(modal);
    }

    function renderDashboardCustomCards() {
        let container = document.getElementById('dashboard-custom-cards');
        if (!container) {
            const aiCard = document.getElementById('ai-assistant-card');
            if (!aiCard) return;
            container = document.createElement('div');
            container.id = 'dashboard-custom-cards';
            aiCard.parentNode.insertBefore(container, aiCard.nextSibling);
        }
        if (customCardsCache.length === 0) { container.innerHTML = ''; return; }
        const typeIcons = { quiz: '🧠', tracker: '📊', challenge: '🏆', checklist: '✅' };
        const typeGradients = {
            quiz: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
            tracker: 'linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%)',
            challenge: 'linear-gradient(135deg, #f59e0b 0%, #ef4444 100%)',
            checklist: 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
        };
        const cards = customCardsCache.slice(0, 4);
        container.innerHTML = `<div style="margin: 0 25px 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">${cards.map(card => {
            const icon = card.card_data?.icon || typeIcons[card.card_type] || '📋';
            const gradient = typeGradients[card.card_type] || typeGradients.quiz;
            return `<div onclick="window._customCardOpen('${card.id}')" style="background: ${gradient}; border-radius: 14px; padding: 16px; color: white; cursor: pointer; position: relative; overflow: hidden; min-height: 80px;"><div style="position: absolute; top: -15px; right: -15px; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div><div style="font-size: 1.3rem; margin-bottom: 6px;">${icon}</div><div style="font-weight: 700; font-size: 0.85rem; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${card.title}</div><div style="font-size: 0.72rem; opacity: 0.85; text-transform: capitalize; margin-top: 2px;">${card.card_type}</div></div>`;
        }).join('')}</div>`;
    }

    window._customCardOpen = openCard;
    window._customCardDelete = deleteCard;
    window.saveCustomCard = saveCustomCard;
    window.renderDashboardCustomCards = renderDashboardCustomCards;
    window.loadMyCustomCards = loadMyCards;
    window.getCustomCardsCache = function() { return customCardsCache; };

    setTimeout(() => {
        if (window.currentUser) loadMyCards().then(() => renderDashboardCustomCards());
    }, 3000);
})();
</script>

<!-- CRITICAL: Immediate check for male user to prevent UI flash -->
<script>
(function() {
    if (localStorage.getItem('userGender') === 'male') {
        document.body.classList.add('male-theme');
        document.body.classList.remove('female-theme');
        
        // Fast early-update for current phase
        const pTitle = document.getElementById('dashboard-current-phase-title');
        const pName = document.getElementById('dashboard-current-phase-name');
        if (pTitle) pTitle.textContent = 'Current Phase';
        if (pName) pName.textContent = 'Performance Mode';
        
        // Update nav icon label
        const nLabel = document.getElementById('nav-cycle-label');
        if (nLabel) nLabel.textContent = 'Calendar';
        
        // Adjust CSS directly to hide female sections immediately
        const style = document.createElement('style');
        style.textContent = `
            #check-in-period-section, #check-in-cervical-section, #cycle-hero-card,
            #check-in-prompt-card, #check-in-completed-card, .female-only-chip { display: none !important; }
            #check-in-recovery-section, .male-only-chip { display: block !important; }
        `;
        document.head.appendChild(style);
    }
})();
</script>

</body>
</html>
